////////////////////////////////////////////////////////////////////////////////
// Процедуры и функции формирования отчетности по НДС.
//  
////////////////////////////////////////////////////////////////////////////////

#Область ПрограммныйИнтерфейс

// Открывает форму списка документов НДС в режиме выбора, в качестве описания оповещения 
// при открытии формы используется ОписаниеОповещения, передаваемое в параметрах процедуры.
//
// Параметры: 
//	ОписаниеОповещения	- ОписаниеОповещения - Описание оповещения при выборе.
//	ПараметрыОтбора	- Структура - Задает начальные значения отборов. Поля структуры:
//		* Организация - СправочникСсылка.Организации - Организация.
//
Процедура ВыбратьДокументНДСДляПередачиФНС(ОписаниеОповещения, ПараметрыОтбора) Экспорт
	
	ПараметрыФормы = Новый Структура;
	ПараметрыФормы.Вставить("РежимВыбора", Истина);
	
	Если ПараметрыОтбора <> Неопределено Тогда
		Если ПараметрыОтбора.Свойство("Организация") Тогда
			ПараметрыФормы.Вставить("Организация", ПараметрыОтбора.Организация);
		КонецЕсли;
	КонецЕсли;
	
	ОткрытьФорму("ЖурналДокументов.ДокументыПоУчетуНДСДляПередачиВЭлектронномВиде.ФормаСписка", ПараметрыФормы,,,,,ОписаниеОповещения);
		
КонецПроцедуры

#Область ПереносСтрокТабличныхЧастей

// Функция проверяет для переданной формы не превышает ли количество строк в табличной части (табличных частях)
// максимально возможное для записи в базу данных.
// Если лимит возможного количества строк превышен, то пользователю предлагается перенести лишние строки
// в новый документ (новые документы).
//
// Параметры:
//   Форма - ФормаКлиентскогоПриложения - форма документа
//   ПараметрыПереносаСтрокТЧ - Структура - структура входных параметров с ключами:
//     * ТабличныеЧасти          - Соответствие - соотствие между проверяемой табличной частью и подчиненной.
//               * Ключ             - Строка - имя проверяемой табличной части
//               * Значение         - Структура - структура с ключами:
//....................* КоличествоСтрокДляПереноса - Число - обязательный ключ в него записывается вычисляемое в функции
//..........................................................количество строк для переноса проверяемой табличной части.
//                    * ПодчиненныеТабличныеЧасти - Массив - необязательный ключ массив подчинённых табличных частей,
//                                                            строки из которых нужно перенести в новый документ. 
//                    * ПодчиненнаяТЧМаксимальноеКоличествоСтрок - Строка - имя подчиненной табличной части с
//                                                                          максимальным количеством строк.
//                    * МаксимальноеКоличествоСтрокВДокументе    - Число - максимальное количество строк основной
//                                                                         табличной части в новом документе.
//     * РеквизитыДокумента      - Строка - список реквизитов для копирования из документа.
//     * РежимЗаписи             - РежимЗаписиДокумента - режим записи документа.
// Возвращаемое значение:
//  - Булево - Истина, если количество строк табличной части документа превышает
//             максимальное количество строк, хранимое платформой в табличной части.
//
//  Если количество строк подчинной табличной части превышает количество строк основной табличной части и максимально
//   возможное количество для записи в базу данных, то в структуру, связанную с основной табличной частью 
//   добавляется ключи:
//  * ПодчиненнаяТЧМаксимальноеКоличествоСтрок - Строка - имя подчиненной табличной части с максимальным
//                                                        количеством строк.
//  * МаксимальноеКоличествоСтрокВДокументе    - Число - максимальное количество строк основной табличной
//                                                       части в новом документе.
Функция ПроверкаЗаписиСтрокТабличныхЧастей(Форма, ПараметрыПереносаСтрокТЧ) Экспорт
	
	Объект = Форма.Объект;
	МаксимальноеКоличествоСтрок = 99999;
	КоличествоНовыхДокументов = 0;
	
	Отказ = Ложь; 
	
	ПодчиненнаяТЧМаксимальноеКоличествоСтрок = "";
	
	Для Каждого ТабличнаяЧасть Из ПараметрыПереносаСтрокТЧ.ТабличныеЧасти Цикл 
		
		ОсновнаяТЧ = Объект[ТабличнаяЧасть.Ключ];
		КоличествоСтрокОсновнойТЧ = ОсновнаяТЧ.Количество();
		МасимальноеКоличествоСтрокТЧ = КоличествоСтрокОсновнойТЧ; 
		ПодчиненныеТабличныеЧасти = Новый Массив;
		
		Если ТабличнаяЧасть.Значение.Свойство("ПодчиненныеТабличныеЧасти") Тогда
			ПодчиненныеТабличныеЧасти = ТабличнаяЧасть.Значение.ПодчиненныеТабличныеЧасти; 
		КонецЕсли;
		
		Для каждого ПодчиненнаяТабличнаяЧасть ИЗ ПодчиненныеТабличныеЧасти Цикл
			КоличествоСтрокПодчиненнойТЧ = Объект[ПодчиненнаяТабличнаяЧасть].Количество();
			Если КоличествоСтрокПодчиненнойТЧ > МасимальноеКоличествоСтрокТЧ Тогда
				ПодчиненнаяТЧМаксимальноеКоличествоСтрок = ПодчиненнаяТабличнаяЧасть;
				МасимальноеКоличествоСтрокТЧ = КоличествоСтрокПодчиненнойТЧ;
			КонецЕсли;
			
		КонецЦикла;
		
		Если МасимальноеКоличествоСтрокТЧ > МаксимальноеКоличествоСтрок Тогда
			
			Отказ = Истина;
			КоличествоСтрокДляПереноса = МасимальноеКоличествоСтрокТЧ - МаксимальноеКоличествоСтрок;
			КоличествоНовыхДокументов = КоличествоНовыхДокументов + 
										Цел(КоличествоСтрокДляПереноса / МаксимальноеКоличествоСтрок) +
										?(КоличествоСтрокДляПереноса % МаксимальноеКоличествоСтрок <> 0, 1, 0);
			ТабличнаяЧасть.Значение.Вставить("КоличествоСтрокДляПереноса", КоличествоСтрокДляПереноса);
			
			Если МасимальноеКоличествоСтрокТЧ > КоличествоСтрокОсновнойТЧ Тогда
				
				ТабличнаяЧасть.Значение.Вставить("ПодчиненнаяТЧМаксимальноеКоличествоСтрок", ПодчиненнаяТЧМаксимальноеКоличествоСтрок); 
				
				// Вычисляем сколько нужно перенести строк с конца основной табличной части
				
				КоличествоСтрокДляПереносаИзОсновнойТЧ = 0;
				КоличествоСтрокДляПереносаИзПодчиненнойТЧ = 0;
				ОстатокСтрокДляПереносаИзПодчиненнойТЧ = 0;
				ИндексПоследнийСтрокиОсновнойТЧ = КоличествоСтрокОсновнойТЧ - 1;
				ИндкесНачалаНовогоДокумента = ИндексПоследнийСтрокиОсновнойТЧ;
				КоличествоСтрокОсновнойТЧНовогоДокумента = 0;
				
				Пока КоличествоСтрокДляПереноса > КоличествоСтрокДляПереносаИзПодчиненнойТЧ
					И ИндексПоследнийСтрокиОсновнойТЧ >= 0 Цикл
					
					СтрокаТЧ = ОсновнаяТЧ[ИндексПоследнийСтрокиОсновнойТЧ];
					КлючПоиска = Новый Структура("КлючСтроки", СтрокаТЧ.КлючСтроки);
					МассивСтрок = Объект[ПодчиненнаяТЧМаксимальноеКоличествоСтрок].НайтиСтроки(КлючПоиска);
					КоличествоСтрокДляПереносаИзПодчиненнойТЧ = КоличествоСтрокДляПереносаИзПодчиненнойТЧ + МассивСтрок.Количество();
					
					Если КоличествоСтрокДляПереносаИзПодчиненнойТЧ - ОстатокСтрокДляПереносаИзПодчиненнойТЧ >
						МаксимальноеКоличествоСтрок Тогда
						
						Если КоличествоСтрокОсновнойТЧНовогоДокумента = 0 Тогда
							КоличествоСтрокОсновнойТЧНовогоДокумента = ИндкесНачалаНовогоДокумента - ИндексПоследнийСтрокиОсновнойТЧ;
						Иначе
							КоличествоСтрокОсновнойТЧНовогоДокумента = Мин(КоличествоСтрокОсновнойТЧНовогоДокумента,
													ИндкесНачалаНовогоДокумента - ИндексПоследнийСтрокиОсновнойТЧ);
						КонецЕсли;
							
						ОстатокСтрокДляПереносаИзПодчиненнойТЧ = КоличествоСтрокДляПереносаИзПодчиненнойТЧ - МассивСтрок.Количество();
						ИндкесНачалаНовогоДокумента = ИндексПоследнийСтрокиОсновнойТЧ;
						
					КонецЕсли;
						
					КоличествоСтрокДляПереносаИзОсновнойТЧ = КоличествоСтрокДляПереносаИзОсновнойТЧ + 1;
					ИндексПоследнийСтрокиОсновнойТЧ = ИндексПоследнийСтрокиОсновнойТЧ - 1;
					
				КонецЦикла;
				
				ТабличнаяЧасть.Значение.Вставить("КоличествоСтрокДляПереноса", КоличествоСтрокДляПереносаИзОсновнойТЧ);
				ТабличнаяЧасть.Значение.Вставить("МаксимальноеКоличествоСтрокВДокументе", КоличествоСтрокОсновнойТЧНовогоДокумента);
				
			КонецЕсли;
			
		КонецЕсли;
		
	КонецЦикла;
	
	Если Отказ Тогда
		ПараметрыПереносаСтрокТЧ.Вставить("МаксимальноеКоличествоСтрок", МаксимальноеКоличествоСтрок);
		ПараметрыПереносаСтрокТЧ.Вставить("Объект", Объект);
		
		Оповещение = Новый ОписаниеОповещения("ВопросПеренестиСтрокиТабличныхЧастейВДругойДокументЗавершение", Форма, ПараметрыПереносаСтрокТЧ);
		
		ТекстВопроса = СтрШаблон(НСтр("ru = 'В табличные части можно записать не более %1 строк.
			|Перенести превышающие лимит записи строки в %2 ?';
			|en = 'You can write no more than %1 rows to tables.
			|Do you want to move the rows that exceed the limit to %2?'"),
			МаксимальноеКоличествоСтрок,
			?(КоличествоНовыхДокументов = 1,НСтр("ru = 'новый документ';
												|en = 'new document'"),НСтр("ru = 'новые документы';
																			|en = 'new documents'")));
			
		ПоказатьВопрос(Оповещение, ТекстВопроса, РежимДиалогаВопрос.ДаНет, , КодВозвратаДиалога.Да);
		
	КонецЕсли;
	
	Возврат Отказ;
	
КонецФункции

// Процедура оповещает об успехе, либо неудачи переноса в новый документ (новые документы)
// строк, которые превыщают лимит количества записи строк табличной части (табличных частей) в базу данных.
// Внутри себя вызывает функцию разбиения табличной части (табличных частей) на несколько документов.
//
// Параметры:
//   ПараметрыПереносаСтрокТЧ - Структура - структура входных параметров с ключами:
//     * ТабличныеЧасти          - Соответвие - соотствие между проверяемой табличной частью и подчиненной.
//               * Ключ             - Строка - имя проверяемой табличной части
//               * Значение         - Структура - структура с ключами:
//....................* КоличествоСтрокДляПереноса - Число - обязательный ключ в него записывается вычисляемое в функции
//..........................................................количество строк для переноса проверяемой табличной части.
//                    * ПодчиненныеТабличныеЧасти - Массив - необязательный ключ является массивом подчинённых
//                                                           табличных частей для переноса строк в новый документ.
//     * РеквизитыДокумента          - Строка - список реквизитов для копирования из документа.
//     * РежимЗаписи                 - РежимЗаписиДокумента - режим записи документа.
//     * МаксимальноеКоличествоСтрок - Число - максимальное количество строк, хранимое платформой в табличной части.
//     * Объект                      - ДанныеФормыСтруктура - объект клиентской формы документа, для которого нужно
//                                                            перености строки табличных частей в новый документ.
//
Процедура ПеренестиСтрокиТабличныхЧастейВДругойДокумент(ПараметрыПереносаСтрокТЧ) Экспорт
	
	Если УчетНДСВызовСервера.ПеренестиСтрокиТабличныхЧастейВДругойДокументНаСервере(ПараметрыПереносаСтрокТЧ) Тогда
		
		ПоказатьОповещениеПользователя(НСтр("ru = 'Создание:';
											|en = 'Create:'"),,
			НСтр("ru = 'Перенос строк произошел успешно.';
				|en = 'Rows are moved.'"),
			БиблиотекаКартинок.ВажнаяИнформация32,
			СтатусОповещенияПользователя.Информация);
	Иначе
		
		Сообщение = Новый СообщениеПользователю;
		Сообщение.Текст = НСтр("ru = ' Не удалось создать новый документ для переноса строк табличной части. ';
								|en = ' Cannot create a new document to move table rows.'")+
						ПараметрыПереносаСтрокТЧ.ИнформацияОбОшибке;
		Сообщение.Сообщить();
		
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти

#КонецОбласти
