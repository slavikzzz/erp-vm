///////////////////////////////////////////////////////////////////////////////////////////////////////
// Copyright (c) 2024, ООО 1С-Софт
// Все права защищены. Эта программа и сопроводительные материалы предоставляются 
// в соответствии с условиями лицензии Attribution 4.0 International (CC BY 4.0)
// Текст лицензии доступен по ссылке:
// https://creativecommons.org/licenses/by/4.0/legalcode
///////////////////////////////////////////////////////////////////////////////////////////////////////

#Область СлужебныеПроцедурыИФункции

// Отправляет SMS через SMS.RU.
//
// Параметры:
//  НомераПолучателей - Массив - номера получателей в формате +7ХХХХХХХХХХ;
//  Текст 			  - Строка - текст сообщения, длиной не более 480 символов;
//  ИмяОтправителя 	  - Строка - имя отправителя, которое будет отображаться вместо номера входящего SMS;
//  Логин			  - Строка - логин пользователя услуги отправки sms;
//  Пароль			  - Строка - пароль пользователя услуги отправки sms.
//
// Возвращаемое значение:
//   см. ОтправкаSMS.ОтправитьSMS.
//
Функция ОтправитьSMS(НомераПолучателей, Текст, ИмяОтправителя, Логин, Пароль) Экспорт
	
	Результат = Новый Структура("ОтправленныеСообщения,ОписаниеОшибки", Новый Массив, "");
	
	ФорматированныеНомераТелефонов = ФорматироватьНомераТелефонов(НомераПолучателей);
	Получатели = Новый Массив;
	
	Для Каждого Номер Из НомераПолучателей Цикл
		Если ФорматированныеНомераТелефонов[Номер] <> Неопределено Тогда
			Получатели.Добавить(ФорматированныеНомераТелефонов[Номер]);
		КонецЕсли;
	КонецЦикла;
	
	СтрокаПолучателей = СтрСоединить(Получатели, ",");
	
	Если ПустаяСтрока(СтрокаПолучателей) Или ПустаяСтрока(Текст) Тогда
		Результат.ОписаниеОшибки = НСтр("ru = 'Неверные параметры сообщения';
										|en = 'Invalid message parameters'");
		Возврат Результат;
	КонецЕсли;
	
	УстановитьПривилегированныйРежим(Истина);
	НастройкиОтправкиSMS = ОтправкаSMS.НастройкиОтправкиSMS();
	УстановитьПривилегированныйРежим(Истина);

	ПараметрыЗапроса = Новый Структура;
	
	Если НастройкиОтправкиSMS.Свойство("СпособАвторизации") И НастройкиОтправкиSMS.СпособАвторизации = "ПоИдентификатору" Тогда
		ПараметрыЗапроса.Вставить("api_id", Пароль);
	Иначе
		ПараметрыЗапроса.Вставить("login", Логин);
		ПараметрыЗапроса.Вставить("password", Пароль);
	КонецЕсли;
	
	ПараметрыЗапроса.Вставить("text", Текст);
	ПараметрыЗапроса.Вставить("to", СтрокаПолучателей);
	ПараметрыЗапроса.Вставить("from", ИмяОтправителя);
	ПараметрыЗапроса.Вставить("json", 1);
	
	ТекстОтвета = ВыполнитьЗапрос("sms/send", ПараметрыЗапроса);
	Если Не ЗначениеЗаполнено(ТекстОтвета) Тогда
		Результат.ОписаниеОшибки = Результат.ОписаниеОшибки + НСтр("ru = 'Соединение не установлено';
																	|en = 'Connection failed'");
		Возврат Результат;
	КонецЕсли;
	
	РезультатЗапроса = ОбщегоНазначения.JSONВЗначение(ТекстОтвета);
	
	ЗапросПринят = РезультатЗапроса["status"] = "OK";
	ТекстСостояния = РезультатЗапроса["status_text"];
	КодСостояния = РезультатЗапроса["status_code"];
	
	Если ЗапросПринят И ЗначениеЗаполнено(РезультатЗапроса["sms"]["empty_phone"]) Тогда
		ЗапросПринят = Ложь;
		ТекстСостояния = РезультатЗапроса["sms"]["empty_phone"]["real_status_text"];
		КодСостояния = РезультатЗапроса["sms"]["empty_phone"]["real_status"];
	КонецЕсли;
	
	Если Не ЗапросПринят Тогда
		Если ЗначениеЗаполнено(ТекстСостояния) Тогда
			Причина = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(НСтр("ru = '%1 (код состояния: %2)';
																					|en = '%1 (status code: %2)'"), ТекстСостояния, КодСостояния);
		Иначе
			Причина = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(НСтр("ru = 'Код состояния: %1';
																					|en = 'Status code: %1'"), КодСостояния);
		КонецЕсли;
		
		Результат.ОписаниеОшибки = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
			НСтр("ru = 'Отправка SMS не выполнена по причине:
			|%1';
			|en = 'Couldn''t send text message due to:
			|%1'"), Причина);
		
		ЗаписьЖурналаРегистрации(НСтр("ru = 'Отправка SMS';
										|en = 'Text messaging'", ОбщегоНазначения.КодОсновногоЯзыка()),
			УровеньЖурналаРегистрации.Ошибка, , , Результат.ОписаниеОшибки);
		Возврат Результат;
	КонецЕсли;
	
	ТекстыОшибок = Новый Массив;
	
	Для Каждого НомерПолучателя Из НомераПолучателей Цикл
		
		ИдентификаторСообщения = "";
		СтатусОтправкиПолучателю = РезультатЗапроса["sms"][ФорматированныеНомераТелефонов[НомерПолучателя]];
		
		Если СтатусОтправкиПолучателю <> Неопределено Тогда
			ИдентификаторСообщения = СтатусОтправкиПолучателю["sms_id"];
			
			Если СтатусОтправкиПолучателю["status_text"] = "ERROR" Тогда
				ТекстСостояния = СтатусОтправкиПолучателю["status_text"];
				КодСостояния = СтатусОтправкиПолучателю["status_code"];
				
				ТекстыОшибок.Добавить(СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
					НСтр("ru = '%1: %2 (код состояния: %3)';
						|en = '%1: %2 (status code: %3)'"),
					НомерПолучателя,
					ТекстСостояния,
					КодСостояния));
				
				Продолжить;
			КонецЕсли;
		КонецЕсли;
		
		Если Не ПустаяСтрока(НомерПолучателя) И ЗначениеЗаполнено(ИдентификаторСообщения) Тогда
			ОтправленноеСообщение = Новый Структура("НомерПолучателя,ИдентификаторСообщения",
				НомерПолучателя,ИдентификаторСообщения);
			Результат.ОтправленныеСообщения.Добавить(ОтправленноеСообщение);
		КонецЕсли;
		
	КонецЦикла;
	
	Если ЗначениеЗаполнено(ТекстыОшибок) Тогда
		Результат.ОписаниеОшибки = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
			НСтр("ru = 'Отправка SMS не выполнена следующим получателям:
			|%1';
			|en = 'Couldn''t send text message to:
			|%1'"), СтрСоединить(ТекстыОшибок, Символы.ПС));
	КонецЕсли;
		
	Возврат Результат;
	
КонецФункции

// Возвращает текстовое представление статуса доставки сообщения.
//
// Параметры:
//  ИдентификаторСообщения - Строка - идентификатор, присвоенный sms при отправке.
//  НастройкиОтправкиSMS   - см. ОтправкаSMS.НастройкиОтправкиSMS.
//
// Возвращаемое значение:
//   см. ОтправкаSMS.СтатусДоставки.
//
Функция СтатусДоставки(ИдентификаторСообщения, НастройкиОтправкиSMS) Экспорт
	
	ИдентификаторыСообщений = ОбщегоНазначенияКлиентСервер.ЗначениеВМассиве(ИдентификаторСообщения);
	Возврат СтатусыДоставки(ИдентификаторыСообщений, НастройкиОтправкиSMS)[ИдентификаторСообщения];
	
КонецФункции

Функция СтатусДоставкиSMS(КодСостояния)
	
	СоответствиеСтатусов = Новый Соответствие;
	СоответствиеСтатусов.Вставить("-1", "НеОтправлялось");
	СоответствиеСтатусов.Вставить("100", "НеОтправлялось");
	СоответствиеСтатусов.Вставить("101", "Отправляется");
	СоответствиеСтатусов.Вставить("102", "Отправлено");
	СоответствиеСтатусов.Вставить("103", "Доставлено");
	СоответствиеСтатусов.Вставить("104", "НеДоставлено");
	СоответствиеСтатусов.Вставить("105", "НеДоставлено");
	СоответствиеСтатусов.Вставить("106", "НеДоставлено");
	СоответствиеСтатусов.Вставить("107", "НеДоставлено");
	СоответствиеСтатусов.Вставить("108", "НеДоставлено");
	СоответствиеСтатусов.Вставить("150", "НеДоставлено");
	
	Результат = СоответствиеСтатусов[НРег(КодСостояния)];
	Возврат ?(Результат = Неопределено, "Ошибка", Результат);
	
КонецФункции

Функция ОписанияОшибок()
	ОписанияОшибок = Новый Соответствие;
	ОписанияОшибок.Вставить("200", НСтр("ru = 'Авторизация не выполнена: неверный api_id.';
										|en = 'Authorization failed: Invalid api_id.'"));
	ОписанияОшибок.Вставить("201", НСтр("ru = 'Недостаточно средств на лицевом счету.';
										|en = 'Insufficient funds.'"));
	ОписанияОшибок.Вставить("202", НСтр("ru = 'Неправильно указан получатель.';
										|en = 'Invalid recipient.'"));
	ОписанияОшибок.Вставить("203", НСтр("ru = 'Нет текста сообщения.';
										|en = 'Blank text message.'"));
	ОписанияОшибок.Вставить("204", НСтр("ru = 'Имя отправителя не согласовано с провайдером (SMS.RU).';
										|en = 'Sender name not approved by provider (SMS.RU).'"));
	ОписанияОшибок.Вставить("205", НСтр("ru = 'Сообщение слишком длинное (превышает 8 SMS).';
										|en = 'Message exceeds the limit of 8 SMS messages.'"));
	ОписанияОшибок.Вставить("206", НСтр("ru = 'Достигнут дневной лимит на отправку сообщений.';
										|en = 'Daily outbound message limit reached.'"));
	ОписанияОшибок.Вставить("207", НСтр("ru = 'На этот номер (или один из номеров) нельзя отправлять сообщения, либо указано более 100 номеров в списке получателей';
										|en = 'Cannot send messages to a recipient, or 100 recipient limit is exceeded.'"));
	ОписанияОшибок.Вставить("208", НСтр("ru = 'Параметр time указан неправильно.';
										|en = 'Invalid ""time"" parameter.'"));
	ОписанияОшибок.Вставить("209", НСтр("ru = 'Номер получателя (или один из номеров) в стоп-листе (см. в личном кабинете на сайте).';
										|en = 'A recipient is on a stop list. Consider stop list in your account on the provider website.'"));
	ОписанияОшибок.Вставить("210", НСтр("ru = 'Используется GET, где необходимо использовать POST.';
										|en = 'GET is used where POST is required.'"));
	ОписанияОшибок.Вставить("211", НСтр("ru = 'Метод не существует.';
										|en = 'Method not found.'"));
	ОписанияОшибок.Вставить("212", НСтр("ru = 'Неверная кодировка текста сообщения (необходимо использовать UTF-8).';
										|en = 'Invalid message text encoding; UTF-8 required.'"));
	ОписанияОшибок.Вставить("220", НСтр("ru = 'Сервис временно недоступен.';
										|en = 'Service temporarily unavailable.'"));
	ОписанияОшибок.Вставить("230", НСтр("ru = 'Сообщение не принято к отправке: достигнут дневной лимит сообщений на один номер (60 шт).';
										|en = 'Daily limit of 60 messages to single recipient reached.'"));
	ОписанияОшибок.Вставить("300", НСтр("ru = 'Авторизация не выполнена: token устарел (истек срок действия, либо изменился IP отправителя.';
										|en = 'Authorization failed: Token expired or sender IP address changed.'"));
	ОписанияОшибок.Вставить("301", НСтр("ru = 'Авторизация не выполнена: логин или пароль указаны неверно.';
										|en = 'Authorization failed: Invalid credentials.'"));
	ОписанияОшибок.Вставить("302", НСтр("ru = 'Авторизация не выполнена: пользователь авторизован, но аккаунт не подтвержден (пользователь не ввел код, присланный в регистрационной SMS.)';
										|en = 'Authorization failed: User account not confirmed.'"));
	
	Возврат ОписанияОшибок;
КонецФункции

Функция ОписаниеОшибкиПолученияСтатуса(КодОшибки)
	ОписанияОшибок =ОписанияОшибок();
	ТекстСообщения = ОписанияОшибок[КодОшибки];
	Если ТекстСообщения = Неопределено Тогда
		ТекстСообщения = НСтр("ru = 'Отказ выполнения операции';
								|en = 'Operation failed'");
	КонецЕсли;
	Возврат ТекстСообщения;
КонецФункции

Функция ВыполнитьЗапрос(ИмяМетода, ПараметрыЗапроса)
	
	HTTPЗапрос = ОтправкаSMS.ПодготовитьHTTPЗапрос("/" + ИмяМетода, ПараметрыЗапроса);
	HTTPОтвет = Неопределено;
	
	Попытка
		Соединение = Новый HTTPСоединение("sms.ru", , , , ПолучениеФайловИзИнтернета.ПолучитьПрокси("https"),
			60, ОбщегоНазначенияКлиентСервер.НовоеЗащищенноеСоединение());
			
		HTTPОтвет = Соединение.ОтправитьДляОбработки(HTTPЗапрос);
	Исключение
		ЗаписьЖурналаРегистрации(НСтр("ru = 'Отправка SMS';
										|en = 'Text messaging'", ОбщегоНазначения.КодОсновногоЯзыка()),
			УровеньЖурналаРегистрации.Ошибка, , , ОбработкаОшибок.ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()));
		Возврат Неопределено;
	КонецПопытки;
	
	Если HTTPОтвет <> Неопределено Тогда
		Если HTTPОтвет.КодСостояния <> 200 Тогда
			ТекстОшибки = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
				НСтр("ru = 'Запрос ""%1"" не выполнен. Код состояния: %2.';
					|en = 'Request failed: %1. Status code: %2.'"), ИмяМетода, HTTPОтвет.КодСостояния) + Символы.ПС
				+ HTTPОтвет.ПолучитьТелоКакСтроку();
			ЗаписьЖурналаРегистрации(НСтр("ru = 'Отправка SMS';
											|en = 'Text messaging'", ОбщегоНазначения.КодОсновногоЯзыка()),
				УровеньЖурналаРегистрации.Ошибка, , , ТекстОшибки);
			Возврат Неопределено;
		КонецЕсли;
		
		Возврат HTTPОтвет.ПолучитьТелоКакСтроку();
	КонецЕсли;
	
	Возврат Неопределено;
	
КонецФункции

Функция ФорматироватьНомер(Знач Номер)
	
	ДопустимыеСимволы = "1234567890";
	ЛишниеСимволы = СтрСоединить(СтрРазделить(Номер, ДопустимыеСимволы, Ложь), "");
	
	Возврат СтрСоединить(СтрРазделить(Номер, ЛишниеСимволы, Ложь), "");
	
КонецФункции

Функция ФорматироватьНомераТелефонов(Знач НомераТелефонов)
	
	Результат = Новый Соответствие;
	
	Для Каждого НомерТелефона Из НомераТелефонов Цикл
		ФорматированныйНомер = ФорматироватьНомер(НомерТелефона);
		Если ЗначениеЗаполнено(ФорматированныйНомер) Тогда
			Результат.Вставить(НомерТелефона, ФорматированныйНомер);
		КонецЕсли;
	КонецЦикла;
	
	Возврат Результат;
	
КонецФункции

// Возвращает список разрешений для отправки SMS с использованием всех доступных провайдеров.
//
// Возвращаемое значение:
//  Массив
//
Функция Разрешения() Экспорт
	
	Протокол = "HTTP";
	Адрес = "sms.ru";
	Порт = Неопределено;
	Описание = НСтр("ru = 'Отправка SMS через ""SMS.RU"".';
					|en = 'Text messaging via SMS.RU.'");
	
	МодульРаботаВБезопасномРежиме = ОбщегоНазначения.ОбщийМодуль("РаботаВБезопасномРежиме");
	
	Разрешения = Новый Массив;
	Разрешения.Добавить(
		МодульРаботаВБезопасномРежиме.РазрешениеНаИспользованиеИнтернетРесурса(Протокол, Адрес, Порт, Описание));
	
	Возврат Разрешения;
КонецФункции

Процедура ПриОпределенииНастроек(Настройки) Экспорт
	
	Настройки.АдресОписанияУслугиВИнтернете = "https://sms.ru";
	Настройки.ПриОпределенииСпособовАвторизации = Истина;
	Настройки.ПриОпределенииПолейАвторизации = Истина;
	Настройки.СтатусыДоставкиОднимЗапросом = Истина;
	
КонецПроцедуры

Процедура ПриОпределенииСпособовАвторизации(СпособыАвторизации) Экспорт
	
	СпособыАвторизации.Очистить();
	СпособыАвторизации.Добавить("ПоИдентификатору", НСтр("ru = 'По ключу (рекомендуется)';
														|en = 'API token (recommended)'"));
	СпособыАвторизации.Добавить("ПоЛогинуИПаролю", НСтр("ru = 'По логину и паролю';
														|en = 'Username and password authentication'"));
	
КонецПроцедуры

Процедура ПриОпределенииПолейАвторизации(СпособыАвторизации) Экспорт
	
	ПоляАвторизации = Новый СписокЗначений;
	ПоляАвторизации.Добавить("Пароль", НСтр("ru = 'api_id';
											|en = 'api_id'"));
	
	СпособыАвторизации.Вставить("ПоИдентификатору", ПоляАвторизации);
	
	ПоляАвторизации = Новый СписокЗначений;
	ПоляАвторизации.Добавить("Логин", НСтр("ru = 'Логин';
											|en = 'Username'"));
	ПоляАвторизации.Добавить("Пароль", НСтр("ru = 'Пароль';
											|en = 'Password'"));

	СпособыАвторизации.Вставить("ПоЛогинуИПаролю", ПоляАвторизации);
	
КонецПроцедуры

// Запрашивает статус доставки сообщения у поставщика услуг.
//
// Параметры:
//  ИдентификаторыСообщений - см. ОтправкаSMS.СтатусыДоставки.ИдентификаторыСообщений
//  НастройкиОтправкиSMS    - см. ОтправкаSMS.НастройкиОтправкиSMS
//  
// Возвращаемое значение:
//   См. ОтправкаSMS.СтатусыДоставки
//
Функция СтатусыДоставки(ИдентификаторыСообщений, НастройкиОтправкиSMS) Экспорт
	
	СтатусыДоставки = Новый Соответствие;
	
	Для Каждого ИдентификаторСообщения Из ИдентификаторыСообщений Цикл
		СтатусыДоставки[ИдентификаторСообщения] = "Ошибка";
	КонецЦикла;
	
	Логин = НастройкиОтправкиSMS.Логин;
	Пароль = НастройкиОтправкиSMS.Пароль;
	
	ПараметрыЗапроса = Новый Структура;
	
	Если НастройкиОтправкиSMS.Свойство("СпособАвторизации") И НастройкиОтправкиSMS.СпособАвторизации = "ПоИдентификатору" Тогда
		ПараметрыЗапроса.Вставить("api_id", Пароль);
	Иначе
		ПараметрыЗапроса.Вставить("login", Логин);
		ПараметрыЗапроса.Вставить("password", Пароль);
	КонецЕсли;
	
	ПараметрыЗапроса.Вставить("id", СтрСоединить(ИдентификаторыСообщений, ","));
	ПараметрыЗапроса.Вставить("json", 1);
	
	ТекстОтвета = ВыполнитьЗапрос("sms/status", ПараметрыЗапроса);
	Если Не ЗначениеЗаполнено(ТекстОтвета) Тогда
		Возврат СтатусыДоставки;
	КонецЕсли;
	
	РезультатЗапроса = ОбщегоНазначения.JSONВЗначение(ТекстОтвета);
	
	Если РезультатЗапроса["status"] <> "OK" Тогда
		ТекстСостояния = РезультатЗапроса["status_text"];
		КодСостояния = РезультатЗапроса["status_code"];
		
		Если ЗначениеЗаполнено(ТекстСостояния) Тогда
			Причина = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(НСтр("ru = '%1 (код состояния: %2)';
																					|en = '%1 (status code: %2)'"), ТекстСостояния, КодСостояния);
		Иначе
			Причина = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(НСтр("ru = 'Код состояния: %1';
																					|en = 'Status code: %1'"), КодСостояния);
		КонецЕсли;
		
		ОписаниеОшибки = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
			НСтр("ru = 'Не удалось проверить статус доставки SMS по причине:
			|%1';
			|en = 'Failed to confirm delivery status. Reason:
			|%1'"), Причина);
		
		ЗаписьЖурналаРегистрации(НСтр("ru = 'Отправка SMS';
										|en = 'Text Messaging'", ОбщегоНазначения.КодОсновногоЯзыка()),
			УровеньЖурналаРегистрации.Ошибка, , , ОписаниеОшибки);
			
		Возврат СтатусыДоставки;
	КонецЕсли;
	
	Для Каждого ИдентификаторСообщения Из ИдентификаторыСообщений Цикл
		КодСостояния = РезультатЗапроса["sms"][ИдентификаторСообщения]["status_code"];
		СтатусДоставки = СтатусДоставкиSMS(КодСостояния);
		СтатусыДоставки[ИдентификаторСообщения] = СтатусДоставкиSMS(КодСостояния);
		
		Если СтатусДоставки = "Ошибка" Тогда
			ОписаниеОшибки = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(НСтр(
				"ru = 'Не удалось получить статус доставки SMS (id: ""%3""):
				|%1 (код ошибки: %2)';
				|en = 'Getting delivery status for SMS message with ID %3 failed with error code %2.
				|Details: %1'"), ОписаниеОшибкиПолученияСтатуса(РезультатЗапроса), КодСостояния, ИдентификаторСообщения);
			ЗаписьЖурналаРегистрации(НСтр("ru = 'Отправка SMS';
											|en = 'Text Messaging'", ОбщегоНазначения.КодОсновногоЯзыка()),
				УровеньЖурналаРегистрации.Ошибка, , , ОписаниеОшибки);
		КонецЕсли;
	КонецЦикла;
	
	Возврат СтатусыДоставки;
	
КонецФункции

#КонецОбласти

