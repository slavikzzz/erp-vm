
// ПартионныйУчет - модуль оффлайнового (неоперативного) расчета регистров партий
// 
// Заметки по концепции:
//
// * Партии.Первичное = Истина означает, что запись не будет разбита, но может быть дополнена данными.
// Если Партии.Первичное = Ложь, то запись может быть перезаписана, разбита на записи, удалена и т.д.
//
// * Партии.ДокументИсточник показывает документ возникновения остатка.
// Для расходов текущего периода это будет документ поступления или перемещения на организацию/склад,
// для приходов перемещений/пересортиц и прочих расходно-приходных документов это будет сам документ
// перемещения, для сторнирующих документов это будет документ реализации.
// При расходах по остаткам прошлого периода это будет документ партии (поступления).
// Реквизит нужен для протягивания партий затрат и партий расходов на с/с по движениям перемещений.
//
// * Записи с типом "Остаток" никогда не пишутся в базу.
////////////////////////////////////////////////////////////////////////////////////////////////////

#Область ПрограммныйИнтерфейс

// Выполняет полный расчет партий.
//
// Параметры:
//	ОкончаниеПериодаРасчета - Дата - конец периода (месяца), до которого надо выполнить расчет
//	Организация - СправочникСсылка.Организации - организация, по которым надо выполнить расчет.
//	ВыполняетсяЗакрытиеМесяца - Булево - признак выполнения регламентных операций по закрытию месяца
//
Процедура РассчитатьВсе(Знач ОкончаниеПериодаРасчета, Организация = Неопределено, ВыполняетсяЗакрытиеМесяца = Ложь, АвтоматическоеТестирование = Ложь) Экспорт
	
	УстановитьПривилегированныйРежим(Истина);
	
	ИдентификаторРасчета = Новый УникальныйИдентификатор;
	
	// Проверим, закончено ли обновление ИБ
	РасчетСебестоимостиПрикладныеАлгоритмы.ПроверитьБлокировкуДанныхПриОбновленииИБ(
		Ложь,
		РасчетСебестоимостиПовтИсп.ПартионныйУчетВерсии22(НачалоМесяца(ОкончаниеПериодаРасчета)));
	
	УровеньИнформация = УровеньЖурналаРегистрации.Информация;
	ФорматПериода = "ДЛФ=D";
	КодЯзыка = ОбщегоНазначения.КодОсновногоЯзыка();
	
	НомерЗаданияДоРасчета = РасчетСебестоимостиПрикладныеАлгоритмы.УвеличитьНомерЗаданияКРасчетуСебестоимости();
	
	#Область СхемаРасчета
	
	НачатьТранзакцию();
	
	Попытка
		
		// Определим по каким периодам и организациям требуется перерасчет.
		СхемаРасчета = РасчетСебестоимостиПрикладныеАлгоритмы.СхемаРасчетаПартий(
			ОкончаниеПериодаРасчета,
			Организация,
			НомерЗаданияДоРасчета);
			
		Если СхемаРасчета.Количество() > 0 Тогда
			ВременныеТаблицы = РасчетСебестоимостиПрикладныеАлгоритмы.СформироватьВТЗаданияДоРасчета(
				НомерЗаданияДоРасчета,
				СхемаРасчета[СхемаРасчета.Количество() - 1].Организации);
		КонецЕсли;
		
		ЗафиксироватьТранзакцию();
		
	Исключение
		ОтменитьТранзакцию();
		ТекстОшибки = ПодробноеПредставлениеОшибки(ИнформацияОбОшибке());
		ВызватьИсключение ТекстОшибки;
	КонецПопытки;
		
	Если СхемаРасчета.Количество() = 0 Тогда
		
		// Расчет не требуется (ни в версии 2.1, ни в версии 2.2)
		Комментарий = НСтр("ru = 'Расчет партий по %ОкончаниеПериода% не требуется - партии уже рассчитаны';
							|en = 'It is not required to calculate batches up to %ОкончаниеПериода%  - the batches have already been calculated'", КодЯзыка);
		Комментарий = СтрЗаменить(Комментарий, "%ОкончаниеПериода%", Формат(ОкончаниеПериодаРасчета, ФорматПериода));
		
		ЗаписьЖурналаРегистрации(
			НСтр("ru = 'Партионный учет.Расчет не требуется';
				|en = 'Batch accounting.Calculation is not required'", КодЯзыка),
			УровеньИнформация,
			,
			ОкончаниеПериодаРасчета,
			Комментарий);
		
		Возврат;
		
	КонецЕсли;
	
	ФактическоеОкончаниеПериодаРасчета = ОкончаниеПериодаРасчета;
	
	Если РасчетСебестоимостиПовтИсп.ПартионныйУчетВерсии22(НачалоМесяца(ОкончаниеПериодаРасчета)) Тогда
		
		ДатаПереходаНаПартионныйУчетВерсии22 = РасчетСебестоимостиПовтИсп.ДатаПереходаНаПартионныйУчетВерсии22();
		Если ЗначениеЗаполнено(ДатаПереходаНаПартионныйУчетВерсии22) Тогда
			Если ОкончаниеПериодаРасчета >= ДатаПереходаНаПартионныйУчетВерсии22 Тогда
				// Этим механизмом (версии 2.1) можно рассчитать партии только до даты перехода
				ОкончаниеПериодаРасчета = ДатаПереходаНаПартионныйУчетВерсии22 - 1;
			КонецЕсли;
		Иначе
			ОкончаниеПериодаРасчета = Дата(1, 1, 1); // расчет в версии 2.1 не требуется - будет выполнен расчет в версии 2.2
		КонецЕсли;
		
	КонецЕсли;
	
	НеобходимРасчет = (НачалоМесяца(СхемаРасчета[0].Дата) <= НачалоМесяца(ОкончаниеПериодаРасчета));
	РассчитанныеСтрокиСхемы = Новый Массив;
	
	#КонецОбласти
	
	Если НеобходимРасчет Тогда
		
		ПартионныйУчетВключен = РасчетСебестоимостиПовтИсп.ПартионныйУчетВерсии21(НачалоМесяца(СхемаРасчета[0].Дата));
		
		ОписаниеЗамера = ОценкаПроизводительности.НачатьЗамерДлительнойОперации("ЗакрытиеМесяца.РасчетПартийИСебестоимости");
		КоличествоПовторяющихсяДанных = 0;
		
		Комментарий = НСтр("ru = 'Выполняется расчет партий версии 2.1 по %ОкончаниеПериода%';
							|en = 'Calculating batches of version 2.1 till %ОкончаниеПериода%'", КодЯзыка);
		Комментарий = СтрЗаменить(Комментарий, "%ОкончаниеПериода%", Формат(ОкончаниеПериодаРасчета, ФорматПериода));
		ЗаписьЖурналаРегистрации(
			НСтр("ru = 'Партионный учет.Начало расчета';
				|en = 'Batch accounting.Calculation start'", КодЯзыка), УровеньИнформация, , ОкончаниеПериодаРасчета, Комментарий);
		
		Для Каждого СтрокаСхемыРасчета Из СхемаРасчета Цикл
			
			Если НЕ РасчетСебестоимостиПовтИсп.ВозможенРасчетСебестоимости(НачалоМесяца(СтрокаСхемыРасчета.Дата)) Тогда
				
				РегистрыСведений.ЗаданияКРасчетуСебестоимости.ОчиститьЗаписиЗаПериод(
					НачалоМесяца(СтрокаСхемыРасчета.Дата),
					КонецМесяца(СтрокаСхемыРасчета.Дата),
					СтрокаСхемыРасчета.Организации);
				
				Продолжить;
				
			КонецЕсли;
			
			Если НачалоМесяца(СтрокаСхемыРасчета.Дата) > НачалоМесяца(ОкончаниеПериодаРасчета) Тогда
				// Дальше необходим расчет партий версии 2.2
				Прервать;
			КонецЕсли;
			
			Если НЕ ВыполняетсяЗакрытиеМесяца Тогда
				// Выполним операции механизма закрытиям месяца, вызываемые до расчета этапа.
				Если НЕ РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьОперацииЗакрытияМесяцаДляПодготовкиКРасчетуЭтапа(СтрокаСхемыРасчета, ИдентификаторРасчета) Тогда
					Возврат;
				КонецЕсли;
			КонецЕсли;
			
			НачалоПериода     = НачалоМесяца(СтрокаСхемыРасчета.Дата);
			ОкончаниеПериода  = КонецМесяца(СтрокаСхемыРасчета.Дата);
			МассивОрганизаций = СтрокаСхемыРасчета.Организации;
			
			// Выполним корректировки начальных остатков регистров партионного учета.
			КорректировкаНачальныхОстатковРегистраСебестоимостьТоваров(НачалоПериода, МассивОрганизаций, ПартионныйУчетВключен);
			
			Если АвтоматическоеТестирование Тогда
				ПерепровестиДокументыПоРегистрам(НачалоПериода, ОкончаниеПериода, МассивОрганизаций);
			КонецЕсли;
			
			//++ НЕ УТ
			РеглУчетСервер.ОбновитьЗаданияКЗакрытиюМесяцаПриВыполненииРеглОперации(НачалоПериода, МассивОрганизаций);
			//-- НЕ УТ

			// Исправление некорректных движений
			ИсправитьДвиженияВозвратТоваровМеждуОрганизациямиПоТоварамОрганизаций(НачалоПериода, ОкончаниеПериода, МассивОрганизаций);
			//++ НЕ УТ
			ВосстановитьДвиженияПоОтчетамПереработчикаСНекорректнойАналитикой(НачалоПериода, ОкончаниеПериода, МассивОрганизаций);
			//-- НЕ УТ

			// Устранение проблем первичных движений по себестоимости товаров
			ИсправитьДвиженияПеремещенийТоваровПоСебестоимостиТоваров(НачалоПериода, ОкончаниеПериода, МассивОрганизаций);
			ВосстановитьДвиженияПрочегоОприходованияТоваровПоСебестоимостиТоваров(НачалоПериода, ОкончаниеПериода, МассивОрганизаций);
			ВосстановитьДвиженияПоСебестоимостиТоваровСформированныеВВерсииПУ22(НачалоПериода, ОкончаниеПериода, МассивОрганизаций);
			ЗаполнитьКорОрганизациюВОперацияхРеглУчет(НачалоПериода, ОкончаниеПериода, МассивОрганизаций);
			ИсправитьКорОрганизациюВВозвратеМеждуОрганизациями(НачалоПериода, ОкончаниеПериода, МассивОрганизаций);
			ИсправитьКорОрганизациюВИсправлениеРазвернутогоСальдо(НачалоПериода, ОкончаниеПериода, МассивОрганизаций);
			ЗаполнитьВидыЗапасовИНазначенияВСебестоимостиТоваров(НачалоПериода, ОкончаниеПериода, МассивОрганизаций);
			ИсправитьДвиженияПриходовДопРасходовПоПрочимРасходам(НачалоПериода, ОкончаниеПериода, МассивОрганизаций);
			
			Если ПартионныйУчетВключен Тогда
				Документы.КорректировкаНалогообложенияНДСПартийТоваров.ОтменитьКорректировкуНалогообложенияНДС(ОкончаниеПериода);
				// Этап 1Х: расчет партий товаров
				РассчитатьПартииТоваров(НачалоПериода, ОкончаниеПериода, МассивОрганизаций, КоличествоПовторяющихсяДанных);
				ОценкаПроизводительности.ЗафиксироватьЗамерДлительнойОперации(ОписаниеЗамера, КоличествоПовторяющихсяДанных, "РассчитатьПартииТоваров");
				КоличествоПовторяющихсяДанных = 0;
				
				СозданаКорректировка = Ложь;
				Документы.КорректировкаНалогообложенияНДСПартийТоваров.СкорректироватьНалогообложениеНДС(ОкончаниеПериода, СозданаКорректировка);
				Если СозданаКорректировка Тогда
					РассчитатьПартииТоваров(НачалоПериода, ОкончаниеПериода, МассивОрганизаций);
				КонецЕсли;
				// Этап 16: расчет партий переданных на комиссию
				РассчитатьПартииПереданные(НачалоПериода, ОкончаниеПериода, МассивОрганизаций, КоличествоПовторяющихсяДанных);
				ОценкаПроизводительности.ЗафиксироватьЗамерДлительнойОперации(ОписаниеЗамера, КоличествоПовторяющихсяДанных, "РассчитатьПартииПереданные");
				КоличествоПовторяющихсяДанных = 0;
				// Этап 18: расчет партий производственных затрат.
				
				//++ НЕ УТ
				РассчитатьТрудозатраты(НачалоПериода, ОкончаниеПериода, МассивОрганизаций, КоличествоПовторяющихсяДанных); // ПУ 2.2 этап 6
				ОценкаПроизводительности.ЗафиксироватьЗамерДлительнойОперации(ОписаниеЗамера, КоличествоПовторяющихсяДанных, "РассчитатьТрудозатраты");
				КоличествоПовторяющихсяДанных = 0;
				РассчитатьРаспределениеМатериаловИРабот(НачалоПериода, ОкончаниеПериода, МассивОрганизаций, КоличествоПовторяющихсяДанных); // ПУ 2.2 этап 7
				ОценкаПроизводительности.ЗафиксироватьЗамерДлительнойОперации(ОписаниеЗамера, КоличествоПовторяющихсяДанных, "РассчитатьРаспределениеМатериаловИРабот");
				КоличествоПовторяющихсяДанных = 0;
				//-- НЕ УТ
				СформироватьДвиженияПоНДС(ОкончаниеПериода, МассивОрганизаций, КоличествоПовторяющихсяДанных);
				ОценкаПроизводительности.ЗафиксироватьЗамерДлительнойОперации(ОписаниеЗамера, КоличествоПовторяющихсяДанных, "СформироватьДвиженияПоНДС");
				КоличествоПовторяющихсяДанных = 0;
				РассчитатьПартииПроизводства(НачалоПериода, ОкончаниеПериода, МассивОрганизаций, КоличествоПовторяющихсяДанных);
				ОценкаПроизводительности.ЗафиксироватьЗамерДлительнойОперации(ОписаниеЗамера, КоличествоПовторяющихсяДанных, "РассчитатьПартииПроизводства");
				КоличествоПовторяющихсяДанных = 0;
				//++ НЕ УТ
				РассчитатьПартииНЗП(НачалоПериода, ОкончаниеПериода, МассивОрганизаций, КоличествоПовторяющихсяДанных); // ПУ 2.2 этап 8
				ОценкаПроизводительности.ЗафиксироватьЗамерДлительнойОперации(ОписаниеЗамера, КоличествоПовторяющихсяДанных, "РассчитатьПартииНЗП");
				КоличествоПовторяющихсяДанных = 0;
				РаспределитьПрочиеРасходыПоБазе(НачалоПериода, ОкончаниеПериода, МассивОрганизаций, Истина, КоличествоПовторяющихсяДанных); // ПУ 2.2 этап 16
				ОценкаПроизводительности.ЗафиксироватьЗамерДлительнойОперации(ОписаниеЗамера, КоличествоПовторяющихсяДанных, "РаспределитьПрочиеРасходыПоБазе");
				КоличествоПовторяющихсяДанных = 0;
				РассчитатьПрочиеРасходыНЗП(НачалоПериода, ОкончаниеПериода, МассивОрганизаций, КоличествоПовторяющихсяДанных); // ПУ 2.2 этап 17
				ОценкаПроизводительности.ЗафиксироватьЗамерДлительнойОперации(ОписаниеЗамера, КоличествоПовторяющихсяДанных, "РассчитатьПрочиеРасходыНЗП");
				КоличествоПовторяющихсяДанных = 0;
				//-- НЕ УТ

				// Этап 2Х: расчет партий затрат на выпуск
				РассчитатьПартииЗатрат(НачалоПериода, ОкончаниеПериода, МассивОрганизаций, КоличествоПовторяющихсяДанных);
				ОценкаПроизводительности.ЗафиксироватьЗамерДлительнойОперации(ОписаниеЗамера, КоличествоПовторяющихсяДанных, "РассчитатьПартииЗатрат");
				КоличествоПовторяющихсяДанных = 0;
				// Этапы 3Х и 4Х: расчет партий прочих расходов на себестоимость товаров, партионный учет включен.
				РассчитатьПартииПрочих(НачалоПериода, ОкончаниеПериода, МассивОрганизаций, КоличествоПовторяющихсяДанных); // ПУ 2.2 этап 11
				ОценкаПроизводительности.ЗафиксироватьЗамерДлительнойОперации(ОписаниеЗамера, КоличествоПовторяющихсяДанных, "РассчитатьПартииПрочих");
				КоличествоПовторяющихсяДанных = 0;
				// Этап 5Х: расчет партий расходов на себестоимость выбытия товаров
				РассчитатьПартииРасходов(НачалоПериода, ОкончаниеПериода, МассивОрганизаций, КоличествоПовторяющихсяДанных);
				ОценкаПроизводительности.ЗафиксироватьЗамерДлительнойОперации(ОписаниеЗамера, КоличествоПовторяющихсяДанных, "РассчитатьПартииРасходов");
				КоличествоПовторяющихсяДанных = 0;
				// Этап 64: расчет приходов партий НДС к распределению
				РассчитатьПриходыПартийНДСКРаспределению(НачалоПериода, ОкончаниеПериода, МассивОрганизаций, КоличествоПовторяющихсяДанных);
				ОценкаПроизводительности.ЗафиксироватьЗамерДлительнойОперации(ОписаниеЗамера, КоличествоПовторяющихсяДанных, "РассчитатьПриходыПартийПрочихРасходов");
				КоличествоПовторяющихсяДанных = 0;
				//++ НЕ УТ
				РассчитатьСебестоимостьПроизводства(НачалоПериода, ОкончаниеПериода, МассивОрганизаций, КоличествоПовторяющихсяДанных);
				ОценкаПроизводительности.ЗафиксироватьЗамерДлительнойОперации(ОписаниеЗамера, КоличествоПовторяющихсяДанных, "РассчитатьСебестоимостьПроизводства");
				КоличествоПовторяющихсяДанных = 0;
				//-- НЕ УТ
			Иначе
				// Этап 2Х: расчет партий затрат на выпуск
				
				//++ НЕ УТ
				РассчитатьТрудозатраты(НачалоПериода, ОкончаниеПериода, МассивОрганизаций, КоличествоПовторяющихсяДанных);
				ОценкаПроизводительности.ЗафиксироватьЗамерДлительнойОперации(ОписаниеЗамера, КоличествоПовторяющихсяДанных, "РассчитатьТрудозатраты");
				КоличествоПовторяющихсяДанных = 0;
				РассчитатьРаспределениеМатериаловИРабот(НачалоПериода, ОкончаниеПериода, МассивОрганизаций, КоличествоПовторяющихсяДанных);
				ОценкаПроизводительности.ЗафиксироватьЗамерДлительнойОперации(ОписаниеЗамера, КоличествоПовторяющихсяДанных, "РассчитатьРаспределениеМатериаловИРабот");
				КоличествоПовторяющихсяДанных = 0;
				//-- НЕ УТ
				СформироватьДвиженияПоНДС(ОкончаниеПериода, МассивОрганизаций, КоличествоПовторяющихсяДанных);
				ОценкаПроизводительности.ЗафиксироватьЗамерДлительнойОперации(ОписаниеЗамера, КоличествоПовторяющихсяДанных, "СформироватьДвиженияПоНДС");
				КоличествоПовторяющихсяДанных = 0;
				РассчитатьПартииПроизводства(НачалоПериода, ОкончаниеПериода, МассивОрганизаций, КоличествоПовторяющихсяДанных);
				ОценкаПроизводительности.ЗафиксироватьЗамерДлительнойОперации(ОписаниеЗамера, КоличествоПовторяющихсяДанных, "РассчитатьПартииПроизводства");
				КоличествоПовторяющихсяДанных = 0;
				//++ НЕ УТ
				РассчитатьПартииНЗП(НачалоПериода, ОкончаниеПериода, МассивОрганизаций, КоличествоПовторяющихсяДанных);
				ОценкаПроизводительности.ЗафиксироватьЗамерДлительнойОперации(ОписаниеЗамера, КоличествоПовторяющихсяДанных, "РассчитатьПартииНЗП");
				КоличествоПовторяющихсяДанных = 0;
				РаспределитьПрочиеРасходыПоБазе(НачалоПериода, ОкончаниеПериода, МассивОрганизаций, Истина, КоличествоПовторяющихсяДанных );
				ОценкаПроизводительности.ЗафиксироватьЗамерДлительнойОперации(ОписаниеЗамера, КоличествоПовторяющихсяДанных, "РаспределитьПрочиеРасходыПоБазе");
				КоличествоПовторяющихсяДанных = 0;
				РассчитатьПрочиеРасходыНЗП(НачалоПериода, ОкончаниеПериода, МассивОрганизаций, КоличествоПовторяющихсяДанных);
				ОценкаПроизводительности.ЗафиксироватьЗамерДлительнойОперации(ОписаниеЗамера, КоличествоПовторяющихсяДанных, "РассчитатьПрочиеРасходыНЗП");
				КоличествоПовторяющихсяДанных = 0;
				РассчитатьСебестоимостьПроизводства(НачалоПериода, ОкончаниеПериода, МассивОрганизаций, КоличествоПовторяющихсяДанных);
				ОценкаПроизводительности.ЗафиксироватьЗамерДлительнойОперации(ОписаниеЗамера, КоличествоПовторяющихсяДанных, "РассчитатьСебестоимостьПроизводства");
				КоличествоПовторяющихсяДанных = 0;
				//-- НЕ УТ

				// Этапы 3Х и 4Х: расчет партий прочих расходов на себестоимость товаров при выключенном партионном учете.
				РассчитатьПартииПрочих(НачалоПериода, ОкончаниеПериода, МассивОрганизаций, КоличествоПовторяющихсяДанных);
				ОценкаПроизводительности.ЗафиксироватьЗамерДлительнойОперации(ОписаниеЗамера, КоличествоПовторяющихсяДанных, "РассчитатьПартииПрочих");
				КоличествоПовторяющихсяДанных = 0;
			КонецЕсли;
			
			// Этап 7Х: Выполнение расчета себестоимости
			РассчитатьСебестоимость(ОкончаниеПериода, МассивОрганизаций, СтрокаСхемыРасчета.ИзмененоДокументов, ОписаниеЗамера);
			
			// Этап 8Х: Запись новых границ рассчитанных партий - завершение партионного расчета за период.
			УстановитьГраницыРассчитанногоПериода(НачалоПериода, МассивОрганизаций, НомерЗаданияДоРасчета, ВременныеТаблицы);
			
			ОценкаПроизводительности.ЗафиксироватьЗамерДлительнойОперации(ОписаниеЗамера, КоличествоПовторяющихсяДанных, "РассчитатьСебестоимость");
			КоличествоПовторяющихсяДанных = 0;
			
			РассчитанныеСтрокиСхемы.Добавить(СтрокаСхемыРасчета);
			
			Если НЕ ВыполняетсяЗакрытиеМесяца Тогда
				// Выполним операции механизма закрытиям месяца, вызываемые после расчета этапа.
				РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьОперацииЗакрытияМесяцаДляЗавершенияРасчетаЭтапа(СтрокаСхемыРасчета, ИдентификаторРасчета);
			КонецЕсли;
			
			ЗаписьЖурналаРегистрации(
				НСтр("ru = 'Партионный учет.Рассчитан период';
					|en = 'Batch accounting.Period is calculated.'", КодЯзыка), УровеньИнформация, , Формат(НачалоПериода, "ДФ='ММ.гггг'"));
			
		КонецЦикла;
		
		ОценкаПроизводительности.ЗакончитьЗамерДлительнойОперации(ОписаниеЗамера, 1);
		
		Комментарий = НСтр("ru = 'Выполнен расчет с %НачалоПериода% по %ОкончаниеПериода%';
							|en = 'Calculation from %НачалоПериода% to %ОкончаниеПериода% is performed'", КодЯзыка);
		Комментарий = СтрЗаменить(Комментарий, "%НачалоПериода%",    Формат(НачалоМесяца(СхемаРасчета[0].Дата), ФорматПериода));
		Комментарий = СтрЗаменить(Комментарий, "%ОкончаниеПериода%", Формат(ОкончаниеПериодаРасчета, ФорматПериода));
		
		Если ЗначениеЗаполнено(Организация) Тогда
			Комментарий = Комментарий + "
				|" + НСтр("ru = 'Организация: %Организация%';
							|en = 'Company: %Организация%'");
			Комментарий = СтрЗаменить(Комментарий,
				"%Организация%", 
				РасчетСебестоимостиПрикладныеАлгоритмы.ПредставлениеОрганизаций(Организация,, Истина));
		КонецЕсли;
		
		ЗаписьЖурналаРегистрации(
			НСтр("ru = 'Партионный учет.Окончание расчета';
				|en = 'Batch accounting.Calculation end'", КодЯзыка), УровеньИнформация, , ОкончаниеПериодаРасчета, Комментарий);
		
	КонецЕсли;
	
	Если ФактическоеОкончаниеПериодаРасчета > ОкончаниеПериодаРасчета Тогда
		
		// Удалим рассчитанные строки из схемы расчета.
		Для Каждого СтрокаСхемыРасчета Из РассчитанныеСтрокиСхемы Цикл
			СхемаРасчета.Удалить(СтрокаСхемыРасчета);
		КонецЦикла;
		
		// Оставшиеся периоды рассчитаем механизмом версии 2.2.
		ПараметрыЗапуска = Новый Структура;
		ПараметрыЗапуска.Вставить("Дата", 				ФактическоеОкончаниеПериодаРасчета);
		ПараметрыЗапуска.Вставить("МассивОрганизаций",  Организация);
		ПараметрыЗапуска.Вставить("СхемаРасчета", 		СхемаРасчета);
		ПараметрыЗапуска.Вставить("ВременныеТаблицы",   ВременныеТаблицы);
		ПараметрыЗапуска.Вставить("МестоВызоваРасчета", "ПартионныйУчет.РассчитатьВсе");
		
		РасчетСебестоимости.РассчитатьВсеВПопыткеИсключении(ПараметрыЗапуска);
		
	КонецЕсли;
	
КонецПроцедуры

//++ НЕ УТ
#Область ЗапросыДляРасшифровки

// Получает данные для построения расшифровки базы распределения по нормативам.
//
// Возвращаемое значение:
//	Строка - текст запроса
//
Функция Текст_Данные_ПоНормативамРасшифровка() Экспорт
	
	ТекстЗапроса = ТекстДанныеПоНормативамРасходаМатериала() + ";"
	+ ТекстРаспаковкаНаборов() + ";
	|ВЫБРАТЬ
	|	НЕОПРЕДЕЛЕНО КАК Подразделение,
	|	ДД.НаправлениеДеятельности КАК НаправлениеДеятельности,
	|	НЕОПРЕДЕЛЕНО КАК Материал,
	|	ДД.НоменклатураВыпуска КАК Продукция,
	|	ДД.ГруппаПродукции,
	|	НЕОПРЕДЕЛЕНО КАК ВидРабот,
	|	ДД.Спецификация,
	|	ДД.ЗаказНаПроизводство КАК Заказ,
	|	ДД.КодСтрокиПродукция КАК КодСтроки,
	|	ДД.Этап,
	|	ВЫБОР
	|		КОГДА ДД.ЗаказНаПроизводство ССЫЛКА Документ.ВыпускПродукции
	|		ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА
	|	КОНЕЦ КАК ВыпускПоЗаказу,
	|	ДД.ЗапланированоПродукции КАК ЗапланированоПродукции,
	|	ДД.ЗапланированоЭтапов,
	|	ДД.ВыполненоЭтапов,
	|	ДД.Количество КАК РасчетноеКоличествоВыпуска,
	|	ДД.Количество * СУММА(СПМ.Количество)
	|		/ СУММА(ВЫРАЗИТЬ(СПВ.КоличествоУпаковок * ЕСТЬNULL(&ТекстЗапросаКоэффициентУпаковки, 1) КАК ЧИСЛО(15,3))) КАК НормативРасходаМатериала,
	|	0 КАК Количество,
	|	0 КАК Объем,
	|	0 КАК Вес,
	|	0 КАК Цена,
	|	0 КАК Стоимость
	|ИЗ
	|	Данные_ПоНормативамРасходаМатериала КАК ДД
	|
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ МатериалыИУслугиСпецификаций КАК СПМ
	|	ПО ДД.Спецификация = СПМ.Ссылка
	|		И &Номенклатура = СПМ.Номенклатура
	|		И &Характеристика = СПМ.Характеристика
	|
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.РесурсныеСпецификации.ВыходныеИзделия КАК СПВ
	|	ПО ДД.Спецификация = СПВ.Ссылка
	|		И ВЫБОР
	|			КОГДА СПВ.Номенклатура = ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка)
	|				ТОГДА ИСТИНА
	|			ИНАЧЕ
	|				ДД.НоменклатураВыпуска = СПВ.Номенклатура
	|				И (ДД.ХарактеристикаВыпуска = СПВ.Характеристика
	|					ИЛИ СПВ.Характеристика = ЗНАЧЕНИЕ(Справочник.ХарактеристикиНоменклатуры.ПустаяСсылка))
	|		КОНЕЦ
	|ГДЕ
	|	ДД.Организация = &Организация
	|	И &БазаРаспределения = ЗНАЧЕНИЕ(Перечисление.ТипыБазыРаспределенияРасходов.НормативРасходаМатериала)
	|	И (&ПоВсемГруппамПродукции ИЛИ (ДД.ГруппаПродукции В (&ГруппыПродукции)))
	|	И (&ПоВсемНазначениям ИЛИ ДД.Назначение = &Назначение)
	|
	|СГРУППИРОВАТЬ ПО
	|	ДД.НаправлениеДеятельности,
	|	ДД.НоменклатураВыпуска,
	|	ДД.ГруппаПродукции,
	|	ДД.Спецификация,
	|	ДД.ЗаказНаПроизводство,
	|	ДД.КодСтрокиПродукция,
	|	ДД.Этап,
	|	ДД.ЗапланированоПродукции,
	|	ДД.ЗапланированоЭтапов,
	|	ДД.ВыполненоЭтапов,
	|	ДД.Количество
	|";
	
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "&ТекстЗапросаКоэффициентУпаковки",
		Справочники.УпаковкиЕдиницыИзмерения.ТекстЗапросаКоэффициентаУпаковки(
			"СПВ.Упаковка",
			"ДД.НоменклатураВыпуска"));
			
	Возврат СтрЗаменить(ТекстЗапроса, "В (&МассивОрганизаций)", "= &Организация");
	
КонецФункции

// Получает данные для построения расшифровки базы распределения по трудозатратам.
//
// Возвращаемое значение:
//	Строка - текст запроса
//
Функция Текст_Данные_ПоУказаннымТрудозатратамРасшифровка() Экспорт
	ТекстЗапроса = ТекстДанныеПоУказаннымТрудозатратам() + ";" + "
	|ВЫБРАТЬ
	|	ДД.Подразделение КАК Подразделение,
	|	ДД.НаправлениеДеятельности КАК НаправлениеДеятельности,
	|	НЕОПРЕДЕЛЕНО КАК Материал,
	|	ДД.Продукция,
	|	ДД.ГруппаПродукции,
	|	ДД.ВидРабот,
	|	НЕОПРЕДЕЛЕНО КАК Спецификация,
	|	ВЫБОР
	|		КОГДА ДД.ДокументВыпуска <> ЗНАЧЕНИЕ(Документ.ВыпускПродукции.ПустаяСсылка)
	|			ТОГДА ДД.ДокументВыпуска
	|		ИНАЧЕ ДД.ЗаказНаПроизводство
	|	КОНЕЦ КАК Заказ,
	|	ВЫБОР
	|		КОГДА ДД.ДокументВыпуска <> ЗНАЧЕНИЕ(Документ.ВыпускПродукции.ПустаяСсылка)
	|			ТОГДА ДД.КодСтроки
	|		ИНАЧЕ ДД.КодСтрокиПродукция
	|	КОНЕЦ КАК КодСтроки,
	|	ДД.Этап,
	|	ЛОЖЬ КАК ВыпускПоЗаказу,
	|	0 КАК ЗапланированоПродукции,
	|	0 КАК ЗапланированоЭтапов,
	|	0 КАК ВыполненоЭтапов,
	|	0 КАК РасчетноеКоличествоВыпуска,
	|	0 КАК НормативРасходаМатериала,
	|	ДД.Количество,
	|	0 КАК Объем,
	|	0 КАК Вес,
	|	0 КАК Цена,
	|	0 КАК Стоимость
	|ИЗ
	|	Данные_ПоУказаннымТрудозатратам КАК ДД
	|ГДЕ
	|	ДД.Организация = &Организация
	|	И &БазаРаспределения = ЗНАЧЕНИЕ(Перечисление.ТипыБазыРаспределенияРасходов.КоличествоРаботУказанныхВидов)
	|	И (&ПоВсемВидамРабот ИЛИ (ДД.ВидРабот В (&ВидыРабот)))
	|	И (&ПоВсемГруппамПродукции ИЛИ (ДД.ГруппаПродукции В (&ГруппыПродукции)))
	|	И (&ПоВсемНазначениям ИЛИ ДД.Назначение = &Назначение)
	|";
	Возврат СтрЗаменить(ТекстЗапроса, "В (&МассивОрганизаций)", "= &Организация");
КонецФункции

// Получает данные для построения расшифровки базы распределения по материалам.
//
// Возвращаемое значение:
//	Строка - текст запроса
//
Функция Текст_Данные_ПоУказаннымМатериаламРасшифровка() Экспорт
	ТекстЗапроса = ТекстДанныеПоУказаннымМатериалам() + ";" + "
	|ВЫБРАТЬ
	|	ДД.Подразделение КАК Подразделение,
	|	ДД.НаправлениеДеятельности КАК НаправлениеДеятельности,
	|	ДД.Материал КАК Материал,
	|	ДД.Продукция КАК Продукция,
	|	ДД.ГруппаПродукции,
	|	НЕОПРЕДЕЛЕНО КАК ВидРабот,
	|	НЕОПРЕДЕЛЕНО КАК Спецификация,
	|	ДД.ЗаказНаПроизводство КАК Заказ,
	|	ДД.КодСтрокиПродукция КАК КодСтроки,
	|	ДД.Этап,
	|	ЛОЖЬ КАК ВыпускПоЗаказу,
	|	0 КАК ЗапланированоПродукции,
	|	0 КАК ЗапланированоЭтапов,
	|	0 КАК ВыполненоЭтапов,
	|	0 КАК РасчетноеКоличествоВыпуска,
	|	0 КАК НормативРасходаМатериала,
	|	ДД.Количество,
	|	ДД.Объем,
	|	ДД.Вес,
	|	0 КАК Цена,
	|	0 КАК Стоимость
	|ИЗ
	|	Данные_ПоУказаннымМатериалам КАК ДД
	|ГДЕ
	|	ДД.Организация = &Организация
	|	И (&БазаРаспределения = ЗНАЧЕНИЕ(Перечисление.ТипыБазыРаспределенияРасходов.КоличествоУказанныхМатериалов)
	|		ИЛИ &БазаРаспределения = ЗНАЧЕНИЕ(Перечисление.ТипыБазыРаспределенияРасходов.ОбъемУказанныхМатериалов)
	|		ИЛИ &БазаРаспределения = ЗНАЧЕНИЕ(Перечисление.ТипыБазыРаспределенияРасходов.ВесУказанныхМатериалов))
	|	И (&ПоВсемМатериалам ИЛИ (ДД.Материал В (&Материалы)))
	|	И (&ПоВсемГруппамПродукции ИЛИ (ДД.ГруппаПродукции В (&ГруппыПродукции)))
	|	И (&ПоВсемНазначениям ИЛИ ДД.Назначение = &Назначение)
	|";
	Возврат СтрЗаменить(ТекстЗапроса, "В (&МассивОрганизаций)", "= &Организация");
КонецФункции

// Получает данные для построения расшифровки базы распределения по продукции.
//
// Возвращаемое значение:
//	Строка - текст запроса
//
Функция Текст_Данные_ПоПродукцииРасшифровка() Экспорт
	ТекстЗапроса = ТекстДанныеПоПродукции() + ";" + "
	|ВЫБРАТЬ
	|	ДД.Подразделение КАК Подразделение,
	|	ДД.НаправлениеДеятельности КАК НаправлениеДеятельности,
	|	НЕОПРЕДЕЛЕНО КАК Материал,
	|	ДД.Продукция,
	|	ДД.ГруппаПродукции,
	|	НЕОПРЕДЕЛЕНО КАК ВидРабот,
	|	НЕОПРЕДЕЛЕНО КАК Спецификация,
	|	ДД.ЗаказНаПроизводство КАК Заказ,
	|	ДД.КодСтрокиПродукция КАК КодСтроки,
	|	ДД.Этап,
	|	ВЫБОР
	|		КОГДА ДД.ЗаказНаПроизводство ССЫЛКА Документ.ВыпускПродукции
	|		ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА
	|	КОНЕЦ КАК ВыпускПоЗаказу,
	|	ДД.ЗапланированоПродукции,
	|	ДД.ЗапланированоЭтапов,
	|	ДД.ВыполненоЭтапов,
	|	ДД.Количество КАК РасчетноеКоличествоВыпуска,
	|	0 КАК НормативРасходаМатериала,
	|	0 КАК Количество,
	|	ДД.Объем КАК Объем,
	|	ДД.Вес КАК Вес,
	|	0 КАК Цена,
	|	0 КАК Стоимость
	|ИЗ
	|	Данные_ПоПродукции КАК ДД
	|ГДЕ
	|	ДД.Организация = &Организация
	|	И (&БазаРаспределения = ЗНАЧЕНИЕ(Перечисление.ТипыБазыРаспределенияРасходов.КоличествоПродукции)
	|		ИЛИ &БазаРаспределения = ЗНАЧЕНИЕ(Перечисление.ТипыБазыРаспределенияРасходов.ОбъемПродукции)
	|		ИЛИ &БазаРаспределения = ЗНАЧЕНИЕ(Перечисление.ТипыБазыРаспределенияРасходов.ВесПродукции))
	|	И (&ПоВсемГруппамПродукции ИЛИ (ДД.ГруппаПродукции В (&ГруппыПродукции)))
	|	И (&ПоВсемНазначениям ИЛИ ДД.Назначение = &Назначение)
	|";
	Возврат СтрЗаменить(ТекстЗапроса, "В (&МассивОрганизаций)", "= &Организация");
КонецФункции

// Получает данные для построения расшифровки базы распределения по плановой стоимости.
//
// Возвращаемое значение:
//	Строка - текст запроса
//
Функция Текст_Данные_ПоПлановойСтоимостиРасшифровка() Экспорт
	ТекстЗапроса = ТекстДанныеПоПлановойСтоимости() + ";" + "
	|ВЫБРАТЬ
	|	ДД.Подразделение КАК Подразделение,
	|	ДД.НаправлениеДеятельности КАК НаправлениеДеятельности,
	|	НЕОПРЕДЕЛЕНО КАК Материал,
	|	ДД.Номенклатура КАК Продукция,
	|	ДД.ГруппаПродукции,
	|	НЕОПРЕДЕЛЕНО КАК ВидРабот,
	|	НЕОПРЕДЕЛЕНО КАК Спецификация,
	|	ДД.ЗаказНаПроизводство КАК Заказ,
	|	ДД.КодСтрокиПродукция КАК КодСтроки,
	|	ДД.Этап,
	|	ВЫБОР
	|		КОГДА ДД.ЗаказНаПроизводство ССЫЛКА Документ.ВыпускПродукции
	|		ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА
	|	КОНЕЦ КАК ВыпускПоЗаказу,
	|	ДД.ЗапланированоПродукции,
	|	ДД.ЗапланированоЭтапов,
	|	ДД.ВыполненоЭтапов,
	|	ДД.Количество КАК РасчетноеКоличествоВыпуска,
	|	0 КАК НормативРасходаМатериала,
	|	0 КАК Количество,
	|	0 КАК Объем,
	|	0 КАК Вес,
	|	ЕСТЬNULL(Ц.Цена, 0) КАК Цена,
	|	ДД.Количество * ЕСТЬNULL(Ц.Цена, 0) КАК Стоимость
	|ИЗ
	|	Данные_ПоПлановойСтоимости КАК ДД
	|
	|	ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ЦеныНоменклатуры.СрезПоследних(&ОкончаниеПериода, ВидЦены = &ВидПлановыхЦен ) КАК Ц
	|	ПО (ДД.Номенклатура = Ц.Номенклатура)
	|		И (ДД.Характеристика = Ц.Характеристика)
	|
	|ГДЕ
	|	ДД.Организация = &Организация
	|	И &БазаРаспределения = ЗНАЧЕНИЕ(Перечисление.ТипыБазыРаспределенияРасходов.ПлановаяСтоимостьПродукции)
	|	И (&ПоВсемГруппамПродукции ИЛИ (ДД.ГруппаПродукции В (&ГруппыПродукции)))
	|	И (&ПоВсемНазначениям ИЛИ ДД.Назначение = &Назначение)
	|";
	Возврат СтрЗаменить(ТекстЗапроса, "В (&МассивОрганизаций)", "= &Организация");
КонецФункции

// Получает данные для построения расшифровки базы распределения по стоимости материальных затрат.
//
// Возвращаемое значение:
//	Строка - текст запроса
//
Функция Текст_Данные_ПоСтоимостиМатЗатратРасшифровка() Экспорт
	ТекстЗапроса = ТекстВыпускРаботСписанныхНаЗатратыБезЗаказа() + ";"
	+ ТекстДанныеПоСтоимостиМатЗатрат()
	+ "ОБЪЕДИНИТЬ ВСЕ"+ ТекстДанныеПоСтоимостиМатЗатратБезПУ() + ";" + "
	|ВЫБРАТЬ
	|	ДД.Подразделение КАК Подразделение,
	|	НЕОПРЕДЕЛЕНО КАК Материал,
	|	ДД.НаправлениеДеятельности,
	|	ДД.Продукция,
	|	ДД.ГруппаПродукции,
	|	НЕОПРЕДЕЛЕНО КАК ВидРабот,
	|	НЕОПРЕДЕЛЕНО КАК Спецификация,
	|	(ВЫБОР
	|		КОГДА НЕ ДД.ДокументВыпуска.Дата ЕСТЬ NULL ТОГДА ДД.ДокументВыпуска
	|		ИНАЧЕ ДД.ЗаказНаПроизводство КОНЕЦ) КАК Заказ,
	|	ДД.КодСтрокиПродукция КАК КодСтроки,
	|	ДД.Этап,
	|	(ВЫБОР
	|		КОГДА НЕ ДД.ДокументВыпуска.Дата ЕСТЬ NULL ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА КОНЕЦ) КАК ВыпускПоЗаказу,
	|	0 КАК ЗапланированоПродукции,
	|	0 КАК ЗапланированоЭтапов,
	|	0 КАК ВыполненоЭтапов,
	|	0 КАК РасчетноеКоличествоВыпуска,
	|	0 КАК НормативРасходаМатериала,
	|	0 КАК Количество,
	|	0 КАК Объем,
	|	0 КАК Вес,
	|	0 КАК Цена,
	|	СУММА(ДД.Стоимость) КАК Стоимость
	|ИЗ
	|	Данные_СтоимостьМатЗатрат КАК ДД
	|ГДЕ
	|	ДД.Организация = &Организация
	|	И &БазаРаспределения = ЗНАЧЕНИЕ(Перечисление.ТипыБазыРаспределенияРасходов.СуммаМатериальныхЗатрат)
	|	И (&ПоВсемГруппамПродукции ИЛИ (ДД.ГруппаПродукции В (&ГруппыПродукции)))
	|СГРУППИРОВАТЬ ПО
	|	ДД.Подразделение,
	|	ДД.НаправлениеДеятельности,
	|	ДД.Продукция,
	|	ДД.ГруппаПродукции,
	|	(ВЫБОР
	|		КОГДА НЕ ДД.ДокументВыпуска.Дата ЕСТЬ NULL ТОГДА ДД.ДокументВыпуска
	|		ИНАЧЕ ДД.ЗаказНаПроизводство КОНЕЦ),
	|	ДД.КодСтрокиПродукция,
	|	ДД.Этап,
	|	(ВЫБОР
	|		КОГДА НЕ ДД.ДокументВыпуска.Дата ЕСТЬ NULL ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА КОНЕЦ)
	|";
	Возврат СтрЗаменить(ТекстЗапроса, "В (&МассивОрганизаций)", "= &Организация");
КонецФункции

// Получает данные для построения расшифровки базы распределения по стоимости затрат на оплату труда.
//
// Возвращаемое значение:
//	Строка - текст запроса
//
Функция Текст_Данные_ПоСтоимостиЗатратНаОплатуТрудаРасшифровка() Экспорт
	ТекстЗапроса = ТекстВыпускРаботСписанныхНаЗатратыБезЗаказа() + ";"
	+ ТекстДанныеПоЗатратамНаОплатуТрудаБезЗаказа()
	//++ НЕ УТКА
	+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстДанныеПоЗатратамНаОплатуТрудаНЗП()
	//-- НЕ УТКА
	+ ";" + "
	|ВЫБРАТЬ
	|	ДД.Подразделение КАК Подразделение,
	|	ДД.НаправлениеДеятельности КАК НаправлениеДеятельности,
	|	НЕОПРЕДЕЛЕНО КАК Материал,
	|	ДД.Продукция,
	|	ДД.ГруппаПродукции,
	|	ДД.ВидРабот,
	|	НЕОПРЕДЕЛЕНО КАК Спецификация,
	|	(ВЫБОР
	|		КОГДА НЕ ДД.ДокументВыпуска.Дата ЕСТЬ NULL ТОГДА ДД.ДокументВыпуска
	|		ИНАЧЕ ДД.ЗаказНаПроизводство КОНЕЦ) КАК Заказ,
	|	ДД.КодСтрокиПродукция КАК КодСтроки,
	|	НЕОПРЕДЕЛЕНО КАК Этап,
	|	(ВЫБОР
	|		КОГДА НЕ ДД.ДокументВыпуска.Дата ЕСТЬ NULL ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА КОНЕЦ) КАК ВыпускПоЗаказу,
	|	0 КАК ЗапланированоПродукции,
	|	0 КАК ЗапланированоЭтапов,
	|	0 КАК ВыполненоЭтапов,
	|	0 КАК РасчетноеКоличествоВыпуска,
	|	0 КАК НормативРасходаМатериала,
	|	0 КАК Количество,
	|	0 КАК Объем,
	|	0 КАК Вес,
	|	0 КАК Цена,
	|	СУММА(ДД.Стоимость) КАК Стоимость
	|ИЗ
	|	Данные_ЗатратыНаОплатуТруда КАК ДД
	|ГДЕ
	|	ДД.Организация = &Организация
	|	И &БазаРаспределения = ЗНАЧЕНИЕ(Перечисление.ТипыБазыРаспределенияРасходов.СуммаРасходовНаОплатуТруда)
	|	И (&ПоВсемГруппамПродукции ИЛИ (ДД.ГруппаПродукции В (&ГруппыПродукции)))
	|СГРУППИРОВАТЬ ПО
	|	ДД.Подразделение,
	|	ДД.НаправлениеДеятельности,
	|	ДД.Продукция,
	|	ДД.ГруппаПродукции,
	|	ДД.ВидРабот,
	|	(ВЫБОР
	|		КОГДА НЕ ДД.ДокументВыпуска.Дата ЕСТЬ NULL ТОГДА ДД.ДокументВыпуска
	|		ИНАЧЕ ДД.ЗаказНаПроизводство КОНЕЦ),
	|	ДД.КодСтрокиПродукция,
	|	(ВЫБОР
	|		КОГДА НЕ ДД.ДокументВыпуска.Дата ЕСТЬ NULL ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА КОНЕЦ)
	|";
	Возврат СтрЗаменить(ТекстЗапроса, "В (&МассивОрганизаций)", "= &Организация");
КонецФункции

// Получает данные для построения расшифровки базы распределения по нормативной стоимости затрат на оплату труда.
//
// Возвращаемое значение:
//	Строка - текст запроса
//
Функция Текст_Данные_ПоНормативнойСтоимостиЗатратНаОплатуТрудаРасшифровка() Экспорт
	ТекстЗапроса = ТекстВыпускРаботСписанныхНаЗатратыБезЗаказа() + ";"
	+ ТекстДанныеПоНормативнымЗатратамНаОплатуТрудаБезЗаказа()
	//++ НЕ УТКА
	+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстДанныеПоНормативнымЗатратамНаОплатуТрудаНЗП()
	//-- НЕ УТКА
	+ ";" + "
	|ВЫБРАТЬ
	|	ДД.Подразделение КАК Подразделение,
	|	ДД.НаправлениеДеятельности КАК НаправлениеДеятельности,
	|	НЕОПРЕДЕЛЕНО КАК Материал,
	|	ДД.Продукция,
	|	ДД.ГруппаПродукции,
	|	ДД.ВидРабот,
	|	НЕОПРЕДЕЛЕНО КАК Спецификация,
	|	(ВЫБОР
	|		КОГДА НЕ ДД.ДокументВыпуска.Дата ЕСТЬ NULL ТОГДА ДД.ДокументВыпуска
	|		ИНАЧЕ ДД.ЗаказНаПроизводство КОНЕЦ) КАК Заказ,
	|	ДД.КодСтрокиПродукция КАК КодСтроки,
	|	НЕОПРЕДЕЛЕНО КАК Этап,
	|	(ВЫБОР
	|		КОГДА НЕ ДД.ДокументВыпуска.Дата ЕСТЬ NULL ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА КОНЕЦ) КАК ВыпускПоЗаказу,
	|	0 КАК ЗапланированоПродукции,
	|	0 КАК ЗапланированоЭтапов,
	|	0 КАК ВыполненоЭтапов,
	|	0 КАК РасчетноеКоличествоВыпуска,
	|	0 КАК НормативРасходаМатериала,
	|	0 КАК Количество,
	|	0 КАК Объем,
	|	0 КАК Вес,
	|	0 КАК Цена,
	|	СУММА(ДД.Стоимость) КАК Стоимость
	|ИЗ
	|	Данные_НормативныеЗатратыНаОплатуТруда КАК ДД
	|ГДЕ
	|	ДД.Организация = &Организация
	|	И &БазаРаспределения = ЗНАЧЕНИЕ(Перечисление.ТипыБазыРаспределенияРасходов.НормативыОплатыТруда)
	|	И (&ПоВсемГруппамПродукции ИЛИ (ДД.ГруппаПродукции В (&ГруппыПродукции)))
	|СГРУППИРОВАТЬ ПО
	|	ДД.Подразделение,
	|	ДД.НаправлениеДеятельности,
	|	ДД.Продукция,
	|	ДД.ГруппаПродукции,
	|	ДД.ВидРабот,
	|	(ВЫБОР
	|		КОГДА НЕ ДД.ДокументВыпуска.Дата ЕСТЬ NULL ТОГДА ДД.ДокументВыпуска
	|		ИНАЧЕ ДД.ЗаказНаПроизводство КОНЕЦ),
	|	ДД.КодСтрокиПродукция,
	|	(ВЫБОР
	|		КОГДА НЕ ДД.ДокументВыпуска.Дата ЕСТЬ NULL ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА КОНЕЦ)
	|";
	Возврат СтрЗаменить(ТекстЗапроса, "В (&МассивОрганизаций)", "= &Организация");
КонецФункции

#КонецОбласти
//-- НЕ УТ
#КонецОбласти

#Область СлужебныеПроцедурыИФункции

#Область ЭтапыРасчета

// Этап 1Х: расчет партий товаров
Процедура РассчитатьПартииТоваров(НачалоПериода, ОкончаниеПериода, МассивОрганизаций, КоличествоЗаписей = 0)
	ИмяРегистра = Метаданные.РегистрыНакопления.ПартииТоваровОрганизаций.Имя;
	
	НачалоЗамера = ТекущаяУниверсальнаяДатаВМиллисекундах();
	// ФАЗА 0:

	//++ НЕ УТ

	// Восстановление некорректных движений документа ВозвратМатериаловИзПроизводства по товарам организаций.
	ВосстановитьДвиженияВозвратМатериаловИзПроизводстваПоТоварамОрганизаций(НачалоПериода, ОкончаниеПериода, МассивОрганизаций);
	//-- НЕ УТ

	// Восстановление "потерянных" первичных движений по партиям товаров
	ВосстановитьДвиженияПоПартиямТоваров(НачалоПериода, ОкончаниеПериода, МассивОрганизаций);
	// ФАЗА 10: Выборка исходных данных для расчета партий товаров организаций
	ДанныеДляПартийТоваров = ДанныеДляПартийТоваров(НачалоПериода, ОкончаниеПериода, МассивОрганизаций);
	// ФАЗА 12: Расчет партий товаров по исходным данным
	МассивИсключаемыхТипов = Новый Массив;
	МассивИсключаемыхТипов.Добавить(Тип("ДокументСсылка.КорректировкаРегистров"));
	Регистраторы = Регистраторы(НачалоПериода, ОкончаниеПериода, МассивОрганизаций, ИмяРегистра, МассивИсключаемыхТипов);
	РегистраторыССохраняемымиДвижениями = РегистраторыССохраняемымиДвижениями(ИмяРегистра, ДанныеДляПартийТоваров, Регистраторы, НачалоПериода, ОкончаниеПериода, МассивОрганизаций);
	РасчетныеПартииТоваров = РасчетныеПартииТоваров(ДанныеДляПартийТоваров, Регистраторы);
	// ФАЗА 14: Запись регистра ПартииТоваровОрганизаций
	ЗаписатьРасчетныеПартии(РегистрыНакопления[ИмяРегистра], РасчетныеПартииТоваров, Регистраторы);
	ОчиститьРегистрНаСервере(Регистраторы, ИмяРегистра, РегистраторыССохраняемымиДвижениями);
	ЗаписатьСохраняемыеДвижения(РегистрыНакопления[ИмяРегистра], ДанныеДляПартийТоваров, РегистраторыССохраняемымиДвижениями);
	// Завершение этапа
	КоличествоЗаписей = КоличествоЗаписей(ДанныеДляПартийТоваров);
	ДанныеДляПартийТоваров.Закрыть();
	РасчетныеПартииТоваров = Неопределено;
	Замер = ТекущаяУниверсальнаяДатаВМиллисекундах() - НачалоЗамера;
	Комментарий = НСтр("ru = 'Рассчитано %КолвоСтрок% стр. за %Замер% сек.';
						|en = '%КолвоСтрок% rows are calculated for %Замер% sec.'", ОбщегоНазначения.КодОсновногоЯзыка());
	Комментарий = СтрЗаменить(Комментарий, "%КолвоСтрок%", КоличествоЗаписей);
	Комментарий = СтрЗаменить(Комментарий, "%Замер%", Формат(Замер/1000., "ЧДЦ=3; ЧН=; ЧГ="));
	ЗаписьЖурналаРегистрации(
		НСтр("ru = 'Партионный учет.ПартииТоваровОрганизаций';
			|en = 'Batch accounting.ПартииТоваровОрганизаций'",	ОбщегоНазначения.КодОсновногоЯзыка()),
		УровеньЖурналаРегистрации.Информация,,, Комментарий);
КонецПроцедуры

// Этап 16: расчет партий переданных на комиссию
Процедура РассчитатьПартииПереданные(НачалоПериода, ОкончаниеПериода, МассивОрганизаций, КоличествоЗаписей = 0)
	ИмяРегистра = Метаданные.РегистрыНакопления.ПартииТоваровПереданныеНаКомиссию.Имя;
	
	// ФАЗА 10: Выборка исходных данных для расчета партий товаров организаций
	ДанныеДляПартийПереданных = ДанныеДляПартийПереданных(НачалоПериода, ОкончаниеПериода, МассивОрганизаций);
	// ФАЗА 12: Расчет партий товаров по исходным данным
	Регистраторы = Регистраторы(НачалоПериода, ОкончаниеПериода, МассивОрганизаций, ИмяРегистра);
	РегистраторыПартийВПути(НачалоПериода, ОкончаниеПериода, МассивОрганизаций, Регистраторы);
	РегистраторыССохраняемымиДвижениями = РегистраторыССохраняемымиДвижениями(ИмяРегистра, ДанныеДляПартийПереданных, Регистраторы, НачалоПериода, ОкончаниеПериода, МассивОрганизаций);
	РасчетныеПартииПереданные = РасчетныеПартииПереданные(ДанныеДляПартийПереданных, Регистраторы, Неопределено, Ложь, КоличествоЗаписей);
	// ФАЗА 14: Запись регистра ПартииТоваровОрганизаций
	ЗаписатьРасчетныеПартии(РегистрыНакопления[ИмяРегистра], РасчетныеПартииПереданные, Регистраторы);
	ОчиститьРегистрНаСервере(Регистраторы, ИмяРегистра, РегистраторыССохраняемымиДвижениями);
	ЗаписатьСохраняемыеДвижения(РегистрыНакопления[ИмяРегистра], ДанныеДляПартийПереданных, РегистраторыССохраняемымиДвижениями);
	// Завершение этапа
	ДанныеДляПартийПереданных.Закрыть();
	РасчетныеПартииПереданные = Неопределено;
КонецПроцедуры

//++ НЕ УТ

// Этап 18-0: распределение материалов и работ
Процедура РассчитатьРаспределениеМатериаловИРабот(НачалоПериода, ОкончаниеПериода, МассивОрганизаций, КоличествоЗаписей = 0)
	ИмяРегистра = Метаданные.РегистрыНакопления.МатериалыИРаботыВПроизводстве.Имя;
	
	// ФАЗА 10: Выборка исходных данных для распределения материалов и работ
	ДанныеДляРаспределенияМатериаловИРабот = ДанныеДляРаспределенияМатериаловИРабот(НачалоПериода, ОкончаниеПериода, МассивОрганизаций);
	// ФАЗА 12: Распределение материалов и работ по исходным данным
	МассивПоддерживаемыхТипов = Новый Массив;
	МассивПоддерживаемыхТипов.Добавить(Тип("ДокументСсылка.РаспределениеПроизводственныхЗатрат"));
	Регистраторы = Регистраторы(НачалоПериода, ОкончаниеПериода, МассивОрганизаций, ИмяРегистра,, МассивПоддерживаемыхТипов);
	РасчетноеРаспределениеМатериаловИРабот = РасчетноеРаспределениеМатериаловИРабот(ДанныеДляРаспределенияМатериаловИРабот, Регистраторы,,, КоличествоЗаписей);
	// ФАЗА 14: Запись регистра "МатериалыИРаботыВПроизводстве"
	ЗаписатьРасчетныеПартии(РегистрыНакопления[ИмяРегистра], РасчетноеРаспределениеМатериаловИРабот, Регистраторы);
	ОчиститьРегистрНаСервере(Регистраторы, ИмяРегистра);
	// Завершение этапа
	ДанныеДляРаспределенияМатериаловИРабот.Закрыть();
	РасчетноеРаспределениеМатериаловИРабот = Неопределено;
КонецПроцедуры
//-- НЕ УТ

// Этап 18-1: расчет партий производственных затрат
Процедура РассчитатьПартииПроизводства(НачалоПериода, ОкончаниеПериода, МассивОрганизаций, КоличествоЗаписей = 0)
	ИмяРегистра = Метаданные.РегистрыНакопления.ПартииПроизводственныхЗатрат.Имя;
	
	НачалоЗамера = ТекущаяУниверсальнаяДатаВМиллисекундах();
	//++ НЕ УТ

	// ФАЗА 10: Заполнение нового реквизита ПодразделениеРасходов.
	ВосстановитьДвиженияВыпускаПродукцииПоПартиямПроизводственныхЗатрат(НачалоПериода, ОкончаниеПериода, МассивОрганизаций);
	// Заполнение реквизита "ЗаказНаПроизводство".
	ВосстановитьДвиженияСписанияЗатратНаВыпускПоПроизводственнымЗатратам(НачалоПериода, ОкончаниеПериода, МассивОрганизаций);
	//-- НЕ УТ

	// ФАЗА 11: Выборка данных партий производственных затрат
	ДанныеДляПартийПроизводства = ДанныеДляПартийПроизводства(НачалоПериода, ОкончаниеПериода, МассивОрганизаций);
	// ФАЗА 12: Расчет партий производственных затрат по исходным данным
	Регистраторы = Регистраторы(НачалоПериода, ОкончаниеПериода, МассивОрганизаций, ИмяРегистра);
	//++ НЕ УТКА
	РегистраторыПрошлыхДвиженийМаршрутныхЛистов(НачалоПериода, ОкончаниеПериода, МассивОрганизаций, Регистраторы);
	//-- НЕ УТКА
	РегистраторыССохраняемымиДвижениями = РегистраторыССохраняемымиДвижениями(ИмяРегистра, ДанныеДляПартийПроизводства, Регистраторы, НачалоПериода, ОкончаниеПериода, МассивОрганизаций);
	РасчетныеПартииПроизводства = РасчетныеПартииПроизводства(ДанныеДляПартийПроизводства, Регистраторы);
	// ФАЗА 14: запись партий производственных затрат
	ЗаписатьРасчетныеПартии(РегистрыНакопления[ИмяРегистра], РасчетныеПартииПроизводства, Регистраторы);
	ОчиститьРегистрНаСервере(Регистраторы, ИмяРегистра, РегистраторыССохраняемымиДвижениями);
	ЗаписатьСохраняемыеДвижения(РегистрыНакопления[ИмяРегистра], ДанныеДляПартийПроизводства, РегистраторыССохраняемымиДвижениями);
	// Завершение этапа
	КоличествоЗаписей = КоличествоЗаписей(ДанныеДляПартийПроизводства);
	ДанныеДляПартийПроизводства.Закрыть();
	РасчетныеПартииПроизводства = Неопределено;
	Замер = ТекущаяУниверсальнаяДатаВМиллисекундах() - НачалоЗамера;
	Комментарий = НСтр("ru = 'Рассчитано %КолвоСтрок% стр. за %Замер% сек.';
						|en = '%КолвоСтрок% rows are calculated for %Замер% sec.'", ОбщегоНазначения.КодОсновногоЯзыка());
	Комментарий = СтрЗаменить(Комментарий, "%КолвоСтрок%", КоличествоЗаписей);
	Комментарий = СтрЗаменить(Комментарий, "%Замер%", Формат(Замер/1000., "ЧДЦ=3; ЧН=; ЧГ="));
	ЗаписьЖурналаРегистрации(
		НСтр("ru = 'Партионный учет.ПартииПроизводственныхЗатрат';
			|en = 'Batch accounting.ПартииПроизводственныхЗатрат'",	ОбщегоНазначения.КодОсновногоЯзыка()),
		УровеньЖурналаРегистрации.Информация,,, Комментарий);
КонецПроцедуры

//++ НЕ УТ

// Этап 18-2: расчет партий незавершенного производства 
Процедура РассчитатьПартииНЗП(НачалоПериода, ОкончаниеПериода, МассивОрганизаций, КоличествоЗаписей = 0)
	ИмяРегистра = Метаданные.РегистрыНакопления.ПартииНезавершенногоПроизводства.Имя;
	
	НачалоЗамера = ТекущаяУниверсальнаяДатаВМиллисекундах();
	// ФАЗА 20: Выборка данных партий незавершенного производства
	ДанныеДляПартийНЗП = ДанныеДляПартийНЗП(НачалоПериода, ОкончаниеПериода, МассивОрганизаций);
	// ФАЗА 22: Расчет партий незавершенного производства по исходным данным
	МассивИсключаемыхТипов = Новый Массив;
	МассивИсключаемыхТипов.Добавить(Тип("ДокументСсылка.КорректировкаРегистров"));
	Регистраторы = Регистраторы(НачалоПериода, ОкончаниеПериода, МассивОрганизаций, ИмяРегистра, МассивИсключаемыхТипов);
	//++ НЕ УТКА
	РегистраторыПрошлыхДвиженийМаршрутныхЛистов(НачалоПериода, ОкончаниеПериода, МассивОрганизаций, Регистраторы);
	//-- НЕ УТКА
	РасчетныеПартииНЗП = РасчетныеПартииНЗП(ДанныеДляПартийНЗП, Регистраторы);
	// ФАЗА 24: запись партий незавершенного производства
	ЗаписатьРасчетныеПартии(РегистрыНакопления[ИмяРегистра], РасчетныеПартииНЗП, Регистраторы);
	ОчиститьРегистрНаСервере(Регистраторы, ИмяРегистра);
	// Завершение этапа
	КоличествоЗаписей = КоличествоЗаписей(ДанныеДляПартийНЗП);
	ДанныеДляПартийНЗП.Закрыть();
	РасчетныеПартииНЗП = Неопределено;
	Замер = ТекущаяУниверсальнаяДатаВМиллисекундах() - НачалоЗамера;
	Комментарий = НСтр("ru = 'Рассчитано %КолвоСтрок% стр. за %Замер% сек.';
						|en = '%КолвоСтрок% rows are calculated for %Замер% sec.'", ОбщегоНазначения.КодОсновногоЯзыка());
	Комментарий = СтрЗаменить(Комментарий, "%КолвоСтрок%", КоличествоЗаписей);
	Комментарий = СтрЗаменить(Комментарий, "%Замер%", Формат(Замер/1000., "ЧДЦ=3; ЧН=; ЧГ="));
	ЗаписьЖурналаРегистрации(
		НСтр("ru = 'Партионный учет.ПартииНезавершенногоПроизводства';
			|en = 'Batch accounting.ПартииНезавершенногоПроизводства'",	ОбщегоНазначения.КодОсновногоЯзыка()),
		УровеньЖурналаРегистрации.Информация,,, Комментарий);
КонецПроцедуры

// Этап 18-3: расчет трудозатрат незавершенного производства
Процедура РассчитатьТрудозатраты(НачалоПериода, ОкончаниеПериода, МассивОрганизаций, КоличествоЗаписей = 0)
	ИмяРегистра = Метаданные.РегистрыНакопления.ТрудозатратыНезавершенногоПроизводства.Имя;
	
	НачалоЗамера = ТекущаяУниверсальнаяДатаВМиллисекундах();
	// ФАЗА 30: Выборка данных трудозатрат незавершенного производства
	ДанныеДляТрудозатратНЗП = ДанныеДляТрудозатратНЗП(НачалоПериода, ОкончаниеПериода, МассивОрганизаций);
	// ФАЗА 31: Расчет трудозатрат незавершенного производства по исходным данным
	Регистраторы = Регистраторы(НачалоПериода, ОкончаниеПериода, МассивОрганизаций, ИмяРегистра);
	РегистраторыССохраняемымиДвижениями = РегистраторыССохраняемымиДвижениями(ИмяРегистра, ДанныеДляТрудозатратНЗП, Регистраторы, НачалоПериода, ОкончаниеПериода, МассивОрганизаций);
	РасчетныеТрудозатратыНЗП = РасчетныеТрудозатратыНЗП(ДанныеДляТрудозатратНЗП, Регистраторы);
	// ФАЗА 32: запись трудозатрат незавершенного производства
	ЗаписатьРасчетныеПартии(РегистрыНакопления[ИмяРегистра], РасчетныеТрудозатратыНЗП, Регистраторы);
	ОчиститьРегистрНаСервере(Регистраторы, ИмяРегистра, РегистраторыССохраняемымиДвижениями);
	ЗаписатьСохраняемыеДвижения(РегистрыНакопления[ИмяРегистра], ДанныеДляТрудозатратНЗП, РегистраторыССохраняемымиДвижениями);
	// Завершение этапа
	КоличествоЗаписей = КоличествоЗаписей(ДанныеДляТрудозатратНЗП);
	ДанныеДляТрудозатратНЗП.Закрыть();
	РасчетныеТрудозатратыНЗП = Неопределено;
	Замер = ТекущаяУниверсальнаяДатаВМиллисекундах() - НачалоЗамера;
	Комментарий = НСтр("ru = 'Рассчитано %КолвоСтрок% стр. за %Замер% сек.';
						|en = '%КолвоСтрок% rows are calculated for %Замер% sec.'", ОбщегоНазначения.КодОсновногоЯзыка());
	Комментарий = СтрЗаменить(Комментарий, "%КолвоСтрок%", КоличествоЗаписей);
	Комментарий = СтрЗаменить(Комментарий, "%Замер%", Формат(Замер/1000., "ЧДЦ=3; ЧН=; ЧГ="));
	ЗаписьЖурналаРегистрации(
		НСтр("ru = 'Партионный учет.ТрудозатратыНезавершенногоПроизводства';
			|en = 'Batch accounting.ТрудозатратыНезавершенногоПроизводства'",	ОбщегоНазначения.КодОсновногоЯзыка()),
		УровеньЖурналаРегистрации.Информация,,, Комментарий);
КонецПроцедуры

// Этап 18-4: распределение прочих производственных расходов по базе распределения
Процедура РаспределитьПрочиеРасходыПоБазе(НачалоПериода, ОкончаниеПериода, Организации, РассчитатьВсе = Ложь, КоличествоЗаписейВсего = 0) Экспорт
	
	Если ТипЗнч(Организации) <> Тип("Массив") Тогда
		// Передана организация - дополним связанными организациями
		МассивОрганизаций = РасчетСебестоимостиПрикладныеАлгоритмы.СвязиОрганизацийПоСхемеИнтеркампани(ОкончаниеПериода, Организации);
	Иначе
		// Переданы связанные по Интеркампани организации
		МассивОрганизаций = Организации;
	КонецЕсли;
	
	// Проверим, закончено ли обновление ИБ
	Если НЕ РассчитатьВсе Тогда // вызывается "снаружи"; при вызове из этого модуля проверка не нужна - уже выполнялась при старте расчета
		РасчетСебестоимостиПрикладныеАлгоритмы.ПроверитьБлокировкуДанныхПриОбновленииИБ(Ложь, Ложь);
	КонецЕсли;
	
	// Расчет долей списания косвенных расходов
	МассивОпераций = Новый Массив;
	МассивОпераций.Добавить(Перечисления.ТипыРегламентныхОпераций.РасчетДолейСписанияКосвенныхРасходов);
	
	Документы.РегламентнаяОперация.РассчитатьРегламентныеОперации(
		НачалоПериода,
		МассивОпераций,
		Справочники.Организации.ГоловныеОрганизации(МассивОрганизаций),
		Ложь,
		Истина);
	
	// Расчет расходов на продукцию
	ПараметрыЗапускаРасчетаСебестоимости = Новый Структура;
	ПараметрыЗапускаРасчетаСебестоимости.Вставить("Дата", 					ОкончаниеПериода);
	ПараметрыЗапускаРасчетаСебестоимости.Вставить("ПредварительныйРасчет", 	Истина);
	ПараметрыЗапускаРасчетаСебестоимости.Вставить("МассивОрганизаций", 		МассивОрганизаций);
	ПараметрыЗапускаРасчетаСебестоимости.Вставить("РегламентноеЗадание", 	Ложь);
	ПараметрыЗапускаРасчетаСебестоимости.Вставить("МестоВызоваРасчета", 	"ПартионныйУчет.РаспределитьПрочиеРасходыПоБазе");
	
	СебестоимостьРассчитана = РасчетСебестоимостиПартионныйУчет21.РассчитатьВсеВПопыткеИсключении(ПараметрыЗапускаРасчетаСебестоимости);
	
	// ФАЗА 40: Выборка данных для распределения прочих производственных расходов
	ДанныеДляРасходовКРаспределению = ДанныеДляРасходовКРаспределению(НачалоПериода, ОкончаниеПериода, МассивОрганизаций);
	// ФАЗА 41: Расчет данных для распределения прочих производственных расходов по исходным данным.
	РасчетныеРасходыКРаспределению = РасчетныеРасходыКРаспределению(ДанныеДляРасходовКРаспределению, Неопределено, Неопределено, Ложь, КоличествоЗаписейВсего);
	ДанныеДляРасходовКРаспределению = Неопределено;
	// ФАЗА 42: Выборка данных для распределения прочих производственных расходов по подразделениям по базе.
	ДанныеДляПрочихРасходовНЗППоПодразделениямПоБазе = 
		ДанныеДляПрочихРасходовНЗППоПодразделениямПоБазе(НачалоПериода, ОкончаниеПериода, МассивОрганизаций, РасчетныеРасходыКРаспределению);
	// ФАЗА 43: Расчет распределения по подразделениям прочих производственных расходов по исходным данным.
	МассивИсключаемыхТиповРегистраторов = Новый Массив;
	МассивИсключаемыхТиповРегистраторов.Добавить(Тип("ДокументСсылка.РасчетСебестоимостиТоваров"));
	МассивИсключаемыхТиповРегистраторов.Добавить(Тип("ДокументСсылка.ОтчетПереработчика"));
	МассивИсключаемыхТиповРегистраторов.Добавить(Тип("ДокументСсылка.КорректировкаРегистров"));
	Регистраторы = Регистраторы(НачалоПериода, ОкончаниеПериода, МассивОрганизаций, "ПрочиеРасходыНезавершенногоПроизводства", МассивИсключаемыхТиповРегистраторов);
	РегистраторыПрочиеРасходы = Регистраторы(НачалоПериода, ОкончаниеПериода, МассивОрганизаций, "ПрочиеРасходыНезавершенногоПроизводства", МассивИсключаемыхТиповРегистраторов);
	РегистраторыПрочиеРасходы(НачалоПериода, ОкончаниеПериода, МассивОрганизаций, РегистраторыПрочиеРасходы);
	КоличествоЗаписей = 0;
	РасчетныеПрочиеРасходыНЗППоПодразделениямПоБазе = 
		РасчетныеПрочиеРасходыНЗППоПодразделениямПоБазе(ДанныеДляПрочихРасходовНЗППоПодразделениямПоБазе, Регистраторы, Неопределено, Ложь, КоличествоЗаписей);
	КоличествоЗаписейВсего = КоличествоЗаписейВсего + КоличествоЗаписей;
	ДанныеДляПрочихРасходовНЗППоПодразделениямПоБазе = Неопределено;
	// ФАЗА 44: Выборка данных для распределения прочих производственных расходов по этапам по базе.
	ДанныеДляПрочихРасходовНЗППоЭтапамПоБазе = 
		ДанныеДляПрочихРасходовНЗППоЭтапамПоБазе(НачалоПериода,
												 ОкончаниеПериода,
												 МассивОрганизаций,
												 РасчетныеРасходыКРаспределению,
												 РасчетныеПрочиеРасходыНЗППоПодразделениямПоБазе);
	// ФАЗА 45: Расчет распределения прочих производственных расходов по этапам по базе
	РасчетныеПрочиеРасходыНЗППоЭтапамПоБазе = 
		РасчетныеПрочиеРасходыНЗППоЭтапамПоБазе(ДанныеДляПрочихРасходовНЗППоЭтапамПоБазе, Регистраторы, Неопределено, Ложь, КоличествоЗаписей);
	КоличествоЗаписейВсего = КоличествоЗаписейВсего + КоличествоЗаписей;
	ДанныеДляПрочихРасходовНЗППоЭтапамПоБазе = Неопределено;
	// ФАЗА 46: Запись прочих расходов незавершенного производства
	ЗаписатьРасчетныеПартии(РегистрыНакопления.ПрочиеРасходыНезавершенногоПроизводства, РасчетныеПрочиеРасходыНЗППоЭтапамПоБазе, Регистраторы);
	ОчиститьРегистрНаСервере(Регистраторы, "ПрочиеРасходыНезавершенногоПроизводства");
	РасчетныеПрочиеРасходыНЗППоПодразделениямПоБазе = Неопределено;
	РасчетныеПрочиеРасходыНЗППоЭтапамПоБазе = Неопределено;
	// ФАЗА 47: Выборка данных для распределения прочих производственных расходов на другие статьи расходов,
	// и данных о расходах, распределенных по базе или вручную.
	ДанныеДляПрочихРасходов = ДанныеДляПрочихРасходов(НачалоПериода, ОкончаниеПериода, МассивОрганизаций, РасчетныеРасходыКРаспределению);
	РасчетныеПрочиеРасходы = РасчетныеПрочиеРасходы(ДанныеДляПрочихРасходов, РегистраторыПрочиеРасходы, Неопределено, Ложь, КоличествоЗаписей);
	КоличествоЗаписейВсего = КоличествоЗаписейВсего + КоличествоЗаписей;
	ДанныеДляПрочихРасходов = Неопределено;
	РасчетныеРасходыКРаспределению = Неопределено;
	// ФАЗА 48: Запись прочих расходов
	ЗаписатьРасчетныеПартии(РегистрыНакопления.ПрочиеРасходы, РасчетныеПрочиеРасходы, РегистраторыПрочиеРасходы);
	ОчиститьРегистрНаСервере(РегистраторыПрочиеРасходы, "ПрочиеРасходы");
	ВернутьДокументыРаспределенияРасходовПоБазеКОтражениюВРеглУчете(РегистраторыПрочиеРасходы);
	ВернутьДокументыРаспределенияРасходовПоБазеКОтражениюВРеглУчете(РасчетныеПрочиеРасходы);
	
	КоличествоЗаписейНЗП = 0;
	Если НЕ РассчитатьВсе Тогда
		РассчитатьПрочиеРасходыНЗП(НачалоПериода, ОкончаниеПериода, МассивОрганизаций, КоличествоЗаписейНЗП); // формирует часть движений по ПрочиеРасходыНезавершенногоПроизводства
	КонецЕсли;
	КоличествоЗаписейВсего = КоличествоЗаписейВсего  + КоличествоЗаписейНЗП;
КонецПроцедуры

// Этап 18-5: расчет прочих расходов НЗП
Процедура РассчитатьПрочиеРасходыНЗП(НачалоПериода, ОкончаниеПериода, МассивОрганизаций, КоличествоЗаписей = 0)
	ИмяРегистра = Метаданные.РегистрыНакопления.ПрочиеРасходыНезавершенногоПроизводства.Имя;
	
	НачалоЗамера = ТекущаяУниверсальнаяДатаВМиллисекундах();
	// ФАЗА 50: Выборка данных прочих расходов незавершенного производства
	ДанныеДляПрочихРасходовНЗП = ДанныеДляПрочихРасходовНЗП(НачалоПериода, ОкончаниеПериода, МассивОрганизаций);
	// ФАЗА 51: Расчет прочих расходов незавершенного производства по исходным данным
	Регистраторы = Регистраторы(НачалоПериода, ОкончаниеПериода, МассивОрганизаций, ИмяРегистра);
	РасчетныеПрочиеРасходыНЗП = РасчетныеПрочиеРасходыНЗП(ДанныеДляПрочихРасходовНЗП, Регистраторы);
	// ФАЗА 52: запись прочих расходов незавершенного производства
	ЗаписатьРасчетныеПартии(РегистрыНакопления[ИмяРегистра], РасчетныеПрочиеРасходыНЗП, Регистраторы);
	ОчиститьРегистрНаСервере(Регистраторы, ИмяРегистра);
	// Завершение этапа
	КоличествоЗаписей = КоличествоЗаписей(ДанныеДляПрочихРасходовНЗП);
	ДанныеДляПрочихРасходовНЗП.Закрыть();
	РасчетныеПрочиеРасходыНЗП = Неопределено;
	Замер = ТекущаяУниверсальнаяДатаВМиллисекундах() - НачалоЗамера;
	Комментарий = НСтр("ru = 'Рассчитано %КолвоСтрок% стр. за %Замер% сек.';
						|en = '%КолвоСтрок% rows are calculated for %Замер% sec.'", ОбщегоНазначения.КодОсновногоЯзыка());
	Комментарий = СтрЗаменить(Комментарий, "%КолвоСтрок%", КоличествоЗаписей);
	Комментарий = СтрЗаменить(Комментарий, "%Замер%", Формат(Замер/1000., "ЧДЦ=3; ЧН=; ЧГ="));
	ЗаписьЖурналаРегистрации(
		НСтр("ru = 'Партионный учет.ПрочиеРасходыНезавершенногоПроизводства';
			|en = 'Batch accounting.ПрочиеРасходыНезавершенногоПроизводства'",	ОбщегоНазначения.КодОсновногоЯзыка()),
		УровеньЖурналаРегистрации.Информация,,, Комментарий);
КонецПроцедуры

// Этап 18-6: расчет движений себестоимости производства
Процедура РассчитатьСебестоимостьПроизводства(НачалоПериода, ОкончаниеПериода, МассивОрганизаций, КоличествоЗаписей = 0)
	ИмяРегистра = Метаданные.РегистрыНакопления.СебестоимостьТоваров.Имя;
	
	НачалоЗамера = ТекущаяУниверсальнаяДатаВМиллисекундах();
	// ФАЗА 61: Расчет (трансляция в себестоимость товаров)
	ДанныеДляСебестоимостиПроизводства = ДанныеДляСебестоимостиПроизводства(НачалоПериода, ОкончаниеПериода, МассивОрганизаций);
	Регистраторы = РегистраторыСебестоимостиПроизводства(ДанныеДляСебестоимостиПроизводства, НачалоПериода, ОкончаниеПериода, МассивОрганизаций);
	// ФАЗА 62: Запись расходов в СебестоимостьТоваров
	Запрос = Новый Запрос("ВЫБРАТЬ * ИЗ Данные КАК Т");
	Запрос.МенеджерВременныхТаблиц = ДанныеДляСебестоимостиПроизводства;
	ДвиженияСебестоимостиПроизводства = Запрос.Выполнить().Выгрузить();
	ЗаписатьРасчетныеПартии(РегистрыНакопления[ИмяРегистра], ДвиженияСебестоимостиПроизводства, Регистраторы);
	ОчиститьРегистрНаСервере(Регистраторы, ИмяРегистра);
	// ФАЗА 63: Запись в ОтражениеДокументовВРеглУчете
	ВернутьДокументыСДвижениямиПоСебестоимостиКОтражениюВРеглУчете(ДанныеДляСебестоимостиПроизводства);
	// Завершение этапа
	КоличествоЗаписей = ДвиженияСебестоимостиПроизводства.Количество();
	ДвиженияСебестоимостиПроизводства = Неопределено;
	ДанныеДляСебестоимостиПроизводства.Закрыть();
	Замер = ТекущаяУниверсальнаяДатаВМиллисекундах() - НачалоЗамера;
	Комментарий = НСтр("ru = 'Рассчитано %КолвоСтрок% стр. за %Замер% сек.';
						|en = '%КолвоСтрок% rows are calculated for %Замер% sec.'", ОбщегоНазначения.КодОсновногоЯзыка());
	Комментарий = СтрЗаменить(Комментарий, "%КолвоСтрок%", КоличествоЗаписей);
	Комментарий = СтрЗаменить(Комментарий, "%Замер%", Формат(Замер/1000., "ЧДЦ=3; ЧН=; ЧГ="));
	ЗаписьЖурналаРегистрации(
		НСтр("ru = 'Партионный учет.СебестоимостьТоваров';
			|en = 'Batch accounting.СебестоимостьТоваров'",	ОбщегоНазначения.КодОсновногоЯзыка()),
		УровеньЖурналаРегистрации.Информация,,, Комментарий);
КонецПроцедуры
//-- НЕ УТ

// Этап 2Х: расчет партий затрат на выпуск
Процедура РассчитатьПартииЗатрат(НачалоПериода, ОкончаниеПериода, МассивОрганизаций, КоличествоЗаписей = 0)
	ИмяРегистра = Метаданные.РегистрыНакопления.ПартииЗатратНаВыпуск.Имя;
	
	НачалоЗамера = ТекущаяУниверсальнаяДатаВМиллисекундах();
	// ФАЗА 20: Выборка исходных данных для расчета партий затрат на выпуск
	ДанныеДляПартийЗатрат = ДанныеДляПартийЗатрат(НачалоПериода, ОкончаниеПериода, МассивОрганизаций);
	// ФАЗА 22: Расчет партий затрат по исходным данным
	Регистраторы = Регистраторы(НачалоПериода, ОкончаниеПериода, МассивОрганизаций, ИмяРегистра);
	РегистраторыПартийВПути(НачалоПериода, ОкончаниеПериода, МассивОрганизаций, Регистраторы);
	РегистраторыССохраняемымиДвижениями = РегистраторыССохраняемымиДвижениями(ИмяРегистра, ДанныеДляПартийЗатрат, Регистраторы, НачалоПериода, ОкончаниеПериода, МассивОрганизаций);
	РасчетныеПартииЗатрат = РасчетныеПартииЗатрат(ДанныеДляПартийЗатрат, Регистраторы);
	// ФАЗА 24: Запись регистра ПартииЗатратНаВыпуск
	ЗаписатьРасчетныеПартии(РегистрыНакопления[ИмяРегистра], РасчетныеПартииЗатрат, Регистраторы);
	ОчиститьРегистрНаСервере(Регистраторы, ИмяРегистра, РегистраторыССохраняемымиДвижениями);
	ЗаписатьСохраняемыеДвижения(РегистрыНакопления[ИмяРегистра], ДанныеДляПартийЗатрат, РегистраторыССохраняемымиДвижениями);
	// Завершение этапа
	КоличествоЗаписей = КоличествоЗаписей(ДанныеДляПартийЗатрат);
	ДанныеДляПартийЗатрат.Закрыть();
	РасчетныеПартииЗатрат = Неопределено;
	Замер = ТекущаяУниверсальнаяДатаВМиллисекундах() - НачалоЗамера;
	Комментарий = НСтр("ru = 'Рассчитано %КолвоСтрок% стр. за %Замер% сек.';
						|en = '%КолвоСтрок% rows are calculated for %Замер% sec.'", ОбщегоНазначения.КодОсновногоЯзыка());
	Комментарий = СтрЗаменить(Комментарий, "%КолвоСтрок%", КоличествоЗаписей);
	Комментарий = СтрЗаменить(Комментарий, "%Замер%", Формат(Замер/1000., "ЧДЦ=3; ЧН=; ЧГ="));
	ЗаписьЖурналаРегистрации(
		НСтр("ru = 'Партионный учет.ПартииЗатратНаВыпуск';
			|en = 'Batch accounting.ПартииЗатратНаВыпуск'",ОбщегоНазначения.КодОсновногоЯзыка()),
		УровеньЖурналаРегистрации.Информация,,, Комментарий);
КонецПроцедуры

// Этапы 3Х и 4Х: расчет партий прочих расходов на себестоимость товаров, партионный учет включен.
Процедура РассчитатьПартииПрочих(НачалоПериода, ОкончаниеПериода, МассивОрганизаций, КоличествоЗаписей = 0)
	
	ПартионныйУчетВключен = РасчетСебестоимостиПовтИсп.ПартионныйУчетВерсии21(НачалоПериода);
// Область РасчетПартийПрочих
	// ФАЗА 30: Выборка исходных данных для расчета списания партий прочих расходов.
	Регистраторы = РегистраторыПартийПрочих(НачалоПериода, ОкончаниеПериода, МассивОрганизаций);
	Если ПартионныйУчетВключен Тогда
		ДанныеДляПартийПрочих = ДанныеДляПартийПрочих(НачалоПериода, ОкончаниеПериода, МассивОрганизаций);
	Иначе
		ДанныеДляПартийПрочих = ДанныеДляПартийПрочихСебестоимость(НачалоПериода, ОкончаниеПериода, МассивОрганизаций);
	КонецЕсли;
	// ФАЗА 32: Расчет расхода ПартииПрочихРасходов
	РасчетныеПартииПрочих = РасчетныеПартииПрочих(ДанныеДляПартийПрочих, Неопределено, Неопределено, Ложь, КоличествоЗаписей);
	
	ЗаписатьРасчетныеПартии(РегистрыНакопления.ПартииПрочихРасходов, РасчетныеПартииПрочих, Неопределено);
	
// Область РасчетПриходыРасходовСебестоимость
	// ФАЗА 40: Расчет прихода в ПартииРасходовНаСебестоимостьТоваров.
	РасчетныеПриходыПартийРасходов = РасчетныеПриходыПартийРасходов(ДанныеДляПартийПрочих, Неопределено);
	ДанныеДляПартийПрочих = Неопределено;
	
	// Фаза 42: Расчет приходов в прочие расходы
	РасчетныеДвиженияПрочихРасходов = РасчетныеДвиженияПрочихРасходов(НачалоПериода, РасчетныеПриходыПартийРасходов, РасчетныеПартииПрочих);
	
	ЗаписатьРасчетныеПартии(РегистрыНакопления.ПрочиеРасходы, РасчетныеДвиженияПрочихРасходов, Неопределено);
	РасчетныеДвиженияПрочихРасходов = Неопределено;
	РасчетныеПартииПрочих = Неопределено;
	
	// Фаза 43: Расчет приходов в партии НДС к распределению
	РасчетныеПартииНДСКРаспределению = РасчетныеПриходыПартийНДСКРаспределению(НачалоПериода, РасчетныеПриходыПартийРасходов);
	
	ЗаписатьРасчетныеПартии(РегистрыНакопления.ПартииНДСКРаспределению, РасчетныеПартииНДСКРаспределению, Неопределено);
	РасчетныеПартииНДСКРаспределению = Неопределено;
	
	// ФАЗА 44: Расчет (трансляция приходов партий расходов) приходов в себестоимость товаров.
	РасчетныеПриходыСебестоимости = РасчетныеПриходыСебестоимости(НачалоПериода, РасчетныеПриходыПартийРасходов, Регистраторы);
	
	// ФАЗА 45: Запись прихода в СебестоимостьТоваров
	ЗаписатьРасчетныеПартии(РегистрыНакопления.СебестоимостьТоваров, РасчетныеПриходыСебестоимости, Неопределено);
	
	// ФАЗА 46: Запись прихода в ПартииРасходовНаСебестоимостьТоваров
	Если ПартионныйУчетВключен Тогда
		УдалитьНезаписываемыеСтроки("ПартииРасходовНаСебестоимостьТоваров", РасчетныеПриходыПартийРасходов);		
		ЗаписатьРасчетныеПартии(РегистрыНакопления.ПартииРасходовНаСебестоимостьТоваров, РасчетныеПриходыПартийРасходов, Неопределено);
	КонецЕсли;
	РасчетныеПриходыПартийРасходов = Неопределено;
	
	//++ НЕ УТ

	// ФАЗА 47: Запись в ОтражениеДокументовВРеглУчете
	ВернутьДокументыКОтражениюВРеглУчете(НачалоПериода, ОкончаниеПериода, МассивОрганизаций);
	//++ НЕ УТКА

	// ФАЗА 47: Запись в ОтражениеДокументовВМеждународномУчете
	ВернутьДокументыКОтражениюВМеждународномУчете(НачалоПериода, ОкончаниеПериода, МассивОрганизаций);
	//-- НЕ УТКА

	//-- НЕ УТ
	РасчетныеПриходыСебестоимости = Неопределено;
	
// Область РасчетЗаписейНоменклатураДоходыРасходы
	// ФАЗА 47: Выборка исходных данных для движений в НоменклатураДоходыРасходы.
	ДанныеДляНоменклатураДоходыРасходы = ДанныеДляНоменклатураДоходыРасходы(НачалоПериода, ОкончаниеПериода, МассивОрганизаций);
	// ФАЗА 48: Запись движений в НоменклатураДоходыРасходы
	ЗаписатьРасчетныеПартии(РегистрыНакопления.ДвиженияНоменклатураДоходыРасходы, ДанныеДляНоменклатураДоходыРасходы, Неопределено);
	КоличествоЗаписей = КоличествоЗаписей + ДанныеДляНоменклатураДоходыРасходы.Количество();
	ДанныеДляНоменклатураДоходыРасходы = Неопределено;
	
	МассивПоддерживаемыхТипов = Новый Массив;
	МассивПоддерживаемыхТипов.Добавить(Тип("ДокументСсылка.СчетФактураНалоговыйАгент"));
	МассивПоддерживаемыхТипов.Добавить(Тип("ДокументСсылка.СчетФактураПолученныйНалоговыйАгент"));
	РегистраторыДвиженияНоменклатураДоходыРасходы = Регистраторы(НачалоПериода, ОкончаниеПериода, МассивОрганизаций, Метаданные.РегистрыНакопления.ДвиженияНоменклатураДоходыРасходы.Имя,,
		МассивПоддерживаемыхТипов);
	ОчиститьРегистрНаСервере(РегистраторыДвиженияНоменклатураДоходыРасходы, "ДвиженияНоменклатураДоходыРасходы");
КонецПроцедуры

// Этап 5Х: расчет партий расходов на себестоимость выбытия товаров
Процедура РассчитатьПартииРасходов(НачалоПериода, ОкончаниеПериода, МассивОрганизаций, КоличествоЗаписей = 0)
	ИмяРегистра = Метаданные.РегистрыНакопления.ПартииРасходовНаСебестоимостьТоваров.Имя;
	
	НачалоЗамера = ТекущаяУниверсальнаяДатаВМиллисекундах();
	// ФАЗА 50: Выборка исходных данных для расчета списания партий расходов на себестоимость товаров.
	ДанныеДляПартийРасходов = ДанныеДляПартийРасходов(НачалоПериода, ОкончаниеПериода, МассивОрганизаций);
	// ФАЗА 52: Расчет расхода ПартииРасходовНаСебестоимостьТоваров
	Регистраторы = Регистраторы(НачалоПериода, ОкончаниеПериода, МассивОрганизаций, ИмяРегистра);
	РегистраторыПартийВПути(НачалоПериода, ОкончаниеПериода, МассивОрганизаций, Регистраторы);
	РегистраторыССохраняемымиДвижениями = РегистраторыССохраняемымиДвижениями(ИмяРегистра, ДанныеДляПартийРасходов, Регистраторы, НачалоПериода, ОкончаниеПериода, МассивОрганизаций);
	РасчетныеПартииРасходов = РасчетныеПартииРасходов(ДанныеДляПартийРасходов, Регистраторы);
	// ФАЗА 54: Запись расхода ПартииРасходовНаСебестоимостьТоваров
	ЗаписатьРасчетныеПартии(РегистрыНакопления[ИмяРегистра], РасчетныеПартииРасходов, Регистраторы);
	ОчиститьРегистрНаСервере(Регистраторы, ИмяРегистра, РегистраторыССохраняемымиДвижениями);
	ЗаписатьСохраняемыеДвижения(РегистрыНакопления[ИмяРегистра], ДанныеДляПартийРасходов, РегистраторыССохраняемымиДвижениями);
	// Завершение этапа
	КоличествоЗаписей = КоличествоЗаписей(ДанныеДляПартийРасходов);
	ДанныеДляПартийРасходов.Закрыть();
	РасчетныеПартииРасходов = Неопределено;
	Замер = ТекущаяУниверсальнаяДатаВМиллисекундах() - НачалоЗамера;
	Комментарий = НСтр("ru = 'Рассчитано %КолвоСтрок% стр. за %Замер% сек.';
						|en = '%КолвоСтрок% rows are calculated for %Замер% sec.'", ОбщегоНазначения.КодОсновногоЯзыка());
	Комментарий = СтрЗаменить(Комментарий, "%КолвоСтрок%", КоличествоЗаписей);
	Комментарий = СтрЗаменить(Комментарий, "%Замер%", Формат(Замер/1000., "ЧДЦ=3; ЧН=; ЧГ="));
	ЗаписьЖурналаРегистрации(
		НСтр("ru = 'Партионный учет.ПартииРасходовНаСебестоимостьТоваров';
			|en = 'Batch accounting.ПартииРасходовНаСебестоимостьТоваров'",ОбщегоНазначения.КодОсновногоЯзыка()),
		УровеньЖурналаРегистрации.Информация,,, Комментарий);
КонецПроцедуры

// Этап 64: расчет приходов партий прочих расходов
Процедура РассчитатьПриходыПартийНДСКРаспределению(НачалоПериода, ОкончаниеПериода, МассивОрганизаций, КоличествоЗаписей)
	ИмяРегистра = Метаданные.РегистрыНакопления.ПартииНДСКРаспределению.Имя;
	
	// ФАЗА 60: выборка данных для приходов партий прочих расходов
	ДанныеДляПартийНДСКРаспределению = ДанныеДляПартийНДСКРаспределению(НачалоПериода, ОкончаниеПериода, МассивОрганизаций);
	// ФАЗА 62: запись книги продаж
	ЗаписатьРасчетныеПартии(РегистрыНакопления[ИмяРегистра], ДанныеДляПартийНДСКРаспределению, Неопределено);
	КоличествоЗаписей = ДанныеДляПартийНДСКРаспределению.Количество();
	// Завершение этапа
	ДанныеДляПартийНДСКРаспределению = Неопределено;
КонецПроцедуры
	
Процедура СформироватьДвиженияПоНДС(ОкончаниеПериода, МассивОрганизаций, КоличествоЗаписей = 0)
	
	// Корректировка и распределение НДС
	РасчетСебестоимостиНДС.СформироватьЗаданияДляМеханизмовУчетаНДСПартионныйУчет21(ОкончаниеПериода, МассивОрганизаций, Ложь);
	
	РезультатРаспределенияНДС = Документы.РаспределениеНДС.РаспределитьНДС(
		ОкончаниеПериода,
		МассивОрганизаций,
		НСтр("ru = 'Партионный учет.Распределение НДС.';
			|en = 'Batch accounting.VAT allocation.'", ОбщегоНазначения.КодОсновногоЯзыка()),
		,
		Истина);
	
	// Значение "РезультатРаспределенияНДС.ТекстОшибки" не проверяем - продолжим выполнение в любом случае.
	КоличествоЗаписей = КоличествоЗаписей + РезультатРаспределенияНДС.МассивДокументов.Количество();
	
КонецПроцедуры

Процедура РассчитатьСебестоимость(ОкончаниеПериода, МассивОрганизаций, ИзмененоДокументов, ОписаниеЗамера)
	
	ВосстановитьДвиженияДокументовСДублямиДвиженийПоВыручкеИСебестоимостиПродаж(
		НачалоМесяца(ОкончаниеПериода),
		ОкончаниеПериода,
		МассивОрганизаций);
		
	ВосстановитьДвиженияПоВыручкеИСебестоимостиПродажСформированныеВВерсииПУ22(
		НачалоМесяца(ОкончаниеПериода),
		ОкончаниеПериода,
		МассивОрганизаций);
		
	ЗаполнитьВидыЗапасовИНазначенияВВыручкеИСебестоимостиПродаж(
		НачалоМесяца(ОкончаниеПериода),
		ОкончаниеПериода,
		МассивОрганизаций);
	
	ПараметрыЗапускаРасчетаСебестоимости = Новый Структура;
	ПараметрыЗапускаРасчетаСебестоимости.Вставить("Дата", 					ОкончаниеПериода);
	ПараметрыЗапускаРасчетаСебестоимости.Вставить("ПредварительныйРасчет", 	Ложь);
	ПараметрыЗапускаРасчетаСебестоимости.Вставить("МассивОрганизаций", 		МассивОрганизаций);
	ПараметрыЗапускаРасчетаСебестоимости.Вставить("РегламентноеЗадание", 	Ложь);
	ПараметрыЗапускаРасчетаСебестоимости.Вставить("МестоВызоваРасчета", 	"ПартионныйУчет.РассчитатьСебестоимость");
	ПараметрыЗапускаРасчетаСебестоимости.Вставить("ОписаниеЗамера", 		ОписаниеЗамера);
	
	СебестоимостьРассчитана = РасчетСебестоимостиПартионныйУчет21.РассчитатьВсеВПопыткеИсключении(ПараметрыЗапускаРасчетаСебестоимости);
	
	Если НЕ СебестоимостьРассчитана Тогда
		ВызватьИсключение РасчетСебестоимостиПрикладныеАлгоритмы.ТекстОшибкиНекорректногоЗавершенияРасчетаСебестоимости();
	КонецЕсли;
	
КонецПроцедуры

// По окончании расчета создает записи регистров "Задания к..."
Процедура УстановитьГраницыРассчитанногоПериода(НачалоПериода, МассивОрганизаций, НомерЗаданияДоРасчета, ВременныеТаблицы)
	
	НачатьТранзакцию();
	
	Попытка
		РасчетСебестоимостиПрикладныеАлгоритмы.ЗаблокироватьРегистрЗаданий(НомерЗаданияДоРасчета, МассивОрганизаций);
		РасчетСебестоимостиПрикладныеАлгоритмы.УвеличитьПериодРасчетаСебестоимости(НачалоПериода, МассивОрганизаций, ВременныеТаблицы);
		ЗафиксироватьТранзакцию();
	Исключение
		ОтменитьТранзакцию();
		ТекстОшибки = ПодробноеПредставлениеОшибки(ИнформацияОбОшибке());
		ВызватьИсключение ТекстОшибки;
	КонецПопытки;
	
	РасчетСебестоимостиНДС.СформироватьЗаданияДляМеханизмовУчетаНДСПартионныйУчет21(НачалоПериода, МассивОрганизаций, Истина);
	
КонецПроцедуры

#КонецОбласти


#Область РасчетПартийТоваров

// Текст запроса исходных движений для расчета партий
Функция ДанныеДляПартийТоваров(НачалоПериода, ОкончаниеПериода, МассивОрганизаций)
	// СОРТИРОВКА по аналитикам, приоритету и моменту движения - требование алгоритма обсчета партий.
	ТекстСортировка = "
		|УПОРЯДОЧИТЬ ПО
		|	Номенклатура, ПериодПоступления, Приоритет ВОЗР, РазделУчета, Организация, ВидЗапасов, АналитикаУчетаПартий, Регистратор
		|";
	ТекстИндексы = "
		|ИНДЕКСИРОВАТЬ ПО
		|	Номенклатура
		|";
	
	ИсходныйТекстЗапроса =
		ТекстПартииТоваровИнициализация() + ";" // вт ПрошлыеПоступления
		+ ЕстьУведомленияОВвозеПрослеживаемыхТоваров() // вт ЕстьУведомленияОВвозе
		+ ";"
		+ ТекстОписаниеПартийТоваров()
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстОстаткиПартийТоваров() // использует ПрошлыеПоступления
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстПервичныеПартииТоваров()
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстПервичныеПеремещенияТоваров()
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстРеализацииПрошлыхМесяцев()
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстПотребленияТоваров()
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстСписанияКомиссионныхТоваров()
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстПриходыПеремещений()
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстСписаниеИмпортныхПартий()
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстСписаниеТаможеннойДекларацией()
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстПриходыРастаможенногоТовара()
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстПотребленияЧужихЗапасов()
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстВозвратыЧужихЗапасов()
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстПотребленияСобственныхЗапасов()
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстПередачиВозвратыКомиссияМеждуОрганизациями()
		//++ НЕ УТ
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстОстаткиВПроизводстве()
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстВводыОстатковВПроизводстве()
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстПоступленияОтходовВПроизводство()
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстПередачиВПроизводствоКомиссионныхТоваров()
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстПередачиВПроизводство()
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстВозвратыИзПроизводства()
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстПеремещенияМатериаловВПроизводстве()
		//-- НЕ УТ
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстОстаткиПереданныхТоваров()
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстВводыОстатковПереданныхТоваров()
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстПередачиНаКомиссию()
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстВозвратыПереданныхТоваров()
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстВозвратыНаСкладПереданныхТоваров()
		+ ТекстИндексы;
	МВТ = Новый МенеджерВременныхТаблиц;	
	ИсходныйЗапрос = Новый Запрос(СтрЗаменить(ИсходныйТекстЗапроса, "//ВоВременнуюТаблицу", ""));
	ИсходныйЗапрос.УстановитьПараметр("НачалоПериода", НачалоПериода);
	ИсходныйЗапрос.УстановитьПараметр("ОкончаниеПериода", ОкончаниеПериода);	
	ИсходныйЗапрос.УстановитьПараметр("МассивОрганизаций", МассивОрганизаций);
	ИсходныйЗапрос.УстановитьПараметр("ТипДокументаИмпорта", ОбщегоНазначения.ИдентификаторОбъектаМетаданных("Документ.ТаможеннаяДекларацияИмпорт"));		
	ИсходныйЗапрос.УстановитьПараметр("КонецПредыдущегоПериода", НачалоПериода - 1);
	ИсходныйЗапрос.УстановитьПараметр("ГраницаКонецПредыдущегоПериода", Новый Граница(НачалоПериода - 1, ВидГраницы.Включая));
	ИсходныйЗапрос.МенеджерВременныхТаблиц = МВТ;
	ИсходныйЗапрос.Выполнить();
	
	Запрос = Новый Запрос(ТекстОписаниеПартийТоваров());
	РасчетныеПартии = Запрос.Выполнить().Выгрузить();
	
	ВременнаяТаблицаДанныхПоОтбору("Номенклатура", ТекстСортировка, РасчетныеПартии, МВТ);
	
	Возврат МВТ;
КонецФункции

Функция РасчетныеПартииТоваров(ДанныеДляРасчета, Регистраторы, ЦепочкиДвижений = Неопределено, Тест = Ложь, РассчитатьПартии = Истина) // ДанныеДляРасчета будут изменены
	// Шаг 1: создаем буфер накопления рассчитанных партий
	Запрос = Новый Запрос(ТекстОписаниеПартийТоваров());
	РасчетныеПартии = Запрос.Выполнить().Выгрузить();
	
	// Шаг 2: готовим описание обсчета
	КонтекстЦепочек = ОписаниеЦепочек("Потребление, Партия, Остаток, Сторно, Перемещение, Прошлое, Материал, Производство,
		|Возврат, Корректировка, Импорт, Декларация, ВозвратКомиссия, ПеремещениеВПроизводстве");
	
	ПоляПотреблений = "АналитикаУчетаНоменклатуры, ВидЗапасов, Организация, РазделУчета";
	КонтекстДвижений = ОписаниеДвижений(
		"ПартииТоваровОрганизаций",
		"ПартииТоваровОрганизаций",
		ПереченьПолей(РасчетныеПартии.Колонки),
		ПоляПотреблений,
		"Знаменатель, Количество, Стоимость, СтоимостьБезНДС, СтоимостьРегл, НДСРегл, ПостояннаяРазница, ВременнаяРазница",
		"Количество", "Количество", "ДокументИсточник", "ПериодПоступления", "ДокументПоступления", Истина);
		
	// Шаг 3: обсчитываем потребления из партий
	ДобавитьОписаниеПриемника(КонтекстЦепочек, "Потребление", ПоляПотреблений);
	ДобавитьОписаниеИсточника(КонтекстЦепочек, "Потребление", "Остаток", 	 ПоляПотреблений);
	ДобавитьОписаниеИсточника(КонтекстЦепочек, "Потребление", "Партия", 	 ПоляПотреблений);
	ДобавитьОписаниеИсточника(КонтекстЦепочек, "Потребление", "Импорт", 	 ПоляПотреблений);
	ДобавитьОписаниеИсточника(КонтекстЦепочек, "Потребление", "Перемещение", ПоляПотреблений);
	ДобавитьОписаниеИсточника(КонтекстЦепочек, "Потребление", "Сторно", 	 ПоляПотреблений);
	
	ДобавитьОписаниеПриемника(КонтекстЦепочек, "Декларация", "АналитикаУчетаНоменклатуры, ВидЗапасов, Организация, РазделУчета, ДокументПоступления");
	ДобавитьОписаниеИсточника(КонтекстЦепочек, "Декларация", "Остаток", "АналитикаУчетаНоменклатуры, ВидЗапасов, Организация, РазделУчета, ДокументПоступления");
	ДобавитьОписаниеИсточника(КонтекстЦепочек, "Декларация", "Импорт",  "АналитикаУчетаНоменклатуры, ВидЗапасов, Организация, РазделУчета, ДокументПоступления");
	
	ДобавитьОписаниеПриемника(КонтекстЦепочек, "Материал", ПоляПотреблений);
	ДобавитьОписаниеИсточника(КонтекстЦепочек, "Материал", "Остаток", 	  ПоляПотреблений);
	ДобавитьОписаниеИсточника(КонтекстЦепочек, "Материал", "Партия", 	  ПоляПотреблений);
	ДобавитьОписаниеИсточника(КонтекстЦепочек, "Материал", "Перемещение", ПоляПотреблений);
	ДобавитьОписаниеИсточника(КонтекстЦепочек, "Материал", "Сторно", 	  ПоляПотреблений);
	
	ДобавитьОписаниеПриемника(КонтекстЦепочек, "Корректировка", "ДокументПоступления, АналитикаУчетаНоменклатуры, ВидЗапасов, Организация, РазделУчета");
	ДобавитьОписаниеИсточника(КонтекстЦепочек, "Корректировка", "Остаток", "ДокументПоступления, АналитикаУчетаНоменклатуры, ВидЗапасов, Организация, РазделУчета");
	ДобавитьОписаниеИсточника(КонтекстЦепочек, "Корректировка", "Партия",  "ДокументПоступления, АналитикаУчетаНоменклатуры, ВидЗапасов, Организация, РазделУчета");
	
	ДобавитьОписаниеПриемника(КонтекстЦепочек, "Сторно", "ДокументИсточник, КорАналитикаУчетаНоменклатуры, КорВидЗапасов");
	ДобавитьОписаниеИсточника(КонтекстЦепочек, "Сторно", "Потребление", "Регистратор, АналитикаУчетаНоменклатуры, ВидЗапасов");
	ДобавитьОписаниеИсточника(КонтекстЦепочек, "Сторно", "Прошлое", 	"Регистратор, АналитикаУчетаНоменклатуры, ВидЗапасов");
	ДобавитьОписаниеИсточника(КонтекстЦепочек, "Сторно", "Материал", 	"Регистратор, АналитикаУчетаНоменклатуры, ВидЗапасов");
	ДобавитьОписаниеИсточника(КонтекстЦепочек, "Сторно", "Возврат", 	"Регистратор, АналитикаУчетаНоменклатуры, КорВидЗапасов");
	ДобавитьОписаниеИсточника(КонтекстЦепочек, "Сторно", "ВозвратКомиссия", "Регистратор, АналитикаУчетаНоменклатуры, ВидЗапасов");
	
	ДобавитьОписаниеПриемника(КонтекстЦепочек, "Перемещение", "ДокументИсточник, АналитикаУчетаНоменклатуры, ВидЗапасов");
	ДобавитьОписаниеИсточника(КонтекстЦепочек, "Перемещение", "Потребление", "Регистратор, КорАналитикаУчетаНоменклатуры, КорВидЗапасов");
	ДобавитьОписаниеИсточника(КонтекстЦепочек, "Перемещение", "Декларация",  "Регистратор, КорАналитикаУчетаНоменклатуры, КорВидЗапасов");
	ДобавитьОписаниеИсточника(КонтекстЦепочек, "Перемещение", "Материал", 	 "Регистратор, КорАналитикаУчетаНоменклатуры, КорВидЗапасов");
	ДобавитьОписаниеИсточника(КонтекстЦепочек, "Перемещение", "ПеремещениеВПроизводстве", "Регистратор, КорАналитикаУчетаНоменклатуры, КорВидЗапасов");
	
	ДобавитьОписаниеПриемника(КонтекстЦепочек, "Производство", "ДокументИсточник, КорАналитикаУчетаНоменклатуры, КорВидЗапасов");
	ДобавитьОписаниеИсточника(КонтекстЦепочек, "Производство", "Потребление", "Регистратор, АналитикаУчетаНоменклатуры, ВидЗапасов");
	
	ДобавитьОписаниеПриемника(КонтекстЦепочек, "ПеремещениеВПроизводстве", "АналитикаУчетаНоменклатуры, Организация, РазделУчета, Назначение");
	ДобавитьОписаниеИсточника(КонтекстЦепочек, "ПеремещениеВПроизводстве", "Производство", "АналитикаУчетаНоменклатуры, Организация, РазделУчета, Назначение");
	ДобавитьОписаниеИсточника(КонтекстЦепочек, "ПеремещениеВПроизводстве", "Остаток", 	  "АналитикаУчетаНоменклатуры, Организация, РазделУчета, Назначение");
	
	ДобавитьОписаниеПриемника(КонтекстЦепочек, "Возврат", "АналитикаУчетаНоменклатуры, Организация, РазделУчета, Назначение");
	ДобавитьОписаниеИсточника(КонтекстЦепочек, "Возврат", "Производство", "АналитикаУчетаНоменклатуры, Организация, РазделУчета, Назначение");
	ДобавитьОписаниеИсточника(КонтекстЦепочек, "Возврат", "Остаток", 	  "АналитикаУчетаНоменклатуры, Организация, РазделУчета, Назначение");
	ДобавитьОписаниеИсточника(КонтекстЦепочек, "Возврат", "Перемещение",  "АналитикаУчетаНоменклатуры, Организация, РазделУчета, Назначение");
	
	ДобавитьОписаниеПриемника(КонтекстЦепочек, "ВозвратКомиссия", "ДокументИсточник, АналитикаУчетаНоменклатуры, ВидЗапасов, Организация, РазделУчета");
	ДобавитьОписаниеИсточника(КонтекстЦепочек, "ВозвратКомиссия", "Перемещение", "Регистратор, АналитикаУчетаНоменклатуры, ВидЗапасов, Организация, РазделУчета");
	ДобавитьОписаниеИсточника(КонтекстЦепочек, "ВозвратКомиссия", "Остаток", "Регистратор, АналитикаУчетаНоменклатуры, ВидЗапасов, Организация, РазделУчета");
	
	ЦепочкиДвижений(КонтекстЦепочек, ДанныеДляРасчета);
	Если РассчитатьПартии Тогда
		РассчитатьПартииПоЦепочкам(КонтекстДвижений, ДанныеДляРасчета, РасчетныеПартии, Регистраторы, Тест);
	КонецЕсли;
	ЦепочкиДвижений = ДанныеДляРасчета;
	
	// Шаг 4: Удаляем строки, не требующие записи в базу.
	Если Не Тест Тогда
		УдалитьНезаписываемыеСтроки(КонтекстДвижений.Контекст, РасчетныеПартии);
	КонецЕсли;
	
	// Шаг 5: Сортировка партий для дальнейшей записи
	РасчетныеПартии.Сортировать("Регистратор, Приоритет", Новый СравнениеЗначений);
	Возврат РасчетныеПартии;
КонецФункции

Функция ТекстПартииТоваровИнициализация() // вт ПотребленияЧужихЗапасов, ПрошлыеРеализации, ПрошлыеПоступления, МатериалыИРаботыВПроизводстве, ПрошлыеПоступленияПроизводство, КорректировкиПоступлений
	Возврат "
		|ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	ДД.Регистратор,
		|	ДД.ОрганизацияВладелец,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.НомерГТД,
		|	ДД.ВидЗапасовПродавца,
		|	ВидыЗапасов.ВидЗапасовВладельца,
		|	ВидыЗапасов.Организация КАК ОрганизацияПродавец
		|ПОМЕСТИТЬ
		|	ПотребленияЧужихЗапасов
		|ИЗ
		|	РегистрНакопления.ТоварыОрганизацийКПередаче КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ВидыЗапасов КАК ВидыЗапасов
		|		ПО ВидыЗапасов.Ссылка = ДД.ВидЗапасовПродавца
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрНакопления.ТоварыОрганизаций КАК Расходы
		|		ПО Расходы.Регистратор = ДД.Регистратор
		|		И Расходы.Организация = ДД.ОрганизацияВладелец
		|		И Расходы.АналитикаУчетаНоменклатуры = ДД.АналитикаУчетаНоменклатуры
		|		И Расходы.НомерГТД = ДД.НомерГТД
		|		И Расходы.ВидЗапасов = ВидыЗапасов.ВидЗапасовВладельца
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ВидыЗапасов.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|	И Расходы.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		|;
	    |ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	ДД.ДокументРеализации КАК ДокументРеализации,
		|	ДД.КорАналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
		|	ДД.КорВидЗапасов КАК ВидЗапасов
		|ПОМЕСТИТЬ
		|	ПрошлыеРеализации
		|ИЗ
		|	РегистрНакопления.ТоварыОрганизаций КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрНакопления.ТоварыОрганизаций КАК Расход
		|		ПО Расход.Период < &НачалоПериода
		|		И Расход.Регистратор = ДД.ДокументРеализации
		|		И Расход.АналитикаУчетаНоменклатуры = ДД.КорАналитикаУчетаНоменклатуры
		|		И Расход.ВидЗапасов = ДД.КорВидЗапасов
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И ДД.ДокументРеализации <> НЕОПРЕДЕЛЕНО
		|	И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		|	И ДД.Количество < 0
		|	
		|ОБЪЕДИНИТЬ ВСЕ
		|ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	ДД.ДокументРеализации КАК ДокументРеализации,
		|	ДД.КорАналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
		|	ДД.КорВидЗапасов КАК ВидЗапасов
		|ИЗ
		|	РегистрНакопления.ТоварыОрганизаций КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрНакопления.ТоварыОрганизацийКПередаче КАК Расход
		|		ПО Расход.Период < &НачалоПериода
		|		И Расход.Регистратор = ДД.ДокументРеализации
		|		И Расход.АналитикаУчетаНоменклатуры = ДД.КорАналитикаУчетаНоменклатуры
		|		И Расход.ВидЗапасовПродавца = ДД.КорВидЗапасов
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Активность
		|	И ДД.ДокументРеализации <> НЕОПРЕДЕЛЕНО
		|	И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		|	И ДД.Количество < 0
		|;
		|ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	ДД.ДокументПоступления КАК Ссылка,
		|	МАКСИМУМ(Периодика.Период) КАК Период,
		|	(ВЫБОР КОГДА Импорт.Регистратор ЕСТЬ NULL
		|		ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыНаСкладах)
		|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КОНЕЦ) КАК РазделУчета
		|ПОМЕСТИТЬ ПрошлыеПоступления
		|ИЗ
		|	РегистрНакопления.ПартииТоваровОрганизаций.Остатки(&НачалоПериода, Организация В (&МассивОрганизаций)) КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрНакопления.ПартииТоваровОрганизаций КАК Периодика
		|		ПО Периодика.Период < &НачалоПериода
		|		И Периодика.Регистратор = ДД.ДокументПоступления
		|	ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ТоварыКОформлениюДокументовИмпорта КАК Импорт
		|		ПО Импорт.Период < &НачалоПериода
		|		И Импорт.Регистратор = ДД.ДокументПоступления
		|		И Импорт.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|		И Импорт.ТипДокументаИмпорта = &ТипДокументаИмпорта
		|ГДЕ
		|	ДД.ДокументПоступления <> НЕОПРЕДЕЛЕНО
		|СГРУППИРОВАТЬ ПО
		|	ДД.ДокументПоступления,
		|	(ВЫБОР КОГДА Импорт.Регистратор ЕСТЬ NULL
		|		ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыНаСкладах)
		|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КОНЕЦ)
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	ДД.ДокументПоступления КАК Ссылка,
		|	МАКСИМУМ(Периодика.Период) КАК Период,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыНаСкладах) КАК РазделУчета
		|ИЗ
		|	РегистрНакопления.ПартииТоваровОрганизаций.Остатки(&НачалоПериода, Организация В (&МассивОрганизаций)) КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрНакопления.ПартииТоваровПереданныеНаКомиссию КАК Периодика
		|		ПО Периодика.Период < &НачалоПериода
		|		И Периодика.Регистратор = ДД.ДокументПоступления
		|ГДЕ
		|	ДД.ДокументПоступления <> НЕОПРЕДЕЛЕНО
		|СГРУППИРОВАТЬ ПО
		|	ДД.ДокументПоступления
		|;
	    |ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	ДД.Регистратор КАК Регистратор
		|ПОМЕСТИТЬ
		|	МатериалыИРаботыВПроизводстве
		|ИЗ
		|	РегистрНакопления.МатериалыИРаботыВПроизводстве КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Номенклатура КАК Товары
		|		ПО Товары.Ссылка = ДД.Номенклатура
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И Товары.ТипНоменклатуры <> ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.Работа)
		|	И ДД.Количество > 0
		|;
		|ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	ДД.ДокументПоступления КАК Ссылка,
		|	ДД.АналитикаУчетаНоменклатуры.МестоХранения КАК Склад,
		|	МАКСИМУМ(Периодика.Регистратор) КАК Регистратор,
		|	МАКСИМУМ(Периодика.Период) КАК Период
		|ПОМЕСТИТЬ
		|	ПрошлыеПоступленияПроизводство
		|ИЗ
		|	РегистрНакопления.ПартииПроизводственныхЗатрат.Остатки(&НачалоПериода) КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрНакопления.ПартииПроизводственныхЗатрат КАК Периодика
		|		ПО Периодика.Период < &НачалоПериода
		|		И Периодика.ДокументПоступления = ДД.ДокументПоступления
		|		И Периодика.АналитикаУчетаНоменклатуры.МестоХранения = ДД.АналитикаУчетаНоменклатуры.МестоХранения
		|ГДЕ
		|	ДД.ДокументПоступления <> НЕОПРЕДЕЛЕНО
		|	И Периодика.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|	И Периодика.Количество > 0
		|СГРУППИРОВАТЬ ПО
		|	ДД.ДокументПоступления,
		|	ДД.АналитикаУчетаНоменклатуры.МестоХранения
		|;
		|ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	ДД.Регистратор,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов
		|ПОМЕСТИТЬ
		|	КорректировкиПоступлений
		|ИЗ
		|	РегистрНакопления.ПартииТоваровОрганизаций КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрНакопления.ПартииТоваровОрганизаций КАК Поступления
		|		ПО Поступления.Период <= &ОкончаниеПериода
		|		И Поступления.АналитикаУчетаНоменклатуры = ДД.АналитикаУчетаНоменклатуры
		|		И Поступления.ВидЗапасов = ДД.ВидЗапасов
		|		И Поступления.ДокументПоступления = ДД.ДокументПоступления
		|		И Поступления.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|		И Поступления.Регистратор <> ДД.Регистратор
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И ДД.Первичное
		|	И ДД.Регистратор ССЫЛКА Документ.КорректировкаПриобретения
		|	И ДД.Регистратор <> ДД.ДокументПоступления
		|";
КонецФункции

Функция ЕстьУведомленияОВвозеПрослеживаемыхТоваров() // вт ЕстьУведомленияОВвозе
	Возврат "
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	Остатки.ДокументПоступления КАК Партия,
	|	Остатки.АналитикаУчетаНоменклатуры.Номенклатура КАК Номенклатура,
	|	НАЧАЛОПЕРИОДА(ЗакупкаВСтранахЕАЭС.Дата, МЕСЯЦ) КАК Дата
	|
	|ПОМЕСТИТЬ ОстаткиЗакупкаВСтранахЕАЭС
	|ИЗ
	|	РегистрНакопления.ПартииТоваровОрганизаций.Остатки(&ГраницаКонецПредыдущегоПериода,
	|		Организация В (&МассивОрганизаций)
	|		И ЕСТЬNULL(АналитикаУчетаНоменклатуры.Номенклатура.ПрослеживаемыйТовар, ЛОЖЬ)
	|	) КАК Остатки
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ПриобретениеТоваровУслуг КАК ЗакупкаВСтранахЕАЭС
	|		ПО ЗакупкаВСтранахЕАЭС.Ссылка = Остатки.ДокументПоступления
	|		И ЗакупкаВСтранахЕАЭС.ХозяйственнаяОперация В (
	|			ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ЗакупкаВСтранахЕАЭС),
	|			ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ЗакупкаВСтранахЕАЭСТоварыВПути))
	|ИНДЕКСИРОВАТЬ ПО
	|	Партия
	|;
	|////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	Уведомление.ПервичныйДокумент КАК Партия,
	|	Уведомление.Дата КАК Дата,
	|	УведомлениеТовары.Номенклатура КАК Номенклатура
	|
	|ПОМЕСТИТЬ ЕстьУведомленияОВвозе
	|ИЗ
	|	Документ.УведомлениеОВвозеПрослеживаемыхТоваров КАК Уведомление
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.УведомлениеОВвозеПрослеживаемыхТоваров.Товары КАК УведомлениеТовары
	|		ПО УведомлениеТовары.Ссылка = Уведомление.Ссылка
	|ГДЕ
	|	Уведомление.Дата МЕЖДУ &НачалоПериода И &ОкончаниеПериода 
	|	И Уведомление.Организация В (&МассивОрганизаций)
	|	И Уведомление.Проведен
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	Остатки.Партия КАК Партия,
	|	Уведомление.Дата КАК Дата, 
	|	Остатки.Номенклатура КАК Номенклатура
	|ИЗ
	|	ОстаткиЗакупкаВСтранахЕАЭС КАК Остатки
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.УведомлениеОВвозеПрослеживаемыхТоваров КАК Уведомление
	|		ПО Уведомление.Дата МЕЖДУ Остатки.Дата И &КонецПредыдущегоПериода
	|		И Уведомление.ПервичныйДокумент = Остатки.Партия
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Партия,
	|	Номенклатура
	|";		 
КонецФункции

Функция ТекстОписаниеПартийТоваров()
	Возврат "
		|ВЫБРАТЬ ПЕРВЫЕ 0
		|	ВЫРАЗИТЬ("""" КАК СТРОКА(80)) КАК ЗапросИсточник,
		|	0 КАК Приоритет,
		|	""ХХХХХХХХХХХХХХХХХХХХХХХХ"" КАК ТипЗаписи,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КАК РазделУчета,
		|	ДАТАВРЕМЯ(1, 1, 1, 0, 0, 0) КАК Период,
		|	ДД.Регистратор,
		|	ЗНАЧЕНИЕ(Справочник.Организации.ПустаяСсылка) КАК Организация,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КАК АналитикаУчетаНоменклатуры,
		|	ДД.ДокументПоступления,
		|	ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка) КАК ВидЗапасов,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка) КАК АналитикаУчетаПартий,
		|	0 КАК Знаменатель,
		|	0 КАК Количество,
		|	0 КАК Стоимость,
		|	0 КАК СтоимостьБезНДС,
		|	0 КАК СтоимостьРегл,
		|	0 КАК НДСРегл,
		|	0 КАК ПостояннаяРазница,
		|	0 КАК ВременнаяРазница,
		|	ЛОЖЬ КАК Первичное,
		|	ЛОЖЬ КАК СохранятьРегл,
		|	ДАТАВРЕМЯ(1, 1, 1, 0, 0, 0) КАК ПериодПоступления,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КАК КорАналитикаУчетаНоменклатуры,
		|	ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка) КАК КорВидЗапасов,
		|	ДД.ДокументИсточник,
		|	ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка) КАК Назначение,
		|	ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка) КАК Номенклатура,
		|	ЗНАЧЕНИЕ(Справочник.ХарактеристикиНоменклатуры.ПустаяСсылка) КАК Характеристика,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка) КАК НалогообложениеПартии,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка) КАК НалогообложениеНДС,
		|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПустаяСсылка) КАК ХозяйственнаяОперация,
		|	ДД.СтатьяРасходовСписания,
		|	ДД.АналитикаРасходов,
		|	ДД.АналитикаАктивовПассивов,
		|	ДД.СтатьяСписанияНДС,
		|	ДД.АналитикаСписанияНДС
		|//ВоВременнуюТаблицу ПОМЕСТИТЬ ИсходныеДанные
		|ИЗ
		|	РегистрНакопления.ПартииТоваровОрганизаций КАК ДД
		|";
КонецФункции

// КОНТУР ПартииТоваровОрганизаций
Функция ТекстОстаткиПартийТоваров() // использует ПрошлыеПоступления, ЕстьУведомленияОВвозе
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстОстаткиПартийТоваров"" КАК ЗапросИсточник,
		|	10 КАК Приоритет,
		|	""Остаток"" КАК ТипЗаписи,
		|	ИСТИНА КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
		|	ЕСТЬNULL(Периодика.РазделУчета, ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыНаСкладах)) КАК РазделУчета,
		|	ЕСТЬNULL(Периодика.Период, &НачалоПериода) КАК Период,
		|	ДД.ДокументПоступления КАК Регистратор,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ДокументПоступления,
		|	ДД.ВидЗапасов,
		|	ДД.АналитикаУчетаПартий,
		|	0 КАК Знаменатель,
		|	ДД.КоличествоОстаток КАК Количество,
		|	ДД.СтоимостьОстаток КАК Стоимость,
		|	ДД.СтоимостьБезНДСОстаток КАК СтоимостьБезНДС,
		|	ДД.СтоимостьРеглОстаток КАК СтоимостьРегл,
		|	ДД.НДСРеглОстаток КАК НДСРегл,
		|	ДД.ПостояннаяРазницаОстаток КАК ПостояннаяРазница,
		|	ДД.ВременнаяРазницаОстаток КАК ВременнаяРазница,
		|	ИСТИНА КАК Первичное,
		|	ИСТИНА КАК СохранятьРегл,
		|	(ВЫБОР
		|		КОГДА НЕ ЕстьУведомленияОВвозе.Дата ЕСТЬ NULL ТОГДА ЕстьУведомленияОВвозе.Дата
		|		ИНАЧЕ Периодика.Период КОНЕЦ) КАК ПериодПоступления,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КАК КорАналитикаУчетаНоменклатуры,
		|	ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка) КАК КорВидЗапасов,
		|	НЕОПРЕДЕЛЕНО КАК ДокументИсточник,
		|	ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка) КАК Назначение,
		|	ДД.АналитикаУчетаНоменклатуры.Номенклатура КАК Номенклатура,
		|	ДД.АналитикаУчетаНоменклатуры.Характеристика КАК Характеристика,
		|	ДД.АналитикаУчетаПартий.НалогообложениеНДС КАК НалогообложениеПартии,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка) КАК НалогообложениеНДС,
		|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПустаяСсылка) КАК ХозяйственнаяОперация,
		|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) КАК СтатьяРасходовСписания,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивовПассивов,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаСписанияНДС
		|ИЗ
		|	РегистрНакопления.ПартииТоваровОрганизаций.Остатки(&НачалоПериода, Организация В (&МассивОрганизаций)) КАК ДД
		|	ЛЕВОЕ СОЕДИНЕНИЕ ПрошлыеПоступления КАК Периодика
		|		ПО Периодика.Ссылка = ДД.ДокументПоступления
		|
		|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.ПриобретениеТоваровУслуг КАК ЗакупкаВСтранахЕАЭС
		|		ПО ЗакупкаВСтранахЕАЭС.Ссылка = ДД.ДокументПоступления
		|		И ЗакупкаВСтранахЕАЭС.ХозяйственнаяОперация В (
		|			ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ЗакупкаВСтранахЕАЭС),
		|			ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ЗакупкаВСтранахЕАЭСТоварыВПути))
		|	ЛЕВОЕ СОЕДИНЕНИЕ ЕстьУведомленияОВвозе КАК ЕстьУведомленияОВвозе
		|		ПО ЕстьУведомленияОВвозе.Партия = ДД.ДокументПоступления
		|		И ЕстьУведомленияОВвозе.Номенклатура = ДД.АналитикаУчетаНоменклатуры.Номенклатура
		|ГДЕ
		|	ДД.КоличествоОстаток > 0
		|	И НЕ (НЕ ЗакупкаВСтранахЕАЭС.Ссылка ЕСТЬ NULL
		|		 И ЕСТЬNULL(ДД.АналитикаУчетаНоменклатуры.Номенклатура.ПрослеживаемыйТовар, ЛОЖЬ)
		|		 И ЕстьУведомленияОВвозе.Номенклатура ЕСТЬ NULL)
		|";
КонецФункции

Функция ТекстПервичныеПартииТоваров() // использует КорректировкиПоступлений, ЕстьУведомленияОВвозе
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстПервичныеПартииТоваров"" КАК ЗапросИсточник,
		|	(ВЫБОР
		|		КОГДА НЕ Корректировка.Регистратор ЕСТЬ NULL ТОГДА 15
		|		ИНАЧЕ 10 КОНЕЦ) КАК Приоритет,
		|	(ВЫБОР
		|		КОГДА ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) И ДД.Количество < 0 ТОГДА ""Сторно""
		|		КОГДА НЕ Корректировка.Регистратор ЕСТЬ NULL ТОГДА ""Корректировка""
		|		КОГДА ДД.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ЗакупкаПоИмпорту) ТОГДА ""Импорт""
		|		ИНАЧЕ ""Партия"" КОНЕЦ) КАК ТипЗаписи,
		|	(ВЫБОР
		|		КОГДА НЕ Корректировка.Регистратор ЕСТЬ NULL ТОГДА ЛОЖЬ
		// Приобретение товаров (ввоз из ЕАЭС) для прослеживаемых товаров без уведомления о ввозе не должно быть источником для подбора партий.
		|		КОГДА НЕ ЗакупкаВСтранахЕАЭС.Ссылка ЕСТЬ NULL
		|		 И ЕСТЬNULL(ДД.АналитикаУчетаНоменклатуры.Номенклатура.ПрослеживаемыйТовар, ЛОЖЬ)
		|		 И ЕстьУведомленияОВвозе.Номенклатура ЕСТЬ NULL
		|   		ТОГДА ЛОЖЬ
		|		ИНАЧЕ ИСТИНА КОНЕЦ) КАК РасчетЗавершен,
		|	ДД.ВидДвижения КАК ВидДвижения,
		|	(ВЫБОР
		|		КОГДА ДД.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ЗакупкаПоИмпорту)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка)
		|		КОГДА ДД.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВозвратТоваровОтКлиента)
		|		 И ДД.ВидЗапасов.РеализацияЗапасовДругойОрганизации
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка)
		|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыНаСкладах) КОНЕЦ) КАК РазделУчета,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ДокументПоступления,
		|	ДД.ВидЗапасов,
		|	ДД.АналитикаУчетаПартий,
		|	0 КАК Знаменатель,
		|	СУММА(ДД.Количество) КАК Количество,
		|	СУММА(ДД.Стоимость) КАК Стоимость,
		|	СУММА(ДД.СтоимостьБезНДС) КАК СтоимостьБезНДС,
		|	СУММА(ДД.СтоимостьРегл) КАК СтоимостьРегл,
		|	СУММА(ДД.НДСРегл) КАК НДСРегл,
		|	СУММА(ДД.ПостояннаяРазница) КАК ПостояннаяРазница,
		|	СУММА(ДД.ВременнаяРазница) КАК ВременнаяРазница,
		|	ДД.Первичное,
		|	ЛОЖЬ КАК СохранятьРегл,
		|	(ВЫБОР
		|		КОГДА НЕ Корректировка.Регистратор ЕСТЬ NULL
		|		 И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) ТОГДА ДОБАВИТЬКДАТЕ(&НачалоПериода, СЕКУНДА, -1)
		|		КОГДА НЕ ЕстьУведомленияОВвозе.Дата ЕСТЬ NULL ТОГДА ЕстьУведомленияОВвозе.Дата
		|		ИНАЧЕ ДД.Период КОНЕЦ) КАК ПериодПоступления,
		|	ДД.КорАналитикаУчетаНоменклатуры,
		|	ДД.КорВидЗапасов,
		|	ДД.ДокументИсточник,
		|	ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка) КАК Назначение,
		|	ДД.Номенклатура,
		|	ДД.Характеристика,
		|	АналитикиПартий.НалогообложениеНДС КАК НалогообложениеПартии,
		|	ДД.НалогообложениеНДС,
		|	ДД.ХозяйственнаяОперация,
		|	ДД.СтатьяРасходовСписания,
		|	ДД.АналитикаРасходов,
		|	ДД.АналитикаАктивовПассивов,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаСписанияНДС
		|ИЗ
		|	РегистрНакопления.ПартииТоваровОрганизаций КАК ДД
		|	ЛЕВОЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаПартий КАК АналитикиПартий
		|		ПО АналитикиПартий.Ссылка = ДД.АналитикаУчетаПартий
		|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.ПриобретениеТоваровУслуг КАК Поступление
		|		ПО Поступление.Ссылка = ДД.ДокументПоступления
		|	ЛЕВОЕ СОЕДИНЕНИЕ КорректировкиПоступлений КАК Корректировка
		|		ПО Корректировка.Регистратор = ДД.Регистратор
		|		И Корректировка.АналитикаУчетаНоменклатуры = ДД.АналитикаУчетаНоменклатуры
		|		И Корректировка.ВидЗапасов = ДД.ВидЗапасов
		|
		|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.ПриобретениеТоваровУслуг КАК ЗакупкаВСтранахЕАЭС
		|		ПО ЗакупкаВСтранахЕАЭС.Ссылка = ДД.Регистратор
		|		И ЗакупкаВСтранахЕАЭС.ХозяйственнаяОперация В (
		|			ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ЗакупкаВСтранахЕАЭС),
		|			ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ЗакупкаВСтранахЕАЭСТоварыВПути))
		|	ЛЕВОЕ СОЕДИНЕНИЕ ЕстьУведомленияОВвозе КАК ЕстьУведомленияОВвозе
		|		ПО ЕстьУведомленияОВвозе.Партия = ДД.Регистратор
		|		И ЕстьУведомленияОВвозе.Номенклатура = ДД.АналитикаУчетаНоменклатуры.Номенклатура
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И ДД.Первичное
		|	И (ДД.ДокументИсточник = НЕОПРЕДЕЛЕНО
		|		ИЛИ НЕ Корректировка.Регистратор ЕСТЬ NULL)
		|	И НЕ ДД.Регистратор ССЫЛКА Документ.КорректировкаРеализации
		|СГРУППИРОВАТЬ ПО
		|	(ВЫБОР
		|		КОГДА НЕ Корректировка.Регистратор ЕСТЬ NULL ТОГДА 15
		|		ИНАЧЕ 10 КОНЕЦ),
		|	(ВЫБОР
		|		КОГДА ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) И ДД.Количество < 0 ТОГДА ""Сторно""
		|		КОГДА НЕ Корректировка.Регистратор ЕСТЬ NULL ТОГДА ""Корректировка""
		|		КОГДА ДД.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ЗакупкаПоИмпорту) ТОГДА ""Импорт""
		|		ИНАЧЕ ""Партия"" КОНЕЦ),
		|	(ВЫБОР
		|		КОГДА НЕ Корректировка.Регистратор ЕСТЬ NULL ТОГДА ЛОЖЬ
		|		КОГДА НЕ ЗакупкаВСтранахЕАЭС.Ссылка ЕСТЬ NULL
		|		 И ЕСТЬNULL(ДД.АналитикаУчетаНоменклатуры.Номенклатура.ПрослеживаемыйТовар, ЛОЖЬ)
		|		 И ЕстьУведомленияОВвозе.Номенклатура ЕСТЬ NULL
		|   		ТОГДА ЛОЖЬ
		|		ИНАЧЕ ИСТИНА КОНЕЦ), // РасчетЗавершен
		|	ДД.ВидДвижения,
		|	(ВЫБОР
		|		КОГДА ДД.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ЗакупкаПоИмпорту)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка)
		|		КОГДА ДД.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВозвратТоваровОтКлиента)
		|		 И ДД.ВидЗапасов.РеализацияЗапасовДругойОрганизации
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка)
		|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыНаСкладах) КОНЕЦ),
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ДокументПоступления,
		|	ДД.ВидЗапасов,
		|	ДД.АналитикаУчетаПартий,
		|	ДД.Первичное,
		|	(ВЫБОР
		|		КОГДА НЕ Корректировка.Регистратор ЕСТЬ NULL
		|		 И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) ТОГДА ДОБАВИТЬКДАТЕ(&НачалоПериода, СЕКУНДА, -1)
		|		КОГДА НЕ ЕстьУведомленияОВвозе.Дата ЕСТЬ NULL ТОГДА ЕстьУведомленияОВвозе.Дата
		|		ИНАЧЕ ДД.Период КОНЕЦ), // ПериодПоступления
		|	ДД.КорАналитикаУчетаНоменклатуры,
		|	ДД.КорВидЗапасов,
		|	ДД.ДокументИсточник,
		|	ДД.Номенклатура,
		|	ДД.Характеристика,
		|	АналитикиПартий.НалогообложениеНДС,
		|	ДД.НалогообложениеНДС,
		|	ДД.ХозяйственнаяОперация,
		|	ДД.СтатьяРасходовСписания,
		|	ДД.АналитикаРасходов,
		|	ДД.АналитикаАктивовПассивов
		|";
КонецФункции

Функция ТекстПервичныеПеремещенияТоваров()
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстПервичныеПеремещенияТоваров"" КАК ЗапросИсточник,
		|	10 КАК Приоритет,
		|	(ВЫБОР
		|		КОГДА НЕ Возврат.Ссылка ЕСТЬ NULL ТОГДА ""Сторно""
		|		КОГДА Сборка.Ссылка ЕСТЬ NULL И ПередачаКомиссия.Ссылка ЕСТЬ NULL ТОГДА ""Перемещение"" 
		|		ИНАЧЕ ""Партия"" КОНЕЦ) КАК ТипЗаписи,
		|	(ВЫБОР
		|		КОГДА Сборка.Ссылка ЕСТЬ NULL И ПередачаКомиссия.Ссылка ЕСТЬ NULL ТОГДА ЛОЖЬ
		|		ИНАЧЕ ИСТИНА КОНЕЦ) КАК РасчетЗавершен,
		|	ДД.ВидДвижения КАК ВидДвижения,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыНаСкладах) КАК РазделУчета,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ДокументПоступления,
		|	ДД.ВидЗапасов,
		|	ДД.АналитикаУчетаПартий,
		|	0 КАК Знаменатель,
		|	СУММА(ДД.Количество) КАК Количество,
		|	0 КАК Стоимость,
		|	0 КАК СтоимостьБезНДС,
		|	СУММА(ВЫБОР КОГДА Передача.Ссылка ЕСТЬ NULL И Возврат.Ссылка ЕСТЬ NULL ТОГДА 0 ИНАЧЕ ДД.СтоимостьРегл КОНЕЦ) КАК СтоимостьРегл,
		|	СУММА(ВЫБОР КОГДА Передача.Ссылка ЕСТЬ NULL И Возврат.Ссылка ЕСТЬ NULL ТОГДА 0 ИНАЧЕ ДД.НДСРегл КОНЕЦ) КАК НДСРегл,
		|	СУММА(ВЫБОР КОГДА Передача.Ссылка ЕСТЬ NULL И Возврат.Ссылка ЕСТЬ NULL ТОГДА 0 ИНАЧЕ ДД.ПостояннаяРазница КОНЕЦ) КАК ПостояннаяРазница,
		|	СУММА(ВЫБОР КОГДА Передача.Ссылка ЕСТЬ NULL И Возврат.Ссылка ЕСТЬ NULL ТОГДА 0 ИНАЧЕ ДД.ВременнаяРазница КОНЕЦ) КАК ВременнаяРазница,
		|	ДД.Первичное,
		|	(ВЫБОР КОГДА Передача.Ссылка ЕСТЬ NULL И Возврат.Ссылка ЕСТЬ NULL ТОГДА ЛОЖЬ ИНАЧЕ ИСТИНА КОНЕЦ) КАК СохранятьРегл,
		|	ДД.Период КАК ПериодПоступления,
		|	ДД.КорАналитикаУчетаНоменклатуры,
		|	ДД.КорВидЗапасов,
		|	ДД.ДокументИсточник,
		|	ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка) КАК Назначение,
		|	ДД.Номенклатура,
		|	ДД.Характеристика,
		|	ДД.АналитикаУчетаПартий.НалогообложениеНДС КАК НалогообложениеПартии,
		|	ДД.НалогообложениеНДС,
		|	ДД.ХозяйственнаяОперация,
		|	ДД.СтатьяРасходовСписания,
		|	ДД.АналитикаРасходов,
		|	ДД.АналитикаАктивовПассивов,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаСписанияНДС
		|ИЗ
		|	РегистрНакопления.ПартииТоваровОрганизаций КАК ДД
		|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.СборкаТоваров КАК Сборка
		|		ПО Сборка.Дата = ДД.Период
		|		И Сборка.Ссылка = ДД.Регистратор
		|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.ПередачаТоваровМеждуОрганизациями КАК Передача
		|		ПО Передача.Дата = ДД.Период
		|		И Передача.Ссылка = ДД.Регистратор
		|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.ПередачаТоваровМеждуОрганизациями КАК ПередачаКомиссия
		|		ПО ПередачаКомиссия.Дата = ДД.Период
		|		И ПередачаКомиссия.Ссылка = ДД.Регистратор
		|		И ПередачаКомиссия.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПередачаНаКомиссиюВДругуюОрганизацию)
		|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.ВозвратТоваровМеждуОрганизациями КАК Возврат
		|		ПО Возврат.Дата = ДД.Период
		|		И Возврат.Ссылка = ДД.Регистратор
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И ДД.Регистратор = ДД.ДокументПоступления
		|	И ДД.Первичное
		|	И ДД.ДокументИсточник <> НЕОПРЕДЕЛЕНО
		|	И НЕ ДД.Регистратор ССЫЛКА Документ.ПересортицаТоваров
		|СГРУППИРОВАТЬ ПО
		|	(ВЫБОР
		|		КОГДА НЕ Возврат.Ссылка ЕСТЬ NULL ТОГДА ""Сторно""
		|		КОГДА Сборка.Ссылка ЕСТЬ NULL И ПередачаКомиссия.Ссылка ЕСТЬ NULL ТОГДА ""Перемещение"" 
		|		ИНАЧЕ ""Партия"" КОНЕЦ),
		|	(ВЫБОР
		|		КОГДА Сборка.Ссылка ЕСТЬ NULL И ПередачаКомиссия.Ссылка ЕСТЬ NULL ТОГДА ЛОЖЬ
		|		ИНАЧЕ ИСТИНА КОНЕЦ),
		|	ДД.ВидДвижения,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ДокументПоступления,
		|	ДД.ВидЗапасов,
		|	ДД.АналитикаУчетаПартий,
		|	ДД.Первичное,
		|	(ВЫБОР КОГДА Передача.Ссылка ЕСТЬ NULL И Возврат.Ссылка ЕСТЬ NULL ТОГДА ЛОЖЬ ИНАЧЕ ИСТИНА КОНЕЦ),
		|	ДД.КорАналитикаУчетаНоменклатуры,
		|	ДД.КорВидЗапасов,
		|	ДД.ДокументИсточник,
		|	ДД.Номенклатура,
		|	ДД.Характеристика,
		|	ДД.АналитикаУчетаПартий.НалогообложениеНДС,
		|	ДД.НалогообложениеНДС,
		|	ДД.ХозяйственнаяОперация,
		|	ДД.СтатьяРасходовСписания,
		|	ДД.АналитикаРасходов,
		|	ДД.АналитикаАктивовПассивов
		|";
КонецФункции

Функция ТекстРеализацииПрошлыхМесяцев()
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстРеализацииПрошлыхМесяцев"" КАК ЗапросИсточник,
		|	10 КАК Приоритет,
		|	""Прошлое"" КАК ТипЗаписи,
		|	ИСТИНА КАК РасчетЗавершен,
		|	ДД.ВидДвижения КАК ВидДвижения,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыНаСкладах) КАК РазделУчета,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ДокументПоступления,
		|	ДД.ВидЗапасов,
		|	ДД.АналитикаУчетаПартий,
		|	0 КАК Знаменатель,
		|	СУММА(ДД.Количество) КАК Количество,
		|	СУММА(ДД.Стоимость) КАК Стоимость,
		|	СУММА(ДД.СтоимостьБезНДС) КАК СтоимостьБезНДС,
		|	СУММА(ДД.СтоимостьРегл) КАК СтоимостьРегл,
		|	СУММА(ДД.НДСРегл) КАК НДСРегл,
		|	СУММА(ДД.ПостояннаяРазница) КАК ПостояннаяРазница,
		|	СУММА(ДД.ВременнаяРазница) КАК ВременнаяРазница,
		|	ДД.Первичное,
		|	ИСТИНА КАК СохранятьРегл,
		|	ДД.Период КАК ПериодПоступления,
		|	ДД.АналитикаУчетаНоменклатуры КАК КорАналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов КАК КорВидЗапасов,
		|	ДД.Регистратор КАК ДокументИсточник,
		|	ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка) КАК Назначение,
		|	ДД.Номенклатура,
		|	ДД.Характеристика,
		|	ДД.АналитикаУчетаПартий.НалогообложениеНДС КАК НалогообложениеПартии,
		|	ДД.НалогообложениеНДС,
		|	ДД.ХозяйственнаяОперация,
		|	ДД.СтатьяРасходовСписания,
		|	ДД.АналитикаРасходов,
		|	ДД.АналитикаАктивовПассивов,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаСписанияНДС
		|ИЗ
		|	РегистрНакопления.ПартииТоваровОрганизаций КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ПрошлыеРеализации КАК Прошлые
		|		ПО ДД.Регистратор = Прошлые.ДокументРеализации
		|		И ДД.АналитикаУчетаНоменклатуры = Прошлые.АналитикаУчетаНоменклатуры
		|		И ДД.ВидЗапасов = Прошлые.ВидЗапасов
		|ГДЕ
		|	ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|СГРУППИРОВАТЬ ПО
		|	ДД.ВидДвижения,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ДокументПоступления,
		|	ДД.ВидЗапасов,
		|	ДД.АналитикаУчетаПартий,
		|	ДД.Первичное,
		|	ДД.Номенклатура,
		|	ДД.Характеристика,
		|	ДД.НалогообложениеНДС,
		|	ДД.ХозяйственнаяОперация,
		|	ДД.СтатьяРасходовСписания,
		|	ДД.АналитикаРасходов,
		|	ДД.АналитикаАктивовПассивов
		|";
КонецФункции

// КОНТУР ТоварыОрганизаций
Функция ТекстПотребленияТоваров()
	// Потребления товаров - реализации, возвраты, расходы перемещений и передач - без расходов чужих видов запасов.
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстПотребленияТоваров"" КАК ЗапросИсточник,
		|	(ВЫБОР КОГДА ДД.Количество > 0 ТОГДА 90 ИНАЧЕ 10 КОНЕЦ) КАК Приоритет,
		|	(ВЫБОР
		|		КОГДА НЕ Разборка.Ссылка ЕСТЬ NULL ТОГДА ""Материал""
		|		КОГДА ДД.Количество > 0 ТОГДА ""Потребление""
		|		ИНАЧЕ ""Сторно"" КОНЕЦ) КАК ТипЗаписи,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ДД.ВидДвижения,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыНаСкладах) КАК РазделУчета,
		|	ДД.Период,
		|	ДД.Регистратор, 
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	(ВЫБОР
		|		КОГДА ДД.Регистратор ССЫЛКА Документ.ВозвратТоваровПоставщику ТОГДА ДД.ДокументРеализации
		|		ИНАЧЕ НЕОПРЕДЕЛЕНО КОНЕЦ) КАК ДокументПоступления,
		|	ДД.ВидЗапасов,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка) КАК АналитикаУчетаПартий,
		|	0 КАК Знаменатель,
		|	СУММА(ДД.Количество) КАК Количество,
		|	0 КАК Стоимость,
		|	0 КАК СтоимостьБезНДС,
		|	0 КАК СтоимостьРегл,
		|	0 КАК НДСРегл,
		|	0 КАК ПостояннаяРазница,
		|	0 КАК ВременнаяРазница,
		|	ЛОЖЬ КАК Первичное,
		|	ЛОЖЬ КАК СохранятьРегл,
		|	ДД.Период КАК ПериодПоступления,
		|	(ВЫБОР
		|		КОГДА ДД.Регистратор ССЫЛКА Документ.ПеремещениеТоваров ТОГДА ДД.КорАналитикаУчетаНоменклатуры
		|		КОГДА ДД.Регистратор ССЫЛКА Документ.ИсправлениеРазвернутогоСальдоТоваровОрганизаций ТОГДА ДД.КорАналитикаУчетаНоменклатуры
		|		КОГДА ДД.Регистратор ССЫЛКА Документ.ПередачаТоваровМеждуОрганизациями ТОГДА ДД.КорАналитикаУчетаНоменклатуры
		|		КОГДА ДД.Регистратор ССЫЛКА Документ.РеализацияТоваровУслуг ТОГДА ДД.КорАналитикаУчетаНоменклатуры
		|		КОГДА ДД.Регистратор ССЫЛКА Документ.КорректировкаОбособленногоУчетаЗапасов ТОГДА ДД.КорАналитикаУчетаНоменклатуры
		|		КОГДА СпрВидыЗапасов.ТипЗапасов <> ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.КомиссионныйТовар)
		|			И ДД.КорАналитикаУчетаНоменклатуры <> ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка)
		|			ТОГДА ДД.КорАналитикаУчетаНоменклатуры
		|		КОГДА ДД.Количество < 0 ТОГДА ДД.АналитикаУчетаНоменклатуры
		|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КОНЕЦ) КАК КорАналитикаУчетаНоменклатуры,
		|	(ВЫБОР
		|		КОГДА ДД.КорВидЗапасов = ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка)
		|			И ДД.КорАналитикаУчетаНоменклатуры <> ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка)
		|			ТОГДА ДД.ВидЗапасов
		|		КОГДА ДД.Количество < 0 И ДД.КорВидЗапасов = ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка) ТОГДА ДД.ВидЗапасов
		|		ИНАЧЕ ДД.КорВидЗапасов КОНЕЦ) КАК КорВидЗапасов,
		|	(ВЫБОР
		|		КОГДА ДД.Количество > 0 ТОГДА НЕОПРЕДЕЛЕНО
		|		КОГДА ДД.Количество < 0 И ДД.Регистратор ССЫЛКА Документ.ОтчетОРозничныхПродажах ТОГДА ДД.Регистратор
		|		ИНАЧЕ ДД.ДокументРеализации КОНЕЦ) КАК ДокументИсточник,
		|	ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка) КАК Назначение,
		|	ДД.Номенклатура,
		|	ДД.Характеристика,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка) КАК НалогообложениеПартии,
		|	ДД.НалогообложениеНДС,
		|	ДД.ХозяйственнаяОперация,
		|	ДД.СтатьяРасходов КАК СтатьяРасходовСписания,
		|	ДД.АналитикаРасходов,
		|	ДД.АналитикаАктивовПассивов,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаСписанияНДС
		|ИЗ
		|	РегистрНакопления.ТоварыОрганизаций КАК ДД
		|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.СборкаТоваров КАК Разборка
		|		ПО Разборка.Дата = ДД.Период
		|		И Разборка.Ссылка = ДД.Регистратор
		|		И Разборка.АналитикаУчетаНоменклатуры = ДД.АналитикаУчетаНоменклатуры
		//++ НЕ УТ
		|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.ПередачаСырьяПереработчику КАК ПередачаПереработчику
		|		ПО ПередачаПереработчику.Дата = ДД.Период
		|		И ПередачаПереработчику.Ссылка = ДД.Регистратор
		//-- НЕ УТ
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ВидыЗапасов КАК СпрВидыЗапасов
		|		ПО СпрВидыЗапасов.Ссылка = ДД.ВидЗапасов
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И (ДД.Организация = ДД.ОрганизацияОтгрузки
		|		ИЛИ ДД.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВозвратТоваровМеждуОрганизациями))
		|	И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		|	И (ДД.Количество > 0
		|		ИЛИ ДД.ДокументРеализации <> НЕОПРЕДЕЛЕНО
		|		ИЛИ ДД.Регистратор ССЫЛКА Документ.ОтчетОРозничныхПродажах)
		|	И ДД.ХозяйственнаяОперация <> ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВозвратОтКомиссионера)
		|	И НЕ ДД.Регистратор ССЫЛКА Документ.КорректировкаПриобретения
		//++ НЕ УТ
		|	И НЕ (ЕСТЬNULL(ПередачаПереработчику.ВернутьМногооборотнуюТару, ЛОЖЬ)
		|		И ДД.АналитикаУчетаНоменклатуры.Номенклатура.ТипНоменклатуры = ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.МногооборотнаяТара))
		//-- НЕ УТ

		// сворачиваем строки, различающиеся номерами ГТД
		|СГРУППИРОВАТЬ ПО
		|	(ВЫБОР КОГДА ДД.Количество > 0 ТОГДА 90 ИНАЧЕ 10 КОНЕЦ),
		|	(ВЫБОР
		|		КОГДА НЕ Разборка.Ссылка ЕСТЬ NULL ТОГДА ""Материал""
		|		КОГДА ДД.Количество > 0 ТОГДА ""Потребление""
		|		ИНАЧЕ ""Сторно"" КОНЕЦ),
		|	ДД.ВидДвижения,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	(ВЫБОР
		|		КОГДА ДД.Регистратор ССЫЛКА Документ.ВозвратТоваровПоставщику ТОГДА ДД.ДокументРеализации
		|		ИНАЧЕ НЕОПРЕДЕЛЕНО КОНЕЦ),
		|	ДД.ВидЗапасов,
		|	ЕСТЬNULL(Разборка.Количество, 0),
		|	(ВЫБОР
		|		КОГДА ДД.Регистратор ССЫЛКА Документ.ПеремещениеТоваров ТОГДА ДД.КорАналитикаУчетаНоменклатуры
		|		КОГДА ДД.Регистратор ССЫЛКА Документ.ИсправлениеРазвернутогоСальдоТоваровОрганизаций ТОГДА ДД.КорАналитикаУчетаНоменклатуры
		|		КОГДА ДД.Регистратор ССЫЛКА Документ.ПередачаТоваровМеждуОрганизациями ТОГДА ДД.КорАналитикаУчетаНоменклатуры
		|		КОГДА ДД.Регистратор ССЫЛКА Документ.РеализацияТоваровУслуг ТОГДА ДД.КорАналитикаУчетаНоменклатуры
		|		КОГДА ДД.Регистратор ССЫЛКА Документ.КорректировкаОбособленногоУчетаЗапасов ТОГДА ДД.КорАналитикаУчетаНоменклатуры
		|		КОГДА СпрВидыЗапасов.ТипЗапасов <> ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.КомиссионныйТовар)
		|			И ДД.КорАналитикаУчетаНоменклатуры <> ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка)
		|			ТОГДА ДД.КорАналитикаУчетаНоменклатуры
		|		КОГДА ДД.Количество < 0 ТОГДА ДД.АналитикаУчетаНоменклатуры
		|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КОНЕЦ),
		|	(ВЫБОР
		|		КОГДА ДД.КорВидЗапасов = ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка)
		|			И ДД.КорАналитикаУчетаНоменклатуры <> ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка)
		|			ТОГДА ДД.ВидЗапасов
		|		КОГДА ДД.Количество < 0 И ДД.КорВидЗапасов = ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка) ТОГДА ДД.ВидЗапасов
		|		ИНАЧЕ ДД.КорВидЗапасов КОНЕЦ),
		|	(ВЫБОР
		|		КОГДА ДД.Количество > 0 ТОГДА НЕОПРЕДЕЛЕНО
		|		КОГДА ДД.Количество < 0 И ДД.Регистратор ССЫЛКА Документ.ОтчетОРозничныхПродажах ТОГДА ДД.Регистратор
		|		ИНАЧЕ ДД.ДокументРеализации КОНЕЦ),
		|	ДД.Номенклатура,
		|	ДД.Характеристика,
		|	ДД.НалогообложениеНДС,
		|	ДД.ХозяйственнаяОперация,
		|	ДД.СтатьяРасходов,
		|	ДД.АналитикаРасходов,
		|	ДД.АналитикаАктивовПассивов
		|";
КонецФункции

Функция ТекстСписанияКомиссионныхТоваров()
	// списание товаров, полученных на комиссию, по аналитике номенклатуры у комитента
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстСписанияКомиссионныхТоваров"" КАК ЗапросИсточник,
		|	90 КАК Приоритет,
		|	(ВЫБОР КОГДА ДД.КоличествоСписано > 0 ТОГДА ""Потребление""
		|		ИНАЧЕ ""Сторно"" КОНЕЦ) КАК ТипЗаписи,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) КАК ВидДвижения,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыНаСкладах) КАК РазделУчета,
		|	ДД.Период,
		|	ДД.Регистратор, 
		|	ДД.ВидЗапасов.Организация КАК Организация,
		|	ДД.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
		|	НЕОПРЕДЕЛЕНО КАК ДокументПоступления,
		|	ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка) КАК ВидЗапасов,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка) КАК АналитикаУчетаПартий,
		|	0 КАК Знаменатель,
		|	СУММА(ДД.КоличествоСписано) / КОЛИЧЕСТВО(РАЗЛИЧНЫЕ ДД.НомерСтроки) КАК Количество,
		|	0 КАК Стоимость,
		|	0 КАК СтоимостьБезНДС,
		|	0 КАК СтоимостьРегл,
		|	0 КАК НДСРегл,
		|	0 КАК ПостояннаяРазница,
		|	0 КАК ВременнаяРазница,
		|	ЛОЖЬ КАК Первичное,
		|	ЛОЖЬ КАК СохранятьРегл,
		|	ДД.Период КАК ПериодПоступления,
		|	(ВЫБОР КОГДА ДД.КоличествоСписано > 0 ТОГДА ДД.КорАналитикаУчетаНоменклатуры
		|		ИНАЧЕ ДД.АналитикаУчетаНоменклатуры КОНЕЦ) КАК КорАналитикаУчетаНоменклатуры,
		|	(ВЫБОР КОГДА ДД.КоличествоСписано > 0 ТОГДА ДД.КорВидЗапасов
		|		ИНАЧЕ ДД.КорВидЗапасов КОНЕЦ) КАК КорВидЗапасов,
		|	ТоварыОрганизаций.ДокументРеализации КАК ДокументИсточник,
		|	ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка) КАК Назначение,
		|	ДД.Номенклатура,
		|	ДД.Характеристика,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка) КАК НалогообложениеПартии,
		|	ТоварыОрганизаций.НалогообложениеНДС,
		|	ДД.ХозяйственнаяОперация,
		|	ТоварыОрганизаций.СтатьяРасходов КАК СтатьяРасходовСписания,
		|	ТоварыОрганизаций.АналитикаРасходов,
		|	ТоварыОрганизаций.АналитикаАктивовПассивов,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаСписанияНДС
		|ИЗ
		|	РегистрНакопления.ТоварыКОформлениюОтчетовКомитенту КАК ДД
		|	ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ТоварыОрганизаций КАК ТоварыОрганизаций
		|		ПО ТоварыОрганизаций.Регистратор = ДД.Регистратор
		|		И ТоварыОрганизаций.Период = ДД.Период
		|		И ТоварыОрганизаций.КорАналитикаУчетаНоменклатуры = ДД.АналитикаУчетаНоменклатуры
		|		И ТоварыОрганизаций.ВидЗапасов = ДД.ВидЗапасов
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.ВидЗапасов.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|	И ДД.КоличествоСписано <> 0
		// сворачиваем строки, различающиеся номерами ГТД
		|СГРУППИРОВАТЬ ПО
		|	(ВЫБОР КОГДА ДД.КоличествоСписано > 0 ТОГДА ""Потребление""
		|		ИНАЧЕ ""Сторно"" КОНЕЦ),
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.ВидЗапасов.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.КорВидЗапасов,
		|	(ВЫБОР КОГДА ДД.КоличествоСписано > 0 ТОГДА ДД.КорАналитикаУчетаНоменклатуры
		|		ИНАЧЕ ДД.АналитикаУчетаНоменклатуры КОНЕЦ),
		|	(ВЫБОР КОГДА ДД.КоличествоСписано > 0 ТОГДА ДД.КорВидЗапасов
		|		ИНАЧЕ ДД.КорВидЗапасов КОНЕЦ),
		|	ТоварыОрганизаций.ДокументРеализации,
		|	ДД.Номенклатура,
		|	ДД.Характеристика,
		|	ТоварыОрганизаций.НалогообложениеНДС,
		|	ДД.ХозяйственнаяОперация,
		|	ТоварыОрганизаций.СтатьяРасходов,
		|	ТоварыОрганизаций.АналитикаРасходов,
		|	ТоварыОрганизаций.АналитикаАктивовПассивов
		|";
КонецФункции

Функция ТекстПриходыПеремещений()
	// Приходы перемещений, передач, пересортиц по ценам списания, порч по ценам списания.
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстПриходыПеремещений"" КАК ЗапросИсточник,
		|	90 КАК Приоритет,
		|	""Перемещение"" КАК ТипЗаписи,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ДД.ВидДвижения,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыНаСкладах) КАК РазделУчета,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	(ВЫБОР ДД.ХозяйственнаяОперация
		|		КОГДА ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПересортицаТоваров) ТОГДА ДД.Регистратор
		|		ИНАЧЕ НЕОПРЕДЕЛЕНО КОНЕЦ) КАК ДокументПоступления,
		|	ДД.ВидЗапасов,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка) КАК АналитикаУчетаПартий,
		|	0 КАК Знаменатель,
		|	СУММА(ДД.Количество) КАК Количество,
		|	0 КАК Стоимость,
		|	0 КАК СтоимостьБезНДС,
		|	0 КАК СтоимостьРегл,
		|	0 КАК НДСРегл,
		|	0 КАК ПостояннаяРазница,
		|	0 КАК ВременнаяРазница,
		|	ЛОЖЬ КАК Первичное,
		|	ЛОЖЬ КАК СохранятьРегл,
		|	ДД.Период КАК ПериодПоступления,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КАК КорАналитикаУчетаНоменклатуры,
		|	ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка) КАК КорВидЗапасов,
		|	ДД.Регистратор КАК ДокументИсточник,
		|	ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка) КАК Назначение,
		|	ДД.Номенклатура,
		|	ДД.Характеристика,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка) КАК НалогообложениеПартии,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка) КАК НалогообложениеНДС,
		|	ДД.ХозяйственнаяОперация,
		|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) КАК СтатьяРасходовСписания,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивовПассивов,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаСписанияНДС
		|ИЗ
		|	РегистрНакопления.ТоварыОрганизаций КАК ДД
		|	ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ПартииТоваровОрганизаций КАК Партии
		|		ПО Партии.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|		И Партии.Регистратор = ДД.Регистратор
		|		И Партии.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|		И Партии.Первичное
		|		И Партии.АналитикаУчетаНоменклатуры = ДД.АналитикаУчетаНоменклатуры
		|		И Партии.ВидЗапасов = ДД.ВидЗапасов
		|		И НЕ (Партии.Регистратор ССЫЛКА Документ.ПересортицаТоваров И Партии.ДокументИсточник <> НЕОПРЕДЕЛЕНО)
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|	И ДД.ХозяйственнаяОперация В (
		|		ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПеремещениеТоваров),
		|		ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПеремещениеТоваровМеждуФилиалами),
		|		ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПорчаТоваров),
		|		ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПересортицаТоваров),
		|		ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.КорректировкаОбособленногоУчета),
		|		ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РеализацияКлиентуРеглУчет))
		|	И Партии.Регистратор ЕСТЬ NULL
		// сворачиваем строки, различающиеся номерами ГТД
		|СГРУППИРОВАТЬ ПО
		|	ДД.ВидДвижения,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	(ВЫБОР ДД.ХозяйственнаяОперация
		|		КОГДА ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПересортицаТоваров) ТОГДА ДД.Регистратор
		|		ИНАЧЕ НЕОПРЕДЕЛЕНО КОНЕЦ),
		|	ДД.ВидЗапасов,
		|	ДД.Номенклатура,
		|	ДД.Характеристика,
		|	ДД.ХозяйственнаяОперация
		|";
КонецФункции
	
// КОНТУР ТоварыКОформлениюДокументовИмпорта -> оформление импорта
Функция ТекстСписаниеИмпортныхПартий()
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстСписаниеИмпортныхПартий"" КАК ЗапросИсточник,
		|	90 КАК Приоритет,
		|	""Потребление"" ТипЗаписи,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) КАК ВидДвижения,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КАК РазделУчета,
		|	ДД.Дата КАК Период,
		|	ДД.Ссылка КАК Регистратор,
		|	ДД.Организация,
		|	Строки.АналитикаУчетаНоменклатуры,
		|	Строки.ДокументПоступления,
		|	Строки.ВидЗапасов,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка) КАК АналитикаУчетаПартий,
		|	0 КАК Знаменатель,
		|	СУММА(Строки.Количество) КАК Количество,
		|	0 КАК Стоимость,
		|	0 КАК СтоимостьБезНДС,
		|	0 КАК СтоимостьРегл,
		|	0 КАК НДСРегл,
		|	0 КАК ПостояннаяРазница,
		|	0 КАК ВременнаяРазница,
		|	ЛОЖЬ КАК Первичное,
		|	ЛОЖЬ КАК СохранятьРегл,
		|	ДД.Дата КАК ПериодПоступления,
		|	Строки.АналитикаУчетаНоменклатуры КАК КорАналитикаУчетаНоменклатуры,
		|	Строки.ВидЗапасов КАК КорВидЗапасов,
		|	НЕОПРЕДЕЛЕНО КАК ДокументИсточник,
		|	ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка) КАК Назначение,
		|	Строки.Номенклатура,
		|	Строки.Характеристика,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка) КАК НалогообложениеПартии,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка) КАК НалогообложениеНДС,
		|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ЗакупкаПоИмпорту) КАК ХозяйственнаяОперация,
		|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) КАК СтатьяРасходовСписания,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивовПассивов,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаСписанияНДС
		|ИЗ
		|	Документ.ТаможеннаяДекларацияИмпорт КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ТаможеннаяДекларацияИмпорт.Товары КАК Строки
		|		ПО Строки.Ссылка = ДД.Ссылка
		|	ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ТоварыКОформлениюДокументовИмпорта КАК КОформлению
		|		ПО КОформлению.Период = ДД.Дата
		|		И КОформлению.Регистратор = ДД.Ссылка
		|		И КОформлению.АналитикаУчетаНоменклатуры = Строки.АналитикаУчетаНоменклатуры
		|		И КОформлению.ВидЗапасов = Строки.ВидЗапасов
		|		И КОформлению.ДокументПоступления = Строки.ДокументПоступления
		|		И КОформлению.ДокументПоступления <> ЗНАЧЕНИЕ(Документ.ПриобретениеТоваровУслуг.ПустаяСсылка)
		|		И КОформлению.ДокументПоступления <> НЕОПРЕДЕЛЕНО
		|		И КОформлению.ТипДокументаИмпорта = &ТипДокументаИмпорта
		|ГДЕ
		|	ДД.Дата МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Проведен
		|	И КОформлению.ДокументПоступления ЕСТЬ NULL
		|СГРУППИРОВАТЬ ПО
		|	ДД.Дата,
		|	ДД.Ссылка,
		|	Строки.ДокументПоступления,
		|	ДД.Организация,
		|	Строки.АналитикаУчетаНоменклатуры,
		|	Строки.ВидЗапасов,
		|	Строки.Номенклатура,
		|	Строки.Характеристика
		|";
КонецФункции

Функция ТекстСписаниеТаможеннойДекларацией()
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстСписаниеТаможеннойДекларацией"" КАК ЗапросИсточник,
		|	90 КАК Приоритет,
		|	""Декларация"" КАК ТипЗаписи,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ДД.ВидДвижения,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КАК РазделУчета,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ДокументПоступления,
		|	ДД.ВидЗапасов,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка) КАК АналитикаУчетаПартий,
		|	0 КАК Знаменатель,
		|	СУММА(ДД.Количество) КАК Количество,
		|	0 КАК Стоимость,
		|	0 КАК СтоимостьБезНДС,
		|	0 КАК СтоимостьРегл,
		|	0 КАК НДСРегл,
		|	0 КАК ПостояннаяРазница,
		|	0 КАК ВременнаяРазница,
		|	ЛОЖЬ КАК Первичное,
		|	ЛОЖЬ КАК СохранятьРегл,
		|	ДД.Период КАК ПериодПоступления,
		|	ДД.АналитикаУчетаНоменклатуры КАК КорАналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов КАК КорВидЗапасов,
		|	НЕОПРЕДЕЛЕНО КАК ДокументИсточник,
		|	ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка) КАК Назначение,
		|	Аналитики.Номенклатура,
		|	Аналитики.Характеристика,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка) КАК НалогообложениеПартии,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка) КАК НалогообложениеНДС,
		|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ЗакупкаПоИмпорту) КАК ХозяйственнаяОперация,
		|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) КАК СтатьяРасходовСписания,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивовПассивов,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаСписанияНДС
		|ИЗ
		|	РегистрНакопления.ТоварыКОформлениюДокументовИмпорта КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК Аналитики
		|		ПО Аналитики.Ссылка = ДД.АналитикаУчетаНоменклатуры
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		|	И ДД.ДокументПоступления <> ЗНАЧЕНИЕ(Документ.ПриобретениеТоваровУслуг.ПустаяСсылка)
		|	И ДД.ДокументПоступления <> НЕОПРЕДЕЛЕНО
		|	И ДД.ТипДокументаИмпорта = &ТипДокументаИмпорта	
		|СГРУППИРОВАТЬ ПО
		|	ДД.ВидДвижения,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.ДокументПоступления,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов,
		|	Аналитики.Номенклатура,
		|	Аналитики.Характеристика
		|";
КонецФункции

Функция ТекстПриходыРастаможенногоТовара()
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстПриходыРастаможенногоТовара"" КАК ЗапросИсточник,
		|	10 КАК Приоритет,
		|	""Перемещение"" КАК ТипЗаписи,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыНаСкладах) КАК РазделУчета,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.Регистратор КАК ДокументПоступления,
		|	ДД.ВидЗапасов,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка) КАК АналитикаУчетаПартий,
		|	0 КАК Знаменатель,
		|	СУММА(ДД.Количество) КАК Количество,
		|	0 КАК Стоимость,
		|	0 КАК СтоимостьБезНДС,
		|	0 КАК СтоимостьРегл,
		|	0 КАК НДСРегл,
		|	0 КАК ПостояннаяРазница,
		|	0 КАК ВременнаяРазница,
		|	ЛОЖЬ КАК Первичное,
		|	ЛОЖЬ КАК СохранятьРегл,
		|	ДД.Период КАК ПериодПоступления,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КАК КорАналитикаУчетаНоменклатуры,
		|	ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка) КАК КорВидЗапасов,
		|	ДД.Регистратор КАК ДокументИсточник,
		|	ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка) КАК Назначение,
		|	Аналитики.Номенклатура,
		|	Аналитики.Характеристика,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка) КАК НалогообложениеПартии,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка) КАК НалогообложениеНДС,
		|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ЗакупкаУПоставщика) КАК ХозяйственнаяОперация,
		|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) КАК СтатьяРасходовСписания,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивовПассивов,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаСписанияНДС
		|ИЗ
		|	РегистрНакопления.ТоварыКОформлениюДокументовИмпорта КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК Аналитики
		|		ПО Аналитики.Ссылка = ДД.АналитикаУчетаНоменклатуры
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		|	И ДД.ТипДокументаИмпорта = &ТипДокументаИмпорта
		|СГРУППИРОВАТЬ ПО
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов,
		|	Аналитики.Номенклатура,
		|	Аналитики.Характеристика
		|";
КонецФункции

// КОНТУР ТоварыОрганизацийКПередаче -> оформление продаж между организациями по расходу чужих запасов.
Функция ТекстПотребленияЧужихЗапасов()
	// потребления чужих видов запасов (реализации, перемещения, возвраты от клиентов)
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстПотребленияЧужихЗапасов"" КАК ЗапросИсточник,
		|	(ВЫБОР КОГДА ДД.Количество > 0 ТОГДА 90 ИНАЧЕ 10 КОНЕЦ) КАК Приоритет,
		|	(ВЫБОР
		|		КОГДА НЕ Разборка.Ссылка ЕСТЬ NULL ТОГДА ""Материал""
		|		КОГДА ДД.Количество > 0 ТОГДА ""Потребление""
		|		ИНАЧЕ ""Сторно"" КОНЕЦ) КАК ТипЗаписи,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ДД.ВидДвижения,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыНаСкладах) КАК РазделУчета,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.ОрганизацияОтгрузки КАК Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	НЕОПРЕДЕЛЕНО КАК ДокументПоступления,
		|	КПередаче.ВидЗапасовПродавца КАК ВидЗапасов,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка) КАК АналитикаУчетаПартий,
		|	0 КАК Знаменатель,
		|	ДД.Количество,
		|	0 КАК Стоимость,
		|	0 КАК СтоимостьБезНДС,
		|	0 КАК СтоимостьРегл,
		|	0 КАК НДСРегл,
		|	0 КАК ПостояннаяРазница,
		|	0 КАК ВременнаяРазница,
		|	ЛОЖЬ КАК Первичное,
		|	ЛОЖЬ КАК СохранятьРегл,
		|	ДД.Период КАК ПериодПоступления,
		|	ДД.КорАналитикаУчетаНоменклатуры,
		|	(ВЫБОР КОГДА ДД.КорВидЗапасов = ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка) ТОГДА КПередаче.ВидЗапасовПродавца
		|		ИНАЧЕ ДД.КорВидЗапасов КОНЕЦ) КАК КорВидЗапасов,
		|	ДД.ДокументРеализации КАК ДокументИсточник,
		|	ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка) КАК Назначение,
		|	ДД.Номенклатура,
		|	ДД.Характеристика,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка) КАК НалогообложениеПартии,
		|	ДД.НалогообложениеНДС,
		|	ДД.ХозяйственнаяОперация,
		|	ДД.СтатьяРасходов КАК СтатьяРасходовСписания,
		|	ДД.АналитикаРасходов,
		|	ДД.АналитикаАктивовПассивов,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаСписанияНДС
		|ИЗ
		|	РегистрНакопления.ТоварыОрганизаций КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ПотребленияЧужихЗапасов КАК КПередаче
		|		ПО КПередаче.Регистратор = ДД.Регистратор
		|		И КПередаче.ОрганизацияВладелец = ДД.Организация
		|		И КПередаче.ОрганизацияПродавец = ДД.ОрганизацияОтгрузки
		|		И КПередаче.АналитикаУчетаНоменклатуры = ДД.АналитикаУчетаНоменклатуры
		|		И КПередаче.НомерГТД = ДД.НомерГТД
		|		И КПередаче.ВидЗапасовВладельца = ДД.ВидЗапасов
		|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.СборкаТоваров КАК Разборка
		|		ПО Разборка.Дата = ДД.Период
		|		И Разборка.Ссылка = ДД.Регистратор
		|		И Разборка.АналитикаУчетаНоменклатуры = ДД.АналитикаУчетаНоменклатуры
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.ОрганизацияОтгрузки В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		|	И НЕ ДД.Регистратор ССЫЛКА Документ.ВозвратТоваровОтКлиента
		|	И НЕ (ДД.Регистратор ССЫЛКА Документ.КорректировкаРеализации И ДД.Количество < 0)
		|";
КонецФункции

Функция ТекстВозвратыЧужихЗапасов()
	// возвраты от клиентов чужих видов запасов
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстВозвратыЧужихЗапасов"" КАК ЗапросИсточник,
		|	10 КАК Приоритет,
		|	""Сторно"" КАК ТипЗаписи,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) КАК ВидДвижения,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КАК РазделУчета,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.ОрганизацияОтгрузки КАК Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	НЕОПРЕДЕЛЕНО КАК ДокументПоступления,
		|	КПередаче.ВидЗапасовПродавца КАК ВидЗапасов,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка) КАК АналитикаУчетаПартий,
		|	0 КАК Знаменатель,
		|	ДД.Количество КАК Количество,
		|	0 КАК Стоимость,
		|	0 КАК СтоимостьБезНДС,
		|	0 КАК СтоимостьРегл,
		|	0 КАК НДСРегл,
		|	0 КАК ПостояннаяРазница,
		|	0 КАК ВременнаяРазница,
		|	ЛОЖЬ КАК Первичное,
		|	ЛОЖЬ КАК СохранятьРегл,
		|	ДД.Период КАК ПериодПоступления,
		|	ДД.КорАналитикаУчетаНоменклатуры,
		|	ДД.КорВидЗапасов КАК КорВидЗапасов,
		|	(ВЫБОР 
		|		КОГДА ДД.Номенклатура.ТипНоменклатуры = ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.МногооборотнаяТара)
		|		 И Возврат.ВозвратПереданнойМногооборотнойТары
		|			ТОГДА ДД.ДокументРеализации
		|		КОГДА ДД.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВозвратОтКомиссионера) ТОГДА ДД.Регистратор
		|		ИНАЧЕ ДД.ДокументРеализации КОНЕЦ) КАК ДокументИсточник,
		|	ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка) КАК Назначение,
		|	ДД.Номенклатура,
		|	ДД.Характеристика,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка) КАК НалогообложениеПартии,
		|	ДД.НалогообложениеНДС,
		|	ДД.ХозяйственнаяОперация,
		|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) КАК СтатьяРасходовСписания,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивовПассивов,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаСписанияНДС
		|ИЗ
		|	РегистрНакопления.ТоварыОрганизаций КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ПотребленияЧужихЗапасов КАК КПередаче
		|		ПО КПередаче.Регистратор = ДД.Регистратор
		|		И КПередаче.ОрганизацияВладелец = ДД.Организация
		|		И КПередаче.ОрганизацияПродавец = ДД.ОрганизацияОтгрузки
		|		И КПередаче.АналитикаУчетаНоменклатуры = ДД.АналитикаУчетаНоменклатуры
		|		И КПередаче.НомерГТД = ДД.НомерГТД
		|		И КПередаче.ВидЗапасовВладельца = ДД.ВидЗапасов
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ВидыЗапасов КАК СправочникВидыЗапасов
		|		ПО СправочникВидыЗапасов.Ссылка = ДД.КорВидЗапасов
		|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.ВозвратТоваровОтКлиента КАК Возврат
		|		ПО Возврат.Ссылка = ДД.Регистратор
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И (НЕ ДД.Первичное
	    |	 ИЛИ ДД.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВозвратОтКомиссионера))
		|	И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		|	И ДД.Количество < 0
		|	И ДД.Организация <> ДД.ОрганизацияОтгрузки
		|	И (ДД.Регистратор ССЫЛКА Документ.ВозвратТоваровОтКлиента
		|		ИЛИ ДД.Регистратор ССЫЛКА Документ.КорректировкаРеализации)
		|	И СправочникВидыЗапасов.РеализацияЗапасовДругойОрганизации
		|";
КонецФункции

Функция ТекстПотребленияСобственныхЗапасов()
	// Списание под обеспечение потреблений чужих видов запасов (передачи, возвраты передач).
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстПотребленияСобственныхЗапасов"" КАК ЗапросИсточник,
		|	90 КАК Приоритет,
		|	""Потребление"" КАК ТипЗаписи,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) КАК ВидДвижения,
		|	(ВЫБОР
		|		КОГДА НЕ Возврат.Ссылка ЕСТЬ NULL
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка)
		|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыНаСкладах) КОНЕЦ) КАК РазделУчета,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	(ВЫБОР КОГДА ДД.Возвращено > 0 ТОГДА СправочникВидыЗапасов.Организация ИНАЧЕ ДД.ОрганизацияВладелец КОНЕЦ) КАК Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	НЕОПРЕДЕЛЕНО КАК ДокументПоступления,
		|	(ВЫБОР КОГДА ДД.Возвращено > 0 ТОГДА ДД.ВидЗапасовПродавца ИНАЧЕ СправочникВидыЗапасов.ВидЗапасовВладельца КОНЕЦ) КАК ВидЗапасов,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка) КАК АналитикаУчетаПартий,
		|	0 КАК Знаменатель,
		|	СУММА(ДД.Количество + ДД.Возвращено) КАК Количество,
		|	0 КАК Стоимость,
		|	0 КАК СтоимостьБезНДС,
		|	0 КАК СтоимостьРегл,
		|	0 КАК НДСРегл,
		|	0 КАК ПостояннаяРазница,
		|	0 КАК ВременнаяРазница,
		|	ЛОЖЬ КАК Первичное,
		|	ЛОЖЬ КАК СохранятьРегл,
		|	ДД.Период КАК ПериодПоступления,
		|	(ВЫБОР
		|		КОГДА ДД.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВозвратПоКомиссииМеждуОрганизациями)
		|			ТОГДА НЕОПРЕДЕЛЕНО
		|		ИНАЧЕ ДД.АналитикаУчетаНоменклатуры КОНЕЦ) КАК КорАналитикаУчетаНоменклатуры,
		|	(ВЫБОР
		|		КОГДА ДД.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВозвратПоКомиссииМеждуОрганизациями)
		|			ТОГДА НЕОПРЕДЕЛЕНО
		|		КОГДА ДД.Возвращено > 0 ТОГДА ДД.КорВидЗапасов
		|		ИНАЧЕ ДД.ВидЗапасовПродавца КОНЕЦ) КАК КорВидЗапасов,
		|	НЕОПРЕДЕЛЕНО КАК ДокументИсточник,
		|	ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка) КАК Назначение,
		|	ДД.Номенклатура,
		|	ДД.Характеристика,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка) КАК НалогообложениеПартии,
		|	ДД.НалогообложениеНДС,
		|	ДД.ХозяйственнаяОперация,
		|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) КАК СтатьяРасходовСписания,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивовПассивов,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаСписанияНДС
		|ИЗ
		|	РегистрНакопления.ТоварыОрганизацийКПередаче КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ВидыЗапасов КАК СправочникВидыЗапасов
		|		ПО СправочникВидыЗапасов.Ссылка = ДД.ВидЗапасовПродавца
		|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.ВозвратТоваровМеждуОрганизациями КАК Возврат
		|		ПО Возврат.Дата = ДД.Период
		|		И Возврат.Ссылка = ДД.Регистратор
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И (ВЫБОР КОГДА ДД.Возвращено > 0 ТОГДА СправочникВидыЗапасов.Организация ИНАЧЕ ДД.ОрганизацияВладелец КОНЕЦ) В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		|	И ДД.ХозяйственнаяОперация <> ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПередачаНаКомиссиюВДругуюОрганизацию)
		|		// сворачиваем строки, различающиеся номерами ГТД
		|СГРУППИРОВАТЬ ПО
		|	(ВЫБОР
		|		КОГДА НЕ Возврат.Ссылка ЕСТЬ NULL
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка)
		|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыНаСкладах) КОНЕЦ),
		|	ДД.Период,
		|	ДД.Регистратор,
		|	(ВЫБОР КОГДА ДД.Возвращено > 0 ТОГДА СправочникВидыЗапасов.Организация ИНАЧЕ ДД.ОрганизацияВладелец КОНЕЦ),
		|	ДД.АналитикаУчетаНоменклатуры,
		|	(ВЫБОР КОГДА ДД.Возвращено > 0 ТОГДА ДД.ВидЗапасовПродавца ИНАЧЕ СправочникВидыЗапасов.ВидЗапасовВладельца КОНЕЦ),
		|	(ВЫБОР
		|		КОГДА ДД.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВозвратПоКомиссииМеждуОрганизациями)
		|			ТОГДА НЕОПРЕДЕЛЕНО
		|		ИНАЧЕ ДД.АналитикаУчетаНоменклатуры КОНЕЦ),
		|	(ВЫБОР
		|		КОГДА ДД.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВозвратПоКомиссииМеждуОрганизациями)
		|			ТОГДА НЕОПРЕДЕЛЕНО
		|		КОГДА ДД.Возвращено > 0 ТОГДА ДД.КорВидЗапасов
		|		ИНАЧЕ ДД.ВидЗапасовПродавца КОНЕЦ),
		|	ДД.Номенклатура,
		|	ДД.Характеристика,
		|	ДД.НалогообложениеНДС,
		|	ДД.ХозяйственнаяОперация
		|";
КонецФункции

Функция ТекстПередачиВозвратыКомиссияМеждуОрганизациями()
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстПередачиВозвратыКомиссияМеждуОрганизациями"" КАК ЗапросИсточник,
		|	90 КАК Приоритет,
		|	(ВЫБОР
		|		КОГДА ДД.Возвращено = 0 ТОГДА ""Потребление""
		|		ИНАЧЕ ""Перемещение"" КОНЕЦ) КАК ТипЗаписи,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ДД.ВидДвижения,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыНаСкладах) КАК РазделУчета,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.ОрганизацияВладелец КАК Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	НЕОПРЕДЕЛЕНО КАК ДокументПоступления,
		|	ДД.ВидЗапасовПродавца.ВидЗапасовВладельца КАК ВидЗапасов,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка) КАК АналитикаУчетаПартий,
		|	0. КАК Знаменатель,
		|	СУММА(ДД.Количество + ДД.Возвращено) КАК Количество,
		|	0. КАК Стоимость,
		|	0. КАК СтоимостьБезНДС,
		|	0. КАК СтоимостьРегл,
		|	0. КАК НДСРегл,
		|	0. КАК ПостояннаяРазница,
		|	0. КАК ВременнаяРазница,
		|	ЛОЖЬ КАК Первичное,
		|	ЛОЖЬ КАК СохранятьРегл,
		|	ДД.Период КАК ПериодПоступления,
		|	АналитикаКомиссионера.КлючАналитики КАК КорАналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасовПродавца.ВидЗапасовВладельца КАК КорВидЗапасов,
		|	(ВЫБОР
		|		КОГДА ДД.Возвращено = 0 ТОГДА НЕОПРЕДЕЛЕНО
		|		ИНАЧЕ ДД.Регистратор КОНЕЦ) КАК ДокументИсточник,
		|	ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка) КАК Назначение,
		|	ДД.Номенклатура,
		|	ДД.Характеристика,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка) КАК НалогообложениеПартии,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка) КАК НалогообложениеНДС,
		|	ДД.ХозяйственнаяОперация,
		|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) КАК СтатьяРасходовСписания,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивовПассивов,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаСписанияНДС
		|ИЗ
		|	РегистрНакопления.ТоварыОрганизацийКПередаче КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК Аналитика
		|		ПО Аналитика.Ссылка = ДД.АналитикаУчетаНоменклатуры
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаНоменклатуры КАК АналитикаКомиссионера
		|		ПО АналитикаКомиссионера.Номенклатура = Аналитика.Номенклатура
		|		И АналитикаКомиссионера.Характеристика = Аналитика.Характеристика
		|		И АналитикаКомиссионера.Серия = ЗНАЧЕНИЕ(Справочник.СерииНоменклатуры.ПустаяСсылка)
		|		И АналитикаКомиссионера.Назначение = ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка)
		|		И АналитикаКомиссионера.МестоХранения = ДД.ВидЗапасовПродавца.Организация
		//++ НЕ УТ 
		|		И АналитикаКомиссионера.СтатьяКалькуляции = ЗНАЧЕНИЕ(Справочник.СтатьиКалькуляции.ПустаяСсылка)
		//-- НЕ УТ 
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.ОрганизацияВладелец В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И ДД.ХозяйственнаяОперация В (
		|		ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПередачаНаКомиссиюВДругуюОрганизацию),
		|		ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВозвратПоКомиссииМеждуОрганизациями))
		// сворачиваем строки, различающиеся номерами ГТД
		|СГРУППИРОВАТЬ ПО
		|	(ВЫБОР
		|		КОГДА ДД.Возвращено = 0 ТОГДА ""Потребление""
		|		ИНАЧЕ ""Перемещение"" КОНЕЦ),
		|	ДД.ВидДвижения,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.ОрганизацияВладелец,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасовПродавца.ВидЗапасовВладельца,
		|	АналитикаКомиссионера.КлючАналитики,
		|	(ВЫБОР
		|		КОГДА ДД.Возвращено = 0 ТОГДА НЕОПРЕДЕЛЕНО
		|		ИНАЧЕ ДД.Регистратор КОНЕЦ),
		|	ДД.Номенклатура,
		|	ДД.Характеристика,
		|	ДД.ХозяйственнаяОперация
		|";
КонецФункции

//++ НЕ УТ

// КОНТУР ПроизводственныеЗатраты
Функция ТекстОстаткиВПроизводстве() // использует ПрошлыеПоступленияПроизводство
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстОстаткиВПроизводстве"" КАК ЗапросИсточник,
		|	10 КАК Приоритет,
		|	""Остаток"" КАК ТипЗаписи,
		|	ИСТИНА КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты) КАК РазделУчета,
		|	ЕСТЬNULL(Периодика.Период, &НачалоПериода) КАК Период,
		|	ЕСТЬNULL(Периодика.Регистратор, ДД.ДокументПоступления) КАК Регистратор,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ДокументПоступления,
		|	ДД.ВидЗапасов,
		|	ДД.АналитикаУчетаПартий,
		|	0 КАК Знаменатель,
		|	ДД.КоличествоОстаток КАК Количество,
		|	ДД.СтоимостьОстаток КАК Стоимость,
		|	ДД.СтоимостьБезНДСОстаток КАК СтоимостьБезНДС,
		|	ДД.СтоимостьРеглОстаток КАК СтоимостьРегл,
		|	ДД.НДСРеглОстаток КАК НДСРегл,
		|	ДД.ПостояннаяРазницаОстаток КАК ПостояннаяРазница,
		|	ДД.ВременнаяРазницаОстаток КАК ВременнаяРазница,
		|	ИСТИНА КАК Первичное,
		|	ИСТИНА КАК СохранятьРегл,
		|	&НачалоПериода КАК ПериодПоступления,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КАК КорАналитикаУчетаНоменклатуры,
		|	ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка) КАК КорВидЗапасов,
		|	НЕОПРЕДЕЛЕНО КАК ДокументИсточник,
		|	ДД.АналитикаУчетаНоменклатуры.Назначение КАК Назначение,
		|	ДД.АналитикаУчетаНоменклатуры.Номенклатура КАК Номенклатура,
		|	ДД.АналитикаУчетаНоменклатуры.Характеристика КАК Характеристика,
		|	ДД.АналитикаУчетаПартий.НалогообложениеНДС КАК НалогообложениеПартии,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка) КАК НалогообложениеНДС,
		|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПустаяСсылка) КАК ХозяйственнаяОперация,
		|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) КАК СтатьяРасходовСписания,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивовПассивов,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаСписанияНДС
		|ИЗ
		|	РегистрНакопления.ПартииПроизводственныхЗатрат.Остатки(&НачалоПериода, Организация В (&МассивОрганизаций)) КАК ДД
		|	ЛЕВОЕ СОЕДИНЕНИЕ ПрошлыеПоступленияПроизводство КАК Периодика
		|		ПО Периодика.Ссылка = ДД.ДокументПоступления
		|		И Периодика.Склад = ДД.АналитикаУчетаНоменклатуры.МестоХранения
		|ГДЕ
		|	ДД.КоличествоОстаток > 0
		|";
КонецФункции

Функция ТекстВводыОстатковВПроизводстве()
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстВводыОстатковВПроизводстве"" КАК ЗапросИсточник,
		|	10 КАК Приоритет,
		|	""Остаток"" КАК ТипЗаписи,
		|	ИСТИНА КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты) КАК РазделУчета,
		|	&НачалоПериода КАК Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ДокументПоступления,
		|	ДД.ВидЗапасов,
		|	ДД.АналитикаУчетаПартий,
		|	0 КАК Знаменатель,
		|	ДД.Количество КАК Количество,
		|	ДД.Стоимость КАК Стоимость,
		|	ДД.СтоимостьБезНДС КАК СтоимостьБезНДС,
		|	ДД.СтоимостьРегл КАК СтоимостьРегл,
		|	ДД.НДСРегл КАК НДСРегл,
		|	ДД.ПостояннаяРазница КАК ПостояннаяРазница,
		|	ДД.ВременнаяРазница КАК ВременнаяРазница,
		|	ИСТИНА КАК Первичное,
		|	ИСТИНА КАК СохранятьРегл,
		|	&НачалоПериода КАК ПериодПоступления,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КАК КорАналитикаУчетаНоменклатуры,
		|	ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка) КАК КорВидЗапасов,
		|	НЕОПРЕДЕЛЕНО КАК ДокументИсточник,
		|	ДД.АналитикаУчетаНоменклатуры.Назначение КАК Назначение,
		|	ДД.АналитикаУчетаНоменклатуры.Номенклатура КАК Номенклатура,
		|	ДД.АналитикаУчетаНоменклатуры.Характеристика КАК Характеристика,
		|	ДД.АналитикаУчетаПартий.НалогообложениеНДС КАК НалогообложениеПартии,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка) КАК НалогообложениеНДС,
		|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПустаяСсылка) КАК ХозяйственнаяОперация,
		|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) КАК СтатьяРасходовСписания,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивовПассивов,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаСписанияНДС
		|ИЗ
		|	РегистрНакопления.ПартииПроизводственныхЗатрат КАК ДД
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|	И ДД.Регистратор ССЫЛКА Документ.ВводОстатков
		|";
КонецФункции

Функция ТекстПоступленияОтходовВПроизводство()
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстПоступленияОтходовВПроизводство"" КАК ЗапросИсточник,
		|	10 КАК Приоритет,
		|	""Остаток"" КАК ТипЗаписи,
		|	ИСТИНА КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты) КАК РазделУчета,
		|	&НачалоПериода КАК Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ДокументПоступления,
		|	ДД.ВидЗапасов,
		|	ДД.АналитикаУчетаПартий,
		|	0 КАК Знаменатель,
		|	ДД.Количество КАК Количество,
		|	ДД.Стоимость КАК Стоимость,
		|	ДД.СтоимостьБезНДС КАК СтоимостьБезНДС,
		|	ДД.СтоимостьРегл КАК СтоимостьРегл,
		|	ДД.НДСРегл КАК НДСРегл,
		|	ДД.ПостояннаяРазница КАК ПостояннаяРазница,
		|	ДД.ВременнаяРазница КАК ВременнаяРазница,
		|	ИСТИНА КАК Первичное,
		|	ИСТИНА КАК СохранятьРегл,
		|	&НачалоПериода КАК ПериодПоступления,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КАК КорАналитикаУчетаНоменклатуры,
		|	ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка) КАК КорВидЗапасов,
		|	НЕОПРЕДЕЛЕНО КАК ДокументИсточник,
		|	ДД.АналитикаУчетаНоменклатуры.Назначение КАК Назначение,
		|	ДД.АналитикаУчетаНоменклатуры.Номенклатура КАК Номенклатура,
		|	ДД.АналитикаУчетаНоменклатуры.Характеристика КАК Характеристика,
		|	ДД.АналитикаУчетаПартий.НалогообложениеНДС КАК НалогообложениеПартии,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка) КАК НалогообложениеНДС,
		|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПустаяСсылка) КАК ХозяйственнаяОперация,
		|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) КАК СтатьяРасходовСписания,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивовПассивов,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаСписанияНДС
		|ИЗ
		|	РегистрНакопления.ПартииПроизводственныхЗатрат КАК ДД
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|	И ДД.Регистратор ССЫЛКА Документ.ВыпускПродукции
		|	И ДД.Количество > 0
		|";
КонецФункции

Функция ТекстПередачиВПроизводство()
	// Передачи материалов в производство и в переработку, возвраты материалов из производства и от переработчика.
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстПередачиВПроизводство"" КАК ЗапросИсточник,
		|	(ВЫБОР 
		|		КОГДА ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) ТОГДА 90
		|		ИНАЧЕ 10 КОНЕЦ) КАК Приоритет,
		|	(ВЫБОР 
		|		КОГДА ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) ТОГДА ""Возврат""
		|		ИНАЧЕ ""Производство"" КОНЕЦ) КАК ТипЗаписи,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	(ВЫБОР 
		|		КОГДА ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) ТОГДА ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		|		ИНАЧЕ ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КОНЕЦ) КАК ВидДвижения,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты) КАК РазделУчета,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация КАК Организация,
		|	ДД.КорАналитикаУчетаНоменклатуры,
		|	НЕОПРЕДЕЛЕНО КАК ДокументПоступления,
		|	(ВЫБОР 
		|		КОГДА ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) ТОГДА ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка)
		|		ИНАЧЕ ДД.КорВидЗапасов КОНЕЦ) КАК ВидЗапасов,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка) КАК АналитикаУчетаПартий,
		|	0 КАК Знаменатель,
		|	СУММА(ДД.Количество) КАК Количество,
		|	0 КАК Стоимость,
		|	0 КАК СтоимостьБезНДС,
		|	0 КАК СтоимостьРегл,
		|	0 КАК НДСРегл,
		|	0 КАК ПостояннаяРазница,
		|	0 КАК ВременнаяРазница,
		|	ЛОЖЬ КАК Первичное,
		|	ЛОЖЬ КАК СохранятьРегл,
		|	ДД.Период КАК ПериодПоступления,
		|	ДД.АналитикаУчетаНоменклатуры КАК КорАналитикаУчетаНоменклатуры,
		|	(ВЫБОР 
		|		КОГДА ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) ТОГДА ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка)
		|		ИНАЧЕ ДД.ВидЗапасов КОНЕЦ) КАК КорВидЗапасов,
		|	(ВЫБОР 
		|		КОГДА ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) ТОГДА НЕОПРЕДЕЛЕНО
		|		ИНАЧЕ ДД.Регистратор КОНЕЦ) КАК ДокументИсточник,
		|	(ВЫБОР 
		|		КОГДА ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) ТОГДА ДД.АналитикаУчетаНоменклатуры.Назначение
		|		ИНАЧЕ ЕСТЬNULL(ДД.КорАналитикаУчетаНоменклатуры.Назначение, ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка)) КОНЕЦ) КАК Назначение,
		|	ДД.Номенклатура,
		|	ДД.Характеристика,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка) КАК НалогообложениеПартии,
		|	ДД.НалогообложениеНДС,
		|	ДД.ХозяйственнаяОперация,
		|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) КАК СтатьяРасходовСписания,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивовПассивов,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаСписанияНДС
		|ИЗ
		|	РегистрНакопления.ТоварыОрганизаций КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ МатериалыИРаботыВПроизводстве КАК Затраты
		|		ПО Затраты.Регистратор = ДД.Регистратор
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ВидыЗапасов КАК СпрВидыЗапасов
		|		ПО СпрВидыЗапасов.Ссылка = ДД.ВидЗапасов
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И СпрВидыЗапасов.ТипЗапасов <> ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.КомиссионныйТовар)
		|СГРУППИРОВАТЬ ПО
		|	(ВЫБОР 
		|		КОГДА ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) ТОГДА 90
		|		ИНАЧЕ 10 КОНЕЦ),
		|	(ВЫБОР 
		|		КОГДА ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) ТОГДА ""Возврат""
		|		ИНАЧЕ ""Производство"" КОНЕЦ),
		|	(ВЫБОР 
		|		КОГДА ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) ТОГДА ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		|		ИНАЧЕ ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КОНЕЦ),
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.КорАналитикаУчетаНоменклатуры,
		|	(ВЫБОР 
		|		КОГДА ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) ТОГДА ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка)
		|		ИНАЧЕ ДД.КорВидЗапасов КОНЕЦ),
		|	(ВЫБОР 
		|		КОГДА ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) ТОГДА ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка)
		|		ИНАЧЕ ДД.ВидЗапасов КОНЕЦ),
		|	(ВЫБОР 
		|		КОГДА ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) ТОГДА НЕОПРЕДЕЛЕНО
		|		ИНАЧЕ ДД.Регистратор КОНЕЦ),
		|	(ВЫБОР 
		|		КОГДА ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) ТОГДА ДД.АналитикаУчетаНоменклатуры.Назначение
		|		ИНАЧЕ ЕСТЬNULL(ДД.КорАналитикаУчетаНоменклатуры.Назначение, ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка)) КОНЕЦ),
		|	ДД.Номенклатура,
		|	ДД.Характеристика,
		|	ДД.НалогообложениеНДС,
		|	ДД.ХозяйственнаяОперация
		|";
КонецФункции

Функция ТекстПередачиВПроизводствоКомиссионныхТоваров()
	// передачи в производство товаров, принятых на комиссию
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстПередачиВПроизводствоКомиссионныхТоваров"" КАК ЗапросИсточник,
		|	10 КАК Приоритет,
		|	""Производство"" КАК ТипЗаписи,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты) КАК РазделУчета,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	СпрВидыЗапасов.Организация КАК Организация,
		|	ДД.КорАналитикаУчетаНоменклатуры,
		|	НЕОПРЕДЕЛЕНО КАК ДокументПоступления,
		|	ДД.КорВидЗапасов КАК ВидЗапасов,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка) КАК АналитикаУчетаПартий,
		|	0 КАК Знаменатель,
		|	СУММА(ДД.КоличествоСписано) КАК Количество,
		|	0 КАК Стоимость,
		|	0 КАК СтоимостьБезНДС,
		|	0 КАК СтоимостьРегл,
		|	0 КАК НДСРегл,
		|	0 КАК ПостояннаяРазница,
		|	0 КАК ВременнаяРазница,
		|	ЛОЖЬ КАК Первичное,
		|	ЛОЖЬ КАК СохранятьРегл,
		|	ДД.Период КАК ПериодПоступления,
		|	ДД.АналитикаУчетаНоменклатуры КАК КорАналитикаУчетаНоменклатуры,
		|	ДД.КорВидЗапасов КАК КорВидЗапасов,
		|	ДД.Регистратор КАК ДокументИсточник,
		|	ДД.КорАналитикаУчетаНоменклатуры.Назначение КАК Назначение,
		|	ДД.Номенклатура,
		|	ДД.Характеристика,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка) КАК НалогообложениеПартии,
		|	ДД.НалогообложениеНДС,
		|	ДД.ХозяйственнаяОперация,
		|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) КАК СтатьяРасходовСписания,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивовПассивов,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаСписанияНДС
		|ИЗ
		|	РегистрНакопления.ТоварыКОформлениюОтчетовКомитенту КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ МатериалыИРаботыВПроизводстве КАК Затраты
		|		ПО Затраты.Регистратор = ДД.Регистратор
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ВидыЗапасов КАК СпрВидыЗапасов
		|		ПО СпрВидыЗапасов.Ссылка = ДД.ВидЗапасов
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Активность
		|	И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|	И ДД.КоличествоСписано <> 0
		|	И ДД.КорАналитикаУчетаНоменклатуры <> ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка)
		|СГРУППИРОВАТЬ ПО
		|	ДД.Период,
		|	ДД.Регистратор,
		|	СпрВидыЗапасов.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.КорАналитикаУчетаНоменклатуры,
		|	ДД.КорВидЗапасов,
		|	ДД.КорАналитикаУчетаНоменклатуры.Назначение,
		|	ДД.Номенклатура,
		|	ДД.Характеристика,
		|	ДД.НалогообложениеНДС,
		|	ДД.ХозяйственнаяОперация
		|";
КонецФункции

Функция ТекстВозвратыИзПроизводства()
	// возвраты материалов из производства и от переработчика
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстВозвратыИзПроизводства"" КАК ЗапросИсточник,
		|	10 КАК Приоритет,
		|	""Сторно"" КАК ТипЗаписи,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) КАК ВидДвижения,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыНаСкладах) КАК РазделУчета,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация КАК Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	НЕОПРЕДЕЛЕНО КАК ДокументПоступления,
		|	ДД.ВидЗапасов КАК ВидЗапасов,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка) КАК АналитикаУчетаПартий,
		|	0 КАК Знаменатель,
		|	-ДД.Количество КАК Количество,
		|	0 КАК Стоимость,
		|	0 КАК СтоимостьБезНДС,
		|	0 КАК СтоимостьРегл,
		|	0 КАК НДСРегл,
		|	0 КАК ПостояннаяРазница,
		|	0 КАК ВременнаяРазница,
		|	ЛОЖЬ КАК Первичное,
		|	ЛОЖЬ КАК СохранятьРегл,
		|	ДД.Период КАК ПериодПоступления,
		|	ДД.КорАналитикаУчетаНоменклатуры КАК КорАналитикаУчетаНоменклатуры,
		|	ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка) КАК КорВидЗапасов,
		|	ДД.Регистратор КАК ДокументИсточник,
		|	ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка) КАК Назначение,
		|	ДД.Номенклатура,
		|	ДД.Характеристика,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка) КАК НалогообложениеПартии,
		|	ДД.НалогообложениеНДС,
		|	ДД.ХозяйственнаяОперация,
		|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) КАК СтатьяРасходовСписания,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивовПассивов,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаСписанияНДС
		|ИЗ
		|	РегистрНакопления.ТоварыОрганизаций КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ МатериалыИРаботыВПроизводстве КАК Затраты
		|		ПО Затраты.Регистратор = ДД.Регистратор
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|";
КонецФункции

Функция ТекстПеремещенияМатериаловВПроизводстве()
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстПеремещенияМатериаловВПроизводстве"" КАК ЗапросИсточник,
		|	(ВЫБОР 
		|		КОГДА ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) ТОГДА 90
		|		ИНАЧЕ 10 КОНЕЦ) КАК Приоритет,
		|	(ВЫБОР 
		|		КОГДА ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) ТОГДА ""ПеремещениеВПроизводстве""
		|		ИНАЧЕ ""Перемещение"" КОНЕЦ) КАК ТипЗаписи,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ДД.ВидДвижения,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты) КАК РазделУчета,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация КАК Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	НЕОПРЕДЕЛЕНО КАК ДокументПоступления,
		|	ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка) КАК ВидЗапасов,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка) КАК АналитикаУчетаПартий,
		|	0 КАК Знаменатель,
		|	СУММА(ДД.Количество) КАК Количество,
		|	0 КАК Стоимость,
		|	0 КАК СтоимостьБезНДС,
		|	0 КАК СтоимостьРегл,
		|	0 КАК НДСРегл,
		|	0 КАК ПостояннаяРазница,
		|	0 КАК ВременнаяРазница,
		|	ЛОЖЬ КАК Первичное,
		|	ЛОЖЬ КАК СохранятьРегл,
		|	ДД.Период КАК ПериодПоступления,
		|	ЕСТЬNULL(АналитикаПолучателя.КлючАналитики, НЕОПРЕДЕЛЕНО) КАК КорАналитикаУчетаНоменклатуры,
		|	ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка) КАК КорВидЗапасов,
		|	(ВЫБОР 
		|		КОГДА ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) ТОГДА НЕОПРЕДЕЛЕНО
		|		ИНАЧЕ ДД.Регистратор КОНЕЦ) КАК ДокументИсточник,
		|	ДД.Назначение,
		|	ДД.Номенклатура,
		|	ДД.Характеристика,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка) КАК НалогообложениеПартии,
		|	ДД.НалогообложениеНДС,
		|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПустаяСсылка) КАК ХозяйственнаяОперация,
		|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) КАК СтатьяРасходовСписания,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивовПассивов,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаСписанияНДС
		|ИЗ
		|	РегистрНакопления.МатериалыИРаботыВПроизводстве КАК ДД
		|	ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаНоменклатуры КАК АналитикаПолучателя
		|		ПО АналитикаПолучателя.Номенклатура = ДД.Номенклатура
		|		И АналитикаПолучателя.Характеристика = ДД.Характеристика
		|		И АналитикаПолучателя.Серия = ДД.Серия
		|		И АналитикаПолучателя.МестоХранения = ДД.ПодразделениеПолучатель
		|		И АналитикаПолучателя.Назначение = ДД.Назначение
		|		И АналитикаПолучателя.СтатьяКалькуляции = ЗНАЧЕНИЕ(Справочник.СтатьиКалькуляции.ПустаяСсылка)
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И ДД.Регистратор ССЫЛКА Документ.ПеремещениеМатериаловВПроизводстве
		|СГРУППИРОВАТЬ ПО
		|	(ВЫБОР 
		|		КОГДА ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) ТОГДА 90
		|		ИНАЧЕ 10 КОНЕЦ),
		|	(ВЫБОР 
		|		КОГДА ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) ТОГДА ""Потребление""
		|		ИНАЧЕ ""Перемещение"" КОНЕЦ),
		|	ДД.ВидДвижения,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ЕСТЬNULL(АналитикаПолучателя.КлючАналитики, НЕОПРЕДЕЛЕНО),
		|	(ВЫБОР 
		|		КОГДА ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) ТОГДА НЕОПРЕДЕЛЕНО
		|		ИНАЧЕ ДД.Регистратор КОНЕЦ),
		|	ДД.Назначение,
		|	ДД.Номенклатура,
		|	ДД.Характеристика,
		|	ДД.НалогообложениеНДС
		|";
КонецФункции
//-- НЕ УТ

// КОНТУР ПартииТоваровПереданныеНаКомиссию
Функция ТекстОстаткиПереданныхТоваров()
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстОстаткиПереданныхТоваров"" КАК ЗапросИсточник,
		|	10 КАК Приоритет,
		|	""Остаток"" КАК ТипЗаписи,
		|	ИСТИНА КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПереданныеНаКомиссию) КАК РазделУчета,
		|	&НачалоПериода КАК Период,
		|	ДД.ДокументПоступления КАК Регистратор,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ДокументПоступления,
		|	ДД.ВидЗапасов,
		|	ДД.АналитикаУчетаПартий,
		|	0 КАК Знаменатель,
		|	ДД.КоличествоОстаток КАК Количество,
		|	ДД.СтоимостьОстаток КАК Стоимость,
		|	ДД.СтоимостьБезНДСОстаток КАК СтоимостьБезНДС,
		|	ДД.СтоимостьРеглОстаток КАК СтоимостьРегл,
		|	ДД.НДСРеглОстаток КАК НДСРегл,
		|	ДД.ПостояннаяРазницаОстаток КАК ПостояннаяРазница,
		|	ДД.ВременнаяРазницаОстаток КАК ВременнаяРазница,
		|	ИСТИНА КАК Первичное,
		|	ИСТИНА КАК СохранятьРегл,
		|	&НачалоПериода КАК ПериодПоступления,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КАК КорАналитикаУчетаНоменклатуры,
		|	ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка) КАК КорВидЗапасов,
		|	ДД.ДокументПередачиНаКомиссию КАК ДокументИсточник,
		|	ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка) КАК Назначение,
		|	ДД.АналитикаУчетаНоменклатуры.Номенклатура КАК Номенклатура,
		|	ДД.АналитикаУчетаНоменклатуры.Характеристика КАК Характеристика,
		|	ДД.АналитикаУчетаПартий.НалогообложениеНДС КАК НалогообложениеПартии,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка) КАК НалогообложениеНДС,
		|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПустаяСсылка) КАК ХозяйственнаяОперация,
		|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) КАК СтатьяРасходовСписания,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивовПассивов,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаСписанияНДС
		|ИЗ
		|	РегистрНакопления.ПартииТоваровПереданныеНаКомиссию.Остатки(&НачалоПериода, Организация В (&МассивОрганизаций)) КАК ДД
		|ГДЕ
		|	ДД.КоличествоОстаток > 0
		|";
КонецФункции

Функция ТекстВводыОстатковПереданныхТоваров()
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстВводыОстатковПереданныхТоваров"" КАК ЗапросИсточник,
		|	10 КАК Приоритет,
		|	""Остаток"" КАК ТипЗаписи,
		|	ИСТИНА КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПереданныеНаКомиссию) КАК РазделУчета,
		|	&НачалоПериода КАК Период,
		|	ДД.ДокументПоступления КАК Регистратор,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ДокументПоступления,
		|	ДД.ВидЗапасов,
		|	ДД.АналитикаУчетаПартий,
		|	0 КАК Знаменатель,
		|	ДД.Количество,
		|	ДД.Стоимость,
		|	ДД.СтоимостьБезНДС,
		|	ДД.СтоимостьРегл,
		|	ДД.НДСРегл,
		|	ДД.ПостояннаяРазница,
		|	ДД.ВременнаяРазница,
		|	ИСТИНА КАК Первичное,
		|	ИСТИНА КАК СохранятьРегл,
		|	&НачалоПериода КАК ПериодПоступления,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КАК КорАналитикаУчетаНоменклатуры,
		|	ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка) КАК КорВидЗапасов,
		|	ДД.ДокументПередачиНаКомиссию КАК ДокументИсточник,
		|	ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка) КАК Назначение,
		|	ДД.АналитикаУчетаНоменклатуры.Номенклатура КАК Номенклатура,
		|	ДД.АналитикаУчетаНоменклатуры.Характеристика КАК Характеристика,
		|	ДД.АналитикаУчетаПартий.НалогообложениеНДС КАК НалогообложениеПартии,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка) КАК НалогообложениеНДС,
		|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПустаяСсылка) КАК ХозяйственнаяОперация,
		|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) КАК СтатьяРасходовСписания,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивовПассивов,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаСписанияНДС
		|ИЗ
		|	РегистрНакопления.ПартииТоваровПереданныеНаКомиссию КАК ДД
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|	И ДД.Регистратор ССЫЛКА Документ.ВводОстатков
		|";
КонецФункции

Функция ТекстПередачиНаКомиссию()
	// передачи товаров на комиссию
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстПередачиНаКомиссию"" КАК ЗапросИсточник,
		|	10 КАК Приоритет,
		|	""Перемещение"" КАК ТипЗаписи,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ДД.ВидДвижения,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПереданныеНаКомиссию) КАК РазделУчета,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	НЕОПРЕДЕЛЕНО КАК ДокументПоступления,
		|	ДД.ВидЗапасов,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка) КАК АналитикаУчетаПартий,
		|	0 КАК Знаменатель,
		|	СУММА(ДД.Количество) КАК Количество,
		|	0 КАК Стоимость,
		|	0 КАК СтоимостьБезНДС,
		|	0 КАК СтоимостьРегл,
		|	0 КАК НДСРегл,
		|	0 КАК ПостояннаяРазница,
		|	0 КАК ВременнаяРазница,
		|	ЛОЖЬ КАК Первичное,
		|	ЛОЖЬ КАК СохранятьРегл,
		|	ДД.Период КАК ПериодПоступления,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КАК КорАналитикаУчетаНоменклатуры,
		|	ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка) КАК КорВидЗапасов,
		|	ДД.Регистратор КАК ДокументИсточник,
		|	ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка) КАК Назначение,
		|	ДД.Номенклатура,
		|	ДД.Характеристика,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка) КАК НалогообложениеПартии,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка) КАК НалогообложениеНДС,
		|	ДД.ХозяйственнаяОперация,
		|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) КАК СтатьяРасходовСписания,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивовПассивов,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаСписанияНДС
		|ИЗ
		|	РегистрНакопления.ТоварыПереданныеНаКомиссию КАК ДД
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|	И НЕ ДД.Регистратор ССЫЛКА Документ.ВводОстатков
		// сворачиваем строки, различающиеся номерами ГТД
		|СГРУППИРОВАТЬ ПО
		|	ДД.ВидДвижения,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов,
		|	ДД.Номенклатура,
		|	ДД.Характеристика,
		|	ДД.ХозяйственнаяОперация
		|";
КонецФункции

Функция ТекстВозвратыПереданныхТоваров()
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстВозвратыПереданныхТоваров"" КАК ЗапросИсточник,
		|	90 Приоритет,
		|	(ВЫБОР
		|		КОГДА Реализация.Дата >= &НачалоПериода ТОГДА ""ВозвратКомиссия""
		|		ИНАЧЕ ""Потребление"" КОНЕЦ) КАК ТипЗаписи,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ДД.ВидДвижения,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПереданныеНаКомиссию) КАК РазделУчета,
		|	ДД.Период,
		|	ДД.Регистратор, 
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	НЕОПРЕДЕЛЕНО КАК ДокументПоступления,
		|	ДД.ВидЗапасов,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка) КАК АналитикаУчетаПартий,
		|	0 КАК Знаменатель,
		|	СУММА(ДД.Количество) КАК Количество,
		|	0 КАК Стоимость,
		|	0 КАК СтоимостьБезНДС,
		|	0 КАК СтоимостьРегл,
		|	0 КАК НДСРегл,
		|	0 КАК ПостояннаяРазница,
		|	0 КАК ВременнаяРазница,
		|	ЛОЖЬ КАК Первичное,
		|	ЛОЖЬ КАК СохранятьРегл,
		|	ДД.Период КАК ПериодПоступления,
		|	ДД.КорАналитикаУчетаНоменклатуры КАК КорАналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов КАК КорВидЗапасов,
		|	ДД.ДокументРеализации КАК ДокументИсточник,
		|	ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка) КАК Назначение,
		|	ДД.Номенклатура,
		|	ДД.Характеристика,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка) КАК НалогообложениеПартии,
		|	ДД.НалогообложениеНДС,
		|	ДД.ХозяйственнаяОперация,
		|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) КАК СтатьяРасходовСписания,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивовПассивов,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаСписанияНДС
		|ИЗ
		|	РегистрНакопления.ТоварыПереданныеНаКомиссию КАК ДД
		|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.РеализацияТоваровУслуг КАК Реализация
		|		ПО Реализация.Ссылка = ДД.ДокументРеализации
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		|	И ДД.ХозяйственнаяОперация В (
		|		ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВозвратОтКомиссионера),
		|		ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВозвратПоКомиссииМеждуОрганизациями))
		// сворачиваем строки, различающиеся номерами ГТД
		|СГРУППИРОВАТЬ ПО
		|	(ВЫБОР
		|		КОГДА Реализация.Дата >= &НачалоПериода ТОГДА ""ВозвратКомиссия""
		|		ИНАЧЕ ""Потребление"" КОНЕЦ),
		|	ДД.ВидДвижения,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов,
		|	ДД.КорАналитикаУчетаНоменклатуры,
		|	ДД.ДокументРеализации,
		|	ДД.Номенклатура,
		|	ДД.Характеристика,
		|	ДД.НалогообложениеНДС,
		|	ДД.ХозяйственнаяОперация
		|";
КонецФункции
	
Функция ТекстВозвратыНаСкладПереданныхТоваров()
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстВозвратыНаСкладПереданныхТоваров"" КАК ЗапросИсточник,
		|	90 Приоритет,
		|	""Сторно"" КАК ТипЗаписи,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ДД.ВидДвижения,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыНаСкладах) КАК РазделУчета,
		|	ДД.Период,
		|	ДД.Регистратор, 
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	НЕОПРЕДЕЛЕНО КАК ДокументПоступления,
		|	ДД.ВидЗапасов,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка) КАК АналитикаУчетаПартий,
		|	0 КАК Знаменатель,
		|	СУММА(ДД.Количество) КАК Количество,
		|	0 КАК Стоимость,
		|	0 КАК СтоимостьБезНДС,
		|	0 КАК СтоимостьРегл,
		|	0 КАК НДСРегл,
		|	0 КАК ПостояннаяРазница,
		|	0 КАК ВременнаяРазница,
		|	ЛОЖЬ КАК Первичное,
		|	ЛОЖЬ КАК СохранятьРегл,
		|	ДД.Период КАК ПериодПоступления,
		|	ДД.КорАналитикаУчетаНоменклатуры,
		|	ДД.КорВидЗапасов,
		|	ДД.Регистратор КАК ДокументИсточник,
		|	ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка) КАК Назначение,
		|	ДД.Номенклатура,
		|	ДД.Характеристика,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка) КАК НалогообложениеПартии,
		|	ДД.НалогообложениеНДС,
		|	ДД.ХозяйственнаяОперация,
		|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) КАК СтатьяРасходовСписания,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивовПассивов,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаСписанияНДС
		|ИЗ
		|	РегистрНакопления.ТоварыОрганизаций КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ВидыЗапасов КАК СправочникВидыЗапасов
		|		ПО СправочникВидыЗапасов.Ссылка = ДД.ВидЗапасов
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		|	И ДД.Организация = ДД.ОрганизацияОтгрузки
		|	И ДД.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВозвратОтКомиссионера)
		|	И НЕ СправочникВидыЗапасов.РеализацияЗапасовДругойОрганизации
		// сворачиваем строки, различающиеся номерами ГТД
		|СГРУППИРОВАТЬ ПО
		|	ДД.ВидДвижения,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов,
		|	ДД.КорАналитикаУчетаНоменклатуры,
		|	ДД.КорВидЗапасов,
		|	ДД.ДокументРеализации,
		|	ДД.Номенклатура,
		|	ДД.Характеристика,
		|	ДД.НалогообложениеНДС,
		|	ДД.ХозяйственнаяОперация
		|";
КонецФункции

#КонецОбласти


#Область РасчетПартийПереданных

// Текст запроса исходных движений для расчета партий
// ПРИОРИТЕТ:
//	{10, Партия}, {10, Сторно}, {10, Перемещение}, {10, Перемещение/Собственные},
//	{80, Сторно/Чужие},
//	{90, Потребление}, {90, Потребление/Чужие}, {90, Потребление/Собственные}
// ПРИМЕЧАНИЯ:
//	ДокументПоступления - нужен для партий/остатков, приходных движений перемещений и для сторно
//	КорАналитикаУчетаНоменклатуры, КорВидЗапасов - нужны для расходных движений перемещений и для сторно.
Функция ДанныеДляПартийПереданных(НачалоПериода, ОкончаниеПериода, МассивОрганизаций)
	// СОРТИРОВКА по аналитикам, приоритету и моменту движения - требование алгоритма обсчета партий.
	ТекстСортировка = "
		|УПОРЯДОЧИТЬ ПО
		|	Номенклатура, Приоритет ВОЗР, ПериодПоступления, Регистратор
		|";
	ТекстИндексы = "
		|ИНДЕКСИРОВАТЬ ПО
		|	Номенклатура
		|";	
		
	ИсходныйТекстЗапроса =
		ТекстПартииПереданныхИнициализация() + ";" // вт ПрошлыеПоступления
		+ ТекстОписаниеПартийПереданных()
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстОстаткиПартийПереданных()  // использует ПрошлыеПоступления
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстНачальныеОстаткиПереданные()
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстПартииПереданные()
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстПартииВПути()
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстПартииВПутиРеализовано()
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстВозвратыКомиссионеров()
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстВозвратыМеждуОрганизациями()
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстОтчетыКомиссионеров()
		+ ТекстИндексы;
	МВТ = Новый МенеджерВременныхТаблиц;	
	ИсходныйЗапрос = Новый Запрос(СтрЗаменить(ИсходныйТекстЗапроса, "//ВоВременнуюТаблицу", ""));
	ИсходныйЗапрос.УстановитьПараметр("НачалоПериода", НачалоПериода);
	ИсходныйЗапрос.УстановитьПараметр("ОкончаниеПериода", ОкончаниеПериода);	
	ИсходныйЗапрос.УстановитьПараметр("МассивОрганизаций", МассивОрганизаций);	
	ИсходныйЗапрос.МенеджерВременныхТаблиц = МВТ;
	ИсходныйЗапрос.Выполнить();
	
	Запрос = Новый Запрос(ТекстОписаниеПартийПереданных());
	РасчетныеПартии = Запрос.Выполнить().Выгрузить();
	
	ВременнаяТаблицаДанныхПоОтбору("Номенклатура", ТекстСортировка, РасчетныеПартии, МВТ);

	Возврат МВТ;
КонецФункции

Функция РасчетныеПартииПереданные(ДанныеДляРасчета, Регистраторы, ЦепочкиДвижений = Неопределено, Тест = Ложь, КоличествоЗаписей = 0) // ДанныеДляРасчета будут изменены
	// Шаг 1: создаем буфер накопления рассчитанных партий
	Запрос = Новый Запрос(ТекстОписаниеПартийПереданных());
	РасчетныеПартии = Запрос.Выполнить().Выгрузить();
	КоличествоЗаписей = РасчетныеПартии.Количество();
	
	// Шаг 2: обсчитываем цепочки движений по передачам, возвратам, перемещениям, порчам, пересортицам и т.д.
	КонтекстЦепочек = ОписаниеЦепочек("Потребление, Партия, Остаток, Сторно, Возврат, ВПути");
	
	ПоляПотреблений = "РазделУчета, Организация, АналитикаУчетаНоменклатуры, ВидЗапасов";
	ДобавитьОписаниеПриемника(КонтекстЦепочек, "Потребление", ПоляПотреблений);
	ДобавитьОписаниеИсточника(КонтекстЦепочек, "Потребление", "Партия", ПоляПотреблений);
	ДобавитьОписаниеИсточника(КонтекстЦепочек, "Потребление", "ВПути", ПоляПотреблений);
	ДобавитьОписаниеИсточника(КонтекстЦепочек, "Потребление", "Остаток", ПоляПотреблений);
	ДобавитьОписаниеИсточника(КонтекстЦепочек, "Потребление", "Сторно", ПоляПотреблений);
	
	ДобавитьОписаниеПриемника(КонтекстЦепочек, "Сторно", "АналитикаУчетаНоменклатуры, ВидЗапасов");
	ДобавитьОписаниеИсточника(КонтекстЦепочек, "Сторно", "Партия", "АналитикаУчетаНоменклатуры, ВидЗапасов");
	
	ПоляВозврата = "РазделУчета, Организация, АналитикаУчетаНоменклатуры, ВидЗапасов, ДокументПоступления, ДокументПередачиНаКомиссию";
	ДобавитьОписаниеПриемника(КонтекстЦепочек, "Возврат", ПоляВозврата);
	ДобавитьОписаниеИсточника(КонтекстЦепочек, "Возврат", "Остаток", ПоляВозврата);
	ДобавитьОписаниеИсточника(КонтекстЦепочек, "Возврат", "Партия", ПоляВозврата);
	
	// Шаг 3: замена ложных партий на первичные партии в расчетных строках по результатам построение графа замен.
	КонтекстДвижений = ОписаниеДвижений(
		"ПартииТоваровПереданныеНаКомиссию",
		"ПартииТоваровПереданныеНаКомиссию",
		ПереченьПолей(РасчетныеПартии.Колонки),
		ПоляПотреблений,
		"Количество, Стоимость, СтоимостьБезНДС, СтоимостьРегл, НДСРегл, ПостояннаяРазница, ВременнаяРазница",
		"Количество", "Количество", "ДокументПередачиНаКомиссию", "Период");
	ЦепочкиДвижений(КонтекстЦепочек, ДанныеДляРасчета);
	РассчитатьПартииПоЦепочкам(КонтекстДвижений, ДанныеДляРасчета, РасчетныеПартии, Регистраторы, Тест);
	ЦепочкиДвижений = ДанныеДляРасчета;
	
	// Шаг 4: Удаляем нерассчитанные партии
	УдалитьНезаписываемыеСтроки(КонтекстДвижений.Контекст, РасчетныеПартии);
	
	Возврат РасчетныеПартии;
КонецФункции

Функция ТекстПартииПереданныхИнициализация()
	Возврат "
		|ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	ДД.ДокументПоступления КАК Ссылка
		|ПОМЕСТИТЬ ПрошлыеПоступленияОстатки
		|ИЗ
		|	РегистрНакопления.ПартииТоваровПереданныеНаКомиссию.Остатки(&НачалоПериода, Организация В (&МассивОрганизаций)) КАК ДД
		|ГДЕ
		|	ДД.ДокументПоступления <> НЕОПРЕДЕЛЕНО
		|;
		|ВЫБРАТЬ
		|	ПрошлыеПоступления.Ссылка,
		|	МАКСИМУМ(Периодика.Период) КАК Период
		|ПОМЕСТИТЬ ПрошлыеПоступления
		|ИЗ
		|	ПрошлыеПоступленияОстатки КАК ПрошлыеПоступления
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрНакопления.ПартииТоваровПереданныеНаКомиссию КАК Периодика
		|		ПО Периодика.Период < &НачалоПериода
		|		И Периодика.ДокументПоступления = ПрошлыеПоступления.Ссылка
		|СГРУППИРОВАТЬ ПО
		|	ПрошлыеПоступления.Ссылка
		|ИНДЕКСИРОВАТЬ ПО
		|	Ссылка
		|";
КонецФункции

Функция ТекстОписаниеПартийПереданных()
	Возврат "
		|ВЫБРАТЬ ПЕРВЫЕ 0
		|	""ТекстОписаниеПартийПереданных_ХХХХХХХХХХХХХХ"" КАК ЗапросИсточник,
		|	0 КАК Приоритет,
		|	""ХХХХХХХХХХХХХХХХ"" КАК ТипЗаписи,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КАК РазделУчета,
		|	ДАТАВРЕМЯ(1, 1, 1, 0, 0, 0) КАК Период,
		|	ДД.Регистратор,
		|	ЗНАЧЕНИЕ(Справочник.Организации.ПустаяСсылка) КАК Организация,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КАК АналитикаУчетаНоменклатуры,
		|	ДД.ДокументПоступления,
		|	ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка) КАК ВидЗапасов,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка) КАК АналитикаУчетаПартий,
		|	ДД.ДокументПередачиНаКомиссию,
		|	0 КАК Количество,
		|	0 КАК Стоимость,
		|	0 КАК СтоимостьБезНДС,
		|	0 КАК СтоимостьРегл,
		|	0 КАК НДСРегл,
		|	0 КАК ПостояннаяРазница,
		|	0 КАК ВременнаяРазница,
		|	ДАТАВРЕМЯ(1, 1, 1, 0, 0, 0) КАК ПериодПоступления,
		|	ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка) КАК Номенклатура,
		|	ЗНАЧЕНИЕ(Справочник.ХарактеристикиНоменклатуры.ПустаяСсылка) КАК Характеристика,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка) КАК НалогообложениеНДС,
		|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПустаяСсылка) КАК ХозяйственнаяОперация,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КАК КорАналитикаУчетаНоменклатуры
		|//ВоВременнуюТаблицу ПОМЕСТИТЬ ИсходныеДанные
		|ИЗ
		|	РегистрНакопления.ПартииТоваровПереданныеНаКомиссию КАК ДД
		|";
КонецФункции

Функция ТекстОстаткиПартийПереданных() // использует ПрошлыеПоступления
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстОстаткиПартийПереданных"" КАК ЗапросИсточник,
		|	10 КАК Приоритет,
		|	""Остаток"" КАК ТипЗаписи,
		|	ИСТИНА КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПереданныеНаКомиссию) КАК РазделУчета,
		|	Периодика.Период КАК Период,
		|	ДД.ДокументПоступления КАК Регистратор,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ДокументПоступления,
		|	ДД.ВидЗапасов,
		|	ДД.АналитикаУчетаПартий,
		|	ДД.ДокументПередачиНаКомиссию,
		|	ДД.КоличествоОстаток КАК Количество,
		|	ДД.СтоимостьОстаток КАК Стоимость,
		|	ДД.СтоимостьБезНДСОстаток КАК СтоимостьБезНДС,
		|	ДД.СтоимостьРеглОстаток КАК СтоимостьРегл,
		|	ДД.НДСРеглОстаток КАК НДСРегл,
		|	ДД.ПостояннаяРазницаОстаток КАК ПостояннаяРазница,
		|	ДД.ВременнаяРазницаОстаток КАК ВременнаяРазница,
		|	Периодика.Период КАК ПериодПоступления,
		|	ДД.АналитикаУчетаНоменклатуры.Номенклатура КАК Номенклатура,
		|	ДД.АналитикаУчетаНоменклатуры.Характеристика КАК Характеристика,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка) КАК НалогообложениеНДС,
		|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПустаяСсылка) КАК ХозяйственнаяОперация,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КАК КорАналитикаУчетаНоменклатуры
		|ИЗ
		|	РегистрНакопления.ПартииТоваровПереданныеНаКомиссию.Остатки(&НачалоПериода, Организация В (&МассивОрганизаций)) КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ПрошлыеПоступления КАК Периодика
		|		ПО Периодика.Ссылка = ДД.ДокументПоступления
		|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.РеализацияТоваровУслуг КАК Отгрузки
		|		ПО Отгрузки.Ссылка = ДД.ДокументПередачиНаКомиссию
		|		И Отгрузки.ХозяйственнаяОперация В (
		|			ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РеализацияБезПереходаПраваСобственности),
		|			ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РеализацияЧерезКомиссионераБезПереходаПраваСобственности))
		|ГДЕ
		|	ДД.КоличествоОстаток > 0
		|	И Отгрузки.Ссылка ЕСТЬ NULL
		|";
КонецФункции

Функция ТекстНачальныеОстаткиПереданные()
	Возврат "
		// Ввод начальных остатков
		|ВЫБРАТЬ
		|	""ТекстНачальныеОстаткиПереданные"" КАК ЗапросИсточник,
		|	10 КАК Приоритет,
		|	""Партия"" КАК ТипЗаписи,
		|	ИСТИНА КАК РасчетЗавершен,
		|	ДД.ВидДвижения КАК ВидДвижения,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПереданныеНаКомиссию) КАК РазделУчета,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ДокументПоступления,
		|	ДД.ВидЗапасов,
		|	ДД.АналитикаУчетаПартий,
		|	ДД.ДокументПередачиНаКомиссию,
		|	ДД.Количество,
		|	ДД.Стоимость,
		|	ДД.СтоимостьБезНДС,
		|	ДД.СтоимостьРегл,
		|	ДД.НДСРегл,
		|	ДД.ПостояннаяРазница,
		|	ДД.ВременнаяРазница,
		|	ДД.Период КАК ПериодПоступления,
		|	ДД.Номенклатура,
		|	ДД.Характеристика,
		|	ДД.НалогообложениеНДС,
		|	ДД.ХозяйственнаяОперация,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КАК КорАналитикаУчетаНоменклатуры
		|ИЗ
		|	РегистрНакопления.ПартииТоваровПереданныеНаКомиссию КАК ДД
		|	ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ТоварыОрганизаций КАК Товары
		|		ПО Товары.Регистратор = ДД.Регистратор
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|	И ДД.Регистратор = ДД.ДокументПоступления
		|	И Товары.Регистратор ЕСТЬ NULL
		|";
КонецФункции

Функция ТекстПартииПереданные()
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстПартииПереданные"" КАК ЗапросИсточник,
		|	10 КАК Приоритет,
		|	""Партия"" КАК ТипЗаписи,
		|	ИСТИНА КАК РасчетЗавершен,
		|	ДД.ВидДвижения,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПереданныеНаКомиссию) КАК РазделУчета,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	Партии.ДокументПоступления,
		|	ДД.ВидЗапасов,
		|	Партии.АналитикаУчетаПартий,
		|	Партии.Регистратор КАК ДокументПередачиНаКомиссию,
		|	СУММА(Партии.Количество) / КОЛИЧЕСТВО(РАЗЛИЧНЫЕ ДД.НомерСтроки) КАК Количество,
		|	СУММА(Партии.Стоимость) / КОЛИЧЕСТВО(РАЗЛИЧНЫЕ ДД.НомерСтроки) КАК Стоимость,
		|	СУММА(Партии.СтоимостьБезНДС) / КОЛИЧЕСТВО(РАЗЛИЧНЫЕ ДД.НомерСтроки) КАК СтоимостьБезНДС,
		|	СУММА(Партии.СтоимостьРегл) / КОЛИЧЕСТВО(РАЗЛИЧНЫЕ ДД.НомерСтроки) КАК СтоимостьРегл,
		|	СУММА(Партии.НДСРегл) / КОЛИЧЕСТВО(РАЗЛИЧНЫЕ ДД.НомерСтроки) КАК НДСРегл,
		|	СУММА(Партии.ПостояннаяРазница) / КОЛИЧЕСТВО(РАЗЛИЧНЫЕ ДД.НомерСтроки) КАК ПостояннаяРазница,
		|	СУММА(Партии.ВременнаяРазница) / КОЛИЧЕСТВО(РАЗЛИЧНЫЕ ДД.НомерСтроки) КАК ВременнаяРазница,
		|	ДД.Период КАК ПериодПоступления,
		|	ДД.Номенклатура,
		|	ДД.Характеристика,
		|	ДД.НалогообложениеНДС,
		|	ДД.ХозяйственнаяОперация,
		|	ДД.КорАналитикаУчетаНоменклатуры
		|ИЗ
		|	РегистрНакопления.ТоварыПереданныеНаКомиссию КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрНакопления.ПартииТоваровОрганизаций КАК Партии
		|		ПО Партии.Регистратор = ДД.Регистратор
		|		И Партии.АналитикаУчетаНоменклатуры = ДД.КорАналитикаУчетаНоменклатуры
		|		И Партии.ВидЗапасов = ДД.ВидЗапасов
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|	И Партии.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И Партии.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		|	И Партии.Количество > 0
		|	И НЕ Партии.Первичное
		// сворачиваем строки, различающиеся номерами ГТД
		|СГРУППИРОВАТЬ ПО
		|	ДД.ВидДвижения,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	Партии.ДокументПоступления,
		|	ДД.ВидЗапасов,
		|	Партии.АналитикаУчетаПартий,
		|	Партии.Регистратор,
		|	ДД.Номенклатура,
		|	ДД.Характеристика,
		|	ДД.НалогообложениеНДС,
		|	ДД.ХозяйственнаяОперация,
		|	ДД.КорАналитикаУчетаНоменклатуры
		|";
КонецФункции

Функция ТекстПартииВПути()
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстПартииВПути"" КАК ЗапросИсточник,
		|	10 КАК Приоритет,
		|	(ВЫБОР
		|		КОГДА Отгрузки.ДатаПереходаПраваСобственности МЕЖДУ &НачалоПериода И &ОкончаниеПериода ТОГДА ""ВПути""
		|		ИНАЧЕ ""Партия"" КОНЕЦ) КАК ТипЗаписи,
		|	ИСТИНА КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыВПути) КАК РазделУчета,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.КорАналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
		|	ДД.ДокументПоступления,
		|	ДД.ВидЗапасов,
		|	ДД.АналитикаУчетаПартий,
		|	ДД.Регистратор КАК ДокументПередачиНаКомиссию,
		|	СУММА(ДД.Количество) КАК Количество,
		|	СУММА(ДД.Стоимость) КАК Стоимость,
		|	СУММА(ДД.СтоимостьБезНДС) КАК СтоимостьБезНДС,
		|	СУММА(ДД.СтоимостьРегл) КАК СтоимостьРегл,
		|	СУММА(ДД.НДСРегл) КАК НДСРегл,
		|	СУММА(ДД.ПостояннаяРазница) КАК ПостояннаяРазница,
		|	СУММА(ДД.ВременнаяРазница) КАК ВременнаяРазница,
		|	ДД.Период КАК ПериодПоступления,
		|	ДД.Номенклатура,
		|	ДД.Характеристика,
		|	ДД.НалогообложениеНДС,
		|	ДД.ХозяйственнаяОперация,
		|	ДД.АналитикаУчетаНоменклатуры КАК КорАналитикаУчетаНоменклатуры
		|ИЗ
		|	РегистрНакопления.ПартииТоваровОрганизаций КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.РеализацияТоваровУслуг КАК Отгрузки
		|		ПО Отгрузки.Ссылка = ДД.Регистратор
		|ГДЕ
		|	(ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|		ИЛИ Отгрузки.ДатаПереходаПраваСобственности МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|		ИЛИ Отгрузки.ДатаПереходаПраваСобственности = ДАТАВРЕМЯ(1,1,1))
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		|	И Отгрузки.ХозяйственнаяОперация В (
		|		ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РеализацияБезПереходаПраваСобственности),
		|		ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РеализацияЧерезКомиссионераБезПереходаПраваСобственности))
		// сворачиваем строки, различающиеся номерами ГТД
		|СГРУППИРОВАТЬ ПО
		|	(ВЫБОР
		|		КОГДА Отгрузки.ДатаПереходаПраваСобственности МЕЖДУ &НачалоПериода И &ОкончаниеПериода ТОГДА ""ВПути""
		|		ИНАЧЕ ""Партия"" КОНЕЦ),
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ДокументПоступления,
		|	ДД.ВидЗапасов,
		|	ДД.АналитикаУчетаПартий,
		|	ДД.Регистратор,
		|	ДД.Номенклатура,
		|	ДД.Характеристика,
		|	ДД.НалогообложениеНДС,
		|	ДД.ХозяйственнаяОперация,
		|	ДД.КорАналитикаУчетаНоменклатуры
		|";
КонецФункции

Функция ТекстПартииВПутиРеализовано()
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстПартииВПутиРеализовано"" КАК ЗапросИсточник,
		|	90 КАК Приоритет,
		|	""Потребление"" КАК ТипЗаписи,
		|	ИСТИНА КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) КАК ВидДвижения,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыВПути) КАК РазделУчета,
		|	Отгрузки.ДатаПереходаПраваСобственности КАК Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.КорАналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
		|	ДД.ДокументПоступления,
		|	ДД.ВидЗапасов,
		|	ДД.АналитикаУчетаПартий,
		|	ДД.Регистратор КАК ДокументПередачиНаКомиссию,
		|	СУММА(ДД.Количество) КАК Количество,
		|	СУММА(ДД.Стоимость) КАК Стоимость,
		|	СУММА(ДД.СтоимостьБезНДС) КАК СтоимостьБезНДС,
		|	СУММА(ДД.СтоимостьРегл) КАК СтоимостьРегл,
		|	СУММА(ДД.НДСРегл) КАК НДСРегл,
		|	СУММА(ДД.ПостояннаяРазница) КАК ПостояннаяРазница,
		|	СУММА(ДД.ВременнаяРазница) КАК ВременнаяРазница,
		|	Отгрузки.ДатаПереходаПраваСобственности КАК ПериодПоступления,
		|	ДД.Номенклатура,
		|	ДД.Характеристика,
		|	НЕОПРЕДЕЛЕНО КАК НалогообложениеНДС,
		|	ДД.ХозяйственнаяОперация,
		|	ДД.АналитикаУчетаНоменклатуры КАК КорАналитикаУчетаНоменклатуры
		|ИЗ
		|	РегистрНакопления.ПартииТоваровОрганизаций КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.РеализацияТоваровУслуг КАК Отгрузки
		|		ПО Отгрузки.Ссылка = ДД.Регистратор
		|ГДЕ
		|	(Отгрузки.ДатаПереходаПраваСобственности МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|		ИЛИ ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода)
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		|	И Отгрузки.ХозяйственнаяОперация В (
		|		ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РеализацияБезПереходаПраваСобственности),
		|		ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РеализацияЧерезКомиссионераБезПереходаПраваСобственности))
		|	И Отгрузки.Статус = ЗНАЧЕНИЕ(Перечисление.СтатусыРеализацийТоваровУслуг.Отгружено)
		// сворачиваем строки, различающиеся номерами ГТД
		|СГРУППИРОВАТЬ ПО
		|	Отгрузки.ДатаПереходаПраваСобственности,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ДокументПоступления,
		|	ДД.ВидЗапасов,
		|	ДД.АналитикаУчетаПартий,
		|	ДД.Регистратор,
		|	ДД.Номенклатура,
		|	ДД.Характеристика,
		|	ДД.ХозяйственнаяОперация,
		|	ДД.КорАналитикаУчетаНоменклатуры
		|";
КонецФункции

Функция ТекстВозвратыКомиссионеров()
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстВозвратыКомиссионеров"" КАК ЗапросИсточник,
		|	45 КАК Приоритет,
		|	""Возврат"" КАК ТипЗаписи,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ДД.ВидДвижения,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПереданныеНаКомиссию) КАК РазделУчета,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	Партии.ДокументПоступления,
		|	ДД.ВидЗапасов,
		|	Партии.АналитикаУчетаПартий,
		|	Партии.ДокументИсточник КАК ДокументПередачиНаКомиссию,
		|	- СУММА(Партии.Количество) / КОЛИЧЕСТВО(РАЗЛИЧНЫЕ ДД.НомерСтроки) КАК Количество,
		|	- СУММА(Партии.Стоимость) / КОЛИЧЕСТВО(РАЗЛИЧНЫЕ ДД.НомерСтроки) КАК Стоимость,
		|	- СУММА(Партии.СтоимостьБезНДС) / КОЛИЧЕСТВО(РАЗЛИЧНЫЕ ДД.НомерСтроки) КАК СтоимостьБезНДС,
		|	- СУММА(Партии.СтоимостьРегл) / КОЛИЧЕСТВО(РАЗЛИЧНЫЕ ДД.НомерСтроки) КАК СтоимостьРегл,
		|	- СУММА(Партии.НДСРегл) / КОЛИЧЕСТВО(РАЗЛИЧНЫЕ ДД.НомерСтроки) КАК НДСРегл,
		|	- СУММА(Партии.ПостояннаяРазница) / КОЛИЧЕСТВО(РАЗЛИЧНЫЕ ДД.НомерСтроки) КАК ПостояннаяРазница,
		|	- СУММА(Партии.ВременнаяРазница) / КОЛИЧЕСТВО(РАЗЛИЧНЫЕ ДД.НомерСтроки) КАК ВременнаяРазница,
		|	ДАТАВРЕМЯ(1, 1, 1, 0, 0, 0) КАК ПериодПоступления,
		|	ДД.Номенклатура,
		|	ДД.Характеристика,
		|	ДД.НалогообложениеНДС,
		|	ДД.ХозяйственнаяОперация,
		|	ДД.КорАналитикаУчетаНоменклатуры
		|ИЗ
		|	РегистрНакопления.ТоварыПереданныеНаКомиссию КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрНакопления.ПартииТоваровОрганизаций КАК Партии
		|		ПО Партии.Регистратор = ДД.Регистратор
		|		И Партии.КорАналитикаУчетаНоменклатуры = ДД.АналитикаУчетаНоменклатуры
		|		И Партии.КорВидЗапасов = ДД.ВидЗапасов
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		|	И НЕ ДД.Регистратор ССЫЛКА Документ.ВозвратТоваровМеждуОрганизациями
		|	И Партии.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И Партии.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		|	И Партии.Количество < 0
		// сворачиваем строки, различающиеся номерами ГТД
		|СГРУППИРОВАТЬ ПО
		|	(НЕ Партии.Первичное),
		|	ДД.ВидДвижения,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	Партии.ДокументПоступления,
		|	ДД.ВидЗапасов,
		|	Партии.АналитикаУчетаПартий,
		|	Партии.ДокументИсточник,
		|	ДД.Номенклатура,
		|	ДД.Характеристика,
		|	ДД.НалогообложениеНДС,
		|	ДД.ХозяйственнаяОперация,
		|	ДД.КорАналитикаУчетаНоменклатуры
		|";
КонецФункции

Функция ТекстВозвратыМеждуОрганизациями()
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстВозвратыМеждуОрганизациями"" КАК ЗапросИсточник,
		|	90 КАК Приоритет,
		|	""Возврат"" КАК ТипЗаписи,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ДД.ВидДвижения,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПереданныеНаКомиссию) КАК РазделУчета,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	Партии.ДокументПоступления,
		|	ДД.ВидЗапасов,
		|	Партии.АналитикаУчетаПартий,
		|	Партии.ДокументИсточник КАК ДокументПередачиНаКомиссию,
		|	СУММА(Партии.Количество) / КОЛИЧЕСТВО(РАЗЛИЧНЫЕ ДД.НомерСтроки) КАК Количество,
		|	СУММА(Партии.Стоимость) / КОЛИЧЕСТВО(РАЗЛИЧНЫЕ ДД.НомерСтроки) КАК Стоимость,
		|	СУММА(Партии.СтоимостьБезНДС) / КОЛИЧЕСТВО(РАЗЛИЧНЫЕ ДД.НомерСтроки) КАК СтоимостьБезНДС,
		|	СУММА(Партии.СтоимостьРегл) / КОЛИЧЕСТВО(РАЗЛИЧНЫЕ ДД.НомерСтроки) КАК СтоимостьРегл,
		|	СУММА(Партии.НДСРегл) / КОЛИЧЕСТВО(РАЗЛИЧНЫЕ ДД.НомерСтроки) КАК НДСРегл,
		|	СУММА(Партии.ПостояннаяРазница) / КОЛИЧЕСТВО(РАЗЛИЧНЫЕ ДД.НомерСтроки) КАК ПостояннаяРазница,
		|	СУММА(Партии.ВременнаяРазница) / КОЛИЧЕСТВО(РАЗЛИЧНЫЕ ДД.НомерСтроки) КАК ВременнаяРазница,
		|	Партии.ДокументПоступления.Дата КАК ПериодПоступления,
		|	ДД.Номенклатура,
		|	ДД.Характеристика,
		|	ДД.НалогообложениеНДС,
		|	ДД.ХозяйственнаяОперация,
		|	ДД.КорАналитикаУчетаНоменклатуры
		|ИЗ
		|	РегистрНакопления.ТоварыПереданныеНаКомиссию КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрНакопления.ПартииТоваровОрганизаций КАК Партии
		|		ПО Партии.Регистратор = ДД.Регистратор
		|		И Партии.КорАналитикаУчетаНоменклатуры = ДД.АналитикаУчетаНоменклатуры
		|		И Партии.КорВидЗапасов = ДД.ВидЗапасов
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		|	И ДД.Регистратор ССЫЛКА Документ.ВозвратТоваровМеждуОрганизациями
		// сворачиваем строки, различающиеся номерами ГТД
		|СГРУППИРОВАТЬ ПО
		|	ДД.ВидДвижения,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	Партии.ДокументПоступления,
		|	ДД.ВидЗапасов,
		|	Партии.АналитикаУчетаПартий,
		|	Партии.ДокументИсточник,
		|	ДД.Номенклатура,
		|	ДД.Характеристика,
		|	ДД.НалогообложениеНДС,
		|	ДД.ХозяйственнаяОперация,
		|	ДД.КорАналитикаУчетаНоменклатуры
		|";
КонецФункции
	
Функция ТекстОтчетыКомиссионеров()
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстОтчетыКомиссионеров"" КАК ЗапросИсточник,
		|	90 КАК Приоритет,
		|	ВЫБОР
		|		КОГДА СУММА(ДД.Количество) < 0
		|		ТОГДА ""Сторно""
		|		ИНАЧЕ ""Потребление""
		|	КОНЕЦ КАК ТипЗаписи,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) КАК ВидДвижения,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПереданныеНаКомиссию) КАК РазделУчета,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	НЕОПРЕДЕЛЕНО КАК ДокументПоступления,
		|	ДД.ВидЗапасов КАК ВидЗапасов,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка) КАК АналитикаУчетаПартий,
		|	НЕОПРЕДЕЛЕНО КАК ДокументПередачиНаКомиссию,
		|	СУММА(ДД.Количество) КАК Количество,
		|	0 КАК Стоимость,
		|	0 КАК СтоимостьБезНДС,
		|	0 КАК СтоимостьРегл,
		|	0 КАК НДСРегл,
		|	0 КАК ПостояннаяРазница,
		|	0 КАК ВременнаяРазница,
		|	ДД.Период КАК ПериодПоступления,
		|	ДД.Номенклатура,
		|	ДД.Характеристика,
		|	ДД.НалогообложениеНДС,
		|	ДД.ХозяйственнаяОперация,
		|	ДД.КорАналитикаУчетаНоменклатуры
		|ИЗ
		|	РегистрНакопления.ТоварыПереданныеНаКомиссию КАК ДД
		|	ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ТоварыОрганизаций КАК Товары
		|		ПО Товары.Регистратор = ДД.Регистратор
		|	ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ТоварыОрганизацийКПередаче КАК ТоварыКПередаче
		|		ПО ТоварыКПередаче.Регистратор = ДД.Регистратор
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		|	И Товары.Регистратор ЕСТЬ NULL
		|	И ТоварыКПередаче.Регистратор ЕСТЬ NULL
		|СГРУППИРОВАТЬ ПО
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов,
		|	ДД.Номенклатура,
		|	ДД.Характеристика,
		|	ДД.НалогообложениеНДС,
		|	ДД.ХозяйственнаяОперация,
		|	ДД.КорАналитикаУчетаНоменклатуры
		|";
КонецФункции

#КонецОбласти


#Область РасчетПартийЗатрат

Функция ДанныеДляПартийЗатрат(НачалоПериода, ОкончаниеПериода, МассивОрганизаций)
	ТекстСортировка = "
		|УПОРЯДОЧИТЬ ПО
		|	ДокументВыпуска, Период, Регистратор, Приоритет ВОЗР
		|";
	ТекстИндексы = "
		|ИНДЕКСИРОВАТЬ ПО
		|	ДокументВыпуска
		|";	
	// Выбираем приходные движения партий затрат, которые дальше будем двигать по партиям.
	ИсходныйТекстЗапроса =
		ТекстПартииЗатратИнициализация() + ";" // вт Выпуски
		+ ТекстОписаниеПартийЗатрат()
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстОстаткиПартийЗатрат() // использует Выпуски
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстПриходыСборокТоваров() // использует ПриходыСборок
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстПриходыСборокТоваровПолуфабрикаты() // использует Выпуски, ПриходыСборок
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстРасходыПартийЗатратПрошлыхМесяцев() // использует ПрошлыеРеализации
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстИтерацияПартийЗатрат()
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстИтерацияПартийЗатратКомиссия()
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстИтерацияПартийЗатратКомиссияВозврат()
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстДополнениеПартийЗатрат()
		//++ НЕ УТ
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстПриходыПартийЗатрат()
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстРасходыПрочихРасходовНЗП()
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстТрудозатратыНЗП()
		//++ НЕ УТКА
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстПартииНезавершенногоПроизводстваОтчетДавальцу()
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстОтчетДавальцу()
		//-- НЕ УТКА
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстИспользованныеПолуфабрикаты() // использует Выпуски
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстИтерацияПередачиВПроизводство()
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстИтерацияВыпускПродукции()
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстИтерацияРаботыИПеремещенияВПроизводстве()
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстПриходыПроизводственныхЗатрат()
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстПриходыПроизводственныхЗатратПрочее()
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстРаспределениеПроизводственныхЗатрат()
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстРаспределениеПроизводственныхЗатратПрочее()
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстВыпускИзПроизводственныхЗатрат()
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстСписаниеПроизводственныхЗатрат()
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстОтчетПереработчика()
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстОтчетПереработчикаРаспределение()
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстВозвратИзПроизводстваИЛИОтПереработчика()
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстВозвратИзПроизводстваИЛИОтПереработчикаНаСклад()
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстСписаниеВПроизводстве()
		//-- НЕ УТ
		+ ТекстИндексы;
	МВТ = Новый МенеджерВременныхТаблиц;	
	ИсходныйЗапрос = Новый Запрос(СтрЗаменить(ИсходныйТекстЗапроса, "//ВоВременнуюТаблицу", ""));
	ИсходныйЗапрос.УстановитьПараметр("НачалоПериода", НачалоПериода);
	ИсходныйЗапрос.УстановитьПараметр("ОкончаниеПериода", ОкончаниеПериода);	
	ИсходныйЗапрос.УстановитьПараметр("МассивОрганизаций", МассивОрганизаций);	
	ИсходныйЗапрос.УстановитьПараметр("Итерация", Ложь);
	ИсходныйЗапрос.УстановитьПараметр("СобственныеТипыЗапасов", РасчетСебестоимостиПрикладныеАлгоритмы.СобственныеТипыЗапасов());
	ИсходныйЗапрос.УстановитьПараметр("ЕстьФИФОСкользящая", ЕстьФИФОСкользящая(НачалоПериода, ОкончаниеПериода, МассивОрганизаций));
	ИсходныйЗапрос.МенеджерВременныхТаблиц = МВТ;
	ИсходныйЗапрос.Выполнить();
	
	Запрос = Новый Запрос(ТекстОписаниеПартийЗатрат());
	РасчетныеПартии = Запрос.Выполнить().Выгрузить();
	
	ВременнаяТаблицаДанныхПоОтбору("ДокументВыпуска", ТекстСортировка, РасчетныеПартии, МВТ);
	
	Возврат МВТ;
КонецФункции

Функция РасчетныеПартииЗатрат(ДанныеДляРасчета, Регистраторы, ЦепочкиДвижений = Неопределено, Тест = Ложь, РассчитатьПартии = Истина) // ДанныеДляРасчета будут изменены
	// Шаг 1: создаем буфер накопления рассчитанных партий
	Запрос = Новый Запрос(ТекстОписаниеПартийЗатрат());
	РасчетныеПартии = Запрос.Выполнить().Выгрузить();
	
	// Шаг 2: обсчитываем цепочки движений по передачам, возвратам, перемещениям, порчам, пересортицам и т.д.
	КонтекстЦепочек = ОписаниеЦепочек("Потребление, Перемещение, Партия, Остаток, Выпуск, Сторно, Замещение, Продукция, Передача, ПотреблениеВПути,
	|Сборка, Затраты, ЗатратыПрочие, Распределение, ВыпускПрочие, ВПути, Прочее, Списание, Прошлое");
	
	ПоляПотреблений = "РазделУчета, ДокументВыпуска, АналитикаУчетаПродукции, Организация, ДокументИсточник";
	ДобавитьОписаниеПриемника(КонтекстЦепочек, "Потребление", ПоляПотреблений);
	ДобавитьОписаниеИсточника(КонтекстЦепочек, "Потребление", "Партия", ПоляПотреблений);
	ДобавитьОписаниеИсточника(КонтекстЦепочек, "Потребление", "Остаток", ПоляПотреблений);
	ДобавитьОписаниеИсточника(КонтекстЦепочек, "Потребление", "Перемещение", ПоляПотреблений);
	ДобавитьОписаниеИсточника(КонтекстЦепочек, "Потребление", "Замещение", ПоляПотреблений);
	ДобавитьОписаниеИсточника(КонтекстЦепочек, "Потребление", "Выпуск", ПоляПотреблений);
	ДобавитьОписаниеИсточника(КонтекстЦепочек, "Потребление", "ВыпускПрочие", ПоляПотреблений);
	ДобавитьОписаниеИсточника(КонтекстЦепочек, "Потребление", "Передача", ПоляПотреблений);
	ДобавитьОписаниеИсточника(КонтекстЦепочек, "Потребление", "Сборка", ПоляПотреблений);
	ДобавитьОписаниеИсточника(КонтекстЦепочек, "Потребление", "Сторно", "РазделУчета, ДокументВыпуска, АналитикаУчетаПродукции, Организация, Регистратор");
	
	ДобавитьОписаниеПриемника(КонтекстЦепочек, "ПотреблениеВПути", "РазделУчета, ДокументВыпуска, АналитикаУчетаПродукции, Организация, Регистратор");
	ДобавитьОписаниеИсточника(КонтекстЦепочек, "ПотреблениеВПути", "Передача", "РазделУчета, ДокументВыпуска, АналитикаУчетаПродукции, Организация, Регистратор");
	ДобавитьОписаниеИсточника(КонтекстЦепочек, "ПотреблениеВПути", "Остаток", ПоляПотреблений);

	ДобавитьОписаниеПриемника(КонтекстЦепочек, "Перемещение", "Регистратор, АналитикаУчетаПродукции, ДокументВыпуска");
	ДобавитьОписаниеИсточника(КонтекстЦепочек, "Перемещение", "Потребление", "Регистратор, КорАналитикаУчетаПродукции, ДокументВыпуска");
	ДобавитьОписаниеИсточника(КонтекстЦепочек, "Перемещение", "Продукция", "Регистратор, КорАналитикаУчетаПродукции, ДокументВыпуска");
	
	ДобавитьОписаниеПриемника(КонтекстЦепочек, "Замещение", "ДокументИсточник, АналитикаУчетаПродукции");
	ДобавитьОписаниеИсточника(КонтекстЦепочек, "Замещение", "Потребление", "Регистратор, КорАналитикаУчетаПродукции");
	
	ДобавитьОписаниеПриемника(КонтекстЦепочек, "Передача", "Регистратор, КорАналитикаУчетаПродукции, ДокументВыпуска");
	ДобавитьОписаниеИсточника(КонтекстЦепочек, "Передача", "Потребление", "Регистратор, АналитикаУчетаПродукции, ДокументВыпуска");
	
	ДобавитьОписаниеПриемника(КонтекстЦепочек, "Выпуск", "ДокументИсточник, АналитикаУчетаПродукции, АналитикаУчетаНоменклатуры, ДокументПоступления, ВидЗапасов");
	ДобавитьОписаниеИсточника(КонтекстЦепочек, "Выпуск", "Потребление", "Регистратор, КорАналитикаУчетаПродукции, АналитикаУчетаПродукции, ДокументПоступления, КорВидЗапасов");
	ДобавитьОписаниеИсточника(КонтекстЦепочек, "Выпуск", "Продукция", "Регистратор, КорАналитикаУчетаПродукции, АналитикаУчетаПродукции, ДокументВыпуска, КорВидЗапасов");
	
	ДобавитьОписаниеПриемника(КонтекстЦепочек, "Сборка", "ДокументИсточник, АналитикаУчетаПродукции");
	ДобавитьОписаниеИсточника(КонтекстЦепочек, "Сборка", "Потребление", "Регистратор, КорАналитикаУчетаПродукции");
	
	ДобавитьОписаниеПриемника(КонтекстЦепочек, "Продукция", "ДокументИсточник, РазделУчета, ДокументВыпуска, АналитикаУчетаПродукции, Организация");
	ДобавитьОписаниеИсточника(КонтекстЦепочек, "Продукция", "Партия", "ДокументИсточник, РазделУчета, ДокументВыпуска, АналитикаУчетаПродукции, Организация");
	ДобавитьОписаниеИсточника(КонтекстЦепочек, "Продукция", "Остаток", "ДокументИсточник, РазделУчета, ДокументВыпуска, АналитикаУчетаПродукции, Организация");
	ДобавитьОписаниеИсточника(КонтекстЦепочек, "Продукция", "Перемещение", "ДокументИсточник, РазделУчета, ДокументВыпуска, АналитикаУчетаПродукции, Организация");
	ДобавитьОписаниеИсточника(КонтекстЦепочек, "Продукция", "Выпуск", "ДокументИсточник, РазделУчета, ДокументВыпуска, АналитикаУчетаПродукции, Организация");
	ДобавитьОписаниеИсточника(КонтекстЦепочек, "Продукция", "ВыпускПрочие", "ДокументИсточник, РазделУчета, ДокументВыпуска, АналитикаУчетаПродукции, Организация");
	
	ДобавитьОписаниеПриемника(КонтекстЦепочек, "Сторно", "ДокументИсточник, РазделУчета, КорАналитикаУчетаПродукции, ДокументВыпуска");
	ДобавитьОписаниеИсточника(КонтекстЦепочек, "Сторно", "Потребление", "Регистратор, РазделУчета, АналитикаУчетаПродукции, ДокументВыпуска");
	ДобавитьОписаниеИсточника(КонтекстЦепочек, "Сторно", "ПотреблениеВПути", "Регистратор, РазделУчета, КорАналитикаУчетаПродукции, ДокументВыпуска");
	ДобавитьОписаниеИсточника(КонтекстЦепочек, "Сторно", "Прошлое", "Регистратор, РазделУчета, АналитикаУчетаПродукции, ДокументВыпуска");
	
	ДобавитьОписаниеПриемника(КонтекстЦепочек, "ЗатратыПрочие", "ДокументИсточник, СтатьяРасходовСписания, АналитикаРасходов, ПодразделениеРасходов");
	ДобавитьОписаниеИсточника(КонтекстЦепочек, "ЗатратыПрочие", "Потребление", "Регистратор, СтатьяРасходовСписания, АналитикаРасходов, ПодразделениеРасходов");
	
	ДобавитьОписаниеПриемника(КонтекстЦепочек, "Распределение", "ДокументИсточник");
	ДобавитьОписаниеИсточника(КонтекстЦепочек, "Распределение", "Затраты", "Регистратор");
	ДобавитьОписаниеИсточника(КонтекстЦепочек, "Распределение", "ЗатратыПрочие", "Регистратор");
	
	ДобавитьОписаниеПриемника(КонтекстЦепочек, "Прочее", "Организация, СтатьяРасходовСписания, АналитикаРасходов, ПодразделениеРасходов");
	ДобавитьОписаниеИсточника(КонтекстЦепочек, "Прочее", "Затраты", "Организация, СтатьяРасходовСписания, АналитикаРасходов, ПодразделениеРасходов");
	ДобавитьОписаниеИсточника(КонтекстЦепочек, "Прочее", "ЗатратыПрочие", "Организация, СтатьяРасходовСписания, АналитикаРасходов, ПодразделениеРасходов");
	
	ДобавитьОписаниеПриемника(КонтекстЦепочек, "Списание", "Регистратор");
	ДобавитьОписаниеИсточника(КонтекстЦепочек, "Списание", "Прочее", "Регистратор");
	
	ДобавитьОписаниеПриемника(КонтекстЦепочек, "ВыпускПрочие", "ДокументИсточник, АналитикаУчетаПродукции, СтатьяРасходовСписания, АналитикаРасходов, ПодразделениеРасходов");
	ДобавитьОписаниеИсточника(КонтекстЦепочек, "ВыпускПрочие", "Распределение", "Регистратор, КорАналитикаУчетаПродукции, СтатьяРасходовСписания, АналитикаРасходов, ПодразделениеРасходов");
	
	// Шаг 4: замена ложных партий на первичные партии в расчетных строках по результатам построение графа замен.
	КонтекстДвижений = ОписаниеДвижений(
		"ПартииЗатратНаВыпуск",
		"ПартииЗатратНаВыпуск",
		ПереченьПолей(РасчетныеПартии.Колонки),
		ПоляПотреблений,
		"Знаменатель, Количество, Стоимость, СтоимостьБезНДС, СтоимостьРегл, НДСРегл, ПостояннаяРазница, ВременнаяРазница",
		"Знаменатель", "Знаменатель", "ДокументИсточник", "Период");
	КонтекстДвижений.Вставить("ЗаполнятьАналитикуПартий", Истина);
	КонтекстДвижений.Вставить("ПоляСуммирования", "Количество, Стоимость, СтоимостьБезНДС, СтоимостьРегл, НДСРегл, ПостояннаяРазница, ВременнаяРазница");
	КонтекстДвижений.Вставить("ПоляГруппировки", ПереченьПолей(РасчетныеПартии.Колонки, КонтекстДвижений.ПоляСуммирования));
	КонтекстДвижений.Вставить("УменьшатьБазис", Истина);
	ЦепочкиДвижений(КонтекстЦепочек, ДанныеДляРасчета);
	Если РассчитатьПартии Тогда
		РассчитатьПартииПоЦепочкам(КонтекстДвижений, ДанныеДляРасчета, РасчетныеПартии, Регистраторы, Тест);
	КонецЕсли;
	ЦепочкиДвижений = ДанныеДляРасчета;
	
	// Шаг 4: Удаляем нерассчитанные партии
	Если Не Тест Тогда
		УдалитьНезаписываемыеСтроки(КонтекстДвижений.Контекст, РасчетныеПартии);
	КонецЕсли;
	
	Возврат РасчетныеПартии;
КонецФункции

Функция ТекстПартииЗатратИнициализация() // вт ПрошлыеРеализации, Выпуски, ОстаткиПартийСборок, ПроизводственныеЗатраты, ДолиСтоимости, ВыпускиПродукции, ПриходыСборок, ПрошлыеПоступления, ИсключаемыеВыпуски
	Возврат "
		|ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	ДД.ДокументРеализации КАК ДокументРеализации,
		|	ДД.КорАналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры
		|ПОМЕСТИТЬ
		|	ПрошлыеРеализации
		|ИЗ
		|	РегистрНакопления.ТоварыОрганизаций КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрНакопления.ТоварыОрганизаций КАК Расход
		|		ПО Расход.Период < &НачалоПериода
		|		И Расход.Регистратор = ДД.ДокументРеализации
		|		И Расход.АналитикаУчетаНоменклатуры = ДД.КорАналитикаУчетаНоменклатуры
		|		И Расход.ВидЗапасов = ДД.КорВидЗапасов
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И ДД.ДокументРеализации <> НЕОПРЕДЕЛЕНО
		|	И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		|	И ДД.Количество < 0
		|	
		|ОБЪЕДИНИТЬ ВСЕ
		|ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	ДД.ДокументРеализации КАК ДокументРеализации,
		|	ДД.КорАналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры
		|ИЗ
		|	РегистрНакопления.ТоварыОрганизаций КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрНакопления.ТоварыОрганизацийКПередаче КАК Расход
		|		ПО Расход.Период < &НачалоПериода
		|		И Расход.Регистратор = ДД.ДокументРеализации
		|		И Расход.АналитикаУчетаНоменклатуры = ДД.КорАналитикаУчетаНоменклатуры
		|		И Расход.ВидЗапасовПродавца = ДД.КорВидЗапасов
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Активность
		|	И ДД.ДокументРеализации <> НЕОПРЕДЕЛЕНО
		|	И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		|	И ДД.Количество < 0
		|;
		// Документы и даты выпусков и сборок
		|ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	ДД.Регистратор,
		|	Аналитика.Номенклатура КАК Номенклатура,
		|	Аналитика.Характеристика КАК Характеристика,
		|	МАКСИМУМ(ДД.Период) КАК Период
		|ПОМЕСТИТЬ Выпуски
		|ИЗ (
		|	ВЫБРАТЬ РАЗЛИЧНЫЕ
		|		ДД.ДокументВыпуска КАК Регистратор,
		|		ДД.АналитикаУчетаПродукции КАК АналитикаУчетаПродукции,
		|		Приходы.Период
		|	ИЗ
		|		РегистрНакопления.ПартииЗатратНаВыпуск.Остатки(&НачалоПериода, Организация В (&МассивОрганизаций)) КАК ДД
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрНакопления.ПартииЗатратНаВыпуск КАК Приходы
		|			ПО Приходы.Период < &НачалоПериода
		|			И Приходы.Регистратор = ДД.ДокументВыпуска
		|			И Приходы.Регистратор = Приходы.ДокументВыпуска
		|
		//++ НЕ УТ
		|	ОБЪЕДИНИТЬ ВСЕ
		|	ВЫБРАТЬ РАЗЛИЧНЫЕ
		|		ДД.Регистратор,
		|		ДД.АналитикаУчетаНоменклатуры,
		|		ДД.Период
		|	ИЗ РегистрНакопления.ВыпускПродукции КАК ДД
		|	ГДЕ
		|		ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|		И ДД.Организация В (&МассивОрганизаций)
		|		И ДД.Активность
		//-- НЕ УТ
		|
		|	ОБЪЕДИНИТЬ ВСЕ
		|	ВЫБРАТЬ РАЗЛИЧНЫЕ
		|		ДД.Регистратор,
		|		ДД.АналитикаУчетаНоменклатуры,
		|		ДД.Период
		|	ИЗ
		|		РегистрНакопления.ПартииТоваровОрганизаций КАК ДД
		|	ГДЕ
		|		ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|		И ДД.Организация В (&МассивОрганизаций)
		|		И ДД.Активность
		|		И ТИПЗНАЧЕНИЯ(ДД.Регистратор) В (ТИП(Документ.СборкаТоваров),
		|										ТИП(Документ.ПересортицаТоваров),
		|										ТИП(Документ.ПорчаТоваров))
		|		И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|) КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК Аналитика
		|		ПО Аналитика.Ссылка = ДД.АналитикаУчетаПродукции
		|СГРУППИРОВАТЬ ПО
		|	Аналитика.Номенклатура,
		|	Аналитика.Характеристика,
		|	ДД.Регистратор
		|;
		// Остатки партионных регистров на начало
		|ВЫБРАТЬ
		|	Партии.Организация,
		|	Партии.АналитикаУчетаНоменклатуры,
		|	Партии.ДокументПоступления,
		|	СУММА(Партии.Количество) КАК Количество
		|ПОМЕСТИТЬ
		|	ОстаткиПартийСборок
		|ИЗ (
		|	ВЫБРАТЬ
		|		ДД.Организация,
		|		ДД.АналитикаУчетаНоменклатуры,
		|		ДД.ДокументПоступления,
		|		ДД.КоличествоОстаток КАК Количество
		|	ИЗ
		|		РегистрНакопления.ПартииТоваровОрганизаций.Остатки(&НачалоПериода, Организация В (&МассивОрганизаций)) КАК ДД
		|
		|	ОБЪЕДИНИТЬ ВСЕ
		|	ВЫБРАТЬ
		|		ДД.Организация,
		|		ДД.АналитикаУчетаНоменклатуры,
		|		ДД.ДокументПоступления,
		|		ДД.КоличествоОстаток КАК Количество
		|	ИЗ
		|		РегистрНакопления.ПартииТоваровПереданныеНаКомиссию.Остатки(&НачалоПериода, Организация В (&МассивОрганизаций)) КАК ДД
		|
		|	ОБЪЕДИНИТЬ ВСЕ
		|	ВЫБРАТЬ
		|		ДД.Организация,
		|		ДД.АналитикаУчетаНоменклатуры,
		|		ДД.ДокументПоступления,
		|		ДД.КоличествоОстаток КАК Количество
		|	ИЗ
		|		РегистрНакопления.ПартииПроизводственныхЗатрат.Остатки(&НачалоПериода, Организация В (&МассивОрганизаций)) КАК ДД
		|
		//++ НЕ УТ
		|	ОБЪЕДИНИТЬ ВСЕ
		|	ВЫБРАТЬ
		|		ДД.Организация,
		|		ДД.АналитикаУчетаНоменклатуры,
		|		ДД.ДокументПоступления,
		|		ДД.КоличествоОстаток КАК Количество
		|	ИЗ
		|		РегистрНакопления.ПартииНезавершенногоПроизводства.Остатки(&НачалоПериода, Организация В (&МассивОрганизаций)) КАК ДД
		//-- НЕ УТ
		|	) КАК Партии
		|СГРУППИРОВАТЬ ПО
		|	Партии.Организация,
		|	Партии.АналитикаУчетаНоменклатуры,
		|	Партии.ДокументПоступления
		|;
		// Документы передачи в производство и возврата из производства
		|ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	ДД.Регистратор КАК Регистратор
		|ПОМЕСТИТЬ
		|	МатериалыИРаботыВПроизводстве
		|ИЗ
		|	РегистрНакопления.МатериалыИРаботыВПроизводстве КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Номенклатура КАК Товары
		|		ПО Товары.Ссылка = ДД.АналитикаУчетаНоменклатуры.Номенклатура
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И Товары.ТипНоменклатуры <> ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.Работа)
		|ИНДЕКСИРОВАТЬ ПО
		|	ДД.Регистратор
		|;
		//++ НЕ УТ

		// Доли распределения производственных затрат
		|ВЫБРАТЬ
		|	ДД.Организация,
		|	ДД.СтатьяРасходов,
		|	ДД.АналитикаРасходов,
		|	ДД.НаправлениеДеятельности,
		|	ДД.Подразделение КАК ПодразделениеРасходов,
		|	ДД.Дата КАК Период,
		|	ДД.Ссылка КАК Регистратор,
		|	ВЫБОР 
		|		КОГДА ДД.ДоляСтоимостиНаПроизводство = 0 
		|				И ДД.ВсегоДолейСтоимости = 0
		|			ТОГДА 100 
		|		ИНАЧЕ 
		|			ДД.ДоляСтоимостиНаПроизводство 
		|	КОНЕЦ + ДД.ДоляСтоимостиНаСтатьи КАК ДоляСтоимости
		|ПОМЕСТИТЬ
		|	ДолиСтоимости
		|ИЗ 
		|	Документ.РаспределениеПрочихЗатрат КАК ДД
		|ГДЕ
		|	ДД.Дата МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Проведен
		|;
		|ВЫБРАТЬ
		|	ДД.Регистратор,
		|	(ВЫБОР
		|		КОГДА ДД.АналитикаУчетаПродукции <> ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка)
		|			ТОГДА ДД.АналитикаУчетаПродукции
		|		ИНАЧЕ ДД.АналитикаУчетаНоменклатуры КОНЕЦ) КАК АналитикаУчетаПродукции,
		|	ДД.ВидЗапасов,
		|	СУММА(ДД.Количество) КАК Количество
		|ПОМЕСТИТЬ
		|	ВыпускиПродукции
		|ИЗ
		|	РегистрНакопления.ВыпускПродукции КАК ДД
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Активность
		|СГРУППИРОВАТЬ ПО
		|	ДД.Регистратор,
		|	(ВЫБОР
		|		КОГДА ДД.АналитикаУчетаПродукции <> ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка)
		|			ТОГДА ДД.АналитикаУчетаПродукции
		|		ИНАЧЕ ДД.АналитикаУчетаНоменклатуры КОНЕЦ),
		|	ДД.ВидЗапасов
		|;
		//-- НЕ УТ

		// Поступления комплектов сборок товаров
		|ВЫБРАТЬ
		|	ДД.Регистратор,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов,
		|	ДД.АналитикаУчетаПартий,
		|	ДД.ДокументИсточник,
		|	СУММА(ДД.Количество) КАК Количество
		|ПОМЕСТИТЬ
		|	ПриходыСборок
		|ИЗ
		|	РегистрНакопления.ПартииТоваровОрганизаций КАК ДД
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И ДД.Регистратор ССЫЛКА Документ.СборкаТоваров
		|	И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|СГРУППИРОВАТЬ ПО
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов,
		|	ДД.АналитикаУчетаПартий,
		|	ДД.ДокументИсточник
		|;
		|ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	ДД.ДокументПоступления КАК Ссылка,
		|	ДД.Склад КАК Склад,
		|	МАКСИМУМ(ДД.Регистратор) КАК Регистратор,
		|	МАКСИМУМ(ДД.Период) КАК Период
		|ПОМЕСТИТЬ
		|	ПрошлыеПоступления
		|ИЗ (
		|	ВЫБРАТЬ РАЗЛИЧНЫЕ
		|		ДД.ДокументПоступления,
		|		ДД.АналитикаУчетаНоменклатуры.МестоХранения КАК Склад,
		|		МАКСИМУМ(Периодика.Регистратор) КАК Регистратор,
		|		МАКСИМУМ(Периодика.Период) КАК Период
		|	ИЗ
		|		РегистрНакопления.ПартииПроизводственныхЗатрат.Остатки(&НачалоПериода, Организация В (&МассивОрганизаций)) КАК ДД
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрНакопления.ПартииПроизводственныхЗатрат КАК Периодика
		|			ПО Периодика.Период < &НачалоПериода
		|			И Периодика.ДокументПоступления = ДД.ДокументПоступления
		|			И Периодика.АналитикаУчетаНоменклатуры.МестоХранения = ДД.АналитикаУчетаНоменклатуры.МестоХранения
		|	ГДЕ
		|		ДД.ДокументПоступления <> НЕОПРЕДЕЛЕНО
		|		И Периодика.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|		И Периодика.Количество > 0
		|	СГРУППИРОВАТЬ ПО
		|		ДД.ДокументПоступления,
		|		ДД.АналитикаУчетаНоменклатуры.МестоХранения
		|
		//++ НЕ УТ
		|	ОБЪЕДИНИТЬ ВСЕ
		|	ВЫБРАТЬ РАЗЛИЧНЫЕ
		|		ДД.ДокументПоступления,
		|		ДД.АналитикаУчетаНоменклатуры.МестоХранения КАК Склад,
		|		МАКСИМУМ(Периодика.Регистратор) КАК Регистратор,
		|		МАКСИМУМ(Периодика.Период) КАК Период
		|	ИЗ
		|		РегистрНакопления.ПартииНезавершенногоПроизводства.Остатки(&НачалоПериода, Организация В (&МассивОрганизаций)) КАК ДД
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрНакопления.ПартииПроизводственныхЗатрат КАК Периодика
		|			ПО Периодика.Период < &НачалоПериода
		|			И Периодика.ДокументПоступления = ДД.ДокументПоступления
		|			И Периодика.АналитикаУчетаНоменклатуры.МестоХранения = ДД.АналитикаУчетаНоменклатуры.МестоХранения
		|	ГДЕ
		|		ДД.ДокументПоступления <> НЕОПРЕДЕЛЕНО
		|		И Периодика.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|	СГРУППИРОВАТЬ ПО
		|		ДД.ДокументПоступления,
		|		ДД.АналитикаУчетаНоменклатуры.МестоХранения
		//-- НЕ УТ
		|	) КАК ДД
		|СГРУППИРОВАТЬ ПО
		|	ДД.ДокументПоступления,
		|	ДД.Склад
		|;
		// Подразделение документов-регистраторов
		|ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	ДД.Регистратор,
		|	ДД.Подразделение
		|ПОМЕСТИТЬ
		|	ПодразделенияРегистраторов
		|ИЗ
		|	РегистрНакопления.СебестоимостьТоваров КАК ДД
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И (ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		|		ИЛИ ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|		И ДД.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СторноСписанияНаРасходы))
		|	И ДД.Подразделение <> ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка)
		//++ НЕ УТ
		|;
		// Выпуски продукции, реализованные без смены налогообложения НДС.
		|ВЫБРАТЬ
		|	Партии.Номенклатура,
		|	Партии.Характеристика,
		|	Партии.ДокументПоступления,
		|	СУММА(Партии.Количество) КАК Количество
		|ПОМЕСТИТЬ
		|	ИсключаемыеВыпуски
		|ИЗ (
		|	ВЫБРАТЬ
		|		Аналитика.Номенклатура,
		|		Аналитика.Характеристика,
		|		ДД.ДокументПоступления,
		|		СУММА(ДД.Количество) КАК Количество
		|	ИЗ
		|		РегистрНакопления.ПартииТоваровОрганизаций КАК ДД
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК Аналитика
		|			ПО Аналитика.Ссылка = ДД.АналитикаУчетаНоменклатуры
		|	ГДЕ
		|		ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|		И ДД.Регистратор ССЫЛКА Документ.ВыпускПродукции
		|		И НЕ &ЕстьФИФОСкользящая
		|	СГРУППИРОВАТЬ ПО
		|		Аналитика.Номенклатура,
		|		Аналитика.Характеристика,
		|		ДД.ДокументПоступления
		|
		|	ОБЪЕДИНИТЬ ВСЕ
		|	ВЫБРАТЬ
		|		Аналитика.Номенклатура,
		|		Аналитика.Характеристика,
		|		ДД.ДокументПоступления,
		|		-СУММА(ДД.Количество) КАК Количество
		|	ИЗ
		|		РегистрНакопления.ПартииТоваровОрганизаций КАК ДД
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК Аналитика
		|			ПО Аналитика.Ссылка = ДД.АналитикаУчетаНоменклатуры
		|	ГДЕ
		|		ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|		И ДД.ДокументПоступления ССЫЛКА Документ.ВыпускПродукции
		|		И ДД.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РеализацияКлиенту)
		|		И ДД.НалогообложениеНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаОблагаетсяНДС)
		|		И НЕ &ЕстьФИФОСкользящая
		|	СГРУППИРОВАТЬ ПО
		|		Аналитика.Номенклатура,
		|		Аналитика.Характеристика,
		|		ДД.ДокументПоступления
		|	) КАК Партии
		|СГРУППИРОВАТЬ ПО
		|	Партии.Номенклатура,
		|	Партии.Характеристика,
		|	Партии.ДокументПоступления
		|ИМЕЮЩИЕ
		|	СУММА(Партии.Количество) = 0
		//-- НЕ УТ
		|";
КонецФункции

Функция ТекстОписаниеПартийЗатрат()
	Возврат "
		|ВЫБРАТЬ ПЕРВЫЕ 0
		|	ВЫРАЗИТЬ("""" КАК СТРОКА(80)) КАК ЗапросИсточник,
		|	0 КАК Приоритет,
		|	""ХХХХХХХХХХХХХХХХ"" КАК ТипЗаписи,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КАК РазделУчета,
		|	ДАТАВРЕМЯ(1, 1, 1, 0, 0, 0) КАК Период,
		|	ДД.Регистратор,
		|	ЗНАЧЕНИЕ(Справочник.Организации.ПустаяСсылка) КАК Организация,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КАК АналитикаУчетаПродукции,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КАК АналитикаУчетаНоменклатуры,
		|	ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка) КАК ВидЗапасов,
		|	ДД.ДокументВыпуска,
		|	ДД.ДокументПоступления,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка) КАК АналитикаУчетаПартий,
		|	0 КАК Знаменатель,
		|	0 КАК Количество,
		|	0 КАК Стоимость,
		|	0 КАК СтоимостьБезНДС,
		|	0 КАК СтоимостьРегл,
		|	0 КАК НДСРегл,
		|	0 КАК ПостояннаяРазница,
		|	0 КАК ВременнаяРазница,
		|	ЛОЖЬ КАК СохранятьРегл,
		|	ДД.Регистратор КАК ДокументИсточник,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КАК КорАналитикаУчетаПродукции,
		|	ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка) КАК КорВидЗапасов,
		|	ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка) КАК Продукция,
		|	ЗНАЧЕНИЕ(Справочник.ХарактеристикиНоменклатуры.ПустаяСсылка) КАК ХарактеристикаПродукции,
		|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПустаяСсылка) КАК ХозяйственнаяОперация,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка) КАК НалогообложениеПартии,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка) КАК НалогообложениеНДС,
		|	ДД.СтатьяРасходовСписания,
		|	ДД.АналитикаРасходов,
		|	ДД.ИдентификаторСтроки КАК ИдентификаторСтроки,
		|	ДД.АналитикаАктивовПассивов,
		|	ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка) КАК ПодразделениеРасходов,
		|	ДД.СтатьяСписанияНДС,
		|	ДД.АналитикаСписанияНДС
		|//ВоВременнуюТаблицу ПОМЕСТИТЬ ИсходныеДанные
		|ИЗ
		|	РегистрНакопления.ПартииЗатратНаВыпуск КАК ДД
		|";
КонецФункции

Функция ТекстОстаткиПартийЗатрат() // использует Выпуски, ОстаткиПартийСборок, ПрошлыеПоступления
	Возврат "
		// остатки партий затрат на выпуск
		|ВЫБРАТЬ
		|	""ТекстОстаткиПартийЗатрат"" КАК ЗапросИсточник,
		|	90 КАК Приоритет,
		|	""Остаток"" КАК ТипЗаписи,
		|	ИСТИНА КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
		|	(ВЫБОР
		|		КОГДА Периодика.Регистратор ЕСТЬ NULL ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка)
		//++ НЕ УТ
		|		КОГДА Периодика.Регистратор ССЫЛКА Документ.ПередачаСырьяПереработчику
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПереданныеПереработчику)
		//-- НЕ УТ
		|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КОНЕЦ) КАК РазделУчета,
		|	Выпуски.Период КАК Период,
		|	ЕСТЬNULL(Периодика.Регистратор, ДД.ДокументВыпуска) КАК Регистратор,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаПродукции,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов,
		|	ДД.ДокументВыпуска,
		|	ДД.ДокументПоступления,
		|	ДД.АналитикаУчетаПартий,
		|	Партии.Количество КАК Знаменатель,
		|	ДД.КоличествоОстаток КАК Количество,
		|	ДД.СтоимостьОстаток КАК Стоимость,
		|	ДД.СтоимостьБезНДСОстаток КАК СтоимостьБезНДС,
		|	ДД.СтоимостьРеглОстаток КАК СтоимостьРегл,
		|	ДД.НДСРеглОстаток КАК НДСРегл,
		|	ДД.ПостояннаяРазницаОстаток КАК ПостояннаяРазница,
		|	ДД.ВременнаяРазницаОстаток КАК ВременнаяРазница,
		|	ЛОЖЬ КАК СохранятьРегл,
		|	ЕСТЬNULL(Периодика.Регистратор, ДД.ДокументВыпуска) КАК ДокументИсточник,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КАК КорАналитикаУчетаПродукции,
		|	ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка) КАК КорВидЗапасов,
		|	НЕОПРЕДЕЛЕНО КАК Продукция,
		|	НЕОПРЕДЕЛЕНО КАК ХарактеристикаПродукции,
		|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПустаяСсылка) КАК ХозяйственнаяОперация,
		|	ДД.АналитикаУчетаПартий.НалогообложениеНДС КАК НалогообложениеПартии,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)  КАК НалогообложениеНДС,
		|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) КАК СтатьяРасходовСписания,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
		|	"""",
		|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивовПассивов,
		|	ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка) КАК ПодразделениеРасходов,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаСписанияНДС
		|ИЗ
		|	РегистрНакопления.ПартииЗатратНаВыпуск.Остатки(&НачалоПериода, Организация В (&МассивОрганизаций)) КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК Аналитика
		|		ПО Аналитика.Ссылка = ДД.АналитикаУчетаПродукции
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Выпуски
		|		ПО Выпуски.Регистратор = ДД.ДокументВыпуска
		|		И Выпуски.Номенклатура = Аналитика.Номенклатура
		|		И Выпуски.Характеристика = Аналитика.Характеристика
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ОстаткиПартийСборок КАК Партии
		|		ПО Партии.Организация = ДД.Организация
		|		И Партии.АналитикаУчетаНоменклатуры = ДД.АналитикаУчетаПродукции
		|		И Партии.ДокументПоступления = ДД.ДокументВыпуска
		|	ЛЕВОЕ СОЕДИНЕНИЕ ПрошлыеПоступления КАК Периодика
		|		ПО Периодика.Ссылка = ДД.ДокументВыпуска
		|		И Периодика.Склад = ДД.АналитикаУчетаПродукции.МестоХранения
		|ГДЕ
		|	Партии.Количество > 0
		|";
КонецФункции

Функция ТекстПриходыСборокТоваров() // использует ПриходыСборок
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстПриходыСборокТоваров"" КАК ЗапросИсточник,
		|	90 КАК Приоритет,
		|	""Партия"" КАК ТипЗаписи,
		|	ИСТИНА КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КАК РазделУчета,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.КорАналитикаУчетаНоменклатуры КАК АналитикаУчетаПродукции,
		|	ДД.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов КАК ВидЗапасов,
		|	ДД.Регистратор КАК ДокументВыпуска,
		|	ДД.ДокументПоступления КАК ДокументПоступления,
		|	ДД.АналитикаУчетаПартий,
		|	Приходы.Количество КАК Знаменатель,
		|	СУММА(ДД.Количество) КАК Количество,
		|	СУММА(ДД.Стоимость) КАК Стоимость,
		|	СУММА(ДД.СтоимостьБезНДС) КАК СтоимостьБезНДС,
		|	СУММА(ДД.СтоимостьРегл) КАК СтоимостьРегл,
		|	СУММА(ДД.НДСРегл) КАК НДСРегл,
		|	СУММА(ДД.ПостояннаяРазница) КАК ПостояннаяРазница,
		|	СУММА(ДД.ВременнаяРазница) КАК ВременнаяРазница,
		|	ЛОЖЬ КАК СохранятьРегл,
		|	Приходы.ДокументИсточник,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КАК КорАналитикаУчетаПродукции,
		|	ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка) КАК КорВидЗапасов,
		|	НЕОПРЕДЕЛЕНО КАК Продукция,
		|	НЕОПРЕДЕЛЕНО КАК ХарактеристикаПродукции,
		|	ДД.ХозяйственнаяОперация,
		|	ДД.АналитикаУчетаПартий.НалогообложениеНДС КАК НалогообложениеПартии,
		|	ДД.НалогообложениеНДС КАК НалогообложениеНДС,
		|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) КАК СтатьяРасходовСписания,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
		|	"""",
		|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивовПассивов,
		|	ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка) КАК ПодразделениеРасходов,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаСписанияНДС
		|ИЗ
		|	РегистрНакопления.ПартииТоваровОрганизаций КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ПриходыСборок КАК Приходы
		|		ПО Приходы.Регистратор = ДД.Регистратор
		|		И (Приходы.ВидЗапасов = ДД.КорВидЗапасов
		|			ИЛИ ДД.КорВидЗапасов = ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка)
		|			И ДД.ВидЗапасов = ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка))
		|		И Приходы.АналитикаУчетаНоменклатуры = ДД.КорАналитикаУчетаНоменклатуры
		|	ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ВидыЗапасов КАК ВидыЗапасов
		|		ПО ВидыЗапасов.Ссылка = ДД.ВидЗапасов
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И ТИПЗНАЧЕНИЯ(ДД.Регистратор) = ТИП(Документ.СборкаТоваров)
		|	И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		|	И ЕСТЬNULL(ВидыЗапасов.ТипЗапасов, ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.Товар)) В (&СобственныеТипыЗапасов)
		|	И (НЕ ДД.Стоимость = 0
		|		ИЛИ НЕ ДД.СтоимостьБезНДС = 0)
		|СГРУППИРОВАТЬ ПО
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.КорАналитикаУчетаНоменклатуры,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов,
		|	ДД.Регистратор,
		|	ДД.ДокументПоступления,
		|	ДД.АналитикаУчетаПартий,
		|	Приходы.Количество,
		|	Приходы.ДокументИсточник,
		|	ДД.ХозяйственнаяОперация,
		|	ДД.АналитикаУчетаПартий.НалогообложениеНДС,
		|	ДД.НалогообложениеНДС
		|";
КонецФункции

Функция ТекстПриходыСборокТоваровПолуфабрикаты() // использует Выпуски, ПриходыСборок
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстПриходыСборокТоваров"" КАК ЗапросИсточник,
		|	90 КАК Приоритет,
		|	""Сборка"" КАК ТипЗаписи,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КАК РазделУчета,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.КорАналитикаУчетаНоменклатуры КАК АналитикаУчетаПродукции,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КАК АналитикаУчетаНоменклатуры,
		|	ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка) КАК ВидЗапасов,
		|	ДД.Регистратор КАК ДокументВыпуска,
		|	НЕОПРЕДЕЛЕНО КАК ДокументПоступления,
		|	ДД.АналитикаУчетаПартий,
		|	Приходы.Количество КАК Знаменатель,
		|	СУММА(ДД.Количество) КАК Количество,
		|	СУММА(ДД.Стоимость) КАК Стоимость,
		|	СУММА(ДД.СтоимостьБезНДС) КАК СтоимостьБезНДС,
		|	СУММА(ДД.СтоимостьРегл) КАК СтоимостьРегл,
		|	СУММА(ДД.НДСРегл) КАК НДСРегл,
		|	СУММА(ДД.ПостояннаяРазница) КАК ПостояннаяРазница,
		|	СУММА(ДД.ВременнаяРазница) КАК ВременнаяРазница,
		|	ЛОЖЬ КАК СохранятьРегл,
		|	Приходы.ДокументИсточник,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КАК КорАналитикаУчетаПродукции,
		|	ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка) КАК КорВидЗапасов,
		|	НЕОПРЕДЕЛЕНО КАК Продукция,
		|	НЕОПРЕДЕЛЕНО КАК ХарактеристикаПродукции,
		|	ДД.ХозяйственнаяОперация,
		|	ДД.АналитикаУчетаПартий.НалогообложениеНДС КАК НалогообложениеПартии,
		|	ДД.НалогообложениеНДС КАК НалогообложениеНДС,
		|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) КАК СтатьяРасходовСписания,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
		|	"""",
		|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивовПассивов,
		|	ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка) КАК ПодразделениеРасходов,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаСписанияНДС
		|ИЗ
		|	РегистрНакопления.ПартииТоваровОрганизаций КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ПриходыСборок КАК Приходы
		|		ПО Приходы.Регистратор = ДД.Регистратор
		|		И (Приходы.ВидЗапасов = ДД.КорВидЗапасов
		|			ИЛИ ДД.КорВидЗапасов = ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка)
		|			И ДД.ВидЗапасов = ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка))
		|		И Приходы.АналитикаУчетаНоменклатуры = ДД.КорАналитикаУчетаНоменклатуры
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК Аналитика
		|		ПО Аналитика.Ссылка = ДД.АналитикаУчетаНоменклатуры
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Выпуски
		|		ПО Выпуски.Регистратор = ДД.ДокументПоступления
		|		И Выпуски.Номенклатура = Аналитика.Номенклатура
		|		И Выпуски.Характеристика = Аналитика.Характеристика
		|	ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ВидыЗапасов КАК ВидыЗапасов
		|		ПО ВидыЗапасов.Ссылка = ДД.ВидЗапасов
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И ТИПЗНАЧЕНИЯ(ДД.Регистратор) = ТИП(Документ.СборкаТоваров)
		|	И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		|	И ЕСТЬNULL(ВидыЗапасов.ТипЗапасов, ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.Товар)) В (&СобственныеТипыЗапасов)
		|СГРУППИРОВАТЬ ПО
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.КорАналитикаУчетаНоменклатуры,
		|	ДД.Регистратор,
		|	ДД.АналитикаУчетаПартий,
		|	Приходы.Количество,
		|	Приходы.ДокументИсточник,
		|	ДД.ХозяйственнаяОперация,
		|	ДД.АналитикаУчетаПартий.НалогообложениеНДС,
		|	ДД.НалогообложениеНДС
		|";
КонецФункции

Функция ТекстРасходыПартийЗатратПрошлыхМесяцев() // использует ПрошлыеРеализации
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстРасходыПартийЗатратПрошлыхМесяцев"" КАК ЗапросИсточник,
		|	10 КАК Приоритет,
		|	""Прошлое"" КАК ТипЗаписи,
		|	ИСТИНА КАК РасчетЗавершен,
		|	ДД.ВидДвижения,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КАК РазделУчета,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаПродукции,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов,
		|	ДД.ДокументВыпуска,
		|	ДД.ДокументПоступления,
		|	ДД.АналитикаУчетаПартий,
		|	ДД.Знаменатель,
		|	СУММА(ДД.Количество) КАК Количество,
		|	СУММА(ДД.Стоимость) КАК Стоимость,
		|	СУММА(ДД.СтоимостьБезНДС) КАК СтоимостьБезНДС,
		|	СУММА(ДД.СтоимостьРегл) КАК СтоимостьРегл,
		|	СУММА(ДД.НДСРегл) КАК НДСРегл,
		|	СУММА(ДД.ПостояннаяРазница) КАК ПостояннаяРазница,
		|	СУММА(ДД.ВременнаяРазница) КАК ВременнаяРазница,
		|	ЛОЖЬ КАК СохранятьРегл,
		|	ДД.ДокументИсточник,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КАК КорАналитикаУчетаПродукции,
		|	ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка) КАК КорВидЗапасов,
		|	НЕОПРЕДЕЛЕНО КАК Продукция,
		|	НЕОПРЕДЕЛЕНО КАК ХарактеристикаПродукции,
		|	ДД.ХозяйственнаяОперация,
		|	ДД.АналитикаУчетаПартий.НалогообложениеНДС КАК НалогообложениеПартии,
		|	ДД.НалогообложениеНДС КАК НалогообложениеНДС,
		|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) КАК СтатьяРасходовСписания,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
		|	"""",
		|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивовПассивов,
		|	ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка) КАК ПодразделениеРасходов,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаСписанияНДС
		|ИЗ
		|	РегистрНакопления.ПартииЗатратНаВыпуск КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ПрошлыеРеализации КАК Прошлые
		|		ПО ДД.Регистратор = Прошлые.ДокументРеализации
		|		И ДД.АналитикаУчетаПродукции = Прошлые.АналитикаУчетаНоменклатуры
		|ГДЕ
		|	ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|СГРУППИРОВАТЬ ПО
		|	ДД.ВидДвижения,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаПродукции,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов,
		|	ДД.ДокументВыпуска,
		|	ДД.ДокументПоступления,
		|	ДД.АналитикаУчетаПартий,
		|	ДД.Знаменатель,
		|	ДД.ДокументИсточник,
		|	ДД.ХозяйственнаяОперация,
		|	ДД.НалогообложениеНДС
		|";
КонецФункции

Функция ТекстИтерацияПартийЗатрат()
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстИтерацияПартийЗатрат"" КАК ЗапросИсточник,
		|	(ВЫБОР
		|		КОГДА ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) ТОГДА 90
		|		КОГДА ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) И ДД.Количество > 0 ТОГДА 10
		|		ИНАЧЕ 40 КОНЕЦ) КАК Приоритет,
		|	(ВЫБОР
		|		КОГДА ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) И ДД.Количество > 0 ТОГДА ""Потребление""
		|		КОГДА ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) И ДД.Количество < 0 ТОГДА ""Сторно""
		|		КОГДА ДД.Регистратор = ДД.ДокументПоступления ТОГДА ""Замещение""
		|		ИНАЧЕ ""Перемещение"" КОНЕЦ) КАК ТипЗаписи,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ДД.ВидДвижения,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КАК РазделУчета,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры КАК АналитикаУчетаПродукции,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КАК АналитикаУчетаНоменклатуры,
		|	ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка) КАК ВидЗапасов,
		|	ДД.ДокументПоступления КАК ДокументВыпуска,
		|	НЕОПРЕДЕЛЕНО КАК ДокументПоступления,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка) КАК АналитикаУчетаПартий,
		|	СУММА(ДД.Количество) КАК Знаменатель,
		|	0 КАК Количество,
		|	0 КАК Стоимость,
		|	0 КАК СтоимостьБезНДС,
		|	0 КАК СтоимостьРегл,
		|	0 КАК НДСРегл,
		|	0 КАК ПостояннаяРазница,
		|	0 КАК ВременнаяРазница,
		|	(ВЫБОР
		|		КОГДА ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) ТОГДА ЛОЖЬ
		|		КОГДА Передачи.Ссылка ЕСТЬ NULL И Возвраты.Ссылка ЕСТЬ NULL ТОГДА ЛОЖЬ
		|		ИНАЧЕ ИСТИНА КОНЕЦ) КАК СохранятьРегл,
		|	ДД.ДокументИсточник,
		|	ДД.КорАналитикаУчетаНоменклатуры КАК КорАналитикаУчетаПродукции,
		|	(ВЫБОР
		|		КОГДА ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) ТОГДА ДД.ВидЗапасов
		|		ИНАЧЕ ДД.КорВидЗапасов КОНЕЦ) КАК КорВидЗапасов,
		|	НЕОПРЕДЕЛЕНО КАК Продукция,
		|	НЕОПРЕДЕЛЕНО КАК ХарактеристикаПродукции,
		|	ДД.ХозяйственнаяОперация,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка) КАК НалогообложениеПартии,
		|	ДД.НалогообложениеНДС,
		|	ДД.СтатьяРасходовСписания,
		|	ДД.АналитикаРасходов,
		|	"""",
		|	ДД.АналитикаАктивовПассивов,
		|	ЕСТЬNULL(ПодразделенияРегистраторов.Подразделение, ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка)) КАК ПодразделениеРасходов,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаСписанияНДС
		|ИЗ
		|	РегистрНакопления.ПартииТоваровОрганизаций КАК ДД
		|	ЛЕВОЕ СОЕДИНЕНИЕ ПодразделенияРегистраторов КАК ПодразделенияРегистраторов
		|		ПО ПодразделенияРегистраторов.Регистратор = ДД.Регистратор
		|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.ПередачаТоваровМеждуОрганизациями КАК Передачи
		|		ПО Передачи.Дата МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|		И Передачи.Ссылка = ДД.Регистратор
		|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.ВозвратТоваровМеждуОрганизациями КАК Возвраты
		|		ПО Возвраты.Дата МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|		И Возвраты.Ссылка = ДД.Регистратор
		|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.ВозвратТоваровОтКлиента КАК ВозвратыОтКлиента
		|		ПО ВозвратыОтКлиента.Дата МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|		И ВозвратыОтКлиента.Ссылка = ДД.Регистратор
		|		И ВозвратыОтКлиента.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВозвратОтКомиссионера)
		|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.СборкаТоваров КАК Сборка
		|		ПО Сборка.Дата МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|		И Сборка.Ссылка = ДД.Регистратор
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И ДД.ДокументИсточник <> НЕОПРЕДЕЛЕНО
		|	И ВозвратыОтКлиента.Ссылка ЕСТЬ NULL
		|	И НЕ (ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) И НЕ Сборка.Ссылка ЕСТЬ NULL)
		|	И НЕ (ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) И НЕ Сборка.Ссылка ЕСТЬ NULL
		|		И ДД.АналитикаУчетаНоменклатуры = ДД.КорАналитикаУчетаНоменклатуры)
		|	И ДД.ДокументПоступления <> НЕОПРЕДЕЛЕНО
		|	И НЕ ДД.ДокументПоступления ССЫЛКА Документ.ВводОстатков
		|	И НЕ ДД.ДокументПоступления ССЫЛКА Документ.ПриобретениеТоваровУслуг
		//++ НЕ УТКА
		|	И НЕ ДД.ДокументПоступления ССЫЛКА Документ.ПоступлениеСырьяОтДавальца
		//-- НЕ УТКА
		|	И НЕ ДД.ДокументПоступления ССЫЛКА Документ.ОприходованиеИзлишковТоваров
		|	И НЕ ДД.ДокументПоступления ССЫЛКА Документ.ТаможеннаяДекларацияИмпорт
		|	И НЕ (ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|		И ЕСТЬNULL(Передачи.ХозяйственнаяОперация, НЕОПРЕДЕЛЕНО) = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПередачаНаКомиссиюВДругуюОрганизацию))
		//++ НЕ УТ
		|	И НЕ ДД.Регистратор ССЫЛКА Документ.ВозвратСырьяОтПереработчика
		|	И НЕ ДД.Регистратор ССЫЛКА Документ.ВозвратМатериаловИзПроизводства
		//-- НЕ УТ
		|СГРУППИРОВАТЬ ПО
		|	(ВЫБОР
		|		КОГДА ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) ТОГДА 90
		|		КОГДА ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) И ДД.Количество > 0 ТОГДА 10
		|		ИНАЧЕ 40 КОНЕЦ),
		|	(ВЫБОР
		|		КОГДА ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) И ДД.Количество > 0 ТОГДА ""Потребление""
		|		КОГДА ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) И ДД.Количество < 0 ТОГДА ""Сторно""
		|		КОГДА ДД.Регистратор = ДД.ДокументПоступления ТОГДА ""Замещение""
		|		ИНАЧЕ ""Перемещение"" КОНЕЦ),
		|	ДД.ВидДвижения,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ДокументПоступления,
		|	(ВЫБОР
		|		КОГДА ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) ТОГДА ЛОЖЬ
		|		КОГДА Передачи.Ссылка ЕСТЬ NULL И Возвраты.Ссылка ЕСТЬ NULL ТОГДА ЛОЖЬ
		|		ИНАЧЕ ИСТИНА КОНЕЦ),
		|	ДД.ДокументИсточник,
		|	ДД.КорАналитикаУчетаНоменклатуры,
		|	(ВЫБОР
		|		КОГДА ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) ТОГДА ДД.ВидЗапасов
		|		ИНАЧЕ ДД.КорВидЗапасов КОНЕЦ),
		|	ДД.ХозяйственнаяОперация,
		|	ДД.НалогообложениеНДС,
		|	ДД.СтатьяРасходовСписания,
		|	ДД.АналитикаРасходов,
		|	ДД.АналитикаАктивовПассивов,
		|	ЕСТЬNULL(ПодразделенияРегистраторов.Подразделение, ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка))
		|";
КонецФункции

Функция ТекстИтерацияПартийЗатратКомиссия()
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстИтерацияПартийЗатратКомиссия"" КАК ЗапросИсточник,
		|	(ВЫБОР
		|		КОГДА ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) ТОГДА 90
		|		КОГДА ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) И ДД.Количество > 0 ТОГДА 10
		|		ИНАЧЕ 40 КОНЕЦ) КАК Приоритет,
		|	(ВЫБОР
		|		КОГДА ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		|			И НЕ РеализацияТоварыВПути.Ссылка ЕСТЬ NULL ТОГДА ""ПотреблениеВПути""
		|		КОГДА ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) И ДД.Количество > 0 ТОГДА ""Потребление""
		|		КОГДА ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) И ДД.Количество < 0 ТОГДА ""Сторно""
		|		КОГДА ДД.Регистратор = ДД.ДокументПоступления ТОГДА ""Замещение""
		|		ИНАЧЕ ""Передача"" КОНЕЦ) КАК ТипЗаписи,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ДД.ВидДвижения,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КАК РазделУчета,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры КАК АналитикаУчетаПродукции,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КАК АналитикаУчетаНоменклатуры,
		|	ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка) КАК ВидЗапасов,
		|	ДД.ДокументПоступления КАК ДокументВыпуска,
		|	НЕОПРЕДЕЛЕНО КАК ДокументПоступления,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка) КАК АналитикаУчетаПартий,
		|	СУММА(ДД.Количество) КАК Знаменатель,
		|	0 КАК Количество,
		|	0 КАК Стоимость,
		|	0 КАК СтоимостьБезНДС,
		|	0 КАК СтоимостьРегл,
		|	0 КАК НДСРегл,
		|	0 КАК ПостояннаяРазница,
		|	0 КАК ВременнаяРазница,
		|	ЛОЖЬ КАК СохранятьРегл,
		|	(ВЫБОР
		|		КОГДА Реализация.Дата >= &НачалоПериода ТОГДА ДД.ДокументПередачиНаКомиссию
		|		КОГДА Передача.Дата >= &НачалоПериода ТОГДА ДД.ДокументПередачиНаКомиссию
		|		ИНАЧЕ ДД.ДокументПоступления КОНЕЦ) КАК ДокументИсточник,
		|	ДД.КорАналитикаУчетаНоменклатуры КАК КорАналитикаУчетаПродукции,
		|	НЕОПРЕДЕЛЕНО КАК КорВидЗапасов,
		|	НЕОПРЕДЕЛЕНО КАК Продукция,
		|	НЕОПРЕДЕЛЕНО КАК ХарактеристикаПродукции,
		|	ДД.ХозяйственнаяОперация,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка) КАК НалогообложениеПартии,
		|	ДД.НалогообложениеНДС,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяРасходовСписания,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
		|	"""",
		|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивовПассивов,
		|	ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка) КАК ПодразделениеРасходов,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаСписанияНДС
		|ИЗ
		|	РегистрНакопления.ПартииТоваровПереданныеНаКомиссию КАК ДД
		|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.РеализацияТоваровУслуг КАК РеализацияТоварыВПути
		|		ПО РеализацияТоварыВПути.Дата МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|		И РеализацияТоварыВПути.Ссылка = ДД.Регистратор
		|		И РеализацияТоварыВПути.ХозяйственнаяОперация В (
		|			ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РеализацияБезПереходаПраваСобственности),
		|			ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РеализацияЧерезКомиссионераБезПереходаПраваСобственности))
		|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.РеализацияТоваровУслуг КАК Реализация
		|		ПО Реализация.Ссылка = ДД.ДокументПередачиНаКомиссию
		|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.ПередачаТоваровМеждуОрганизациями КАК Передача
		|		ПО Передача.Ссылка = ДД.ДокументПередачиНаКомиссию
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И (ДД.Регистратор <> ДД.ДокументПоступления ИЛИ &Итерация)
		|СГРУППИРОВАТЬ ПО
		|	(ВЫБОР
		|		КОГДА ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) ТОГДА 90
		|		КОГДА ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) И ДД.Количество > 0 ТОГДА 10
		|		ИНАЧЕ 40 КОНЕЦ),
		|	(ВЫБОР
		|		КОГДА ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		|			И НЕ РеализацияТоварыВПути.Ссылка ЕСТЬ NULL ТОГДА ""ПотреблениеВПути""
		|		КОГДА ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) И ДД.Количество > 0 ТОГДА ""Потребление""
		|		КОГДА ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) И ДД.Количество < 0 ТОГДА ""Сторно""
		|		КОГДА ДД.Регистратор = ДД.ДокументПоступления ТОГДА ""Замещение""
		|		ИНАЧЕ ""Передача"" КОНЕЦ),
		|	ДД.ВидДвижения,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ДокументПоступления,
		|	(ВЫБОР
		|		КОГДА Реализация.Дата >= &НачалоПериода ТОГДА ДД.ДокументПередачиНаКомиссию
		|		КОГДА Передача.Дата >= &НачалоПериода ТОГДА ДД.ДокументПередачиНаКомиссию
		|		ИНАЧЕ ДД.ДокументПоступления КОНЕЦ),
		|	ДД.КорАналитикаУчетаНоменклатуры,
		|	ДД.ХозяйственнаяОперация,
		|	ДД.НалогообложениеНДС
		|";
КонецФункции

Функция ТекстИтерацияПартийЗатратКомиссияВозврат()
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстИтерацияПартийЗатратКомиссияВозврат"" КАК ЗапросИсточник,
		|	40 КАК Приоритет,
		|	""Сторно"" КАК ТипЗаписи,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ДД.ВидДвижения,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КАК РазделУчета,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.КорАналитикаУчетаНоменклатуры КАК АналитикаУчетаПродукции,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КАК АналитикаУчетаНоменклатуры,
		|	ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка) КАК ВидЗапасов,
		|	ДД.ДокументПоступления КАК ДокументВыпуска,
		|	НЕОПРЕДЕЛЕНО КАК ДокументПоступления,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка) КАК АналитикаУчетаПартий,
		|	СУММА(-ДД.Количество) КАК Знаменатель,
		|	0 КАК Количество,
		|	0 КАК Стоимость,
		|	0 КАК СтоимостьБезНДС,
		|	0 КАК СтоимостьРегл,
		|	0 КАК НДСРегл,
		|	0 КАК ПостояннаяРазница,
		|	0 КАК ВременнаяРазница,
		|	ЛОЖЬ КАК СохранятьРегл,
		|	ДД.Регистратор КАК ДокументИсточник,
		|	ДД.АналитикаУчетаНоменклатуры КАК КорАналитикаУчетаПродукции,
		|	НЕОПРЕДЕЛЕНО КАК КорВидЗапасов,
		|	НЕОПРЕДЕЛЕНО КАК Продукция,
		|	НЕОПРЕДЕЛЕНО КАК ХарактеристикаПродукции,
		|	ДД.ХозяйственнаяОперация,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка) КАК НалогообложениеПартии,
		|	ДД.НалогообложениеНДС,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяРасходовСписания,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
		|	"""",
		|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивовПассивов,
		|	ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка) КАК ПодразделениеРасходов,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаСписанияНДС
		|ИЗ
		|	РегистрНакопления.ПартииТоваровПереданныеНаКомиссию КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ВозвратТоваровОтКлиента КАК ВозвратыОтКлиента
		|		ПО ВозвратыОтКлиента.Дата МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|		И ВозвратыОтКлиента.Ссылка = ДД.Регистратор
		|		И ВозвратыОтКлиента.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВозвратОтКомиссионера)
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И (ДД.Регистратор <> ДД.ДокументПоступления ИЛИ &Итерация)
		|СГРУППИРОВАТЬ ПО
		|	ДД.ВидДвижения,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ДокументПоступления,
		|	ДД.ДокументПередачиНаКомиссию,
		|	ДД.КорАналитикаУчетаНоменклатуры,
		|	ДД.ХозяйственнаяОперация,
		|	ДД.НалогообложениеНДС
		|";
КонецФункции

Функция ТекстДополнениеПартийЗатрат()
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстДополнениеПартийЗатрат"" КАК ЗапросИсточник,
		|	90 КАК Приоритет,
		|	""ВПути"" КАК ТипЗаписи,
		|	ИСТИНА КАК РасчетЗавершен,
		|	ДД.ВидДвижения,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КАК РазделУчета,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаПродукции,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов,
		|	ДД.ДокументВыпуска,
		|	ДД.ДокументПоступления,
		|	ДД.АналитикаУчетаПартий,
		|	СУММА(ДД.Знаменатель) КАК Знаменатель,
		|	СУММА(ДД.Количество) КАК Количество,
		|	СУММА(ДД.Стоимость) КАК Стоимость,
		|	СУММА(ДД.СтоимостьБезНДС) КАК СтоимостьБезНДС,
		|	СУММА(ДД.СтоимостьРегл) КАК СтоимостьРегл,
		|	СУММА(ДД.НДСРегл) КАК НДСРегл,
		|	СУММА(ДД.ПостояннаяРазница) КАК ПостояннаяРазница,
		|	СУММА(ДД.ВременнаяРазница) КАК ВременнаяРазница,
		|	ЛОЖЬ КАК СохранятьРегл,
		|	НЕОПРЕДЕЛЕНО КАК ДокументИсточник,
		|	ДД.КорАналитикаУчетаПродукции,
		|	ДД.КорВидЗапасов,
		|	НЕОПРЕДЕЛЕНО КАК Продукция,
		|	НЕОПРЕДЕЛЕНО КАК ХарактеристикаПродукции,
		|	ДД.ХозяйственнаяОперация,
		|	ДД.АналитикаУчетаПартий.НалогообложениеНДС КАК НалогообложениеПартии,
		|	ДД.НалогообложениеНДС КАК НалогообложениеНДС,
		|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) КАК СтатьяРасходовСписания,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
		|	"""",
		|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивовПассивов,
		|	ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка) КАК ПодразделениеРасходов,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаСписанияНДС
		|ИЗ
		|	Документ.РеализацияТоваровУслуг КАК Отгрузки
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрНакопления.ПартииЗатратНаВыпуск КАК ДД
		|		ПО ДД.Регистратор = Отгрузки.Ссылка
		|ГДЕ
		|	Отгрузки.ХозяйственнаяОперация В (
		|		ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РеализацияБезПереходаПраваСобственности),
		|		ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РеализацияЧерезКомиссионераБезПереходаПраваСобственности))
		|	И (Отгрузки.ДатаПереходаПраваСобственности МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|		ИЛИ Отгрузки.ДатаПереходаПраваСобственности = ДАТАВРЕМЯ(1,1,1))
		|	И ДД.Период < &НачалоПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|СГРУППИРОВАТЬ ПО
		|	ДД.ВидДвижения,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаПродукции,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов,
		|	ДД.ДокументВыпуска,
		|	ДД.ДокументПоступления,
		|	ДД.АналитикаУчетаПартий,
		|	ДД.КорАналитикаУчетаПродукции,
		|	ДД.КорВидЗапасов,
		|	ДД.ХозяйственнаяОперация,
		|	ДД.АналитикаУчетаПартий.НалогообложениеНДС,
		|	ДД.НалогообложениеНДС
		|";
КонецФункции

//++ НЕ УТКА

Функция ТекстОтчетДавальцу()
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстОтчетДавальцу"" КАК ЗапросИсточник,
		|	10 КАК Приоритет,
		|	""Потребление"" КАК ТипЗаписи,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) КАК ВидДвижения,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КАК РазделУчета,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры КАК АналитикаУчетаПродукции,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КАК АналитикаУчетаНоменклатуры,
		|	ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка) КАК ВидЗапасов,
		|	ДД.Регистратор КАК ДокументВыпуска,
		|	НЕОПРЕДЕЛЕНО КАК ДокументПоступления,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка) КАК АналитикаУчетаПартий,
		|	СУММА(ДД.Количество) КАК Знаменатель,
		|	0 КАК Количество,
		|	0 КАК Стоимость,
		|	0 КАК СтоимостьБезНДС,
		|	0 КАК СтоимостьРегл,
		|	0 КАК НДСРегл,
		|	0 КАК ПостояннаяРазница,
		|	0 КАК ВременнаяРазница,
		|	ЛОЖЬ КАК СохранятьРегл,
		|	ДД.Регистратор КАК ДокументИсточник,
		|	ДД.АналитикаУчетаНоменклатуры КАК КорАналитикаУчетаПродукции,
		|	ДД.ВидЗапасов КАК КорВидЗапасов,
		|	НЕОПРЕДЕЛЕНО КАК Продукция,
		|	НЕОПРЕДЕЛЕНО КАК ХарактеристикаПродукции,
		|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ОтчетДавальцу) КАК ХозяйственнаяОперация,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка) КАК НалогообложениеПартии,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка) КАК НалогообложениеНДС,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяРасходовСписания,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
		|	"""",
		|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивовПассивов,
		|	ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка) КАК ПодразделениеРасходов,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаСписанияНДС
		|ИЗ
		|	РегистрНакопления.ВыпускПродукции КАК ДД
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И ДД.Регистратор ССЫЛКА Документ.ОтчетДавальцу
		|СГРУППИРОВАТЬ ПО
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов
		|";
КонецФункции

Функция ТекстПартииНезавершенногоПроизводстваОтчетДавальцу()
	Возврат "
		// Собственные материалы и полуфабрикаты, использованные на выпуск продукции из давальческого сырья.
		|ВЫБРАТЬ
		|	""ТекстПартииНезавершенногоПроизводстваОтчетДавальцу"" КАК ЗапросИсточник,
		|	90 КАК Приоритет,
		|	(ВЫБОР КОГДА ДД.Стоимость <> 0 ИЛИ ДД.СтоимостьРегл <> 0 ТОГДА ""Партия"" ИНАЧЕ ""Выпуск"" КОНЕЦ) КАК ТипЗаписи,
		|	(ВЫБОР КОГДА ДД.Стоимость <> 0 ИЛИ ДД.СтоимостьРегл <> 0 ТОГДА ИСТИНА ИНАЧЕ ЛОЖЬ КОНЕЦ) КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КАК РазделУчета,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаПродукции,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов,
		|	ДД.Регистратор КАК ДокументВыпуска,
		|	ДД.ДокументПоступления,
		|	ДД.АналитикаУчетаПартий,
		|	МАКСИМУМ(ДД.КоличествоПродукции) КАК Знаменатель,
		|	СУММА(ДД.Количество) КАК Количество,
		|	СУММА(ДД.Стоимость) КАК Стоимость,
		|	СУММА(ДД.СтоимостьБезНДС) КАК СтоимостьБезНДС,
		|	СУММА(ДД.СтоимостьРегл) КАК СтоимостьРегл,
		|	СУММА(ДД.НДСРегл) КАК НДСРегл,
		|	СУММА(ДД.ПостояннаяРазница) КАК ПостояннаяРазница,
		|	СУММА(ДД.ВременнаяРазница) КАК ВременнаяРазница,
		|	ЛОЖЬ КАК СохранятьРегл,
		|	ДД.Регистратор КАК ДокументИсточник,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КАК КорАналитикаУчетаПродукции,
		|	ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка) КАК КорВидЗапасов,
		|	НЕОПРЕДЕЛЕНО КАК Продукция,
		|	НЕОПРЕДЕЛЕНО КАК ХарактеристикаПродукции,
		|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПустаяСсылка) КАК ХозяйственнаяОперация,
		|	ДД.АналитикаУчетаПартий.НалогообложениеНДС КАК НалогообложениеПартии,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка) КАК НалогообложениеНДС,
		|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) КАК СтатьяРасходовСписания,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
		|	"""",
		|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивовПассивов,
		|	ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка) КАК ПодразделениеРасходов,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаСписанияНДС
		|ИЗ
		|	РегистрНакопления.ПартииНезавершенногоПроизводства КАК ДД
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		|	И ДД.Регистратор ССЫЛКА Документ.ОтчетДавальцу
		|СГРУППИРОВАТЬ ПО
		|	(ВЫБОР КОГДА ДД.Стоимость <> 0 ИЛИ ДД.СтоимостьРегл <> 0 ТОГДА ""Партия"" ИНАЧЕ ""Выпуск"" КОНЕЦ),
		|	(ВЫБОР КОГДА ДД.Стоимость <> 0 ИЛИ ДД.СтоимостьРегл <> 0 ТОГДА ИСТИНА ИНАЧЕ ЛОЖЬ КОНЕЦ),
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаПродукции,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов,
		|	ДД.ДокументПоступления,
		|	ДД.АналитикаУчетаПартий,
		|	ДД.АналитикаУчетаПартий.НалогообложениеНДС
		|";
КонецФункции
//-- НЕ УТКА

//++ НЕ УТ

Функция ТекстПриходыПартийЗатрат()
	Возврат "
		// приходы из партий затрат, где регистратор не является сборкой
		|ВЫБРАТЬ
		|	""ТекстПриходыПартийЗатрат"" КАК ЗапросИсточник,
		|	10 КАК Приоритет,
		|	(ВЫБОР КОГДА ДД.Стоимость <> 0 ИЛИ ДД.СтоимостьРегл <> 0 ТОГДА ""Партия"" ИНАЧЕ ""Выпуск"" КОНЕЦ) КАК ТипЗаписи,
		|	(ВЫБОР КОГДА ДД.Стоимость <> 0 ИЛИ ДД.СтоимостьРегл <> 0 ТОГДА ИСТИНА ИНАЧЕ ЛОЖЬ КОНЕЦ) КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КАК РазделУчета,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаПродукции,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов,
		|	ДД.Регистратор КАК ДокументВыпуска,
		|	ДД.ДокументПоступления,
		|	ДД.АналитикаУчетаПартий,
		|	ВыпускиПродукции.Количество КАК Знаменатель,
		|	СУММА(ДД.Количество) КАК Количество,
		|	СУММА(ДД.Стоимость) КАК Стоимость,
		|	СУММА(ДД.СтоимостьБезНДС) КАК СтоимостьБезНДС,
		|	СУММА(ДД.СтоимостьРегл) КАК СтоимостьРегл,
		|	СУММА(ДД.НДСРегл) КАК НДСРегл,
		|	СУММА(ДД.ПостояннаяРазница) КАК ПостояннаяРазница,
		|	СУММА(ДД.ВременнаяРазница) КАК ВременнаяРазница,
		|	ЛОЖЬ КАК СохранятьРегл,
		|	ДД.Регистратор КАК ДокументИсточник,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КАК КорАналитикаУчетаПродукции,
		|	ДД.КорВидЗапасов КАК КорВидЗапасов,
		|	НЕОПРЕДЕЛЕНО КАК Продукция,
		|	НЕОПРЕДЕЛЕНО КАК ХарактеристикаПродукции,
		|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукции) КАК ХозяйственнаяОперация,
		|	ДД.АналитикаУчетаПартий.НалогообложениеНДС КАК НалогообложениеПартии,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка) КАК НалогообложениеНДС,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяРасходовСписания,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
		|	"""",
		|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивовПассивов,
		|	ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка) КАК ПодразделениеРасходов,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаСписанияНДС
		|ИЗ
		|	РегистрНакопления.ПартииНезавершенногоПроизводства КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК Аналитика
		|		ПО Аналитика.Ссылка = ДД.АналитикаУчетаПродукции
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВыпускиПродукции КАК ВыпускиПродукции
		|		ПО ВыпускиПродукции.Регистратор = ДД.Регистратор
		|		И ВыпускиПродукции.АналитикаУчетаПродукции = ДД.АналитикаУчетаПродукции
		|		И ВыпускиПродукции.ВидЗапасов = ДД.КорВидЗапасов
		|	ЛЕВОЕ СОЕДИНЕНИЕ ИсключаемыеВыпуски КАК ИсключаемыеВыпуски
		|		ПО НЕ &ЕстьФИФОСкользящая
		|		И ИсключаемыеВыпуски.Номенклатура = Аналитика.Номенклатура
		|		И ИсключаемыеВыпуски.Характеристика = Аналитика.Характеристика
		|		И ИсключаемыеВыпуски.ДокументПоступления = ДД.Регистратор
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		|	И (ДД.Регистратор ССЫЛКА Документ.ВыпускПродукции
		|		ИЛИ ДД.Регистратор ССЫЛКА Документ.ПоступлениеОтПереработчика)
		|	И ДД.Количество <> 0
		|	И ДД.АналитикаУчетаНоменклатуры <> ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка)
		|	И ИсключаемыеВыпуски.ДокументПоступления ЕСТЬ NULL
		|СГРУППИРОВАТЬ ПО
		|	(ВЫБОР КОГДА ДД.Стоимость <> 0 ИЛИ ДД.СтоимостьРегл <> 0 ТОГДА ""Партия"" ИНАЧЕ ""Выпуск"" КОНЕЦ),
		|	(ВЫБОР КОГДА ДД.Стоимость <> 0 ИЛИ ДД.СтоимостьРегл <> 0 ТОГДА ИСТИНА ИНАЧЕ ЛОЖЬ КОНЕЦ),
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаПродукции,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов,
		|	ДД.ДокументПоступления,
		|	ДД.АналитикаУчетаПартий,
		|	ДД.КорВидЗапасов,
		|	ДД.АналитикаУчетаПартий.НалогообложениеНДС,
		|	ВыпускиПродукции.Количество
		|";
КонецФункции

Функция ТекстРасходыПрочихРасходовНЗП()
	Возврат "
		// расходы прочих расходов незавершенного производства
		|ВЫБРАТЬ
		|	""ТекстРасходыПрочихРасходовНЗП"" КАК ЗапросИсточник,
		|	90 КАК Приоритет,
		|	""Партия"" КАК ТипЗаписи,
		|	ИСТИНА КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КАК РазделУчета,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаПродукции,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КАК АналитикаУчетаНоменклатуры,
		|	ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка) КАК ВидЗапасов,
		|	ДД.Регистратор КАК ДокументВыпуска,
		|	НЕОПРЕДЕЛЕНО КАК ДокументПоступления,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка) КАК АналитикаУчетаПартий,
		|	МАКСИМУМ(Выпуски.Количество) КАК Знаменатель,
		|	0 КАК Количество,
		|	СУММА(ДД.Стоимость) КАК Стоимость,
		|	СУММА(ДД.СтоимостьБезНДС) КАК СтоимостьБезНДС,
		|	СУММА(ДД.СтоимостьРегл) КАК СтоимостьРегл,
		|	0 КАК НДСРегл,
		|	СУММА(ДД.ПостояннаяРазница) КАК ПостояннаяРазница,
		|	СУММА(ДД.ВременнаяРазница) КАК ВременнаяРазница,
		|	ЛОЖЬ КАК СохранятьРегл,
		|	ДД.Регистратор КАК ДокументИсточник,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КАК КорАналитикаУчетаПродукции,
		|	ДД.ВидЗапасов КАК КорВидЗапасов,
		|	НЕОПРЕДЕЛЕНО КАК Продукция,
		|	НЕОПРЕДЕЛЕНО КАК ХарактеристикаПродукции,
		|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукции) КАК ХозяйственнаяОперация,
		|	НЕОПРЕДЕЛЕНО КАК НалогообложениеПартии,
		|	НЕОПРЕДЕЛЕНО КАК НалогообложениеНДС,
		|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) КАК СтатьяРасходовСписания,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
		|	"""",
		|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивовПассивов,
		|	ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка) КАК ПодразделениеРасходов,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаСписанияНДС
		|ИЗ
		|	РегистрНакопления.ПрочиеРасходыНезавершенногоПроизводства КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВыпускиПродукции КАК Выпуски
		|		ПО ДД.Регистратор = Выпуски.Регистратор
		|		И ДД.АналитикаУчетаПродукции = Выпуски.АналитикаУчетаПродукции
		|		И ДД.ВидЗапасов = Выпуски.ВидЗапасов
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И НЕ ДД.РасчетСебестоимости
		|	И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		|	И (ДД.Регистратор ССЫЛКА Документ.ВыпускПродукции
		//++ НЕ УТКА
		|		ИЛИ ДД.Регистратор ССЫЛКА Документ.ОтчетДавальцу
		//-- НЕ УТКА
		|		ИЛИ ДД.Регистратор ССЫЛКА Документ.ПоступлениеОтПереработчика)
		|	И &ЕстьФИФОСкользящая
		|СГРУППИРОВАТЬ ПО
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаПродукции,
		|	ДД.ВидЗапасов
		|ИМЕЮЩИЕ
		|	СУММА(ДД.Стоимость) <> 0
		|	ИЛИ СУММА(ДД.СтоимостьРегл) <> 0
		|	ИЛИ СУММА(ДД.ВременнаяРазница) <> 0
		|	ИЛИ СУММА(ДД.ПостояннаяРазница) <> 0
		|";
КонецФункции

Функция ТекстТрудозатратыНЗП()
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстТрудозатратыНЗП"" КАК ЗапросИсточник,
		|	90 КАК Приоритет,
		|	""Партия"" КАК ТипЗаписи,
		|	ИСТИНА КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КАК РазделУчета,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.КорАналитикаУчетаПродукции КАК АналитикаУчетаПродукции,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КАК АналитикаУчетаНоменклатуры,
		|	ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка) КАК ВидЗапасов,
		|	ДД.Регистратор КАК ДокументВыпуска,
		|	НЕОПРЕДЕЛЕНО КАК ДокументПоступления,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка) КАК АналитикаУчетаПартий,
		|	МАКСИМУМ(ДД.КоличествоПродукции) КАК Знаменатель,
		|	0 КАК Количество,
		|	СУММА(ДД.Стоимость) КАК Стоимость,
		|	СУММА(ДД.Стоимость) КАК СтоимостьБезНДС,
		|	СУММА(ДД.СтоимостьРегл) КАК СтоимостьРегл,
		|	0 КАК НДСРегл,
		|	0 КАК ПостояннаяРазница,
		|	0 КАК ВременнаяРазница,
		|	ЛОЖЬ КАК СохранятьРегл,
		|	ДД.Регистратор КАК ДокументИсточник,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КАК КорАналитикаУчетаПродукции,
		|	ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка) КАК КорВидЗапасов,
		|	НЕОПРЕДЕЛЕНО КАК Продукция,
		|	НЕОПРЕДЕЛЕНО КАК ХарактеристикаПродукции,
		|	НЕОПРЕДЕЛЕНО КАК ХозяйственнаяОперация,
		|	НЕОПРЕДЕЛЕНО КАК НалогообложениеПартии,
		|	НЕОПРЕДЕЛЕНО КАК НалогообложениеНДС,
		|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) КАК СтатьяРасходовСписания,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
		|	"""",
		|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивовПассивов,
		|	ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка) КАК ПодразделениеРасходов,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаСписанияНДС
		|ИЗ
		|	РегистрНакопления.ТрудозатратыНезавершенногоПроизводства КАК ДД
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		|	И (ДД.Регистратор ССЫЛКА Документ.ВыпускПродукции
		//++ НЕ УТКА
		|		ИЛИ ДД.Регистратор ССЫЛКА Документ.ОтчетДавальцу
		//-- НЕ УТКА
		|		)
		|	И &ЕстьФИФОСкользящая
		|СГРУППИРОВАТЬ ПО
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.КорАналитикаУчетаПродукции
		|";
КонецФункции

Функция ТекстИспользованныеПолуфабрикаты()
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстИспользованныеПолуфабрикаты"" КАК ЗапросИсточник,
		|	10 КАК Приоритет,
		|	""Выпуск"" КАК ТипЗаписи,
		|	ИСТИНА КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КАК РазделУчета,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаПродукции,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов,
		|	ДД.Регистратор КАК ДокументВыпуска,
		|	НЕОПРЕДЕЛЕНО КАК ДокументПоступления,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаПартий,
		|	ВыпускиПродукции.Количество КАК Знаменатель,
		|	СУММА(ДД.Количество) КАК Количество,
		|	0 КАК Стоимость,
		|	0 КАК СтоимостьБезНДС,
		|	0 КАК СтоимостьРегл,
		|	0 КАК НДСРегл,
		|	0 КАК ПостояннаяРазница,
		|	0 КАК ВременнаяРазница,
		|	ЛОЖЬ КАК СохранятьРегл,
		|	ДД.Регистратор КАК ДокументИсточник,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаУчетаПродукции,
		|	ДД.КорВидЗапасов,
		|	НЕОПРЕДЕЛЕНО КАК Продукция,
		|	НЕОПРЕДЕЛЕНО КАК ХарактеристикаПродукции,
		|	НЕОПРЕДЕЛЕНО КАК ХозяйственнаяОперация,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка) КАК НалогообложениеПартии,
		|	НЕОПРЕДЕЛЕНО КАК НалогообложениеНДС,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяРасходовСписания,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
		|	"""",
		|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивовПассивов,
		|	ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка) КАК ПодразделениеРасходов,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаСписанияНДС
		|ИЗ
		|	РегистрНакопления.ПартииНезавершенногоПроизводства КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК Аналитика
		|		ПО Аналитика.Ссылка = ДД.АналитикаУчетаНоменклатуры
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Выпуски
		|		ПО Выпуски.Регистратор = ДД.ДокументПоступления
		|		И Выпуски.Номенклатура = Аналитика.Номенклатура
		|		И Выпуски.Характеристика = Аналитика.Характеристика
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВыпускиПродукции КАК ВыпускиПродукции
		|		ПО ВыпускиПродукции.Регистратор = ДД.Регистратор
		|		И ВыпускиПродукции.АналитикаУчетаПродукции = ДД.АналитикаУчетаПродукции
		|		И ВыпускиПродукции.ВидЗапасов = ДД.КорВидЗапасов
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		|	И ДД.Количество > 0
		|	И ДД.Стоимость = 0
		|	И ДД.СтоимостьРегл = 0
		|	И &ЕстьФИФОСкользящая
		|СГРУППИРОВАТЬ ПО
		|	ДД.ВидДвижения,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.АналитикаУчетаПродукции,
		|	ДД.ВидЗапасов,
		|	ДД.КорВидЗапасов,
		|	ВыпускиПродукции.Количество
		|";
КонецФункции
	
Функция ТекстИтерацияПередачиВПроизводство()
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстИтерацияПередачиВПроизводство"" КАК ЗапросИсточник,
		|	(ВЫБОР 
		|		КОГДА ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) ТОГДА 10
		|		ИНАЧЕ 90 КОНЕЦ) КАК Приоритет,
		|	(ВЫБОР 
		|		КОГДА ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) ТОГДА ""Потребление""
		|		ИНАЧЕ ""Перемещение"" КОНЕЦ) КАК ТипЗаписи,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	(ВЫБОР 
		|		КОГДА ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) ТОГДА ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		|		ИНАЧЕ ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КОНЕЦ) КАК ВидДвижения,
		|	(ВЫБОР ДД.ХозяйственнаяОперация
		|		КОГДА ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПередачаПереработчику)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПереданныеПереработчику)
		|		КОГДА ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПередачаПереработчику2_5)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПереданныеПереработчику)
		|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КОНЕЦ) КАК РазделУчета,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.КорАналитикаУчетаНоменклатуры КАК АналитикаУчетаПродукции,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КАК АналитикаУчетаНоменклатуры,
		|	ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка) КАК ВидЗапасов,
		|	ДД.ДокументПоступления КАК ДокументВыпуска,
		|	НЕОПРЕДЕЛЕНО КАК ДокументПоступления,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка) КАК АналитикаУчетаПартий,
		|	СУММА(ДД.Количество) КАК Знаменатель,
		|	0 КАК Количество,
		|	0 КАК Стоимость,
		|	0 КАК СтоимостьБезНДС,
		|	0 КАК СтоимостьРегл,
		|	0 КАК НДСРегл,
		|	0 КАК ПостояннаяРазница,
		|	0 КАК ВременнаяРазница,
		|	ЛОЖЬ КАК СохранятьРегл,
		|	ДД.Регистратор КАК ДокументИсточник,
		|	ДД.АналитикаУчетаНоменклатуры КАК КорАналитикаУчетаПродукции,
		|	ДД.КорВидЗапасов КАК КорВидЗапасов,
		|	НЕОПРЕДЕЛЕНО КАК Продукция,
		|	НЕОПРЕДЕЛЕНО КАК ХарактеристикаПродукции,
		|	НЕОПРЕДЕЛЕНО КАК ХозяйственнаяОперация,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка) КАК НалогообложениеПартии,
		|	ДД.НалогообложениеНДС,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяРасходовСписания,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
		|	"""",
		|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивовПассивов,
		|	ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка) КАК ПодразделениеРасходов,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаСписанияНДС
		|ИЗ
		|	РегистрНакопления.ПартииТоваровОрганизаций КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ МатериалыИРаботыВПроизводстве КАК Затраты
		|		ПО Затраты.Регистратор = ДД.Регистратор
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И (ДД.Регистратор <> ДД.ДокументПоступления ИЛИ &Итерация)
		|	И ДД.ДокументПоступления <> НЕОПРЕДЕЛЕНО
		|	И НЕ ДД.ДокументПоступления ССЫЛКА Документ.ВводОстатков
		|	И НЕ ДД.ДокументПоступления ССЫЛКА Документ.ПриобретениеТоваровУслуг
		//++ НЕ УТКА
		|	И НЕ ДД.ДокументПоступления ССЫЛКА Документ.ПоступлениеСырьяОтДавальца
		//-- НЕ УТКА
		|	И НЕ ДД.ДокументПоступления ССЫЛКА Документ.ОприходованиеИзлишковТоваров
		|	И НЕ ДД.ДокументПоступления ССЫЛКА Документ.ТаможеннаяДекларацияИмпорт
		|	И НЕ ДД.Регистратор ССЫЛКА Документ.ВозвратСырьяОтПереработчика
		|	И НЕ ДД.Регистратор ССЫЛКА Документ.ВозвратМатериаловИзПроизводства
		|	
		|СГРУППИРОВАТЬ ПО
		|	(ВЫБОР 
		|		КОГДА ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) ТОГДА 10
		|		ИНАЧЕ 90 КОНЕЦ),
		|	(ВЫБОР 
		|		КОГДА ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) ТОГДА ""Потребление""
		|		ИНАЧЕ ""Перемещение"" КОНЕЦ),
		|	(ВЫБОР 
		|		КОГДА ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) ТОГДА ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		|		ИНАЧЕ ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КОНЕЦ),
		|	(ВЫБОР ДД.ХозяйственнаяОперация
		|		КОГДА ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПередачаПереработчику)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПереданныеПереработчику)
		|		КОГДА ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПередачаПереработчику2_5)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПереданныеПереработчику)
		|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КОНЕЦ),
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.КорАналитикаУчетаНоменклатуры,
		|	ДД.КорВидЗапасов,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ДокументПоступления,
		|	ДД.НалогообложениеНДС
		|";
КонецФункции

Функция ТекстИтерацияВыпускПродукции()
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстИтерацияВыпускПродукции"" КАК ЗапросИсточник,
		|	10 КАК Приоритет,
		|	""Продукция"" КАК ТипЗаписи,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) КАК ВидДвижения,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КАК РазделУчета,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры КАК АналитикаУчетаПродукции,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КАК АналитикаУчетаНоменклатуры,
		|	ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка) КАК ВидЗапасов,
		|	ДД.ДокументПоступления КАК ДокументВыпуска,
		|	НЕОПРЕДЕЛЕНО КАК ДокументПоступления,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка) КАК АналитикаУчетаПартий,
		|	СУММА(ДД.Количество) КАК Знаменатель,
		|	0 КАК Количество,
		|	0 КАК Стоимость,
		|	0 КАК СтоимостьБезНДС,
		|	0 КАК СтоимостьРегл,
		|	0 КАК НДСРегл,
		|	0 КАК ПостояннаяРазница,
		|	0 КАК ВременнаяРазница,
		|	ЛОЖЬ КАК СохранятьРегл,
		|	ДД.ДокументИсточник,
		|	ДД.АналитикаУчетаПродукции КАК КорАналитикаУчетаПродукции,
		|	ДД.ВидЗапасов КАК КорВидЗапасов,
		|	ДД.АналитикаУчетаПродукции.Номенклатура КАК Продукция,
		|	ДД.АналитикаУчетаПродукции.Характеристика КАК ХарактеристикаПродукции,
		|	НЕОПРЕДЕЛЕНО КАК ХозяйственнаяОперация,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка) КАК НалогообложениеПартии,
		|	НЕОПРЕДЕЛЕНО КАК НалогообложениеНДС,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяРасходовСписания,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
		|	"""",
		|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивовПассивов,
		|	ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка) КАК ПодразделениеРасходов,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаСписанияНДС
		|ИЗ
		|	РегистрНакопления.ПартииНезавершенногоПроизводства КАК ДД
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		|	И ДД.Количество <> 0
		|	И ДД.Стоимость = 0 
		|	И ДД.СтоимостьРегл = 0
		|	И ДД.АналитикаУчетаНоменклатуры <> ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка)
		|СГРУППИРОВАТЬ ПО
		|	ДД.ВидДвижения,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.АналитикаУчетаПродукции,
		|	ДД.ВидЗапасов,
		|	ДД.ДокументПоступления,
		|	ДД.ДокументИсточник
		|";
КонецФункции

Функция ТекстИтерацияРаботыИПеремещенияВПроизводстве()
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстИтерацияРаботыИПеремещенияВПроизводстве"" КАК ЗапросИсточник,
		|	(ВЫБОР 
		|		КОГДА ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) ТОГДА 90
		|		ИНАЧЕ 10 КОНЕЦ) КАК Приоритет,
		|	(ВЫБОР 
		|		КОГДА ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) ТОГДА ""Потребление""
		|		ИНАЧЕ ""Перемещение"" КОНЕЦ) КАК ТипЗаписи,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ДД.ВидДвижения,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КАК РазделУчета,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры КАК АналитикаУчетаПродукции,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КАК АналитикаУчетаНоменклатуры,
		|	ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка) КАК ВидЗапасов,
		|	ДД.ДокументПоступления КАК ДокументВыпуска,
		|	НЕОПРЕДЕЛЕНО КАК ДокументПоступления,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка) КАК АналитикаУчетаПартий,
		|	СУММА(ДД.Количество) КАК Знаменатель,
		|	0 КАК Количество,
		|	0 КАК Стоимость,
		|	0 КАК СтоимостьБезНДС,
		|	0 КАК СтоимостьРегл,
		|	0 КАК НДСРегл,
		|	0 КАК ПостояннаяРазница,
		|	0 КАК ВременнаяРазница,
		|	ЛОЖЬ КАК СохранятьРегл,
		|	(ВЫБОР
		|		КОГДА ДД.ДокументИсточник = НЕОПРЕДЕЛЕНО ТОГДА ДД.ДокументПоступления
		|		ИНАЧЕ ДД.ДокументИсточник КОНЕЦ) КАК ДокументИсточник,
		|	(ВЫБОР
		|		КОГДА ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) И НЕ Выпуск.Ссылка ЕСТЬ NULL
		|			ТОГДА НЕОПРЕДЕЛЕНО
		|		КОГДА ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) И НЕ Перемещение.Ссылка ЕСТЬ NULL
		|			ТОГДА ДД.КорАналитикаУчетаНоменклатуры
		|		ИНАЧЕ ДД.АналитикаУчетаНоменклатуры КОНЕЦ) КАК КорАналитикаУчетаПродукции,
		|	ДД.ВидЗапасов КАК КорВидЗапасов,
		|	НЕОПРЕДЕЛЕНО КАК Продукция,
		|	НЕОПРЕДЕЛЕНО КАК ХарактеристикаПродукции,
		|	НЕОПРЕДЕЛЕНО КАК ХозяйственнаяОперация,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка) КАК НалогообложениеПартии,
		|	ДД.НалогообложениеНДС,
		|	ДД.СтатьяРасходовСписания КАК СтатьяРасходовСписания,
		|	ДД.АналитикаРасходов КАК АналитикаРасходов,
		|	"""",
		|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивовПассивов,
		|	ДД.ПодразделениеРасходов КАК ПодразделениеРасходов,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаСписанияНДС
		|ИЗ
		|	РегистрНакопления.ПартииПроизводственныхЗатрат КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК Аналитика
		|		ПО ДД.АналитикаУчетаНоменклатуры = Аналитика.Ссылка
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Номенклатура КАК Работы
		|		ПО Аналитика.Номенклатура = Работы.Ссылка
		|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.ВыпускПродукции КАК Выпуск
		|		ПО Выпуск.Дата МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|		И Выпуск.Ссылка = ДД.Регистратор
		|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.ПеремещениеМатериаловВПроизводстве КАК Перемещение
		|		ПО Перемещение.Дата МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|		И Перемещение.Ссылка = ДД.Регистратор
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И (ДД.Регистратор <> ДД.ДокументПоступления 
		|		ИЛИ ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		|		ИЛИ &Итерация)
		|	И (Работы.ТипНоменклатуры = ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.Работа)
		|		ИЛИ НЕ Перемещение.Ссылка ЕСТЬ NULL)
		//++ НЕ УТКА
		|	И НЕ ДД.Регистратор ССЫЛКА Документ.МаршрутныйЛистПроизводства
		|	И НЕ ДД.Регистратор ССЫЛКА Документ.СписаниеЗатратНаВыпуск
		|	И НЕ (ДД.Регистратор ССЫЛКА Документ.РаспределениеПроизводственныхЗатрат
		|			И (ДД.СтатьяРасходовСписания = ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка)
		|				ИЛИ ДД.СтатьяРасходовСписания = НЕОПРЕДЕЛЕНО))
		//-- НЕ УТКА
		|	И ДД.ДокументПоступления <> НЕОПРЕДЕЛЕНО
		|	И НЕ ДД.ДокументПоступления ССЫЛКА Документ.ВводОстатков
		|	И НЕ ДД.ДокументПоступления ССЫЛКА Документ.ПриобретениеТоваровУслуг
		//++ НЕ УТКА
		|	И НЕ ДД.ДокументПоступления ССЫЛКА Документ.ПоступлениеСырьяОтДавальца
		//-- НЕ УТКА
		|	И НЕ ДД.ДокументПоступления ССЫЛКА Документ.ОприходованиеИзлишковТоваров
		|	И НЕ ДД.ДокументПоступления ССЫЛКА Документ.ТаможеннаяДекларацияИмпорт
		|СГРУППИРОВАТЬ ПО
		|	(ВЫБОР 
		|		КОГДА ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) ТОГДА 90
		|		ИНАЧЕ 10 КОНЕЦ),
		|	(ВЫБОР 
		|		КОГДА ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) ТОГДА ""Потребление""
		|		ИНАЧЕ ""Перемещение"" КОНЕЦ),
		|	ДД.ВидДвижения,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	(ВЫБОР
		|		КОГДА ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) И НЕ Выпуск.Ссылка ЕСТЬ NULL
		|			ТОГДА НЕОПРЕДЕЛЕНО
		|		КОГДА ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) И НЕ Перемещение.Ссылка ЕСТЬ NULL
		|			ТОГДА ДД.КорАналитикаУчетаНоменклатуры
		|		ИНАЧЕ ДД.АналитикаУчетаНоменклатуры КОНЕЦ),
		|	ДД.ДокументПоступления,
		|	ДД.ВидЗапасов,
		|	(ВЫБОР
		|		КОГДА ДД.ДокументИсточник = НЕОПРЕДЕЛЕНО ТОГДА ДД.ДокументПоступления
		|		ИНАЧЕ ДД.ДокументИсточник КОНЕЦ),
		|	ДД.НалогообложениеНДС,
		|	ДД.СтатьяРасходовСписания,
		|	ДД.АналитикаРасходов,
		|	ДД.ПодразделениеРасходов
		|";
КонецФункции

Функция ТекстПриходыПроизводственныхЗатрат() // использует ДолиСтоимости
	Возврат "
		// приходы из партий товаров по списаниям на статьи производственных затрат
		|ВЫБРАТЬ
		|	""ТекстПриходыПроизводственныхЗатрат"" КАК ЗапросИсточник,
		|	10 КАК Приоритет,
		|	(ВЫБОР КОГДА ДД.Стоимость <> 0 ИЛИ ДД.СтоимостьРегл <> 0 ТОГДА ""Затраты"" ИНАЧЕ ""ЗатратыПрочие"" КОНЕЦ) КАК ТипЗаписи,
		|	(ВЫБОР КОГДА ДД.Стоимость <> 0 ИЛИ ДД.СтоимостьРегл <> 0 ТОГДА ИСТИНА ИНАЧЕ ЛОЖЬ КОНЕЦ) КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КАК РазделУчета,
		|	ДолиСтоимости.Период КАК Период,
		|	ДолиСтоимости.Регистратор КАК Регистратор,
		|	ДД.Организация,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КАК АналитикаУчетаПродукции,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КАК АналитикаУчетаНоменклатуры,
		|	НЕОПРЕДЕЛЕНО КАК ВидЗапасов,
		|	НЕОПРЕДЕЛЕНО КАК ДокументВыпуска,
		|	НЕОПРЕДЕЛЕНО КАК ДокументПоступления,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаПартий,
		|	МАКСИМУМ(ДолиСтоимости.ДоляСтоимости) КАК Знаменатель,
		|	0 КАК Количество,
		|	СУММА(ВЫБОР
		|		КОГДА Статья.ВариантРаспределенияРасходовУпр = ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаПроизводственныеЗатраты)
		|			ТОГДА ДД.Стоимость
		|		ИНАЧЕ 0 КОНЕЦ) КАК Стоимость,
		|	СУММА(ВЫБОР
		|		КОГДА Статья.ВариантРаспределенияРасходовУпр = ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаПроизводственныеЗатраты)
		|			ТОГДА ДД.СтоимостьБезНДС
		|		ИНАЧЕ 0 КОНЕЦ) КАК СтоимостьБезНДС,
		|	СУММА(
		|		(ВЫБОР
		|			КОГДА Статья.ВариантРаспределенияРасходовРегл <> ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаПроизводственныеЗатраты)
		|				ТОГДА 0
		|			КОГДА ДД.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПередачаВЭксплуатацию) ТОГДА 0
		|			КОГДА ДД.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПередачаВЭксплуатациюБУНУ) ТОГДА 0
		|			ИНАЧЕ ДД.СтоимостьРегл КОНЕЦ)
		|		+
		|		(ВЫБОР КОГДА ДД.СтатьяСписанияНДС <> ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка)
		|			ТОГДА 0
		|		КОГДА Статья.ВариантРаспределенияРасходовРегл <> ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаПроизводственныеЗатраты)
		|				ТОГДА 0
		|		КОГДА ДД.АналитикаУчетаПартий.НалогообложениеНДС В (
		|			ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаОблагаетсяНДС),
		|			ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаНаЭкспорт),
		|			ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ЭкспортСырьевыхТоваровУслуг),
		|			ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ЭкспортНесырьевыхТоваров),
		|			ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПоФактическомуИспользованию))
		|		 И ДД.НалогообложениеНДС В (
		|			ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаНеОблагаетсяНДС),
		|			ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаОблагаетсяЕНВД))
		|		ТОГДА (ВЫБОР
		|				КОГДА ДД.Количество < 0 ТОГДА 0 - ДД.НДСРегл
		|				ИНАЧЕ ДД.НДСРегл КОНЕЦ)
		|
		|		КОГДА ДД.АналитикаУчетаПартий.НалогообложениеНДС В (
		|			ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаНеОблагаетсяНДС),
		|			ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаОблагаетсяЕНВД))
		|		 И ДД.НалогообложениеНДС В (
		|			ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаОблагаетсяНДС),
		|			ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ОблагаетсяНДСУПокупателя),
		|			ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.РеализацияРаботУслугНаЭкспорт),
		|			ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаОблагаетсяНДСВСтранеЕАЭС),
		|			ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ОблагаетсяНДССМежценовойРазницы),
		|			ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаНаЭкспорт),
		|			ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ЭкспортСырьевыхТоваровУслуг),
		|			ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ЭкспортНесырьевыхТоваров))
		|		ТОГДА (ВЫБОР
		|				КОГДА ДД.Количество < 0 ТОГДА ДД.НДСРегл
		|				ИНАЧЕ - ДД.НДСРегл КОНЕЦ)
		|
		|		КОГДА ДД.АналитикаУчетаПартий.НалогообложениеНДС В (
		|			ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаНеОблагаетсяНДС),
		|			ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаОблагаетсяЕНВД))
		|		ТОГДА (ВЫБОР
		|				КОГДА ДД.Количество < 0 ТОГДА -ДД.НДСРегл
		|				ИНАЧЕ ДД.НДСРегл КОНЕЦ)
		|		ИНАЧЕ 0 КОНЕЦ)
		|		) КАК СтоимостьРегл,
		|	0 КАК НДСРегл,
		|	СУММА(ВЫБОР
		|		КОГДА Статья.ВариантРаспределенияРасходовРегл <> ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаПроизводственныеЗатраты)
		|			ТОГДА 0
		|		КОГДА ДД.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПередачаВЭксплуатацию) ТОГДА 0
		|		КОГДА ДД.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПередачаВЭксплуатациюБУНУ) ТОГДА 0
		|		ИНАЧЕ ДД.ПостояннаяРазница КОНЕЦ) КАК ПостояннаяРазница,
		|	СУММА(ВЫБОР
		|		КОГДА Статья.ВариантРаспределенияРасходовРегл <> ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаПроизводственныеЗатраты)
		|			ТОГДА 0
		|		КОГДА ДД.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПередачаВЭксплуатациюБУНУ) ТОГДА 0
		|		КОГДА ЕСТЬNULL(Статья.ВариантРаспределенияРасходовНУ = ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаНаправленияДеятельности), ЛОЖЬ)
		|			ТОГДА ДД.СтоимостьРегл + ДД.ВременнаяРазница
		|		КОГДА ДД.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПередачаВЭксплуатацию)
		|			ТОГДА -(ДД.СтоимостьРегл + ДД.ВременнаяРазница)
		|			КОГДА ЕСТЬNULL(Статья.ВариантРаспределенияРасходовНУ = ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаНаправленияДеятельности), ЛОЖЬ) ТОГДА ДД.СтоимостьРегл + ДД.ВременнаяРазница
		|		ИНАЧЕ ДД.ВременнаяРазница КОНЕЦ) КАК ВременнаяРазница,
		|	ЛОЖЬ КАК СохранятьРегл,
		|	(ВЫБОР КОГДА ДД.Стоимость <> 0 ИЛИ ДД.СтоимостьРегл <> 0 ТОГДА НЕОПРЕДЕЛЕНО ИНАЧЕ ДД.Регистратор КОНЕЦ) КАК ДокументИсточник,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КАК КорАналитикаУчетаПродукции,
		|	НЕОПРЕДЕЛЕНО КАК КорВидЗапасов,
		|	НЕОПРЕДЕЛЕНО КАК Продукция,
		|	НЕОПРЕДЕЛЕНО КАК ХарактеристикаПродукции,
		|	НЕОПРЕДЕЛЕНО КАК ХозяйственнаяОперация,
		|	НЕОПРЕДЕЛЕНО КАК НалогообложениеПартии,
		|	НЕОПРЕДЕЛЕНО КАК НалогообложениеНДС,
		|	ДД.СтатьяРасходовСписания,
		|	ДД.АналитикаРасходов,
		|	"""",
		|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивовПассивов,
		|	ДолиСтоимости.ПодразделениеРасходов КАК ПодразделениеРасходов,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаСписанияНДС
		|ИЗ
		|	РегистрНакопления.ПартииТоваровОрганизаций КАК ДД
		|	ЛЕВОЕ СОЕДИНЕНИЕ ПодразделенияРегистраторов КАК ПодразделенияРегистраторов
		|		ПО ПодразделенияРегистраторов.Регистратор = ДД.Регистратор
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ПланВидовХарактеристик.СтатьиРасходов КАК Статья
		|		ПО Статья.Ссылка = ДД.СтатьяРасходовСписания
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ДолиСтоимости КАК ДолиСтоимости
		|		ПО ДолиСтоимости.Организация = ДД.Организация
		|		И ДолиСтоимости.СтатьяРасходов = ДД.СтатьяРасходовСписания
		|		И ДолиСтоимости.АналитикаРасходов = ДД.АналитикаРасходов
		|		И ДолиСтоимости.НаправлениеДеятельности = ЕСТЬNULL(ДД.АналитикаУчетаНоменклатуры.Назначение.НаправлениеДеятельности,ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка))
		|		И ДолиСтоимости.ПодразделениеРасходов = ЕСТЬNULL(ПодразделенияРегистраторов.Подразделение, ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка))
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		|	И ДД.ХозяйственнаяОперация <> ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПередачаВПроизводство)
		|	И (Статья.ВариантРаспределенияРасходовУпр = ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаПроизводственныеЗатраты)
		|		ИЛИ Статья.ВариантРаспределенияРасходовРегл = ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаПроизводственныеЗатраты))
		|	И &ЕстьФИФОСкользящая
		|СГРУППИРОВАТЬ ПО
		|	(ВЫБОР КОГДА ДД.Стоимость <> 0 ИЛИ ДД.СтоимостьРегл <> 0 ТОГДА ""Затраты"" ИНАЧЕ ""ЗатратыПрочие"" КОНЕЦ),
		|	(ВЫБОР КОГДА ДД.Стоимость <> 0 ИЛИ ДД.СтоимостьРегл <> 0 ТОГДА ИСТИНА ИНАЧЕ ЛОЖЬ КОНЕЦ),
		|	ДД.Регистратор,
		|	ДолиСтоимости.Период,
		|	ДолиСтоимости.Регистратор,
		|	ДД.Организация,
		|	(ВЫБОР КОГДА ДД.Стоимость <> 0 ИЛИ ДД.СтоимостьРегл <> 0 ТОГДА НЕОПРЕДЕЛЕНО ИНАЧЕ ДД.Регистратор КОНЕЦ),
		|	ДД.СтатьяРасходовСписания,
		|	ДД.АналитикаРасходов,
		|	ДолиСтоимости.ПодразделениеРасходов
		|";
КонецФункции

Функция ТекстПриходыПроизводственныхЗатратПрочее() // использует ДолиСтоимости
	Возврат "
		// Приходы из партий производственных затрат по списаниям на статьи производственных затрат.
		|ВЫБРАТЬ
		|	""ТекстПриходыПроизводственныхЗатратПрочее"" КАК ЗапросИсточник,
		|	10 КАК Приоритет,
		|	""ЗатратыПрочие"" КАК ТипЗаписи,
		|	(ВЫБОР
		|		КОГДА ДД.Стоимость <> 0 ИЛИ ДД.СтоимостьРегл <> 0  ТОГДА ИСТИНА
		|		ИНАЧЕ ЛОЖЬ КОНЕЦ) КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КАК РазделУчета,
		|	ДолиСтоимости.Период КАК Период,
		|	ДолиСтоимости.Регистратор КАК Регистратор,
		|	ДД.Организация,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КАК АналитикаУчетаПродукции,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КАК АналитикаУчетаНоменклатуры,
		|	НЕОПРЕДЕЛЕНО КАК ВидЗапасов,
		|	НЕОПРЕДЕЛЕНО КАК ДокументВыпуска,
		|	НЕОПРЕДЕЛЕНО КАК ДокументПоступления,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаПартий,
		|	МАКСИМУМ(ДолиСтоимости.ДоляСтоимости) КАК Знаменатель,
		|	0 КАК Количество,
		|	СУММА(ВЫБОР
		|		КОГДА Статья.ВариантРаспределенияРасходовУпр = ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаПроизводственныеЗатраты)
		|			ТОГДА ДД.Стоимость
		|		ИНАЧЕ 0 КОНЕЦ) КАК Стоимость,
		|	СУММА(ВЫБОР
		|		КОГДА Статья.ВариантРаспределенияРасходовУпр = ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаПроизводственныеЗатраты)
		|			ТОГДА ДД.СтоимостьБезНДС
		|		ИНАЧЕ 0 КОНЕЦ) КАК СтоимостьБезНДС,
		|	СУММА(ВЫБОР
		|		КОГДА Статья.ВариантРаспределенияРасходовРегл = ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаПроизводственныеЗатраты)
		|			ТОГДА ДД.СтоимостьРегл
		|		ИНАЧЕ 0 КОНЕЦ) КАК СтоимостьРегл,
		|	СУММА(
		|		ВЫБОР КОГДА ДД.СтатьяСписанияНДС <> ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка)
		|			ТОГДА 0
		|		КОГДА Статья.ВариантРаспределенияРасходовРегл <> ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаПроизводственныеЗатраты)
		|			ТОГДА 0
		|		ИНАЧЕ
		|			ДД.НДСРегл
		|		КОНЕЦ
		|	) КАК НДСРегл,
		|	СУММА(ВЫБОР
		|		КОГДА Статья.ВариантРаспределенияРасходовРегл = ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаПроизводственныеЗатраты)
		|			ТОГДА ДД.ПостояннаяРазница
		|		ИНАЧЕ 0 КОНЕЦ) КАК ПостояннаяРазница,
		|	СУММА(ВЫБОР
		|		КОГДА Статья.ВариантРаспределенияРасходовРегл = ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаПроизводственныеЗатраты)
		|			ТОГДА ДД.ВременнаяРазница
		|		ИНАЧЕ 0 КОНЕЦ) КАК ВременнаяРазница,
		|	ЛОЖЬ КАК СохранятьРегл,
		|	ДД.Регистратор КАК ДокументИсточник,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КАК КорАналитикаУчетаПродукции,
		|	НЕОПРЕДЕЛЕНО КАК КорВидЗапасов,
		|	НЕОПРЕДЕЛЕНО КАК Продукция,
		|	НЕОПРЕДЕЛЕНО КАК ХарактеристикаПродукции,
		|	НЕОПРЕДЕЛЕНО КАК ХозяйственнаяОперация,
		|	НЕОПРЕДЕЛЕНО КАК НалогообложениеПартии,
		|	НЕОПРЕДЕЛЕНО КАК НалогообложениеНДС,
		|	ДД.СтатьяРасходовСписания,
		|	ДД.АналитикаРасходов,
		|	"""",
		|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивовПассивов,
		|	ДД.ПодразделениеРасходов,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаСписанияНДС
		|ИЗ
		|	РегистрНакопления.ПартииПроизводственныхЗатрат КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ПланВидовХарактеристик.СтатьиРасходов КАК Статья
		|		ПО Статья.Ссылка = ДД.СтатьяРасходовСписания
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ДолиСтоимости КАК ДолиСтоимости
		|		ПО ДолиСтоимости.Организация = ДД.Организация
		|		И ДолиСтоимости.СтатьяРасходов = ДД.СтатьяРасходовСписания
		|		И ДолиСтоимости.АналитикаРасходов = ДД.АналитикаРасходов
		|		И ДолиСтоимости.ПодразделениеРасходов = ДД.ПодразделениеРасходов
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		|	И (Статья.ВариантРаспределенияРасходовУпр = ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаПроизводственныеЗатраты)
		|		ИЛИ Статья.ВариантРаспределенияРасходовРегл = ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаПроизводственныеЗатраты))
		|	И &ЕстьФИФОСкользящая
		|СГРУППИРОВАТЬ ПО
		|	(ВЫБОР
		|		КОГДА ДД.Стоимость <> 0 ИЛИ ДД.СтоимостьРегл <> 0  ТОГДА ИСТИНА
		|		ИНАЧЕ ЛОЖЬ КОНЕЦ),
		|	ДолиСтоимости.Период,
		|	ДД.Регистратор,
		|	ДолиСтоимости.Регистратор,
		|	ДД.Организация,
		|	ДД.СтатьяРасходовСписания,
		|	ДД.АналитикаРасходов,
		|	ДД.ПодразделениеРасходов
		|";
КонецФункции

Функция ТекстРаспределениеПроизводственныхЗатрат()
	Возврат "
		// распределение производственных затрат на документы выпуска продукции
		|ВЫБРАТЬ
		|	""ТекстРаспределениеПроизводственныхЗатрат"" КАК ЗапросИсточник,
		|	90 КАК Приоритет,
		|	""Распределение"" КАК ТипЗаписи,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) КАК ВидДвижения,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КАК РазделУчета,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаПродукции,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КАК АналитикаУчетаНоменклатуры,
		|	НЕОПРЕДЕЛЕНО КАК ВидЗапасов,
		|	НЕОПРЕДЕЛЕНО КАК ДокументВыпуска,
		|	НЕОПРЕДЕЛЕНО КАК ДокументПоступления,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаПартий,
		|	СУММА(ДД.ДоляСтоимости) КАК Знаменатель,
		|	0 КАК Количество,
		|	0 КАК Стоимость,
		|	0 КАК СтоимостьБезНДС,
		|	0 КАК СтоимостьРегл,
		|	0 КАК НДСРегл,
		|	0 КАК ПостояннаяРазница,
		|	0 КАК ВременнаяРазница,
		|	ЛОЖЬ КАК СохранятьРегл,
		|	ДД.ДокументИсточник,
		|	ДД.АналитикаУчетаПродукции КАК КорАналитикаУчетаПродукции,
		|	ДД.ВидЗапасов КАК КорВидЗапасов,
		|	НЕОПРЕДЕЛЕНО КАК Продукция,
		|	НЕОПРЕДЕЛЕНО КАК ХарактеристикаПродукции,
		|	НЕОПРЕДЕЛЕНО КАК ХозяйственнаяОперация,
		|	НЕОПРЕДЕЛЕНО КАК НалогообложениеПартии,
		|	НЕОПРЕДЕЛЕНО КАК НалогообложениеНДС,
		|	ДД.СтатьяРасходов КАК СтатьяРасходовСписания,
		|	ДД.АналитикаРасходов,
		|	"""",
		|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивовПассивов,
		|	ДД.ДокументИсточник.Подразделение КАК ПодразделениеРасходов,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаСписанияНДС
		|ИЗ
		|	РегистрНакопления.ПрочиеРасходыНезавершенногоПроизводства КАК ДД
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		|	И ДД.ДоляСтоимости <> 0
		|	И НЕ ДД.Регистратор ССЫЛКА Документ.РасчетСебестоимостиТоваров
		|	И НЕ ДД.РасчетСебестоимости
		|	И &ЕстьФИФОСкользящая
		|СГРУППИРОВАТЬ ПО
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.ДокументИсточник,
		|	ДД.АналитикаУчетаПродукции,
		|	ДД.ВидЗапасов,
		|	ДД.СтатьяРасходов,
		|	ДД.АналитикаРасходов
		|";
КонецФункции

Функция ТекстРаспределениеПроизводственныхЗатратПрочее()
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстРаспределениеПроизводственныхЗатратПрочее"" КАК ЗапросИсточник,
		|	90 КАК Приоритет,
		|	""Прочее"" КАК ТипЗаписи,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) КАК ВидДвижения,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КАК РазделУчета,
		|	ДД.Дата КАК Период,
		|	ДД.Ссылка КАК Регистратор,
		|	ДД.Организация,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаПродукции,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КАК АналитикаУчетаНоменклатуры,
		|	НЕОПРЕДЕЛЕНО КАК ВидЗапасов,
		|	НЕОПРЕДЕЛЕНО КАК ДокументВыпуска,
		|	НЕОПРЕДЕЛЕНО КАК ДокументПоступления,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаПартий,
		|	СУММА(Строки.ДоляСтоимости) КАК Знаменатель,
		|	0 КАК Количество,
		|	0 КАК Стоимость,
		|	0 КАК СтоимостьБезНДС,
		|	0 КАК СтоимостьРегл,
		|	0 КАК НДСРегл,
		|	0 КАК ПостояннаяРазница,
		|	0 КАК ВременнаяРазница,
		|	ЛОЖЬ КАК СохранятьРегл,
		|	ДД.Ссылка КАК ДокументИсточник,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаУчетаПродукции,
		|	НЕОПРЕДЕЛЕНО КАК КорВидЗапасов,
		|	НЕОПРЕДЕЛЕНО КАК Продукция,
		|	НЕОПРЕДЕЛЕНО КАК ХарактеристикаПродукции,
		|	НЕОПРЕДЕЛЕНО КАК ХозяйственнаяОперация,
		|	НЕОПРЕДЕЛЕНО КАК НалогообложениеПартии,
		|	НЕОПРЕДЕЛЕНО КАК НалогообложениеНДС,
		|	ДД.СтатьяРасходов КАК СтатьяРасходовСписания,
		|	ДД.АналитикаРасходов,
		|	"""",
		|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивовПассивов,
		|	ДД.Подразделение КАК ПодразделениеРасходов,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаСписанияНДС
		|ИЗ
		|	Документ.РаспределениеПрочихЗатрат КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.РаспределениеПрочихЗатрат.Списание КАК Строки
		| 		ПО Строки.Ссылка = ДД.Ссылка
		|ГДЕ
		|	ДД.Дата МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Проведен
		|	И Строки.ДоляСтоимости <> 0
		|	И &ЕстьФИФОСкользящая
		|СГРУППИРОВАТЬ ПО
		|	ДД.Дата,
		|	ДД.Ссылка,
		|	ДД.Организация,
		|	ДД.СтатьяРасходов,
		|	ДД.АналитикаРасходов,
		|	ДД.Подразделение
		|";
КонецФункции

Функция ТекстВыпускИзПроизводственныхЗатрат()
	Возврат "
		// распределение производственных затрат на документы выпуска продукции
		|ВЫБРАТЬ
		|	""ТекстВыпускИзПроизводственныхЗатрат"" КАК ЗапросИсточник,
		|	90 КАК Приоритет,
		|	""ВыпускПрочие"" КАК ТипЗаписи,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КАК РазделУчета,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаПродукции,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КАК АналитикаУчетаНоменклатуры,
		|	НЕОПРЕДЕЛЕНО КАК ВидЗапасов,
		|	ДД.Регистратор КАК ДокументВыпуска,
		|	НЕОПРЕДЕЛЕНО КАК ДокументПоступления,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаПартий,
		|	МАКСИМУМ(ДД.КоличествоПродукции) КАК Знаменатель,
		|	СУММА(ДД.ДоляСтоимости) КАК Количество,
		|	0 КАК Стоимость,
		|	0 КАК СтоимостьБезНДС,
		|	0 КАК СтоимостьРегл,
		|	0 КАК НДСРегл,
		|	0 КАК ПостояннаяРазница,
		|	0 КАК ВременнаяРазница,
		|	ЛОЖЬ КАК СохранятьРегл,
		|	ДД.Регистратор КАК ДокументИсточник,
		|	ДД.АналитикаУчетаПродукции КАК КорАналитикаУчетаПродукции,
		|	ДД.ВидЗапасов КАК КорВидЗапасов,
		|	НЕОПРЕДЕЛЕНО КАК Продукция,
		|	НЕОПРЕДЕЛЕНО КАК ХарактеристикаПродукции,
		|	НЕОПРЕДЕЛЕНО КАК ХозяйственнаяОперация,
		|	НЕОПРЕДЕЛЕНО КАК НалогообложениеПартии,
		|	НЕОПРЕДЕЛЕНО КАК НалогообложениеНДС,
		|	ДД.СтатьяРасходов КАК СтатьяРасходовСписания,
		|	ДД.АналитикаРасходов,
		|	"""",
		|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивовПассивов,
		|	ДД.ДокументИсточник.Подразделение КАК ПодразделениеРасходов,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаСписанияНДС
		|ИЗ
		|	РегистрНакопления.ПрочиеРасходыНезавершенногоПроизводства КАК ДД
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		|	И ДД.ДоляСтоимости <> 0
		|	И НЕ ДД.Регистратор ССЫЛКА Документ.РасчетСебестоимостиТоваров
		|	И НЕ ДД.РасчетСебестоимости
		|	И &ЕстьФИФОСкользящая
		|СГРУППИРОВАТЬ ПО
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаПродукции,
		|	ДД.ВидЗапасов,
		|	ДД.СтатьяРасходов,
		|	ДД.АналитикаРасходов,
		|	ДД.ДокументИсточник.Подразделение
		|";
КонецФункции

Функция ТекстСписаниеПроизводственныхЗатрат()
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстСписаниеПроизводственныхЗатрат"" КАК ЗапросИсточник,
		|	90 КАК Приоритет,
		|	""Списание"" КАК ТипЗаписи,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) КАК ВидДвижения,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КАК РазделУчета,
		|	ДД.Дата КАК Период,
		|	ДД.Ссылка КАК Регистратор,
		|	ДД.Организация,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаПродукции,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КАК АналитикаУчетаНоменклатуры,
		|	НЕОПРЕДЕЛЕНО КАК ВидЗапасов,
		|	НЕОПРЕДЕЛЕНО КАК ДокументВыпуска,
		|	НЕОПРЕДЕЛЕНО КАК ДокументПоступления,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаПартий,
		|	СУММА(Строки.ДоляСтоимости) КАК Знаменатель,
		|	0 КАК Количество,
		|	0 КАК Стоимость,
		|	0 КАК СтоимостьБезНДС,
		|	0 КАК СтоимостьРегл,
		|	0 КАК НДСРегл,
		|	0 КАК ПостояннаяРазница,
		|	0 КАК ВременнаяРазница,
		|	ЛОЖЬ КАК СохранятьРегл,
		|	ДД.Ссылка КАК ДокументИсточник,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаУчетаПродукции,
		|	НЕОПРЕДЕЛЕНО КАК КорВидЗапасов,
		|	НЕОПРЕДЕЛЕНО КАК Продукция,
		|	НЕОПРЕДЕЛЕНО КАК ХарактеристикаПродукции,
		|	НЕОПРЕДЕЛЕНО КАК ХозяйственнаяОперация,
		|	НЕОПРЕДЕЛЕНО КАК НалогообложениеПартии,
		|	НЕОПРЕДЕЛЕНО КАК НалогообложениеНДС,
		|	Строки.СтатьяРасходов КАК СтатьяРасходовСписания,
		|	Строки.АналитикаРасходов,
		|	Строки.ИдентификаторСтроки,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивовПассивов,
		|	ДД.Подразделение КАК ПодразделениеРасходов,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаСписанияНДС
		|ИЗ
		|	Документ.РаспределениеПрочихЗатрат КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.РаспределениеПрочихЗатрат.Списание КАК Строки
		| 		ПО Строки.Ссылка = ДД.Ссылка
		|ГДЕ
		|	ДД.Дата МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Проведен
		|	И Строки.ДоляСтоимости <> 0
		|СГРУППИРОВАТЬ ПО
		|	ДД.Дата,
		|	ДД.Ссылка,
		|	ДД.Организация,
		|	Строки.СтатьяРасходов,
		|	Строки.АналитикаРасходов,
		|	Строки.ИдентификаторСтроки,
		|	ДД.Подразделение
		|";
КонецФункции

Функция ТекстОтчетПереработчика()
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстОтчетПереработчика"" КАК ЗапросИсточник,
		|	10 КАК Приоритет,
		|	""Потребление"" КАК ТипЗаписи,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ДД.ВидДвижения,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПереданныеПереработчику) КАК РазделУчета,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры КАК АналитикаУчетаПродукции,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КАК АналитикаУчетаНоменклатуры,
		|	ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка) КАК ВидЗапасов,
		|	ДД.ДокументПоступления КАК ДокументВыпуска,
		|	НЕОПРЕДЕЛЕНО КАК ДокументПоступления,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка) КАК АналитикаУчетаПартий,
		|	СУММА(ДД.Количество) КАК Знаменатель,
		|	0 КАК Количество,
		|	0 КАК Стоимость,
		|	0 КАК СтоимостьБезНДС,
		|	0 КАК СтоимостьРегл,
		|	0 КАК НДСРегл,
		|	0 КАК ПостояннаяРазница,
		|	0 КАК ВременнаяРазница,
		|	ЛОЖЬ КАК СохранятьРегл,
		|	ДД.ДокументИсточник,
		|	ДД.АналитикаУчетаНоменклатуры КАК КорАналитикаУчетаПродукции,
		|	ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка) КАК КорВидЗапасов,
		|	НЕОПРЕДЕЛЕНО КАК Продукция,
		|	НЕОПРЕДЕЛЕНО КАК ХарактеристикаПродукции,
		|	НЕОПРЕДЕЛЕНО КАК ХозяйственнаяОперация,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка) КАК НалогообложениеПартии,
		|	ДД.НалогообложениеНДС,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяРасходовСписания,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
		|	"""",
		|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивовПассивов,
		|	ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка) КАК ПодразделениеРасходов,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаСписанияНДС
		|ИЗ
		|	РегистрНакопления.ПартииПроизводственныхЗатрат КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК Аналитика
		|		ПО Аналитика.Ссылка = ДД.АналитикаУчетаНоменклатуры
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Выпуски
		|		ПО Выпуски.Регистратор = ДД.ДокументПоступления
		|		И Выпуски.Номенклатура = Аналитика.Номенклатура
		|		И Выпуски.Характеристика = Аналитика.Характеристика
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И ДД.Регистратор ССЫЛКА Документ.ОтчетПереработчика
		|СГРУППИРОВАТЬ ПО
		|	ДД.ВидДвижения,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ДокументПоступления,
		|	ДД.НалогообложениеНДС,
		|	ДД.ДокументИсточник
		|";
КонецФункции

Функция ТекстОтчетПереработчикаРаспределение()
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстОтчетПереработчикаРаспределение"" КАК ЗапросИсточник,
		|	90 КАК Приоритет,
		|	""Перемещение"" КАК ТипЗаписи,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КАК РазделУчета,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры КАК АналитикаУчетаПродукции,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КАК АналитикаУчетаНоменклатуры,
		|	ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка) КАК ВидЗапасов,
		|	ДД.ДокументПоступления КАК ДокументВыпуска,
		|	НЕОПРЕДЕЛЕНО КАК ДокументПоступления,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка) КАК АналитикаУчетаПартий,
		|	СУММА(ДД.Количество) КАК Знаменатель,
		|	0 КАК Количество,
		|	0 КАК Стоимость,
		|	0 КАК СтоимостьБезНДС,
		|	0 КАК СтоимостьРегл,
		|	0 КАК НДСРегл,
		|	0 КАК ПостояннаяРазница,
		|	0 КАК ВременнаяРазница,
		|	ЛОЖЬ КАК СохранятьРегл,
		|	ДД.ДокументИсточник,
		|	ДД.АналитикаУчетаНоменклатуры КАК КорАналитикаУчетаПродукции,
		|	ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка) КАК КорВидЗапасов,
		|	ДД.АналитикаУчетаПродукции.Номенклатура КАК Продукция,
		|	ДД.АналитикаУчетаПродукции.Характеристика КАК ХарактеристикаПродукции,
		|	НЕОПРЕДЕЛЕНО КАК ХозяйственнаяОперация,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка) КАК НалогообложениеПартии,
		|	НЕОПРЕДЕЛЕНО КАК НалогообложениеНДС,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяРасходовСписания,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
		|	"""",
		|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивовПассивов,
		|	ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка) КАК ПодразделениеРасходов,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаСписанияНДС
		|ИЗ
		|	РегистрНакопления.ПартииНезавершенногоПроизводства КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК Аналитика
		|		ПО Аналитика.Ссылка = ДД.АналитикаУчетаНоменклатуры
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Выпуски
		|		ПО Выпуски.Регистратор = ДД.ДокументПоступления
		|		И Выпуски.Номенклатура = Аналитика.Номенклатура
		|		И Выпуски.Характеристика = Аналитика.Характеристика
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И ДД.Регистратор ССЫЛКА Документ.ОтчетПереработчика
		|СГРУППИРОВАТЬ ПО
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.АналитикаУчетаПродукции.Номенклатура,
		|	ДД.АналитикаУчетаПродукции.Характеристика,
		|	ДД.ДокументПоступления,
		|	ДД.ДокументИсточник
		|";
КонецФункции

Функция ТекстВозвратИзПроизводстваИЛИОтПереработчика()
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстВозвратИзПроизводстваИЛИОтПереработчика"" КАК ЗапросИсточник,
		|	10 КАК Приоритет,
		|	""Потребление"" КАК ТипЗаписи,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) КАК ВидДвижения,
		|	(ВЫБОР
		|		КОГДА ДД.Регистратор ССЫЛКА Документ.ВозвратСырьяОтПереработчика
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПереданныеПереработчику)
		|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КОНЕЦ) КАК РазделУчета,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры КАК АналитикаУчетаПродукции,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КАК АналитикаУчетаНоменклатуры,
		|	ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка) КАК ВидЗапасов,
		|	ДД.ДокументПоступления КАК ДокументВыпуска,
		|	НЕОПРЕДЕЛЕНО КАК ДокументПоступления,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка) КАК АналитикаУчетаПартий,
		|	СУММА(-ДД.Количество) КАК Знаменатель,
		|	0 КАК Количество,
		|	0 КАК Стоимость,
		|	0 КАК СтоимостьБезНДС,
		|	0 КАК СтоимостьРегл,
		|	0 КАК НДСРегл,
		|	0 КАК ПостояннаяРазница,
		|	0 КАК ВременнаяРазница,
		|	ЛОЖЬ КАК СохранятьРегл,
		|	ДД.ДокументИсточник,
		|	ДД.КорАналитикаУчетаНоменклатуры КАК КорАналитикаУчетаПродукции,
		|	ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка) КАК КорВидЗапасов,
		|	НЕОПРЕДЕЛЕНО КАК Продукция,
		|	НЕОПРЕДЕЛЕНО КАК ХарактеристикаПродукции,
		|	НЕОПРЕДЕЛЕНО КАК ХозяйственнаяОперация,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка) КАК НалогообложениеПартии,
		|	ДД.НалогообложениеНДС,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяРасходовСписания,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
		|	"""",
		|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивовПассивов,
		|	ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка) КАК ПодразделениеРасходов,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаСписанияНДС
		|ИЗ
		|	РегистрНакопления.ПартииПроизводственныхЗатрат КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК Аналитика
		|		ПО Аналитика.Ссылка = ДД.АналитикаУчетаНоменклатуры
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Выпуски
		|		ПО Выпуски.Регистратор = ДД.ДокументПоступления
		|		И Выпуски.Номенклатура = Аналитика.Номенклатура
		|		И Выпуски.Характеристика = Аналитика.Характеристика
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И (ДД.Регистратор ССЫЛКА Документ.ВозвратСырьяОтПереработчика
		|		ИЛИ ДД.Регистратор ССЫЛКА Документ.ВозвратМатериаловИзПроизводства)
		|СГРУППИРОВАТЬ ПО
		|	(ВЫБОР
		|		КОГДА ДД.Регистратор ССЫЛКА Документ.ВозвратСырьяОтПереработчика
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПереданныеПереработчику)
		|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КОНЕЦ),
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ДокументПоступления,
		|	ДД.КорАналитикаУчетаНоменклатуры,
		|	ДД.НалогообложениеНДС,
		|	ДД.ДокументИсточник
		|";
КонецФункции

Функция ТекстВозвратИзПроизводстваИЛИОтПереработчикаНаСклад()
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстВозвратИзПроизводстваИЛИОтПереработчикаНаСклад"" КАК ЗапросИсточник,
		|	10 КАК Приоритет,
		|	""Перемещение"" КАК ТипЗаписи,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КАК РазделУчета,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры КАК АналитикаУчетаПродукции,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КАК АналитикаУчетаНоменклатуры,
		|	ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка) КАК ВидЗапасов,
		|	ДД.ДокументПоступления КАК ДокументВыпуска,
		|	НЕОПРЕДЕЛЕНО КАК ДокументПоступления,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка) КАК АналитикаУчетаПартий,
		|	СУММА(-ДД.Количество) КАК Знаменатель,
		|	0 КАК Количество,
		|	0 КАК Стоимость,
		|	0 КАК СтоимостьБезНДС,
		|	0 КАК СтоимостьРегл,
		|	0 КАК НДСРегл,
		|	0 КАК ПостояннаяРазница,
		|	0 КАК ВременнаяРазница,
		|	ЛОЖЬ КАК СохранятьРегл,
		|	ДД.Регистратор КАК ДокументИсточник,
		|	ДД.КорАналитикаУчетаНоменклатуры КАК КорАналитикаУчетаПродукции,
		|	ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка) КАК КорВидЗапасов,
		|	НЕОПРЕДЕЛЕНО КАК Продукция,
		|	НЕОПРЕДЕЛЕНО КАК ХарактеристикаПродукции,
		|	НЕОПРЕДЕЛЕНО КАК ХозяйственнаяОперация,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка) КАК НалогообложениеПартии,
		|	ДД.НалогообложениеНДС,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяРасходовСписания,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
		|	"""",
		|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивовПассивов,
		|	ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка) КАК ПодразделениеРасходов,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаСписанияНДС
		|ИЗ
		|	РегистрНакопления.ПартииТоваровОрганизаций КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК Аналитика
		|		ПО Аналитика.Ссылка = ДД.АналитикаУчетаНоменклатуры
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Выпуски
		|		ПО Выпуски.Регистратор = ДД.ДокументПоступления
		|		И Выпуски.Номенклатура = Аналитика.Номенклатура
		|		И Выпуски.Характеристика = Аналитика.Характеристика
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И (ДД.Регистратор ССЫЛКА Документ.ВозвратСырьяОтПереработчика
		|		ИЛИ ДД.Регистратор ССЫЛКА Документ.ВозвратМатериаловИзПроизводства)
		|СГРУППИРОВАТЬ ПО
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ДокументПоступления,
		|	ДД.КорАналитикаУчетаНоменклатуры,
		|	ДД.НалогообложениеНДС,
		|	ДД.ДокументИсточник
		|";
КонецФункции

Функция ТекстСписаниеВПроизводстве()
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстСписаниеВПроизводстве"" КАК ЗапросИсточник,
		|	10 КАК Приоритет,
		|	""Потребление"" КАК ТипЗаписи,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) КАК ВидДвижения,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КАК РазделУчета,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры КАК АналитикаУчетаПродукции,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КАК АналитикаУчетаНоменклатуры,
		|	ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка) КАК ВидЗапасов,
		|	ДД.ДокументПоступления КАК ДокументВыпуска,
		|	НЕОПРЕДЕЛЕНО КАК ДокументПоступления,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка) КАК АналитикаУчетаПартий,
		|	СУММА(ДД.Количество) КАК Знаменатель,
		|	0 КАК Количество,
		|	0 КАК Стоимость,
		|	0 КАК СтоимостьБезНДС,
		|	0 КАК СтоимостьРегл,
		|	0 КАК НДСРегл,
		|	0 КАК ПостояннаяРазница,
		|	0 КАК ВременнаяРазница,
		|	ЛОЖЬ КАК СохранятьРегл,
		|	ДД.ДокументИсточник,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаУчетаПродукции,
		|	НЕОПРЕДЕЛЕНО КАК КорВидЗапасов,
		|	НЕОПРЕДЕЛЕНО КАК Продукция,
		|	НЕОПРЕДЕЛЕНО КАК ХарактеристикаПродукции,
		|	НЕОПРЕДЕЛЕНО КАК ХозяйственнаяОперация,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка) КАК НалогообложениеПартии,
		|	ДД.НалогообложениеНДС,
		|	ДД.СтатьяРасходовСписания,
		|	ДД.АналитикаРасходов,
		|	"""",
		|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивовПассивов,
		|	ДД.ПодразделениеРасходов,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаСписанияНДС
		|ИЗ
		|	РегистрНакопления.ПартииПроизводственныхЗатрат КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК Аналитика
		|		ПО Аналитика.Ссылка = ДД.АналитикаУчетаНоменклатуры
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Выпуски
		|		ПО Выпуски.Регистратор = ДД.ДокументПоступления
		|		И Выпуски.Номенклатура = Аналитика.Номенклатура
		|		И Выпуски.Характеристика = Аналитика.Характеристика
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		|	И ДД.Регистратор ССЫЛКА Документ.РаспределениеПроизводственныхЗатрат
		|	И ДД.СтатьяРасходовСписания <> ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка)
		|	И ДД.СтатьяРасходовСписания <> НЕОПРЕДЕЛЕНО
		|СГРУППИРОВАТЬ ПО
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ДокументПоступления,
		|	ДД.НалогообложениеНДС,
		|	ДД.ДокументИсточник,
		|	ДД.СтатьяРасходовСписания,
		|	ДД.АналитикаРасходов,
		|	ДД.ПодразделениеРасходов
		|";
КонецФункции

//-- НЕ УТ

#КонецОбласти


#Область РасчетПартийПрочих

Функция ДанныеДляПартийПрочих(НачалоПериода, ОкончаниеПериода, МассивОрганизаций)
	МВТ = Новый МенеджерВременныхТаблиц;
	// Распределяем только по собственным запасам, исключаем комиссионные и давальческие запасы.
	СобственныеТипыЗапасов = РасчетСебестоимостиПрикладныеАлгоритмы.СобственныеТипыЗапасов();
	
	// Определяем базу распределения прочих расходов на заказы поставщикам и заказы перемещений,
	// т.е. распределяем выполненные строки заказов на поступления партий - указываем заказ в партии.
	ТекстСортировкаЗаказов = "
		|УПОРЯДОЧИТЬ ПО
		|	Регистратор, Номенклатура, Характеристика, Склад, Назначение, Приоритет
		|";
	ТекстРасчетаЗаказов = 
		ТекстТаможенныеДекларацииИПоступления() + ";" + // вт Декларации
		ТекстАналитикиРасходовВсе() + ";" + // вт АналитикиРасходовВсе
		ТекстЗаказыИзАналитикРасходов() + ";" + // вт ЗаказыИзАналитикРасходов, использует АналитикиРасходовВсе
		ТекстЗаказыИзАналитикРасходовСводно() + ";" + // вт ЗаказыИзАналитикРасходовСводно, использует ЗаказыИзАналитикРасходов 
		ТекстПоступившиеЗаказы() + // использует ЗаказыИзАналитикРасходов
		"ОБЪЕДИНИТЬ ВСЕ" + ТекстОстаткиПоступленийПоЗаказам() + // использует ЗаказыИзАналитикРасходов
		"ОБЪЕДИНИТЬ ВСЕ" + ТекстПриходыПоступленийПоЗаказам() + // использует ЗаказыИзАналитикРасходов
		"ОБЪЕДИНИТЬ ВСЕ" + ТекстПриходыРаботПоЗаказам() + // использует ЗаказыИзАналитикРасходов
		ТекстСортировкаЗаказов;
	ЗапросРасчетаЗаказов = Новый Запрос(ТекстРасчетаЗаказов);
	ЗапросРасчетаЗаказов.МенеджерВременныхТаблиц = МВТ;
	ЗапросРасчетаЗаказов.УстановитьПараметр("НачалоПериода", НачалоПериода);
	ЗапросРасчетаЗаказов.УстановитьПараметр("ОкончаниеПериода", ОкончаниеПериода);
	ЗапросРасчетаЗаказов.УстановитьПараметр("МассивОрганизаций", МассивОрганизаций);	
	ЗапросРасчетаЗаказов.УстановитьПараметр("СобственныеТипыЗапасов", СобственныеТипыЗапасов);
	ЗапросРасчетаЗаказов.УстановитьПараметр("УчитыватьНазначение",
		РасчетСебестоимостиПовтИсп.СебестоимостьТоваровПоНазначениям(НачалоПериода));
	
	ДанныеРасчетаЗаказов = ЗапросРасчетаЗаказов.Выполнить().Выгрузить();
	РасчетныеПартииПоЗаказам = Новый ТаблицаЗначений;
	ПоляРасчетаЗаказов = СкопироватьКолонки(ДанныеРасчетаЗаказов.Колонки, РасчетныеПартииПоЗаказам.Колонки);
	КонтекстДвижений = ОписаниеДвижений(
		"ЗаказыПоставщикам", "",
		ПоляРасчетаЗаказов,
		"Номенклатура, Регистратор, Характеристика, Склад", "Количество, Стоимость",
		"Количество", "Количество", "Заказ", "Период");
	РаспределитьПриходыНаРасходы(КонтекстДвижений, ДанныеРасчетаЗаказов, РасчетныеПартииПоЗаказам);
	
	// Получаем данные для расчета списания партий прочих расходов и прихода партий расходов на с/с товаров.
	ТекстСортировка = "
		|УПОРЯДОЧИТЬ ПО
		|	Организация, Приоритет, ВидДвижения, Период, Регистратор, АналитикаУчетаНоменклатуры, ВидЗапасов, ДокументПоступления";
	ИсходныйТекстЗапроса =
		ТекстПартииПоЗаказам() + ";" + // вт ПартииПоЗаказам, использует &РасчетныеПартииПоЗаказам
		ТекстПрошлыеПеремещения() + ";" + // вт ПрошлыеПеремещения
		ТекстРегистраторыПрочих() + ";" + // вт РегистраторыПрочих
		ТекстОстаткиПартийСборок() + ";" + // вт ОстаткиЗатратПоСборкам, ОстаткиПартийСборок
		ТекстОстаткиСебестоимости() + ";" + // вт ОстаткиСебестоимости
		ТекстПриходыПартийСборок() + ";" + // вт ПриходыПартийСборок
		ТекстОписаниеПартийПрочих() +
		"ОБЪЕДИНИТЬ ВСЕ" + ТекстОстаткиПартийПрочих() + // использует АналитикиРасходовВсе
		"ОБЪЕДИНИТЬ ВСЕ" + ТекстПриходыПартийПрочих() +
		"ОБЪЕДИНИТЬ ВСЕ" + ТекстДополненияПартийПрочих() + // использует РегистраторыПрочих
		"ОБЪЕДИНИТЬ ВСЕ" + ТекстБазисОстатки() + // использует АналитикиРасходовВсе
		"ОБЪЕДИНИТЬ ВСЕ" + ТекстБазисОстаткиСборок() + // использует ОстаткиПартийСборок, АналитикиРасходовВсе
		"ОБЪЕДИНИТЬ ВСЕ" + ТекстБазисПриходы() + // использует АналитикиРасходовВсе
		"ОБЪЕДИНИТЬ ВСЕ" + ТекстБазисКорректировкиПоступлений() + // использует АналитикиРасходовВсе
		"ОБЪЕДИНИТЬ ВСЕ" + ТекстБазисПриходыСборок() + // использует ПриходыПартийСборок, АналитикиРасходовВсе
		"ОБЪЕДИНИТЬ ВСЕ" + ТекстБазисРаботы() + // использует АналитикиРасходовВсе
		"ОБЪЕДИНИТЬ ВСЕ" + ТекстБазисПеремещения() + // использует АналитикиРасходовВсе
		"ОБЪЕДИНИТЬ ВСЕ" + ТекстБазисПеремещенияСборок() + // использует АналитикиРасходовВсе
		"ОБЪЕДИНИТЬ ВСЕ" + ТекстБазисПрошлыеПеремещения() + // использует ПрошлыеПеремещения
		"ОБЪЕДИНИТЬ ВСЕ" + ТекстБазисЗаказы() + // использует ПартииПоЗаказам, ЗаказыИзАналитикРасходов
		"ОБЪЕДИНИТЬ ВСЕ" + ТекстБазисУслуги() + // использует АналитикиРасходовВсе
		"ОБЪЕДИНИТЬ ВСЕ" + ТекстБазисПрочиеАктивыПассивы() + // использует АналитикиРасходовВсе
		ТекстСортировка;
	ИсходныйТекстЗапроса = СтрЗаменить(ИсходныйТекстЗапроса, "&Вес", 
		Справочники.УпаковкиЕдиницыИзмерения.ТекстЗапросаВесУпаковки("СпрНоменклатура.ЕдиницаИзмерения", "СпрНоменклатура"));
	ИсходныйТекстЗапроса = СтрЗаменить(ИсходныйТекстЗапроса, "&Объем", 
		Справочники.УпаковкиЕдиницыИзмерения.ТекстЗапросаОбъемУпаковки("СпрНоменклатура.ЕдиницаИзмерения", "СпрНоменклатура"));
	ИсходныйЗапрос = Новый Запрос(ИсходныйТекстЗапроса);
	ИсходныйЗапрос.МенеджерВременныхТаблиц = МВТ;
	ИсходныйЗапрос.УстановитьПараметр("РасчетныеПартииПоЗаказам", РасчетныеПартииПоЗаказам);
	ИсходныйЗапрос.УстановитьПараметр("НачалоПериода", НачалоПериода);
	ИсходныйЗапрос.УстановитьПараметр("ОкончаниеПериода", ОкончаниеПериода);
	ИсходныйЗапрос.УстановитьПараметр("МассивОрганизаций", МассивОрганизаций);	
	ИсходныйЗапрос.УстановитьПараметр("СобственныеТипыЗапасов", СобственныеТипыЗапасов);
	ИсходныйЗапрос.УстановитьПараметр("УчитыватьНазначение", 
		РасчетСебестоимостиПовтИсп.СебестоимостьТоваровПоНазначениям(НачалоПериода));
	ИсходныйЗапрос.УстановитьПараметр("ОрганизацииСФИФОСкользящая",
		НастройкиНалоговУчетныхПолитик.ОрганизацииСЗаданнымПараметромПолитики(
			"УчетнаяПолитикаФинансовогоУчета",
			"МетодОценкиСтоимостиТоваров",
			Перечисления.МетодыОценкиСтоимостиТоваров.ФИФОСкользящаяОценка,
			МассивОрганизаций,
			НачалоПериода));
	
	ДанныеДляРасчета = ИсходныйЗапрос.Выполнить().Выгрузить();
	
	Возврат ДанныеДляРасчета;
	
КонецФункции

Функция РасчетныеПартииПрочих(ДанныеДляРасчета, Регистраторы, УзлыДвижений = Неопределено, Тест = Ложь, КоличествоЗаписей = 0) // ДанныеДляРасчета будут изменены
	
	// Шаг 0: Свертка исходных данных
	ПоляСуммирования = "Базис, Количество, Вес, Объем, Стоимость, СтоимостьБезНДС, СтоимостьРегл, НДСРегл, ПостояннаяРазница, ВременнаяРазница";
	Исключения = "ЗапросИсточник";
	ПоляГруппировки = ПереченьПолей(ДанныеДляРасчета.Колонки, ПоляСуммирования + ", " + Исключения);
	ДанныеДляРасчета.Свернуть(ПоляГруппировки, ПоляСуммирования);
	
	// Движения, которые надо сохранить в расчетных партиях, но не нужно учитывать в расчетах.
	Дополнения = Новый Массив;
	// кэшируем получение пустых ссылок - на множественных итерациях есть выигрыш
	ПустыеСсылки = Новый Соответствие;
	ПропорциональноКоличеству = Перечисления.ТипыБазыРаспределенияРасходов.КоличествоТоваров;
	ПропорциональноСебестоимости = Перечисления.ТипыБазыРаспределенияРасходов.СебестоимостьТоваров;
	ПропорциональноВесу = Перечисления.ТипыБазыРаспределенияРасходов.ВесТоваров;
	ПропорциональноОбъему = Перечисления.ТипыБазыРаспределенияРасходов.ОбъемТоваров;
	// Шаг 1: Рассчитываем базу распределения для каждого прихода прочих расходов с учетом налогообложения партии распределения.
	УзлыДвижений = Новый Соответствие; // [Организация, [АналитикаРасходов, [ИндексСтроки, [НалогообложениеНДС, Базис]]]]
	Ключи = Новый Массив(4); // {Организация, АналитикаРасходов, ИндексСтроки, НалогообложениеНДС}
	УдаляемыеСтроки = новый Массив;
	
	// расчет базы по для каждой строки прихода по налогообложению каждого расхода
	Для Каждого Движение Из ДанныеДляРасчета Цикл
		Ключи[0] = Движение.Организация;
		Ключи[1] = Неопределено;
		Ключи[2] = ДанныеДляРасчета.Индекс(Движение);
		Ключи[3] = Движение.НалогообложениеНДС;
		// фиксируем дополнение и уходим на следующую запись
		Если Движение.ТипЗаписи = "Дополнение" Тогда
			Дополнения.Добавить(Ключи[2]);
			Продолжить;
		// накапливаем приход партий прочих расходов для распределения по налогообложению
		ИначеЕсли ЗначениеЗаполнено(Движение.СтатьяРасходов) Тогда
			Ключи[1] = Движение.АналитикаРаспределения;
			ДобавитьУзелИндекса(УзлыДвижений, Ключи, Неопределено);
			Продолжить;
		КонецЕсли;
		
		Количество = Движение.Количество;
		Стоимость  = Движение.Стоимость;
		СтоимостьРегл  = Движение.СтоимостьРегл;
		Вес = Движение.Вес;
		Объем = Движение.Объем;
		
		// Исключаем строки с отрицательными показателями базиса распределения.
		Если Количество < 0
		 ИЛИ Стоимость < 0
		 ИЛИ СтоимостьРегл < 0
		 ИЛИ Вес < 0
		 ИЛИ Объем < 0 Тогда
			УдаляемыеСтроки.Добавить(Движение);
			Продолжить;
		КонецЕсли;
		
		// непосредственно расчет базисов по налогообложению
		Аналитики = УзелИндекса(УзлыДвижений, Ключи);
		Если Аналитики = Неопределено Тогда
			Продолжить;
		КонецЕсли;
		Для Каждого Значение Из АналитикиОбсчетаПартийПрочих(Движение, ПустыеСсылки) Цикл
			ИндексыСтрок = Аналитики[Значение];
			Если ИндексыСтрок = Неопределено Тогда
				Продолжить;
			КонецЕсли;
			Для Каждого ИндексСтроки Из ИндексыСтрок Цикл
				Приход = ДанныеДляРасчета[ИндексСтроки.Ключ];
				Если Приход.ПравилоРаспределения = ПропорциональноКоличеству Тогда
					Базис = Количество;
				ИначеЕсли Приход.ПравилоРаспределения = ПропорциональноВесу Тогда
					Базис = Вес;
				ИначеЕсли Приход.ПравилоРаспределения = ПропорциональноОбъему Тогда
					Базис = Объем;	
				ИначеЕсли Приход.ПравилоРаспределения = ПропорциональноСебестоимости Тогда
					Базис = Стоимость;
				Иначе
					Продолжить;
				КонецЕсли;
				Приход.Базис = Приход.Базис + Базис;
				// увеличим базу по налогообложению (Ключи[3])
				Налоги = ИндексСтроки.Значение;
				ОписаниеБазы = ?(Налоги[Ключи[3]] = Неопределено, Новый Структура("Базис", 0), Налоги[Ключи[3]]);
				ОписаниеБазы.Базис = ОписаниеБазы.Базис + Базис;
				Налоги.Вставить(Ключи[3], ОписаниеБазы);
			КонецЦикла;
		КонецЦикла;
	КонецЦикла;
	// Шаг 2: создаем буфер накопления рассчитанных партий
	РасчетныеПартии = Новый ТаблицаЗначений;
	СкопироватьКолонки(ДанныеДляРасчета.Колонки, РасчетныеПартии.Колонки);
	// Шаг 3: Копируем дополнительные движения в расчетные партии
	Для Каждого Дополнение Из Дополнения Цикл
		Движение = ДанныеДляРасчета[Дополнение];
		РасчетнаяПартия = РасчетныеПартии.Добавить();
		ЗаполнитьРасчетнуюПартию("ПартииПрочихРасходов", РасчетнаяПартия, Движение, Неопределено);
	КонецЦикла;
	// Шаг 4: Создаем расчетные партии расходов по каждому накопленному налогообложению
	Для Каждого Организация Из УзлыДвижений Цикл
		Для Каждого Аналитика Из Организация.Значение Цикл
			Для Каждого ИндексСтроки Из Аналитика.Значение Цикл
				Движение = ДанныеДляРасчета[ИндексСтроки.Ключ];
				Если Движение.Базис = 0 Тогда
					Продолжить;
				КонецЕсли;
				Для Каждого РаспределениеБазиса Из ИндексСтроки.Значение Цикл
					Если РаспределениеБазиса.Значение = Неопределено Тогда
						Продолжить;
					КонецЕсли;
					РасчетнаяПартия = РасчетныеПартии.Добавить();
					ЗаполнитьРасчетнуюПартию("ПартииПрочихРасходов", РасчетнаяПартия, Движение, РаспределениеБазиса);
				КонецЦикла;
			КонецЦикла;
		КонецЦикла;
	КонецЦикла;
	
	// Удаляем строки с отрицательным базисом.
	Для Каждого Строка Из УдаляемыеСтроки Цикл
		ДанныеДляРасчета.Удалить(Строка);
	КонецЦикла;
	УдаляемыеСтроки.Очистить();
	
	// Шаг 4: Удаляем измененные записи ДанныеДляРасчета (партии, остатки, дополнения) - они теперь лишние.
	МинимальныйИндекс = 1 - ДанныеДляРасчета.Количество();
	Для Индекс = МинимальныйИндекс По 0 Цикл
		Движение = ДанныеДляРасчета[-Индекс];
		Если Движение.ТипЗаписи = "Партия" Или Движение.ТипЗаписи = "Остаток" Или Движение.ТипЗаписи = "Дополнение" Тогда
			ДанныеДляРасчета.Удалить(-Индекс);
		КонецЕсли;
	КонецЦикла;
	// Шаг 5: Копируем рассчитанные партии с указанием налогообложения в ДанныеДляРасчета
	// эти движения понадобятся для формирования прихода в партии расходов на себестоимость.
	Для Каждого РасчетнаяПартия Из РасчетныеПартии Цикл
		Если РасчетнаяПартия.ТипЗаписи = "Потребление" Тогда
			Движение = ДанныеДляРасчета.Добавить();
			ЗаполнитьЗначенияСвойств(Движение, РасчетнаяПартия,,"ХозяйственнаяОперация");
			Движение.ТипЗаписи = "Остаток";
			Движение.ВидДвижения = ВидДвиженияНакопления.Приход;
		КонецЕсли;
	КонецЦикла;
	// Шаг 6: Сортировка партий для дальнейшей записи
	РасчетныеПартии.Сортировать("Регистратор, ВидДвижения, Период", Новый СравнениеЗначений);
	КоличествоЗаписей = РасчетныеПартии.Количество();
	Возврат РасчетныеПартии;
КонецФункции

Функция ТекстТаможенныеДекларацииИПоступления() // вт Декларации, КоличествоДеклараций
	Возврат "
		|ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	ДД.ДокументПоступления КАК Ссылка,
		|	Партии.ДокументПоступления КАК Поступление
		|ПОМЕСТИТЬ
		|	Декларации
		|ИЗ
		|	РегистрНакопления.ПартииТоваровОрганизаций.Остатки(&НачалоПериода, Организация В (&МассивОрганизаций)) КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК Аналитика
		|		ПО Аналитика.Ссылка = ДД.АналитикаУчетаНоменклатуры
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрНакопления.ПартииТоваровОрганизаций КАК Партии
		|		ПО Партии.Регистратор = ДД.ДокументПоступления
		|		И Партии.Организация = ДД.Организация
		|		И Партии.АналитикаУчетаНоменклатуры.Номенклатура = Аналитика.Номенклатура
		|		И Партии.АналитикаУчетаНоменклатуры.Характеристика = Аналитика.Характеристика
		|ГДЕ
		|	ДД.ДокументПоступления ССЫЛКА Документ.ТаможеннаяДекларацияИмпорт
		|	И Партии.Период < &НачалоПериода
		|	И Партии.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		|ИНДЕКСИРОВАТЬ ПО
		|	Поступление
		|;
		|ВЫБРАТЬ
		|	ДД.Поступление,
		|	КОЛИЧЕСТВО(РАЗЛИЧНЫЕ ДД.Ссылка) КАК Количество
		|ПОМЕСТИТЬ
		|	КоличествоДеклараций
		|ИЗ
		|	Декларации КАК ДД
		|СГРУППИРОВАТЬ ПО
		|	ДД.Поступление
		|ИНДЕКСИРОВАТЬ ПО
		|	Поступление
		|";
КонецФункции

Функция ТекстАналитикиРасходовВсе() // вт АналитикиРасходовВсе, использует Декларации
	Возврат "
		|ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	Ключи.Организация,
		|	Ключи.СтатьяРасходов,
		|	Ключи.АналитикаРасходов,
		|	Ключи.НаправлениеДеятельности
		|ПОМЕСТИТЬ
		|	АналитикиРасходовВсе
		|ИЗ (
		|	ВЫБРАТЬ
		|		ДД.Организация,
		|		ДД.СтатьяРасходов,
		|		ЕСТЬNULL(Декларации.Ссылка, ДД.АналитикаРасходов) КАК АналитикаРасходов,
		|		ДД.НаправлениеДеятельности
		|	ИЗ
		|		РегистрНакопления.ПартииПрочихРасходов.Остатки(&НачалоПериода, Организация В (&МассивОрганизаций)) КАК ДД
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ПланВидовХарактеристик.СтатьиРасходов КАК Статьи
		|			ПО Статьи.Ссылка = ДД.СтатьяРасходов
		|		ЛЕВОЕ СОЕДИНЕНИЕ Декларации КАК Декларации
		|			ПО Декларации.Поступление = ДД.АналитикаРасходов
		|	ГДЕ
		|		Статьи.ВариантРаспределенияРасходовУпр =
		|			ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаСебестоимостьТоваров)
		|		ИЛИ Статьи.ВариантРаспределенияРасходовРегл =
		|			ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаСебестоимостьТоваров)
		|
		|	ОБЪЕДИНИТЬ ВСЕ
		|	ВЫБРАТЬ
		|		ДД.Организация,
		|		ДД.СтатьяРасходов,
		|		(ВЫБОР
		|			КОГДА ДД.Регистратор ССЫЛКА Документ.ТаможеннаяДекларацияИмпорт
		|			 И ДД.АналитикаРасходов = ЗНАЧЕНИЕ(Документ.ПриобретениеТоваровУслуг.ПустаяСсылка)
		|				ТОГДА ЗНАЧЕНИЕ(Документ.ТаможеннаяДекларацияИмпорт.ПустаяСсылка)
		|			ИНАЧЕ ЕСТЬNULL(Декларации.Ссылка, ДД.АналитикаРасходов) КОНЕЦ) КАК АналитикаРасходов,
		|		ДД.НаправлениеДеятельности
		|	ИЗ
		|		РегистрНакопления.ПартииПрочихРасходов КАК ДД
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ПланВидовХарактеристик.СтатьиРасходов КАК Статьи
		|			ПО Статьи.Ссылка = ДД.СтатьяРасходов
		|		ЛЕВОЕ СОЕДИНЕНИЕ Декларации КАК Декларации
		|			ПО Декларации.Поступление = ДД.АналитикаРасходов
		|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.КорректировкаПриобретения КАК Корректировка
		|			ПО Корректировка.Ссылка = ДД.Регистратор
		|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.СчетФактураПолученныйНалоговыйАгент КАК СчетФактура
		|			ПО СчетФактура.Ссылка = ДД.Регистратор
		|	ГДЕ
		|		ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|		И ДД.Организация В (&МассивОрганизаций)
		|		И ДД.Активность
		|		И ДД.ДокументПоступленияРасходов В (
		|			ДД.Регистратор,
		|			СчетФактура.СчетФактураОснование,
		|			Корректировка.ДокументОснование)
		|		И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|		И (Статьи.ВариантРаспределенияРасходовУпр =
		|				ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаСебестоимостьТоваров)
		|			ИЛИ Статьи.ВариантРаспределенияРасходовРегл =
		|				ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаСебестоимостьТоваров))
		|) КАК Ключи
		|";
КонецФункции

Функция ТекстПрошлыеПеремещения() // вт ПрошлыеПеремещения
	Возврат "
		|ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	ДД.Организация КАК Организация,
		|	ДД.АналитикаРасходов КАК Перемещение,
		|	Партии.Период,
		|	Партии.ДокументПоступления КАК ДокументПоступления,
		|	Партии.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры
		|ПОМЕСТИТЬ
		|	ПрошлыеПеремещения
		|ИЗ
		|	РегистрНакопления.ПартииПрочихРасходов КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ПеремещениеТоваров КАК Перемещение
		|		ПО Перемещение.Ссылка = ДД.АналитикаРасходов
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрНакопления.ПартииТоваровОрганизаций КАК Партии
		|		ПО Партии.Период = Перемещение.Дата
		|		И Партии.Регистратор = Перемещение.Ссылка
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|	И Перемещение.Дата < &НачалоПериода
		|	И Партии.ДокументПоступления <> ДД.Регистратор
		|	И Партии.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|ИНДЕКСИРОВАТЬ ПО
		|	Организация,
		|	ДокументПоступления,
		|	АналитикаУчетаНоменклатуры
		|";
КонецФункции

Функция ТекстРегистраторыПрочих() // вт РегистраторыПрочих
	Возврат "
		|ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	Ключи.Регистратор
		|ПОМЕСТИТЬ
		|	РегистраторыПрочих
		|ИЗ (
		|	ВЫБРАТЬ РАЗЛИЧНЫЕ
		|		ДД.ДокументПоступленияРасходов КАК Регистратор
		|	ИЗ
		|		РегистрНакопления.ПартииПрочихРасходов.Остатки(&НачалоПериода, Организация В (&МассивОрганизаций)) КАК ДД
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ПланВидовХарактеристик.СтатьиРасходов КАК Статьи
		|			ПО Статьи.Ссылка = ДД.СтатьяРасходов
		|	ГДЕ
		|		ДД.СтоимостьОстаток > 0
		|		И (Статьи.ВариантРаспределенияРасходовУпр =
		|				ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаСебестоимостьТоваров)
		|			ИЛИ Статьи.ВариантРаспределенияРасходовРегл =
		|				ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаСебестоимостьТоваров))
		|
		|	ОБЪЕДИНИТЬ ВСЕ
		|	ВЫБРАТЬ
		|		ДД.Регистратор КАК Регистратор
		|	ИЗ
		|		РегистрНакопления.ПартииПрочихРасходов КАК ДД
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ПланВидовХарактеристик.СтатьиРасходов КАК Статьи
		|			ПО Статьи.Ссылка = ДД.СтатьяРасходов
		|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.СчетФактураПолученныйНалоговыйАгент КАК СчетФактура
		|			ПО СчетФактура.Ссылка = ДД.Регистратор
		|	ГДЕ
		|		ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|		И ДД.Организация В (&МассивОрганизаций)
		|		И ДД.Активность
		|		И ДД.ДокументПоступленияРасходов В (
		|			ДД.Регистратор,
		|			СчетФактура.СчетФактураОснование)
		|		И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|		И (Статьи.ВариантРаспределенияРасходовУпр =
		|				ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаСебестоимостьТоваров)
		|			ИЛИ Статьи.ВариантРаспределенияРасходовРегл =
		|				ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаСебестоимостьТоваров))
		|) КАК Ключи
		|";
КонецФункции
	
Функция ТекстОстаткиПартийСборок() // вт ОстаткиЗатратПоСборкам, ОстаткиПартийСборок
	
	Возврат "
		|ВЫБРАТЬ
		|	ДД.ДокументВыпуска
		|ПОМЕСТИТЬ
		|	ОстаткиЗатратПоСборкам
		|ИЗ
		|	РегистрНакопления.ПартииЗатратНаВыпуск.Остатки(&НачалоПериода, Организация В (&МассивОрганизаций)) КАК ДД
		|ИНДЕКСИРОВАТЬ ПО
		|	ДокументВыпуска
		|;
		|////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ДокументПоступления,
		|	ДД.ВидЗапасов,
		|	СпрАналитикиУчетаПартий.НалогообложениеНДС КАК НалогообложениеНДС,
		|	ДД.КоличествоОстаток КАК Количество
		|ПОМЕСТИТЬ
		|	ОстаткиПартийСборок
		|ИЗ
		|	РегистрНакопления.ПартииТоваровОрганизаций.Остатки(&НачалоПериода, Организация В (&МассивОрганизаций)
		|		И ДокументПоступления В (
		|			ВЫБРАТЬ
		|				Затраты.ДокументВыпуска
		|			ИЗ
		|				ОстаткиЗатратПоСборкам КАК Затраты
		|		)
		|		И ВидЗапасов.ТипЗапасов В (&СобственныеТипыЗапасов)
		|) КАК ДД
		|
		|	ЛЕВОЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаПартий КАК СпрАналитикиУчетаПартий
		|	ПО СпрАналитикиУчетаПартий.Ссылка = ДД.АналитикаУчетаПартий
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	Организация,
		|	АналитикаУчетаНоменклатуры,
		|	ДокументПоступления
		|";
КонецФункции

Функция ТекстПриходыПартийСборок() // вт ПриходыПартийСборок
	
	Возврат "
		|ВЫБРАТЬ
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ДокументПоступления,
		|	ДД.ВидЗапасов,
		|	СпрАналитикиУчетаПартий.НалогообложениеНДС КАК НалогообложениеНДС,
		|	СУММА(ДД.Количество) КАК Количество
		|ПОМЕСТИТЬ
		|	ПриходыПартийСборок
		|ИЗ
		|	РегистрНакопления.ПартииТоваровОрганизаций КАК ДД
		|
		|	ЛЕВОЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаПартий КАК СпрАналитикиУчетаПартий
		|	ПО СпрАналитикиУчетаПартий.Ссылка = ДД.АналитикаУчетаПартий
		|
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|	И ДД.Активность
		|	И (ДД.ДокументПоступления ССЫЛКА Документ.СборкаТоваров
		|		ИЛИ ДД.ДокументПоступления ССЫЛКА Документ.ПередачаТоваровМеждуОрганизациями)
		|	И (ДД.Регистратор ССЫЛКА Документ.СборкаТоваров
		|		ИЛИ ДД.Регистратор ССЫЛКА Документ.ПеремещениеТоваров
		|		ИЛИ ДД.Регистратор ССЫЛКА Документ.ПередачаТоваровМеждуОрганизациями)
		|СГРУППИРОВАТЬ ПО
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ДокументПоступления,
		|	СпрАналитикиУчетаПартий.НалогообложениеНДС,
		|	ДД.ВидЗапасов
		|ИНДЕКСИРОВАТЬ ПО
		|	Организация,
		|	АналитикаУчетаНоменклатуры,
		|	ДокументПоступления
		|";
КонецФункции

Функция ТекстОстаткиСебестоимости() // вт ОстаткиСебестоимости
	Возврат 
	"ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	ДД.Организация КАК Организация,
	|	Аналитика.Номенклатура КАК Номенклатура,
	|	Аналитика.Характеристика КАК Характеристика,
	|	Аналитика.Серия КАК Серия,
	|	Аналитика.МестоХранения КАК Склад,
	|	ВЫБОР
	|		КОГДА &УчитыватьНазначение
	|			ТОГДА Аналитика.Назначение
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК Назначение
	|ПОМЕСТИТЬ ОстаткиСебестоимости
	|ИЗ
	|	РегистрНакопления.СебестоимостьТоваров.Остатки(&НачалоПериода, Организация В (&МассивОрганизаций)) КАК ДД
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК Аналитика
	|		ПО (Аналитика.Ссылка = ДД.АналитикаУчетаНоменклатуры)
	|ГДЕ
	|	ДД.КоличествоОстаток > 0
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	ДД.Организация,
	|	Аналитика.Номенклатура,
	|	Аналитика.Характеристика,
	|	Аналитика.Серия,
	|	Аналитика.МестоХранения,
	|	Назначение";
КонецФункции

Функция ТекстЗаказыИзАналитикРасходов() // вт ЗаказыИзАналитикРасходов, использует АналитикиРасходовВсе
	Возврат "
		|ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	ДД.ДатаПоступления,
		|	ДД.Поступление,
		|	ДД.Заказ,
		|	ДД.Организация,
		|	ДД.Номенклатура,
		|	ДД.Характеристика,
		|	ДД.Склад,
		|	(ВЫБОР
		|		КОГДА &УчитыватьНазначение ТОГДА ДД.Назначение
		|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка) КОНЕЦ) КАК Назначение,
		|	ДД.Количество
		|ПОМЕСТИТЬ
		|	ЗаказыИзАналитикРасходов
		|ИЗ (
		|	ВЫБРАТЬ РАЗЛИЧНЫЕ
		|		ДД.Период КАК ДатаПоступления,
		|		ДД.Регистратор КАК Поступление,
		|		ДД.ЗаказПоставщику КАК Заказ,
		|		КлючиРасходов.Организация,
		|		ДД.Номенклатура,
		|		ДД.Характеристика,
		|		ТоварыДокумента.Назначение,
		|		(ВЫБОР
		|			КОГДА Заказ.ХозяйственнаяОперация В (
		|					ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ЗакупкаУПоставщикаТоварыВПути),
		|					ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ЗакупкаПоИмпортуТоварыВПути),
		|					ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ЗакупкаВСтранахЕАЭСТоварыВПути))
		|				ТОГДА Заказ.Партнер
		|			ИНАЧЕ ДД.Склад КОНЕЦ) КАК Склад,
		|		ДД.КОформлению КАК Количество
		|	ИЗ
		|		РегистрНакопления.ЗаказыПоставщикам КАК ДД
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ЗаказПоставщику КАК Заказ
		|			ПО Заказ.Ссылка = ДД.ЗаказПоставщику
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ЗаказПоставщику.Товары КАК ТоварыДокумента
		|			ПО ТоварыДокумента.Ссылка = ДД.ЗаказПоставщику
		|			И ТоварыДокумента.КодСтроки = ДД.КодСтроки
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ АналитикиРасходовВсе КАК КлючиРасходов
		|			ПО КлючиРасходов.АналитикаРасходов = ДД.ЗаказПоставщику
		|			И КлючиРасходов.НаправлениеДеятельности = 
		|				ЕСТЬNULL(ТоварыДокумента.Назначение.НаправлениеДеятельности,
		|					ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка))
		|	ГДЕ
		|		ДД.Период <= &ОкончаниеПериода
		|		И ДД.Активность
		|		И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		|
		|	ОБЪЕДИНИТЬ ВСЕ
		|
		|	ВЫБРАТЬ РАЗЛИЧНЫЕ
		|		ДД.Период КАК ДатаПоступления,
		|		ДД.Регистратор КАК Поступление,
		|		ДД.ЗаказПоставщику КАК Заказ,
		|		КлючиРасходов.Организация,
		|		ДД.Номенклатура,
		|		ДД.Характеристика,
		|		ТоварыДокумента.Назначение,
		|		(ВЫБОР
		|			КОГДА Заказ.ХозяйственнаяОперация В (
		|					ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ЗакупкаУПоставщикаТоварыВПути),
		|					ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ЗакупкаПоИмпортуТоварыВПути),
		|					ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ЗакупкаВСтранахЕАЭСТоварыВПути))
		|				ТОГДА Заказ.Партнер
		|			ИНАЧЕ ДД.Склад КОНЕЦ) КАК Склад,
		|		ДД.КОформлению КАК Количество
		|	ИЗ
		|		РегистрНакопления.ЗаказыПоставщикам КАК ДД
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ЗаказПоставщику КАК Заказ
		|			ПО Заказ.Ссылка = ДД.ЗаказПоставщику
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ЗаказПоставщику.Товары КАК ТоварыДокумента
		|			ПО ДД.ЗаказПоставщику = ТоварыДокумента.Ссылка
		|			И ДД.КодСтроки = ТоварыДокумента.КодСтроки
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ АналитикиРасходовВсе КАК КлючиРасходов
		|			ПО КлючиРасходов.АналитикаРасходов = ЗНАЧЕНИЕ(Документ.ЗаказПоставщику.ПустаяСсылка)
		|			И КлючиРасходов.Организация = Заказ.Организация
		|			И КлючиРасходов.НаправлениеДеятельности = 
		|				ЕСТЬNULL(ТоварыДокумента.Назначение.НаправлениеДеятельности,
		|					ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка))
		|	ГДЕ
		|		ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|		И ДД.Активность
		|		И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		|
		// Расходы по заказам на перемещение
		|	ОБЪЕДИНИТЬ ВСЕ
		|
		|	ВЫБРАТЬ РАЗЛИЧНЫЕ
		|		ДД.Период КАК ДатаПоступления,
		|		ДД.Регистратор КАК Поступление,
		|		ДД.ЗаказНаПеремещение КАК Заказ,
		|		КлючиРасходов.Организация,
		|		ДД.Номенклатура,
		|		ДД.Характеристика,
		|		ТоварыДокумента.Назначение,
		|		Заказ.СкладПолучатель КАК Склад,
		|		ДД.КОформлению КАК Количество
		|	ИЗ
		|		РегистрНакопления.ЗаказыНаПеремещение КАК ДД
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ЗаказНаПеремещение КАК Заказ
		|			ПО Заказ.Ссылка = ДД.ЗаказНаПеремещение
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ЗаказНаПеремещение.Товары КАК ТоварыДокумента
		|			ПО ДД.ЗаказНаПеремещение = ТоварыДокумента.Ссылка
		|			И ДД.КодСтроки = ТоварыДокумента.КодСтроки
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ АналитикиРасходовВсе КАК КлючиРасходов
		|			ПО КлючиРасходов.АналитикаРасходов = ДД.ЗаказНаПеремещение
		|			И КлючиРасходов.НаправлениеДеятельности = 
		|				ЕСТЬNULL(ТоварыДокумента.Назначение.НаправлениеДеятельности,
		|					ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка))
		|	ГДЕ
		|		ДД.Период <= &ОкончаниеПериода
		|		И ДД.Активность
		|		И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		|
		|	ОБЪЕДИНИТЬ ВСЕ
		|
		|	ВЫБРАТЬ РАЗЛИЧНЫЕ
		|		ДД.Период КАК ДатаПоступления,
		|		ДД.Регистратор КАК Поступление,
		|		ДД.ЗаказНаПеремещение КАК Заказ,
		|		КлючиРасходов.Организация,
		|		ДД.Номенклатура,
		|		ДД.Характеристика,
		|		ТоварыДокумента.Назначение,
		|		Заказ.СкладПолучатель КАК Склад,
		|		ДД.КОформлению КАК Количество
		|	ИЗ
		|		РегистрНакопления.ЗаказыНаПеремещение КАК ДД
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ЗаказНаПеремещение КАК Заказ
		|			ПО Заказ.Ссылка = ДД.ЗаказНаПеремещение
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ЗаказНаПеремещение.Товары КАК ТоварыДокумента
		|			ПО ДД.ЗаказНаПеремещение = ТоварыДокумента.Ссылка
		|			И ДД.КодСтроки = ТоварыДокумента.КодСтроки
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ АналитикиРасходовВсе КАК КлючиРасходов
		|			ПО КлючиРасходов.АналитикаРасходов = ЗНАЧЕНИЕ(Документ.ЗаказНаПеремещение.ПустаяСсылка)
		|			И КлючиРасходов.Организация = Заказ.Организация
		|			И КлючиРасходов.НаправлениеДеятельности = 
		|				ЕСТЬNULL(ТоварыДокумента.Назначение.НаправлениеДеятельности,
		|					ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка))
		|	ГДЕ
		|		ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|		И ДД.Активность
		|		И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		|
		// Расходы по заказам на сборку
		|	ОБЪЕДИНИТЬ ВСЕ
		|
		|	ВЫБРАТЬ РАЗЛИЧНЫЕ
		|		ДД.Период КАК ДатаПоступления,
		|		ДД.Регистратор КАК Поступление,
		|		ДД.ЗаказНаСборку КАК Заказ,
		|		КлючиРасходов.Организация,
		|		ДД.Номенклатура,
		|		ДД.Характеристика,
		|		(ВЫБОР
		|			КОГДА Заказ.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СборкаТоваров)
		|				ТОГДА Заказ.Назначение
		|			ИНАЧЕ ЗаказТовары.Назначение КОНЕЦ) КАК Назначение,
		|		Заказ.Склад КАК Склад,
		|		ДД.КОформлению КАК Количество
		|	ИЗ
		|		РегистрНакопления.ЗаказыНаСборку КАК ДД
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ЗаказНаСборку КАК Заказ
		|			ПО Заказ.Ссылка = ДД.ЗаказНаСборку
		|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.ЗаказНаСборку.Товары КАК ЗаказТовары
		|			ПО ЗаказТовары.Ссылка = ДД.ЗаказНаСборку
		|			И ЗаказТовары.КодСтроки = ДД.КодСтроки
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ АналитикиРасходовВсе КАК КлючиРасходов
		|			ПО КлючиРасходов.АналитикаРасходов = ДД.ЗаказНаСборку
		|			И КлючиРасходов.НаправлениеДеятельности = 
		|			(ВЫБОР
		|				КОГДА Заказ.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СборкаТоваров)
		|					ТОГДА ЕСТЬNULL(Заказ.Назначение.НаправлениеДеятельности,
		|						ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка))
		|				ИНАЧЕ
		|					ЕСТЬNULL(ЗаказТовары.Назначение.НаправлениеДеятельности,
		|						ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка))
		|				КОНЕЦ)
		|	ГДЕ
		|		ДД.Период <= &ОкончаниеПериода
		|		И ДД.Активность
		|		И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		|		И ДД.ТипСборки = ЗНАЧЕНИЕ(Перечисление.ТипыДвиженияЗапасов.Поступление)
		|
		|	ОБЪЕДИНИТЬ ВСЕ
		|
		|	ВЫБРАТЬ РАЗЛИЧНЫЕ
		|		ДД.Период КАК ДатаПоступления,
		|		ДД.Регистратор КАК Поступление,
		|		ДД.ЗаказНаСборку КАК Заказ,
		|		КлючиРасходов.Организация,
		|		ДД.Номенклатура,
		|		ДД.Характеристика,
		|		(ВЫБОР
		|			КОГДА Заказ.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СборкаТоваров)
		|				ТОГДА Заказ.Назначение
		|			ИНАЧЕ ЗаказТовары.Назначение КОНЕЦ) КАК Назначение,
		|		Заказ.Склад КАК Склад,
		|		ДД.КОформлению КАК Количество
		|	ИЗ
		|		РегистрНакопления.ЗаказыНаСборку КАК ДД
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ЗаказНаСборку КАК Заказ
		|			ПО Заказ.Ссылка = ДД.ЗаказНаСборку
		|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.ЗаказНаСборку.Товары КАК ЗаказТовары
		|			ПО ЗаказТовары.Ссылка = ДД.ЗаказНаСборку
		|			И ЗаказТовары.КодСтроки = ДД.КодСтроки
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ АналитикиРасходовВсе КАК КлючиРасходов
		|			ПО КлючиРасходов.АналитикаРасходов = ЗНАЧЕНИЕ(Документ.ЗаказНаСборку.ПустаяСсылка)
		|			И КлючиРасходов.Организация = Заказ.Организация
		|			И КлючиРасходов.НаправлениеДеятельности = 
		|			(ВЫБОР
		|				КОГДА Заказ.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СборкаТоваров)
		|					ТОГДА ЕСТЬNULL(Заказ.Назначение.НаправлениеДеятельности,
		|						ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка))
		|				ИНАЧЕ
		|					ЕСТЬNULL(ЗаказТовары.Назначение.НаправлениеДеятельности,
		|						ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка))
		|				КОНЕЦ)
		|	ГДЕ
		|		ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|		И ДД.Активность
		|		И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		|		И ДД.ТипСборки = ЗНАЧЕНИЕ(Перечисление.ТипыДвиженияЗапасов.Поступление)
		|) КАК ДД
		|";
КонецФункции

Функция ТекстЗаказыИзАналитикРасходовСводно() // вт ЗаказыИзАналитикРасходовСводно, использует ЗаказыИзАналитикРасходов
	Возврат "
		|ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	Заказы.ДатаПоступления,
		|	Заказы.Поступление,
		|	Заказы.Номенклатура,
		|	Заказы.Характеристика,
		|	Заказы.Склад,
		|	Заказы.Назначение
		|ПОМЕСТИТЬ ЗаказыИзАналитикРасходовСводно
		|ИЗ
		|	ЗаказыИзАналитикРасходов КАК Заказы
		|ГДЕ
		|	Заказы.ДатаПоступления < &ОкончаниеПериода
		|ИНДЕКСИРОВАТЬ ПО
		|	Поступление,
		|	Номенклатура,
		|	Характеристика,
		|	Склад
		|";
КонецФункции

Функция ТекстПоступившиеЗаказы() // использует ЗаказыИзАналитикРасходов
	Возврат "
		|ВЫБРАТЬ
		|	10 КАК Приоритет,
		|	""Остаток"" КАК ТипЗаписи,
		|	ИСТИНА КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
		|	ДД.ДатаПоступления КАК Период,
		|	ДД.Поступление КАК Регистратор,
		|	ДД.Поступление КАК ДокументПоступления,
		|	ДД.Заказ,
		|	ДД.Организация,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КАК АналитикаУчетаНоменклатуры,
		|	ДД.Номенклатура,
		|	ДД.Характеристика,
		|	ДД.Склад,
		|	ЗНАЧЕНИЕ(Справочник.СерииНоменклатуры.ПустаяСсылка) КАК Серия,
		|	ДД.Назначение,
		|	ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка) КАК ВидЗапасов,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка) КАК АналитикаУчетаПартий,
		|	ДД.Количество,
		|	0 КАК Стоимость,
		|	0 КАК СтоимостьБезНДС,
		|	0 КАК СтоимостьРегл,
		|	0 КАК НДСРегл,
		|	0 КАК ПостояннаяРазница,
		|	0 КАК ВременнаяРазница,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка) КАК НалогообложениеНДС
		|ИЗ
		|	ЗаказыИзАналитикРасходов КАК ДД
		|";
КонецФункции

Функция ТекстОстаткиПоступленийПоЗаказам() // использует ЗаказыИзАналитикРасходов
	Возврат "
		|ВЫБРАТЬ
		|	90 КАК Приоритет,
		|	""Потребление"" КАК ТипЗаписи,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) КАК ВидДвижения,
		|	Заказы.ДатаПоступления КАК Период,
		|	ДД.ДокументПоступления КАК Регистратор,
		|	ДД.ДокументПоступления КАК ДокументПоступления,
		|	НЕОПРЕДЕЛЕНО КАК Заказ,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.АналитикаУчетаНоменклатуры.Номенклатура   КАК Номенклатура,
		|	ДД.АналитикаУчетаНоменклатуры.Характеристика КАК Характеристика,
		|	ДД.АналитикаУчетаНоменклатуры.МестоХранения  КАК Склад,
		|	ДД.АналитикаУчетаНоменклатуры.Серия          КАК Серия,
		|	ДД.АналитикаУчетаНоменклатуры.Назначение     КАК Назначение,
		|	ДД.ВидЗапасов,
		|	ДД.АналитикаУчетаПартий,
		|	ДД.КоличествоОстаток КАК Количество,
		|	ДД.СтоимостьОстаток КАК Стоимость,
		|	ДД.СтоимостьБезНДСОстаток КАК СтоимостьБезНДС,
		|	ДД.СтоимостьРеглОстаток КАК СтоимостьРегл,
		|	ДД.НДСРеглОстаток КАК НДСРегл,
		|	ДД.ПостояннаяРазницаОстаток КАК ПостояннаяРазница,
		|	ДД.ВременнаяРазницаОстаток КАК ВременнаяРазница,
		|	АналитикиПартий.НалогообложениеНДС
		|ИЗ
		|	РегистрНакопления.ПартииТоваровОрганизаций.Остатки(&НачалоПериода, Организация В (&МассивОрганизаций)) КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаПартий КАК АналитикиПартий
		|		ПО АналитикиПартий.КлючАналитики = ДД.АналитикаУчетаПартий
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ВидыЗапасов КАК ВидыЗапасов
		|		ПО ВидыЗапасов.Ссылка = ДД.ВидЗапасов
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ЗаказыИзАналитикРасходовСводно КАК Заказы
		|		ПО Заказы.Поступление = ДД.ДокументПоступления
		|		И Заказы.Номенклатура = ДД.АналитикаУчетаНоменклатуры.Номенклатура
		|		И Заказы.Характеристика = ДД.АналитикаУчетаНоменклатуры.Характеристика
		|		И Заказы.Склад = ДД.АналитикаУчетаНоменклатуры.МестоХранения
		|		И Заказы.Назначение = ДД.АналитикаУчетаНоменклатуры.Назначение
		|		И Заказы.ДатаПоступления < &НачалоПериода
		|ГДЕ
		|	ДД.КоличествоОстаток > 0
		|	И ВидыЗапасов.ТипЗапасов В (&СобственныеТипыЗапасов)
		|";
КонецФункции

Функция ТекстПриходыПоступленийПоЗаказам() // использует ЗаказыИзАналитикРасходов
	Возврат "
		|ВЫБРАТЬ
		|	90 КАК Приоритет,
		|	""Потребление"" КАК ТипЗаписи,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) КАК ВидДвижения,
		|	Заказы.ДатаПоступления КАК Период,
		|	ДД.Регистратор КАК Регистратор,
		|	ДД.ДокументПоступления КАК ДокументПоступления,
		|	НЕОПРЕДЕЛЕНО КАК Заказ,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.АналитикаУчетаНоменклатуры.Номенклатура   КАК Номенклатура,
		|	ДД.АналитикаУчетаНоменклатуры.Характеристика КАК Характеристика,
		|	ДД.АналитикаУчетаНоменклатуры.МестоХранения  КАК МестоХранения,
		|	ДД.АналитикаУчетаНоменклатуры.Серия          КАК Серия,
		|	ДД.АналитикаУчетаНоменклатуры.Назначение     КАК Назначение,
		|	ДД.ВидЗапасов,
		|	ДД.АналитикаУчетаПартий,
		|	ДД.Количество,
		|	ДД.Стоимость,
		|	ДД.СтоимостьБезНДС,
		|	ДД.СтоимостьРегл,
		|	ДД.НДСРегл,
		|	ДД.ПостояннаяРазница,
		|	ДД.ВременнаяРазница,
		|	АналитикиПартий.НалогообложениеНДС
		|ИЗ
		|	РегистрНакопления.ПартииТоваровОрганизаций КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаПартий КАК АналитикиПартий
		|		ПО АналитикиПартий.КлючАналитики = ДД.АналитикаУчетаПартий
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ВидыЗапасов КАК ВидыЗапасов
		|		ПО ВидыЗапасов.Ссылка = ДД.ВидЗапасов
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ЗаказыИзАналитикРасходовСводно КАК Заказы
		|		ПО Заказы.Поступление = ДД.Регистратор
		|		И Заказы.Номенклатура = ДД.АналитикаУчетаНоменклатуры.Номенклатура
		|		И Заказы.Характеристика = ДД.АналитикаУчетаНоменклатуры.Характеристика
		|		И Заказы.Склад = ДД.АналитикаУчетаНоменклатуры.МестоХранения
		|		И Заказы.Назначение = ДД.АналитикаУчетаНоменклатуры.Назначение
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И ВидыЗапасов.ТипЗапасов В (&СобственныеТипыЗапасов)
		|";
КонецФункции

Функция ТекстПриходыРаботПоЗаказам() // использует ЗаказыИзАналитикРасходов
	Возврат "
		|ВЫБРАТЬ
		|	90 КАК Приоритет,
		|	""Потребление"" КАК ТипЗаписи,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) КАК ВидДвижения,
		|	Заказы.ДатаПоступления КАК Период,
		|	ДД.Регистратор КАК Регистратор,
		|	ДД.ДокументПоступления КАК ДокументПоступления,
		|	НЕОПРЕДЕЛЕНО КАК Заказ,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.АналитикаУчетаНоменклатуры.Номенклатура   КАК Номенклатура,
		|	ДД.АналитикаУчетаНоменклатуры.Характеристика КАК Характеристика,
		|	ЗНАЧЕНИЕ(Справочник.Склады.ПустаяСсылка)     КАК Склад,
		|	ДД.АналитикаУчетаНоменклатуры.Серия          КАК Серия,
		|	ДД.АналитикаУчетаНоменклатуры.Назначение     КАК Назначение,
		|	ДД.ВидЗапасов,
		|	ДД.АналитикаУчетаПартий,
		|	ДД.Количество,
		|	ДД.Стоимость,
		|	ДД.СтоимостьБезНДС,
		|	ДД.СтоимостьРегл,
		|	ДД.НДСРегл,
		|	ДД.ПостояннаяРазница,
		|	ДД.ВременнаяРазница,
		|	АналитикиПартий.НалогообложениеНДС
		|ИЗ
		|	РегистрНакопления.ПартииПроизводственныхЗатрат КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Номенклатура КАК Работы
		|		ПО Работы.Ссылка = ДД.АналитикаУчетаНоменклатуры.Номенклатура
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаПартий КАК АналитикиПартий
		|		ПО АналитикиПартий.КлючАналитики = ДД.АналитикаУчетаПартий
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ВидыЗапасов КАК ВидыЗапасов
		|		ПО ВидыЗапасов.Ссылка = ДД.ВидЗапасов
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ЗаказыИзАналитикРасходовСводно КАК Заказы
		|		ПО Заказы.Поступление = ДД.Регистратор
		|		И Заказы.Номенклатура = ДД.АналитикаУчетаНоменклатуры.Номенклатура
		|		И Заказы.Характеристика = ДД.АналитикаУчетаНоменклатуры.Характеристика
		|		И Заказы.Назначение = ДД.АналитикаУчетаНоменклатуры.Назначение
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И Работы.ТипНоменклатуры = ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.Работа)
		|	И ВидыЗапасов.ТипЗапасов В (&СобственныеТипыЗапасов)
		|";
КонецФункции

Функция ТекстПартииПоЗаказам() // вт ПартииПоЗаказам, использует &РасчетныеПартииПоЗаказам
	Возврат "
		|ВЫБРАТЬ
		|	ДД.Приоритет,
		|	ДД.ТипЗаписи,
		|	ДД.ВидДвижения,
		|	ДД.Период,
		|	ДД.Заказ,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.Регистратор,
		|	ДД.ДокументПоступления,
		|	ДД.ВидЗапасов,
		|	ДД.Количество,
		|	ДД.Стоимость,
		|	ДД.СтоимостьБезНДС,
		|	ДД.СтоимостьРегл,
		|	ДД.НДСРегл,
		|	ДД.ПостояннаяРазница,
		|	ДД.ВременнаяРазница,
		|	ДД.НалогообложениеНДС
		|ПОМЕСТИТЬ
		|	ПартииПоЗаказам
		|ИЗ
		|	&РасчетныеПартииПоЗаказам КАК ДД
		|";
КонецФункции

Функция ТекстОписаниеПартийПрочих()
	Возврат "
		|ВЫБРАТЬ ПЕРВЫЕ 0
		|	ВЫРАЗИТЬ("""" КАК СТРОКА(80)) КАК ЗапросИсточник,
		|	0 КАК Приоритет,
		|	""ХХХХХХХХХХХХХХХХ"" КАК ТипЗаписи,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ДД.ВидДвижения,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка) КАК Номенклатура,
		|	ЗНАЧЕНИЕ(Справочник.Склады.ПустаяСсылка) КАК Склад,
		|	НЕОПРЕДЕЛЕНО КАК ДокументПоступления,
		|	ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка) КАК ВидЗапасов,
		|	ДД.АналитикаУчетаПартий,
		|	ДД.НаправлениеДеятельности,
		|	ДД.АналитикаУчетаПартий.Контрагент КАК Поставщик,
		|	ДД.ДокументПоступленияРасходов,
		|	ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.ПустаяСсылка) КАК ВидЦенности,
		|	ДД.АналитикаУчетаПартий.СтавкаНДС КАК СтавкаНДС,
		|	ДД.СтатьяРасходов,
		|	ДД.Подразделение,
		|	ДД.АналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРаспределения,
		|	0 КАК Базис,
		|	0 КАК Количество,
		|	0 КАК Вес,
		|	0 КАК Объем,
		|	ДД.Стоимость,
		|	ДД.СтоимостьБезНДС,
		|	ДД.СтоимостьРегл,
		|	ДД.НДСРегл,
		|	ДД.ПостояннаяРазница,
		|	ДД.ВременнаяРазница,
		|	ДД.АналитикаУчетаПартий.НалогообложениеНДС КАК НалогообложениеПартии,
		|	ДД.НалогообложениеНДС,
		|	ДД.ХозяйственнаяОперация,
		|	ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка) КАК ПодразделениеРасходов,
		|	ДД.ДокументРеализации,
		|	НЕОПРЕДЕЛЕНО КАК ДокументИсточник,
		|	ДД.СтатьяОтраженияРасходов,
		|	ЗНАЧЕНИЕ(Перечисление.ВариантыРаздельногоУчетаНДС.ПустаяСсылка)	КАК ВариантРаздельногоУчетаНДС,
		|	ДД.АналитикаОтраженияРасходов,
		|	ЗНАЧЕНИЕ(Перечисление.ПравилаРаспределенияНаСебестоимостьТоваров.ПустаяСсылка) КАК ПравилоРаспределения,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КАК РазделУчета,
		|	ДАТАВРЕМЯ(1, 1, 1, 0, 0, 0) КАК РасчетныйПериод,
		|	ДД.РасчетПартий
		|ИЗ
		|	РегистрНакопления.ПартииПрочихРасходов КАК ДД
		|";
КонецФункции

Функция ТекстОстаткиПартийПрочих() // использует АналитикиРасходовВсе
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстОстаткиПартийПрочих"" КАК ЗапросИсточник,
		|	10 КАК Приоритет,
		|	""Остаток"" КАК ТипЗаписи,
		|	ИСТИНА КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
		|	Периоды.Период,
		|	ДД.ДокументПоступленияРасходов КАК Регистратор,
		|	ДД.Организация,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КАК АналитикаУчетаНоменклатуры,
		|	НЕОПРЕДЕЛЕНО КАК Номенклатура,
		|	НЕОПРЕДЕЛЕНО КАК Склад,
		|	НЕОПРЕДЕЛЕНО КАК ДокументПоступления,
		|	ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка) КАК ВидЗапасов,
		|	ДД.АналитикаУчетаПартий,
		|	ДД.НаправлениеДеятельности,
		|	ДД.АналитикаУчетаПартий.Контрагент КАК Поставщик,
		|	ДД.ДокументПоступленияРасходов,
		|	НЕОПРЕДЕЛЕНО КАК ВидЦенности,
		|	ДД.АналитикаУчетаПартий.СтавкаНДС КАК СтавкаНДС,
		|	ДД.СтатьяРасходов,
		|	ДД.Подразделение,
		|	ДД.АналитикаРасходов,
		|	ДД.АналитикаРасходов КАК АналитикаРаспределения,
		|	0 КАК Базис,
		|	0 КАК Количество,
		|	0 КАК Вес,
		|	0 КАК Объем,
		|	(ВЫБОР
		|		КОГДА Статьи.ВариантРаспределенияРасходовУпр =
		|				ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаСебестоимостьТоваров)
		|			ТОГДА ДД.СтоимостьОстаток
		|		ИНАЧЕ 0 КОНЕЦ) КАК Стоимость,
		|	(ВЫБОР
		|		КОГДА Статьи.ВариантРаспределенияРасходовУпр =
		|				ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаСебестоимостьТоваров)
		|			ТОГДА ДД.СтоимостьБезНДСОстаток
		|		ИНАЧЕ 0 КОНЕЦ) КАК СтоимостьБезНДС,
		|	(ВЫБОР
		|		КОГДА Статьи.ВариантРаспределенияРасходовРегл =
		|				ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаСебестоимостьТоваров)
		|			ТОГДА ДД.СтоимостьРеглОстаток
		|		ИНАЧЕ 0 КОНЕЦ) КАК СтоимостьРегл,
		|	(ВЫБОР
		|		КОГДА Статьи.ВариантРаспределенияРасходовРегл =
		|				ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаСебестоимостьТоваров)
		|			ТОГДА ДД.НДСРеглОстаток
		|		ИНАЧЕ 0 КОНЕЦ) КАК НДСРегл,
		|	(ВЫБОР
		|		КОГДА Статьи.ВариантРаспределенияРасходовРегл =
		|				ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаСебестоимостьТоваров)
		|			ТОГДА ДД.ПостояннаяРазницаОстаток
		|		ИНАЧЕ 0 КОНЕЦ) КАК ПостояннаяРазница,
		|	(ВЫБОР
		|		КОГДА Статьи.ВариантРаспределенияРасходовРегл =
		|				ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаСебестоимостьТоваров)
		|			ТОГДА ДД.ВременнаяРазницаОстаток
		|		ИНАЧЕ 0 КОНЕЦ) КАК ВременнаяРазница,
		|	ДД.АналитикаУчетаПартий.НалогообложениеНДС КАК НалогообложениеПартии,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка) КАК НалогообложениеНДС,
		|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПустаяСсылка) КАК ХозяйственнаяОперация,
		|	ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка) КАК ПодразделениеРасходов,
		|	НЕОПРЕДЕЛЕНО КАК ДокументРеализации,
		|	НЕОПРЕДЕЛЕНО КАК ДокументИсточник,
		|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) КАК СтатьяОтраженияРасходов,
		|	ЗНАЧЕНИЕ(Перечисление.ВариантыРаздельногоУчетаНДС.ПустаяСсылка)	КАК ВариантРаздельногоУчетаНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаОтраженияРасходов,
		|	Правила.БазаРаспределенияПоПартиям КАК ПравилоРаспределения,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КАК РазделУчета,
		|	&НачалоПериода КАК РасчетныйПериод,
		|	ЛОЖЬ КАК РасчетПартий
		|ИЗ
		|	РегистрНакопления.ПартииПрочихРасходов.Остатки(&НачалоПериода, Организация В (&МассивОрганизаций)) КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ПланВидовХарактеристик.СтатьиРасходов КАК Статьи
		|		ПО Статьи.Ссылка = ДД.СтатьяРасходов
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ПравилаРаспределенияРасходов КАК Правила
		|		ПО Правила.Ссылка = Статьи.ПравилоРаспределенияРасходовУпр
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ (
		|		ВЫБРАТЬ
		|			ДД.Регистратор КАК ДокументПоступленияРасходов,
		|			ДД.Организация,
		|			ДД.СтатьяРасходов,
		|			ДД.АналитикаРасходов,
		|			ДД.НаправлениеДеятельности,
		|			МАКСИМУМ(ДД.Период) КАК Период
		|		ИЗ
		|			РегистрНакопления.ПартииПрочихРасходов КАК ДД
		|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ АналитикиРасходовВсе КАК КлючиРасходов
		|				ПО КлючиРасходов.Организация = ДД.Организация
		|				И КлючиРасходов.СтатьяРасходов = ДД.СтатьяРасходов
		|				И КлючиРасходов.АналитикаРасходов = ДД.АналитикаРасходов
		|				И КлючиРасходов.НаправлениеДеятельности = ДД.НаправлениеДеятельности
		|			ЛЕВОЕ СОЕДИНЕНИЕ Документ.КорректировкаПриобретения КАК Корректировка
		|				ПО Корректировка.Ссылка = ДД.Регистратор
		|			ЛЕВОЕ СОЕДИНЕНИЕ Документ.СчетФактураПолученныйНалоговыйАгент КАК СчетФактура
		|				ПО СчетФактура.Ссылка = ДД.Регистратор
		|		ГДЕ
		|			ДД.Период < &НачалоПериода
		|			И ДД.Организация В (&МассивОрганизаций)
		|			И ДД.Активность
		|			И ДД.ДокументПоступленияРасходов В (
		|				ДД.Регистратор,
		|				СчетФактура.СчетФактураОснование,
		|				Корректировка.ДокументОснование)
		|			И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|		СГРУППИРОВАТЬ ПО
		|			ДД.Регистратор,
		|			ДД.Организация,
		|			ДД.СтатьяРасходов,
		|			ДД.АналитикаРасходов,
		|			ДД.НаправлениеДеятельности
		|	) КАК Периоды
		|		ПО Периоды.ДокументПоступленияРасходов = ДД.ДокументПоступленияРасходов
		|		И Периоды.Организация = ДД.Организация
		|		И Периоды.СтатьяРасходов = ДД.СтатьяРасходов
		|		И Периоды.АналитикаРасходов = ДД.АналитикаРасходов
		|		И Периоды.НаправлениеДеятельности = ДД.НаправлениеДеятельности
		|ГДЕ
		|	(Статьи.ВариантРаспределенияРасходовУпр =
		|		ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаСебестоимостьТоваров)
		|	ИЛИ Статьи.ВариантРаспределенияРасходовРегл =
		|		ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаСебестоимостьТоваров))
		|";
КонецФункции

Функция ТекстПриходыПартийПрочих() // использует Декларации
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстПриходыПартийПрочих"" КАК ЗапросИсточник,
		|	10 КАК Приоритет,
		|	""Партия"" КАК ТипЗаписи,
		|	ИСТИНА КАК РасчетЗавершен,
		|	ДД.ВидДвижения,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КАК АналитикаУчетаНоменклатуры,
		|	НЕОПРЕДЕЛЕНО КАК Номенклатура,
		|	НЕОПРЕДЕЛЕНО КАК Склад,
		|	НЕОПРЕДЕЛЕНО КАК ДокументПоступления,
		|	ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка) КАК ВидЗапасов,
		|	ДД.АналитикаУчетаПартий,
		|	ДД.НаправлениеДеятельности,
		|	ДД.АналитикаУчетаПартий.Контрагент КАК Поставщик,
		|	ДД.ДокументПоступленияРасходов,
		|	НЕОПРЕДЕЛЕНО КАК ВидЦенности,
		|	ДД.АналитикаУчетаПартий.СтавкаНДС КАК СтавкаНДС,
		|	ДД.СтатьяРасходов,
		|	ДД.Подразделение,
		|	ДД.АналитикаРасходов,
		|	(ВЫБОР
		|		КОГДА ДД.Регистратор ССЫЛКА Документ.ТаможеннаяДекларацияИмпорт
		|		 И ДД.АналитикаРасходов = ЗНАЧЕНИЕ(Документ.ПриобретениеТоваровУслуг.ПустаяСсылка)
		|			ТОГДА ЗНАЧЕНИЕ(Документ.ТаможеннаяДекларацияИмпорт.ПустаяСсылка)
		|		ИНАЧЕ ЕСТЬNULL(Декларации.Ссылка, ДД.АналитикаРасходов) КОНЕЦ) КАК АналитикаРаспределения,
		|	0 КАК Базис,
		|	0 КАК Количество,
		|	0 КАК Вес,
		|	0 КАК Объем,
		|	СУММА(ВЫБОР
		|		КОГДА Статьи.ВариантРаспределенияРасходовУпр =
		|				ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаСебестоимостьТоваров)
		|			ТОГДА ДД.Стоимость / ЕСТЬNULL(Знаменатели.Количество, 1)
		|		ИНАЧЕ 0 КОНЕЦ) КАК Стоимость,
		|	СУММА(ВЫБОР
		|		КОГДА Статьи.ВариантРаспределенияРасходовУпр =
		|				ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаСебестоимостьТоваров)
		|			ТОГДА ДД.СтоимостьБезНДС / ЕСТЬNULL(Знаменатели.Количество, 1)
		|		ИНАЧЕ 0 КОНЕЦ) КАК СтоимостьБезНДС,
		|	СУММА(ВЫБОР
		|		КОГДА Статьи.ВариантРаспределенияРасходовРегл =
		|				ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаСебестоимостьТоваров)
		|			ТОГДА ДД.СтоимостьРегл / ЕСТЬNULL(Знаменатели.Количество, 1)
		|		ИНАЧЕ 0 КОНЕЦ) КАК СтоимостьРегл,
		|	СУММА(ВЫБОР
		|		КОГДА Статьи.ВариантРаспределенияРасходовРегл =
		|				ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаСебестоимостьТоваров)
		|			ТОГДА ДД.НДСРегл / ЕСТЬNULL(Знаменатели.Количество, 1)
		|		ИНАЧЕ 0 КОНЕЦ) КАК НДСРегл,
		|	СУММА(ВЫБОР
		|		КОГДА Статьи.ВариантРаспределенияРасходовРегл =
		|				ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаСебестоимостьТоваров)
		|			ТОГДА ДД.ПостояннаяРазница / ЕСТЬNULL(Знаменатели.Количество, 1)
		|		ИНАЧЕ 0 КОНЕЦ) КАК ПостояннаяРазница,
		|	СУММА(ВЫБОР
		|		КОГДА Статьи.ВариантРаспределенияРасходовРегл =
		|				ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаСебестоимостьТоваров)
		|			ТОГДА ДД.ВременнаяРазница / ЕСТЬNULL(Знаменатели.Количество, 1)
		|		ИНАЧЕ 0 КОНЕЦ) КАК ВременнаяРазница,
		|	ДД.АналитикаУчетаПартий.НалогообложениеНДС КАК НалогообложениеПартии,
		|	ДД.НалогообложениеНДС,
		|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПустаяСсылка) КАК ХозяйственнаяОперация,
		|	ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка) КАК ПодразделениеРасходов,
		|	ДД.ДокументРеализации,
		|	НЕОПРЕДЕЛЕНО КАК ДокументИсточник,
		|	ДД.СтатьяОтраженияРасходов,
		|	ЗНАЧЕНИЕ(Перечисление.ВариантыРаздельногоУчетаНДС.ПустаяСсылка)	КАК ВариантРаздельногоУчетаНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаОтраженияРасходов,
		|	Правила.БазаРаспределенияПоПартиям КАК ПравилоРаспределения,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КАК РазделУчета,
		|	ДД.Период КАК РасчетныйПериод,
		|	ЛОЖЬ КАК РасчетПартий
		|ИЗ
		|	РегистрНакопления.ПартииПрочихРасходов КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ПланВидовХарактеристик.СтатьиРасходов КАК Статьи
		|		ПО Статьи.Ссылка = ДД.СтатьяРасходов
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ПравилаРаспределенияРасходов КАК Правила
		|		ПО Правила.Ссылка = Статьи.ПравилоРаспределенияРасходовУпр
		|	ЛЕВОЕ СОЕДИНЕНИЕ Декларации КАК Декларации
		|		ПО Декларации.Поступление = ДД.АналитикаРасходов
		|	ЛЕВОЕ СОЕДИНЕНИЕ КоличествоДеклараций КАК Знаменатели
		|		ПО Знаменатели.Поступление = ДД.АналитикаРасходов
		|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.КорректировкаПриобретения КАК Корректировка
		|		ПО Корректировка.Ссылка = ДД.Регистратор
		|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.СчетФактураПолученныйНалоговыйАгент КАК СчетФактура
		|		ПО СчетФактура.Ссылка = ДД.Регистратор
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И ДД.ДокументПоступленияРасходов В (
		|		ДД.Регистратор,
		|		СчетФактура.СчетФактураОснование,
		|		Корректировка.ДокументОснование)
		|	И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|	И (Статьи.ВариантРаспределенияРасходовУпр =
		|			ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаСебестоимостьТоваров)
		|		ИЛИ Статьи.ВариантРаспределенияРасходовРегл =
		|			ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаСебестоимостьТоваров))
		|СГРУППИРОВАТЬ ПО
		|	ДД.ВидДвижения,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаПартий,
		|	ДД.НаправлениеДеятельности,
		|	ДД.ДокументПоступленияРасходов,
		|	ДД.СтатьяРасходов,
		|	ДД.Подразделение,
		|	ДД.АналитикаРасходов,
		|	(ВЫБОР
		|		КОГДА ДД.Регистратор ССЫЛКА Документ.ТаможеннаяДекларацияИмпорт
		|		 И ДД.АналитикаРасходов = ЗНАЧЕНИЕ(Документ.ПриобретениеТоваровУслуг.ПустаяСсылка)
		|			ТОГДА ЗНАЧЕНИЕ(Документ.ТаможеннаяДекларацияИмпорт.ПустаяСсылка)
		|		ИНАЧЕ ЕСТЬNULL(Декларации.Ссылка, ДД.АналитикаРасходов) КОНЕЦ),
		|	ДД.АналитикаУчетаПартий.НалогообложениеНДС,
		|	ДД.НалогообложениеНДС,
		|	ДД.ДокументРеализации,
		|	ДД.СтатьяОтраженияРасходов,
		|	Правила.БазаРаспределенияПоПартиям
		|";
КонецФункции

Функция ТекстДополненияПартийПрочих() // использует РегистраторыПрочих
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстДополненияПартийПрочих"" КАК ЗапросИсточник,
		|	99 КАК Приоритет,
		|	""Дополнение"" КАК ТипЗаписи,
		|	ИСТИНА КАК РасчетЗавершен,
		|	ДД.ВидДвижения,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КАК АналитикаУчетаНоменклатуры,
		|	НЕОПРЕДЕЛЕНО КАК Номенклатура,
		|	НЕОПРЕДЕЛЕНО КАК Склад,
		|	НЕОПРЕДЕЛЕНО КАК ДокументПоступления,
		|	ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка) КАК ВидЗапасов,
		|	ДД.АналитикаУчетаПартий,
		|	ДД.НаправлениеДеятельности,
		|	НЕОПРЕДЕЛЕНО КАК Поставщик,
		|	ДД.ДокументПоступленияРасходов,
		|	НЕОПРЕДЕЛЕНО КАК ВидЦенности,
		|	НЕОПРЕДЕЛЕНО КАК СтавкаНДС,
		|	ДД.СтатьяРасходов,
		|	ДД.Подразделение,
		|	ДД.АналитикаРасходов,
		|	ДД.АналитикаРасходов КАК АналитикаРаспределения,
		|	0 КАК Базис,
		|	0 КАК Количество,
		|	0 КАК Вес,
		|	0 КАК Объем,
		|	ДД.Стоимость,
		|	ДД.СтоимостьБезНДС,
		|	ДД.СтоимостьРегл,
		|	ДД.НДСРегл,
		|	ДД.ПостояннаяРазница,
		|	ДД.ВременнаяРазница,
		|	ДД.АналитикаУчетаПартий.НалогообложениеНДС КАК НалогообложениеПартии,
		|	ДД.НалогообложениеНДС,
		|	ДД.ХозяйственнаяОперация,
		|	ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка) КАК ПодразделениеРасходов,
		|	ДД.ДокументРеализации,
		|	НЕОПРЕДЕЛЕНО КАК ДокументИсточник,
		|	ДД.СтатьяОтраженияРасходов,
		|	ЗНАЧЕНИЕ(Перечисление.ВариантыРаздельногоУчетаНДС.ПустаяСсылка)	КАК ВариантРаздельногоУчетаНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаОтраженияРасходов,
		|	ЗНАЧЕНИЕ(Перечисление.ПравилаРаспределенияНаСебестоимостьТоваров.ПустаяСсылка) КАК ПравилоРаспределения,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КАК РазделУчета,
		|	ДД.Период КАК РасчетныйПериод,
		|	ДД.РасчетПартий
		|ИЗ
		|	РегистрНакопления.ПартииПрочихРасходов КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистраторыПрочих КАК Регистраторы
		|		ПО Регистраторы.Регистратор = ДД.Регистратор
		|	ЛЕВОЕ СОЕДИНЕНИЕ ПланВидовХарактеристик.СтатьиРасходов КАК Статьи
		|		ПО Статьи.Ссылка = ДД.СтатьяРасходов
		|ГДЕ
		|	НЕ ДД.РасчетПартий
		|	И (
		|		НЕ (ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода)
		|		И ДД.Организация В (&МассивОрганизаций)
		|		И ДД.Активность
		|	ИЛИ ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|	)
		|";
КонецФункции

Функция ТекстБазисОстатки() // использует АналитикиРасходовВсе, ОстаткиСебестоимости
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстБазисОстатки"" КАК ЗапросИсточник,
		|	90 КАК Приоритет,
		|	""Потребление"" КАК ТипЗаписи,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) КАК ВидДвижения,
		|	&НачалоПериода КАК Период,
		|	ДД.ДокументПоступления КАК Регистратор,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	СпрНоменклатура.Ссылка КАК Номенклатура,
		|	АналитикиТоваров.МестоХранения КАК Склад,
		|	ДД.ДокументПоступления,
		|	ДД.ВидЗапасов,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка) КАК АналитикаУчетаПартий,
		|	ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка) КАК НаправлениеДеятельности,
		|	НЕОПРЕДЕЛЕНО КАК Поставщик,
		|	НЕОПРЕДЕЛЕНО КАК ДокументПоступленияРасходов,
		|	НЕОПРЕДЕЛЕНО КАК ВидЦенности,
		|	НЕОПРЕДЕЛЕНО КАК СтавкаНДС,
		|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) КАК СтатьяРасходов,
		|	ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка) КАК Подразделение,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРаспределения,
		|	0 КАК Базис,
		|	ДД.КоличествоОстаток КАК Количество,
		|	&Вес * ДД.КоличествоОстаток КАК Вес,
		|	&Объем * ДД.КоличествоОстаток КАК Объем,
		|	(ВЫБОР
		|		КОГДА ДД.Организация В (&ОрганизацииСФИФОСкользящая) ТОГДА ДД.СтоимостьОстаток
		|		ИНАЧЕ ДД.СтоимостьРеглОстаток КОНЕЦ) КАК Стоимость,
		|	ДД.СтоимостьБезНДСОстаток КАК СтоимостьБезНДС,
		|	ДД.СтоимостьРеглОстаток КАК СтоимостьРегл,
		|	ДД.НДСРеглОстаток КАК НДСРегл,
		|	ДД.ПостояннаяРазницаОстаток КАК ПостояннаяРазница,
		|	ДД.ВременнаяРазницаОстаток КАК ВременнаяРазница,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка) КАК НалогообложениеПартии,
		|	ЕСТЬNULL(АналитикиПартий.НалогообложениеНДС,
		|		ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)) КАК НалогообложениеНДС,
		|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПустаяСсылка) КАК ХозяйственнаяОперация,
		|	ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка) КАК ПодразделениеРасходов,
		|	НЕОПРЕДЕЛЕНО КАК ДокументРеализации,
		|	НЕОПРЕДЕЛЕНО КАК ДокументИсточник,
		|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) КАК СтатьяОтраженияРасходов,
		|	ЗНАЧЕНИЕ(Перечисление.ВариантыРаздельногоУчетаНДС.ПустаяСсылка)	КАК ВариантРаздельногоУчетаНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаОтраженияРасходов,
		|	ЗНАЧЕНИЕ(Перечисление.ПравилаРаспределенияНаСебестоимостьТоваров.ПустаяСсылка) КАК ПравилоРаспределения,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыНаСкладах) КАК РазделУчета,
		|	&НачалоПериода КАК РасчетныйПериод,
		|	ЛОЖЬ КАК РасчетПартий
		|ИЗ
		|	РегистрНакопления.ПартииТоваровОрганизаций.Остатки(&НачалоПериода, Организация В (&МассивОрганизаций)) КАК ДД
		|	ЛЕВОЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК АналитикиТоваров
		|		ПО АналитикиТоваров.Ссылка = ДД.АналитикаУчетаНоменклатуры
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Номенклатура КАК СпрНоменклатура
		|		ПО СпрНоменклатура.Ссылка = АналитикиТоваров.Номенклатура
		|	ЛЕВОЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаПартий КАК АналитикиПартий
		|		ПО АналитикиПартий.Ссылка = ДД.АналитикаУчетаПартий
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ВидыЗапасов КАК ВидыЗапасов
		|		ПО ВидыЗапасов.Ссылка = ДД.ВидЗапасов
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ОстаткиСебестоимости КАК Остатки
		|		ПО Остатки.Организация = ДД.Организация
		|		И Остатки.Номенклатура = АналитикиТоваров.Номенклатура
		|		И Остатки.Характеристика = АналитикиТоваров.Характеристика
		|		И Остатки.Серия = АналитикиТоваров.Серия
		|		И Остатки.Склад = АналитикиТоваров.МестоХранения
		|		И (Остатки.Назначение = АналитикиТоваров.Назначение
		|			ИЛИ НЕ &УчитыватьНазначение)
		|ГДЕ
		|	ДД.СтоимостьОстаток > 0
		|	И (ДД.Организация,
		|		АналитикиТоваров.Номенклатура,
		|		АналитикиТоваров.МестоХранения,
		|		ЕСТЬNULL(АналитикиТоваров.Назначение.НаправлениеДеятельности,
		|			ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)),
		|		ДД.ДокументПоступления) В
		|	(
		|		ВЫБРАТЬ РАЗЛИЧНЫЕ
		|			КлючиРасходов.Организация,
		|			АналитикиТоваров.Номенклатура,
		|			АналитикиТоваров.МестоХранения,
		|			(ВЫБОР
		|				КОГДА КлючиРасходов.НаправлениеДеятельности = ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)
		|					ТОГДА ЕСТЬNULL(АналитикиТоваров.Назначение.НаправлениеДеятельности,
		|						ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка))
		|				ИНАЧЕ КлючиРасходов.НаправлениеДеятельности КОНЕЦ) КАК НаправлениеДеятельности,
		|			ДД.ДокументПоступления
		|		ИЗ
		|			АналитикиРасходовВсе КАК КлючиРасходов
		|		ГДЕ 
		|			КлючиРасходов.АналитикаРасходов В (
		|				АналитикиТоваров.Номенклатура,
		|				ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка),
		|				АналитикиТоваров.МестоХранения,
		|				ЗНАЧЕНИЕ(Справочник.Склады.ПустаяСсылка),
		|				ДД.ДокументПоступления)
		|	)
		|	И ВидыЗапасов.ТипЗапасов В (&СобственныеТипыЗапасов)
		|";
КонецФункции

Функция ТекстБазисОстаткиСборок() // использует ОстаткиПартийСборок, АналитикиРасходовВсе
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстБазисОстаткиСборок"" КАК ЗапросИсточник,
		|	90 КАК Приоритет,
		|	""Потребление"" КАК ТипЗаписи,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) КАК ВидДвижения,
		|	&НачалоПериода КАК Период,
		|	ДД.ДокументВыпуска КАК Регистратор,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаПродукции КАК АналитикаУчетаНоменклатуры,
		|	СпрНоменклатура.Ссылка КАК Номенклатура,
		|	АналитикиТоваров.МестоХранения КАК Склад,
		|	ДД.ДокументВыпуска КАК ДокументПоступления,
		|	Партии.ВидЗапасов,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка) КАК АналитикаУчетаПартий,
		|	ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка) КАК НаправлениеДеятельности,
		|	НЕОПРЕДЕЛЕНО КАК Поставщик,
		|	НЕОПРЕДЕЛЕНО КАК ДокументПоступленияРасходов,
		|	НЕОПРЕДЕЛЕНО КАК ВидЦенности,
		|	НЕОПРЕДЕЛЕНО КАК СтавкаНДС,
		|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) КАК СтатьяРасходов,
		|	ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка) КАК Подразделение,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРаспределения,
		|	0 КАК Базис,
		|	Партии.Количество,
		|	&Вес * Партии.Количество КАК Вес,
		|	&Объем * Партии.Количество КАК Объем,
		|	(ВЫБОР
		|		КОГДА ДД.Организация В (&ОрганизацииСФИФОСкользящая) ТОГДА ДД.СтоимостьОстаток
		|		ИНАЧЕ ДД.СтоимостьРеглОстаток КОНЕЦ) КАК Стоимость,
		|	ДД.СтоимостьБезНДСОстаток КАК СтоимостьБезНДС,
		|	ДД.СтоимостьРеглОстаток КАК СтоимостьРегл,
		|	ДД.НДСРеглОстаток КАК НДСРегл,
		|	ДД.ПостояннаяРазницаОстаток КАК ПостояннаяРазница,
		|	ДД.ВременнаяРазницаОстаток КАК ВременнаяРазница,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка) КАК НалогообложениеПартии,
		|	Партии.НалогообложениеНДС,
		|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПустаяСсылка) КАК ХозяйственнаяОперация,
		|	ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка) КАК ПодразделениеРасходов,
		|	НЕОПРЕДЕЛЕНО КАК ДокументРеализации,
		|	НЕОПРЕДЕЛЕНО КАК ДокументИсточник,
		|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) КАК СтатьяОтраженияРасходов,
		|	ЗНАЧЕНИЕ(Перечисление.ВариантыРаздельногоУчетаНДС.ПустаяСсылка)	КАК ВариантРаздельногоУчетаНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаОтраженияРасходов,
		|	ЗНАЧЕНИЕ(Перечисление.ПравилаРаспределенияНаСебестоимостьТоваров.ПустаяСсылка) КАК ПравилоРаспределения,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыНаСкладах) КАК РазделУчета,
		|	&НачалоПериода КАК РасчетныйПериод,
		|	ЛОЖЬ КАК РасчетПартий
		|ИЗ
		|	РегистрНакопления.ПартииЗатратНаВыпуск.Остатки(&НачалоПериода, Организация В (&МассивОрганизаций)) КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ОстаткиПартийСборок КАК Партии
		|		ПО Партии.Организация = ДД.Организация
		|		И Партии.АналитикаУчетаНоменклатуры = ДД.АналитикаУчетаПродукции
		|		И Партии.ДокументПоступления = ДД.ДокументВыпуска
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК АналитикиТоваров
		|		ПО АналитикиТоваров.Ссылка = ДД.АналитикаУчетаПродукции
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Номенклатура КАК СпрНоменклатура
		|		ПО СпрНоменклатура.Ссылка = АналитикиТоваров.Номенклатура
		|ГДЕ
		|	(ДД.Организация,
		|		АналитикиТоваров.Номенклатура,
		|		АналитикиТоваров.МестоХранения,
		|		ЕСТЬNULL(АналитикиТоваров.Назначение.НаправлениеДеятельности,
		|			ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)),
		|		ДД.ДокументВыпуска) В
		|	(
		|		ВЫБРАТЬ РАЗЛИЧНЫЕ
		|			КлючиРасходов.Организация,
		|			АналитикиТоваров.Номенклатура,
		|			АналитикиТоваров.МестоХранения,
		|			(ВЫБОР
		|				КОГДА КлючиРасходов.НаправлениеДеятельности = ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)
		|					ТОГДА ЕСТЬNULL(АналитикиТоваров.Назначение.НаправлениеДеятельности,
		|						ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка))
		|				ИНАЧЕ КлючиРасходов.НаправлениеДеятельности КОНЕЦ) КАК НаправлениеДеятельности,
		|			ДД.ДокументВыпуска
		|		ИЗ
		|			АналитикиРасходовВсе КАК КлючиРасходов
		|		ГДЕ 
		|			КлючиРасходов.АналитикаРасходов В (
		|				АналитикиТоваров.Номенклатура,
		|				ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка),
		|				АналитикиТоваров.МестоХранения,
		|				ЗНАЧЕНИЕ(Справочник.Склады.ПустаяСсылка),
		|				ДД.ДокументВыпуска)
		|	)
		|";
КонецФункции

Функция ТекстБазисПриходы() // использует АналитикиРасходовВсе
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстБазисПриходы"" КАК ЗапросИсточник,
		|	90 КАК Приоритет,
		|	""Потребление"" КАК ТипЗаписи,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) КАК ВидДвижения,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	СпрНоменклатура.Ссылка КАК Номенклатура,
		|	АналитикиТоваров.МестоХранения КАК Склад,
		|	ДД.ДокументПоступления,
		|	ДД.ВидЗапасов,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка) КАК АналитикаУчетаПартий,
		|	ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка) КАК НаправлениеДеятельности,
		|	НЕОПРЕДЕЛЕНО КАК Поставщик,
		|	НЕОПРЕДЕЛЕНО КАК ДокументПоступленияРасходов,
		|	НЕОПРЕДЕЛЕНО КАК ВидЦенности,
		|	НЕОПРЕДЕЛЕНО КАК СтавкаНДС,
		|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) КАК СтатьяРасходов,
		|	ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка) КАК Подразделение,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРаспределения,
		|	0 КАК Базис,
		|	СУММА(
		|		ВЫБОР КОГДА ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|			ТОГДА ДД.Количество
		|		ИНАЧЕ -ДД.Количество КОНЕЦ) КАК Количество,
		|	СУММА(&Вес
		|		* ВЫБОР КОГДА ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|			ТОГДА ДД.Количество
		|		ИНАЧЕ -ДД.Количество КОНЕЦ) КАК Вес,
		|	СУММА(&Объем
		|		* ВЫБОР КОГДА ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|			ТОГДА ДД.Количество
		|		ИНАЧЕ -ДД.Количество КОНЕЦ) КАК Объем,
		|	СУММА(
		|		ВЫБОР КОГДА ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|		 И ДД.Организация В (&ОрганизацииСФИФОСкользящая)
		|			ТОГДА ДД.Стоимость
		|		КОГДА ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|		 И НЕ ДД.Организация В (&ОрганизацииСФИФОСкользящая)
		|			ТОГДА ДД.СтоимостьРегл
		|		ИНАЧЕ -ДД.Стоимость КОНЕЦ) КАК Стоимость,
		|	СУММА(
		|		ВЫБОР КОГДА ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|			ТОГДА ДД.СтоимостьБезНДС
		|		ИНАЧЕ -ДД.СтоимостьБезНДС КОНЕЦ) КАК СтоимостьБезНДС,
		|	СУММА(
		|		ВЫБОР КОГДА ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|			ТОГДА ДД.СтоимостьРегл
		|		ИНАЧЕ -ДД.СтоимостьРегл КОНЕЦ) КАК СтоимостьРегл,
		|	СУММА(
		|		ВЫБОР КОГДА ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|			ТОГДА ДД.НДСРегл
		|		ИНАЧЕ -ДД.НДСРегл КОНЕЦ) КАК НДСРегл,
		|	СУММА(
		|		ВЫБОР КОГДА ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|			ТОГДА ДД.ПостояннаяРазница
		|		ИНАЧЕ -ДД.ПостояннаяРазница КОНЕЦ) КАК ПостояннаяРазница,
		|	СУММА(
		|		ВЫБОР КОГДА ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|			ТОГДА ДД.ВременнаяРазница
		|		ИНАЧЕ -ДД.ВременнаяРазница КОНЕЦ) КАК ВременнаяРазница,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка) КАК НалогообложениеПартии,
		|	АналитикиПартий.НалогообложениеНДС,
		|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПустаяСсылка) КАК ХозяйственнаяОперация,
		|	ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка) КАК ПодразделениеРасходов,
		|	НЕОПРЕДЕЛЕНО КАК ДокументРеализации,
		|	НЕОПРЕДЕЛЕНО КАК ДокументИсточник,
		|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) КАК СтатьяОтраженияРасходов,
		|	ЗНАЧЕНИЕ(Перечисление.ВариантыРаздельногоУчетаНДС.ПустаяСсылка)	КАК ВариантРаздельногоУчетаНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаОтраженияРасходов,
		|	ЗНАЧЕНИЕ(Перечисление.ПравилаРаспределенияНаСебестоимостьТоваров.ПустаяСсылка) КАК ПравилоРаспределения,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыНаСкладах) КАК РазделУчета,
		|	ДД.Период КАК РасчетныйПериод,
		|	ЛОЖЬ КАК РасчетПартий
		|ИЗ
		|	РегистрНакопления.ПартииТоваровОрганизаций КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК АналитикиТоваров
		|		ПО АналитикиТоваров.Ссылка = ДД.АналитикаУчетаНоменклатуры
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Номенклатура КАК СпрНоменклатура
		|		ПО СпрНоменклатура.Ссылка = АналитикиТоваров.Номенклатура
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Склады КАК Склады
		|		ПО АналитикиТоваров.МестоХранения = Склады.Ссылка
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаПартий КАК АналитикиПартий
		|		ПО АналитикиПартий.КлючАналитики = ДД.АналитикаУчетаПартий
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ВидыЗапасов КАК СпрВидыЗапасов
		|		ПО СпрВидыЗапасов.Ссылка = ДД.ВидЗапасов
		|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.ПеремещениеТоваров КАК Перемещения
		|		ПО Перемещения.Дата МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|		И Перемещения.Ссылка = ДД.Регистратор
		|		И Перемещения.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПеремещениеТоваровМеждуФилиалами)
		|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.ВозвратТоваровМеждуОрганизациями КАК Возвраты
		|		ПО Возвраты.Дата МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|		И Возвраты.Ссылка = ДД.Регистратор
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И (ДД.Регистратор = ДД.ДокументПоступления ИЛИ НЕ Перемещения.Ссылка ЕСТЬ NULL)
		|	И Возвраты.Ссылка ЕСТЬ NULL
		|	И НЕ ДД.Регистратор Ссылка Документ.СборкаТоваров
		|	И НЕ (ДД.Регистратор Ссылка Документ.ПередачаТоваровМеждуОрганизациями И ДД.Стоимость = 0)
		//++ НЕ УТ
		|	И НЕ (ДД.Регистратор Ссылка Документ.ВыпускПродукции И ДД.Стоимость = 0)
		|	И НЕ (ДД.Регистратор Ссылка Документ.ПоступлениеОтПереработчика И ДД.Стоимость = 0)
		//-- НЕ УТ
		|	И (ДД.Первичное ИЛИ
		|		ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|		И (ТИПЗНАЧЕНИЯ(ДД.Регистратор) = ТИП(Документ.ПередачаТоваровМеждуОрганизациями)
		|			ИЛИ ТИПЗНАЧЕНИЯ(ДД.Регистратор) = ТИП(Документ.ТаможеннаяДекларацияИмпорт)
		|			ИЛИ НЕ Перемещения.Ссылка ЕСТЬ NULL)
		|	)
		|	И (ДД.Организация,
		|		АналитикиТоваров.Номенклатура,
		|		АналитикиТоваров.МестоХранения,
		|		ЕСТЬNULL(АналитикиТоваров.Назначение.НаправлениеДеятельности,
		|			ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)),
		|		ДД.Регистратор) В
		|	(
		|		ВЫБРАТЬ РАЗЛИЧНЫЕ
		|			КлючиРасходов.Организация,
		|			АналитикиТоваров.Номенклатура,
		|			АналитикиТоваров.МестоХранения,
		|			(ВЫБОР
		|				КОГДА КлючиРасходов.НаправлениеДеятельности = ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)
		|					ТОГДА ЕСТЬNULL(АналитикиТоваров.Назначение.НаправлениеДеятельности,
		|						ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка))
		|				ИНАЧЕ КлючиРасходов.НаправлениеДеятельности КОНЕЦ) КАК НаправлениеДеятельности,
		|			ДД.Регистратор
		|		ИЗ
		|			АналитикиРасходовВсе КАК КлючиРасходов
		|		ГДЕ 
		|			КлючиРасходов.АналитикаРасходов В (
		|				АналитикиТоваров.Номенклатура,
		|				ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка),
		|				АналитикиТоваров.МестоХранения,
		|				ЗНАЧЕНИЕ(Справочник.Склады.ПустаяСсылка),
		|				ДД.ДокументПоступления)
		|			ИЛИ
		|			ТИПЗНАЧЕНИЯ(ДД.Регистратор) = ТИПЗНАЧЕНИЯ(КлючиРасходов.АналитикаРасходов)
		|			И КлючиРасходов.АналитикаРасходов В (
		|				ЗНАЧЕНИЕ(Документ.ПриобретениеТоваровУслуг.ПустаяСсылка),
		|				ЗНАЧЕНИЕ(Документ.ТаможеннаяДекларацияИмпорт.ПустаяСсылка),
		|				ЗНАЧЕНИЕ(Документ.ПередачаТоваровМеждуОрганизациями.ПустаяСсылка))
		|	)
		|	И СпрВидыЗапасов.ТипЗапасов В (&СобственныеТипыЗапасов)
		|
		|СГРУППИРОВАТЬ ПО
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	СпрНоменклатура.Ссылка,
		|	АналитикиТоваров.МестоХранения,
		|	ДД.ДокументПоступления,
		|	ДД.ВидЗапасов,
		|	АналитикиПартий.НалогообложениеНДС
		|";
КонецФункции

Функция ТекстБазисКорректировкиПоступлений() // использует АналитикиРасходовВсе
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстБазисКорректировкиПоступлений"" КАК ЗапросИсточник,
		|	90 КАК Приоритет,
		|	""Потребление"" КАК ТипЗаписи,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) КАК ВидДвижения,
		|	Поступление.Дата КАК Период,
		|	ДД.ДокументПоступления КАК Регистратор,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	СпрНоменклатура.Ссылка КАК Номенклатура,
		|	АналитикиТоваров.МестоХранения КАК Склад,
		|	ДД.ДокументПоступления,
		|	ДД.ВидЗапасов,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка) КАК АналитикаУчетаПартий,
		|	ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка) КАК НаправлениеДеятельности,
		|	НЕОПРЕДЕЛЕНО КАК Поставщик,
		|	НЕОПРЕДЕЛЕНО КАК ДокументПоступленияРасходов,
		|	НЕОПРЕДЕЛЕНО КАК ВидЦенности,
		|	НЕОПРЕДЕЛЕНО КАК СтавкаНДС,
		|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) КАК СтатьяРасходов,
		|	ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка) КАК Подразделение,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРаспределения,
		|	0. КАК Базис,
		|	СУММА(
		|		ВЫБОР КОГДА ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|			ТОГДА ДД.Количество
		|		ИНАЧЕ -ДД.Количество КОНЕЦ) КАК Количество,
		|	СУММА(&Вес
		|		* ВЫБОР КОГДА ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|			ТОГДА ДД.Количество
		|		ИНАЧЕ -ДД.Количество КОНЕЦ) КАК Вес,
		|	СУММА(&Объем
		|		* ВЫБОР КОГДА ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|			ТОГДА ДД.Количество
		|		ИНАЧЕ -ДД.Количество КОНЕЦ) КАК Объем,
		|	СУММА(
		|		ВЫБОР КОГДА ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|			ТОГДА ДД.Стоимость
		|		ИНАЧЕ -ДД.Стоимость КОНЕЦ) КАК Стоимость,
		|	СУММА(
		|		ВЫБОР КОГДА ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|			ТОГДА ДД.СтоимостьБезНДС
		|		ИНАЧЕ -ДД.СтоимостьБезНДС КОНЕЦ) КАК СтоимостьБезНДС,
		|	СУММА(
		|		ВЫБОР КОГДА ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|			ТОГДА ДД.СтоимостьРегл
		|		ИНАЧЕ -ДД.СтоимостьРегл КОНЕЦ) КАК СтоимостьРегл,
		|	СУММА(
		|		ВЫБОР КОГДА ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|			ТОГДА ДД.НДСРегл
		|		ИНАЧЕ -ДД.НДСРегл КОНЕЦ) КАК НДСРегл,
		|	СУММА(
		|		ВЫБОР КОГДА ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|			ТОГДА ДД.ПостояннаяРазница
		|		ИНАЧЕ -ДД.ПостояннаяРазница КОНЕЦ) КАК ПостояннаяРазница,
		|	СУММА(
		|		ВЫБОР КОГДА ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|			ТОГДА ДД.ВременнаяРазница
		|		ИНАЧЕ -ДД.ВременнаяРазница КОНЕЦ) КАК ВременнаяРазница,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка) КАК НалогообложениеПартии,
		|	АналитикиПартий.НалогообложениеНДС,
		|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПустаяСсылка) КАК ХозяйственнаяОперация,
		|	ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка) КАК ПодразделениеРасходов,
		|	НЕОПРЕДЕЛЕНО КАК ДокументРеализации,
		|	НЕОПРЕДЕЛЕНО КАК ДокументИсточник,
		|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) КАК СтатьяОтраженияРасходов,
		|	ЗНАЧЕНИЕ(Перечисление.ВариантыРаздельногоУчетаНДС.ПустаяСсылка)	КАК ВариантРаздельногоУчетаНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаОтраженияРасходов,
		|	ЗНАЧЕНИЕ(Перечисление.ПравилаРаспределенияНаСебестоимостьТоваров.ПустаяСсылка) КАК ПравилоРаспределения,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыНаСкладах) КАК РазделУчета,
		|	Поступление.Дата КАК РасчетныйПериод,
		|	ЛОЖЬ КАК РасчетПартий
		|ИЗ
		|	РегистрНакопления.ПартииТоваровОрганизаций КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК АналитикиТоваров
		|		ПО АналитикиТоваров.Ссылка = ДД.АналитикаУчетаНоменклатуры
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Номенклатура КАК СпрНоменклатура
		|		ПО СпрНоменклатура.Ссылка = АналитикиТоваров.Номенклатура
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Склады КАК Склады
		|		ПО АналитикиТоваров.МестоХранения = Склады.Ссылка
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаПартий КАК АналитикиПартий
		|		ПО АналитикиПартий.КлючАналитики = ДД.АналитикаУчетаПартий
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ВидыЗапасов КАК СпрВидыЗапасов
		|		ПО СпрВидыЗапасов.Ссылка = ДД.ВидЗапасов
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ПриобретениеТоваровУслуг КАК Поступление
		|		ПО Поступление.Ссылка = ДД.ДокументПоступления
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И ДД.Регистратор Ссылка Документ.КорректировкаПриобретения
		|	И ДД.Первичное
		|	И (ДД.Организация, АналитикиТоваров.Номенклатура, АналитикиТоваров.МестоХранения, ДД.ДокументПоступления) В (
		|		ВЫБРАТЬ РАЗЛИЧНЫЕ
		|			КлючиРасходов.Организация, АналитикиТоваров.Номенклатура, АналитикиТоваров.МестоХранения, ДД.ДокументПоступления
		|		ИЗ
		|			АналитикиРасходовВсе КАК КлючиРасходов
		|		ГДЕ 
		|			КлючиРасходов.АналитикаРасходов В (
		|				АналитикиТоваров.Номенклатура,
		|				ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка),
		|				АналитикиТоваров.МестоХранения,
		|				ЗНАЧЕНИЕ(Справочник.Склады.ПустаяСсылка),
		|				ДД.ДокументПоступления)
		|			ИЛИ
		|			ТИПЗНАЧЕНИЯ(ДД.ДокументПоступления) = ТИПЗНАЧЕНИЯ(КлючиРасходов.АналитикаРасходов)
		|			И КлючиРасходов.АналитикаРасходов В (
		|				ЗНАЧЕНИЕ(Документ.ПриобретениеТоваровУслуг.ПустаяСсылка),
		|				ЗНАЧЕНИЕ(Документ.ТаможеннаяДекларацияИмпорт.ПустаяСсылка),
		|				ЗНАЧЕНИЕ(Документ.ПередачаТоваровМеждуОрганизациями.ПустаяСсылка))
		|	)
		|	И СпрВидыЗапасов.ТипЗапасов В (&СобственныеТипыЗапасов)
		|
		|СГРУППИРОВАТЬ ПО
		|	Поступление.Дата,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	СпрНоменклатура.Ссылка,
		|	АналитикиТоваров.МестоХранения,
		|	ДД.ДокументПоступления,
		|	ДД.ВидЗапасов,
		|	АналитикиПартий.НалогообложениеНДС
		|";
КонецФункции

Функция ТекстБазисПриходыСборок() // использует ПриходыПартийСборок, АналитикиРасходовВсе
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстБазисПриходыСборок"" КАК ЗапросИсточник,
		|	90 КАК Приоритет,
		|	""Потребление"" КАК ТипЗаписи,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) КАК ВидДвижения,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаПродукции КАК АналитикаУчетаНоменклатуры,
		|	СпрНоменклатура.Ссылка КАК Номенклатура,
		|	АналитикиТоваров.СкладскаяТерритория КАК Склад,
		|	ДД.ДокументВыпуска КАК ДокументПоступления,
		|	Партии.ВидЗапасов,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка) КАК АналитикаУчетаПартий,
		|	ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка) КАК НаправлениеДеятельности,
		|	НЕОПРЕДЕЛЕНО КАК Поставщик,
		|	НЕОПРЕДЕЛЕНО КАК ДокументПоступленияРасходов,
		|	НЕОПРЕДЕЛЕНО КАК ВидЦенности,
		|	НЕОПРЕДЕЛЕНО КАК СтавкаНДС,
		|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) КАК СтатьяРасходов,
		|	ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка) КАК Подразделение,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРаспределения,
		|	0 КАК Базис,
		|	Партии.Количество,
		|	&Вес * Партии.Количество КАК Вес,
		|	&Объем * Партии.Количество КАК Объем,
		|	СУММА(ВЫБОР
		|		КОГДА ДД.Организация В (&ОрганизацииСФИФОСкользящая) ТОГДА ДД.Стоимость
		|		ИНАЧЕ ДД.СтоимостьРегл КОНЕЦ) КАК Стоимость,
		|	СУММА(ДД.СтоимостьБезНДС) КАК СтоимостьБезНДС,
		|	СУММА(ДД.СтоимостьРегл) КАК СтоимостьРегл,
		|	СУММА(ДД.НДСРегл) КАК НДСРегл,
		|	СУММА(ДД.ПостояннаяРазница) КАК ПостояннаяРазница,
		|	СУММА(ДД.ВременнаяРазница) КАК ВременнаяРазница,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка) КАК НалогообложениеПартии,
		|	Партии.НалогообложениеНДС,
		|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПустаяСсылка) КАК ХозяйственнаяОперация,
		|	ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка) КАК ПодразделениеРасходов,
		|	НЕОПРЕДЕЛЕНО КАК ДокументРеализации,
		|	НЕОПРЕДЕЛЕНО КАК ДокументИсточник,
		|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) КАК СтатьяОтраженияРасходов,
		|	ЗНАЧЕНИЕ(Перечисление.ВариантыРаздельногоУчетаНДС.ПустаяСсылка)	КАК ВариантРаздельногоУчетаНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаОтраженияРасходов,
		|	ЗНАЧЕНИЕ(Перечисление.ПравилаРаспределенияНаСебестоимостьТоваров.ПустаяСсылка) КАК ПравилоРаспределения,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыНаСкладах) КАК РазделУчета,
		|	ДД.Период КАК РасчетныйПериод,
		|	ЛОЖЬ КАК РасчетПартий
		|ИЗ
		|	РегистрНакопления.ПартииЗатратНаВыпуск КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ПриходыПартийСборок КАК Партии
		|		ПО Партии.Организация = ДД.Организация
		|		И Партии.АналитикаУчетаНоменклатуры = ДД.АналитикаУчетаПродукции
		|		И Партии.ДокументПоступления = ДД.ДокументВыпуска
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК АналитикиТоваров
		|		ПО АналитикиТоваров.Ссылка = ДД.АналитикаУчетаПродукции
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Номенклатура КАК СпрНоменклатура
		|		ПО СпрНоменклатура.Ссылка = АналитикиТоваров.Номенклатура
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Склады КАК Склады
		|		ПО АналитикиТоваров.СкладскаяТерритория = Склады.Ссылка
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ВидыЗапасов КАК СпрВидыЗапасов
		|		ПО СпрВидыЗапасов.Ссылка = Партии.ВидЗапасов
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И ДД.Регистратор = ДД.ДокументВыпуска
		|	И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|	И (ДД.Организация,
		|		АналитикиТоваров.Номенклатура,
		|		АналитикиТоваров.СкладскаяТерритория,
		|		ЕСТЬNULL(АналитикиТоваров.Назначение.НаправлениеДеятельности,
		|			ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)),
		|		ДД.Регистратор) В
		|	(
		|		ВЫБРАТЬ РАЗЛИЧНЫЕ
		|			КлючиРасходов.Организация,
		|			АналитикиТоваров.Номенклатура,
		|			АналитикиТоваров.СкладскаяТерритория,
		|			(ВЫБОР
		|				КОГДА КлючиРасходов.НаправлениеДеятельности = ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)
		|					ТОГДА ЕСТЬNULL(АналитикиТоваров.Назначение.НаправлениеДеятельности,
		|						ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка))
		|				ИНАЧЕ КлючиРасходов.НаправлениеДеятельности КОНЕЦ) КАК НаправлениеДеятельности,
		|			ДД.Регистратор
		|		ИЗ
		|			АналитикиРасходовВсе КАК КлючиРасходов
		|		ГДЕ 
		|			КлючиРасходов.АналитикаРасходов В (
		|				АналитикиТоваров.Номенклатура,
		|				ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка),
		|				АналитикиТоваров.СкладскаяТерритория,
		|				ЗНАЧЕНИЕ(Справочник.Склады.ПустаяСсылка),
		|				ДД.ДокументВыпуска)
		|			ИЛИ
		|			ТИПЗНАЧЕНИЯ(ДД.Регистратор) = ТИПЗНАЧЕНИЯ(КлючиРасходов.АналитикаРасходов)
		|			И КлючиРасходов.АналитикаРасходов В (
		|				ЗНАЧЕНИЕ(Документ.СборкаТоваров.ПустаяСсылка),
		|				ЗНАЧЕНИЕ(Документ.ПередачаТоваровМеждуОрганизациями.ПустаяСсылка))
		|	)
		|	И СпрВидыЗапасов.ТипЗапасов В (&СобственныеТипыЗапасов)
		|
		|СГРУППИРОВАТЬ ПО
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаПродукции,
		|	СпрНоменклатура.Ссылка,
		|	АналитикиТоваров.СкладскаяТерритория,
		|	ДД.ДокументВыпуска,
		|	Партии.ВидЗапасов,
		|	Партии.Количество,
		|	&Вес * Партии.Количество,
		|	&Объем * Партии.Количество,
		|	Партии.НалогообложениеНДС
		|";
КонецФункции

Функция ТекстБазисРаботы() // использует АналитикиРасходовВсе
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстБазисРаботы"" КАК ЗапросИсточник,
		|	90 КАК Приоритет,
		|	""Потребление"" КАК ТипЗаписи,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) КАК ВидДвижения,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	СпрНоменклатура.Ссылка КАК Номенклатура,
		|	АналитикиТоваров.МестоХранения КАК Склад,
		|	ДД.ДокументПоступления,
		|	ДД.ВидЗапасов,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка) КАК АналитикаУчетаПартий,
		|	ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка) КАК НаправлениеДеятельности,
		|	НЕОПРЕДЕЛЕНО КАК Поставщик,
		|	НЕОПРЕДЕЛЕНО КАК ДокументПоступленияРасходов,
		|	НЕОПРЕДЕЛЕНО КАК ВидЦенности,
		|	НЕОПРЕДЕЛЕНО КАК СтавкаНДС,
		|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) КАК СтатьяРасходов,
		|	ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка) КАК Подразделение,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРаспределения,
		|	0 КАК Базис,
		|	СУММА(ДД.Количество) КАК Количество,
		|	СУММА(&Вес * ДД.Количество) КАК Вес,
		|	СУММА(&Объем * ДД.Количество) КАК Объем,
		|	СУММА(ВЫБОР
		|		КОГДА ДД.Организация В (&ОрганизацииСФИФОСкользящая) ТОГДА ДД.Стоимость
		|		ИНАЧЕ ДД.СтоимостьРегл КОНЕЦ) КАК Стоимость,
		|	СУММА(ДД.СтоимостьБезНДС) КАК СтоимостьБезНДС,
		|	СУММА(ДД.СтоимостьРегл) КАК СтоимостьРегл,
		|	СУММА(ДД.НДСРегл) КАК НДСРегл,
		|	СУММА(ДД.ПостояннаяРазница) КАК ПостояннаяРазница,
		|	СУММА(ДД.ВременнаяРазница) КАК ВременнаяРазница,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка) КАК НалогообложениеПартии,
		|	АналитикиПартий.НалогообложениеНДС,
		|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПустаяСсылка) КАК ХозяйственнаяОперация,
		|	ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка) КАК ПодразделениеРасходов,
		|	НЕОПРЕДЕЛЕНО КАК ДокументРеализации,
		|	НЕОПРЕДЕЛЕНО КАК ДокументИсточник,
		|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) КАК СтатьяОтраженияРасходов,
		|	ЗНАЧЕНИЕ(Перечисление.ВариантыРаздельногоУчетаНДС.ПустаяСсылка)	КАК ВариантРаздельногоУчетаНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаОтраженияРасходов,
		|	ЗНАЧЕНИЕ(Перечисление.ПравилаРаспределенияНаСебестоимостьТоваров.ПустаяСсылка) КАК ПравилоРаспределения,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты) КАК РазделУчета,
		|	ДД.Период КАК РасчетныйПериод,
		|	ЛОЖЬ КАК РасчетПартий
		|ИЗ
		|	РегистрНакопления.ПартииПроизводственныхЗатрат КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК АналитикиТоваров
		|		ПО АналитикиТоваров.Ссылка = ДД.АналитикаУчетаНоменклатуры
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Номенклатура КАК СпрНоменклатура
		|		ПО СпрНоменклатура.Ссылка = АналитикиТоваров.Номенклатура
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Номенклатура КАК Работы
		|		ПО Работы.Ссылка = АналитикиТоваров.Номенклатура
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаПартий КАК АналитикиПартий
		|		ПО АналитикиПартий.КлючАналитики = ДД.АналитикаУчетаПартий
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И Работы.ТипНоменклатуры = ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.Работа)
		|	И ДД.Регистратор = ДД.ДокументПоступления
		|	И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		//++ НЕ УТ
		|	И НЕ ДД.Регистратор ССЫЛКА Документ.ОтчетПереработчика
		//-- НЕ УТ
		|	И (ДД.Организация,
		|		АналитикиТоваров.Номенклатура,
		|		АналитикиТоваров.МестоХранения,
		|		ЕСТЬNULL(АналитикиТоваров.Назначение.НаправлениеДеятельности,
		|			ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)),
		|		ДД.Регистратор) В
		|	(
		|		ВЫБРАТЬ РАЗЛИЧНЫЕ
		|			КлючиРасходов.Организация,
		|			АналитикиТоваров.Номенклатура,
		|			АналитикиТоваров.МестоХранения,
		|			(ВЫБОР
		|				КОГДА КлючиРасходов.НаправлениеДеятельности = ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)
		|					ТОГДА ЕСТЬNULL(АналитикиТоваров.Назначение.НаправлениеДеятельности,
		|						ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка))
		|				ИНАЧЕ КлючиРасходов.НаправлениеДеятельности КОНЕЦ) КАК НаправлениеДеятельности,
		|			ДД.Регистратор
		|		ИЗ
		|			АналитикиРасходовВсе КАК КлючиРасходов
		|		ГДЕ 
		|			КлючиРасходов.АналитикаРасходов В (
		|				АналитикиТоваров.Номенклатура,
		|				ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка),
		|				АналитикиТоваров.МестоХранения,
		|				ЗНАЧЕНИЕ(Справочник.Склады.ПустаяСсылка),
		|				ДД.ДокументПоступления)
		|			ИЛИ
		|			ТИПЗНАЧЕНИЯ(ДД.Регистратор) = ТИПЗНАЧЕНИЯ(КлючиРасходов.АналитикаРасходов)
		|			И КлючиРасходов.АналитикаРасходов В (
		|				ЗНАЧЕНИЕ(Документ.ПриобретениеТоваровУслуг.ПустаяСсылка),
		|				ЗНАЧЕНИЕ(Документ.ПередачаТоваровМеждуОрганизациями.ПустаяСсылка))
		|	)
		|
		|СГРУППИРОВАТЬ ПО
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	СпрНоменклатура.Ссылка,
		|	АналитикиТоваров.МестоХранения,
		|	ДД.ДокументПоступления,
		|	ДД.ВидЗапасов,
		|	АналитикиПартий.НалогообложениеНДС
		|";
КонецФункции

Функция ТекстБазисПеремещения() // использует АналитикиРасходовВсе
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстБазисПеремещения"" КАК ЗапросИсточник,
		|	90 КАК Приоритет,
		|	""Потребление"" КАК ТипЗаписи,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) КАК ВидДвижения,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	СпрНоменклатура.Ссылка КАК Номенклатура,
		|	НЕОПРЕДЕЛЕНО КАК Склад,
		|	ДД.ДокументПоступления,
		|	ДД.ВидЗапасов,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка) КАК АналитикаУчетаПартий,
		|	ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка) КАК НаправлениеДеятельности,
		|	НЕОПРЕДЕЛЕНО КАК Поставщик,
		|	НЕОПРЕДЕЛЕНО КАК ДокументПоступленияРасходов,
		|	НЕОПРЕДЕЛЕНО КАК ВидЦенности,
		|	НЕОПРЕДЕЛЕНО КАК СтавкаНДС,
		|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) КАК СтатьяРасходов,
		|	ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка) КАК Подразделение,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
		|	ДД.Регистратор КАК АналитикаРаспределения,
		|	0 КАК Базис,
		|	ДД.Количество,
		|	&Вес * ДД.Количество КАК Вес,
		|	&Объем * ДД.Количество КАК Объем,
		|	(ВЫБОР
		|		КОГДА ДД.Организация В (&ОрганизацииСФИФОСкользящая) ТОГДА ДД.Стоимость
		|		ИНАЧЕ ДД.СтоимостьРегл КОНЕЦ) КАК Стоимость,
		|	ДД.СтоимостьБезНДС,
		|	ДД.СтоимостьРегл,
		|	ДД.НДСРегл,
		|	ДД.ПостояннаяРазница,
		|	ДД.ВременнаяРазница,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка) КАК НалогообложениеПартии,
		|	АналитикиПартий.НалогообложениеНДС,
		|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПустаяСсылка) КАК ХозяйственнаяОперация,
		|	ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка) КАК ПодразделениеРасходов,
		|	НЕОПРЕДЕЛЕНО КАК ДокументРеализации,
		|	ДД.Регистратор КАК ДокументИсточник,
		|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) КАК СтатьяОтраженияРасходов,
		|	ЗНАЧЕНИЕ(Перечисление.ВариантыРаздельногоУчетаНДС.ПустаяСсылка)	КАК ВариантРаздельногоУчетаНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаОтраженияРасходов,
		|	ЗНАЧЕНИЕ(Перечисление.ПравилаРаспределенияНаСебестоимостьТоваров.ПустаяСсылка) КАК ПравилоРаспределения,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыНаСкладах) КАК РазделУчета,
		|	ДД.Период КАК РасчетныйПериод,
		|	ЛОЖЬ КАК РасчетПартий
		|ИЗ
		|	РегистрНакопления.ПартииТоваровОрганизаций КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Номенклатура КАК СпрНоменклатура
		|		ПО СпрНоменклатура.Ссылка = ДД.АналитикаУчетаНоменклатуры.Номенклатура
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаПартий КАК АналитикиПартий
		|		ПО АналитикиПартий.Ссылка = ДД.АналитикаУчетаПартий
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ВидыЗапасов КАК ВидыЗапасов
		|		ПО ВидыЗапасов.Ссылка = ДД.ВидЗапасов
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|	И ТИПЗНАЧЕНИЯ(ДД.Регистратор) = ТИП(Документ.ПеремещениеТоваров)
		|	И НЕ ДД.ДокументПоступления Ссылка Документ.СборкаТоваров
		|	И (ДД.Организация,
		|		ЕСТЬNULL(ДД.АналитикаУчетаНоменклатуры.Назначение.НаправлениеДеятельности,
		|			ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)),
		|		ДД.Регистратор) В
		|	(
		|		ВЫБРАТЬ РАЗЛИЧНЫЕ
		|			КлючиРасходов.Организация,
		|			(ВЫБОР
		|				КОГДА КлючиРасходов.НаправлениеДеятельности = ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)
		|					ТОГДА ЕСТЬNULL(ДД.АналитикаУчетаНоменклатуры.Назначение.НаправлениеДеятельности,
		|						ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка))
		|				ИНАЧЕ КлючиРасходов.НаправлениеДеятельности КОНЕЦ) КАК НаправлениеДеятельности,
		|			ДД.Регистратор
		|		ИЗ
		|			АналитикиРасходовВсе КАК КлючиРасходов
		|		ГДЕ 
		|			КлючиРасходов.АналитикаРасходов В (
		|				ДД.Регистратор,
		|				ЗНАЧЕНИЕ(Документ.ПеремещениеТоваров.ПустаяСсылка))
		|	)
		|	И ВидыЗапасов.ТипЗапасов В (&СобственныеТипыЗапасов)
		|";
КонецФункции

Функция ТекстБазисПеремещенияСборок() // использует АналитикиРасходовВсе
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстБазисПеремещенияСборок"" КАК ЗапросИсточник,
		|	90 КАК Приоритет,
		|	""Потребление"" КАК ТипЗаписи,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) КАК ВидДвижения,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаПродукции КАК АналитикаУчетаНоменклатуры,
		|	СпрНоменклатура.Ссылка КАК Номенклатура,
		|	НЕОПРЕДЕЛЕНО КАК Склад,
		|	ДД.ДокументВыпуска КАК ДокументПоступления,
		|	Партии.ВидЗапасов,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка) КАК АналитикаУчетаПартий,
		|	ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка) КАК НаправлениеДеятельности,
		|	НЕОПРЕДЕЛЕНО КАК Поставщик,
		|	НЕОПРЕДЕЛЕНО КАК ДокументПоступленияРасходов,
		|	НЕОПРЕДЕЛЕНО КАК ВидЦенности,
		|	НЕОПРЕДЕЛЕНО КАК СтавкаНДС,
		|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) КАК СтатьяРасходов,
		|	ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка) КАК Подразделение,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
		|	ДД.Регистратор КАК АналитикаРаспределения,
		|	0. КАК Базис,
		|	Партии.Количество,
		|	&Вес * Партии.Количество КАК Вес,
		|	&Объем * Партии.Количество КАК Объем,
		|	СУММА(ВЫБОР
		|		КОГДА ДД.Организация В (&ОрганизацииСФИФОСкользящая) ТОГДА ДД.Стоимость
		|		ИНАЧЕ ДД.СтоимостьРегл КОНЕЦ) КАК Стоимость,
		|	СУММА(ДД.СтоимостьБезНДС) КАК СтоимостьБезНДС,
		|	СУММА(ДД.СтоимостьРегл) КАК СтоимостьРегл,
		|	СУММА(ДД.НДСРегл) КАК НДСРегл,
		|	СУММА(ДД.ПостояннаяРазница) КАК ПостояннаяРазница,
		|	СУММА(ДД.ВременнаяРазница) КАК ВременнаяРазница,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка) КАК НалогообложениеПартии,
		|	Партии.НалогообложениеНДС,
		|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПустаяСсылка) КАК ХозяйственнаяОперация,
		|	ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка) КАК ПодразделениеРасходов,
		|	НЕОПРЕДЕЛЕНО КАК ДокументРеализации,
		|	ДД.Регистратор КАК ДокументИсточник,
		|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) КАК СтатьяОтраженияРасходов,
		|	ЗНАЧЕНИЕ(Перечисление.ВариантыРаздельногоУчетаНДС.ПустаяСсылка)	КАК ВариантРаздельногоУчетаНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаОтраженияРасходов,
		|	ЗНАЧЕНИЕ(Перечисление.ПравилаРаспределенияНаСебестоимостьТоваров.ПустаяСсылка) КАК ПравилоРаспределения,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыНаСкладах) КАК РазделУчета,
		|	ДД.Период КАК РасчетныйПериод,
		|	ЛОЖЬ КАК РасчетПартий
		|ИЗ
		|	РегистрНакопления.ПартииЗатратНаВыпуск КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ПриходыПартийСборок КАК Партии
		|		ПО Партии.Организация = ДД.Организация
		|		И Партии.АналитикаУчетаНоменклатуры = ДД.АналитикаУчетаПродукции
		|		И Партии.ДокументПоступления = ДД.ДокументВыпуска
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Номенклатура КАК СпрНоменклатура
		|		ПО СпрНоменклатура.Ссылка = ДД.АналитикаУчетаПродукции.Номенклатура
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ВидыЗапасов КАК ВидыЗапасов
		|		ПО ВидыЗапасов.Ссылка = ДД.ВидЗапасов
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|	И ТИПЗНАЧЕНИЯ(ДД.Регистратор) = ТИП(Документ.ПеремещениеТоваров)
		|	И (ДД.Организация,
		|		ЕСТЬNULL(ДД.АналитикаУчетаПродукции.Назначение.НаправлениеДеятельности,
		|			ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)),
		|		ДД.Регистратор) В
		|	(
		|		ВЫБРАТЬ РАЗЛИЧНЫЕ
		|			КлючиРасходов.Организация,
		|			(ВЫБОР
		|				КОГДА КлючиРасходов.НаправлениеДеятельности = ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)
		|					ТОГДА ЕСТЬNULL(ДД.АналитикаУчетаПродукции.Назначение.НаправлениеДеятельности,
		|						ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка))
		|				ИНАЧЕ КлючиРасходов.НаправлениеДеятельности КОНЕЦ) КАК НаправлениеДеятельности,
		|			ДД.Регистратор
		|		ИЗ
		|			АналитикиРасходовВсе КАК КлючиРасходов
		|		ГДЕ 
		|			КлючиРасходов.АналитикаРасходов В (
		|				ДД.Регистратор,
		|				ЗНАЧЕНИЕ(Документ.ПеремещениеТоваров.ПустаяСсылка))
		|	)
		|	И ВидыЗапасов.ТипЗапасов В (&СобственныеТипыЗапасов)
		|СГРУППИРОВАТЬ ПО
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаПродукции,
		|	СпрНоменклатура.Ссылка,
		|	ДД.ДокументВыпуска,
		|	Партии.ВидЗапасов,
		|	Партии.Количество,
		|	&Вес * Партии.Количество,
		|	&Объем * Партии.Количество,
		|	Партии.НалогообложениеНДС
		|";
КонецФункции

Функция ТекстБазисПрошлыеПеремещения() // использует ПрошлыеПеремещения
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстБазисПрошлыеПеремещения"" КАК ЗапросИсточник,
		|	90 КАК Приоритет,
		|	""Потребление"" КАК ТипЗаписи,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) КАК ВидДвижения,
		|	ПрошлыеПеремещения.Период,
		|	ПрошлыеПеремещения.Перемещение КАК Регистратор,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	СпрНоменклатура.Ссылка КАК Номенклатура,
		|	НЕОПРЕДЕЛЕНО КАК Склад,
		|	ДД.ДокументПоступления,
		|	ДД.ВидЗапасов,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка) КАК АналитикаУчетаПартий,
		|	ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка) КАК НаправлениеДеятельности,
		|	НЕОПРЕДЕЛЕНО КАК Поставщик,
		|	НЕОПРЕДЕЛЕНО КАК ДокументПоступленияРасходов,
		|	НЕОПРЕДЕЛЕНО КАК ВидЦенности,
		|	НЕОПРЕДЕЛЕНО КАК СтавкаНДС,
		|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) КАК СтатьяРасходов,
		|	ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка) КАК Подразделение,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
		|	ПрошлыеПеремещения.Перемещение КАК АналитикаРаспределения,
		|	0 КАК Базис,
		|	ДД.КоличествоОстаток КАК Количество,
		|	&Вес * ДД.КоличествоОстаток КАК Вес,
		|	&Объем * ДД.КоличествоОстаток КАК Объем,
		|	(ВЫБОР
		|		КОГДА ДД.Организация В (&ОрганизацииСФИФОСкользящая) ТОГДА ДД.СтоимостьОстаток
		|		ИНАЧЕ ДД.СтоимостьРеглОстаток КОНЕЦ) КАК Стоимость,
		|	ДД.СтоимостьБезНДСОстаток КАК СтоимостьБезНДС,
		|	ДД.СтоимостьРеглОстаток КАК СтоимостьРегл,
		|	ДД.НДСРеглОстаток КАК НДСРегл,
		|	ДД.ПостояннаяРазницаОстаток КАК ПостояннаяРазница,
		|	ДД.ВременнаяРазницаОстаток КАК ВременнаяРазница,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка) КАК НалогообложениеПартии,
		|	АналитикиПартий.НалогообложениеНДС,
		|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПустаяСсылка) КАК ХозяйственнаяОперация,
		|	ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка) КАК ПодразделениеРасходов,
		|	НЕОПРЕДЕЛЕНО КАК ДокументРеализации,
		|	ДД.ДокументПоступления КАК ДокументИсточник,
		|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) КАК СтатьяОтраженияРасходов,
		|	ЗНАЧЕНИЕ(Перечисление.ВариантыРаздельногоУчетаНДС.ПустаяСсылка)	КАК ВариантРаздельногоУчетаНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаОтраженияРасходов,
		|	ЗНАЧЕНИЕ(Перечисление.ПравилаРаспределенияНаСебестоимостьТоваров.ПустаяСсылка) КАК ПравилоРаспределения,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыНаСкладах) КАК РазделУчета,
		|	&НачалоПериода КАК РасчетныйПериод,
		|	ЛОЖЬ КАК РасчетПартий
		|ИЗ
		|	РегистрНакопления.ПартииТоваровОрганизаций.Остатки(&НачалоПериода, Организация В (&МассивОрганизаций)) КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ПрошлыеПеремещения КАК ПрошлыеПеремещения
		|		ПО ПрошлыеПеремещения.Организация = ДД.Организация
		|		И ПрошлыеПеремещения.ДокументПоступления = ДД.ДокументПоступления
		|		И ПрошлыеПеремещения.АналитикаУчетаНоменклатуры = ДД.АналитикаУчетаНоменклатуры
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Номенклатура КАК СпрНоменклатура
		|		ПО СпрНоменклатура.Ссылка = ДД.АналитикаУчетаНоменклатуры.Номенклатура
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаПартий КАК АналитикиПартий
		|		ПО АналитикиПартий.КлючАналитики = ДД.АналитикаУчетаПартий
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ВидыЗапасов КАК ВидыЗапасов
		|		ПО ВидыЗапасов.Ссылка = ДД.ВидЗапасов
		|ГДЕ
		|	ВидыЗапасов.ТипЗапасов В (&СобственныеТипыЗапасов)
		|";
КонецФункции

Функция ТекстБазисЗаказы() // использует ПартииПоЗаказам, ЗаказыИзАналитикРасходов
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстБазисЗаказы"" КАК ЗапросИсточник,
		|	ДД.Приоритет,
		|	ДД.ТипЗаписи,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ДД.ВидДвижения,
		|	ДД.Период,
		|	ДД.Заказ КАК Регистратор,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	СпрНоменклатура.Ссылка КАК Номенклатура,
		|	НЕОПРЕДЕЛЕНО КАК Склад,
		|	ДД.ДокументПоступления,
		|	ДД.ВидЗапасов,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка) КАК АналитикаУчетаПартий,
		|	ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка) КАК НаправлениеДеятельности,
		|	НЕОПРЕДЕЛЕНО КАК Поставщик,
		|	НЕОПРЕДЕЛЕНО КАК ДокументПоступленияРасходов,
		|	НЕОПРЕДЕЛЕНО КАК ВидЦенности,
		|	НЕОПРЕДЕЛЕНО КАК СтавкаНДС,
		|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) КАК СтатьяРасходов,
		|	ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка) КАК Подразделение,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРаспределения,
		|	0 КАК Базис,
		|	СУММА(ДД.Количество) КАК Количество,
		|	СУММА(&Вес * ДД.Количество) КАК Вес,
		|	СУММА(&Объем * ДД.Количество) КАК Объем,
		|	СУММА(ВЫБОР
		|		КОГДА ДД.Организация В (&ОрганизацииСФИФОСкользящая) ТОГДА ДД.Стоимость
		|		ИНАЧЕ ДД.СтоимостьРегл КОНЕЦ) КАК Стоимость,
		|	СУММА(ДД.СтоимостьБезНДС) КАК СтоимостьБезНДС,
		|	СУММА(ДД.СтоимостьРегл) КАК СтоимостьРегл,
		|	СУММА(ДД.НДСРегл) КАК НДСРегл,
		|	СУММА(ДД.ПостояннаяРазница) КАК ПостояннаяРазница,
		|	СУММА(ДД.ВременнаяРазница) КАК ВременнаяРазница,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка) КАК НалогообложениеПартии,
		|	ДД.НалогообложениеНДС,
		|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПустаяСсылка) КАК ХозяйственнаяОперация,
		|	ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка) КАК ПодразделениеРасходов,
		|	НЕОПРЕДЕЛЕНО КАК ДокументРеализации,
		|	(ВЫБОР
		|		КОГДА ТИПЗНАЧЕНИЯ(ДД.Заказ) = ТИП(Документ.ЗаказНаПеремещение) ТОГДА ДД.Регистратор
		|		ИНАЧЕ НЕОПРЕДЕЛЕНО КОНЕЦ) КАК ДокументИсточник,
		|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) КАК СтатьяОтраженияРасходов,
		|	ЗНАЧЕНИЕ(Перечисление.ВариантыРаздельногоУчетаНДС.ПустаяСсылка)	КАК ВариантРаздельногоУчетаНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаОтраженияРасходов,
		|	ЗНАЧЕНИЕ(Перечисление.ПравилаРаспределенияНаСебестоимостьТоваров.ПустаяСсылка) КАК ПравилоРаспределения,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыНаСкладах) КАК РазделУчета,
		|	(ВЫБОР КОГДА ДД.Период < &НачалоПериода ТОГДА &НачалоПериода ИНАЧЕ ДД.Период КОНЕЦ) КАК РасчетныйПериод,
		|	ЛОЖЬ КАК РасчетПартий
		|ИЗ
		|	ПартииПоЗаказам КАК ДД
		|	ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ВидыЗапасов КАК ВидыЗапасов
		|		ПО ВидыЗапасов.Ссылка = ДД.ВидЗапасов
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Номенклатура КАК СпрНоменклатура
		|		ПО СпрНоменклатура.Ссылка = ДД.АналитикаУчетаНоменклатуры.Номенклатура
		|ГДЕ
		|	ЕСТЬNULL(ВидыЗапасов.ТипЗапасов, ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.Товар)) В (&СобственныеТипыЗапасов)
		|	И (ДД.Регистратор, ДД.Заказ) В (
		|		ВЫБРАТЬ РАЗЛИЧНЫЕ
		|			Заказы.Поступление,
		|			Заказы.Заказ
		|		ИЗ
		|			ЗаказыИзАналитикРасходов КАК Заказы
		|	)
		|
		|СГРУППИРОВАТЬ ПО
		|	ДД.Приоритет,
		|	ДД.ТипЗаписи,
		|	ДД.ВидДвижения,
		|	ДД.Период,
		|	ДД.Заказ,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	СпрНоменклатура.Ссылка,
		|	ДД.ДокументПоступления,
		|	ДД.ВидЗапасов,
		|	ДД.НалогообложениеНДС,
		|	(ВЫБОР КОГДА ДД.Период < &НачалоПериода ТОГДА &НачалоПериода ИНАЧЕ ДД.Период КОНЕЦ),
		|	(ВЫБОР
		|		КОГДА ТИПЗНАЧЕНИЯ(ДД.Заказ) = ТИП(Документ.ЗаказНаПеремещение) ТОГДА ДД.Регистратор
		|		ИНАЧЕ НЕОПРЕДЕЛЕНО КОНЕЦ)
		|";
КонецФункции

Функция ТекстБазисУслуги() // использует АналитикиРасходовВсе
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстБазисУслуги"" КАК ЗапросИсточник,
		|	90 КАК Приоритет,
		|	""Потребление"" КАК ТипЗаписи,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) КАК ВидДвижения,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаНоменклатуры,
		|	НЕОПРЕДЕЛЕНО КАК Номенклатура,
		|	НЕОПРЕДЕЛЕНО КАК Склад,
		|	ДД.Регистратор КАК ДокументПоступления,
		|	НЕОПРЕДЕЛЕНО КАК ВидЗапасов,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка) КАК АналитикаУчетаПартий,
		|	ДД.НаправлениеДеятельности КАК НаправлениеДеятельности,
		|	НЕОПРЕДЕЛЕНО КАК Поставщик,
		|	НЕОПРЕДЕЛЕНО КАК ДокументПоступленияРасходов,
		|	(ВЫБОР
		|		КОГДА ЕСТЬNULL(ДД.СтатьяРасходов.ВидЦенностиНДС, ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.ПустаяСсылка)) <>
		|				ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.ПустаяСсылка)
		|			ТОГДА ДД.СтатьяРасходов.ВидЦенностиНДС
		|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.ПрочиеРаботыИУслуги) КОНЕЦ) КАК ВидЦенности,
		|	НЕОПРЕДЕЛЕНО КАК СтавкаНДС,
		|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) КАК СтатьяРасходов,
		|	ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка) КАК Подразделение,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРаспределения,
		|	0 КАК Базис,
		|	1 КАК Количество,
		|	0 КАК Вес,
		|	0 КАК Объем,
		|	СУММА(ВЫБОР
		|		КОГДА ДД.Организация В (&ОрганизацииСФИФОСкользящая) ТОГДА ДД.Сумма
		|		ИНАЧЕ ДД.СуммаРегл КОНЕЦ) КАК Стоимость,
		|	СУММА(ДД.Сумма) КАК СтоимостьБезНДС,
		|	СУММА(ДД.СуммаРегл) КАК СтоимостьРегл,
		|	0 КАК НДСРегл,
		|	0 КАК ПостояннаяРазница,
		|	0 КАК ВременнаяРазница,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка) КАК НалогообложениеПартии,
		|	ЕСТЬNULL(ПоступлениеТоваров.ЗакупкаПодДеятельность, ПоступлениеУслуг.ЗакупкаПодДеятельность) КАК НалогообложениеНДС,
		|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПустаяСсылка) КАК ХозяйственнаяОперация,
		|	ДД.Подразделение КАК ПодразделениеРасходов,
		|	НЕОПРЕДЕЛЕНО КАК ДокументРеализации,
		|	НЕОПРЕДЕЛЕНО КАК ДокументИсточник,
		|	ДД.СтатьяРасходов КАК СтатьяОтраженияРасходов,
		|	ДД.СтатьяРасходов.ВариантРаздельногоУчетаНДС КАК ВариантРаздельногоУчетаНДС,
		|	ДД.АналитикаРасходов КАК АналитикаОтраженияРасходов,
		|	ЗНАЧЕНИЕ(Перечисление.ПравилаРаспределенияНаСебестоимостьТоваров.ПустаяСсылка) КАК ПравилоРаспределения,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты) КАК РазделУчета,
		|	ДД.Период КАК РасчетныйПериод,
		|	ЛОЖЬ КАК РасчетПартий
		|ИЗ
		|	РегистрНакопления.ПрочиеРасходы КАК ДД
		|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.ПриобретениеТоваровУслуг КАК ПоступлениеТоваров
		|		ПО ПоступлениеТоваров.Ссылка = ДД.Регистратор
		|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.ПриобретениеУслугПрочихАктивов КАК ПоступлениеУслуг
		|		ПО ПоступлениеУслуг.Ссылка = ДД.Регистратор
		|ГДЕ
		|	ДД.Период <= &ОкончаниеПериода
		|	И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|	И (ДД.Регистратор ССЫЛКА Документ.ПриобретениеТоваровУслуг 
		|		ИЛИ ДД.Регистратор ССЫЛКА Документ.ПриобретениеУслугПрочихАктивов)
		|	И (ДД.Организация, ДД.Регистратор) В (
		|		ВЫБРАТЬ РАЗЛИЧНЫЕ
		|			КлючиРасходов.Организация, ДД.Регистратор
		|		ИЗ
		|			АналитикиРасходовВсе КАК КлючиРасходов
		|		ГДЕ 
		|			КлючиРасходов.АналитикаРасходов = ДД.Регистратор
		|			И КлючиРасходов.СтатьяРасходов = ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.НДСНалоговогоАгента)
		|		)
		|
		|СГРУППИРОВАТЬ ПО
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.Подразделение,
		|	ДД.СтатьяРасходов,
		|	ДД.СтатьяРасходов.ВариантРаздельногоУчетаНДС,
		|	ДД.АналитикаРасходов,
		|	ДД.НаправлениеДеятельности,
		|	(ВЫБОР
		|		КОГДА ЕСТЬNULL(ДД.СтатьяРасходов.ВидЦенностиНДС, ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.ПустаяСсылка)) <>
		|				ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.ПустаяСсылка)
		|			ТОГДА ДД.СтатьяРасходов.ВидЦенностиНДС
		|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.ПрочиеРаботыИУслуги) КОНЕЦ),
		|	ЕСТЬNULL(ПоступлениеТоваров.ЗакупкаПодДеятельность, ПоступлениеУслуг.ЗакупкаПодДеятельность)
		|";
КонецФункции

Функция ТекстБазисПрочиеАктивыПассивы() // использует АналитикиРасходовВсе
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстБазисПрочиеАктивыПассивы"" КАК ЗапросИсточник,
		|	90 КАК Приоритет,
		|	""Потребление"" КАК ТипЗаписи,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) КАК ВидДвижения,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаНоменклатуры,
		|	НЕОПРЕДЕЛЕНО КАК Номенклатура,
		|	НЕОПРЕДЕЛЕНО КАК Склад,
		|	ДД.Регистратор КАК ДокументПоступления,
		|	НЕОПРЕДЕЛЕНО КАК ВидЗапасов,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка) КАК АналитикаУчетаПартий,
		|	ДД.НаправлениеДеятельности КАК НаправлениеДеятельности,
		|	НЕОПРЕДЕЛЕНО КАК Поставщик,
		|	НЕОПРЕДЕЛЕНО КАК ДокументПоступленияРасходов,
		|	ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.ПрочиеРаботыИУслуги) КАК ВидЦенности,
		|	НЕОПРЕДЕЛЕНО КАК СтавкаНДС,
		|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) КАК СтатьяРасходов,
		|	ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка) КАК Подразделение,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРаспределения,
		|	0 КАК Базис,
		|	1 КАК Количество,
		|	0 КАК Вес,
		|	0 КАК Объем,
		|	СУММА(ДД.Сумма) КАК Стоимость,
		|	СУММА(ДД.Сумма) КАК СтоимостьБезНДС,
		|	СУММА(ДД.Сумма) КАК СтоимостьРегл,
		|	0 КАК НДСРегл,
		|	0 КАК ПостояннаяРазница,
		|	0 КАК ВременнаяРазница,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка) КАК НалогообложениеПартии,
		|	ЕСТЬNULL(ПоступлениеТоваров.ЗакупкаПодДеятельность, ПоступлениеУслуг.ЗакупкаПодДеятельность) КАК НалогообложениеНДС,
		|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПустаяСсылка) КАК ХозяйственнаяОперация,
		|	ДД.Подразделение КАК ПодразделениеРасходов,
		|	НЕОПРЕДЕЛЕНО КАК ДокументРеализации,
		|	НЕОПРЕДЕЛЕНО КАК ДокументИсточник,
		|	ДД.Статья КАК СтатьяОтраженияРасходов,
		|	ЗНАЧЕНИЕ(Перечисление.ВариантыРаздельногоУчетаНДС.ИзДокумента) КАК ВариантРаздельногоУчетаНДС,
		|	ДД.Аналитика КАК АналитикаОтраженияРасходов,
		|	ЗНАЧЕНИЕ(Перечисление.ПравилаРаспределенияНаСебестоимостьТоваров.ПустаяСсылка) КАК ПравилоРаспределения,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты) КАК РазделУчета,
		|	ДД.Период КАК РасчетныйПериод,
		|	ЛОЖЬ КАК РасчетПартий
		|ИЗ
		|	РегистрНакопления.ПрочиеАктивыПассивы КАК ДД
		|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.ПриобретениеТоваровУслуг КАК ПоступлениеТоваров
		|		ПО ПоступлениеТоваров.Ссылка = ДД.Регистратор
		|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.ПриобретениеУслугПрочихАктивов КАК ПоступлениеУслуг
		|		ПО ПоступлениеУслуг.Ссылка = ДД.Регистратор
		|ГДЕ
		|	ДД.Период <= &ОкончаниеПериода
		|	И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|	И ДД.ВидИсточника = ЗНАЧЕНИЕ(Перечисление.ВидыИсточниковДвижений.ПустаяСсылка)
		|	И (ДД.Регистратор ССЫЛКА Документ.ПриобретениеТоваровУслуг 
		|		ИЛИ ДД.Регистратор ССЫЛКА Документ.ПриобретениеУслугПрочихАктивов)
		|	И (ДД.Организация, ДД.Регистратор) В (
		|		ВЫБРАТЬ РАЗЛИЧНЫЕ
		|			КлючиРасходов.Организация, ДД.Регистратор
		|		ИЗ
		|			АналитикиРасходовВсе КАК КлючиРасходов
		|		ГДЕ 
		|			КлючиРасходов.АналитикаРасходов = ДД.Регистратор
		|			И КлючиРасходов.СтатьяРасходов = ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.НДСНалоговогоАгента)
		|		)
		|
		|СГРУППИРОВАТЬ ПО
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.Подразделение,
		|	ДД.Статья,
		|	ДД.Аналитика,
		|	ДД.НаправлениеДеятельности,
		|	ЕСТЬNULL(ПоступлениеТоваров.ЗакупкаПодДеятельность, ПоступлениеУслуг.ЗакупкаПодДеятельность)
		|";
КонецФункции

#КонецОбласти


#Область РасчетПриходыРасходовСебестоимость

// В партионном учете версии 2.2 - этап 11, РаспределениеДопРасходовМеждуПартиямиИТоварами.

Функция ДанныеДляПартийПрочихСебестоимость(НачалоПериода, ОкончаниеПериода, МассивОрганизаций)
	МВТ = Новый МенеджерВременныхТаблиц;
	// Распределяем только по собственным запасам, исключаем комиссионные и давальческие запасы.
	СобственныеТипыЗапасов = РасчетСебестоимостиПрикладныеАлгоритмы.СобственныеТипыЗапасов();
	
	// Определяем базу распределения прочих расходов на заказы поставщикам и заказы перемещений,
	// т.е. распределяем выполненные строки заказов на поступления партий - указываем заказ в партии.
	ТекстСортировкаЗаказов = "
		|УПОРЯДОЧИТЬ ПО
		|	Регистратор, Номенклатура, Характеристика, Склад, Приоритет
		|";
	ТекстРасчетаЗаказов = 
		ТекстТаможенныеДекларацииИПоступления() + ";" + // вт Декларации
		ТекстАналитикиРасходовВсе() + ";" + // вт АналитикиРасходовВсе
		ТекстЗаказыИзАналитикРасходов() + ";" + // вт ЗаказыИзАналитикРасходов, использует АналитикиРасходовВсе
		ТекстЗаказыИзАналитикРасходовСводно() + ";" + // вт ЗаказыИзАналитикРасходовСводно, использует ЗаказыИзАналитикРасходов 
		ТекстПоступившиеЗаказы() + // использует ЗаказыИзАналитикРасходов
		"ОБЪЕДИНИТЬ ВСЕ" + ТекстПриходыПоступленийПоЗаказамСебестоимости() + // использует ЗаказыИзАналитикРасходов
		ТекстСортировкаЗаказов;
	ЗапросРасчетаЗаказов = Новый Запрос(ТекстРасчетаЗаказов);
	ЗапросРасчетаЗаказов.МенеджерВременныхТаблиц = МВТ;
	ЗапросРасчетаЗаказов.УстановитьПараметр("НачалоПериода", НачалоПериода);
	ЗапросРасчетаЗаказов.УстановитьПараметр("ОкончаниеПериода", ОкончаниеПериода);
	ЗапросРасчетаЗаказов.УстановитьПараметр("МассивОрганизаций", МассивОрганизаций);	
	ЗапросРасчетаЗаказов.УстановитьПараметр("УчитыватьНазначение",
		РасчетСебестоимостиПовтИсп.СебестоимостьТоваровПоНазначениям(НачалоПериода));
	
	ДанныеРасчетаЗаказов = ЗапросРасчетаЗаказов.Выполнить().Выгрузить();
	РасчетныеПартииПоЗаказам = Новый ТаблицаЗначений;
	ПоляРасчетаЗаказов = СкопироватьКолонки(ДанныеРасчетаЗаказов.Колонки, РасчетныеПартииПоЗаказам.Колонки);
	КонтекстДвижений = ОписаниеДвижений(
		"ЗаказыПоставщикам", "",
		ПоляРасчетаЗаказов,
		"Номенклатура, Регистратор, Характеристика, Склад", "Количество, Стоимость",
		"Количество", "Количество", "Заказ", "Период");
	РаспределитьПриходыНаРасходы(КонтекстДвижений, ДанныеРасчетаЗаказов, РасчетныеПартииПоЗаказам);
	
	// Получаем данные для расчета списания партий прочих расходов и прихода партий расходов на с/с товаров.
	ТекстСортировка = "
		|УПОРЯДОЧИТЬ ПО
		|	Организация, Приоритет, ВидДвижения, Период, Регистратор";
	ИсходныйТекстЗапроса =
		ТекстПартииПоЗаказам() + ";" + // вт ПартииПоЗаказам, использует &РасчетныеПартииПоЗаказам
		ТекстРегистраторыПрочих() + ";" + // вт РегистраторыПрочих
		ТекстОписаниеПартийПрочих() +
		"ОБЪЕДИНИТЬ ВСЕ" + ТекстОстаткиПартийПрочих() + // использует АналитикиРасходовВсе
		"ОБЪЕДИНИТЬ ВСЕ" + ТекстПриходыПартийПрочих() +
		"ОБЪЕДИНИТЬ ВСЕ" + ТекстДополненияПартийПрочих() + // использует РегистраторыПрочих
		"ОБЪЕДИНИТЬ ВСЕ" + ТекстБазисОстаткиСебестоимость() + // использует АналитикиРасходовВсе
		"ОБЪЕДИНИТЬ ВСЕ" + ТекстБазисПриходыТоваровСебестоимость() + // использует АналитикиРасходовВсе
		"ОБЪЕДИНИТЬ ВСЕ" + ТекстБазисПриходыИнтеркампаниСебестоимость() + // использует АналитикиРасходовВсе
		"ОБЪЕДИНИТЬ ВСЕ" + ТекстБазисПриходыИмпортСебестоимость() + // использует АналитикиРасходовВсе
		"ОБЪЕДИНИТЬ ВСЕ" + ТекстБазисПриходыРаботСебестоимость() + // использует АналитикиРасходовВсе
		"ОБЪЕДИНИТЬ ВСЕ" + ТекстБазисПеремещенияСебестоимость() + // использует АналитикиРасходовВсе
		"ОБЪЕДИНИТЬ ВСЕ" + ТекстБазисПрошлыеПриходыТоваровСебестоимость() + // использует АналитикиРасходовВсе
		"ОБЪЕДИНИТЬ ВСЕ" + ТекстБазисЗаказы() + // использует ПартииПоЗаказам, ЗаказыИзАналитикРасходов
		"ОБЪЕДИНИТЬ ВСЕ" + ТекстБазисУслуги() + // использует АналитикиРасходовВсе
		"ОБЪЕДИНИТЬ ВСЕ" + ТекстБазисПрочиеАктивыПассивы() + // использует АналитикиРасходовВсе
		ТекстСортировка;
	ИсходныйТекстЗапроса = СтрЗаменить(ИсходныйТекстЗапроса, "&Вес", 
		Справочники.УпаковкиЕдиницыИзмерения.ТекстЗапросаВесУпаковки("СпрНоменклатура.ЕдиницаИзмерения", "СпрНоменклатура"));
	ИсходныйТекстЗапроса = СтрЗаменить(ИсходныйТекстЗапроса, "&Объем", 
		Справочники.УпаковкиЕдиницыИзмерения.ТекстЗапросаОбъемУпаковки("СпрНоменклатура.ЕдиницаИзмерения", "СпрНоменклатура"));
	ИсходныйЗапрос = Новый Запрос(ИсходныйТекстЗапроса);
	ИсходныйЗапрос.МенеджерВременныхТаблиц = МВТ;
	ИсходныйЗапрос.УстановитьПараметр("РасчетныеПартииПоЗаказам", РасчетныеПартииПоЗаказам);
	ИсходныйЗапрос.УстановитьПараметр("НачалоПериода", НачалоПериода);
	ИсходныйЗапрос.УстановитьПараметр("ОкончаниеПериода", ОкончаниеПериода);
	ИсходныйЗапрос.УстановитьПараметр("МассивОрганизаций", МассивОрганизаций);	
	ИсходныйЗапрос.УстановитьПараметр("УчитыватьСебестоимостьТоваровПоНазначениям",
		РасчетСебестоимостиПовтИсп.СебестоимостьТоваровПоНазначениям(НачалоПериода));
	ИсходныйЗапрос.УстановитьПараметр("СобственныеТипыЗапасов", СобственныеТипыЗапасов);
	ИсходныйЗапрос.УстановитьПараметр("ОрганизацииСФИФОСкользящая", 
		НастройкиНалоговУчетныхПолитик.ОрганизацииСЗаданнымПараметромПолитики(
			"УчетнаяПолитикаФинансовогоУчета",
			"МетодОценкиСтоимостиТоваров",
			Перечисления.МетодыОценкиСтоимостиТоваров.ФИФОСкользящаяОценка,
			МассивОрганизаций,
			НачалоПериода));
	ИсходныйЗапрос.УстановитьПараметр("ТипДокументаИмпорта", ОбщегоНазначения.ИдентификаторОбъектаМетаданных("Документ.ТаможеннаяДекларацияИмпорт"));
	
	ДанныеДляРасчета = ИсходныйЗапрос.Выполнить().Выгрузить();
	
	Возврат ДанныеДляРасчета;
	
КонецФункции

Функция РасчетныеПриходыПартийРасходов(ДанныеДляРасчета, Регистраторы, УзлыДвижений = Неопределено, Тест = Ложь) // ДанныеДляРасчета будут изменены
	// кэшируем получение пустых ссылок - на множественных итерациях есть выигрыш
	ПустыеСсылки = Новый Соответствие;
	ПравилаРаспределения = Новый Массив(4);
	ПравилаРаспределения[0] = Перечисления.ТипыБазыРаспределенияРасходов.КоличествоТоваров;
	ПравилаРаспределения[1] = Перечисления.ТипыБазыРаспределенияРасходов.СебестоимостьТоваров;
	ПравилаРаспределения[2] = Перечисления.ТипыБазыРаспределенияРасходов.ВесТоваров;
	ПравилаРаспределения[3] = Перечисления.ТипыБазыРаспределенияРасходов.ОбъемТоваров;
	// Шаг 1: Строим сопоставление приходов с базисом и расходов, по которым базис рассчитан.
	ДанныеДляРасчета.Сортировать("Организация, НалогообложениеНДС, Приоритет, Период, Регистратор, АналитикаУчетаНоменклатуры", Новый СравнениеЗначений);
	УзлыДвижений = Новый Соответствие;
	Ключи = Новый Массив(6); // {Организация, НалогообложениеНДС, ПравилоРаспределения, АналитикаРасходов, ДокументПоступленияРасходов, НомерСтроки}
	// формирование упорядоченных массивов строк таблицы ДанныеДляРасчета
	Для Каждого Движение Из ДанныеДляРасчета Цикл
		Ключи[0] = Движение.Организация;
		Ключи[1] = Движение.НалогообложениеНДС;
		Ключи[2] = Движение.ПравилоРаспределения;
		Ключи[3] = Неопределено;
		Ключи[4] = Неопределено;
		Ключи[5] = Неопределено;
		// накапливаем приход партий прочих расходов для дальнейшего сопоставления
		Если ЗначениеЗаполнено(Движение.СтатьяРасходов) Тогда
			Ключи[3] = Движение.АналитикаРаспределения;
			Ключи[4] = Движение.ДокументПоступленияРасходов;
			Ключи[5] = ДанныеДляРасчета.Индекс(Движение);
			Движения = УзелИндекса(УзлыДвижений, Ключи);
			Если Движения = Неопределено Тогда
				Движения = ДобавитьУзелИндекса(УзлыДвижений, Ключи, Новый Массив);
			КонецЕсли;
			Движения.Добавить(Движение);
			Продолжить;
		КонецЕсли;
		// непосредственно вставка строки расхода в сопоставления по каждой аналитике
		Для Каждого Правило Из ПравилаРаспределения Цикл
			Ключи[2] = Правило;
			Аналитики = УзелИндекса(УзлыДвижений, Ключи);
			Если Аналитики = Неопределено Тогда
				Продолжить;
			КонецЕсли;
			// Аналитики содержат соответствие, в ключах которого значение аналитики расхода,
			// в значениях - соответствие между документом поступления расхода и движениями относящимися к этому расходу.
			Для Каждого Значение Из АналитикиОбсчетаПартийПрочих(Движение, ПустыеСсылки) Цикл
				ПоступленияРасходов = Аналитики[Значение];
				Если ПоступленияРасходов = Неопределено Тогда
					Продолжить;
				КонецЕсли;
				Для Каждого ПоступлениеРасхода Из ПоступленияРасходов Цикл
					Для Каждого НомерСтроки Из  ПоступлениеРасхода.Значение Цикл
						НомерСтроки.Значение.Добавить(Движение);
					КонецЦикла
				КонецЦикла;
			КонецЦикла;
		КонецЦикла;
	КонецЦикла;
	// Шаг 2: создаем буфер накопления рассчитанных партий
	РасчетныеПартии = Новый ТаблицаЗначений;
	ПоляРасчета = СкопироватьКолонки(ДанныеДляРасчета.Колонки, РасчетныеПартии.Колонки);
	// Шаг 3: распределяем каждый массив строк в аналитиках
	КонтекстДвижений = ОписаниеДвижений(
		"ПартииРасходовНаСебестоимостьТоваровПриход",
		"ПартииРасходовНаСебестоимостьТоваров",
		ПоляРасчета,
		"Организация",
		"Базис, Количество, Вес, Объем, Стоимость, СтоимостьБезНДС, СтоимостьРегл, НДСРегл, ПостояннаяРазница, ВременнаяРазница",
		"Базис", "<БАЗИС_РАСХОДА>", "ДокументРеализации", "Период");
	Для Каждого Организации Из УзлыДвижений Цикл
		Для Каждого Налогообложения Из Организации.Значение Цикл
			Для Каждого Правила Из Налогообложения.Значение Цикл
				Если Правила.Ключ = ПравилаРаспределения[0] Тогда
					КонтекстДвижений.БазисРасхода = "Количество";
				ИначеЕсли Правила.Ключ = ПравилаРаспределения[2] Тогда
					КонтекстДвижений.БазисРасхода = "Вес";
				ИначеЕсли Правила.Ключ = ПравилаРаспределения[3] Тогда
					КонтекстДвижений.БазисРасхода = "Объем";	
				Иначе
					КонтекстДвижений.БазисРасхода = "Стоимость";
				КонецЕсли;
				Для Каждого Аналитики Из Правила.Значение Цикл
					Для Каждого ПоступлениеРасхода Из Аналитики.Значение Цикл
						Для Каждого НомерСтроки Из  ПоступлениеРасхода.Значение Цикл
							РаспределитьПриходыНаРасходы(КонтекстДвижений, НомерСтроки.Значение, РасчетныеПартии);
						КонецЦикла;
					КонецЦикла;
				КонецЦикла;
			КонецЦикла;
		КонецЦикла;
	КонецЦикла;
	// Шаг 4: Дополнение расчетных партий данными прямого прихода в партии расходов на с/с.
	ИндексРегистраторов = Новый Соответствие;
	Регистраторы = Новый Массив;
	ВсегоРегистраторов = 0;
	НачалоПериода = Дата(1,1,1);
	Для Каждого РасчетнаяПартия Из РасчетныеПартии Цикл
		Ключ = РасчетнаяПартия.Регистратор;
		Если ИндексРегистраторов[Ключ] = Неопределено Тогда
			Регистраторы.Добавить(Ключ);
			ИндексРегистраторов.Вставить(Ключ, ВсегоРегистраторов);
			ВсегоРегистраторов = ВсегоРегистраторов + 1;
			Если НачалоПериода = Дата(1,1,1) Тогда
				НачалоПериода = НачалоМесяца(Движение.Период);
			КонецЕсли;
		КонецЕсли;
	КонецЦикла;
	
	ЗапросИсходныхПартий = Новый Запрос(ТекстИсходныеПриходыПартийРасходов());
	ЗапросИсходныхПартий.УстановитьПараметр("Регистраторы", Регистраторы);
	ЗапросИсходныхПартий.УстановитьПараметр("НачалоПериода", НачалоПериода);
	ВыборкаИсходныхПартий = ЗапросИсходныхПартий.Выполнить().Выбрать();
	Пока ВыборкаИсходныхПартий.Следующий() Цикл
		РасчетнаяПартия = РасчетныеПартии.Добавить();
		ЗаполнитьЗначенияСвойств(РасчетнаяПартия, ВыборкаИсходныхПартий);
	КонецЦикла;
	// Шаг 5: Сортировка партий для дальнейшей записи
	РасчетныеПартии.Сортировать("Регистратор, ВидДвижения, Период, АналитикаУчетаНоменклатуры", Новый СравнениеЗначений);
	Возврат РасчетныеПартии;
КонецФункции

Функция РасчетныеПриходыСебестоимости(НачалоПериода, РасчетныеПриходыПартийРасходов, ИндексРегистраторов, АналитикиПартнеров = Неопределено, Тест = Ложь)
	// Шаг 1: получаем аналитики учета по партнерам и регистраторы расчетных приходов
	АналитикиПартнеров = Новый Соответствие;
	Поступления = Новый Массив;
	
	Если ИндексРегистраторов = Неопределено Тогда
		ИндексРегистраторов = Новый Соответствие;
		Регистраторы = Новый Массив;
		ВсегоРегистраторов = 0;
	Иначе
		Регистраторы = ОбщегоНазначенияУТКлиентСервер.ПреобразоватьСоответствиеИлиСтруктуруВМассив(ИндексРегистраторов);
		ВсегоРегистраторов = Регистраторы.Количество();
	КонецЕсли;
	
	АналитикиБезНазначения = Новый Соответствие;
	АналитикиНоменклатуры = Новый Массив;
	РасчетныеПриходыПартийРасходов.Сортировать("Регистратор", Новый СравнениеЗначений);
	Для Каждого Движение Из РасчетныеПриходыПартийРасходов Цикл
		Если Движение.ТипЗаписи = "Дополнение" Тогда
			Продолжить;
		КонецЕсли;
		// Аналитики учета по партнерам для дальнейшего заполнения по документам поступлений.
		Если АналитикиПартнеров[Движение.ДокументПоступления] = Неопределено Тогда
			Поступления.Добавить(Движение.ДокументПоступления);
			АналитикиПартнеров.Вставить(Движение.ДокументПоступления, Неопределено);
		КонецЕсли;
		// Регистраторы для дальнейшей выборки онлайн-движений из регистра себестоимости товаров.
		Если ИндексРегистраторов[Движение.Регистратор] = Неопределено Тогда
			Регистраторы.Добавить(Движение.Регистратор);
			ИндексРегистраторов.Вставить(Движение.Регистратор, ВсегоРегистраторов);
			ВсегоРегистраторов = ВсегоРегистраторов + 1;
		КонецЕсли;
		
		Если АналитикиБезНазначения[Движение.АналитикаУчетаНоменклатуры] = Неопределено Тогда
			АналитикиБезНазначения.Вставить(Движение.АналитикаУчетаНоменклатуры, Неопределено);
			АналитикиНоменклатуры.Добавить(Движение.АналитикаУчетаНоменклатуры);
		КонецЕсли;
	КонецЦикла;
	// заполняем аналитики учета по партнерам по документам поступлений товаров
	ЗапросАналитик = Новый Запрос(ТекстАналитикиПартнеров()); // использует &Поступления
	ЗапросАналитик.УстановитьПараметр("Поступления", Поступления);
	ВыборкаАналитик = ЗапросАналитик.Выполнить().Выбрать();
	Пока ВыборкаАналитик.Следующий() Цикл
		АналитикиПартнеров[ВыборкаАналитик.ДокументПоступления] = ВыборкаАналитик.АналитикаУчетаПоПартнерам;
	КонецЦикла;
	Поступления.Очистить();
	
	// Заполняем аналитики учета номенклатуры без назначений.
	ЗапросАналитикБезНазначений = Новый Запрос(ТекстАналитикиБезНазначений()); // использует &АналитикиНоменклатуры
	ЗапросАналитикБезНазначений.УстановитьПараметр("АналитикиНоменклатуры", АналитикиНоменклатуры);
	ВыборкаАналитикБезНазначений = ЗапросАналитикБезНазначений.Выполнить().Выбрать();
	Пока ВыборкаАналитикБезНазначений.Следующий() Цикл
		АналитикиБезНазначения[ВыборкаАналитикБезНазначений.Аналитика] = ВыборкаАналитикБезНазначений.АналитикаБезНазначения;
	КонецЦикла;
	АналитикиНоменклатуры.Очистить();
	
	// Шаг 2: создаем буфер накопления рассчитанных приходов в себестоимость
	Запрос = Новый Запрос(ТекстОписаниеСебестоимость());
	РасчетныеПартии = Запрос.Выполнить().Выгрузить();
	
	ТекстСортировка = "УПОРЯДОЧИТЬ ПО Регистратор";
	ЗапросОписания = Новый Запрос(
		ТекстОписаниеСебестоимость() +
		"ОБЪЕДИНИТЬ ВСЕ" + ТекстИсходныеДвиженияСебестоимость() +
		ТекстСортировка
		); // использует &Регистраторы
	ЗапросОписания.УстановитьПараметр("Регистраторы", Регистраторы);
	ЗапросОписания.УстановитьПараметр("НачалоПериода", НачалоПериода);
	ЗапросОписания.УстановитьПараметр("ОкончаниеПериода", КонецМесяца(НачалоПериода));
	Выборка = ЗапросОписания.Выполнить().Выбрать();
	Пока Выборка.Следующий() Цикл
		РасчетнаяПартия = РасчетныеПартии.Добавить();
		ЗаполнитьЗначенияСвойств(РасчетнаяПартия, Выборка);
		Если Не Тест И РасчетныеПартии.Количество() > 1000 Тогда
			ЗаписатьРасчетныеПартии(РегистрыНакопления.СебестоимостьТоваров, РасчетныеПартии, ИндексРегистраторов);
			РасчетныеПартии.Очистить();
		КонецЕсли;
	КонецЦикла;
	Регистраторы.Очистить();
	// кэшируем константы
	СебестоимостьПоНазначениям = РасчетСебестоимостиПовтИсп.СебестоимостьТоваровПоНазначениям(НачалоПериода);
	// Шаг 3: Заполняем буфер накопления
	Для Каждого Движение Из РасчетныеПриходыПартийРасходов Цикл
		Если Не ЗначениеЗаполнено(Движение.СтатьяРасходов)
		 ИЛИ ЗначениеЗаполнено(Движение.ВариантРаздельногоУчетаНДС)
		 ИЛИ Движение.ТипЗаписи = "Дополнение" Тогда
			Продолжить;
		КонецЕсли;
		РасчетнаяПартия = РасчетныеПартии.Добавить();
		ЗаполнитьЗначенияСвойств(РасчетнаяПартия, Движение,
			"Период, Регистратор, ВидЗапасов, Организация, РазделУчета, Подразделение, АналитикаРасходов");
		РасчетнаяПартия.ВидДвижения = ВидДвиженияНакопления.Приход;
		Если СебестоимостьПоНазначениям Тогда
			РасчетнаяПартия.АналитикаУчетаНоменклатуры = Движение.АналитикаУчетаНоменклатуры;
		Иначе
			АналитикаНоменклатурыБезНазначения = АналитикиБезНазначения[Движение.АналитикаУчетаНоменклатуры];
			Если ЗначениеЗаполнено(АналитикаНоменклатурыБезНазначения) Тогда
				РасчетнаяПартия.АналитикаУчетаНоменклатуры = АналитикаНоменклатурыБезНазначения;
			Иначе
				РасчетнаяПартия.АналитикаУчетаНоменклатуры = Движение.АналитикаУчетаНоменклатуры;
			КонецЕсли;
		КонецЕсли;
		РасчетнаяПартия.ДопРасходы = Движение.Стоимость;
		РасчетнаяПартия.ДопРасходыБезНДС = Движение.СтоимостьБезНДС;
		РасчетнаяПартия.СтоимостьРегл = Движение.СтоимостьРегл;
		Если Движение.НалогообложениеПартии = Перечисления.ТипыНалогообложенияНДС.ПродажаОблагаетсяЕНВД
		 ИЛИ Движение.НалогообложениеПартии = Перечисления.ТипыНалогообложенияНДС.ПродажаНеОблагаетсяНДС Тогда
			РасчетнаяПартия.СтоимостьРегл = РасчетнаяПартия.СтоимостьРегл + Движение.НДСРегл;
		КонецЕсли;
		//++ НЕ УТ
		РасчетнаяПартия.ПостояннаяРазница = Движение.ПостояннаяРазница;
		РасчетнаяПартия.ВременнаяРазница = Движение.ВременнаяРазница;
		//-- НЕ УТ
		РасчетнаяПартия.АналитикаУчетаПоПартнерам = АналитикиПартнеров[Движение.ДокументПоступления];
		РасчетнаяПартия.СтатьяРасходовСписания = Движение.СтатьяРасходов;
		РасчетнаяПартия.КорНаправлениеДеятельности = Движение.НаправлениеДеятельности;
		РасчетнаяПартия.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ЗакупкаУПоставщика;
		
		Если Не Тест И РасчетныеПартии.Количество() > 1000 Тогда
			ЗаписатьРасчетныеПартии(РегистрыНакопления.СебестоимостьТоваров, РасчетныеПартии, ИндексРегистраторов);
			РасчетныеПартии.Очистить();
		КонецЕсли;
	КонецЦикла;
	АналитикиПартнеров.Очистить();
	Если Не Тест Тогда
		ЗаписатьРасчетныеПартии(РегистрыНакопления.СебестоимостьТоваров, РасчетныеПартии, ИндексРегистраторов);
		ОчиститьРегистрНаСервере(ИндексРегистраторов, "СебестоимостьТоваров");
		РасчетныеПартии.Очистить();
	КонецЕсли;
	// Шаг 5: Сортировка партий для дальнейшей записи
	РасчетныеПартии.Сортировать("Регистратор, ВидДвижения, Период", Новый СравнениеЗначений);
	Возврат РасчетныеПартии;
КонецФункции

Функция РасчетныеДвиженияПрочихРасходов(НачалоПериода, РасчетныеПриходыПартийРасходов, РасчетныеПартииПрочих, Тест = Ложь)
	
	// Шаг 1: формируем движения по регистру ПрочиеРасходы
	ТекстСортировка = "УПОРЯДОЧИТЬ ПО Регистратор";
	Запрос = Новый Запрос(
		ТекстОписаниеДанныхДляПрочихРасходов()
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстИсходныеДвиженияПрочиеРасходы()
		+ ТекстСортировка); // использует &Регистраторы
	Регистраторы = РасчетныеПартииПрочих.ВыгрузитьКолонку("Регистратор"); 
	Запрос.УстановитьПараметр("Регистраторы", Регистраторы);
	Запрос.УстановитьПараметр("НачалоПериода", НачалоПериода);
	Запрос.УстановитьПараметр("ОкончаниеПериода", КонецМесяца(НачалоПериода));
	РасчетныеПартии = Запрос.Выполнить().Выгрузить();
	
	ИспользоватьУчетПрочихДоходовРасходовРегл = ПолучитьФункциональнуюОпцию("ИспользоватьУчетПрочихДоходовРасходовРегл");
	
	Для Каждого Движение Из РасчетныеПриходыПартийРасходов Цикл
		Если Не ЗначениеЗаполнено(Движение.СтатьяРасходов)
		 ИЛИ НЕ ЗначениеЗаполнено(Движение.ВариантРаздельногоУчетаНДС)
		 ИЛИ Движение.ВариантРаздельногоУчетаНДС = Перечисления.ВариантыРаздельногоУчетаНДС.Распределение
		 ИЛИ Движение.ТипЗаписи = "Дополнение" Тогда
			Продолжить;
		КонецЕсли;
		РасчетнаяПартия = РасчетныеПартии.Добавить();
		ЗаполнитьЗначенияСвойств(РасчетнаяПартия, Движение,
			"Период, Регистратор, Организация, НаправлениеДеятельности");
		РасчетнаяПартия.ВидДвижения = ВидДвиженияНакопления.Приход;
		
		РасчетнаяПартия.Подразделение 			= Движение.ПодразделениеРасходов;
		РасчетнаяПартия.СтатьяРасходов 			= Движение.СтатьяОтраженияРасходов;
		РасчетнаяПартия.АналитикаРасходов 		= Движение.АналитикаОтраженияРасходов;
		
		РасчетнаяПартия.ДокументДвижения 		= Движение.Регистратор;
		
		Если Движение.НалогообложениеНДС = Перечисления.ТипыНалогообложенияНДС.ПродажаОблагаетсяЕНВД
		 ИЛИ Движение.НалогообложениеНДС = Перечисления.ТипыНалогообложенияНДС.ПродажаНеОблагаетсяНДС Тогда
			РасчетнаяПартия.СуммаРегл = Движение.НДСРегл;
		КонецЕсли;
	КонецЦикла;
	
	Для Каждого Движение Из РасчетныеПартииПрочих Цикл
		Если Движение.ВидДвижения = ВидДвиженияНакопления.Расход Тогда
			РасчетнаяПартия = РасчетныеПартии.Добавить();
			ЗаполнитьЗначенияСвойств(РасчетнаяПартия, Движение,
				"ВидДвижения, Период, Регистратор, Организация, Подразделение, НаправлениеДеятельности,
				|СтатьяРасходов, АналитикаРасходов, ХозяйственнаяОперация");
			РасчетнаяПартия.ДокументДвижения = Движение.Регистратор;
			
			РасчетнаяПартия.Сумма       = Движение.Стоимость;
			РасчетнаяПартия.СуммаБезНДС = Движение.СтоимостьБезНДС;
			Если ИспользоватьУчетПрочихДоходовРасходовРегл Тогда
				РасчетнаяПартия.СуммаРегл   = Движение.СтоимостьРегл;
				Если Движение.НалогообложениеНДС = Перечисления.ТипыНалогообложенияНДС.ПродажаОблагаетсяЕНВД
				 ИЛИ Движение.НалогообложениеНДС = Перечисления.ТипыНалогообложенияНДС.ПродажаНеОблагаетсяНДС Тогда
					РасчетнаяПартия.СуммаРегл = РасчетнаяПартия.СуммаРегл + Движение.НДСРегл;
				КонецЕсли;
				РасчетнаяПартия.ПостояннаяРазница = Движение.ПостояннаяРазница;
				РасчетнаяПартия.ВременнаяРазница  = Движение.ВременнаяРазница;
			КонецЕсли;
		КонецЕсли;
	КонецЦикла;
	
	// Шаг 2: Сортировка партий для дальнейшей записи
	РасчетныеПартии.Сортировать("Регистратор, ВидДвижения, Период", Новый СравнениеЗначений);
	Возврат РасчетныеПартии;
КонецФункции

Функция ТекстИсходныеДвиженияПрочиеРасходы()
	Возврат "
	|ВЫБРАТЬ
	|	90 КАК Приоритет,
	|	""Дополнение"" КАК ТипЗаписи,
	|	ИСТИНА КАК РасчетЗавершен,
	|	НЕОПРЕДЕЛЕНО КАК РазделУчета,
	|	Т.ВидДвижения КАК ВидДвижения,
	|	Т.Период,
	|	Т.Регистратор КАК Регистратор,
	|	Т.Организация,
	|	Т.Подразделение,
	|	Т.НаправлениеДеятельности,
	|	Т.СтатьяРасходов,
	|	Т.АналитикаРасходов,
	|	Т.ХозяйственнаяОперация,
	|	Т.ДокументДвижения,
	|	Т.КорСтатьяРасходов,
	|	Т.КорАналитикаРасходов,
	|	Т.Подразделение КАК КорПодразделение,
	|	Т.ГруппаПродукции КАК ГруппаПродукции,
	|	0. КАК Знаменатель,
	|	0. КАК ДоляСтоимости,
	|	Т.Сумма КАК Сумма,
	|	Т.СуммаБезНДС КАК СуммаБезНДС,
	|	Т.СуммаРегл КАК СуммаРегл,
	|	Т.ПостояннаяРазница КАК ПостояннаяРазница,
	|	Т.ВременнаяРазница КАК ВременнаяРазница
	|ИЗ
	|	РегистрНакопления.ПрочиеРасходы КАК Т
	|ГДЕ
	|	Т.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
	|	И Т.Регистратор В (&Регистраторы)
	|	И Т.Активность
	|	И Т.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|";
КонецФункции

Функция РасчетныеПриходыПартийНДСКРаспределению(НачалоПериода, РасчетныеПриходыПартийРасходов)
	
	Запрос = Новый Запрос(ТекстОписаниеДанныхДляПартийНДСКРаспределению());
	РасчетныеПартии = Запрос.Выполнить().Выгрузить();
	
	// Шаг 1: формируем движения по регистру ПрочиеРасходы
	Для Каждого Движение Из РасчетныеПриходыПартийРасходов Цикл
		Если ЗначениеЗаполнено(Движение.СтатьяРасходов)
		 И ЗначениеЗаполнено(Движение.ВариантРаздельногоУчетаНДС)
		 И Движение.ВариантРаздельногоУчетаНДС = Перечисления.ВариантыРаздельногоУчетаНДС.Распределение Тогда
			РасчетнаяПартия = РасчетныеПартии.Добавить();
			ЗаполнитьЗначенияСвойств(РасчетнаяПартия, Движение,
				"Период, Регистратор, Организация, ДокументПоступленияРасходов, НаправлениеДеятельности,
				|Поставщик, ВидЦенности, СтавкаНДС,
				|СтоимостьРегл, НДСРегл");
			РасчетнаяПартия.ВидДвижения = ВидДвиженияНакопления.Приход;
			
			РасчетнаяПартия.Подразделение 			= Движение.ПодразделениеРасходов;
			РасчетнаяПартия.СтатьяРасходов 			= Движение.СтатьяОтраженияРасходов;
			РасчетнаяПартия.АналитикаРасходов 		= Движение.АналитикаОтраженияРасходов;
			РасчетнаяПартия.ВидДеятельностиНДС 		= Движение.НалогообложениеНДС;
			
		ИначеЕсли Движение.НалогообложениеПартии = Перечисления.ТипыНалогообложенияНДС.ОпределяетсяРаспределением
		 И Движение.НДСРегл <> 0 Тогда
			РасчетнаяПартия = РасчетныеПартии.Добавить();
			ЗаполнитьЗначенияСвойств(РасчетнаяПартия, Движение,
				"Период, Регистратор, Организация, ДокументПоступленияРасходов,
				|Поставщик, ВидЦенности, СтавкаНДС, НДСРегл");
			РасчетнаяПартия.ВидДвижения = ВидДвиженияНакопления.Приход;
			РасчетнаяПартия.ВидДеятельностиНДС = Движение.НалогообложениеПартии;
		КонецЕсли;
	КонецЦикла;
	
	// Шаг 2: Сортировка партий для дальнейшей записи
	РасчетныеПартии.Сортировать("Регистратор, Период", Новый СравнениеЗначений);
	Возврат РасчетныеПартии;
КонецФункции

Функция ТекстИсходныеПриходыПартийРасходов() // использует &Регистраторы
	Возврат "
		|ВЫБРАТЬ
		|	10 КАК Приоритет,
		|	""Дополнение"" КАК ТипЗаписи,
		|	ИСТИНА КАК РасчетЗавершен,
		|	ДД.ВидДвижения,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ДокументПоступления,
		|	ДД.ВидЗапасов,
		|	ДД.АналитикаУчетаПартий,
		|	ДД.ДокументПоступленияРасходов,
		|	ДД.СтатьяРасходов,
		|	ДД.Количество,
		|	ДД.Стоимость,
		|	ДД.СтоимостьБезНДС,
		|	ДД.СтоимостьРегл,
		|	ДД.НДСРегл,
		|	ДД.ПостояннаяРазница,
		|	ДД.ВременнаяРазница,
		|	ДД.НалогообложениеНДС,
		|	ДД.ХозяйственнаяОперация,
		|	ДД.ПодразделениеРасходов,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КАК КорАналитикаУчетаНоменклатуры,
		|	ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка) КАК КорВидЗапасов
		|ИЗ
		|	РегистрНакопления.ПартииРасходовНаСебестоимостьТоваров КАК ДД
		|ГДЕ
		|	ДД.Регистратор В (&Регистраторы)
		|	И ДД.ДокументПоступленияРасходов = ДД.Регистратор
		|	И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|	И (ДД.СтатьяРасходов = ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка)
		|		ИЛИ ДД.Период < &НачалоПериода)
		|";
КонецФункции

Функция ТекстАналитикиПартнеров() // использует &Поступления
	Возврат "
		|ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	ДД.Регистратор КАК Декларация,
		|	ДД.ДокументПоступления КАК Поступление
		|ПОМЕСТИТЬ
		|	Импорт
		|ИЗ
		|	РегистрНакопления.ПартииТоваровОрганизаций КАК ДД
		|ГДЕ
		|	ДД.Регистратор ССЫЛКА Документ.ТаможеннаяДекларацияИмпорт
		|	И ДД.Регистратор В (&Поступления)
		|	И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		|;
		|ВЫБРАТЬ
		|	ДД.Регистратор КАК ДокументПоступления,
		|	МИНИМУМ(ДД.АналитикаУчетаПоПартнерам) КАК АналитикаУчетаПоПартнерам
		|ИЗ
		|	РегистрНакопления.СебестоимостьТоваров КАК ДД
		|ГДЕ
		|	ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|	И ДД.Количество > 0
		|	И ДД.АналитикаУчетаПоПартнерам <> ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПоПартнерам.ПустаяСсылка)
		|	И ДД.Регистратор В (&Поступления)
		|СГРУППИРОВАТЬ ПО
		|	ДД.Регистратор
		|	
		|ОБЪЕДИНИТЬ ВСЕ
		|ВЫБРАТЬ
		|	Импорт.Декларация КАК ДокументПоступления,
		|	МИНИМУМ(ДД.АналитикаУчетаПоПартнерам) КАК АналитикаУчетаПоПартнерам
		|ИЗ
		|	РегистрНакопления.СебестоимостьТоваров КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Импорт КАК Импорт
		|		ПО Импорт.Поступление = ДД.Регистратор
		|ГДЕ
		|	ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|	И ДД.Количество > 0
		|	И ДД.АналитикаУчетаПоПартнерам <> ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПоПартнерам.ПустаяСсылка)
		|СГРУППИРОВАТЬ ПО
		|	Импорт.Декларация
		|";
КонецФункции

Функция ТекстАналитикиБезНазначений() // использует &АналитикиНоменклатуры
	Возврат "
		|ВЫБРАТЬ
		|	Аналитики.Ссылка КАК Аналитика,
		|	АналитикиБезНазначения.КлючАналитики КАК АналитикаБезНазначения
		|ИЗ
		|	Справочник.КлючиАналитикиУчетаНоменклатуры КАК Аналитики
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаНоменклатуры КАК АналитикиБезНазначения
		|		ПО АналитикиБезНазначения.Номенклатура = Аналитики.Номенклатура
		|		И АналитикиБезНазначения.Характеристика = Аналитики.Характеристика
		|		И АналитикиБезНазначения.Серия = Аналитики.Серия
		|		И АналитикиБезНазначения.МестоХранения = Аналитики.МестоХранения
		|		И АналитикиБезНазначения.Назначение = ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка)
		//++ НЕ УТ		
		|		И АналитикиБезНазначения.СтатьяКалькуляции = ЗНАЧЕНИЕ(Справочник.СтатьиКалькуляции.ПустаяСсылка)
		//-- НЕ УТ
		|ГДЕ
		|	Аналитики.Ссылка В (&АналитикиНоменклатуры)
		|";
КонецФункции

Функция ТекстОписаниеДанныхДляПрочихРасходов()
	Возврат "
	|ВЫБРАТЬ ПЕРВЫЕ 0
	|	0 КАК Приоритет,
	|	""ХХХХХХХХХХХХХХХХХХХХ"" КАК ТипЗаписи,
	|	ЛОЖЬ КАК РасчетЗавершен,
	|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КАК РазделУчета,
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
	|	ДАТАВРЕМЯ(1, 1, 1, 0, 0, 0) КАК Период,
	|	Т.Регистратор КАК Регистратор,
	|	Т.Организация КАК Организация,
	|	ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка) КАК Подразделение,
	|	ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка) КАК НаправлениеДеятельности,
	|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) КАК СтатьяРасходов,
	|	Т.АналитикаРасходов КАК АналитикаРасходов,
	|	Т.ХозяйственнаяОперация КАК ХозяйственнаяОперация,
	|	Т.Регистратор КАК ДокументДвижения,
	|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) КАК КорСтатьяРасходов,
	|	Т.АналитикаРасходов КАК КорАналитикаРасходов,
	|	ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка) КАК КорПодразделение,
	|	ЗНАЧЕНИЕ(Справочник.ГруппыАналитическогоУчетаНоменклатуры.ПустаяСсылка) КАК ГруппаПродукции,
	|	0 КАК Знаменатель,
	|	0 КАК ДоляСтоимости,
	|	0 КАК Сумма,
	|	0 КАК СуммаБезНДС,
	|	0 КАК СуммаРегл,
	|	0 КАК ПостояннаяРазница,
	|	0 КАК ВременнаяРазница
	|ИЗ
	|	РегистрНакопления.ПрочиеРасходы КАК Т
	|";
КонецФункции

Функция ТекстОписаниеСебестоимость()
	Возврат "
		|ВЫБРАТЬ ПЕРВЫЕ 0
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
		|	ДАТАВРЕМЯ(1, 1, 1, 0, 0, 0) КАК Период,
		|	НЕОПРЕДЕЛЕНО КАК Регистратор,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КАК АналитикаУчетаНоменклатуры,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КАК РазделУчета,
		|	ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка) КАК ВидЗапасов,
		|	ЗНАЧЕНИЕ(Справочник.Организации.ПустаяСсылка) КАК Организация,
		|	0 КАК Количество,
		|	0 КАК Стоимость,
		|	0 КАК СтоимостьБезНДС,
		|	0 КАК ДопРасходы,
		|	0 КАК ДопРасходыБезНДС,
		|	0 КАК СтоимостьРегл,
		|	0 КАК ПостояннаяРазница,
		|	0 КАК ВременнаяРазница,
		|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПустаяСсылка) КАК ХозяйственнаяОперация,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КАК КорАналитикаУчетаНоменклатуры,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КАК КорРазделУчета,
		|	ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка) КАК КорВидЗапасов,
		|	ЗНАЧЕНИЕ(Справочник.Организации.ПустаяСсылка) КАК КорОрганизация,
		|	0 КАК КорСтоимость,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПоПартнерам.ПустаяСсылка) КАК АналитикаУчетаПоПартнерам,
		|	НЕОПРЕДЕЛЕНО КАК ЗаказКлиента,
		|	ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка) КАК Подразделение,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
		|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) КАК СтатьяРасходовСписания,
		|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиДоходов.ПустаяСсылка) КАК СтатьяДоходов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаДоходов,
		|	ДАТАВРЕМЯ(1, 1, 1, 0, 0, 0) КАК ПериодПродажи,
		|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиАктивовПассивов.ПустаяСсылка) КАК СтатьяАктивовПассивов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивовПассивов,
		|	НЕОПРЕДЕЛЕНО КАК ДокументДвижения,
		|	""ХХ"" КАК ИдентификаторСтроки,
		|	ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка) КАК КорНаправлениеДеятельности,
		|	ЗНАЧЕНИЕ(Справочник.ГруппыАналитическогоУчетаНоменклатуры.ПустаяСсылка) КАК ГруппаПродукции
		|//ВоВременнуюТаблицу ПОМЕСТИТЬ ДанныеПредварительные
		|";
КонецФункции

Функция ТекстИсходныеДвиженияСебестоимость() // использует &Регистраторы
	Возврат "
		|ВЫБРАТЬ
		|	ДД.ВидДвижения,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.РазделУчета,
		|	ДД.ВидЗапасов,
		|	ДД.Организация,
		|	ДД.Количество,
		|	ДД.Стоимость,
		|	ДД.СтоимостьБезНДС,
		|	ДД.ДопРасходы,
		|	ДД.ДопРасходыБезНДС,
		|	ДД.СтоимостьРегл,
		|	ДД.ПостояннаяРазница,
		|	ДД.ВременнаяРазница,
		|	ДД.ХозяйственнаяОперация,
		|	ДД.КорАналитикаУчетаНоменклатуры,
		|	ДД.КорРазделУчета,
		|	ДД.КорВидЗапасов,
		|	ДД.КорОрганизация,
		|	ДД.КорСтоимость,
		|	ДД.АналитикаУчетаПоПартнерам,
		|	ДД.ЗаказКлиента,
		|	ДД.Подразделение,
		|	ДД.АналитикаРасходов,
		|	ДД.СтатьяРасходовСписания,
		|	ДД.СтатьяДоходов,
		|	ДД.АналитикаДоходов,
		|	ДД.ПериодПродажи,
		|	ДД.СтатьяАктивовПассивов,
		|	ДД.АналитикаАктивовПассивов,
		|	ДД.ДокументДвижения,
		|	ДД.ИдентификаторСтроки,
		|	ДД.КорНаправлениеДеятельности,
		|	ДД.ГруппаПродукции
		|ИЗ
		|	РегистрНакопления.СебестоимостьТоваров КАК ДД
		|ГДЕ
		|	ДД.Регистратор В (&Регистраторы)
		|	И НЕ ДД.РасчетСебестоимости
		|	И (ДД.ДопРасходы = 0 И ДД.Количество <> 0
		|		ИЛИ ДД.ДопРасходы <> 0 И ДД.Период < &НачалоПериода
		|		ИЛИ ДД.ДопРасходы <> 0 И ДД.Период > &ОкончаниеПериода
		|		ИЛИ ДД.СтатьяРасходовСписания = ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка))
		|";
КонецФункции

Функция ТекстПриходыПоступленийПоЗаказамСебестоимости() // использует ЗаказыИзАналитикРасходов
	Возврат "
		|ВЫБРАТЬ
		|	90 КАК Приоритет,
		|	""Потребление"" КАК ТипЗаписи,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) КАК ВидДвижения,
		|	Заказы.ДатаПоступления КАК Период,
		|	ДД.Регистратор КАК Регистратор,
		|	НЕОПРЕДЕЛЕНО КАК ДокументПоступления,
		|	НЕОПРЕДЕЛЕНО КАК Заказ,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.АналитикаУчетаНоменклатуры.Номенклатура   КАК Номенклатура,
		|	ДД.АналитикаУчетаНоменклатуры.Характеристика КАК Характеристика,
		|	ДД.АналитикаУчетаНоменклатуры.МестоХранения  КАК Склад,
		|	ДД.АналитикаУчетаНоменклатуры.Серия          КАК Серия,
		|	ДД.АналитикаУчетаНоменклатуры.Назначение     КАК Назначение,
		|	ДД.ВидЗапасов,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка),
		|	СУММА(ДД.Количество) КАК Количество,
		|	СУММА(ДД.Стоимость) КАК Стоимость,
		|	СУММА(ДД.СтоимостьБезНДС) КАК СтоимостьБезНДС,
		|	СУММА(ДД.СтоимостьРегл) КАК СтоимостьРегл,
		|	0,
		|	СУММА(ДД.ПостояннаяРазница) КАК ПостояннаяРазница,
		|	СУММА(ДД.ВременнаяРазница) КАК ВременнаяРазница,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
		|ИЗ
		|	РегистрНакопления.СебестоимостьТоваров КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ЗаказыИзАналитикРасходовСводно КАК Заказы
		|		ПО Заказы.Поступление = ДД.Регистратор
		|		И Заказы.Номенклатура = ДД.АналитикаУчетаНоменклатуры.Номенклатура
		|		И Заказы.Характеристика = ДД.АналитикаУчетаНоменклатуры.Характеристика
		|		И Заказы.Склад = ДД.АналитикаУчетаНоменклатуры.МестоХранения
		|		И Заказы.Назначение = ДД.АналитикаУчетаНоменклатуры.Назначение
		|ГДЕ
		|	ДД.Период <= &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|СГРУППИРОВАТЬ ПО
		|	Заказы.ДатаПоступления,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.АналитикаУчетаНоменклатуры.Номенклатура,
		|	ДД.АналитикаУчетаНоменклатуры.Характеристика,
		|	ДД.АналитикаУчетаНоменклатуры.МестоХранения,
		|	ДД.АналитикаУчетаНоменклатуры.Серия,
		|	ДД.АналитикаУчетаНоменклатуры.Назначение,
		|	ДД.ВидЗапасов
		|";
КонецФункции

Функция ТекстБазисОстаткиСебестоимость() // использует АналитикиРасходовВсе
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстБазисОстаткиСебестоимость"" КАК ЗапросИсточник,
		|	90 КАК Приоритет,
		|	""Потребление"" КАК ТипЗаписи,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) КАК ВидДвижения,
		|	&НачалоПериода КАК Период,
		|	ЗНАЧЕНИЕ(Документ.ПриобретениеТоваровУслуг.ПустаяСсылка) КАК Регистратор,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	СпрНоменклатура.Ссылка КАК Номенклатура,
		|	АналитикиТоваров.МестоХранения КАК Склад,
		|	НЕОПРЕДЕЛЕНО КАК ДокументПоступления,
		|	ДД.ВидЗапасов,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка) КАК АналитикаУчетаПартий,
		|	ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка) КАК НаправлениеДеятельности,
		|	НЕОПРЕДЕЛЕНО КАК Поставщик,
		|	НЕОПРЕДЕЛЕНО КАК ДокументПоступленияРасходов,
		|	НЕОПРЕДЕЛЕНО КАК ВидЦенности,
		|	НЕОПРЕДЕЛЕНО КАК СтавкаНДС,
		|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) КАК СтатьяРасходов,
		|	ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка) КАК Подразделение,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРаспределения,
		|	0 КАК Базис,
		|	ДД.КоличествоОстаток КАК Количество,
		|	&Вес * ДД.КоличествоОстаток КАК Вес,
		|	&Объем * ДД.КоличествоОстаток КАК Объем,
		|	ДД.СтоимостьОстаток КАК Стоимость,
		|	ДД.СтоимостьБезНДСОстаток КАК СтоимостьБезНДС,
		|	ДД.СтоимостьРеглОстаток КАК СтоимостьРегл,
		|	0 КАК НДСРегл,
		|	ДД.ПостояннаяРазницаОстаток КАК ПостояннаяРазница,
		|	ДД.ВременнаяРазницаОстаток КАК ВременнаяРазница,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка) КАК НалогообложениеПартии,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка) КАК НалогообложениеНДС,
		|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПустаяСсылка) КАК ХозяйственнаяОперация,
		|	ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка) КАК ПодразделениеРасходов,
		|	НЕОПРЕДЕЛЕНО КАК ДокументРеализации,
		|	НЕОПРЕДЕЛЕНО КАК ДокументИсточник,
		|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) КАК СтатьяОтраженияРасходов,
		|	ЗНАЧЕНИЕ(Перечисление.ВариантыРаздельногоУчетаНДС.ПустаяСсылка)	КАК ВариантРаздельногоУчетаНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаОтраженияРасходов,
		|	ЗНАЧЕНИЕ(Перечисление.ПравилаРаспределенияНаСебестоимостьТоваров.ПустаяСсылка) КАК ПравилоРаспределения,
		|	ДД.РазделУчета,
		|	&НачалоПериода КАК РасчетныйПериод,
		|	ЛОЖЬ КАК РасчетПартий
		|ИЗ
		|	РегистрНакопления.СебестоимостьТоваров.Остатки(&НачалоПериода, Организация В (&МассивОрганизаций)
		|		И РазделУчета <> ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПринятыеНаКомиссию)
		|		И РазделУчета <> ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.МатериалыПринятыеВПереработку)
		|	) КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК АналитикиТоваров
		|		ПО АналитикиТоваров.Ссылка = ДД.АналитикаУчетаНоменклатуры
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Номенклатура КАК СпрНоменклатура
		|		ПО СпрНоменклатура.Ссылка = АналитикиТоваров.Номенклатура
		|ГДЕ
		|	ДД.СтоимостьОстаток > 0
		|	И (ДД.Организация,
		|		АналитикиТоваров.Номенклатура,
		|		АналитикиТоваров.МестоХранения,
		|		ЕСТЬNULL(АналитикиТоваров.Назначение.НаправлениеДеятельности,
		|			ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка))) В
		|	(
		|		ВЫБРАТЬ РАЗЛИЧНЫЕ
		|			КлючиРасходов.Организация,
		|			АналитикиТоваров.Номенклатура,
		|			АналитикиТоваров.МестоХранения,
		|			КлючиРасходов.НаправлениеДеятельности
		|		ИЗ
		|			АналитикиРасходовВсе КАК КлючиРасходов
		|		ГДЕ 
		|			КлючиРасходов.АналитикаРасходов В (
		|				АналитикиТоваров.Номенклатура,
		|				ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка),
		|				АналитикиТоваров.МестоХранения,
		|				ЗНАЧЕНИЕ(Справочник.Склады.ПустаяСсылка)
		|				)
		|	)
		|";
КонецФункции

Функция ТекстБазисПриходыТоваровСебестоимость() // использует АналитикиРасходовВсе
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстБазисПриходыТоваровСебестоимость"" КАК ЗапросИсточник,
		|	90 КАК Приоритет,
		|	""Потребление"" КАК ТипЗаписи,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) КАК ВидДвижения,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	СпрНоменклатура.Ссылка КАК Номенклатура,
		|	АналитикиТоваров.МестоХранения КАК Склад,
		|	ДД.Регистратор,
		|	ДД.ВидЗапасов,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка) КАК АналитикаУчетаПартий,
		|	ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка) КАК НаправлениеДеятельности,
		|	НЕОПРЕДЕЛЕНО КАК Поставщик,
		|	НЕОПРЕДЕЛЕНО КАК ДокументПоступленияРасходов,
		|	НЕОПРЕДЕЛЕНО КАК ВидЦенности,
		|	НЕОПРЕДЕЛЕНО КАК СтавкаНДС,
		|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) КАК СтатьяРасходов,
		|	ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка) КАК Подразделение,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРаспределения,
		|	0 КАК Базис,
		|	СУММА(ДД.Количество) / КОЛИЧЕСТВО(РАЗЛИЧНЫЕ Товары.НомерСтроки) КАК Количество,
		|	СУММА(&Вес * ДД.Количество) / КОЛИЧЕСТВО(РАЗЛИЧНЫЕ Товары.НомерСтроки) КАК Вес,
		|	СУММА(&Объем * ДД.Количество) / КОЛИЧЕСТВО(РАЗЛИЧНЫЕ Товары.НомерСтроки) КАК Объем,
		|	СУММА(ДД.Стоимость) / КОЛИЧЕСТВО(РАЗЛИЧНЫЕ Товары.НомерСтроки) КАК Стоимость,
		|	СУММА(ДД.СтоимостьБезНДС) / КОЛИЧЕСТВО(РАЗЛИЧНЫЕ Товары.НомерСтроки) КАК СтоимостьБезНДС,
		|	СУММА(ДД.СтоимостьРегл) / КОЛИЧЕСТВО(РАЗЛИЧНЫЕ Товары.НомерСтроки) КАК СтоимостьРегл,
		|	0 КАК НДСРегл,
		|	СУММА(ДД.ПостояннаяРазница) / КОЛИЧЕСТВО(РАЗЛИЧНЫЕ Товары.НомерСтроки) КАК ПостояннаяРазница,
		|	СУММА(ДД.ВременнаяРазница) / КОЛИЧЕСТВО(РАЗЛИЧНЫЕ Товары.НомерСтроки) КАК ВременнаяРазница,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка) КАК НалогообложениеПартии,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка) КАК НалогообложениеНДС,
		|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПустаяСсылка) КАК ХозяйственнаяОперация,
		|	ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка) КАК ПодразделениеРасходов,
		|	НЕОПРЕДЕЛЕНО КАК ДокументРеализации,
		|	НЕОПРЕДЕЛЕНО КАК ДокументИсточник,
		|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) КАК СтатьяОтраженияРасходов,
		|	ЗНАЧЕНИЕ(Перечисление.ВариантыРаздельногоУчетаНДС.ПустаяСсылка)	КАК ВариантРаздельногоУчетаНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаОтраженияРасходов,
		|	ЗНАЧЕНИЕ(Перечисление.ПравилаРаспределенияНаСебестоимостьТоваров.ПустаяСсылка) КАК ПравилоРаспределения,
		|	ДД.РазделУчета,
		|	ДД.Период КАК РасчетныйПериод,
		|	ЛОЖЬ КАК РасчетПартий
		|ИЗ
		|	РегистрНакопления.СебестоимостьТоваров КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК АналитикиТоваров
		|		ПО АналитикиТоваров.Ссылка = ДД.АналитикаУчетаНоменклатуры
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Номенклатура КАК СпрНоменклатура
		|		ПО СпрНоменклатура.Ссылка = АналитикиТоваров.Номенклатура
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Склады КАК Склады
		|		ПО АналитикиТоваров.МестоХранения = Склады.Ссылка
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрНакопления.ТоварыОрганизаций КАК Товары
		|		ПО Товары.Регистратор = ДД.Регистратор
		|		И Товары.АналитикаУчетаНоменклатуры.Номенклатура = АналитикиТоваров.Номенклатура
		|		И Товары.АналитикаУчетаНоменклатуры.Характеристика = АналитикиТоваров.Характеристика
		|		И Товары.АналитикаУчетаНоменклатуры.Серия = АналитикиТоваров.Серия
		|		И Товары.АналитикаУчетаНоменклатуры.МестоХранения = АналитикиТоваров.МестоХранения
		|		И Товары.Организация = ДД.Организация
		|		И Товары.ВидЗапасов = ДД.ВидЗапасов
		|		И Товары.Первичное = ИСТИНА
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И НЕ ДД.РазделУчета В (
		|		ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПринятыеНаКомиссию),
		|		ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.МатериалыПринятыеВПереработку))
		|	И (ДД.Организация,
		|		АналитикиТоваров.Номенклатура,
		|		АналитикиТоваров.МестоХранения,
		|		ЕСТЬNULL(АналитикиТоваров.Назначение.НаправлениеДеятельности,
		|			ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)),
		|		ДД.Регистратор) В
		|	(
		|		ВЫБРАТЬ РАЗЛИЧНЫЕ
		|			КлючиРасходов.Организация,
		|			АналитикиТоваров.Номенклатура,
		|			АналитикиТоваров.МестоХранения,
		|			КлючиРасходов.НаправлениеДеятельности,
		|			ДД.Регистратор
		|		ИЗ
		|			АналитикиРасходовВсе КАК КлючиРасходов
		|		ГДЕ 
		|			КлючиРасходов.АналитикаРасходов В (
		|				АналитикиТоваров.Номенклатура,
		|				ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка),
		|				АналитикиТоваров.МестоХранения,
		|				ЗНАЧЕНИЕ(Справочник.Склады.ПустаяСсылка),
		|				ДД.Регистратор)
		|			ИЛИ
		|			ТИПЗНАЧЕНИЯ(ДД.Регистратор) = ТИПЗНАЧЕНИЯ(КлючиРасходов.АналитикаРасходов)
		|			И КлючиРасходов.АналитикаРасходов В (
		|				ЗНАЧЕНИЕ(Документ.ПриобретениеТоваровУслуг.ПустаяСсылка),
		|				ЗНАЧЕНИЕ(Документ.СборкаТоваров.ПустаяСсылка),
		|				ЗНАЧЕНИЕ(Документ.ПередачаТоваровМеждуОрганизациями.ПустаяСсылка))
		|	)
		|СГРУППИРОВАТЬ ПО
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	СпрНоменклатура.Ссылка,
		|	АналитикиТоваров.МестоХранения,
		|	ДД.Регистратор,
		|	ДД.ВидЗапасов,
		|	ДД.РазделУчета
		|";
КонецФункции

Функция ТекстБазисПриходыИнтеркампаниСебестоимость() // использует АналитикиРасходовВсе
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстБазисПриходыИнтеркампаниСебестоимость"" КАК ЗапросИсточник,
		|	90 КАК Приоритет,
		|	""Потребление"" КАК ТипЗаписи,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) КАК ВидДвижения,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	СпрНоменклатура.Ссылка КАК Номенклатура,
		|	АналитикиТоваров.МестоХранения КАК Склад,
		|	ДД.Регистратор,
		|	ДД.ВидЗапасов,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка) КАК АналитикаУчетаПартий,
		|	ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка) КАК НаправлениеДеятельности,
		|	НЕОПРЕДЕЛЕНО КАК Поставщик,
		|	НЕОПРЕДЕЛЕНО КАК ДокументПоступленияРасходов,
		|	НЕОПРЕДЕЛЕНО КАК ВидЦенности,
		|	НЕОПРЕДЕЛЕНО КАК СтавкаНДС,
		|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) КАК СтатьяРасходов,
		|	ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка) КАК Подразделение,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРаспределения,
		|	0 КАК Базис,
		|	СУММА(ДД.Количество) / КОЛИЧЕСТВО(РАЗЛИЧНЫЕ Товары.НомерСтроки) КАК Количество,
		|	СУММА(&Вес * ДД.Количество) / КОЛИЧЕСТВО(РАЗЛИЧНЫЕ Товары.НомерСтроки) КАК Вес,
		|	СУММА(&Объем * ДД.Количество) / КОЛИЧЕСТВО(РАЗЛИЧНЫЕ Товары.НомерСтроки) КАК Объем,
		|	СУММА(ДД.Стоимость) / КОЛИЧЕСТВО(РАЗЛИЧНЫЕ Товары.НомерСтроки) КАК Стоимость,
		|	СУММА(ДД.СтоимостьБезНДС) / КОЛИЧЕСТВО(РАЗЛИЧНЫЕ Товары.НомерСтроки) КАК СтоимостьБезНДС,
		|	СУММА(ДД.СтоимостьРегл) / КОЛИЧЕСТВО(РАЗЛИЧНЫЕ Товары.НомерСтроки) КАК СтоимостьРегл,
		|	0 КАК НДСРегл,
		|	СУММА(ДД.ПостояннаяРазница) / КОЛИЧЕСТВО(РАЗЛИЧНЫЕ Товары.НомерСтроки) КАК ПостояннаяРазница,
		|	СУММА(ДД.ВременнаяРазница) / КОЛИЧЕСТВО(РАЗЛИЧНЫЕ Товары.НомерСтроки) КАК ВременнаяРазница,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка) КАК НалогообложениеПартии,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка) КАК НалогообложениеНДС,
		|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПустаяСсылка) КАК ХозяйственнаяОперация,
		|	ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка) КАК ПодразделениеРасходов,
		|	НЕОПРЕДЕЛЕНО КАК ДокументРеализации,
		|	НЕОПРЕДЕЛЕНО КАК ДокументИсточник,
		|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) КАК СтатьяОтраженияРасходов,
		|	ЗНАЧЕНИЕ(Перечисление.ВариантыРаздельногоУчетаНДС.ПустаяСсылка)	КАК ВариантРаздельногоУчетаНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаОтраженияРасходов,
		|	ЗНАЧЕНИЕ(Перечисление.ПравилаРаспределенияНаСебестоимостьТоваров.ПустаяСсылка) КАК ПравилоРаспределения,
		|	ДД.РазделУчета,
		|	ДД.Период КАК РасчетныйПериод,
		|	ЛОЖЬ КАК РасчетПартий
		|ИЗ
		|	РегистрНакопления.СебестоимостьТоваров КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК АналитикиТоваров
		|		ПО АналитикиТоваров.Ссылка = ДД.АналитикаУчетаНоменклатуры
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Номенклатура КАК СпрНоменклатура
		|		ПО СпрНоменклатура.Ссылка = АналитикиТоваров.Номенклатура
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрНакопления.ТоварыОрганизацийКПередаче КАК Товары
		|		ПО Товары.Регистратор = ДД.Регистратор
		|		И Товары.АналитикаУчетаНоменклатуры = ДД.АналитикаУчетаНоменклатуры
		|		И Товары.ВидЗапасовПродавца.Организация = ДД.Организация
		|		И Товары.ВидЗапасовПродавца = ДД.ВидЗапасов
		|		И Товары.Первичное = ИСТИНА
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И НЕ ДД.РазделУчета В (
		|		ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПринятыеНаКомиссию),
		|		ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.МатериалыПринятыеВПереработку))
		|	И (ДД.Организация,
		|		АналитикиТоваров.Номенклатура,
		|		АналитикиТоваров.МестоХранения,
		|		ЕСТЬNULL(АналитикиТоваров.Назначение.НаправлениеДеятельности,
		|			ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)),
		|		ДД.Регистратор) В
		|	(
		|		ВЫБРАТЬ РАЗЛИЧНЫЕ
		|			КлючиРасходов.Организация,
		|			АналитикиТоваров.Номенклатура,
		|			АналитикиТоваров.МестоХранения,
		|			КлючиРасходов.НаправлениеДеятельности,
		|			ДД.Регистратор
		|		ИЗ
		|			АналитикиРасходовВсе КАК КлючиРасходов
		|		ГДЕ 
		|			КлючиРасходов.АналитикаРасходов В (
		|				АналитикиТоваров.Номенклатура,
		|				ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка),
		|				АналитикиТоваров.МестоХранения,
		|				ЗНАЧЕНИЕ(Справочник.Склады.ПустаяСсылка),
		|				ДД.Регистратор)
		|			ИЛИ
		|			ТИПЗНАЧЕНИЯ(ДД.Регистратор) = ТИПЗНАЧЕНИЯ(КлючиРасходов.АналитикаРасходов)
		|			И КлючиРасходов.АналитикаРасходов В (
		|				ЗНАЧЕНИЕ(Документ.ПриобретениеТоваровУслуг.ПустаяСсылка),
		|				ЗНАЧЕНИЕ(Документ.СборкаТоваров.ПустаяСсылка),
		|				ЗНАЧЕНИЕ(Документ.ПередачаТоваровМеждуОрганизациями.ПустаяСсылка))
		|	)
		|СГРУППИРОВАТЬ ПО
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	СпрНоменклатура.Ссылка,
		|	АналитикиТоваров.МестоХранения,
		|	ДД.Регистратор,
		|	ДД.ВидЗапасов,
		|	ДД.РазделУчета
		|";
КонецФункции

Функция ТекстБазисПриходыРаботСебестоимость() // использует АналитикиРасходовВсе
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстБазисПриходыРаботСебестоимость"" КАК ЗапросИсточник,
		|	90 КАК Приоритет,
		|	""Потребление"" КАК ТипЗаписи,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) КАК ВидДвижения,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	СпрНоменклатура.Ссылка КАК Номенклатура,
		|	АналитикиТоваров.МестоХранения КАК Склад,
		|	ДД.Регистратор,
		|	ДД.ВидЗапасов,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка) КАК АналитикаУчетаПартий,
		|	ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка) КАК НаправлениеДеятельности,
		|	НЕОПРЕДЕЛЕНО КАК Поставщик,
		|	НЕОПРЕДЕЛЕНО КАК ДокументПоступленияРасходов,
		|	НЕОПРЕДЕЛЕНО КАК ВидЦенности,
		|	НЕОПРЕДЕЛЕНО КАК СтавкаНДС,
		|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) КАК СтатьяРасходов,
		|	ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка) КАК Подразделение,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРаспределения,
		|	0 КАК Базис,
		|	СУММА(ДД.Количество) / КОЛИЧЕСТВО(РАЗЛИЧНЫЕ Затраты.НомерСтроки) КАК Количество,
		|	СУММА(&Вес * ДД.Количество) / КОЛИЧЕСТВО(РАЗЛИЧНЫЕ Затраты.НомерСтроки) КАК Вес,
		|	СУММА(&Объем * ДД.Количество) / КОЛИЧЕСТВО(РАЗЛИЧНЫЕ Затраты.НомерСтроки) КАК Объем,
		|	СУММА(ДД.Стоимость) / КОЛИЧЕСТВО(РАЗЛИЧНЫЕ Затраты.НомерСтроки) КАК Стоимость,
		|	СУММА(ДД.СтоимостьБезНДС) / КОЛИЧЕСТВО(РАЗЛИЧНЫЕ Затраты.НомерСтроки) КАК СтоимостьБезНДС,
		|	СУММА(ДД.СтоимостьРегл) / КОЛИЧЕСТВО(РАЗЛИЧНЫЕ Затраты.НомерСтроки) КАК СтоимостьРегл,
		|	0 КАК НДСРегл,
		|	СУММА(ДД.ПостояннаяРазница) / КОЛИЧЕСТВО(РАЗЛИЧНЫЕ Затраты.НомерСтроки) КАК ПостояннаяРазница,
		|	СУММА(ДД.ВременнаяРазница) / КОЛИЧЕСТВО(РАЗЛИЧНЫЕ Затраты.НомерСтроки) КАК ВременнаяРазница,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка) КАК НалогообложениеПартии,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка) КАК НалогообложениеНДС,
		|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПустаяСсылка) КАК ХозяйственнаяОперация,
		|	ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка) КАК ПодразделениеРасходов,
		|	НЕОПРЕДЕЛЕНО КАК ДокументРеализации,
		|	НЕОПРЕДЕЛЕНО КАК ДокументИсточник,
		|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) КАК СтатьяОтраженияРасходов,
		|	ЗНАЧЕНИЕ(Перечисление.ВариантыРаздельногоУчетаНДС.ПустаяСсылка)	КАК ВариантРаздельногоУчетаНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаОтраженияРасходов,
		|	ЗНАЧЕНИЕ(Перечисление.ПравилаРаспределенияНаСебестоимостьТоваров.ПустаяСсылка) КАК ПравилоРаспределения,
		|	ДД.РазделУчета,
		|	ДД.Период КАК РасчетныйПериод,
		|	ЛОЖЬ КАК РасчетПартий
		|ИЗ
		|	РегистрНакопления.СебестоимостьТоваров КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК АналитикиТоваров
		|		ПО АналитикиТоваров.Ссылка = ДД.АналитикаУчетаНоменклатуры
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Номенклатура КАК СпрНоменклатура
		|		ПО СпрНоменклатура.Ссылка = АналитикиТоваров.Номенклатура
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрНакопления.МатериалыИРаботыВПроизводстве КАК Затраты
		|		ПО Затраты.Регистратор = ДД.Регистратор
		|		И Затраты.АналитикаУчетаНоменклатуры = ДД.АналитикаУчетаНоменклатуры
		|		И Затраты.Организация = ДД.Организация
		|		И (Затраты.Назначение = АналитикиТоваров.Назначение
		|			ИЛИ НЕ &УчитыватьСебестоимостьТоваровПоНазначениям
		|			)
		|		И Затраты.Первичное = ИСТИНА
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И (ДД.Организация,
		|		АналитикиТоваров.Номенклатура,
		|		АналитикиТоваров.МестоХранения,
		|		ЕСТЬNULL(АналитикиТоваров.Назначение.НаправлениеДеятельности,
		|			ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)),
		|		ДД.Регистратор) В
		|	(
		|		ВЫБРАТЬ РАЗЛИЧНЫЕ
		|			КлючиРасходов.Организация,
		|			АналитикиТоваров.Номенклатура,
		|			АналитикиТоваров.МестоХранения,
		|			КлючиРасходов.НаправлениеДеятельности,
		|			ДД.Регистратор
		|		ИЗ
		|			АналитикиРасходовВсе КАК КлючиРасходов
		|		ГДЕ 
		|			КлючиРасходов.АналитикаРасходов В (
		|				АналитикиТоваров.Номенклатура,
		|				ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка),
		|				АналитикиТоваров.МестоХранения,
		|				ЗНАЧЕНИЕ(Справочник.Склады.ПустаяСсылка),
		|				ДД.Регистратор)
		|			ИЛИ
		|			ТИПЗНАЧЕНИЯ(ДД.Регистратор) = ТИПЗНАЧЕНИЯ(КлючиРасходов.АналитикаРасходов)
		|			И КлючиРасходов.АналитикаРасходов В (
		|				ЗНАЧЕНИЕ(Документ.ПриобретениеТоваровУслуг.ПустаяСсылка),
		|				ЗНАЧЕНИЕ(Документ.ПередачаТоваровМеждуОрганизациями.ПустаяСсылка))
		|	)
		|СГРУППИРОВАТЬ ПО
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	СпрНоменклатура.Ссылка,
		|	АналитикиТоваров.МестоХранения,
		|	ДД.Регистратор,
		|	ДД.ВидЗапасов,
		|	ДД.РазделУчета
		|";
КонецФункции

Функция ТекстБазисПриходыИмпортСебестоимость() // использует АналитикиРасходовВсе
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстБазисПриходыИмпортСебестоимость"" КАК ЗапросИсточник,
		|	90 КАК Приоритет,
		|	""Потребление"" КАК ТипЗаписи,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) КАК ВидДвижения,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	СпрНоменклатура.Ссылка КАК Номенклатура,
		|	АналитикиТоваров.МестоХранения КАК Склад,
		|	ДД.Регистратор,
		|	ДД.ВидЗапасов,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка) КАК АналитикаУчетаПартий,
		|	ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка) КАК НаправлениеДеятельности,
		|	НЕОПРЕДЕЛЕНО КАК Поставщик,
		|	НЕОПРЕДЕЛЕНО КАК ДокументПоступленияРасходов,
		|	НЕОПРЕДЕЛЕНО КАК ВидЦенности,
		|	НЕОПРЕДЕЛЕНО КАК СтавкаНДС,
		|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) КАК СтатьяРасходов,
		|	ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка) КАК Подразделение,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРаспределения,
		|	0 КАК Базис,
		|	СУММА(ДД.Количество) / КОЛИЧЕСТВО(РАЗЛИЧНЫЕ Товары.НомерСтроки) КАК Количество,
		|	СУММА(&Вес * ДД.Количество) / КОЛИЧЕСТВО(РАЗЛИЧНЫЕ Товары.НомерСтроки) КАК Вес,
		|	СУММА(&Объем * ДД.Количество) / КОЛИЧЕСТВО(РАЗЛИЧНЫЕ Товары.НомерСтроки) КАК Объем,
		|	СУММА(ДД.Стоимость) / КОЛИЧЕСТВО(РАЗЛИЧНЫЕ Товары.НомерСтроки) КАК Стоимость,
		|	СУММА(ДД.СтоимостьБезНДС) / КОЛИЧЕСТВО(РАЗЛИЧНЫЕ Товары.НомерСтроки) КАК СтоимостьБезНДС,
		|	СУММА(ДД.СтоимостьРегл) / КОЛИЧЕСТВО(РАЗЛИЧНЫЕ Товары.НомерСтроки) КАК СтоимостьРегл,
		|	0 КАК НДСРегл,
		|	СУММА(ДД.ПостояннаяРазница) / КОЛИЧЕСТВО(РАЗЛИЧНЫЕ Товары.НомерСтроки) КАК ПостояннаяРазница,
		|	СУММА(ДД.ВременнаяРазница) / КОЛИЧЕСТВО(РАЗЛИЧНЫЕ Товары.НомерСтроки) КАК ВременнаяРазница,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка) КАК НалогообложениеПартии,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка) КАК НалогообложениеНДС,
		|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПустаяСсылка) КАК ХозяйственнаяОперация,
		|	ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка) КАК ПодразделениеРасходов,
		|	НЕОПРЕДЕЛЕНО КАК ДокументРеализации,
		|	НЕОПРЕДЕЛЕНО КАК ДокументИсточник,
		|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) КАК СтатьяОтраженияРасходов,
		|	ЗНАЧЕНИЕ(Перечисление.ВариантыРаздельногоУчетаНДС.ПустаяСсылка)	КАК ВариантРаздельногоУчетаНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаОтраженияРасходов,
		|	ЗНАЧЕНИЕ(Перечисление.ПравилаРаспределенияНаСебестоимостьТоваров.ПустаяСсылка) КАК ПравилоРаспределения,
		|	ДД.РазделУчета,
		|	ДД.Период КАК РасчетныйПериод,
		|	ЛОЖЬ КАК РасчетПартий
		|ИЗ
		|	РегистрНакопления.СебестоимостьТоваров КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК АналитикиТоваров
		|		ПО АналитикиТоваров.Ссылка = ДД.АналитикаУчетаНоменклатуры
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Номенклатура КАК СпрНоменклатура
		|		ПО СпрНоменклатура.Ссылка = АналитикиТоваров.Номенклатура
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрНакопления.ТоварыКОформлениюДокументовИмпорта КАК Товары
		|		ПО Товары.Регистратор = ДД.Регистратор
		|		И Товары.АналитикаУчетаНоменклатуры = ДД.АналитикаУчетаНоменклатуры
		|		И Товары.Организация = ДД.Организация
		|		И Товары.ВидЗапасов = ДД.ВидЗапасов
		|		И Товары.Первичное = ИСТИНА
		|		И Товары.ТипДокументаИмпорта = &ТипДокументаИмпорта
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И НЕ ДД.РазделУчета В (
		|		ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПринятыеНаКомиссию),
		|		ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.МатериалыПринятыеВПереработку))
		|	И (ДД.Организация,
		|		АналитикиТоваров.Номенклатура,
		|		АналитикиТоваров.МестоХранения,
		|		ЕСТЬNULL(АналитикиТоваров.Назначение.НаправлениеДеятельности,
		|			ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)),
		|		ДД.Регистратор) В
		|	(
		|		ВЫБРАТЬ РАЗЛИЧНЫЕ
		|			КлючиРасходов.Организация,
		|			АналитикиТоваров.Номенклатура,
		|			АналитикиТоваров.МестоХранения,
		|			КлючиРасходов.НаправлениеДеятельности,
		|			ДД.Регистратор
		|		ИЗ
		|			АналитикиРасходовВсе КАК КлючиРасходов
		|		ГДЕ 
		|			КлючиРасходов.АналитикаРасходов В (
		|				АналитикиТоваров.Номенклатура,
		|				ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка),
		|				АналитикиТоваров.МестоХранения,
		|				ЗНАЧЕНИЕ(Справочник.Склады.ПустаяСсылка),
		|				ДД.Регистратор)
		|			ИЛИ
		|			ТИПЗНАЧЕНИЯ(ДД.Регистратор) = ТИПЗНАЧЕНИЯ(КлючиРасходов.АналитикаРасходов)
		|			И КлючиРасходов.АналитикаРасходов В (
		|				ЗНАЧЕНИЕ(Документ.ПриобретениеТоваровУслуг.ПустаяСсылка),
		|				ЗНАЧЕНИЕ(Документ.ПередачаТоваровМеждуОрганизациями.ПустаяСсылка))
		|	)
		|СГРУППИРОВАТЬ ПО
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	СпрНоменклатура.Ссылка,
		|	АналитикиТоваров.МестоХранения,
		|	ДД.Регистратор,
		|	ДД.ВидЗапасов,
		|	ДД.РазделУчета
		|";
КонецФункции

Функция ТекстБазисПеремещенияСебестоимость() // использует АналитикиРасходовВсе
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстБазисПеремещенияСебестоимость"" КАК ЗапросИсточник,
		|	90 КАК Приоритет,
		|	""Потребление"" КАК ТипЗаписи,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) КАК ВидДвижения,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	СпрНоменклатура.Ссылка КАК Номенклатура,
		|	НЕОПРЕДЕЛЕНО КАК Склад,
		|	ДД.Регистратор,
		|	ДД.ВидЗапасов,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка) КАК АналитикаУчетаПартий,
		|	ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка) КАК НаправлениеДеятельности,
		|	НЕОПРЕДЕЛЕНО КАК Поставщик,
		|	НЕОПРЕДЕЛЕНО КАК ДокументПоступленияРасходов,
		|	НЕОПРЕДЕЛЕНО КАК ВидЦенности,
		|	НЕОПРЕДЕЛЕНО КАК СтавкаНДС,
		|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) КАК СтатьяРасходов,
		|	ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка) КАК Подразделение,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРаспределения,
		|	0 КАК Базис,
		|	ДД.Количество,
		|	&Вес * ДД.Количество КАК Вес,
		|	&Объем * ДД.Количество КАК Объем,
		|	ДД.Стоимость,
		|	ДД.СтоимостьБезНДС,
		|	ДД.СтоимостьРегл,
		|	0,
		|	ДД.ПостояннаяРазница,
		|	ДД.ВременнаяРазница,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка) КАК НалогообложениеПартии,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка) КАК НалогообложениеНДС,
		|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПустаяСсылка) КАК ХозяйственнаяОперация,
		|	ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка) КАК ПодразделениеРасходов,
		|	НЕОПРЕДЕЛЕНО КАК ДокументРеализации,
		|	НЕОПРЕДЕЛЕНО КАК ДокументИсточник,
		|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) КАК СтатьяОтраженияРасходов,
		|	ЗНАЧЕНИЕ(Перечисление.ВариантыРаздельногоУчетаНДС.ПустаяСсылка)	КАК ВариантРаздельногоУчетаНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаОтраженияРасходов,
		|	ЗНАЧЕНИЕ(Перечисление.ПравилаРаспределенияНаСебестоимостьТоваров.ПустаяСсылка) КАК ПравилоРаспределения,
		|	ДД.РазделУчета,
		|	ДД.Период КАК РасчетныйПериод,
		|	ЛОЖЬ КАК РасчетПартий
		|ИЗ
		|	РегистрНакопления.СебестоимостьТоваров КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК АналитикиТоваров
		|		ПО АналитикиТоваров.Ссылка = ДД.АналитикаУчетаНоменклатуры
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Номенклатура КАК СпрНоменклатура
		|		ПО СпрНоменклатура.Ссылка = АналитикиТоваров.Номенклатура
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|	И ТИПЗНАЧЕНИЯ(ДД.Регистратор) = ТИП(Документ.ПеремещениеТоваров)
		|	И НЕ ДД.РазделУчета В (
		|		ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПринятыеНаКомиссию),
		|		ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.МатериалыПринятыеВПереработку))
		|	И (ДД.Организация,
		|		ЕСТЬNULL(АналитикиТоваров.Назначение.НаправлениеДеятельности,
		|			ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)),
		|		ДД.Регистратор) В
		|	(
		|		ВЫБРАТЬ РАЗЛИЧНЫЕ
		|			КлючиРасходов.Организация,
		|			КлючиРасходов.НаправлениеДеятельности,
		|			ДД.Регистратор
		|		ИЗ
		|			АналитикиРасходовВсе КАК КлючиРасходов
		|		ГДЕ 
		|			КлючиРасходов.АналитикаРасходов В (
		|				ДД.Регистратор,
		|				ЗНАЧЕНИЕ(Документ.ПеремещениеТоваров.ПустаяСсылка))
		|	)
		|";
КонецФункции

Функция ТекстБазисПрошлыеПриходыТоваровСебестоимость() // использует АналитикиРасходовВсе
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстБазисПрошлыеПриходыТоваровСебестоимость"" КАК ЗапросИсточник,
		|	90 КАК Приоритет,
		|	""Потребление"" КАК ТипЗаписи,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) КАК ВидДвижения,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	СпрНоменклатура.Ссылка КАК Номенклатура,
		|	АналитикиТоваров.МестоХранения КАК Склад,
		|	ДД.Регистратор,
		|	ДД.ВидЗапасов,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка) КАК АналитикаУчетаПартий,
		|	ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка) КАК НаправлениеДеятельности,
		|	НЕОПРЕДЕЛЕНО КАК Поставщик,
		|	НЕОПРЕДЕЛЕНО КАК ДокументПоступленияРасходов,
		|	НЕОПРЕДЕЛЕНО КАК ВидЦенности,
		|	НЕОПРЕДЕЛЕНО КАК СтавкаНДС,
		|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) КАК СтатьяРасходов,
		|	ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка) КАК Подразделение,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРаспределения,
		|	0 КАК Базис,
		|	СУММА(ДД.Количество) КАК Количество,
		|	СУММА(&Вес * ДД.Количество) КАК Вес,
		|	СУММА(&Объем * ДД.Количество) КАК Объем,
		|	СУММА(ДД.Стоимость) КАК Стоимость,
		|	СУММА(ДД.СтоимостьБезНДС) КАК СтоимостьБезНДС,
		|	СУММА(ДД.СтоимостьРегл) КАК СтоимостьРегл,
		|	0 КАК НДСРегл,
		|	СУММА(ДД.ПостояннаяРазница) КАК ПостояннаяРазница,
		|	СУММА(ДД.ВременнаяРазница) КАК ВременнаяРазница,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка) КАК НалогообложениеПартии,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка) КАК НалогообложениеНДС,
		|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПустаяСсылка) КАК ХозяйственнаяОперация,
		|	ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка) КАК ПодразделениеРасходов,
		|	НЕОПРЕДЕЛЕНО КАК ДокументРеализации,
		|	НЕОПРЕДЕЛЕНО КАК ДокументИсточник,
		|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) КАК СтатьяОтраженияРасходов,
		|	ЗНАЧЕНИЕ(Перечисление.ВариантыРаздельногоУчетаНДС.ПустаяСсылка)	КАК ВариантРаздельногоУчетаНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаОтраженияРасходов,
		|	ЗНАЧЕНИЕ(Перечисление.ПравилаРаспределенияНаСебестоимостьТоваров.ПустаяСсылка) КАК ПравилоРаспределения,
		|	ДД.РазделУчета,
		|	ДД.Период КАК РасчетныйПериод,
		|	ЛОЖЬ КАК РасчетПартий
		|ИЗ
		|	РегистрНакопления.СебестоимостьТоваров КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрНакопления.СебестоимостьТоваров.Остатки(&НачалоПериода) КАК Остатки
		|		ПО Остатки.АналитикаУчетаНоменклатуры = ДД.АналитикаУчетаНоменклатуры
		|		И Остатки.РазделУчета = ДД.РазделУчета
		|		И Остатки.ВидЗапасов = ДД.ВидЗапасов
		|		И Остатки.Организация = ДД.Организация
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК АналитикиТоваров
		|		ПО АналитикиТоваров.Ссылка = ДД.АналитикаУчетаНоменклатуры
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Номенклатура КАК СпрНоменклатура
		|		ПО СпрНоменклатура.Ссылка = АналитикиТоваров.Номенклатура
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Склады КАК Склады
		|		ПО АналитикиТоваров.МестоХранения = Склады.Ссылка
		|ГДЕ
		|	ДД.Период < &НачалоПериода
		|	И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И НЕ ДД.РазделУчета В (
		|		ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПринятыеНаКомиссию),
		|		ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.МатериалыПринятыеВПереработку))
		|	И (ДД.Организация,
		|		АналитикиТоваров.Номенклатура,
		|		АналитикиТоваров.МестоХранения,
		|		ЕСТЬNULL(АналитикиТоваров.Назначение.НаправлениеДеятельности,
		|			ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)),
		|		ДД.Регистратор) В
		|	(
		|		ВЫБРАТЬ РАЗЛИЧНЫЕ
		|			КлючиРасходов.Организация,
		|			АналитикиТоваров.Номенклатура,
		|			АналитикиТоваров.МестоХранения,
		|			КлючиРасходов.НаправлениеДеятельности,
		|			ДД.Регистратор
		|		ИЗ
		|			АналитикиРасходовВсе КАК КлючиРасходов
		|			ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.СебестоимостьТоваров КАК Поступление
		|				ПО Поступление.Регистратор = КлючиРасходов.АналитикаРасходов
		|		ГДЕ 
		|			КлючиРасходов.АналитикаРасходов = ДД.Регистратор
		|			И Поступление.Период < &НачалоПериода
		|	)
		|СГРУППИРОВАТЬ ПО
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	СпрНоменклатура.Ссылка,
		|	АналитикиТоваров.МестоХранения,
		|	ДД.Регистратор,
		|	ДД.ВидЗапасов,
		|	ДД.РазделУчета
		|";
КонецФункции

#КонецОбласти


#Область РасчетЗаписейНоменклатураДоходыРасходы

// В партионном учете версии 2.2 - этап 11, РаспределениеДопРасходовМеждуПартиямиИТоварами.

Функция ДанныеДляНоменклатураДоходыРасходы(НачалоПериода, ОкончаниеПериода, МассивОрганизаций)
	ТекстСортировка = "";
	ИсходныйТекстЗапроса = 
		ТекстРегистраторыДляНоменклатураДоходыРасходы() + ";" + // вт Регистраторы
		ТекстОписаниеДанныхДляНоменклатураДоходыРасходы()
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстНоменклатураДоходыРасходыИзСебестоимости() // использует Регистраторы
		+ ТекстСортировка;
	ИсходныйЗапрос = Новый Запрос(ИсходныйТекстЗапроса);
	ИсходныйЗапрос.УстановитьПараметр("НачалоПериода", НачалоПериода);
	ИсходныйЗапрос.УстановитьПараметр("ОкончаниеПериода", ОкончаниеПериода);
	ИсходныйЗапрос.УстановитьПараметр("МассивОрганизаций", МассивОрганизаций);	
	ДанныеДляРасчета = ИсходныйЗапрос.Выполнить().Выгрузить();
	ДанныеДляРасчета.Сортировать("Регистратор", Новый СравнениеЗначений);
	
	Возврат ДанныеДляРасчета;
КонецФункции

Функция ТекстРегистраторыДляНоменклатураДоходыРасходы() // вт Регистраторы
	Возврат "
		|ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	ДД.Регистратор
		|ПОМЕСТИТЬ
		|	Регистраторы
		|ИЗ
		|	РегистрНакопления.ПартииПрочихРасходов КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрНакопления.СебестоимостьТоваров КАК Партии
		|		ПО Партии.Период = ДД.Период
		|		И Партии.Регистратор = ДД.Регистратор
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		|	И Партии.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|ИНДЕКСИРОВАТЬ ПО
		|	ДД.Регистратор
		|";
	
КонецФункции

Функция ТекстОписаниеДанныхДляНоменклатураДоходыРасходы()
	Возврат "
		|ВЫБРАТЬ ПЕРВЫЕ 0
		|	0 КАК Приоритет,
		|	""ХХХХХХХХХХХХХХХХ"" КАК ТипЗаписи,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ДАТАВРЕМЯ(1, 1, 1, 0, 0, 0) КАК Период,
		|	НЕОПРЕДЕЛЕНО КАК Регистратор,
		|
		|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПустаяСсылка) КАК ХозяйственнаяОперация,
		|	ЗНАЧЕНИЕ(Справочник.Организации.ПустаяСсылка) КАК Организация,
		|	ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка) КАК Подразделение,
		|
		|	ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)		  КАК НаправлениеДеятельностиНоменклатуры,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КАК АналитикаУчетаНоменклатуры,
		|	ЗНАЧЕНИЕ(Справочник.Склады.ПустаяСсылка) КАК Склад,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.ПустаяСсылка) КАК ТипЗапасов,
		|	ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка) КАК ВидЗапасов,
		|
		|	НЕОПРЕДЕЛЕНО КАК СтатьяДоходовРасходов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаДоходов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
		|
		|	0 КАК Количество,
		|	0 КАК Стоимость,
		|	0 КАК СтоимостьБезНДС,
		|	0 КАК СтоимостьРегл,
		|
		|	НЕОПРЕДЕЛЕНО КАК ИсточникГФУНоменклатуры,
		|	НЕОПРЕДЕЛЕНО КАК ДокументДвижения
		|";
КонецФункции

Функция ТекстНоменклатураДоходыРасходыИзСебестоимости() // использует Регистраторы
	Возврат "
		|ВЫБРАТЬ
		|	90 КАК Приоритет,
		|	""Партия"" КАК ТипЗаписи,
		|	ИСТИНА КАК РасчетЗавершен,
		|	ДД.Период,
		|	ДД.Регистратор,
		|
		|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РаспределениеРасходовНаСебестоимость),
		|	ДД.Организация,
		|	ДД.Подразделение,
		|
		|	Аналитика.Назначение.НаправлениеДеятельности,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	Аналитика.МестоХранения КАК Склад,
		|	ЕСТЬNULL(СпрВидыЗапасов.ТипЗапасов, ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.Товар)) КАК ТипЗапасов,
		|	ДД.ВидЗапасов,
		|
		|	ДД.СтатьяРасходовСписания КАК СтатьяДоходовРасходов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаДоходов,
		|	ДД.АналитикаРасходов КАК АналитикаРасходов,
		|
		|	0 КАК Количество,
		|	СУММА(ДД.ДопРасходы) КАК Стоимость,
		|	СУММА(ДД.ДопРасходыБезНДС) КАК СтоимостьБезНДС,
		|	СУММА(ДД.СтоимостьРегл) КАК СтоимостьРегл,
		|
		|	ДД.ВидЗапасов КАК ИсточникГФУНоменклатуры,
		|	ДД.Регистратор КАК ДокументДвижения
		|
		|ИЗ
		|	РегистрНакопления.СебестоимостьТоваров КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Регистраторы КАК Регистраторы
		|		ПО Регистраторы.Регистратор = ДД.Регистратор
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК Аналитика
		|		ПО Аналитика.Ссылка = ДД.АналитикаУчетаНоменклатуры
		|	ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ВидыЗапасов КАК СпрВидыЗапасов
		|		ПО СпрВидыЗапасов.Ссылка = ДД.ВидЗапасов
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И (ДД.ДопРасходы <> 0 ИЛИ ДД.ДопРасходы <> 0)
		|	И ДД.Количество = 0
		|	И НЕ ДД.ХозяйственнаяОперация В
		|			(ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПустаяСсылка),
		|			 ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ОформлениеГТДБрокером),
		|			 ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ОформлениеГТДСамостоятельно),
		|			 ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ДополнительныеРасходыБезПартии),
		|			 ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ДополнительныеРасходыСПартией))
		|
		|СГРУППИРОВАТЬ ПО
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.ХозяйственнаяОперация,
		|	ДД.Организация,
		|	ДД.Подразделение,
		|	Аналитика.Назначение.НаправлениеДеятельности,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	Аналитика.МестоХранения,
		|	ЕСТЬNULL(СпрВидыЗапасов.ТипЗапасов, ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.Товар)),
		|	ДД.ВидЗапасов,
		|	ДД.СтатьяРасходовСписания,
		|	ДД.АналитикаРасходов
		|";
КонецФункции

#КонецОбласти


#Область РасчетПартийРасходов

Функция ДанныеДляПартийРасходов(НачалоПериода, ОкончаниеПериода, МассивОрганизаций)
	ТекстСортировка = "
		|УПОРЯДОЧИТЬ ПО
		|	ДокументПоступления, Период, Регистратор, Приоритет УБЫВ,
		|	КорАналитикаУчетаНоменклатуры, КорВидЗапасов, АналитикаУчетаНоменклатуры, ВидЗапасов,
		|	ДокументИсточник, ПодразделениеРасходов, СтатьяРасходовСписания, АналитикаРасходов, АналитикаАктивовПассивов
		|";
	ТекстИндексы = "
		|ИНДЕКСИРОВАТЬ ПО
		|	ДокументПоступления
		|";
	// Выбираем приходные движения партий расходов и дальнейшие движения партий товаров
	ИсходныйТекстЗапроса =
		ТекстПартииРасходовИнициализация() + ";" + // вт ПрошлыеРеализации, Отработано, Аналитики, ОстаткиПартий, ДолиСтоимости, ПрошлыеПоступления
		ТекстОписаниеПартийРасходов()
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстОстаткиПартийРасходов() // использует ОстаткиПартий, ПрошлыеПоступления
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстПриходыПартийРасходов()
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстДополненияПартийРасходов()
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстРасходыПартийРасходовПрошлыхМесяцев() // использует ПрошлыеРеализации
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстИтерацияПартийТоваров()
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстИтерацияПартийПереданных()
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстПартииРасходовВПути()
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстИтерацияПартийПроизводства()
		//++ НЕ УТ
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстИтерацияПартийПродукции()
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстИтерацияПартийВыпуска()
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстИтерацияОтчетПереработчика()
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстИтерацияОтчетПереработчикаРаспределение()
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстПриходыДопРасходовПроизводственныхЗатрат() // использует ДолиСтоимости
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстПриходыДопРасходовПроизводственныхЗатратПрочее() // использует ДолиСтоимости
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстРаспределениеДопРасходовПроизводственныхЗатрат()
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстВыпускИзДопРасходовПроизводственныхЗатрат()
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстДопРасходыПроизводственныхЗатратПрочее()
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстДопРасходыПроизводственныхЗатратСписание()
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстДопРасходыСписаниеВПроизводстве()
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстИтерацияВозвратИзПроизводстваИЛИОтПереработчика()
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстИтерацияВозвратИзПроизводстваИЛИОтПереработчикаНаСклад()
		//-- НЕ УТ

		//++ НЕ УТКА
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстИтерацияОтчетДавальцу()
		//-- НЕ УТКА
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстИтерацияПартийРаботИПеремещенияВПроизводстве()
		+ ТекстИндексы;
	МВТ = Новый МенеджерВременныхТаблиц;	
	ИсходныйЗапрос = Новый Запрос(СтрЗаменить(ИсходныйТекстЗапроса, "//ВоВременнуюТаблицу", ""));
	ИсходныйЗапрос.УстановитьПараметр("НачалоПериода", НачалоПериода);
	ИсходныйЗапрос.УстановитьПараметр("ОкончаниеПериода", ОкончаниеПериода);	
	ИсходныйЗапрос.УстановитьПараметр("МассивОрганизаций", МассивОрганизаций);	
	ИсходныйЗапрос.УстановитьПараметр("ЕстьФИФОСкользящая", ЕстьФИФОСкользящая(НачалоПериода, ОкончаниеПериода, МассивОрганизаций));
	ИсходныйЗапрос.МенеджерВременныхТаблиц = МВТ;
	ИсходныйЗапрос.Выполнить();
	
	Запрос = Новый Запрос(ТекстОписаниеПартийРасходов());
	РасчетныеПартии = Запрос.Выполнить().Выгрузить();
	
	ВременнаяТаблицаДанныхПоОтбору("ДокументПоступления", ТекстСортировка, РасчетныеПартии, МВТ);
	
	Возврат МВТ;
КонецФункции

Функция РасчетныеПартииРасходов(ДанныеДляРасчета, Регистраторы, ЦепочкиДвижений = Неопределено, Тест = Ложь, РассчитатьПартии = Истина)
	// Шаг 1: создаем буфер накопления рассчитанных партий
	Запрос = Новый Запрос(ТекстОписаниеПартийРасходов());
	РасчетныеПартии = Запрос.Выполнить().Выгрузить();
	
	// Шаг 2: обсчитываем цепочки движений по передачам, возвратам, перемещениям, порчам, пересортицам и т.д.
	КонтекстЦепочек = ОписаниеЦепочек("Потребление, Перемещение, Партия, Остаток, Сторно, Прошлое, Замещение,
		|Продукция, Выпуск, Затраты, Распределение, ВыпускПрочие, ВПути, Дополнение, Прочее, Списание, ПотреблениеВПути");
	
	ПоляПотреблений = "РазделУчета, АналитикаУчетаНоменклатуры, ВидЗапасов, Организация, ДокументПоступления, ДокументИсточник";
	ДобавитьОписаниеПриемника(КонтекстЦепочек, "Потребление", ПоляПотреблений);
	ДобавитьОписаниеИсточника(КонтекстЦепочек, "Потребление", "Партия", ПоляПотреблений);
	ДобавитьОписаниеИсточника(КонтекстЦепочек, "Потребление", "Остаток", ПоляПотреблений);
	ДобавитьОписаниеИсточника(КонтекстЦепочек, "Потребление", "Перемещение", ПоляПотреблений);
	ДобавитьОписаниеИсточника(КонтекстЦепочек, "Потребление", "Замещение", ПоляПотреблений);
	ДобавитьОписаниеИсточника(КонтекстЦепочек, "Потребление", "Выпуск", ПоляПотреблений);
	ДобавитьОписаниеИсточника(КонтекстЦепочек, "Потребление", "ВыпускПрочие",
		"РазделУчета, АналитикаУчетаНоменклатуры, ВидЗапасов, Организация, ДокументПоступления, Регистратор");
	ДобавитьОписаниеИсточника(КонтекстЦепочек, "Потребление", "Сторно",
		"РазделУчета, АналитикаУчетаНоменклатуры, ВидЗапасов, Организация, ДокументПоступления, Регистратор");
	
	ДобавитьОписаниеПриемника(КонтекстЦепочек, "ПотреблениеВПути", "РазделУчета, АналитикаУчетаНоменклатуры, ВидЗапасов, Организация, ДокументПоступления, Регистратор");
	ДобавитьОписаниеИсточника(КонтекстЦепочек, "ПотреблениеВПути", "Перемещение", "РазделУчета, АналитикаУчетаНоменклатуры, ВидЗапасов, Организация, ДокументПоступления, Регистратор");
	ДобавитьОписаниеИсточника(КонтекстЦепочек, "ПотреблениеВПути", "Остаток", ПоляПотреблений);
	
	ДобавитьОписаниеПриемника(КонтекстЦепочек, "Перемещение",
		"Регистратор, АналитикаУчетаНоменклатуры, ВидЗапасов, ДокументПоступления");
	ДобавитьОписаниеИсточника(КонтекстЦепочек, "Перемещение", "Потребление",
		"Регистратор, КорАналитикаУчетаНоменклатуры, КорВидЗапасов, ДокументПоступления");
	ДобавитьОписаниеИсточника(КонтекстЦепочек, "Перемещение", "Продукция",
		"Регистратор, АналитикаУчетаНоменклатуры, ВидЗапасов, ДокументПоступления");	
	
	ДобавитьОписаниеПриемника(КонтекстЦепочек, "Замещение",
		"Регистратор, АналитикаУчетаНоменклатуры, ВидЗапасов");
	ДобавитьОписаниеИсточника(КонтекстЦепочек, "Замещение", "Потребление",
		"Регистратор, КорАналитикаУчетаНоменклатуры, КорВидЗапасов");
		
	ДобавитьОписаниеПриемника(КонтекстЦепочек, "Продукция", "ДокументИсточник, РазделУчета, АналитикаУчетаНоменклатуры, ДокументПоступления, ВидЗапасов");
	ДобавитьОписаниеИсточника(КонтекстЦепочек, "Продукция", "Перемещение", "ДокументИсточник, РазделУчета, АналитикаУчетаНоменклатуры, ДокументПоступления, ВидЗапасов");
	ДобавитьОписаниеИсточника(КонтекстЦепочек, "Продукция", "Выпуск", "ДокументИсточник, РазделУчета, АналитикаУчетаНоменклатуры, ДокументПоступления, ВидЗапасов");
	ДобавитьОписаниеИсточника(КонтекстЦепочек, "Продукция", "ВыпускПрочие", "Регистратор, РазделУчета, АналитикаУчетаНоменклатуры, ДокументПоступления, ВидЗапасов");
	ДобавитьОписаниеИсточника(КонтекстЦепочек, "Продукция", "Партия", "ДокументИсточник, РазделУчета, АналитикаУчетаНоменклатуры, ДокументПоступления, ВидЗапасов");
	ДобавитьОписаниеИсточника(КонтекстЦепочек, "Продукция", "Остаток", "ДокументИсточник, РазделУчета, АналитикаУчетаНоменклатуры, ДокументПоступления, ВидЗапасов");
		
	ДобавитьОписаниеПриемника(КонтекстЦепочек, "Выпуск", "Регистратор, АналитикаУчетаНоменклатуры, ВидЗапасов, КорАналитикаУчетаНоменклатуры, КорВидЗапасов");
	ДобавитьОписаниеИсточника(КонтекстЦепочек, "Выпуск", "Продукция", "Регистратор, КорАналитикаУчетаНоменклатуры, КорВидЗапасов, АналитикаУчетаНоменклатуры, ВидЗапасов");
	
	ДобавитьОписаниеПриемника(КонтекстЦепочек, "Сторно",
		"ДокументИсточник, КорАналитикаУчетаНоменклатуры, КорВидЗапасов, ДокументПоступления");
	ДобавитьОписаниеИсточника(КонтекстЦепочек, "Сторно", "Потребление",
		"Регистратор, АналитикаУчетаНоменклатуры, ВидЗапасов, ДокументПоступления");
	ДобавитьОписаниеИсточника(КонтекстЦепочек, "Сторно", "ПотреблениеВПути",
		"Регистратор, КорАналитикаУчетаНоменклатуры, ВидЗапасов, ДокументПоступления");
	ДобавитьОписаниеИсточника(КонтекстЦепочек, "Сторно", "Прошлое",
		"Регистратор, АналитикаУчетаНоменклатуры, ВидЗапасов, ДокументПоступления");
	ДобавитьОписаниеИсточника(КонтекстЦепочек, "Сторно", "Перемещение",
		"Регистратор, АналитикаУчетаНоменклатуры, ВидЗапасов, ДокументПоступления");
	ДобавитьОписаниеИсточника(КонтекстЦепочек, "Сторно", "Сторно",
		"Регистратор, АналитикаУчетаНоменклатуры, ВидЗапасов, ДокументПоступления");
		
	ДобавитьОписаниеПриемника(КонтекстЦепочек, "Затраты", "Организация, АналитикаУчетаНоменклатуры, СтатьяРасходовСписания, АналитикаРасходов, ПодразделениеРасходов");
	ДобавитьОписаниеИсточника(КонтекстЦепочек, "Затраты", "Потребление", "Организация, АналитикаУчетаНоменклатуры, СтатьяРасходовСписания, АналитикаРасходов, ПодразделениеРасходов");
		
	ДобавитьОписаниеПриемника(КонтекстЦепочек, "Распределение", "Организация, СтатьяРасходовСписания, АналитикаРасходов, ПодразделениеРасходов");
	ДобавитьОписаниеИсточника(КонтекстЦепочек, "Распределение", "Затраты", "Организация, СтатьяРасходовСписания, АналитикаРасходов, ПодразделениеРасходов");
	
	ДобавитьОписаниеПриемника(КонтекстЦепочек, "Прочее", "Организация, СтатьяРасходов, АналитикаРасходов, ПодразделениеРасходов");
	ДобавитьОписаниеИсточника(КонтекстЦепочек, "Прочее", "Затраты", "Организация, СтатьяРасходовСписания, АналитикаРасходов, ПодразделениеРасходов");
	
	ДобавитьОписаниеПриемника(КонтекстЦепочек, "Списание", "Регистратор");
	ДобавитьОписаниеИсточника(КонтекстЦепочек, "Списание", "Прочее", "Регистратор");
	
	ДобавитьОписаниеПриемника(КонтекстЦепочек, "ВыпускПрочие",
		"Регистратор, ДокументИсточник, АналитикаУчетаНоменклатуры, ВидЗапасов, СтатьяРасходовСписания, АналитикаРасходов, ПодразделениеРасходов");
	ДобавитьОписаниеИсточника(КонтекстЦепочек, "ВыпускПрочие", "Распределение",
		"Регистратор, ДокументИсточник, КорАналитикаУчетаНоменклатуры, КорВидЗапасов, СтатьяРасходовСписания, АналитикаРасходов, ПодразделениеРасходов");
		
	// Шаг 3: замена ложных партий на первичные партии в расчетных строках по результатам построение графа замен.
	КонтекстДвижений = ОписаниеДвижений(
		"ПартииРасходовНаСебестоимостьТоваров",
		"ПартииРасходовНаСебестоимостьТоваров",
		ПереченьПолей(РасчетныеПартии.Колонки),
		ПоляПотреблений,
		"Количество, Знаменатель, Стоимость, СтоимостьБезНДС, СтоимостьРегл, НДСРегл, ПостояннаяРазница, ВременнаяРазница",
		"Количество", "Количество", "ДокументИсточник", "Период");
	КонтекстДвижений.Вставить("ПоляСуммирования", "Стоимость, СтоимостьБезНДС, СтоимостьРегл, НДСРегл, ПостояннаяРазница, ВременнаяРазница");
	КонтекстДвижений.Вставить("ПоляГруппировки", ПереченьПолей(РасчетныеПартии.Колонки, КонтекстДвижений.ПоляСуммирования));
	ЦепочкиДвижений(КонтекстЦепочек, ДанныеДляРасчета);
	Если РассчитатьПартии Тогда
		РассчитатьПартииПоЦепочкам(КонтекстДвижений, ДанныеДляРасчета, РасчетныеПартии, Регистраторы, Тест);
	КонецЕсли;
	ЦепочкиДвижений = ДанныеДляРасчета;
	
	// Шаг 4: Удаляем нерассчитанные партии
	УдалитьНезаписываемыеСтроки(КонтекстДвижений.Контекст, РасчетныеПартии);
	
	Возврат РасчетныеПартии;
КонецФункции

Функция ТекстПартииРасходовИнициализация() // вт ПрошлыеРеализации, ОстаткиПартий, ПроизводственныеЗатраты, ПрошлыеРегистраторы, Выпуски, ДолиСтоимости, ПрошлыеПоступления
	Возврат "
		|ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	ДД.ДокументРеализации КАК ДокументРеализации,
		|	ДД.КорАналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
		|	ДД.КорВидЗапасов КАК ВидЗапасов
		|ПОМЕСТИТЬ
		|	ПрошлыеРеализации
		|ИЗ
		|	РегистрНакопления.ТоварыОрганизаций КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрНакопления.ТоварыОрганизаций КАК Расход
		|		ПО Расход.Период < &НачалоПериода
		|		И Расход.Регистратор = ДД.ДокументРеализации
		|		И Расход.АналитикаУчетаНоменклатуры = ДД.КорАналитикаУчетаНоменклатуры
		|		И Расход.ВидЗапасов = ДД.КорВидЗапасов
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И ДД.ДокументРеализации <> НЕОПРЕДЕЛЕНО
		|	И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		|	И ДД.Количество < 0
		|	
		|ОБЪЕДИНИТЬ ВСЕ
		|ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	ДД.ДокументРеализации КАК ДокументРеализации,
		|	ДД.КорАналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
		|	ДД.КорВидЗапасов КАК ВидЗапасов
		|ИЗ
		|	РегистрНакопления.ТоварыОрганизаций КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрНакопления.ТоварыОрганизацийКПередаче КАК Расход
		|		ПО Расход.Период < &НачалоПериода
		|		И Расход.Регистратор = ДД.ДокументРеализации
		|		И Расход.АналитикаУчетаНоменклатуры = ДД.КорАналитикаУчетаНоменклатуры
		|		И Расход.ВидЗапасовПродавца = ДД.КорВидЗапасов
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Активность
		|	И ДД.ДокументРеализации <> НЕОПРЕДЕЛЕНО
		|	И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		|	И ДД.Количество < 0
		|;
		// Потенциальные источники, потребления которых надо списывать из знаменателя
		|ВЫБРАТЬ
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ДокументПоступления,
		|	ДД.ВидЗапасов,
		|	ДД.АналитикаУчетаПартий,
		|	СУММА(ДД.Количество) КАК Знаменатель
		|ПОМЕСТИТЬ
		|	Знаменатели
		|ИЗ
		|	РегистрНакопления.ПартииТоваровОрганизаций КАК ДД
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И ДД.ДокументИсточник <> НЕОПРЕДЕЛЕНО
		|	И НЕ ДД.Первичное
		|	И (ДД.Регистратор ССЫЛКА Документ.ВозвратТоваровОтКлиента
		|		ИЛИ ДД.Регистратор ССЫЛКА Документ.ПрочееОприходованиеТоваров
		//++ НЕ УТ
		|		ИЛИ ДД.Регистратор ССЫЛКА Документ.ВозвратМатериаловИзПроизводства
		//-- НЕ УТ
		|		ИЛИ ДД.Регистратор ССЫЛКА Документ.КорректировкаРеализации)
		|СГРУППИРОВАТЬ ПО
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ДокументПоступления,
		|	ДД.ВидЗапасов,
		|	ДД.АналитикаУчетаПартий
		|;
		// Остатки партионных регистров на начало по аналитикам доп.расходов
		|ВЫБРАТЬ
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ДокументПоступления,
		|	ДД.ВидЗапасов,
		|	СУММА(ДД.Количество) КАК Количество
		|ПОМЕСТИТЬ
		|	ОстаткиПартий
		|ИЗ (
		|	ВЫБРАТЬ
		|		ДД.Организация,
		|		ДД.АналитикаУчетаНоменклатуры,
		|		ДД.ДокументПоступления,
		|		ДД.ВидЗапасов,
		|		ДД.КоличествоОстаток КАК Количество
		|	ИЗ
		|		РегистрНакопления.ПартииТоваровОрганизаций.Остатки(&НачалоПериода, Организация В (&МассивОрганизаций)) КАК ДД
		|
		|	ОБЪЕДИНИТЬ ВСЕ
		|	ВЫБРАТЬ
		|		ДД.Организация,
		|		ДД.АналитикаУчетаНоменклатуры,
		|		ДД.ДокументПоступления,
		|		ДД.ВидЗапасов,
		|		ДД.КоличествоОстаток КАК Количество
		|	ИЗ
		|		РегистрНакопления.ПартииТоваровПереданныеНаКомиссию.Остатки(&НачалоПериода, Организация В (&МассивОрганизаций)) КАК ДД
		|
		|	ОБЪЕДИНИТЬ ВСЕ
		|	ВЫБРАТЬ
		|		ДД.Организация,
		|		ДД.АналитикаУчетаНоменклатуры,
		|		ДД.ДокументПоступления,
		|		ДД.ВидЗапасов,
		|		ДД.КоличествоОстаток КАК Количество
		|	ИЗ
		|		РегистрНакопления.ПартииПроизводственныхЗатрат.Остатки(&НачалоПериода, Организация В (&МассивОрганизаций)) КАК ДД
		|
		//++ НЕ УТ
		|	ОБЪЕДИНИТЬ ВСЕ
		|	ВЫБРАТЬ
		|		ДД.Организация,
		|		ДД.АналитикаУчетаНоменклатуры,
		|		ДД.ДокументПоступления,
		|		ДД.ВидЗапасов,
		|		ДД.КоличествоОстаток КАК Количество
		|	ИЗ
		|		РегистрНакопления.ПартииНезавершенногоПроизводства.Остатки(&НачалоПериода, Организация В (&МассивОрганизаций)) КАК ДД
		//-- НЕ УТ
		|	) КАК ДД
		|СГРУППИРОВАТЬ ПО
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ДокументПоступления,
		|	ДД.ВидЗапасов
		|;
		// Документы передачи в производство и возврата из производства
		|ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	ДД.Регистратор КАК Регистратор
		|ПОМЕСТИТЬ
		|	МатериалыИРаботыВПроизводстве
		|ИЗ
		|	РегистрНакопления.МатериалыИРаботыВПроизводстве КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Номенклатура КАК Товары
		|		ПО Товары.Ссылка = ДД.АналитикаУчетаНоменклатуры.Номенклатура
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И Товары.ТипНоменклатуры <> ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.Работа)
		|;
		// Документы распределения расходов, возникших в прошлых периодах
		|ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	ДД.ДокументПоступленияРасходов КАК Ссылка
		|ПОМЕСТИТЬ
		|	ПрошлыеРегистраторы
		|ИЗ
		|	РегистрНакопления.ПартииРасходовНаСебестоимостьТоваров.Остатки(&НачалоПериода, Организация В (&МассивОрганизаций)) КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрНакопления.ПартииРасходовНаСебестоимостьТоваров КАК Партии
		|		ПО Партии.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|		И Партии.Регистратор = ДД.ДокументПоступленияРасходов
		|		И Партии.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|СГРУППИРОВАТЬ ПО
		|	ДД.ДокументПоступленияРасходов
		//++ НЕ УТ
		|;
		// Доли распределения производственных затрат
		|ВЫБРАТЬ
		|	ДД.Организация,
		|	ДД.СтатьяРасходов,
		|	ДД.АналитикаРасходов,
		|	ДД.НаправлениеДеятельности,
		|	ДД.Подразделение КАК ПодразделениеРасходов,
		|	ДД.Дата КАК Период,
		|	ДД.Ссылка КАК Регистратор,
		|	ВЫБОР 
		|		КОГДА ДД.ДоляСтоимостиНаПроизводство = 0 
		|				И ДД.ВсегоДолейСтоимости = 0
		|			ТОГДА 100 
		|		ИНАЧЕ 
		|			ДД.ДоляСтоимостиНаПроизводство 
		|	КОНЕЦ + ДД.ДоляСтоимостиНаСтатьи КАК ДоляСтоимости
		|ПОМЕСТИТЬ
		|	ДолиСтоимости
		|ИЗ 
		|	Документ.РаспределениеПрочихЗатрат КАК ДД
		|ГДЕ
		|	ДД.Дата МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Проведен
		//-- НЕ УТ
		|;
		|ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	ДД.ДокументПоступления КАК Ссылка,
		|	ДД.Склад КАК Склад,
		|	МАКСИМУМ(ДД.Регистратор) КАК Регистратор,
		|	МАКСИМУМ(ДД.Период) КАК Период
		|ПОМЕСТИТЬ
		|	ПрошлыеПоступления
		|ИЗ (
		|	ВЫБРАТЬ РАЗЛИЧНЫЕ
		|		ДД.ДокументПоступления,
		|		ДД.АналитикаУчетаНоменклатуры.МестоХранения КАК Склад,
		|		МАКСИМУМ(Периодика.Регистратор) КАК Регистратор,
		|		МАКСИМУМ(Периодика.Период) КАК Период
		|	ИЗ
		|		РегистрНакопления.ПартииПроизводственныхЗатрат.Остатки(&НачалоПериода, Организация В (&МассивОрганизаций)) КАК ДД
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрНакопления.ПартииПроизводственныхЗатрат КАК Периодика
		|			ПО Периодика.Период < &НачалоПериода
		|			И Периодика.ДокументПоступления = ДД.ДокументПоступления
		|			И Периодика.АналитикаУчетаНоменклатуры.МестоХранения = ДД.АналитикаУчетаНоменклатуры.МестоХранения
		|	ГДЕ
		|		ДД.ДокументПоступления <> НЕОПРЕДЕЛЕНО
		|		И Периодика.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|		И Периодика.Количество > 0
		|	СГРУППИРОВАТЬ ПО
		|		ДД.ДокументПоступления,
		|		ДД.АналитикаУчетаНоменклатуры.МестоХранения
		|
		//++ НЕ УТ
		|	ОБЪЕДИНИТЬ ВСЕ
		|	ВЫБРАТЬ РАЗЛИЧНЫЕ
		|		ДД.ДокументПоступления,
		|		ДД.АналитикаУчетаНоменклатуры.МестоХранения КАК Склад,
		|		МАКСИМУМ(Периодика.Регистратор) КАК Регистратор,
		|		МАКСИМУМ(Периодика.Период) КАК Период
		|	ИЗ
		|		РегистрНакопления.ПартииНезавершенногоПроизводства.Остатки(&НачалоПериода, Организация В (&МассивОрганизаций)) КАК ДД
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрНакопления.ПартииПроизводственныхЗатрат КАК Периодика
		|			ПО Периодика.Период < &НачалоПериода
		|			И Периодика.ДокументПоступления = ДД.ДокументПоступления
		|			И Периодика.АналитикаУчетаНоменклатуры.МестоХранения = ДД.АналитикаУчетаНоменклатуры.МестоХранения
		|	ГДЕ
		|		ДД.ДокументПоступления <> НЕОПРЕДЕЛЕНО
		|		И Периодика.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|	СГРУППИРОВАТЬ ПО
		|		ДД.ДокументПоступления,
		|		ДД.АналитикаУчетаНоменклатуры.МестоХранения
		//-- НЕ УТ
		|	) КАК ДД
		|СГРУППИРОВАТЬ ПО
		|	ДД.ДокументПоступления,
		|	ДД.Склад
		|;
		// Подразделение документов-регистраторов
		|ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	ДД.Регистратор,
		|	ДД.Подразделение
		|ПОМЕСТИТЬ
		|	ПодразделенияРегистраторов
		|ИЗ
		|	РегистрНакопления.СебестоимостьТоваров КАК ДД
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И (ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		|		ИЛИ ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|		И ДД.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СторноСписанияНаРасходы))
		|	И ДД.Подразделение <> ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка)
		|;
		|ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	Корректировка.ДокументОснование КАК Поступление
		|ПОМЕСТИТЬ
		|	КорректируемыеПоступления
		|ИЗ
		|	РегистрНакопления.ПартииРасходовНаСебестоимостьТоваров КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.КорректировкаПриобретения КАК Корректировка
		|		ПО Корректировка.Ссылка = ДД.Регистратор
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|	И ДД.ДокументПоступленияРасходов = ДД.Регистратор
		|;
		// Остатки партионных регистров на начало по аналитикам доп.расходов
		|ВЫБРАТЬ
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ДокументПоступления,
		|	ДД.ВидЗапасов,
		|	СУММА(ДД.Количество) КАК Количество
		|ПОМЕСТИТЬ
		|	ПоступленияПартий
		|ИЗ
		|	РегистрНакопления.ПартииТоваровОрганизаций КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ КорректируемыеПоступления КАК Поступления
		|		ПО Поступления.Поступление = ДД.Регистратор
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|СГРУППИРОВАТЬ ПО
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ДокументПоступления,
		|	ДД.ВидЗапасов
		|;
		|ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.СтатьяРасходов
		|ПОМЕСТИТЬ
		|	ПартииПрочихРасходов
		|ИЗ
		|	РегистрНакопления.ПартииПрочихРасходов КАК ДД
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		|	И (ДД.СтатьяРасходов.ВариантРаспределенияРасходовУпр = ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаСебестоимостьТоваров)
		|		ИЛИ ДД.СтатьяРасходов.ВариантРаспределенияРасходовРегл = ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаСебестоимостьТоваров))
		|";
КонецФункции

Функция ТекстОписаниеПартийРасходов()
	Возврат "
		// Соединения и ЕСТЬNULL использованы для расширения типов полей таблицы ДанныеДляПартийХХХ.
		|ВЫБРАТЬ ПЕРВЫЕ 0
		|	ВЫРАЗИТЬ("""" КАК СТРОКА(80)) КАК ЗапросИсточник,
		|	0 КАК Приоритет,
		|	""ХХХХХХХХХХХХХХХХ"" КАК ТипЗаписи,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КАК РазделУчета,
		|	ДАТАВРЕМЯ(1, 1, 1, 0, 0, 0) КАК Период,
		|	ДД.Регистратор,
		|	ЗНАЧЕНИЕ(Справочник.Организации.ПустаяСсылка) КАК Организация,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КАК АналитикаУчетаНоменклатуры,
		|	ДД.ДокументПоступления,
		|	ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка) КАК ВидЗапасов,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка) КАК АналитикаУчетаПартий,
		|	ДД.ДокументПоступленияРасходов,
		|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) КАК СтатьяРасходов,
		|	0 КАК Количество,
		|	0 КАК Знаменатель,
		|	0 КАК Стоимость,
		|	0 КАК СтоимостьБезНДС,
		|	0 КАК СтоимостьРегл,
		|	0 КАК НДСРегл,
		|	0 КАК ПостояннаяРазница,
		|	0 КАК ВременнаяРазница,
		|	ЛОЖЬ КАК СохранятьРегл,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КАК КорАналитикаУчетаНоменклатуры,
		|	ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка) КАК КорВидЗапасов,
		|	ДД.ДокументИсточник,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка) КАК НалогообложениеПартии,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка) КАК НалогообложениеНДС,
		|	ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка) КАК Продукция,
		|	ЗНАЧЕНИЕ(Справочник.ХарактеристикиНоменклатуры.ПустаяСсылка) КАК ХарактеристикаПродукции,
		|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПустаяСсылка) КАК ХозяйственнаяОперация,
		|	ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка) КАК ПодразделениеРасходов,
		|	ДД.СтатьяРасходовСписания,
		|	ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.ПустаяСсылка) КАК ВариантРаспределенияРасходовУпр,
		|	ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.ПустаяСсылка) КАК ВариантРаспределенияРасходовРегл,
		|	ДД.АналитикаРасходов,
		|	ДД.АналитикаАктивовПассивов,
		|	ДД.СтатьяСписанияНДС,
		|	ДД.АналитикаСписанияНДС
		|//ВоВременнуюТаблицу ПОМЕСТИТЬ ИсходныеДанные
		|ИЗ
		|	РегистрНакопления.ПартииРасходовНаСебестоимостьТоваров КАК ДД
		|";
КонецФункции

Функция ТекстОстаткиПартийРасходов() // использует ОстаткиПартий, ПрошлыеПоступления
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстОстаткиПартийРасходов"" КАК ЗапросИсточник,
		|	10 КАК Приоритет,
		|	""Остаток"" КАК ТипЗаписи,
		|	ИСТИНА КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
		|	(ВЫБОР
		|		КОГДА Периодика.Регистратор ЕСТЬ NULL ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка)
		//++ НЕ УТ
		|		КОГДА Периодика.Регистратор ССЫЛКА Документ.ПередачаСырьяПереработчику
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПереданныеПереработчику)
		|		КОГДА Периодика.Регистратор ССЫЛКА Документ.ПередачаМатериаловВПроизводство
		|		 И Аналитика.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Партнер)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПереданныеПереработчику)
		//-- НЕ УТ
		|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КОНЕЦ) КАК РазделУчета,
		|	&НачалоПериода КАК Период,
		|	ЕСТЬNULL(Периодика.Регистратор, ДД.ДокументПоступления) КАК Регистратор,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ДокументПоступления,
		|	ДД.ВидЗапасов,
		|	ДД.АналитикаУчетаПартий,
		|	ДД.ДокументПоступленияРасходов,
		|	ДД.СтатьяРасходов,
		|	Партии.Количество,
		|	0 КАК Знаменатель,
		|	ДД.СтоимостьОстаток КАК Стоимость,
		|	ДД.СтоимостьБезНДСОстаток КАК СтоимостьБезНДС,
		|	ДД.СтоимостьРеглОстаток КАК СтоимостьРегл,
		|	ДД.НДСРеглОстаток КАК НДСРегл,
		|	ДД.ПостояннаяРазницаОстаток КАК ПостояннаяРазница,
		|	ДД.ВременнаяРазницаОстаток КАК ВременнаяРазница,
		|	ЛОЖЬ КАК СохранятьРегл,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КАК КорАналитикаУчетаНоменклатуры,
		|	ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка) КАК КорВидЗапасов,
		|	ЕСТЬNULL(Периодика.Регистратор, ДД.ДокументПоступления) КАК ДокументИсточник,
		|	ДД.АналитикаУчетаПартий.НалогообложениеНДС КАК НалогообложениеПартии,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка) КАК НалогообложениеНДС,
		|	НЕОПРЕДЕЛЕНО КАК Продукция,
		|	НЕОПРЕДЕЛЕНО КАК ХарактеристикаПродукции,
		|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПустаяСсылка) КАК ХозяйственнаяОперация,
		|	ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка) КАК ПодразделениеРасходов,
		|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) КАК СтатьяРасходовСписания,
		|	НЕОПРЕДЕЛЕНО КАК ВариантРаспределенияРасходовУпр,
		|	НЕОПРЕДЕЛЕНО КАК ВариантРаспределенияРасходовРегл,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивовПассивов,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаСписанияНДС
		|ИЗ
		|	РегистрНакопления.ПартииРасходовНаСебестоимостьТоваров.Остатки(&НачалоПериода, Организация В (&МассивОрганизаций)) КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК Аналитика
		|		ПО Аналитика.Ссылка = ДД.АналитикаУчетаНоменклатуры
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ОстаткиПартий КАК Партии
		|		ПО Партии.Организация = ДД.Организация
		|		И Партии.АналитикаУчетаНоменклатуры = ДД.АналитикаУчетаНоменклатуры
		|		И Партии.ДокументПоступления = ДД.ДокументПоступления
		|		И Партии.ВидЗапасов = ДД.ВидЗапасов
		|	ЛЕВОЕ СОЕДИНЕНИЕ ПрошлыеПоступления КАК Периодика
		|		ПО Периодика.Ссылка = ДД.ДокументПоступления
		|		И Периодика.Склад = Аналитика.МестоХранения
		|ГДЕ
		|	Партии.Количество > 0
		|";
КонецФункции
	
Функция ТекстПриходыПартийРасходов()
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстПриходыПартийРасходов"" КАК ЗапросИсточник,
		|	10 КАК Приоритет,
		|	""Партия"" КАК ТипЗаписи,
		|	ИСТИНА КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КАК РазделУчета,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ДокументПоступления,
		|	ДД.ВидЗапасов,
		|	ДД.АналитикаУчетаПартий,
		|	ДД.ДокументПоступленияРасходов,
		|	ДД.СтатьяРасходов,
		|	СУММА(ЕСТЬNULL(ПоступленияПартий.Количество, ДД.Количество)) КАК Количество,
		|	0 КАК Знаменатель,
		|	СУММА(ДД.Стоимость) КАК Стоимость,
		|	СУММА(ДД.СтоимостьБезНДС) КАК СтоимостьБезНДС,
		|	СУММА(ДД.СтоимостьРегл) КАК СтоимостьРегл,
		|	СУММА(ДД.НДСРегл) КАК НДСРегл,
		|	СУММА(ДД.ПостояннаяРазница) КАК ПостояннаяРазница,
		|	СУММА(ДД.ВременнаяРазница) КАК ВременнаяРазница,
		|	ЛОЖЬ КАК СохранятьРегл,
		|	ДД.КорАналитикаУчетаНоменклатуры,
		|	ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка) КАК КорВидЗапасов,
		|	(ВЫБОР 
		|		КОГДА ТИПЗНАЧЕНИЯ(ДД.АналитикаРасходов) = ТИП(Документ.ПеремещениеТоваров)
		|			И ДД.АналитикаРасходов <> ЗНАЧЕНИЕ(Документ.ПеремещениеТоваров.ПустаяСсылка) ТОГДА ДД.ДокументИсточник
		|		КОГДА ТИПЗНАЧЕНИЯ(ДД.АналитикаРасходов) = ТИП(Документ.ПередачаТоваровМеждуОрганизациями)
		|			И ДД.АналитикаРасходов <> ЗНАЧЕНИЕ(Документ.ПередачаТоваровМеждуОрганизациями.ПустаяСсылка) ТОГДА ДД.АналитикаРасходов
		|		КОГДА ТИПЗНАЧЕНИЯ(ДД.АналитикаРасходов) = ТИП(Документ.ЗаказНаПеремещение) ТОГДА ДД.ДокументИсточник
		|		КОГДА ДД.ДокументИсточник <> НЕОПРЕДЕЛЕНО ТОГДА ДД.ДокументИсточник
		|		ИНАЧЕ ДД.ДокументПоступления КОНЕЦ) КАК ДокументИсточник,
		|	ДД.АналитикаУчетаПартий.НалогообложениеНДС КАК НалогообложениеПартии,
		|	ДД.НалогообложениеНДС,
		|	НЕОПРЕДЕЛЕНО КАК Продукция,
		|	НЕОПРЕДЕЛЕНО КАК ХарактеристикаПродукции,
		|	ДД.ХозяйственнаяОперация,
		|	ДД.ПодразделениеРасходов,
		|	ДД.СтатьяРасходовСписания,
		|	НЕОПРЕДЕЛЕНО КАК ВариантРаспределенияРасходовУпр,
		|	НЕОПРЕДЕЛЕНО КАК ВариантРаспределенияРасходовРегл,
		|	ДД.АналитикаРасходов,
		|	ДД.АналитикаАктивовПассивов,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаСписанияНДС
		|ИЗ
		|	РегистрНакопления.ПартииРасходовНаСебестоимостьТоваров КАК ДД
		|	ЛЕВОЕ СОЕДИНЕНИЕ ПоступленияПартий КАК ПоступленияПартий
		|		ПО ПоступленияПартий.Организация = ДД.Организация
		|		И ПоступленияПартий.АналитикаУчетаНоменклатуры = ДД.АналитикаУчетаНоменклатуры
		|		И ПоступленияПартий.ДокументПоступления = ДД.ДокументПоступления
		|		И ПоступленияПартий.ВидЗапасов = ДД.ВидЗапасов
		|	ЛЕВОЕ СОЕДИНЕНИЕ ПартииПрочихРасходов КАК Партии
		|		ПО Партии.Регистратор = ДД.Регистратор
		|		И Партии.Организация = ДД.Организация
		|		И Партии.СтатьяРасходов = ДД.СтатьяРасходов
		|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.СчетФактураПолученныйНалоговыйАгент КАК СчетФактура
		|		ПО СчетФактура.Ссылка = ДД.Регистратор
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И ДД.ДокументПоступленияРасходов В (
		|		ДД.Регистратор,
		|		СчетФактура.СчетФактураОснование)
		|	И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|	И (НЕ Партии.Регистратор ЕСТЬ NULL
		|		ИЛИ ДД.СтатьяРасходов = ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка))
		|СГРУППИРОВАТЬ ПО
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ДокументПоступления,
		|	ДД.ВидЗапасов,
		|	ДД.АналитикаУчетаПартий,
		|	ДД.ДокументПоступленияРасходов,
		|	ДД.СтатьяРасходов,
		|	ДД.КорАналитикаУчетаНоменклатуры,
		|	(ВЫБОР 
		|		КОГДА ТИПЗНАЧЕНИЯ(ДД.АналитикаРасходов) = ТИП(Документ.ПеремещениеТоваров)
		|			И ДД.АналитикаРасходов <> ЗНАЧЕНИЕ(Документ.ПеремещениеТоваров.ПустаяСсылка) ТОГДА ДД.ДокументИсточник
		|		КОГДА ТИПЗНАЧЕНИЯ(ДД.АналитикаРасходов) = ТИП(Документ.ПередачаТоваровМеждуОрганизациями)
		|			И ДД.АналитикаРасходов <> ЗНАЧЕНИЕ(Документ.ПередачаТоваровМеждуОрганизациями.ПустаяСсылка) ТОГДА ДД.АналитикаРасходов
		|		КОГДА ТИПЗНАЧЕНИЯ(ДД.АналитикаРасходов) = ТИП(Документ.ЗаказНаПеремещение) ТОГДА ДД.ДокументИсточник
		|		КОГДА ДД.ДокументИсточник <> НЕОПРЕДЕЛЕНО ТОГДА ДД.ДокументИсточник
		|		ИНАЧЕ ДД.ДокументПоступления КОНЕЦ),
		|	ДД.АналитикаУчетаПартий.НалогообложениеНДС,
		|	ДД.НалогообложениеНДС,
		|	ДД.ХозяйственнаяОперация,
		|	ДД.ПодразделениеРасходов,
		|	ДД.СтатьяРасходовСписания,
		|	ДД.АналитикаРасходов,
		|	ДД.АналитикаАктивовПассивов
		|";
КонецФункции

Функция ТекстДополненияПартийРасходов() // использует ПрошлыеРегистраторы
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстДополненияПартийРасходов"" КАК ЗапросИсточник,
		|	10 КАК Приоритет,
		|	""Дополнение"" КАК ТипЗаписи,
		|	ИСТИНА КАК РасчетЗавершен,
		|	ДД.ВидДвижения,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КАК РазделУчета,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ДокументПоступления,
		|	ДД.ВидЗапасов,
		|	ДД.АналитикаУчетаПартий,
		|	ДД.ДокументПоступленияРасходов,
		|	ДД.СтатьяРасходов,
		|	ДД.Количество,
		|	0 КАК Знаменатель,
		|	ДД.Стоимость,
		|	ДД.СтоимостьБезНДС,
		|	ДД.СтоимостьРегл,
		|	ДД.НДСРегл,
		|	ДД.ПостояннаяРазница,
		|	ДД.ВременнаяРазница,
		|	ЛОЖЬ КАК СохранятьРегл,
		|	ДД.КорАналитикаУчетаНоменклатуры,
		|	ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка) КАК КорВидЗапасов,
		|	ДД.ДокументИсточник,
		|	ДД.АналитикаУчетаПартий.НалогообложениеНДС КАК НалогообложениеПартии,
		|	ДД.НалогообложениеНДС,
		|	НЕОПРЕДЕЛЕНО КАК Продукция,
		|	НЕОПРЕДЕЛЕНО КАК ХарактеристикаПродукции,
		|	ДД.ХозяйственнаяОперация,
		|	ДД.ПодразделениеРасходов,
		|	ДД.СтатьяРасходовСписания,
		|	НЕОПРЕДЕЛЕНО КАК ВариантРаспределенияРасходовУпр,
		|	НЕОПРЕДЕЛЕНО КАК ВариантРаспределенияРасходовРегл,
		|	ДД.АналитикаРасходов,
		|	ДД.АналитикаАктивовПассивов,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаСписанияНДС
		|ИЗ
		|	РегистрНакопления.ПартииРасходовНаСебестоимостьТоваров КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ПрошлыеРегистраторы КАК ПрошлыеРегистраторы
		|		ПО ПрошлыеРегистраторы.Ссылка = ДД.ДокументПоступленияРасходов
		|ГДЕ
		|	ДД.Период < &НачалоПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|";
КонецФункции

Функция ТекстРасходыПартийРасходовПрошлыхМесяцев() // использует ПрошлыеРеализации
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстРасходыПартийРасходовПрошлыхМесяцев"" КАК ЗапросИсточник,
		|	10 КАК Приоритет,
		|	""Прошлое"" КАК ТипЗаписи,
		|	ИСТИНА КАК РасчетЗавершен,
		|	ДД.ВидДвижения,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КАК РазделУчета,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ДокументПоступления,
		|	ДД.ВидЗапасов,
		|	ДД.АналитикаУчетаПартий,
		|	ДД.ДокументПоступленияРасходов,
		|	ДД.СтатьяРасходов,
		|	МАКСИМУМ(ДД.Количество) КАК Количество,
		|	0 КАК Знаменатель,
		|	СУММА(ДД.Стоимость) КАК Стоимость,
		|	СУММА(ДД.СтоимостьБезНДС) КАК СтоимостьБезНДС,
		|	СУММА(ДД.СтоимостьРегл) КАК СтоимостьРегл,
		|	СУММА(ДД.НДСРегл) КАК НДСРегл,
		|	СУММА(ДД.ПостояннаяРазница) КАК ПостояннаяРазница,
		|	СУММА(ДД.ВременнаяРазница) КАК ВременнаяРазница,
		|	ЛОЖЬ КАК СохранятьРегл,
		|	ДД.АналитикаУчетаНоменклатуры КАК КорАналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов КАК КорВидЗапасов,
		|	ДД.Регистратор КАК ДокументИсточник,
		|	ДД.АналитикаУчетаПартий.НалогообложениеНДС КАК НалогообложениеПартии,
		|	ДД.НалогообложениеНДС,
		|	НЕОПРЕДЕЛЕНО КАК Продукция,
		|	НЕОПРЕДЕЛЕНО КАК ХарактеристикаПродукции,
		|	ДД.ХозяйственнаяОперация,
		|	ДД.ПодразделениеРасходов,
		|	ДД.СтатьяРасходовСписания,
		|	НЕОПРЕДЕЛЕНО КАК ВариантРаспределенияРасходовУпр,
		|	НЕОПРЕДЕЛЕНО КАК ВариантРаспределенияРасходовРегл,
		|	ДД.АналитикаРасходов,
		|	ДД.АналитикаАктивовПассивов,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаСписанияНДС
		|ИЗ
		|	РегистрНакопления.ПартииРасходовНаСебестоимостьТоваров КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ПрошлыеРеализации КАК Прошлые
		|		ПО ДД.Регистратор = Прошлые.ДокументРеализации
		|		И ДД.АналитикаУчетаНоменклатуры = Прошлые.АналитикаУчетаНоменклатуры
		|		И ДД.ВидЗапасов = Прошлые.ВидЗапасов
		|ГДЕ
		|	ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|СГРУППИРОВАТЬ ПО
		|	ДД.ВидДвижения,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ДокументПоступления,
		|	ДД.ВидЗапасов,
		|	ДД.АналитикаУчетаПартий,
		|	ДД.ДокументПоступленияРасходов,
		|	ДД.СтатьяРасходов,
		|	ДД.НалогообложениеНДС,
		|	ДД.ХозяйственнаяОперация,
		|	ДД.ПодразделениеРасходов,
		|	ДД.СтатьяРасходовСписания,
		|	ДД.АналитикаРасходов,
		|	ДД.АналитикаАктивовПассивов
		|";
КонецФункции

Функция ТекстИтерацияПартийТоваров()
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстИтерацияПартийТоваров"" КАК ЗапросИсточник,
		|	(ВЫБОР КОГДА ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) И ДД.Количество > 0 ТОГДА 90
		|		ИНАЧЕ 40 КОНЕЦ) КАК Приоритет,
		|	(ВЫБОР
		|		КОГДА ДД.Регистратор = ДД.ДокументПоступления ТОГДА ""Замещение""
		|		КОГДА ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) И ДД.Количество > 0 ТОГДА ""Потребление""
		|		КОГДА ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) И ДД.Количество < 0 ТОГДА ""Сторно""
		|		ИНАЧЕ ""Перемещение"" КОНЕЦ) КАК ТипЗаписи,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	(ВЫБОР
		|		КОГДА ДД.Регистратор = ДД.ДокументПоступления ТОГДА ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|		ИНАЧЕ ДД.ВидДвижения КОНЕЦ) КАК ВидДвижения,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КАК РазделУчета,
		|	ДД.Период КАК Период,
		|	ДД.Регистратор КАК Регистратор,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ДокументПоступления,
		|	ДД.ВидЗапасов,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка) КАК АналитикаУчетаПартий,
		|	НЕОПРЕДЕЛЕНО КАК ДокументПоступленияРасходов,
		|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) КАК СтатьяРасходов,
		|	СУММА(ВЫБОР
		|		КОГДА ДД.Регистратор = ДД.ДокументПоступления И ДД.Количество < 0 ТОГДА -ДД.Количество
		|		ИНАЧЕ ДД.Количество КОНЕЦ) / КОЛИЧЕСТВО(РАЗЛИЧНЫЕ ЕСТЬNULL(Комиссия.НомерСтроки, -1)) КАК Количество,
		|	ЕСТЬNULL(Знаменатели.Знаменатель, 0) КАК Знаменатель,
		|	0 КАК Стоимость,
		|	0 КАК СтоимостьБезНДС,
		|	0 КАК СтоимостьРегл,
		|	0 КАК НДСРегл,
		|	0 КАК ПостояннаяРазница,
		|	0 КАК ВременнаяРазница,
		|	(ВЫБОР
		|		КОГДА НЕ Возвраты.Ссылка ЕСТЬ NULL И ДД.Количество < 0 ТОГДА ИСТИНА
		|		КОГДА ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) ТОГДА ЛОЖЬ
		|		КОГДА Передачи.Ссылка ЕСТЬ NULL И Возвраты.Ссылка ЕСТЬ NULL ТОГДА ЛОЖЬ
		|		ИНАЧЕ ИСТИНА КОНЕЦ) КАК СохранятьРегл,
		|	ЕСТЬNULL(Комиссия.АналитикаУчетаНоменклатуры, ДД.КорАналитикаУчетаНоменклатуры) КАК КорАналитикаУчетаНоменклатуры,
		|	ЕСТЬNULL(Комиссия.ВидЗапасов, ДД.КорВидЗапасов) КАК КорВидЗапасов,
		|	(ВЫБОР
		|		КОГДА ДД.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВозвратОтКомиссионера) ТОГДА ДД.Регистратор
		|		КОГДА ДД.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВозвратИзПроизводства) ТОГДА ДД.Регистратор
		|		ИНАЧЕ ДД.ДокументИсточник КОНЕЦ) КАК ДокументИсточник,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка) КАК НалогообложениеПартии,
		|	ДД.НалогообложениеНДС,
		|	НЕОПРЕДЕЛЕНО КАК Продукция,
		|	НЕОПРЕДЕЛЕНО КАК ХарактеристикаПродукции,
		|	ДД.ХозяйственнаяОперация,
		|	ЕСТЬNULL(ПодразделенияРегистраторов.Подразделение, ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка)) КАК ПодразделениеРасходов,
		|	ДД.СтатьяРасходовСписания,
		|	ДД.СтатьяРасходовСписания.ВариантРаспределенияРасходовУпр КАК ВариантРаспределенияРасходовУпр,
		|	ДД.СтатьяРасходовСписания.ВариантРаспределенияРасходовРегл КАК ВариантРаспределенияРасходовРегл,
		|	ДД.АналитикаРасходов,
		|	ДД.АналитикаАктивовПассивов,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаСписанияНДС
		|ИЗ
		|	РегистрНакопления.ПартииТоваровОрганизаций КАК ДД
		|	ЛЕВОЕ СОЕДИНЕНИЕ ПодразделенияРегистраторов КАК ПодразделенияРегистраторов
		|		ПО ПодразделенияРегистраторов.Регистратор = ДД.Регистратор
		|	ЛЕВОЕ СОЕДИНЕНИЕ Знаменатели КАК Знаменатели
		|		ПО Знаменатели.Регистратор = ДД.Регистратор
		|		И Знаменатели.Организация = ДД.Организация
		|		И Знаменатели.АналитикаУчетаНоменклатуры = ДД.АналитикаУчетаНоменклатуры
		|		И Знаменатели.ДокументПоступления = ДД.ДокументПоступления
		|		И Знаменатели.ВидЗапасов = ДД.ВидЗапасов
		|		И Знаменатели.АналитикаУчетаПартий = ДД.АналитикаУчетаПартий
		|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.ПередачаТоваровМеждуОрганизациями КАК Передачи
		|		ПО Передачи.Дата МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|		И Передачи.Ссылка = ДД.Регистратор
		|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.ВозвратТоваровМеждуОрганизациями КАК Возвраты
		|		ПО Возвраты.Дата МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|		И Возвраты.Ссылка = ДД.Регистратор
		|	ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ПартииТоваровПереданныеНаКомиссию КАК Комиссия
		|		ПО Комиссия.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|		И Комиссия.Регистратор = ДД.Регистратор
		|		И Комиссия.Организация = ДД.Организация
		|		И Комиссия.ДокументПоступления = ДД.ДокументПоступления
		|		И Комиссия.ВидЗапасов = ДД.ВидЗапасов
		|		И Комиссия.КорАналитикаУчетаНоменклатуры = ДД.АналитикаУчетаНоменклатуры
		|	ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ВидыЗапасов КАК ВидЗапасовПрихода
		|		ПО ВидЗапасовПрихода.Ссылка = ДД.ВидЗапасов
		|		И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И ДД.ДокументИсточник <> НЕОПРЕДЕЛЕНО
		|	И ЕСТЬNULL(ВидЗапасовПрихода.ТипЗапасов <> ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.КомиссионныйТовар), ИСТИНА)
		|	И НЕ ДД.Регистратор ССЫЛКА Документ.РасчетСебестоимостиТоваров
		//++ НЕ УТ
		|	И НЕ ДД.Регистратор ССЫЛКА Документ.ВозвратСырьяОтПереработчика
		|	И НЕ ДД.Регистратор ССЫЛКА Документ.ВозвратМатериаловИзПроизводства
		//-- НЕ УТ
		|СГРУППИРОВАТЬ ПО
		|	(ВЫБОР КОГДА ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) И ДД.Количество > 0 ТОГДА 90
		|		ИНАЧЕ 40 КОНЕЦ),
		|	(ВЫБОР
		|		КОГДА ДД.Регистратор = ДД.ДокументПоступления ТОГДА ""Замещение""
		|		КОГДА ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) И ДД.Количество > 0 ТОГДА ""Потребление""
		|		КОГДА ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) И ДД.Количество < 0 ТОГДА ""Сторно""
		|		ИНАЧЕ ""Перемещение"" КОНЕЦ),
		|	(ВЫБОР
		|		КОГДА ДД.Регистратор = ДД.ДокументПоступления ТОГДА ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|		ИНАЧЕ ДД.ВидДвижения КОНЕЦ),
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ДокументПоступления,
		|	ДД.ВидЗапасов,
		|	ЕСТЬNULL(Знаменатели.Знаменатель, 0),
		|	(ВЫБОР
		|		КОГДА НЕ Возвраты.Ссылка ЕСТЬ NULL И ДД.Количество < 0 ТОГДА ИСТИНА
		|		КОГДА ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) ТОГДА ЛОЖЬ
		|		КОГДА Передачи.Ссылка ЕСТЬ NULL И Возвраты.Ссылка ЕСТЬ NULL ТОГДА ЛОЖЬ
		|		ИНАЧЕ ИСТИНА КОНЕЦ),
		|	ЕСТЬNULL(Комиссия.АналитикаУчетаНоменклатуры, ДД.КорАналитикаУчетаНоменклатуры),
		|	ЕСТЬNULL(Комиссия.ВидЗапасов, ДД.КорВидЗапасов),
		|	(ВЫБОР
		|		КОГДА ДД.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВозвратОтКомиссионера) ТОГДА ДД.Регистратор
		|		КОГДА ДД.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВозвратИзПроизводства) ТОГДА ДД.Регистратор
		|		ИНАЧЕ ДД.ДокументИсточник КОНЕЦ),
		|	ДД.НалогообложениеНДС,
		|	ДД.ХозяйственнаяОперация,
		|	ДД.СтатьяРасходовСписания,
		|	ДД.АналитикаРасходов,
		|	ДД.АналитикаАктивовПассивов,
		|	ЕСТЬNULL(ПодразделенияРегистраторов.Подразделение, ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка))
		|";
КонецФункции

Функция ТекстИтерацияПартийПереданных()
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстИтерацияПартийПереданных"" КАК ЗапросИсточник,
		|	(ВЫБОР КОГДА ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) И ДД.Количество > 0 ТОГДА 90
		|		ИНАЧЕ 40 КОНЕЦ) КАК Приоритет,
		|	(ВЫБОР
		|		КОГДА ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		|			И НЕ РеализацияТоварыВПути.Ссылка ЕСТЬ NULL ТОГДА ""ПотреблениеВПути""
		|		КОГДА ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) И ДД.Количество > 0 ТОГДА ""Потребление""
		|		КОГДА ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) И ДД.Количество < 0 ТОГДА ""Сторно""
		|		КОГДА ДД.Регистратор = ДД.ДокументПоступления ТОГДА ""Замещение""
		|		ИНАЧЕ ""Перемещение"" КОНЕЦ) КАК ТипЗаписи,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ДД.ВидДвижения,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КАК РазделУчета,
		|	ДД.Период КАК Период,
		|	ДД.Регистратор КАК Регистратор,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ДокументПоступления,
		|	ДД.ВидЗапасов,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка) КАК АналитикаУчетаПартий,
		|	НЕОПРЕДЕЛЕНО КАК ДокументПоступленияРасходов,
		|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) КАК СтатьяРасходов,
		|	СУММА(ДД.Количество) КАК Количество,
		|	0 КАК Знаменатель,
		|	0 КАК Стоимость,
		|	0 КАК СтоимостьБезНДС,
		|	0 КАК СтоимостьРегл,
		|	0 КАК НДСРегл,
		|	0 КАК ПостояннаяРазница,
		|	0 КАК ВременнаяРазница,
		|	ЛОЖЬ КАК СохранятьРегл,
		|	ДД.КорАналитикаУчетаНоменклатуры,
		|	ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка) КАК КорВидЗапасов,
		|	(ВЫБОР
		|		КОГДА Реализация.Дата >= &НачалоПериода ТОГДА ДД.ДокументПередачиНаКомиссию
		|		КОГДА Передача.Дата >= &НачалоПериода ТОГДА ДД.ДокументПередачиНаКомиссию
		|		ИНАЧЕ ДД.ДокументПоступления КОНЕЦ) КАК ДокументИсточник,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка) КАК НалогообложениеПартии,
		|	ДД.НалогообложениеНДС,
		|	НЕОПРЕДЕЛЕНО КАК Продукция,
		|	НЕОПРЕДЕЛЕНО КАК ХарактеристикаПродукции,
		|	ДД.ХозяйственнаяОперация,
		|	ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка) КАК ПодразделениеРасходов,
		|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) КАК СтатьяРасходовСписания,
		|	НЕОПРЕДЕЛЕНО КАК ВариантРаспределенияРасходовУпр,
		|	НЕОПРЕДЕЛЕНО КАК ВариантРаспределенияРасходовРегл,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивовПассивов,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаСписанияНДС
		|ИЗ
		|	РегистрНакопления.ПартииТоваровПереданныеНаКомиссию КАК ДД
		|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.РеализацияТоваровУслуг КАК Реализация
		|		ПО Реализация.Ссылка = ДД.ДокументПередачиНаКомиссию
		|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.ПередачаТоваровМеждуОрганизациями КАК Передача
		|		ПО Передача.Ссылка = ДД.ДокументПередачиНаКомиссию
		|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.РеализацияТоваровУслуг КАК РеализацияТоварыВПути
		|		ПО РеализацияТоварыВПути.Дата МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|		И РеализацияТоварыВПути.Ссылка = ДД.Регистратор
		|		И РеализацияТоварыВПути.ХозяйственнаяОперация В (
		|			ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РеализацияБезПереходаПраваСобственности),
		|			ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РеализацияЧерезКомиссионераБезПереходаПраваСобственности))
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|СГРУППИРОВАТЬ ПО
		|	(ВЫБОР КОГДА ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) И ДД.Количество > 0 ТОГДА 90
		|		ИНАЧЕ 40 КОНЕЦ),
		|	(ВЫБОР
		|		КОГДА ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		|			И НЕ РеализацияТоварыВПути.Ссылка ЕСТЬ NULL ТОГДА ""ПотреблениеВПути""
		|		КОГДА ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) И ДД.Количество > 0 ТОГДА ""Потребление""
		|		КОГДА ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) И ДД.Количество < 0 ТОГДА ""Сторно""
		|		КОГДА ДД.Регистратор = ДД.ДокументПоступления ТОГДА ""Замещение""
		|		ИНАЧЕ ""Перемещение"" КОНЕЦ),
		|	ДД.ВидДвижения,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ДокументПоступления,
		|	ДД.ВидЗапасов,
		|	ДД.КорАналитикаУчетаНоменклатуры,
		|	(ВЫБОР
		|		КОГДА Реализация.Дата >= &НачалоПериода ТОГДА ДД.ДокументПередачиНаКомиссию
		|		КОГДА Передача.Дата >= &НачалоПериода ТОГДА ДД.ДокументПередачиНаКомиссию
		|		ИНАЧЕ ДД.ДокументПоступления КОНЕЦ),
		|	ДД.НалогообложениеНДС,
		|	ДД.ХозяйственнаяОперация
		|";
КонецФункции

Функция ТекстПартииРасходовВПути()
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстПартииРасходовВПути"" КАК ЗапросИсточник,
		|	10 КАК Приоритет,
		|	""ВПути"" КАК ТипЗаписи,
		|	ИСТИНА КАК РасчетЗавершен,
		|	ДД.ВидДвижения,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КАК РазделУчета,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ДокументПоступления,
		|	ДД.ВидЗапасов,
		|	ДД.АналитикаУчетаПартий,
		|	ДД.ДокументПоступленияРасходов,
		|	ДД.СтатьяРасходов,
		|	ДД.Количество,
		|	0 КАК Знаменатель,
		|	ДД.Стоимость,
		|	ДД.СтоимостьБезНДС,
		|	ДД.СтоимостьРегл,
		|	ДД.НДСРегл,
		|	ДД.ПостояннаяРазница,
		|	ДД.ВременнаяРазница,
		|	ЛОЖЬ КАК СохранятьРегл,
		|	ДД.КорАналитикаУчетаНоменклатуры,
		|	ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка) КАК КорВидЗапасов,
		|	ДД.ДокументИсточник,
		|	ДД.АналитикаУчетаПартий.НалогообложениеНДС КАК НалогообложениеПартии,
		|	ДД.НалогообложениеНДС,
		|	НЕОПРЕДЕЛЕНО КАК Продукция,
		|	НЕОПРЕДЕЛЕНО КАК ХарактеристикаПродукции,
		|	ДД.ХозяйственнаяОперация,
		|	ДД.ПодразделениеРасходов,
		|	ДД.СтатьяРасходовСписания,
		|	НЕОПРЕДЕЛЕНО КАК ВариантРаспределенияРасходовУпр,
		|	НЕОПРЕДЕЛЕНО КАК ВариантРаспределенияРасходовРегл,
		|	ДД.АналитикаРасходов,
		|	ДД.АналитикаАктивовПассивов,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаСписанияНДС
		|ИЗ
		|	Документ.РеализацияТоваровУслуг КАК Отгрузки
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ  РегистрНакопления.ПартииРасходовНаСебестоимостьТоваров КАК ДД
		|		ПО ДД.Регистратор = Отгрузки.Ссылка
		|ГДЕ
		|	Отгрузки.ХозяйственнаяОперация В (
		|		ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РеализацияБезПереходаПраваСобственности),
		|		ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РеализацияЧерезКомиссионераБезПереходаПраваСобственности))
		|	И (Отгрузки.ДатаПереходаПраваСобственности МЕЖДУ &НачалоПериода И &ОкончаниеПериода // расчет в периоде перехода права собственности
		|		ИЛИ Отгрузки.Дата МЕЖДУ &НачалоПериода И &ОкончаниеПериода // расчет в периоде отгрузки
		|		ИЛИ Отгрузки.ДатаПереходаПраваСобственности = ДАТАВРЕМЯ(1,1,1))
		|	И (ДД.Период < &НачалоПериода И Отгрузки.Дата < &НачалоПериода // сохранение движений в периоде отгрузки
		|		// сохранение движений в периоде перехода права собственности
		|		ИЛИ ДД.Период > &ОкончаниеПериода И Отгрузки.Дата МЕЖДУ &НачалоПериода И &ОкончаниеПериода)
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|";
КонецФункции

Функция ТекстИтерацияПартийПроизводства()
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстИтерацияПартийПроизводства"" КАК ЗапросИсточник,
		|	(ВЫБОР 
		|		КОГДА ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) ТОГДА 10
		|		ИНАЧЕ 90 КОНЕЦ) КАК Приоритет,
		|	(ВЫБОР 
		|		КОГДА ДД.Количество < 0 ТОГДА ""Сторно""
		|		КОГДА ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) ТОГДА ""Потребление""
		|		ИНАЧЕ ""Перемещение"" КОНЕЦ) КАК ТипЗаписи,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	(ВЫБОР 
		|		КОГДА ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) ТОГДА ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		|		ИНАЧЕ ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КОНЕЦ) КАК ВидДвижения,
		|	(ВЫБОР ДД.ХозяйственнаяОперация
		|		КОГДА ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПередачаПереработчику)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПереданныеПереработчику)
		|		КОГДА ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПередачаПереработчику2_5)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПереданныеПереработчику)
		|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КОНЕЦ) КАК РазделУчета,
		|	ДД.Период КАК Период,
		|	ДД.Регистратор КАК Регистратор,
		|	ДД.Организация,
		|	(ВЫБОР
		|		КОГДА ДД.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВозвратОтПереработчика)
		|			ТОГДА ДД.АналитикаУчетаНоменклатуры
		|		КОГДА ДД.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВозвратОтПереработчика2_5)
		|			ТОГДА ДД.АналитикаУчетаНоменклатуры
		|		ИНАЧЕ ДД.КорАналитикаУчетаНоменклатуры КОНЕЦ) КАК АналитикаУчетаНоменклатуры,
		|	ДД.ДокументПоступления,
		|	ДД.КорВидЗапасов КАК ВидЗапасов,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка) КАК АналитикаУчетаПартий,
		|	НЕОПРЕДЕЛЕНО КАК ДокументПоступленияРасходов,
		|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) КАК СтатьяРасходов,
		|	СУММА(ДД.Количество) КАК Количество,
		|	СУММА(ДД.Количество) КАК Знаменатель,
		|	0 КАК Стоимость,
		|	0 КАК СтоимостьБезНДС,
		|	0 КАК СтоимостьРегл,
		|	0 КАК НДСРегл,
		|	0 КАК ПостояннаяРазница,
		|	0 КАК ВременнаяРазница,
		|	ЛОЖЬ КАК СохранятьРегл,
		|	(ВЫБОР 
		|		КОГДА ДД.Количество < 0 ТОГДА ДД.КорАналитикаУчетаНоменклатуры
		|		ИНАЧЕ ДД.АналитикаУчетаНоменклатуры КОНЕЦ) КАК КорАналитикаУчетаНоменклатуры,
		|	(ВЫБОР 
		|		КОГДА ДД.Количество < 0 ТОГДА ДД.КорВидЗапасов
		|		ИНАЧЕ ДД.ВидЗапасов КОНЕЦ) КАК КорВидЗапасов,
		|	(ВЫБОР
		|		КОГДА ДД.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВозвратОтПереработчика)
		|			ТОГДА ДД.Регистратор
		|		КОГДА ДД.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВозвратОтПереработчика2_5)
		|			ТОГДА ДД.Регистратор
		|		КОГДА ДД.Количество < 0 ТОГДА ДД.ДокументИсточник
		|		ИНАЧЕ ДД.Регистратор КОНЕЦ) КАК ДокументИсточник,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка) КАК НалогообложениеПартии,
		|	ДД.НалогообложениеНДС,
		|	НЕОПРЕДЕЛЕНО КАК Продукция,
		|	НЕОПРЕДЕЛЕНО КАК ХарактеристикаПродукции,
		|	ДД.ХозяйственнаяОперация,
		|	ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка) КАК ПодразделениеРасходов,
		|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) КАК СтатьяРасходовСписания,
		|	НЕОПРЕДЕЛЕНО КАК ВариантРаспределенияРасходовУпр,
		|	НЕОПРЕДЕЛЕНО КАК ВариантРаспределенияРасходовРегл,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивовПассивов,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаСписанияНДС
		|ИЗ
		|	РегистрНакопления.ПартииТоваровОрганизаций КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ МатериалыИРаботыВПроизводстве КАК Затраты
		|		ПО Затраты.Регистратор = ДД.Регистратор
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		//++ НЕ УТ
		|	И НЕ ДД.Регистратор ССЫЛКА Документ.ВозвратСырьяОтПереработчика
		|	И НЕ ДД.Регистратор ССЫЛКА Документ.ВозвратМатериаловИзПроизводства
		//-- НЕ УТ
		|СГРУППИРОВАТЬ ПО
		|	(ВЫБОР 
		|		КОГДА ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) ТОГДА 10
		|		ИНАЧЕ 90 КОНЕЦ),
		|	(ВЫБОР 
		|		КОГДА ДД.Количество < 0 ТОГДА ""Сторно""
		|		КОГДА ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) ТОГДА ""Потребление""
		|		ИНАЧЕ ""Перемещение"" КОНЕЦ),
		|	(ВЫБОР 
		|		КОГДА ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) ТОГДА ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		|		ИНАЧЕ ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КОНЕЦ),
		|	(ВЫБОР ДД.ХозяйственнаяОперация
		|		КОГДА ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПередачаПереработчику)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПереданныеПереработчику)
		|		КОГДА ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПередачаПереработчику2_5)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПереданныеПереработчику)
		|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КОНЕЦ),
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	(ВЫБОР
		|		КОГДА ДД.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВозвратОтПереработчика)
		|			ТОГДА ДД.АналитикаУчетаНоменклатуры
		|		КОГДА ДД.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВозвратОтПереработчика2_5)
		|			ТОГДА ДД.АналитикаУчетаНоменклатуры
		|		ИНАЧЕ ДД.КорАналитикаУчетаНоменклатуры КОНЕЦ),
		|	ДД.ДокументПоступления,
		|	ДД.КорВидЗапасов,
		|	(ВЫБОР 
		|		КОГДА ДД.Количество < 0 ТОГДА ДД.КорАналитикаУчетаНоменклатуры
		|		ИНАЧЕ ДД.АналитикаУчетаНоменклатуры КОНЕЦ),
		|	(ВЫБОР 
		|		КОГДА ДД.Количество < 0 ТОГДА ДД.КорВидЗапасов
		|		ИНАЧЕ ДД.ВидЗапасов КОНЕЦ),
		|	(ВЫБОР
		|		КОГДА ДД.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВозвратОтПереработчика)
		|			ТОГДА ДД.Регистратор
		|		КОГДА ДД.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВозвратОтПереработчика2_5)
		|			ТОГДА ДД.Регистратор
		|		КОГДА ДД.Количество < 0 ТОГДА ДД.ДокументИсточник
		|		ИНАЧЕ ДД.Регистратор КОНЕЦ),
		|	ДД.НалогообложениеНДС,
		|	ДД.ХозяйственнаяОперация
		|";
КонецФункции

//++ НЕ УТ

Функция ТекстИтерацияПартийПродукции()
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстИтерацияПартийПродукции"" КАК ЗапросИсточник,
		|	45 КАК Приоритет,
		|	""Продукция"" КАК ТипЗаписи,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) КАК ВидДвижения,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КАК РазделУчета,
		|	ДД.Период КАК Период,
		|	ДД.Регистратор КАК Регистратор,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ДокументПоступления,
		|	ДД.ВидЗапасов,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка) КАК АналитикаУчетаПартий,
		|	НЕОПРЕДЕЛЕНО КАК ДокументПоступленияРасходов,
		|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) КАК СтатьяРасходов,
		|	СУММА(ДД.Количество),
		|	0 КАК Знаменатель,
		|	0 КАК Стоимость,
		|	0 КАК СтоимостьБезНДС,
		|	0 КАК СтоимостьРегл,
		|	0 КАК НДСРегл,
		|	0 КАК ПостояннаяРазница,
		|	0 КАК ВременнаяРазница,
		|	ЛОЖЬ КАК СохранятьРегл,
		|	ДД.АналитикаУчетаПродукции КАК КорАналитикаУчетаНоменклатуры,
		|	ДД.КорВидЗапасов,
		|	(ВЫБОР
		|		КОГДА ДД.ДокументИсточник = НЕОПРЕДЕЛЕНО ТОГДА ДД.ДокументПоступления
		|		ИНАЧЕ ДД.ДокументИсточник КОНЕЦ) КАК ДокументИсточник,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка) КАК НалогообложениеПартии,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка) КАК НалогообложениеНДС,
		|	ДД.АналитикаУчетаПродукции.Номенклатура КАК Продукция,
		|	ДД.АналитикаУчетаПродукции.Характеристика КАК ХарактеристикаПродукции,
		|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукции) КАК ХозяйственнаяОперация,
		|	ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка) КАК ПодразделениеРасходов,
		|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) КАК СтатьяРасходовСписания,
		|	НЕОПРЕДЕЛЕНО КАК ВариантРаспределенияРасходовУпр,
		|	НЕОПРЕДЕЛЕНО КАК ВариантРаспределенияРасходовРегл,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивовПассивов,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаСписанияНДС
		|ИЗ
		|	РегистрНакопления.ПартииНезавершенногоПроизводства КАК ДД
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		|
		|СГРУППИРОВАТЬ ПО
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ДокументПоступления,
		|	ДД.ВидЗапасов,
		|	ДД.АналитикаУчетаПродукции,
		|	ДД.КорВидЗапасов,
		|	(ВЫБОР
		|		КОГДА ДД.ДокументИсточник = НЕОПРЕДЕЛЕНО ТОГДА ДД.ДокументПоступления
		|		ИНАЧЕ ДД.ДокументИсточник КОНЕЦ)
		|";
КонецФункции
	
Функция ТекстИтерацияПартийВыпуска() // использует Выпуски
	Возврат "
		|ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	""ТекстИтерацияПартийВыпуска"" КАК ЗапросИсточник,
		|	10 КАК Приоритет,
		|	""Выпуск"" КАК ТипЗаписи,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КАК РазделУчета,
		|	ДД.Период КАК Период,
		|	ДД.Регистратор КАК Регистратор,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаПродукции КАК АналитикаУчетаНоменклатуры,
		|	ДД.Регистратор КАК ДокументПоступления,
		|	ДД.КорВидЗапасов КАК ВидЗапасов,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка) КАК АналитикаУчетаПартий,
		|	НЕОПРЕДЕЛЕНО КАК ДокументПоступленияРасходов,
		|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) КАК СтатьяРасходов,
		|	ДД.КоличествоПродукции КАК Количество,
		|	0 КАК Знаменатель,
		|	0 КАК Стоимость,
		|	0 КАК СтоимостьБезНДС,
		|	0 КАК СтоимостьРегл,
		|	0 КАК НДСРегл,
		|	0 КАК ПостояннаяРазница,
		|	0 КАК ВременнаяРазница,
		|	ЛОЖЬ КАК СохранятьРегл,
		|	ДД.АналитикаУчетаНоменклатуры КАК КорАналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов КАК КорВидЗапасов,
		|	ДД.Регистратор КАК ДокументИсточник,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка) КАК НалогообложениеПартии,
		|	НЕОПРЕДЕЛЕНО КАК НалогообложениеНДС,
		|	НЕОПРЕДЕЛЕНО КАК Продукция,
		|	НЕОПРЕДЕЛЕНО КАК ХарактеристикаПродукции,
		|	НЕОПРЕДЕЛЕНО КАК ХозяйственнаяОперация,
		|	ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка) КАК ПодразделениеРасходов,
		|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) КАК СтатьяРасходовСписания,
		|	НЕОПРЕДЕЛЕНО КАК ВариантРаспределенияРасходовУпр,
		|	НЕОПРЕДЕЛЕНО КАК ВариантРаспределенияРасходовРегл,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивовПассивов,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаСписанияНДС
		|ИЗ
		|	РегистрНакопления.ПартииНезавершенногоПроизводства КАК ДД
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		|	И (ДД.Регистратор ССЫЛКА Документ.ВыпускПродукции
		//++ НЕ УТКА
		|		ИЛИ ДД.Регистратор ССЫЛКА Документ.ОтчетДавальцу
		//-- НЕ УТКА
		|		ИЛИ ДД.Регистратор ССЫЛКА Документ.ПоступлениеОтПереработчика)
		|";
КонецФункции

Функция ТекстИтерацияОтчетПереработчика()
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстИтерацияОтчетПереработчика"" КАК ЗапросИсточник,
		|	10 КАК Приоритет,
		|	""Потребление"" КАК ТипЗаписи,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ДД.ВидДвижения,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПереданныеПереработчику) КАК РазделУчета,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ДокументПоступления,
		|	ДД.ВидЗапасов,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка) КАК АналитикаУчетаПартий,
		|	НЕОПРЕДЕЛЕНО КАК ДокументПоступленияРасходов,
		|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) КАК СтатьяРасходов,
		|	СУММА(ДД.Количество) КАК Количество,
		|	0 КАК Знаменатель,
		|	0 КАК Стоимость,
		|	0 КАК СтоимостьБезНДС,
		|	0 КАК СтоимостьРегл,
		|	0 КАК НДСРегл,
		|	0 КАК ПостояннаяРазница,
		|	0 КАК ВременнаяРазница,
		|	ЛОЖЬ КАК СохранятьРегл,
		|	ДД.АналитикаУчетаНоменклатуры КАК КорАналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов КАК КорВидЗапасов,
		|	ДД.ДокументИсточник,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка) КАК НалогообложениеПартии,
		|	ДД.НалогообложениеНДС,
		|	НЕОПРЕДЕЛЕНО КАК Продукция,
		|	НЕОПРЕДЕЛЕНО КАК ХарактеристикаПродукции,
		|	НЕОПРЕДЕЛЕНО КАК ХозяйственнаяОперация,
		|	ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка) КАК ПодразделениеРасходов,
		|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) КАК СтатьяРасходовСписания,
		|	НЕОПРЕДЕЛЕНО КАК ВариантРаспределенияРасходовУпр,
		|	НЕОПРЕДЕЛЕНО КАК ВариантРаспределенияРасходовРегл,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивовПассивов,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаСписанияНДС
		|ИЗ
		|	РегистрНакопления.ПартииПроизводственныхЗатрат КАК ДД
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И ДД.Регистратор ССЫЛКА Документ.ОтчетПереработчика
		|СГРУППИРОВАТЬ ПО
		|	ДД.ВидДвижения,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ДокументПоступления,
		|	ДД.ВидЗапасов,
		|	ДД.НалогообложениеНДС,
		|	ДД.ДокументИсточник
		|";
КонецФункции

Функция ТекстИтерацияОтчетПереработчикаРаспределение()
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстИтерацияОтчетПереработчикаРаспределение"" КАК ЗапросИсточник,
		|	90 КАК Приоритет,
		|	""Перемещение"" КАК ТипЗаписи,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КАК РазделУчета,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ДокументПоступления,
		|	ДД.ВидЗапасов,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка) КАК АналитикаУчетаПартий,
		|	НЕОПРЕДЕЛЕНО КАК ДокументПоступленияРасходов,
		|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) КАК СтатьяРасходов,
		|	СУММА(ДД.Количество) КАК Количество,
		|	0 КАК Знаменатель,
		|	0 КАК Стоимость,
		|	0 КАК СтоимостьБезНДС,
		|	0 КАК СтоимостьРегл,
		|	0 КАК НДСРегл,
		|	0 КАК ПостояннаяРазница,
		|	0 КАК ВременнаяРазница,
		|	ЛОЖЬ КАК СохранятьРегл,
		|	ДД.АналитикаУчетаНоменклатуры КАК КорАналитикаУчетаНоменклатуры,
		|	ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка) КАК КорВидЗапасов,
		|	ДД.ДокументИсточник,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка) КАК НалогообложениеПартии,
		|	НЕОПРЕДЕЛЕНО КАК НалогообложениеНДС,
		|	ДД.АналитикаУчетаПродукции.Номенклатура КАК Продукция,
		|	ДД.АналитикаУчетаПродукции.Характеристика КАК ХарактеристикаПродукции,
		|	НЕОПРЕДЕЛЕНО КАК ХозяйственнаяОперация,
		|	ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка) КАК ПодразделениеРасходов,
		|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) КАК СтатьяРасходовСписания,
		|	НЕОПРЕДЕЛЕНО КАК ВариантРаспределенияРасходовУпр,
		|	НЕОПРЕДЕЛЕНО КАК ВариантРаспределенияРасходовРегл,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивовПассивов,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаСписанияНДС
		|ИЗ
		|	РегистрНакопления.ПартииНезавершенногоПроизводства КАК ДД
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И ДД.Регистратор ССЫЛКА Документ.ОтчетПереработчика
		|СГРУППИРОВАТЬ ПО
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.АналитикаУчетаПродукции.Номенклатура,
		|	ДД.АналитикаУчетаПродукции.Характеристика,
		|	ДД.ДокументПоступления,
		|	ДД.ВидЗапасов,
		|	ДД.ДокументИсточник
		|";
КонецФункции

Функция ТекстПриходыДопРасходовПроизводственныхЗатрат() // использует ДолиСтоимости
	Возврат "
		// Приходы из партий расходов на себестоимость по списаниям на статьи производственных затрат.
		|ВЫБРАТЬ
		|	""ТекстПриходыДопРасходовПроизводственныхЗатрат"" КАК ЗапросИсточник,
		|	90 КАК Приоритет,
		|	""Затраты"" КАК ТипЗаписи,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КАК РазделУчета,
		|	ДолиСтоимости.Период КАК Период,
		|	ДолиСтоимости.Регистратор КАК Регистратор,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ДокументПоступления,
		|	ДД.ВидЗапасов,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка) КАК АналитикаУчетаПартий,
		|	НЕОПРЕДЕЛЕНО КАК ДокументПоступленияРасходов,
		|	ДД.СтатьяРасходовСписания КАК СтатьяРасходов,
		|	МАКСИМУМ(ДолиСтоимости.ДоляСтоимости) КАК Количество,
		|	0 КАК Знаменатель,
		|	0 КАК Стоимость,
		|	0 КАК СтоимостьБезНДС,
		|	0 КАК СтоимостьРегл,
		|	0 КАК НДСРегл,
		|	0 КАК ПостояннаяРазница,
		|	0 КАК ВременнаяРазница,
		|	ЛОЖЬ КАК СохранятьРегл,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КАК КорАналитикаУчетаНоменклатуры,
		|	НЕОПРЕДЕЛЕНО КАК КорВидЗапасов,
		|	НЕОПРЕДЕЛЕНО КАК ДокументИсточник,
		|	НЕОПРЕДЕЛЕНО КАК НалогообложениеПартии,
		|	ДД.НалогообложениеНДС,
		|	НЕОПРЕДЕЛЕНО КАК Продукция,
		|	НЕОПРЕДЕЛЕНО КАК ХарактеристикаПродукции,
		|	НЕОПРЕДЕЛЕНО КАК ХозяйственнаяОперация,
		|	ДолиСтоимости.ПодразделениеРасходов КАК ПодразделениеРасходов,
		|	ДД.СтатьяРасходовСписания,
		|	ДД.СтатьяРасходовСписания.ВариантРаспределенияРасходовУпр КАК ВариантРаспределенияРасходовУпр,
		|	ДД.СтатьяРасходовСписания.ВариантРаспределенияРасходовРегл КАК ВариантРаспределенияРасходовРегл,
		|	ДД.АналитикаРасходов,
		|	ДД.АналитикаАктивовПассивов,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаСписанияНДС
		|ИЗ
		|	РегистрНакопления.ПартииТоваровОрганизаций КАК ДД
		|	ЛЕВОЕ СОЕДИНЕНИЕ ПодразделенияРегистраторов КАК ПодразделенияРегистраторов
		|		ПО ПодразделенияРегистраторов.Регистратор = ДД.Регистратор
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ПланВидовХарактеристик.СтатьиРасходов КАК Статья
		|		ПО Статья.Ссылка = ДД.СтатьяРасходовСписания
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ДолиСтоимости КАК ДолиСтоимости
		|		ПО ДолиСтоимости.Организация = ДД.Организация
		|		И ДолиСтоимости.СтатьяРасходов = ДД.СтатьяРасходовСписания
		|		И ДолиСтоимости.АналитикаРасходов = ДД.АналитикаРасходов
		|		И ДолиСтоимости.НаправлениеДеятельности = ЕСТЬNULL(ДД.АналитикаУчетаНоменклатуры.Назначение.НаправлениеДеятельности,ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка))
		|		И ДолиСтоимости.ПодразделениеРасходов = ЕСТЬNULL(ПодразделенияРегистраторов.Подразделение, ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка))
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		|	И ДД.ХозяйственнаяОперация <> ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПередачаВПроизводство)
		|	И (Статья.ВариантРаспределенияРасходовУпр = ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаПроизводственныеЗатраты)
		|		ИЛИ Статья.ВариантРаспределенияРасходовРегл = ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаПроизводственныеЗатраты))
		|	И ДД.ДокументИсточник <> НЕОПРЕДЕЛЕНО
		|	И &ЕстьФИФОСкользящая
		|СГРУППИРОВАТЬ ПО
		|	ДолиСтоимости.Период,
		|	ДолиСтоимости.Регистратор,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ДокументПоступления,
		|	ДД.ВидЗапасов,
		|	ДД.СтатьяРасходовСписания,
		|	ДД.НалогообложениеНДС,
		|	ДД.СтатьяРасходовСписания,
		|	ДД.АналитикаРасходов,
		|	ДД.АналитикаАктивовПассивов,
		|	ДолиСтоимости.ПодразделениеРасходов
		|";
КонецФункции

Функция ТекстПриходыДопРасходовПроизводственныхЗатратПрочее() // использует ДолиСтоимости
	Возврат "
		// Приходы из партий расходов на себестоимость по списаниям на статьи производственных затрат.
		|ВЫБРАТЬ
		|	""ТекстПриходыДопРасходовПроизводственныхЗатратПрочее"" КАК ЗапросИсточник,
		|	90 КАК Приоритет,
		|	""Затраты"" КАК ТипЗаписи,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КАК РазделУчета,
		|	ДолиСтоимости.Период КАК Период,
		|	ДолиСтоимости.Регистратор КАК Регистратор,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ДокументПоступления,
		|	ДД.ВидЗапасов,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка) КАК АналитикаУчетаПартий,
		|	НЕОПРЕДЕЛЕНО КАК ДокументПоступленияРасходов,
		|	ДД.СтатьяРасходовСписания КАК СтатьяРасходов,
		|	МАКСИМУМ(ДолиСтоимости.ДоляСтоимости) КАК Количество,
		|	0 КАК Знаменатель,
		|	0 КАК Стоимость,
		|	0 КАК СтоимостьБезНДС,
		|	0 КАК СтоимостьРегл,
		|	0 КАК НДСРегл,
		|	0 КАК ПостояннаяРазница,
		|	0 КАК ВременнаяРазница,
		|	ЛОЖЬ КАК СохранятьРегл,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КАК КорАналитикаУчетаНоменклатуры,
		|	НЕОПРЕДЕЛЕНО КАК КорВидЗапасов,
		|	ДД.Регистратор КАК ДокументИсточник,
		|	НЕОПРЕДЕЛЕНО КАК НалогообложениеПартии,
		|	ДД.НалогообложениеНДС,
		|	НЕОПРЕДЕЛЕНО КАК Продукция,
		|	НЕОПРЕДЕЛЕНО КАК ХарактеристикаПродукции,
		|	НЕОПРЕДЕЛЕНО КАК ХозяйственнаяОперация,
		|	ДолиСтоимости.ПодразделениеРасходов КАК ПодразделениеРасходов,
		|	ДД.СтатьяРасходовСписания,
		|	ДД.СтатьяРасходовСписания.ВариантРаспределенияРасходовУпр КАК ВариантРаспределенияРасходовУпр,
		|	ДД.СтатьяРасходовСписания.ВариантРаспределенияРасходовРегл КАК ВариантРаспределенияРасходовРегл,
		|	ДД.АналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивовПассивов,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаСписанияНДС
		|ИЗ
		|	РегистрНакопления.ПартииПроизводственныхЗатрат КАК ДД
		|	ЛЕВОЕ СОЕДИНЕНИЕ ПодразделенияРегистраторов КАК ПодразделенияРегистраторов
		|		ПО ПодразделенияРегистраторов.Регистратор = ДД.Регистратор
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ПланВидовХарактеристик.СтатьиРасходов КАК Статья
		|		ПО Статья.Ссылка = ДД.СтатьяРасходовСписания
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ДолиСтоимости КАК ДолиСтоимости
		|		ПО ДолиСтоимости.Организация = ДД.Организация
		|		И ДолиСтоимости.СтатьяРасходов = ДД.СтатьяРасходовСписания
		|		И ДолиСтоимости.АналитикаРасходов = ДД.АналитикаРасходов
		|		И ДолиСтоимости.НаправлениеДеятельности = ЕСТЬNULL(ДД.АналитикаУчетаНоменклатуры.Назначение.НаправлениеДеятельности,ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка))
		|		И ДолиСтоимости.ПодразделениеРасходов = ЕСТЬNULL(ПодразделенияРегистраторов.Подразделение, ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка))
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		|	И (Статья.ВариантРаспределенияРасходовУпр = ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаПроизводственныеЗатраты)
		|		ИЛИ Статья.ВариантРаспределенияРасходовРегл = ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаПроизводственныеЗатраты))
		|	И ДД.ДокументИсточник <> НЕОПРЕДЕЛЕНО
		|	И &ЕстьФИФОСкользящая
		|СГРУППИРОВАТЬ ПО
		|	ДолиСтоимости.Период,
		|	ДолиСтоимости.Регистратор,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ДокументПоступления,
		|	ДД.ВидЗапасов,
		|	ДД.Регистратор,
		|	ДД.НалогообложениеНДС,
		|	ДД.СтатьяРасходовСписания,
		|	ДД.АналитикаРасходов,
		|	ДолиСтоимости.ПодразделениеРасходов
		|";
КонецФункции

Функция ТекстРаспределениеДопРасходовПроизводственныхЗатрат()
	Возврат "
		// распределение производственных затрат на документы выпуска продукции
		|ВЫБРАТЬ
		|	""ТекстРаспределениеДопРасходовПроизводственныхЗатрат"" КАК ЗапросИсточник,
		|	90 КАК Приоритет,
		|	""Распределение"" КАК ТипЗаписи,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) КАК ВидДвижения,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КАК РазделУчета,
		|	ДД.Период КАК Период,
		|	ДД.Регистратор КАК Регистратор,
		|	ДД.Организация КАК Организация,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КАК АналитикаУчетаНоменклатуры,
		|	НЕОПРЕДЕЛЕНО КАК ДокументПоступления,
		|	НЕОПРЕДЕЛЕНО КАК ВидЗапасов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаПартий,
		|	НЕОПРЕДЕЛЕНО КАК ДокументПоступленияРасходов,
		|	ДД.СтатьяРасходов КАК СтатьяРасходов,
		|	СУММА(ДД.ДоляСтоимости) КАК Количество,
		|	0 КАК Знаменатель,
		|	0 КАК Стоимость,
		|	0 КАК СтоимостьБезНДС,
		|	0 КАК СтоимостьРегл,
		|	0 КАК НДСРегл,
		|	0 КАК ПостояннаяРазница,
		|	0 КАК ВременнаяРазница,
		|	ЛОЖЬ КАК СохранятьРегл,
		|	ДД.АналитикаУчетаПродукции КАК КорАналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов КАК КорВидЗапасов,
		|	ДД.ДокументИсточник КАК ДокументИсточник,
		|	НЕОПРЕДЕЛЕНО КАК НалогообложениеПартии,
		|	НЕОПРЕДЕЛЕНО КАК НалогообложениеНДС,
		|	НЕОПРЕДЕЛЕНО КАК Продукция,
		|	НЕОПРЕДЕЛЕНО КАК ХарактеристикаПродукции,
		|	НЕОПРЕДЕЛЕНО КАК ХозяйственнаяОперация,
		|	ДД.ДокументИсточник.Подразделение КАК ПодразделениеРасходов,
		|	ДД.СтатьяРасходов КАК СтатьяРасходовСписания,
		|	ДД.СтатьяРасходов.ВариантРаспределенияРасходовУпр КАК ВариантРаспределенияРасходовУпр,
		|	ДД.СтатьяРасходов.ВариантРаспределенияРасходовРегл КАК ВариантРаспределенияРасходовРегл,
		|	ДД.АналитикаРасходов КАК АналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивовПассивов,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаСписанияНДС
		|ИЗ
		|	РегистрНакопления.ПрочиеРасходыНезавершенногоПроизводства КАК ДД
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		|	И ДД.ДоляСтоимости <> 0
		|	И НЕ ДД.Регистратор ССЫЛКА Документ.РасчетСебестоимостиТоваров
		|	И НЕ ДД.РасчетСебестоимости
		|	И &ЕстьФИФОСкользящая
		|СГРУППИРОВАТЬ ПО
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.ДокументИсточник,
		|	ДД.АналитикаУчетаПродукции,
		|	ДД.ВидЗапасов,
		|	ДД.СтатьяРасходов,
		|	ДД.АналитикаРасходов
		|";
КонецФункции

Функция ТекстВыпускИзДопРасходовПроизводственныхЗатрат()
	Возврат "
		// распределение производственных затрат на документы выпуска продукции
		|ВЫБРАТЬ
		|	""ТекстВыпускИзДопРасходовПроизводственныхЗатрат"" КАК ЗапросИсточник,
		|	90 КАК Приоритет,
		|	""ВыпускПрочие"" КАК ТипЗаписи,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КАК РазделУчета,
		|	ДД.Период КАК Период,
		|	ДД.Регистратор КАК Регистратор,
		|	ДД.Организация КАК Организация,
		|	ДД.АналитикаУчетаПродукции КАК АналитикаУчетаНоменклатуры,
		|	ДД.Регистратор КАК ДокументПоступления,
		|	ДД.ВидЗапасов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаПартий,
		|	НЕОПРЕДЕЛЕНО КАК ДокументПоступленияРасходов,
		|	ДД.СтатьяРасходов КАК СтатьяРасходов,
		|	СУММА(ДД.ДоляСтоимости) КАК Количество,
		|	МАКСИМУМ(ДД.КоличествоПродукции) КАК Знаменатель,
		|	0 КАК Стоимость,
		|	0 КАК СтоимостьБезНДС,
		|	0 КАК СтоимостьРегл,
		|	0 КАК НДСРегл,
		|	0 КАК ПостояннаяРазница,
		|	0 КАК ВременнаяРазница,
		|	ЛОЖЬ КАК СохранятьРегл,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаУчетаНоменклатуры,
		|	НЕОПРЕДЕЛЕНО КАК КорВидЗапасов,
		|	ДД.ДокументИсточник КАК ДокументИсточник,
		|	НЕОПРЕДЕЛЕНО КАК НалогообложениеПартии,
		|	НЕОПРЕДЕЛЕНО КАК НалогообложениеНДС,
		|	НЕОПРЕДЕЛЕНО КАК Продукция,
		|	НЕОПРЕДЕЛЕНО КАК ХарактеристикаПродукции,
		|	НЕОПРЕДЕЛЕНО КАК ХозяйственнаяОперация,
		|	ДД.ДокументИсточник.Подразделение КАК ПодразделениеРасходов,
		|	ДД.СтатьяРасходов КАК СтатьяРасходовСписания,
		|	ДД.СтатьяРасходов.ВариантРаспределенияРасходовУпр КАК ВариантРаспределенияРасходовУпр,
		|	ДД.СтатьяРасходов.ВариантРаспределенияРасходовРегл КАК ВариантРаспределенияРасходовРегл,
		|	ДД.АналитикаРасходов КАК АналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивовПассивов,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаСписанияНДС
		|ИЗ
		|	РегистрНакопления.ПрочиеРасходыНезавершенногоПроизводства КАК ДД
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		|	И ДД.ДоляСтоимости <> 0
		|	И НЕ ДД.Регистратор ССЫЛКА Документ.РасчетСебестоимостиТоваров
		|	И НЕ ДД.РасчетСебестоимости
		|	И &ЕстьФИФОСкользящая
		|СГРУППИРОВАТЬ ПО
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.ВидЗапасов,
		|	ДД.ДокументИсточник,
		|	ДД.АналитикаУчетаПродукции,
		|	ДД.СтатьяРасходов,
		|	ДД.АналитикаРасходов
		|";
КонецФункции

Функция ТекстДопРасходыПроизводственныхЗатратПрочее()
	Возврат "
		// отнесение доп.расходов производственных затрат на другие статьи расходов
		|ВЫБРАТЬ
		|	""ТекстДопРасходыПроизводственныхЗатратПрочее"" КАК ЗапросИсточник,
		|	90 КАК Приоритет,
		|	""Прочее"" КАК ТипЗаписи,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) КАК ВидДвижения,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КАК РазделУчета,
		|	ДД.Дата КАК Период,
		|	ДД.Ссылка КАК Регистратор,
		|	ДД.Организация,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КАК АналитикаУчетаНоменклатуры,
		|	НЕОПРЕДЕЛЕНО КАК ДокументПоступления,
		|	НЕОПРЕДЕЛЕНО КАК ВидЗапасов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаПартий,
		|	НЕОПРЕДЕЛЕНО КАК ДокументПоступленияРасходов,
		|	ДД.СтатьяРасходов КАК СтатьяРасходов,
		|	СУММА(Строки.ДоляСтоимости) КАК Количество,
		|	СУММА(Строки.ДоляСтоимости) КАК Знаменатель,
		|	0 КАК Стоимость,
		|	0 КАК СтоимостьБезНДС,
		|	0 КАК СтоимостьРегл,
		|	0 КАК НДСРегл,
		|	0 КАК ПостояннаяРазница,
		|	0 КАК ВременнаяРазница,
		|	ЛОЖЬ КАК СохранятьРегл,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаУчетаНоменклатуры,
		|	НЕОПРЕДЕЛЕНО КАК КорВидЗапасов,
		|	НЕОПРЕДЕЛЕНО КАК ДокументИсточник,
		|	НЕОПРЕДЕЛЕНО КАК НалогообложениеПартии,
		|	НЕОПРЕДЕЛЕНО КАК НалогообложениеНДС,
		|	НЕОПРЕДЕЛЕНО КАК Продукция,
		|	НЕОПРЕДЕЛЕНО КАК ХарактеристикаПродукции,
		|	НЕОПРЕДЕЛЕНО КАК ХозяйственнаяОперация,
		|	ДД.Подразделение КАК ПодразделениеРасходов,
		|	Строки.СтатьяРасходов КАК СтатьяРасходовСписания,
		|	Строки.СтатьяРасходов.ВариантРаспределенияРасходовУпр КАК ВариантРаспределенияРасходовУпр,
		|	Строки.СтатьяРасходов.ВариантРаспределенияРасходовРегл КАК ВариантРаспределенияРасходовРегл,
		|	ДД.АналитикаРасходов КАК АналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивовПассивов,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаСписанияНДС
		|ИЗ
		|	Документ.РаспределениеПрочихЗатрат КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.РаспределениеПрочихЗатрат.Списание КАК Строки
		| 		ПО Строки.Ссылка = ДД.Ссылка
		|ГДЕ
		|	ДД.Дата МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Проведен
		|	И Строки.ДоляСтоимости <> 0
		|	И &ЕстьФИФОСкользящая
		|СГРУППИРОВАТЬ ПО
		|	ДД.Дата,
		|	ДД.Ссылка,
		|	ДД.Организация,
		|	ДД.СтатьяРасходов,
		|	Строки.СтатьяРасходов,
		|	ДД.АналитикаРасходов,
		|	ДД.Подразделение
		|";
КонецФункции

Функция ТекстДопРасходыПроизводственныхЗатратСписание()
	Возврат "
		// отнесение доп.расходов производственных затрат на другие статьи расходов
		|ВЫБРАТЬ
		|	""ТекстДопРасходыПроизводственныхЗатратСписание"" КАК ЗапросИсточник,
		|	90 КАК Приоритет,
		|	""Списание"" КАК ТипЗаписи,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) КАК ВидДвижения,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КАК РазделУчета,
		|	ДД.Дата КАК Период,
		|	ДД.Ссылка КАК Регистратор,
		|	ДД.Организация,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КАК АналитикаУчетаНоменклатуры,
		|	НЕОПРЕДЕЛЕНО КАК ДокументПоступления,
		|	НЕОПРЕДЕЛЕНО КАК ВидЗапасов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаПартий,
		|	НЕОПРЕДЕЛЕНО КАК ДокументПоступленияРасходов,
		|	ДД.СтатьяРасходов КАК СтатьяРасходов,
		|	СУММА(Строки.ДоляСтоимости) КАК Количество,
		|	СУММА(Строки.ДоляСтоимости) КАК Знаменатель,
		|	0 КАК Стоимость,
		|	0 КАК СтоимостьБезНДС,
		|	0 КАК СтоимостьРегл,
		|	0 КАК НДСРегл,
		|	0 КАК ПостояннаяРазница,
		|	0 КАК ВременнаяРазница,
		|	ЛОЖЬ КАК СохранятьРегл,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаУчетаНоменклатуры,
		|	НЕОПРЕДЕЛЕНО КАК КорВидЗапасов,
		|	НЕОПРЕДЕЛЕНО КАК ДокументИсточник,
		|	НЕОПРЕДЕЛЕНО КАК НалогообложениеПартии,
		|	НЕОПРЕДЕЛЕНО КАК НалогообложениеНДС,
		|	НЕОПРЕДЕЛЕНО КАК Продукция,
		|	НЕОПРЕДЕЛЕНО КАК ХарактеристикаПродукции,
		|	НЕОПРЕДЕЛЕНО КАК ХозяйственнаяОперация,
		|	ДД.Подразделение КАК ПодразделениеРасходов,
		|	Строки.СтатьяРасходов КАК СтатьяРасходовСписания,
		|	Строки.СтатьяРасходов.ВариантРаспределенияРасходовУпр КАК ВариантРаспределенияРасходовУпр,
		|	Строки.СтатьяРасходов.ВариантРаспределенияРасходовРегл КАК ВариантРаспределенияРасходовРегл,
		|	Строки.АналитикаРасходов КАК АналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивовПассивов,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаСписанияНДС
		|ИЗ
		|	Документ.РаспределениеПрочихЗатрат КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.РаспределениеПрочихЗатрат.Списание КАК Строки
		| 		ПО Строки.Ссылка = ДД.Ссылка
		|ГДЕ
		|	ДД.Дата МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Проведен
		|	И Строки.ДоляСтоимости <> 0
		|	И &ЕстьФИФОСкользящая
		|СГРУППИРОВАТЬ ПО
		|	ДД.Дата,
		|	ДД.Ссылка,
		|	ДД.Организация,
		|	ДД.СтатьяРасходов,
		|	Строки.СтатьяРасходов,
		|	Строки.АналитикаРасходов,
		|	ДД.Подразделение
		|";
КонецФункции

Функция ТекстДопРасходыСписаниеВПроизводстве()
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстДопРасходыСписаниеВПроизводстве"" КАК ЗапросИсточник,
		|	90 КАК Приоритет,
		|	""Потребление"" КАК ТипЗаписи,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ДД.ВидДвижения,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КАК РазделУчета,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ДокументПоступления,
		|	ДД.ВидЗапасов,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка) КАК АналитикаУчетаПартий,
		|	НЕОПРЕДЕЛЕНО КАК ДокументПоступленияРасходов,
		|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) КАК СтатьяРасходов,
		|	СУММА(ДД.Количество) КАК Количество,
		|	0 КАК Знаменатель,
		|	0 КАК Стоимость,
		|	0 КАК СтоимостьБезНДС,
		|	0 КАК СтоимостьРегл,
		|	0 КАК НДСРегл,
		|	0 КАК ПостояннаяРазница,
		|	0 КАК ВременнаяРазница,
		|	ЛОЖЬ КАК СохранятьРегл,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаУчетаНоменклатуры,
		|	НЕОПРЕДЕЛЕНО КАК КорВидЗапасов,
		|	ДД.ДокументИсточник,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка) КАК НалогообложениеПартии,
		|	ДД.НалогообложениеНДС,
		|	НЕОПРЕДЕЛЕНО КАК Продукция,
		|	НЕОПРЕДЕЛЕНО КАК ХарактеристикаПродукции,
		|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПустаяСсылка) КАК ХозяйственнаяОперация,
		|	ДД.ПодразделениеРасходов КАК ПодразделениеРасходов,
		|	ДД.СтатьяРасходовСписания,
		|	ДД.СтатьяРасходовСписания.ВариантРаспределенияРасходовУпр КАК ВариантРаспределенияРасходовУпр,
		|	ДД.СтатьяРасходовСписания.ВариантРаспределенияРасходовРегл КАК ВариантРаспределенияРасходовРегл,
		|	ДД.АналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивовПассивов,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаСписанияНДС
		|ИЗ
		|	РегистрНакопления.ПартииПроизводственныхЗатрат КАК ДД
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		|	И ДД.Регистратор ССЫЛКА Документ.РаспределениеПроизводственныхЗатрат
		|	И ДД.СтатьяРасходовСписания <> ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка)
		|	И ДД.СтатьяРасходовСписания <> НЕОПРЕДЕЛЕНО
		|СГРУППИРОВАТЬ ПО
		|	ДД.ВидДвижения,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ДокументПоступления,
		|	ДД.ВидЗапасов,
		|	ДД.ДокументИсточник,
		|	ДД.НалогообложениеНДС,
		|	ДД.СтатьяРасходовСписания,
		|	ДД.АналитикаРасходов,
		|	ДД.ПодразделениеРасходов
		|";
КонецФункции

Функция ТекстИтерацияВозвратИзПроизводстваИЛИОтПереработчика()
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстИтерацияВозвратИзПроизводстваИЛИОтПереработчика"" КАК ЗапросИсточник,
		|	90 КАК Приоритет,
		|	""Потребление"" КАК ТипЗаписи,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) КАК ВидДвижения,
		|	(ВЫБОР
		|		КОГДА ДД.Регистратор ССЫЛКА Документ.ВозвратСырьяОтПереработчика
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПереданныеПереработчику)
		|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КОНЕЦ) КАК РазделУчета,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.КорАналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
		|	ДД.ДокументПоступления,
		|	ДД.КорВидЗапасов КАК ВидЗапасов,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка) КАК АналитикаУчетаПартий,
		|	НЕОПРЕДЕЛЕНО КАК ДокументПоступленияРасходов,
		|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) КАК СтатьяРасходов,
		|	СУММА(-ДД.Количество) КАК Количество,
		|	0 КАК Знаменатель,
		|	0 КАК Стоимость,
		|	0 КАК СтоимостьБезНДС,
		|	0 КАК СтоимостьРегл,
		|	0 КАК НДСРегл,
		|	0 КАК ПостояннаяРазница,
		|	0 КАК ВременнаяРазница,
		|	ЛОЖЬ КАК СохранятьРегл,
		|	ДД.АналитикаУчетаНоменклатуры КАК КорАналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов КАК КорВидЗапасов,
		|	ДД.ДокументИсточник,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка) КАК НалогообложениеПартии,
		|	ДД.НалогообложениеНДС,
		|	НЕОПРЕДЕЛЕНО КАК Продукция,
		|	НЕОПРЕДЕЛЕНО КАК ХарактеристикаПродукции,
		|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПустаяСсылка) КАК ХозяйственнаяОперация,
		|	ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка) КАК ПодразделениеРасходов,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяРасходовСписания,
		|	НЕОПРЕДЕЛЕНО КАК ВариантРаспределенияРасходовУпр,
		|	НЕОПРЕДЕЛЕНО КАК ВариантРаспределенияРасходовРегл,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивовПассивов,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаСписанияНДС
		|ИЗ
		|	РегистрНакопления.ПартииТоваровОрганизаций КАК ДД
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И (ДД.Регистратор ССЫЛКА Документ.ВозвратСырьяОтПереработчика
		|		ИЛИ ДД.Регистратор ССЫЛКА Документ.ВозвратМатериаловИзПроизводства)
		|СГРУППИРОВАТЬ ПО
		|	(ВЫБОР
		|		КОГДА ДД.Регистратор ССЫЛКА Документ.ВозвратСырьяОтПереработчика
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПереданныеПереработчику)
		|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КОНЕЦ),
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ДокументПоступления,
		|	ДД.ВидЗапасов,
		|	ДД.КорАналитикаУчетаНоменклатуры,
		|	ДД.КорВидЗапасов,
		|	ДД.ДокументИсточник,
		|	ДД.НалогообложениеНДС
		|";
КонецФункции

Функция ТекстИтерацияВозвратИзПроизводстваИЛИОтПереработчикаНаСклад()
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстИтерацияВозвратИзПроизводстваИЛИОтПереработчикаНаСклад"" КАК ЗапросИсточник,
		|	10 КАК Приоритет,
		|	""Перемещение"" КАК ТипЗаписи,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КАК РазделУчета,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ДокументПоступления,
		|	ДД.ВидЗапасов,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка) КАК АналитикаУчетаПартий,
		|	НЕОПРЕДЕЛЕНО КАК ДокументПоступленияРасходов,
		|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) КАК СтатьяРасходов,
		|	СУММА(-ДД.Количество) КАК Количество,
		|	0 КАК Знаменатель,
		|	0 КАК Стоимость,
		|	0 КАК СтоимостьБезНДС,
		|	0 КАК СтоимостьРегл,
		|	0 КАК НДСРегл,
		|	0 КАК ПостояннаяРазница,
		|	0 КАК ВременнаяРазница,
		|	ЛОЖЬ КАК СохранятьРегл,
		|	ДД.КорАналитикаУчетаНоменклатуры,
		|	ДД.КорВидЗапасов,
		|	ДД.Регистратор КАК ДокументИсточник,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка) КАК НалогообложениеПартии,
		|	ДД.НалогообложениеНДС,
		|	НЕОПРЕДЕЛЕНО КАК Продукция,
		|	НЕОПРЕДЕЛЕНО КАК ХарактеристикаПродукции,
		|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПустаяСсылка) КАК ХозяйственнаяОперация,
		|	ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка) КАК ПодразделениеРасходов,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяРасходовСписания,
		|	НЕОПРЕДЕЛЕНО КАК ВариантРаспределенияРасходовУпр,
		|	НЕОПРЕДЕЛЕНО КАК ВариантРаспределенияРасходовРегл,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивовПассивов,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаСписанияНДС
		|ИЗ
		|	РегистрНакопления.ПартииТоваровОрганизаций КАК ДД
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И (ДД.Регистратор ССЫЛКА Документ.ВозвратСырьяОтПереработчика
		|		ИЛИ ДД.Регистратор ССЫЛКА Документ.ВозвратМатериаловИзПроизводства)
		|СГРУППИРОВАТЬ ПО
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ДокументПоступления,
		|	ДД.ВидЗапасов,
		|	ДД.КорАналитикаУчетаНоменклатуры,
		|	ДД.КорВидЗапасов,
		|	ДД.НалогообложениеНДС
		|";
КонецФункции
//-- НЕ УТ

//++ НЕ УТКА

Функция ТекстИтерацияОтчетДавальцу()
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстИтерацияОтчетДавальцу"" КАК ЗапросИсточник,
		|	10 КАК Приоритет,
		|	""Потребление"" КАК ТипЗаписи,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) КАК ВидДвижения,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КАК РазделУчета,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.Регистратор КАК ДокументПоступления,
		|	ДД.ВидЗапасов,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка) КАК АналитикаУчетаПартий,
		|	НЕОПРЕДЕЛЕНО КАК ДокументПоступленияРасходов,
		|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) КАК СтатьяРасходов,
		|	СУММА(ДД.Количество) КАК Количество,
		|	0 КАК Знаменатель,
		|	0 КАК Стоимость,
		|	0 КАК СтоимостьБезНДС,
		|	0 КАК СтоимостьРегл,
		|	0 КАК НДСРегл,
		|	0 КАК ПостояннаяРазница,
		|	0 КАК ВременнаяРазница,
		|	ЛОЖЬ КАК СохранятьРегл,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаУчетаНоменклатуры,
		|	НЕОПРЕДЕЛЕНО КАК КорВидЗапасов,
		|	ДД.Регистратор КАК ДокументИсточник,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка) КАК НалогообложениеПартии,
		|	НЕОПРЕДЕЛЕНО КАК НалогообложениеНДС,
		|	НЕОПРЕДЕЛЕНО КАК Продукция,
		|	НЕОПРЕДЕЛЕНО КАК ХарактеристикаПродукции,
		|	НЕОПРЕДЕЛЕНО КАК ХозяйственнаяОперация,
		|	ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка) КАК ПодразделениеРасходов,
		|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) КАК СтатьяРасходовСписания,
		|	НЕОПРЕДЕЛЕНО КАК ВариантРаспределенияРасходовУпр,
		|	НЕОПРЕДЕЛЕНО КАК ВариантРаспределенияРасходовРегл,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивовПассивов,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаСписанияНДС
		|ИЗ
		|	РегистрНакопления.ВыпускПродукции КАК ДД
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И ДД.Регистратор ССЫЛКА Документ.ОтчетДавальцу
		|СГРУППИРОВАТЬ ПО
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов
		|";
КонецФункции
//-- НЕ УТКА

Функция ТекстИтерацияПартийРаботИПеремещенияВПроизводстве()
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстИтерацияПартийРаботИПеремещенияВПроизводстве"" КАК ЗапросИсточник,
		|	(ВЫБОР 
		|		КОГДА ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) ТОГДА 90
		|		ИНАЧЕ 10 КОНЕЦ) КАК Приоритет,
		|	(ВЫБОР 
		|		КОГДА ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) ТОГДА ""Потребление""
		|		ИНАЧЕ ""Перемещение"" КОНЕЦ) КАК ТипЗаписи,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ДД.ВидДвижения,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КАК РазделУчета,
		|	ДД.Период КАК Период,
		|	ДД.Регистратор КАК Регистратор,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
		|	ДД.ДокументПоступления,
		|	ДД.ВидЗапасов КАК ВидЗапасов,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка) КАК АналитикаУчетаПартий,
		|	НЕОПРЕДЕЛЕНО КАК ДокументПоступленияРасходов,
		|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) КАК СтатьяРасходов,
		|	СУММА(ДД.Количество) КАК Количество,
		|	0 КАК Знаменатель,
		|	0 КАК Стоимость,
		|	0 КАК СтоимостьБезНДС,
		|	0 КАК СтоимостьРегл,
		|	0 КАК НДСРегл,
		|	0 КАК ПостояннаяРазница,
		|	0 КАК ВременнаяРазница,
		|	ЛОЖЬ КАК СохранятьРегл,
		|	(ВЫБОР
		|		КОГДА ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		//++ НЕ УТКА
		|		И (Не Перемещение.Ссылка ЕСТЬ NULL)
		//-- НЕ УТКА
		|			ТОГДА ДД.КорАналитикаУчетаНоменклатуры
		|		ИНАЧЕ ДД.АналитикаУчетаНоменклатуры КОНЕЦ) КАК КорАналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов КАК КорВидЗапасов,
		|	(ВЫБОР
		|		КОГДА ДД.ДокументИсточник = НЕОПРЕДЕЛЕНО ТОГДА ДД.ДокументПоступления
		|		ИНАЧЕ ДД.ДокументИсточник КОНЕЦ) КАК ДокументИсточник,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка) КАК НалогообложениеПартии,
		|	ДД.НалогообложениеНДС,
		|	НЕОПРЕДЕЛЕНО КАК Продукция,
		|	НЕОПРЕДЕЛЕНО КАК ХарактеристикаПродукции,
		|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПустаяСсылка) КАК ХозяйственнаяОперация,
		|	ДД.ПодразделениеРасходов КАК ПодразделениеРасходов,
		|	ДД.СтатьяРасходовСписания КАК СтатьяРасходовСписания,
		|	НЕОПРЕДЕЛЕНО КАК ВариантРаспределенияРасходовУпр,
		|	НЕОПРЕДЕЛЕНО КАК ВариантРаспределенияРасходовРегл,
		|	ДД.АналитикаРасходов КАК АналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивовПассивов,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаСписанияНДС
		|ИЗ
		|	РегистрНакопления.ПартииПроизводственныхЗатрат КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Номенклатура КАК Работы
		|		ПО Работы.Ссылка = ДД.АналитикаУчетаНоменклатуры.Номенклатура
		//++ НЕ УТКА
		|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.ПеремещениеМатериаловВПроизводстве КАК Перемещение
		|		ПО Перемещение.Дата МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|		И Перемещение.Ссылка = ДД.Регистратор
		//-- НЕ УТКА
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И (Работы.ТипНоменклатуры = ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.Работа)
		//++ НЕ УТКА
		|		ИЛИ НЕ Перемещение.Ссылка ЕСТЬ NULL
		//-- НЕ УТКА
		|		)
		//++ НЕ УТКА
		|	И НЕ ДД.Регистратор ССЫЛКА Документ.МаршрутныйЛистПроизводства
		|	И НЕ ДД.Регистратор ССЫЛКА Документ.СписаниеЗатратНаВыпуск
		|	И НЕ ДД.Регистратор ССЫЛКА Документ.РаспределениеПроизводственныхЗатрат
		//-- НЕ УТКА
		|	И НЕ ДД.Регистратор ССЫЛКА Документ.ПриобретениеТоваровУслуг
		//++ НЕ УТ
		|	И НЕ ДД.Регистратор ССЫЛКА Документ.ВозвратМатериаловИзПроизводства
		|	И НЕ (ДД.Регистратор ССЫЛКА Документ.ВыпускПродукции И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход))
		//-- НЕ УТ
		|СГРУППИРОВАТЬ ПО
		|	(ВЫБОР 
		|		КОГДА ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) ТОГДА 90
		|		ИНАЧЕ 10 КОНЕЦ),
		|	(ВЫБОР 
		|		КОГДА ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) ТОГДА ""Потребление""
		|		ИНАЧЕ ""Перемещение"" КОНЕЦ),
		|	ДД.ВидДвижения,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ДокументПоступления,
		|	ДД.ВидЗапасов,
		|	(ВЫБОР
		|		КОГДА ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		//++ НЕ УТКА
		|		И (Не Перемещение.Ссылка ЕСТЬ NULL)
		//-- НЕ УТКА
		|			ТОГДА ДД.КорАналитикаУчетаНоменклатуры
		|		ИНАЧЕ ДД.АналитикаУчетаНоменклатуры КОНЕЦ),
		|	(ВЫБОР 
		|		КОГДА ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) ТОГДА ДД.ДокументПоступления
		|		ИНАЧЕ ДД.Регистратор КОНЕЦ),
		|	(ВЫБОР
		|		КОГДА ДД.ДокументИсточник = НЕОПРЕДЕЛЕНО ТОГДА ДД.ДокументПоступления
		|		ИНАЧЕ ДД.ДокументИсточник КОНЕЦ),
		|	ДД.НалогообложениеНДС,
		|	ДД.ПодразделениеРасходов,
		|	ДД.СтатьяРасходовСписания,
		|	ДД.АналитикаРасходов
		|";
КонецФункции

#КонецОбласти


//++ НЕ УТ
#Область РаспределениеМатериаловИРабот

// В партионном учете версии 2.2 - этап 7, РаспределениеМатериаловИРаботПоБазе

Функция ДанныеДляРаспределенияМатериаловИРабот(НачалоПериода, ОкончаниеПериода, МассивОрганизаций)
	
	ТекстСортировка = "
		|УПОРЯДОЧИТЬ ПО
		|	Период, Регистратор, ТипЗаписи
		|";
	ТекстИндексы = "
		|ИНДЕКСИРОВАТЬ ПО
		|	Подразделение
		|";
	
	ИсходныйТекстЗапроса =
		ТекстРаспределениеМатериаловИРаботИнициализация() + ";" // вт ОтборПоМатериалам, КРаспределению 
		+ ТекстДанныеПоУказаннымМатериалам() + ";" // вт ДанныеПоУказаннымМатериалам
		+ ТекстДанныеПоПродукции() + ";" //вт Данные_ПоПродукции
		+ ТекстДанныеПоПлановойСтоимости() + ";" //вт Данные_ПоПлановойСтоимости
		+ ТекстДанныеПоУказаннымТрудозатратам() + ";" //вт Данные_ПоУказаннымТрудозатратам
		+ ТекстДанныеПоНормативамРасходаМатериала() + ";" //вт Данные_ПоНормативамРасходаМатериала
		+ ТекстРаспаковкаНаборов() + ";" // вт МатериалыИУслугиСпецификаций
		+ ТекстБазаРаспределения() + ";" // вт БазаРаспределения
		+ ТекстСуммыПоказателей() + ";" // вт ОбщиеСуммы
		+ ТекстОписаниеРаспределениеМатериаловИРабот()
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстКРаспределению()
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстРаспределениеПоБазе()
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстДополнение()
		+ ТекстСортировка;
	
	МВТ = Новый МенеджерВременныхТаблиц;
	
	ИсходныйТекстЗапроса = СтрЗаменить(ИсходныйТекстЗапроса, "&Вес", Справочники.УпаковкиЕдиницыИзмерения.ТекстЗапросаВесУпаковки("СН.ЕдиницаИзмерения", "СН"));
	ИсходныйТекстЗапроса = СтрЗаменить(ИсходныйТекстЗапроса, "&Объем", Справочники.УпаковкиЕдиницыИзмерения.ТекстЗапросаОбъемУпаковки("СН.ЕдиницаИзмерения", "СН"));
	
	ИсходныйЗапрос = Новый Запрос(СтрЗаменить(ИсходныйТекстЗапроса, "//ВоВременнуюТаблицу", ""));
	
	ИсходныйЗапрос.УстановитьПараметр("НачалоПериода", 			   НачалоПериода);
	ИсходныйЗапрос.УстановитьПараметр("ОкончаниеПериода", 		   ОкончаниеПериода);
	ИсходныйЗапрос.УстановитьПараметр("МассивОрганизаций", 		   МассивОрганизаций);	
	ИсходныйЗапрос.УстановитьПараметр("ВидПлановыхЦен", 		   Справочники.ВидыЦен.ВидЦеныПоУмолчанию(Константы.ВидЦеныПлановойСтоимостиМатериаловРабот.Получить()));
	ИсходныйЗапрос.УстановитьПараметр("ОтборПоМатериаламИерархия", ОтборПоМатериаламИерархия(НачалоПериода, ОкончаниеПериода, МассивОрганизаций, "РаспределениеМатериаловИРабот"));
	
	ИсходныйЗапрос.МенеджерВременныхТаблиц = МВТ;
	ИсходныйЗапрос.Выполнить();
	
	Запрос = Новый Запрос(ТекстОписаниеРаспределениеМатериаловИРабот());
	РасчетныеПартии = Запрос.Выполнить().Выгрузить();
	
	ВременнаяТаблицаДанныхПоОтбору("Подразделение", ТекстСортировка, РасчетныеПартии, МВТ);
	
	Возврат МВТ;
	
КонецФункции

Функция РасчетноеРаспределениеМатериаловИРабот(ДанныеДляРасчета, Регистраторы, ЦепочкиДвижений = Неопределено, Тест = Ложь, КоличествоЗаписей = 0)
	
	// Шаг 1: создаем буфер накопления рассчитанных данных
	Запрос = Новый Запрос(ТекстОписаниеРаспределениеМатериаловИРабот());
	РасчетныеПартии = Запрос.Выполнить().Выгрузить();
	КоличествоЗаписей = РасчетныеПартии.Количество();
	
	// Шаг 2: готовим описание обсчета
	КонтекстЦепочек = ОписаниеЦепочек("Партия, Потребление, Дополнение");
	ПоляПотреблений = "Регистратор, Серия";
	
	ДобавитьОписаниеПриемника(КонтекстЦепочек, "Потребление", ПоляПотреблений);
	ДобавитьОписаниеИсточника(КонтекстЦепочек, "Потребление", "Партия", ПоляПотреблений);
	
	// Шаг 3: обсчитываем потребления из партий
	КонтекстДвижений = ОписаниеДвижений(
		"РаспределениеМатериаловИРабот",
		"МатериалыИРаботыВПроизводстве",
		ПереченьПолей(РасчетныеПартии.Колонки),
		ПоляПотреблений,
		"Партия",
		"Количество", "Количество", "", "Период");
	
	ЦепочкиДвижений(КонтекстЦепочек, ДанныеДляРасчета);
	РассчитатьПартииПоЦепочкам(КонтекстДвижений, ДанныеДляРасчета, РасчетныеПартии, Регистраторы, Тест);
	ЦепочкиДвижений = ДанныеДляРасчета;
	
	// Шаг 4: Удаляем строки, не требующие записи в базу.
	УдалитьНезаписываемыеСтроки(КонтекстДвижений.Контекст, РасчетныеПартии);
	
	Возврат РасчетныеПартии;
	
КонецФункции

Функция ТекстРаспределениеМатериаловИРаботИнициализация() // вт ОтборПоМатериалам, Распределить
	
	ТекстЗапроса = "
	|ВЫБРАТЬ
	|	ДД.Регистратор КАК Регистратор,
	|	ДД.Материал КАК Материал
	|ПОМЕСТИТЬ
	|	ОтборПоМатериалам
	|ИЗ
	|	&ОтборПоМатериаламИерархия КАК ДД
	|;
	|/////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ДД.Регистратор,
	|	ДД.Дата,
	|	ДД.Организация,
	|	ДД.Номенклатура,
	|	ДД.Характеристика,
	|	ДД.Серия,
	|	ДД.Подразделение,
	|	ДД.АналитикаУчетаНоменклатуры,
	|	ДД.СтатьяКалькуляции,
	|	ДД.Назначение,
	|	ДД.БазаРаспределения,
	|	ДД.КРаспределению,
	|	ЕСТЬNULL(ОтборПоМатериалам.Материал, НЕОПРЕДЕЛЕНО) КАК Материал,
	|	ЕСТЬNULL(ОтборПоВидамРабот.ВидРабот, НЕОПРЕДЕЛЕНО) КАК ВидРабот,
	|	ЕСТЬNULL(ОтборПоГруппамПродукции.ГруппаПродукции, НЕОПРЕДЕЛЕНО) КАК ГруппаПродукции,
	|	(ВЫБОР
	|		КОГДА ОтборПоГруппамПродукции.ГруппаПродукции ЕСТЬ NULL ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ КОНЕЦ) КАК ПоВсемГруппамПродукции
	|ПОМЕСТИТЬ
	|	Распределить
	|ИЗ (
	|	ВЫБРАТЬ
	|		ДД.Ссылка КАК Регистратор,
	|		ДД.Дата,
	|		ДД.Организация,
	|		ДД.Номенклатура,
	|		ДД.Характеристика,
	|		ДД.Серия,
	|		ДД.Подразделение,
	|		Аналитика.КлючАналитики КАК АналитикаУчетаНоменклатуры,
	|		Правила.БазаРаспределения КАК БазаРаспределения,
	|		ДД.СтатьяКалькуляции КАК СтатьяКалькуляции,
	|		ДД.Назначение КАК Назначение,
	|		ДД.КоличествоКРаспределениюПоПравилу КАК КРаспределению
	|	ИЗ
	|		Документ.РаспределениеПроизводственныхЗатрат КАК ДД
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаНоменклатуры КАК Аналитика
	|			ПО Аналитика.Номенклатура = ДД.Номенклатура
	|			И Аналитика.Характеристика = ДД.Характеристика
	|			И Аналитика.Назначение = ДД.Назначение
	|			И Аналитика.Серия = ДД.Серия
	|			И Аналитика.МестоХранения = ДД.Подразделение
	|			И Аналитика.СтатьяКалькуляции = ЗНАЧЕНИЕ(Справочник.СтатьиКалькуляции.ПустаяСсылка)
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ПравилаРаспределенияРасходов КАК Правила
	|			ПО ДД.ПравилоРаспределения = Правила.Ссылка
	|	ГДЕ
	|		ДД.Дата МЕЖДУ &НачалоПериода И &ОкончаниеПериода
	|		И ДД.Организация В (&МассивОрганизаций)
	|		И ДД.Проведен
	|		И ДД.СтатусУказанияСерий НЕ В(9,10)
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|
	|	ВЫБРАТЬ
	|		ДД.Ссылка КАК Регистратор,
	|		Т.Дата,
	|		Т.Организация,
	|		ДД.Номенклатура,
	|		ДД.Характеристика,
	|		ДД.Серия,
	|		Т.Подразделение,
	|		Аналитика.КлючАналитики КАК АналитикаУчетаНоменклатуры,
	|		Правила.БазаРаспределения КАК БазаРаспределения,
	|		Т.СтатьяКалькуляции КАК СтатьяКалькуляции,
	|		Т.Назначение КАК Назначение,
	|		ДД.КоличествоКРаспределениюПоПравилу КАК КРаспределению
	|	ИЗ
	|		Документ.РаспределениеПроизводственныхЗатрат.Серии КАК ДД
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.РаспределениеПроизводственныхЗатрат КАК Т
	|			ПО Т.Ссылка = ДД.Ссылка
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаНоменклатуры КАК Аналитика
	|			ПО Аналитика.Номенклатура = ДД.Номенклатура
	|			И Аналитика.Характеристика = ДД.Характеристика
	|			И Аналитика.Серия = ЗНАЧЕНИЕ(Справочник.СерииНоменклатуры.ПустаяСсылка)
	|			И Аналитика.МестоХранения = Т.Подразделение
	|			И Аналитика.Назначение = ДД.Назначение
	|			И Аналитика.СтатьяКалькуляции = ЗНАЧЕНИЕ(Справочник.СтатьиКалькуляции.ПустаяСсылка)
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ПравилаРаспределенияРасходов КАК Правила
	|			ПО Т.ПравилоРаспределения = Правила.Ссылка
	|	ГДЕ
	|		Т.Дата МЕЖДУ &НачалоПериода И &ОкончаниеПериода
	|		И Т.Организация В (&МассивОрганизаций)
	|		И Т.Проведен
	|		И Т.СтатусУказанияСерий В (9,10)
	|	) КАК ДД
	|	ЛЕВОЕ СОЕДИНЕНИЕ ОтборПоМатериалам КАК ОтборПоМатериалам
	|		ПО ОтборПоМатериалам.Регистратор = ДД.Регистратор
	|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.РаспределениеПроизводственныхЗатрат.ОтборПоГруппамПродукции КАК ОтборПоГруппамПродукции
	|		ПО ОтборПоГруппамПродукции.Ссылка = ДД.Регистратор
	|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.РаспределениеПроизводственныхЗатрат.ОтборПоВидамРабот КАК ОтборПоВидамРабот
	|		ПО ОтборПоВидамРабот.Ссылка = ДД.Регистратор
	|";
	
	Возврат ТекстЗапроса
			
КонецФункции

Функция ТекстДанныеПоУказаннымМатериалам() // вт ДанныеПоУказаннымМатериалам
	Возврат "
	|ВЫБРАТЬ
	|	ДД.Организация,
	|	ЕСТЬNULL(ОтчетПереработчика.Подразделение, ДД.Подразделение) КАК Подразделение,
	|	ДД.АналитикаУчетаНоменклатуры.Номенклатура КАК Материал,
	|	(ВЫБОР
	//++ НЕ УТКА
	|		КОГДА НЕ ЗаказыНаПроизводство.Ссылка ЕСТЬ NULL ТОГДА ЗаказыНаПроизводство.Номенклатура
	//-- НЕ УТКА
	|		КОГДА НЕ ЗаказыПереработчику.Ссылка ЕСТЬ NULL ТОГДА ЗаказыПереработчику.Номенклатура
	|		КОГДА НЕ Выпуск.Ссылка ЕСТЬ NULL ТОГДА Выпуск.Номенклатура
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО КОНЕЦ) КАК Продукция,
	|	(ВЫБОР
	//++ НЕ УТКА
	|		КОГДА НЕ ЗаказыНаПроизводство.Ссылка ЕСТЬ NULL ТОГДА ЗаказыНаПроизводство.Номенклатура.ГруппаАналитическогоУчета
	//-- НЕ УТКА
	|		КОГДА НЕ ЗаказыПереработчику.Ссылка ЕСТЬ NULL ТОГДА ЗаказыПереработчику.Номенклатура.ГруппаАналитическогоУчета
	|		КОГДА НЕ Выпуск.Ссылка ЕСТЬ NULL ТОГДА Выпуск.Номенклатура.ГруппаАналитическогоУчета
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО КОНЕЦ) КАК ГруппаПродукции,
	|	ДД.Назначение,
	|	ДД.ЗаказНаПроизводство КАК ЗаказНаПроизводство,
	|	ДД.КодСтрокиПродукция,
	|	(ВЫБОР
	//++ НЕ УТКА
	|		КОГДА НЕ ЗаказыНаПроизводство.Ссылка ЕСТЬ NULL ТОГДА ЗаказыНаПроизводство.Назначение.НаправлениеДеятельности
	//-- НЕ УТКА
	|		КОГДА НЕ ЗаказыПереработчику.Ссылка ЕСТЬ NULL ТОГДА ЗаказыПереработчику.Назначение.НаправлениеДеятельности
	|		КОГДА НЕ Выпуск.Ссылка ЕСТЬ NULL ТОГДА Выпуск.Назначение.НаправлениеДеятельности
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО КОНЕЦ) КАК НаправлениеДеятельности,
	|	ДД.Этап,
	|	СУММА(ДД.Количество) КАК Количество,
	|	СУММА(&Объем * ДД.Количество) КАК Объем,
	|	СУММА(&Вес * ДД.Количество) КАК Вес
	|ПОМЕСТИТЬ
	|	Данные_ПоУказаннымМатериалам
	|ИЗ
	|	РегистрНакопления.МатериалыИРаботыВПроизводстве КАК ДД
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Номенклатура КАК СН
	|		ПО СН.Ссылка = ДД.АналитикаУчетаНоменклатуры.Номенклатура
	//++ НЕ УТКА
	|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.ЗаказНаПроизводство.Продукция КАК ЗаказыНаПроизводство
	|		ПО ЗаказыНаПроизводство.Ссылка = ДД.ЗаказНаПроизводство
	|		И ЗаказыНаПроизводство.КодСтроки = ДД.КодСтрокиПродукция
	//-- НЕ УТКА
	|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.ЗаказПереработчику.Продукция КАК ЗаказыПереработчику
	|		ПО ЗаказыПереработчику.Ссылка = ДД.ЗаказНаПроизводство
	|		И ЗаказыПереработчику.КодСтроки = ДД.КодСтрокиПродукция
	|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.ВыпускПродукции.Товары КАК Выпуск
	|		ПО Выпуск.Ссылка = ДД.ЗаказНаПроизводство
	|		И Выпуск.КодСтроки = ДД.КодСтрокиПродукция
	|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.ОтчетПереработчика КАК ОтчетПереработчика
	|		ПО ОтчетПереработчика.Ссылка = ДД.Регистратор
	|ГДЕ
	|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
	|	И ДД.Организация В (&МассивОрганизаций)
	|	И ДД.Активность
	|	И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|	И (ДД.СтатьяРасходов = НЕОПРЕДЕЛЕНО ИЛИ ДД.СтатьяРасходов = ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка))
	|	И ДД.БазаРаспределения = ЗНАЧЕНИЕ(Перечисление.ТипыБазыРаспределенияРасходов.ПустаяСсылка)
	|	И НЕ ДД.Регистратор Ссылка Документ.ВозвратМатериаловИзПроизводства
	|
	|СГРУППИРОВАТЬ ПО
	|	ДД.Организация,
	|	ЕСТЬNULL(ОтчетПереработчика.Подразделение, ДД.Подразделение),
	|	ДД.АналитикаУчетаНоменклатуры.Номенклатура,
	|	(ВЫБОР
	//++ НЕ УТКА
	|		КОГДА НЕ ЗаказыНаПроизводство.Ссылка ЕСТЬ NULL ТОГДА ЗаказыНаПроизводство.Номенклатура
	//-- НЕ УТКА
	|		КОГДА НЕ ЗаказыПереработчику.Ссылка ЕСТЬ NULL ТОГДА ЗаказыПереработчику.Номенклатура
	|		КОГДА НЕ Выпуск.Ссылка ЕСТЬ NULL ТОГДА Выпуск.Номенклатура
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО КОНЕЦ),
	|	(ВЫБОР
	//++ НЕ УТКА
	|		КОГДА НЕ ЗаказыНаПроизводство.Ссылка ЕСТЬ NULL ТОГДА ЗаказыНаПроизводство.Номенклатура.ГруппаАналитическогоУчета
	//-- НЕ УТКА
	|		КОГДА НЕ ЗаказыПереработчику.Ссылка ЕСТЬ NULL ТОГДА ЗаказыПереработчику.Номенклатура.ГруппаАналитическогоУчета
	|		КОГДА НЕ Выпуск.Ссылка ЕСТЬ NULL ТОГДА Выпуск.Номенклатура.ГруппаАналитическогоУчета
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО КОНЕЦ),
	|	ДД.Назначение,
	|	ДД.ЗаказНаПроизводство,
	|	(ВЫБОР
	//++ НЕ УТКА
	|		КОГДА НЕ ЗаказыНаПроизводство.Ссылка ЕСТЬ NULL ТОГДА ЗаказыНаПроизводство.Назначение.НаправлениеДеятельности
	//-- НЕ УТКА
	|		КОГДА НЕ ЗаказыПереработчику.Ссылка ЕСТЬ NULL ТОГДА ЗаказыПереработчику.Назначение.НаправлениеДеятельности
	|		КОГДА НЕ Выпуск.Ссылка ЕСТЬ NULL ТОГДА Выпуск.Назначение.НаправлениеДеятельности
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО КОНЕЦ),
	|	ДД.КодСтрокиПродукция,
	|	ДД.Этап
	|";
КонецФункции

Функция ТекстДанныеПоПродукции() // вт ФактЭтапов_ПоПродукции, ПланЭтаповПоЗаказам_ПоПродукции, Данные_ПоПродукции
	
	Возврат "
	//++ НЕ УТКА
	|ВЫБРАТЬ
	|	ДД.Подразделение,
	|	ДД.Распоряжение,
	|	ДД.КодСтрокиПродукция,
	|	ДД.Этап,
	|	ДД.Этап.Владелец КАК Спецификация,
	|	СУММА(ДД.ЗапланированоПроизводством + ДД.КВыполнению + ДД.Выполнено + ДД.Брак) КАК ФактЭтапов
	|ПОМЕСТИТЬ
	|	ФактЭтапов_ПоПродукции
	|ИЗ
	|	РегистрНакопления.ЭтапыПроизводства КАК ДД
	|ГДЕ
	// Выполняющийся этап
	|	((ДД.НачалоПредварительногоБуфера <= &ОкончаниеПериода
	|		И ДД.ОкончаниеЗавершающегоБуфера >= &НачалоПериода
	|		И (ДД.ЗапланированоПроизводством <> 0 ИЛИ ДД.КВыполнению <> 0))
	|	ИЛИ
	// Выполненный этап
	|	(ДД.ОкончаниеЗавершающегоБуфера МЕЖДУ &НачалоПериода И &ОкончаниеПериода
	|	И (ДД.Выполнено <> 0 ИЛИ ДД.Брак <> 0)))
	|	И ДД.Распоряжение.Организация В (&МассивОрганизаций)
	|	И ДД.Активность
	|
	|СГРУППИРОВАТЬ ПО
	|	ДД.Подразделение,
	|	ДД.Распоряжение,
	|	ДД.КодСтрокиПродукция,
	|	ДД.Этап,
	|	ДД.Этап.Владелец
	|;
	|/////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ДД.Распоряжение,
	|	ДД.КодСтрокиПродукция,
	|	ДД.Спецификация,
	|	СУММА(Этапы.ЗапланированоЗаказом) КАК ПланЭтапов
	|ПОМЕСТИТЬ
	|	ПланЭтаповПоЗаказам_ПоПродукции
	|ИЗ
	|	ФактЭтапов_ПоПродукции КАК ДД
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрНакопления.ЭтапыПроизводства КАК Этапы
	|		ПО Этапы.Распоряжение = ДД.Распоряжение
	|		И Этапы.КодСтрокиПродукция = ДД.КодСтрокиПродукция
	|		И Этапы.Этап = ДД.Этап
	|		И Этапы.ЗапланированоЗаказом <> 0
	|		И Этапы.Активность
	|
	|СГРУППИРОВАТЬ ПО
	|	ДД.Распоряжение,
	|	ДД.КодСтрокиПродукция,
	|	ДД.Спецификация
	|;
	|/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	|
	//-- НЕ УТКА

	// Данные по выпуску без распоряжений
	|ВЫБРАТЬ
	|	Выпуск.Организация,
	|	Выпуск.Подразделение,
	|	ДД.Номенклатура КАК Продукция,
	|	СН.ГруппаАналитическогоУчета КАК ГруппаПродукции,
	|	ДД.Назначение,
	|	ДД.Ссылка КАК ЗаказНаПроизводство,
	|	ДД.КодСтроки КАК КодСтрокиПродукция,
	|	ДД.Назначение.НаправлениеДеятельности КАК НаправлениеДеятельности,
	|	НЕОПРЕДЕЛЕНО КАК Этап,
	|	ДД.Количество КАК ЗапланированоПродукции,
	|	1 КАК ЗапланированоЭтапов,
	|	1 КАК ВыполненоЭтапов,
	|	ДД.Количество,
	|	&Объем * ДД.Количество КАК Объем,
	|	&Вес * ДД.Количество КАК Вес
	|ПОМЕСТИТЬ Данные_ПоПродукции
	|ИЗ
	|	Документ.ВыпускПродукции.Товары КАК ДД
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ВыпускПродукции КАК Выпуск
	|		ПО (Выпуск.Ссылка = ДД.Ссылка)
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Номенклатура КАК СН
	|		ПО (СН.Ссылка = ДД.Номенклатура)
	|ГДЕ
	|	Выпуск.Дата МЕЖДУ &НачалоПериода И &ОкончаниеПериода
	|	И Выпуск.Организация В (&МассивОрганизаций)
	|	И НЕ Выпуск.ВыпускПоРаспоряжениям
	|	И ДД.ТипСтоимости = ЗНАЧЕНИЕ(Перечисление.ТипыСтоимостиВыходныхИзделий.Рассчитывается)
	|	И Выпуск.Проведен
	|
	//++ НЕ УТКА

	// Данные по выпуску по распоряжениям
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ЗаказНаПроизводство.Организация,
	|	ДД.Подразделение,
	|	Строки.Номенклатура КАК Продукция,
	|	СН.ГруппаАналитическогоУчета КАК ГруппаПродукции,
	|	Строки.Назначение,
	|	ДД.Распоряжение,
	|	ДД.КодСтрокиПродукция,
	|	Строки.Назначение.НаправлениеДеятельности КАК НаправлениеДеятельности,
	|	ДД.Этап,
	|	Строки.Количество,
	|	План.ПланЭтапов,
	|	ДД.ФактЭтапов,
	|	ВЫБОР
	|		КОГДА План.ПланЭтапов <> 0
	|		ТОГДА Строки.Количество * ДД.ФактЭтапов / План.ПланЭтапов
	|		ИНАЧЕ 0
	|	КОНЕЦ КАК Количество, //Это расчетный выпуск
	|	ВЫБОР
	|		КОГДА План.ПланЭтапов <> 0
	|		ТОГДА &Объем * Строки.Количество * ДД.ФактЭтапов / План.ПланЭтапов
	|		ИНАЧЕ 0
	|	КОНЕЦ КАК Объем,
	|	ВЫБОР
	|		КОГДА План.ПланЭтапов <> 0
	|		ТОГДА &Вес * Строки.Количество * ДД.ФактЭтапов / План.ПланЭтапов
	|		ИНАЧЕ 0
	|	КОНЕЦ КАК Вес
	|
	|ИЗ ФактЭтапов_ПоПродукции КАК ДД
	|
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ПланЭтаповПоЗаказам_ПоПродукции КАК План
	|		ПО План.Распоряжение = ДД.Распоряжение
	|		И План.КодСтрокиПродукция = ДД.КодСтрокиПродукция
	|		И План.Спецификация = ДД.Спецификация
	|
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ЗаказНаПроизводство.Продукция КАК СтрокиПродукция
	|		ПО СтрокиПродукция.Ссылка = ДД.Распоряжение
	|		И СтрокиПродукция.КодСтроки = ДД.КодСтрокиПродукция
	|
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ЗаказНаПроизводство.ВыходныеИзделия КАК Строки
	|		ПО Строки.Ссылка = СтрокиПродукция.Ссылка
	|		И Строки.КлючСвязиПродукция = СтрокиПродукция.КлючСвязи
	|		И Строки.Этап.Владелец = ДД.Спецификация
	|
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ЗаказНаПроизводство КАК ЗаказНаПроизводство
	|		ПО ЗаказНаПроизводство.Ссылка = ДД.Распоряжение
	|
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Номенклатура КАК СН
	|		ПО СН.Ссылка = Строки.Номенклатура
	|
	//-- НЕ УТКА

	// Поступление от переработчика.
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	Заказ.Организация,
	|	Заказ.Подразделение,
	|	Аналитика.Номенклатура,
	|	СН.ГруппаАналитическогоУчета КАК ГруппаПродукции,
	|	Заказ.Назначение,
	|	ДД.Распоряжение КАК ЗаказНаПроизводство,
	|	ДД.КодСтроки КАК КодСтрокиПродукция,
	|	Заказ.Назначение.НаправлениеДеятельности,
	|	НЕОПРЕДЕЛЕНО КАК Этап,
	|	ДД.Количество КАК ЗапланированоПродукции,
	|	1 КАК ЗапланированоЭтапов,
	|	1 КАК ВыполненоЭтапов,
	|	ДД.Количество,
	|	&Объем * ДД.Количество,
	|	&Вес * ДД.Количество
	|
	|ИЗ
	|	РегистрНакопления.ТоварыПолученныеОтПереработчика КАК ДД
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ЗаказПереработчику КАК Заказ
	|		ПО ДД.Распоряжение = Заказ.Ссылка
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК Аналитика
	|		ПО ДД.АналитикаУчетаНоменклатуры = Аналитика.Ссылка
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Номенклатура КАК СН
	|		ПО СН.Ссылка = Аналитика.Номенклатура
	|ГДЕ
	|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
	|	И Заказ.Организация В (&МассивОрганизаций)
	|	И ДД.Активность
	|	И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|	И ДД.ТипСтоимости = ЗНАЧЕНИЕ(Перечисление.ТипыСтоимостиВыходныхИзделий.Рассчитывается)
	|	И ДД.Активность
	|";
	
КонецФункции

Функция ТекстДанныеПоПлановойСтоимости() // вт ФактЭтапов_ПоПлановойСтоимости, ПланЭтаповПоЗаказам_ПоПлановойСтоимости, Данные_ПоПлановойСтоимости
	
	Возврат "
	//++ НЕ УТКА
	|ВЫБРАТЬ
	|	ДД.Подразделение,
	|	ДД.Распоряжение,
	|	ДД.КодСтрокиПродукция,
	|	ДД.Этап,
	|	СУММА(ДД.ЗапланированоПроизводством + ДД.КВыполнению + ДД.Выполнено + ДД.Брак) КАК ФактЭтапов
	|
	|ПОМЕСТИТЬ ФактЭтапов_ПоПлановойСтоимости
	|
	|ИЗ
	|	РегистрНакопления.ЭтапыПроизводства КАК ДД
	|ГДЕ
	|	((ДД.НачалоПредварительногоБуфера <= &ОкончаниеПериода
	|		И ДД.ОкончаниеЗавершающегоБуфера >= &НачалоПериода
	|		И (ДД.ЗапланированоПроизводством <> 0 ИЛИ ДД.КВыполнению <> 0 ИЛИ ДД.Выполнено <> 0 ИЛИ ДД.Брак <> 0))
	|	)
	|	И ДД.Распоряжение.Организация В (&МассивОрганизаций)
	|	И ДД.Активность
	|
	|СГРУППИРОВАТЬ ПО
	|	ДД.Подразделение,
	|	ДД.Распоряжение,
	|	ДД.КодСтрокиПродукция,
	|	ДД.Этап
	|;
	|
	|/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Т.Распоряжение,
	|	Т.КодСтрокиПродукция,
	|	СУММА(ДД.ЗапланированоЗаказом) КАК ПланЭтапов
	|
	|ПОМЕСТИТЬ ПланЭтаповПоЗаказам_ПоПлановойСтоимости
	|
	|ИЗ ФактЭтапов_ПоПлановойСтоимости КАК Т
	|
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрНакопления.ЭтапыПроизводства КАК ДД
	|	ПО Т.Распоряжение = ДД.Распоряжение
	|	И Т.КодСтрокиПродукция = ДД.КодСтрокиПродукция
	|	И Т.Этап = ДД.Этап
	|	И ДД.ЗапланированоЗаказом <> 0
	|
	|СГРУППИРОВАТЬ ПО
	|	Т.Распоряжение,
	|	Т.КодСтрокиПродукция
	|;
	|
	|/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	|
	//-- НЕ УТКА

	// Данные по выпуску без распоряжений.
	|ВЫБРАТЬ
	|	Выпуск.Организация,
	|	Выпуск.Подразделение,
	|	ДД.Номенклатура КАК Номенклатура,
	|	ДД.Характеристика КАК Характеристика,
	|	СН.ГруппаАналитическогоУчета КАК ГруппаПродукции,
	|	ДД.Назначение,
	|	ДД.Ссылка КАК ЗаказНаПроизводство,
	|	ДД.КодСтроки КАК КодСтрокиПродукция,
	|	ДД.Назначение.НаправлениеДеятельности КАК НаправлениеДеятельности,
	|	НЕОПРЕДЕЛЕНО КАК Этап,
	|	ДД.Количество КАК ЗапланированоПродукции,
	|	1 КАК ЗапланированоЭтапов,
	|	1 КАК ВыполненоЭтапов,
	|	ДД.Количество
	|ПОМЕСТИТЬ Данные_ПоПлановойСтоимости
	|ИЗ
	|	Документ.ВыпускПродукции.Товары КАК ДД
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ВыпускПродукции КАК Выпуск
	|		ПО (Выпуск.Ссылка = ДД.Ссылка)
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Номенклатура КАК СН
	|		ПО (СН.Ссылка = ДД.Номенклатура)
	|ГДЕ
	|	Выпуск.Дата МЕЖДУ &НачалоПериода И &ОкончаниеПериода
	|	И Выпуск.Организация В (&МассивОрганизаций)
	|	И НЕ Выпуск.ВыпускПоРаспоряжениям
	|	И ДД.ТипСтоимости = ЗНАЧЕНИЕ(Перечисление.ТипыСтоимостиВыходныхИзделий.Рассчитывается)
	|	И Выпуск.Проведен
	//++ НЕ УТКА

	// Данные по выпуску по распоряжениям.
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	Д.Организация,
	|	ФК.Подразделение,
	|	П.Номенклатура КАК Номенклатура,
	|	П.Характеристика КАК Характеристика,
	|	СН.ГруппаАналитическогоУчета КАК ГруппаПродукции,
	|	П.Назначение,
	|	ФК.Распоряжение,
	|	ФК.КодСтрокиПродукция,
	|	П.Назначение.НаправлениеДеятельности КАК НаправлениеДеятельности,
	|	ФК.Этап,
	|	П.Количество,
	|	ПЛ.ПланЭтапов,
	|	ФК.ФактЭтапов,
	|	ВЫБОР
	|		КОГДА ФК.ФактЭтапов <> 0 И ПЛ.ПланЭтапов <> 0
	|		ТОГДА П.Количество * ФК.ФактЭтапов / ПЛ.ПланЭтапов
	|		ИНАЧЕ П.Количество
	|	КОНЕЦ КАК Количество //Это расчетный выпуск
	|
	|ИЗ ФактЭтапов_ПоПлановойСтоимости КАК ФК
	|
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ПланЭтаповПоЗаказам_ПоПлановойСтоимости КАК ПЛ
	|	ПО ФК.Распоряжение = ПЛ.Распоряжение
	|	И ФК.КодСтрокиПродукция = ПЛ.КодСтрокиПродукция
	|
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ЗаказНаПроизводство.Продукция КАК П
	|	ПО ФК.Распоряжение = П.Ссылка
	|	И ФК.КодСтрокиПродукция = П.КодСтроки
	|
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ЗаказНаПроизводство КАК Д
	|	ПО ФК.Распоряжение = Д.Ссылка
	|
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Номенклатура КАК СН
	|	ПО П.Номенклатура = СН.Ссылка
	|
	//-- НЕ УТКА

	// Поступление от переработчика.
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	Заказ.Организация,
	|	Заказ.Подразделение,
	|	Аналитика.Номенклатура,
	|	Аналитика.Характеристика,
	|	СпрНоменклатура.ГруппаАналитическогоУчета КАК ГруппаПродукции,
	|	Заказ.Назначение,
	|	ДД.Распоряжение КАК ЗаказНаПроизводство,
	|	ДД.КодСтроки КАК КодСтрокиПродукция,
	|	Заказ.Назначение.НаправлениеДеятельности КАК НаправлениеДеятельности,
	|	НЕОПРЕДЕЛЕНО КАК Этап,
	|	ДД.Количество КАК ЗапланированоПродукции,
	|	1 КАК ЗапланированоЭтапов,
	|	1 КАК ВыполненоЭтапов,
	|	ДД.Количество
	|ИЗ
	|	РегистрНакопления.ТоварыПолученныеОтПереработчика КАК ДД
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ЗаказПереработчику КАК Заказ
	|		ПО ДД.Распоряжение = Заказ.Ссылка
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК Аналитика
	|		ПО ДД.АналитикаУчетаНоменклатуры = Аналитика.Ссылка
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Номенклатура КАК СпрНоменклатура
	|		ПО Аналитика.Номенклатура = СпрНоменклатура.Ссылка
	|ГДЕ
	|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
	|	И Заказ.Организация В (&МассивОрганизаций)
	|	И ДД.Активность
	|	И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|	И ДД.ТипСтоимости = ЗНАЧЕНИЕ(Перечисление.ТипыСтоимостиВыходныхИзделий.Рассчитывается)
	|";
	
КонецФункции

Функция ТекстДанныеПоУказаннымТрудозатратам() // вт Данные_ПоУказаннымТрудозатратам
	
	Возврат "
	|ВЫБРАТЬ
	|	ДД.Организация КАК Организация,
	|	ДД.Подразделение КАК Подразделение,
	|	ДД.ВидРабот КАК ВидРабот,
	|	Аналитика.Номенклатура КАК Продукция,
	|	СН.ГруппаАналитическогоУчета КАК ГруппаПродукции,
	|	Выпуски.Назначение КАК Назначение,
	|	ДД.ЗаказНаПроизводство КАК ЗаказНаПроизводство,
	|	ДД.КодСтрокиПродукция КАК КодСтрокиПродукция,
	|	Выпуски.Назначение.НаправлениеДеятельности КАК НаправлениеДеятельности,
	|	НЕОПРЕДЕЛЕНО КАК Этап,
	|	ДД.ДокументВыпуска КАК ДокументВыпуска,
	|	ДД.КодСтроки КАК КодСтроки,
	|	ДД.Количество КАК Количество
	|ПОМЕСТИТЬ Данные_ПоУказаннымТрудозатратам
	|ИЗ
	|	РегистрНакопления.ТрудозатратыНезавершенногоПроизводства КАК ДД
	|
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК Аналитика
	|	ПО ДД.КорАналитикаУчетаПродукции = Аналитика.Ссылка
	|		И ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
	|		И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|		И ДД.Активность
	|
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Номенклатура КАК СН
	|	ПО Аналитика.Номенклатура = СН.Ссылка
	|
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ВыпускПродукции.Товары КАК Выпуски
	|	ПО ДД.ДокументВыпуска = Выпуски.Ссылка
	|	И ДД.КодСтроки = Выпуски.КодСтроки
	|
	|ГДЕ
	|	ДД.КодСтрокиПродукция = 0
	|	И ДД.Количество <> 0
	|	И ДД.Организация В (&МассивОрганизаций)
	|	И ДД.Активность
	|
	//++ НЕ УТКА
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ДД.Организация КАК Организация,
	|	ДД.Подразделение КАК Подразделение,
	|	ДД.ВидРабот КАК ВидРабот,
	|	Аналитика.Номенклатура КАК Продукция,
	|	СН.ГруппаАналитическогоУчета КАК ГруппаПродукции,
	|	ЕСТЬNULL(З.Назначение, НЕОПРЕДЕЛЕНО) КАК Назначение,
	|	ДД.ЗаказНаПроизводство КАК ЗаказНаПроизводство,
	|	ДД.КодСтрокиПродукция КАК КодСтрокиПродукция,
	|	З.Назначение.НаправлениеДеятельности,
	|	ДД.Этап КАК Этап,
	|	НЕОПРЕДЕЛЕНО КАК ДокументВыпуска,
	|	0 КАК КодСтроки,
	|	ДД.Количество КАК Количество
	|ИЗ
	|	РегистрНакопления.ТрудозатратыНезавершенногоПроизводства КАК ДД
	|
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК Аналитика
	|	ПО ДД.КорАналитикаУчетаПродукции = Аналитика.Ссылка
	|		И ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
	|		И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|		И ДД.Активность
	|
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Номенклатура КАК СН
	|	ПО Аналитика.Номенклатура = СН.Ссылка
	|
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ЗаказНаПроизводство.Продукция КАК З
	|	ПО ДД.ЗаказНаПроизводство = З.Ссылка
	|	И ДД.КодСтрокиПродукция = З.КодСтроки
	|
	|ГДЕ
	|	ДД.Количество <> 0
	|	И ДД.Организация В (&МассивОрганизаций)
	|	И ДД.Активность
	//-- НЕ УТКА
	|";
	
КонецФункции

Функция ТекстДанныеПоНормативамРасходаМатериала()
	
	Возврат "
	//++ НЕ УТКА
	|ВЫБРАТЬ
	|	ДД.Распоряжение,
	|	ДД.КодСтрокиПродукция,
	|	ДД.Этап,
	|	ДД.Этап.Владелец КАК Спецификация,
	|	СУММА(ДД.ЗапланированоПроизводством + ДД.КВыполнению + ДД.Выполнено + ДД.Брак) КАК ФактЭтапов
	|
	|ПОМЕСТИТЬ ФактЭтапов_ПоНормативам
	|
	|ИЗ
	|	РегистрНакопления.ЭтапыПроизводства КАК ДД
	|ГДЕ
	// Выполняющийся этап
	|	((ДД.НачалоПредварительногоБуфера <= &ОкончаниеПериода
	|		И ДД.ОкончаниеЗавершающегоБуфера >= &НачалоПериода
	|		И (ДД.ЗапланированоПроизводством <> 0 ИЛИ ДД.КВыполнению <> 0))
	|	ИЛИ
	// Выполненный этап
	|	(ДД.ОкончаниеЗавершающегоБуфера МЕЖДУ &НачалоПериода И &ОкончаниеПериода
	|	И (ДД.Выполнено <> 0 ИЛИ ДД.Брак <> 0)))
	|	И ДД.Распоряжение.Организация В (&МассивОрганизаций)
	|	И ДД.Активность
	|
	|СГРУППИРОВАТЬ ПО
	|	ДД.Распоряжение,
	|	ДД.КодСтрокиПродукция,
	|	ДД.Этап,
	|	ДД.Этап.Владелец
	|;
	|
	|/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Т.Распоряжение,
	|	Т.КодСтрокиПродукция,
	|	Т.Спецификация,
	|	СУММА(ДД.ЗапланированоЗаказом) КАК ПланЭтапов
	|
	|ПОМЕСТИТЬ ПланЭтаповПоЗаказам_ПоНормативам
	|
	|ИЗ ФактЭтапов_ПоНормативам КАК Т
	|
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрНакопления.ЭтапыПроизводства КАК ДД
	|	ПО Т.Распоряжение = ДД.Распоряжение
	|	И Т.КодСтрокиПродукция = ДД.КодСтрокиПродукция
	|	И Т.Этап = ДД.Этап
	|	И ДД.ЗапланированоЗаказом <> 0
	|
	|СГРУППИРОВАТЬ ПО
	|	Т.Распоряжение,
	|	Т.КодСтрокиПродукция,
	|	Т.Спецификация
	|;
	|
	|/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	|
	//-- НЕ УТКА

	// Данные по выпуску без распоряжений.
	|ВЫБРАТЬ
	|	Выпуск.Организация,
	|	Выпуск.Подразделение,
	|	СН.ГруппаАналитическогоУчета КАК ГруппаПродукции,
	|	ДД.Назначение,
	|	ДД.Назначение.НаправлениеДеятельности КАК НаправлениеДеятельности,
	|	ДД.Ссылка КАК ЗаказНаПроизводство,
	|	ДД.КодСтроки КАК КодСтрокиПродукция,
	|	НЕОПРЕДЕЛЕНО КАК Этап,
	|	ДД.Номенклатура КАК НоменклатураВыпуска,
	|	ДД.Характеристика КАК ХарактеристикаВыпуска,
	|	ДД.Спецификация КАК Спецификация,
	|	ДД.Количество КАК ЗапланированоПродукции,
	|	1 КАК ЗапланированоЭтапов,
	|	1 КАК ВыполненоЭтапов,
	|	ДД.Количество
	|ПОМЕСТИТЬ Данные_ПоНормативамРасходаМатериала
	|ИЗ
	|	Документ.ВыпускПродукции.Товары КАК ДД
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ВыпускПродукции КАК Выпуск
	|		ПО (Выпуск.Ссылка = ДД.Ссылка)
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Номенклатура КАК СН
	|		ПО (СН.Ссылка = ДД.Номенклатура)
	|ГДЕ
	|	Выпуск.Дата МЕЖДУ &НачалоПериода И &ОкончаниеПериода
	|	И Выпуск.Организация В (&МассивОрганизаций)
	|	И НЕ Выпуск.ВыпускПоРаспоряжениям
	|	И Выпуск.Проведен
	|
	//++ НЕ УТКА

	// Данные по выпуску по распоряжениям.
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ЗаказНаПроизводство.Организация,
	|	Строки.Подразделение,
	|	СН.ГруппаАналитическогоУчета КАК ГруппаПродукции,
	|	Строки.Назначение,
	|	Строки.Назначение.НаправлениеДеятельности КАК НаправлениеДеятельности,
	|	ДД.Распоряжение,
	|	ДД.КодСтрокиПродукция,
	|	ДД.Этап,
	|	Строки.Номенклатура,
	|	Строки.Характеристика,
	|	ДД.Спецификация,
	|	Строки.Количество,
	|	План.ПланЭтапов,
	|	ДД.ФактЭтапов,
	|	ВЫБОР
	|		КОГДА План.ПланЭтапов <> 0
	|		ТОГДА Строки.Количество * ДД.ФактЭтапов / План.ПланЭтапов
	|		ИНАЧЕ 0
	|	КОНЕЦ КАК Количество //Это расчетный выпуск
	|
	|ИЗ ФактЭтапов_ПоНормативам КАК ДД
	|
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ПланЭтаповПоЗаказам_ПоНормативам КАК План
	|		ПО ДД.Распоряжение = План.Распоряжение
	|		И ДД.КодСтрокиПродукция = План.КодСтрокиПродукция
	|		И ДД.Спецификация = План.Спецификация
	|
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ЗаказНаПроизводство.Продукция КАК СтрокиПродукция
	|		ПО ДД.Распоряжение = СтрокиПродукция.Ссылка
	|		И ДД.КодСтрокиПродукция = СтрокиПродукция.КодСтроки
	|
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ЗаказНаПроизводство.ВыходныеИзделия КАК Строки
	|		ПО СтрокиПродукция.Ссылка = Строки.Ссылка
	|		И СтрокиПродукция.КлючСвязи = Строки.КлючСвязиПродукция
	|		И ДД.Этап = Строки.Этап
	|
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ЗаказНаПроизводство КАК ЗаказНаПроизводство
	|		ПО ДД.Распоряжение = ЗаказНаПроизводство.Ссылка
	|
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Номенклатура КАК СН
	|		ПО Строки.Номенклатура = СН.Ссылка
	//-- НЕ УТКА
	|";
	
КонецФункции

Функция ТекстБазаРаспределения() // вт БазаРаспределения
	
	ТекстЗапроса = "
	// по указанным материалам
	|ВЫБРАТЬ
	|	ДД.Регистратор,
	|	ДД.Подразделение,
	|	ДД.Дата,
	|	ДД.Серия,
	|	Данные.ЗаказНаПроизводство,
	|	Данные.КодСтрокиПродукция,
	|	Данные.Этап,
	|	Данные.Количество,
	|	Данные.Объем,
	|	Данные.Вес,
	|	0 КАК Стоимость
	|ПОМЕСТИТЬ
	|	БазаРаспределения
	|ИЗ
	|	Распределить КАК ДД
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Данные_ПоУказаннымМатериалам КАК Данные
	|		ПО Данные.Организация = ДД.Организация
	|		И Данные.Подразделение = ДД.Подразделение
	|		И Данные.Материал = ДД.Материал
	|		И (Данные.ГруппаПродукции = ДД.ГруппаПродукции ИЛИ ДД.ПоВсемГруппамПродукции)
	|		И (Данные.Назначение = ДД.Назначение ИЛИ ДД.Назначение = ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка))
	|ГДЕ
	|	ДД.БазаРаспределения = ЗНАЧЕНИЕ(Перечисление.ТипыБазыРаспределенияРасходов.КоличествоУказанныхМатериалов)
	|	ИЛИ ДД.БазаРаспределения = ЗНАЧЕНИЕ(Перечисление.ТипыБазыРаспределенияРасходов.ОбъемУказанныхМатериалов)
	|	ИЛИ ДД.БазаРаспределения = ЗНАЧЕНИЕ(Перечисление.ТипыБазыРаспределенияРасходов.ВесУказанныхМатериалов)
	|
	// по продукции
	|ОБЪЕДИНИТЬ ВСЕ
	|ВЫБРАТЬ
	|	ДД.Регистратор,
	|	ДД.Подразделение,
	|	ДД.Дата,
	|	ДД.Серия,
	|	Данные.ЗаказНаПроизводство,
	|	Данные.КодСтрокиПродукция,
	|	Данные.Этап,
	|	Данные.Количество,
	|	Данные.Объем,
	|	Данные.Вес,
	|	0 КАК Стоимость
	|ИЗ
	|	Распределить КАК ДД
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Данные_ПоПродукции КАК Данные
	|		ПО Данные.Организация = ДД.Организация
	|		И (Данные.ГруппаПродукции = ДД.ГруппаПродукции ИЛИ ДД.ПоВсемГруппамПродукции)
	|		И (Данные.Назначение = ДД.Назначение ИЛИ ДД.Назначение = ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка))
	|		И Данные.Подразделение = ДД.Подразделение
	|ГДЕ
	|	ДД.БазаРаспределения = ЗНАЧЕНИЕ(Перечисление.ТипыБазыРаспределенияРасходов.КоличествоПродукции)
	|	ИЛИ ДД.БазаРаспределения = ЗНАЧЕНИЕ(Перечисление.ТипыБазыРаспределенияРасходов.ОбъемПродукции)
	|	ИЛИ ДД.БазаРаспределения = ЗНАЧЕНИЕ(Перечисление.ТипыБазыРаспределенияРасходов.ВесПродукции)
	|
	// по плановой стоимости
	|ОБЪЕДИНИТЬ ВСЕ
	|ВЫБРАТЬ
	|	ДД.Регистратор,
	|	ДД.Подразделение,
	|	ДД.Дата,
	|	ДД.Серия,
	|	Данные.ЗаказНаПроизводство,
	|	Данные.КодСтрокиПродукция,
	|	Данные.Этап,
	|	Данные.Количество,
	|	0 КАК Объем,
	|	0 КАК Вес,
	|	Данные.Количество * Цены.Цена КАК Стоимость
	|ИЗ
	|	Распределить КАК ДД
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Данные_ПоПлановойСтоимости КАК Данные
	|		ПО Данные.Организация = ДД.Организация
	|		И (Данные.ГруппаПродукции = ДД.ГруппаПродукции ИЛИ ДД.ПоВсемГруппамПродукции)
	|		И (Данные.Назначение = ДД.Назначение ИЛИ ДД.Назначение = ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка))
	|		И Данные.Подразделение = ДД.Подразделение
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.ЦеныНоменклатуры.СрезПоследних(&ОкончаниеПериода, ВидЦены = &ВидПлановыхЦен) КАК Цены
	|		ПО Цены.Номенклатура = Данные.Номенклатура
	|		И Цены.Характеристика = Данные.Характеристика
	|ГДЕ
	|	ДД.БазаРаспределения = ЗНАЧЕНИЕ(Перечисление.ТипыБазыРаспределенияРасходов.ПлановаяСтоимостьПродукции)
	|
	// по указанным трудозатратам
	|ОБЪЕДИНИТЬ ВСЕ
	|ВЫБРАТЬ
	|	ДД.Регистратор,
	|	ДД.Подразделение,
	|	ДД.Дата,
	|	ДД.Серия,
	|	ВЫБОР
	|		КОГДА Данные.ДокументВыпуска <> ЗНАЧЕНИЕ(Документ.ВыпускПродукции.ПустаяСсылка)
	|			И Данные.ДокументВыпуска <> НЕОПРЕДЕЛЕНО
	|			ТОГДА Данные.ДокументВыпуска
	|		ИНАЧЕ Данные.ЗаказНаПроизводство
	|	КОНЕЦ КАК ЗаказНаПроизводство,
	|	ВЫБОР
	|		КОГДА Данные.ДокументВыпуска <> ЗНАЧЕНИЕ(Документ.ВыпускПродукции.ПустаяСсылка)
	|			И Данные.ДокументВыпуска <> НЕОПРЕДЕЛЕНО
	|			ТОГДА Данные.КодСтроки
	|		ИНАЧЕ Данные.КодСтрокиПродукция
	|	КОНЕЦ КАК КодСтрокиПродукция,
	|	Данные.Этап,
	|	Данные.Количество,
	|	0 КАК Объем,
	|	0 КАК Вес,
	|	0 КАК Стоимость
	|ИЗ
	|	Распределить КАК ДД
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Данные_ПоУказаннымТрудозатратам КАК Данные
	|		ПО Данные.Организация = ДД.Организация
	|		И Данные.Подразделение = ДД.Подразделение
	|		И Данные.ВидРабот = ДД.ВидРабот
	|		И (Данные.ГруппаПродукции = ДД.ГруппаПродукции ИЛИ ДД.ПоВсемГруппамПродукции)
	|		И (Данные.Назначение = ДД.Назначение ИЛИ ДД.Назначение = ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка))
	|ГДЕ
	|	ДД.БазаРаспределения = ЗНАЧЕНИЕ(Перечисление.ТипыБазыРаспределенияРасходов.КоличествоРаботУказанныхВидов)
	|
	// по нормативам
	|ОБЪЕДИНИТЬ ВСЕ
	|ВЫБРАТЬ
	|	ДД.Регистратор,
	|	ДД.Подразделение,
	|	ДД.Дата,
	|	ДД.Серия,
	|	Данные.ЗаказНаПроизводство,
	|	Данные.КодСтрокиПродукция,
	|	Данные.Этап,
	|	(ВЫБОР
	|		КОГДА СУММА(ВЫРАЗИТЬ(Продукция.КоличествоУпаковок * ЕСТЬNULL(&ТекстЗапросаКоэффициентУпаковки, 1) КАК ЧИСЛО(15,3))) <> 0
	|			ТОГДА СУММА(Данные.Количество) * СУММА(Материалы.Количество)
	|				/ СУММА(ВЫРАЗИТЬ(Продукция.КоличествоУпаковок * ЕСТЬNULL(&ТекстЗапросаКоэффициентУпаковки, 1) КАК ЧИСЛО(15,3)))
	|		ИНАЧЕ 0 КОНЕЦ) КАК Количество,
	|	0 КАК Объем,
	|	0 КАК Вес,
	|	0 КАК Стоимость
	|ИЗ
	|	Распределить КАК ДД
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Данные_ПоНормативамРасходаМатериала КАК Данные
	|		ПО Данные.Организация = ДД.Организация
	|		И Данные.Подразделение = ДД.Подразделение
	|		И (Данные.ГруппаПродукции = ДД.ГруппаПродукции ИЛИ ДД.ПоВсемГруппамПродукции)
	|		И (Данные.Назначение = ДД.Назначение ИЛИ ДД.Назначение = ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка))
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК Аналитика
	|		ПО Аналитика.Ссылка = ДД.АналитикаУчетаНоменклатуры
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ МатериалыИУслугиСпецификаций КАК Материалы
	|		ПО Материалы.Ссылка = Данные.Спецификация
	|		И Материалы.Номенклатура = Аналитика.Номенклатура
	|		И (Материалы.Характеристика = Аналитика.Характеристика ИЛИ Материалы.Характеристика = ЗНАЧЕНИЕ(Справочник.ХарактеристикиНоменклатуры.ПустаяСсылка))
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.РесурсныеСпецификации.ВыходныеИзделия КАК Продукция
	|		ПО Продукция.Ссылка = Данные.Спецификация
	|		И ВЫБОР
	|			КОГДА Продукция.Номенклатура = ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка)
	|				ТОГДА ИСТИНА
	|			ИНАЧЕ
	|				Продукция.Номенклатура = Данные.НоменклатураВыпуска
	|				И (Продукция.Характеристика = Данные.ХарактеристикаВыпуска ИЛИ Продукция.Характеристика = ЗНАЧЕНИЕ(Справочник.ХарактеристикиНоменклатуры.ПустаяСсылка))
	|		КОНЕЦ
	|ГДЕ
	|	ДД.БазаРаспределения = ЗНАЧЕНИЕ(Перечисление.ТипыБазыРаспределенияРасходов.НормативРасходаМатериала)
	|
	|СГРУППИРОВАТЬ ПО
	|	ДД.Регистратор,
	|	ДД.Подразделение,
	|	ДД.Дата,
	|	ДД.Серия,
	|	Данные.ЗаказНаПроизводство,
	|	Данные.КодСтрокиПродукция,
	|	Данные.Этап
	|";
	
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "&ТекстЗапросаКоэффициентУпаковки",
		Справочники.УпаковкиЕдиницыИзмерения.ТекстЗапросаКоэффициентаУпаковки(
			"Продукция.Упаковка",
			"Данные.НоменклатураВыпуска"));
	
	Возврат ТекстЗапроса;

КонецФункции

Функция ТекстСуммыПоказателей() // вт ОбщиеСуммы
	Возврат "
	|ВЫБРАТЬ
	|	ДД.Регистратор,
	|	ДД.Серия,
	|	СУММА(ДД.Количество) КАК ОбщееКоличество,
	|	СУММА(ДД.Объем) КАК ОбщийОбъем,
	|	СУММА(ДД.Вес) КАК ОбщийВес,
	|	СУММА(ДД.Стоимость) КАК ОбщаяСтоимость
	|ПОМЕСТИТЬ
	|	ОбщиеСуммы
	|ИЗ
	|	БазаРаспределения КАК ДД
	|СГРУППИРОВАТЬ ПО
	|	ДД.Регистратор,
	|	ДД.Серия
	|";
	
КонецФункции

Функция ТекстОписаниеРаспределениеМатериаловИРабот()
	
	Возврат "
		|ВЫБРАТЬ ПЕРВЫЕ 0
		|	""ХХХХХХХХХХХХХХХХ"" КАК ТипЗаписи,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) КАК ВидДвижения,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КАК РазделУчета,
		|	ДАТАВРЕМЯ(1, 1, 1, 0, 0, 0) КАК Период,
		|	ДД.Регистратор КАК Регистратор,
		|	ЗНАЧЕНИЕ(Справочник.Организации.ПустаяСсылка) КАК Организация,
		|	ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка) КАК Номенклатура,
		|	ЗНАЧЕНИЕ(Справочник.ХарактеристикиНоменклатуры.ПустаяСсылка) КАК Характеристика,
		|	ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка) КАК Подразделение,
		|	ЗНАЧЕНИЕ(Справочник.СерииНоменклатуры.ПустаяСсылка) КАК Серия,
		|	ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка) КАК Назначение,
		|	0 КАК Количество,
		|	ЗНАЧЕНИЕ(Справочник.СтатьиКалькуляции.ПустаяСсылка) КАК СтатьяКалькуляции,
		|	ДД.ЗаказНаПроизводство КАК ЗаказНаПроизводство,
		|	0 КАК КодСтрокиПродукция,
		|	ЗНАЧЕНИЕ(Справочник.ЭтапыПроизводства.ПустаяСсылка) КАК Этап,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КАК АналитикаУчетаПродукции,
		|	ЗНАЧЕНИЕ(Справочник.РесурсныеСпецификации.ПустаяСсылка) КАК Спецификация,
		|	ДД.СтатьяРасходов,
		|	ДД.АналитикаРасходов,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КАК АналитикаУчетаНоменклатуры,
		|	ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка) КАК ПодразделениеПолучатель,
		|	ДД.АналитикаАктивовПассивов,
		|	ДД.ИдентификаторСтроки,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыБазыРаспределенияРасходов.ПустаяСсылка) КАК БазаРаспределения,
		|	0 КАК КРаспределению,
		|	0 КАК Объем,
		|	0 КАК Вес,
		|	0 КАК Стоимость
		|//ВоВременнуюТаблицу ПОМЕСТИТЬ ИсходныеДанные
		|ИЗ
		|	РегистрНакопления.МатериалыИРаботыВПроизводстве КАК ДД
		|";
	
КонецФункции

Функция ТекстКРаспределению() // использует Распределить, ОбщиеСуммы  
	
	Возврат "
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	""Партия"" КАК ТипЗаписи,
	|	ИСТИНА КАК РасчетЗавершен,
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) КАК ВидДвижения,
	|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КАК РазделУчета,
	|	ДД.Дата КАК Период,
	|	ДД.Регистратор,
	|	ДД.Организация,
	|	ДД.Номенклатура,
	|	ДД.Характеристика,
	|	ДД.Подразделение,
	|	ДД.Серия,
	|	ДД.Назначение КАК Назначение,
	|	Итог.ОбщееКоличество КАК Количество,
	|	ДД.СтатьяКалькуляции,
	|	НЕОПРЕДЕЛЕНО КАК ЗаказНаПроизводство,
	|	0 КАК КодСтрокиПродукция,
	|	НЕОПРЕДЕЛЕНО КАК Этап,
	|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаПродукции,
	|	НЕОПРЕДЕЛЕНО КАК Спецификация,
	|	НЕОПРЕДЕЛЕНО КАК СтатьяРасходов,
	|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
	|	ДД.АналитикаУчетаНоменклатуры,
	|	НЕОПРЕДЕЛЕНО КАК ПодразделениеПолучатель,
	|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивовПассивов,
	|	НЕОПРЕДЕЛЕНО КАК ИдентификаторСтроки,
	|	ДД.БазаРаспределения,
	|	ДД.КРаспределению,
	|	Итог.ОбщийОбъем КАК Объем,
	|	Итог.ОбщийВес КАК Вес,
	|	Итог.ОбщаяСтоимость КАК Стоимость
	|ИЗ
	|	Распределить КАК ДД
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ОбщиеСуммы КАК Итог
	|		ПО Итог.Регистратор = ДД.Регистратор
	|		И Итог.Серия = ДД.Серия
	|ГДЕ
	|	ДД.Номенклатура <> ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка)
	|";
	
КонецФункции

Функция ТекстРаспределениеПоБазе() // использует БазаРаспределения
	
	Возврат "
	|ВЫБРАТЬ
	|	""Потребление"" КАК ТипЗаписи,
	|	ЛОЖЬ КАК РасчетЗавершен,
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) КАК ВидДвижения,
	|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КАК РазделУчета,
	|	ДД.Дата КАК Период,
	|	ДД.Регистратор,
	|	НЕОПРЕДЕЛЕНО КАК Организация,
	|	НЕОПРЕДЕЛЕНО КАК Номенклатура,
	|	НЕОПРЕДЕЛЕНО КАК Характеристика,
	|	ДД.Подразделение КАК Подразделение,
	|	ДД.Серия КАК Серия,
	|	НЕОПРЕДЕЛЕНО КАК Назначение,
	|	ДД.Количество,
	|	НЕОПРЕДЕЛЕНО КАК СтатьяКалькуляции,
	|	ДД.ЗаказНаПроизводство,
	|	ДД.КодСтрокиПродукция,
	|	ДД.Этап,
	|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаПродукции,
	|	НЕОПРЕДЕЛЕНО КАК Спецификация,
	|	НЕОПРЕДЕЛЕНО КАК СтатьяРасходов,
	|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
	|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаНоменклатуры,
	|	НЕОПРЕДЕЛЕНО КАК ПодразделениеПолучатель,
	|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивовПассивов,
	|	НЕОПРЕДЕЛЕНО КАК ИдентификаторСтроки,
	|	НЕОПРЕДЕЛЕНО КАК БазаРаспределения,
	|	0 КАК КРаспределению,
	|	ДД.Объем,
	|	ДД.Вес,
	|	ДД.Стоимость
	|ИЗ
	|	БазаРаспределения КАК ДД
	|";
	
КонецФункции

Функция ТекстДополнение()
	
	Возврат "
	|ВЫБРАТЬ
	|	""Дополнение"" КАК ТипЗаписи,
	|	ИСТИНА КАК РасчетЗавершен,
	|	ДД.ВидДвижения,
	|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КАК РазделУчета,
	|	ДД.Период КАК Период,
	|	ДД.Регистратор,
	|	ДД.Организация,
	|	ДД.Номенклатура,
	|	ДД.Характеристика,
	|	ДД.Подразделение,
	|	ДД.Серия,
	|	ДД.Назначение,
	|	ДД.Количество,
	|	ДД.СтатьяКалькуляции,
	|	ДД.ЗаказНаПроизводство,
	|	ДД.КодСтрокиПродукция,
	|	ДД.Этап,
	|	ДД.АналитикаУчетаПродукции,
	|	ДД.Спецификация,
	|	ДД.СтатьяРасходов,
	|	ДД.АналитикаРасходов,
	|	ДД.АналитикаУчетаНоменклатуры,
	|	ДД.ПодразделениеПолучатель,
	|	ДД.АналитикаАктивовПассивов,
	|	ДД.ИдентификаторСтроки,
	|	НЕОПРЕДЕЛЕНО КАК БазаРаспределения,
	|	0 КАК КРаспределению,
	|	0 КАК Объем,
	|	0 КАК Вес,
	|	0 КАК Стоимость
	|ИЗ
	|	РегистрНакопления.МатериалыИРаботыВПроизводстве КАК ДД
	|ГДЕ
	|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
	|	И ДД.Организация В (&МассивОрганизаций)
	|	И ДД.Активность
	|	И ДД.Регистратор ССЫЛКА Документ.РаспределениеПроизводственныхЗатрат
	|	И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|	И ДД.БазаРаспределения = ЗНАЧЕНИЕ(Перечисление.ТипыБазыРаспределенияРасходов.ПустаяСсылка)
	|	И ДД.Номенклатура <> ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка)
	|";
	
КонецФункции

Функция ОтборПоМатериаламИерархия(НачалоПериода, ОкончаниеПериода, МассивОрганизаций, Контекст)
	
	ТекстЗапроса = "";
	Если Контекст = "РаспределениеМатериаловИРабот" Тогда
		ТекстЗапроса = "
		|ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	Д.Ссылка КАК Регистратор,
		|	ТЧ.Материал КАК Материал
		|ИЗ
		|	Документ.РаспределениеПроизводственныхЗатрат.ОтборПоМатериалам КАК ТЧ
		|
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.РаспределениеПроизводственныхЗатрат КАК Д
		|	ПО ТЧ.Ссылка = Д.Ссылка
		|
		|ГДЕ
		|	Д.Дата МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И Д.Организация В (&МассивОрганизаций)
		|	И Д.Проведен";
	ИначеЕсли Контекст = "ПрочиеРасходыНезавершенногоПроизводстваПоБазе" Тогда
		ТекстЗапроса = "
		|ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	Д.Ссылка КАК Регистратор,
		|	ТЧ.Материал КАК Материал
		|ИЗ
		|	Документ.РаспределениеПрочихЗатрат.ОтборПоМатериалам КАК ТЧ
		|
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.РаспределениеПрочихЗатрат КАК Д
		|	ПО ТЧ.Ссылка = Д.Ссылка
		|
		|ГДЕ
		|	Д.Дата МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И Д.Организация В (&МассивОрганизаций)
		|	И Д.Проведен";
	КонецЕсли;
	Запрос = Новый Запрос(ТекстЗапроса);
	Запрос.УстановитьПараметр("НачалоПериода", НачалоПериода);
	Запрос.УстановитьПараметр("ОкончаниеПериода", ОкончаниеПериода);
	Запрос.УстановитьПараметр("МассивОрганизаций", МассивОрганизаций);	
	Материалы = Новый ТаблицаЗначений;
	Материалы.Колонки.Добавить("Регистратор", Документы.ТипВсеСсылки());
	Материалы.Колонки.Добавить("Материал", Новый ОписаниеТипов("СправочникСсылка.Номенклатура"));
	ЗапросИерархия = Новый Запрос("
		|ВЫБРАТЬ
		|	&Док КАК Регистратор,
		|	Н.Ссылка КАК Материал
		|ИЗ
		|	Справочник.Номенклатура КАК Н
		|ГДЕ
		|	Н.Ссылка В ИЕРАРХИИ(&Ном)
		|	И НЕ Н.ЭтоГруппа");
		
	Результат = Запрос.Выполнить().Выбрать();
	Пока Результат.Следующий() Цикл
		ЗапросИерархия.УстановитьПараметр("Док", Результат.Регистратор);
		ЗапросИерархия.УстановитьПараметр("Ном", Результат.Материал);
		РезультатИерархия = ЗапросИерархия.Выполнить().Выбрать();
		Пока РезультатИерархия.Следующий() Цикл
			НоваяСтрока = Материалы.Добавить();
			ЗаполнитьЗначенияСвойств(НоваяСтрока, РезультатИерархия);
		КонецЦикла;
	КонецЦикла;
	
	Возврат Материалы;
	
КонецФункции

Функция ТекстРаспаковкаНаборов() // вт МатериалыИУслугиСпецификаций
	
	ТекстЗапроса = 
	"ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	ИсточникСпискаСпецификаций.Спецификация КАК Спецификация
	|ПОМЕСТИТЬ ВТСпецификации
	|ИЗ
	|	Данные_ПоНормативамРасходаМатериала КАК ИсточникСпискаСпецификаций
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Спецификация
	|;
	|%ТекстЗапросаМатериалыСпецификацийВключаяСоставНаборов%
	|;
	|
	|УНИЧТОЖИТЬ ВТСпецификации
	|";
	
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,
		"%ТекстЗапросаМатериалыСпецификацийВключаяСоставНаборов%",
		Справочники.РесурсныеСпецификации.ТекстЗапросаМатериалыСпецификацийВключаяСоставНаборов("ВТСпецификации"));
	
	Возврат ТекстЗапроса;
	
КонецФункции

#КонецОбласти
//-- НЕ УТ

#Область РасчетПартийПроизводственныхЗатрат

Функция ДанныеДляПартийПроизводства(НачалоПериода, ОкончаниеПериода, МассивОрганизаций)
	ТекстСортировка = "
		|УПОРЯДОЧИТЬ ПО
		|	Номенклатура, Приоритет ВОЗР, ПериодПоступления, Регистратор, Назначение
		//++ НЕ УТ
		|	,ЗаказНаПроизводство, КодСтрокиПродукция, Этап 
		//-- НЕ УТ
		|";
	ТекстИндексы = "
		|ИНДЕКСИРОВАТЬ ПО
		|	Номенклатура
		|";	
	ИсходныйТекстЗапроса =
		ТекстПартииПроизводстваИнициализация() + ";" // вт МатериалыИРаботыВПроизводстве, ПрошлыеПоступления, ПрошлыеРеализации
		+ ТекстОписаниеДанныхДляПартийПроизводства()
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстОстаткиПартийПроизводства() // использует ПрошлыеПоступления
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстПервичныеПартииПроизводства()
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстПервичныеПеремещенияПартийПроизводства()
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстПоступленияВПроизводство()
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстПотребленияВПроизводстве()
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстРеализацииРаботПрошлыхМесяцев() // использует ПрошлыеРеализации

		//++ НЕ УТ
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстПервичныеПартииПроизводстваБезПУ()
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстДополнениеПартийПроизводства()
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстДополнениеПрошлыеДвижения()
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстПеремещенияВПроизводстве()
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстПотребленияОтчетомПереработчика()
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстПотребленияОтчетомПереработчикаВозвратныеОтходы()
		//-- НЕ УТ
		+ ТекстИндексы;
	МВТ = Новый МенеджерВременныхТаблиц;	
	ИсходныйЗапрос = Новый Запрос(СтрЗаменить(ИсходныйТекстЗапроса, "//ВоВременнуюТаблицу", ""));
	ИсходныйЗапрос.УстановитьПараметр("НачалоПериода", НачалоПериода);
	ИсходныйЗапрос.УстановитьПараметр("ОкончаниеПериода", ОкончаниеПериода);	
	ИсходныйЗапрос.УстановитьПараметр("МассивОрганизаций", МассивОрганизаций);	
	ИсходныйЗапрос.УстановитьПараметр("ПартионныйУчетВключен", РасчетСебестоимостиПовтИсп.ПартионныйУчетВерсии21(НачалоПериода));
	ИсходныйЗапрос.МенеджерВременныхТаблиц = МВТ;
	ИсходныйЗапрос.Выполнить();
	
	Запрос = Новый Запрос(ТекстОписаниеДанныхДляПартийПроизводства());
	РасчетныеПартии = Запрос.Выполнить().Выгрузить();
	
	ВременнаяТаблицаДанныхПоОтбору("Номенклатура", ТекстСортировка, РасчетныеПартии, МВТ);
	
	Возврат МВТ;
КонецФункции

Функция РасчетныеПартииПроизводства(ДанныеДляРасчета, Регистраторы, ВнутренниеДанные = Неопределено, Тест = Ложь)
	
	// Шаг 1: создаем буфер накопления рассчитанных партий
	Запрос = Новый Запрос(ТекстОписаниеДанныхДляПартийПроизводства());
	РасчетныеПартии = Запрос.Выполнить().Выгрузить();
	
	// Шаг 2: обсчитываем цепочки движений по передачам, возвратам, перемещениям, порчам, пересортицам и т.д.
	КонтекстЦепочек = ОписаниеЦепочек("Потребление, ПотреблениеАвто, Партия, Остаток, ОстатокСторно, Сторно, ПартияСторно, Перемещение, Списание, Дополнение, ВозвратСторно, Корректировка,
									|Прошлое, Возврат");
	
	ПоляПотреблений = "Организация, АналитикаУчетаНоменклатуры, Назначение";
	ДобавитьОписаниеПриемника(КонтекстЦепочек, "Потребление", ПоляПотреблений);
	ДобавитьОписаниеИсточника(КонтекстЦепочек, "Потребление", "Партия", ПоляПотреблений);
	ДобавитьОписаниеИсточника(КонтекстЦепочек, "Потребление", "Остаток", ПоляПотреблений);
	ДобавитьОписаниеИсточника(КонтекстЦепочек, "Потребление", "Перемещение", ПоляПотреблений);
	
	ДобавитьОписаниеПриемника(КонтекстЦепочек, "ПотреблениеАвто", "Организация, АналитикаУчетаНоменклатуры, ВидЗапасов");
	ДобавитьОписаниеИсточника(КонтекстЦепочек, "ПотреблениеАвто", "Партия", "Организация, АналитикаУчетаНоменклатуры, ВидЗапасов");
	ДобавитьОписаниеИсточника(КонтекстЦепочек, "ПотреблениеАвто", "Остаток", "Организация, АналитикаУчетаНоменклатуры, ВидЗапасов");
	ДобавитьОписаниеИсточника(КонтекстЦепочек, "ПотреблениеАвто", "Перемещение", "Организация, АналитикаУчетаНоменклатуры, ВидЗапасов");
	
	ДобавитьОписаниеПриемника(КонтекстЦепочек, "Корректировка", "ДокументПоступления, АналитикаУчетаНоменклатуры, ВидЗапасов, Организация");
	ДобавитьОписаниеИсточника(КонтекстЦепочек, "Корректировка", "Остаток", "ДокументПоступления, АналитикаУчетаНоменклатуры, ВидЗапасов, Организация");
	ДобавитьОписаниеИсточника(КонтекстЦепочек, "Корректировка", "Партия", "ДокументПоступления, АналитикаУчетаНоменклатуры, ВидЗапасов, Организация");
	
	ДобавитьОписаниеПриемника(КонтекстЦепочек, "ВозвратСторно", "ДокументИсточник, ДокументПоступления, АналитикаУчетаНоменклатуры, ВидЗапасов, Организация");
	ДобавитьОписаниеИсточника(КонтекстЦепочек, "ВозвратСторно", "Остаток", "Регистратор, ДокументПоступления, АналитикаУчетаНоменклатуры, ВидЗапасов, Организация");
	ДобавитьОписаниеИсточника(КонтекстЦепочек, "ВозвратСторно", "Партия", "Регистратор, ДокументПоступления, АналитикаУчетаНоменклатуры, ВидЗапасов, Организация");
	
	ДобавитьОписаниеПриемника(КонтекстЦепочек, "Возврат", "ДокументИсточник, АналитикаУчетаНоменклатуры, Организация");
	ДобавитьОписаниеИсточника(КонтекстЦепочек, "Возврат", "Прошлое", "Регистратор, АналитикаУчетаНоменклатуры, Организация");
	ДобавитьОписаниеИсточника(КонтекстЦепочек, "Возврат", "Потребление", "Регистратор, АналитикаУчетаНоменклатуры, Организация");
	
	ДобавитьОписаниеПриемника(КонтекстЦепочек, "Списание", "Регистратор, ДокументПоступления, АналитикаУчетаНоменклатуры, ВидЗапасов, Организация");
	ДобавитьОписаниеИсточника(КонтекстЦепочек, "Списание", "Партия", "Регистратор, ДокументПоступления, АналитикаУчетаНоменклатуры, ВидЗапасов, Организация");
	
	ДобавитьОписаниеПриемника(КонтекстЦепочек, "Сторно", ПоляПотреблений);
	ДобавитьОписаниеИсточника(КонтекстЦепочек, "Сторно", "ОстатокСторно", ПоляПотреблений);
	ДобавитьОписаниеИсточника(КонтекстЦепочек, "Сторно", "ПартияСторно", ПоляПотреблений);
	ДобавитьОписаниеИсточника(КонтекстЦепочек, "Сторно", "Остаток", ПоляПотреблений);
	ДобавитьОписаниеИсточника(КонтекстЦепочек, "Сторно", "Партия", ПоляПотреблений);
	
	ДобавитьОписаниеПриемника(КонтекстЦепочек, "Перемещение", "ДокументИсточник, АналитикаУчетаНоменклатуры");
	ДобавитьОписаниеИсточника(КонтекстЦепочек, "Перемещение", "Потребление", "Регистратор, КорАналитикаУчетаНоменклатуры");
	
	// Шаг 3: замена ложных партий на первичные партии в расчетных строках по результатам построение графа замен.
	КонтекстДвижений = ОписаниеДвижений(
		"ПартииПроизводственныхЗатрат",
		"ПартииПроизводственныхЗатрат",
		ПереченьПолей(РасчетныеПартии.Колонки),
		ПоляПотреблений,
		"Количество, Стоимость, СтоимостьБезНДС, СтоимостьРегл, НДСРегл, ПостояннаяРазница, ВременнаяРазница",
		"Количество", "Количество", "ДокументИсточник", "Период"
		//++ НЕ УТ
		, "ГруппаПродукции, НалогообложениеПартии"
		//-- НЕ УТ
		);
	КонтекстДвижений.Вставить("ЗаполнятьАналитикуПартий", Истина);
	ЦепочкиДвижений(КонтекстЦепочек, ДанныеДляРасчета);
	РассчитатьПартииПоЦепочкам(КонтекстДвижений, ДанныеДляРасчета, РасчетныеПартии, Регистраторы, Тест);
	ВнутренниеДанные = ДанныеДляРасчета;
	
	// Шаг 4: Удаляем нерассчитанные партии
	УдалитьНезаписываемыеСтроки(КонтекстДвижений.Контекст, РасчетныеПартии);
	
	Возврат РасчетныеПартии;
	
КонецФункции

Функция ТекстПартииПроизводстваИнициализация() // вт МатериалыИРаботыВПроизводстве, МатериалыИРаботыРегистраторы, ПрошлыеПоступления, ПрошлыеРеализации
	Возврат "
		|ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	ДД.Регистратор КАК Регистратор,
		|	ДД.АналитикаУчетаНоменклатуры
		|ПОМЕСТИТЬ
		|	МатериалыИРаботыВПроизводстве
		|ИЗ
		|	РегистрНакопления.МатериалыИРаботыВПроизводстве КАК ДД
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|;
		|ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	ДД.Регистратор КАК Регистратор
		|ПОМЕСТИТЬ
		|	МатериалыИРаботыРегистраторы
		|ИЗ
		|	РегистрНакопления.МатериалыИРаботыВПроизводстве КАК ДД
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|;
		|ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	ДД.ДокументПоступления КАК Ссылка,
		|	ДД.АналитикаУчетаНоменклатуры.МестоХранения КАК Склад,
		|	МАКСИМУМ(Периодика.Регистратор) КАК Регистратор,
		|	МАКСИМУМ(Периодика.Период) КАК Период
		|ПОМЕСТИТЬ
		|	ПрошлыеПоступления
		|ИЗ
		|	РегистрНакопления.ПартииПроизводственныхЗатрат.Остатки(&НачалоПериода, Организация В (&МассивОрганизаций)) КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрНакопления.ПартииПроизводственныхЗатрат КАК Периодика
		|		ПО Периодика.Период < &НачалоПериода
		|		И Периодика.ДокументПоступления = ДД.ДокументПоступления
		|		И Периодика.АналитикаУчетаНоменклатуры.МестоХранения = ДД.АналитикаУчетаНоменклатуры.МестоХранения
		|ГДЕ
		|	ДД.ДокументПоступления <> НЕОПРЕДЕЛЕНО
		|	И Периодика.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|	И Периодика.Количество > 0
		|СГРУППИРОВАТЬ ПО
		|	ДД.ДокументПоступления,
		|	ДД.АналитикаУчетаНоменклатуры.МестоХранения
		|;
		|ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	Корректировка.ДокументОснование КАК ДокументРеализации,
		|	ДД.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры
		|ПОМЕСТИТЬ
		|	ПрошлыеРеализации
		|ИЗ
		|	РегистрНакопления.МатериалыИРаботыВПроизводстве КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.КорректировкаРеализации КАК Корректировка
		|		ПО Корректировка.Ссылка = ДД.Регистратор
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрНакопления.МатериалыИРаботыВПроизводстве КАК Расход
		|		ПО Расход.Период < &НачалоПериода
		|		И Расход.Регистратор = Корректировка.ДокументОснование
		|		И Расход.АналитикаУчетаНоменклатуры = ДД.АналитикаУчетаНоменклатуры
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		|	И ДД.Количество < 0
		|";
КонецФункции

Функция ТекстОписаниеДанныхДляПартийПроизводства()
	Возврат "
		|ВЫБРАТЬ ПЕРВЫЕ 0
		|	ВЫРАЗИТЬ("""" КАК СТРОКА(80)) КАК ЗапросИсточник,
		|	0 КАК Приоритет,
		|	""ХХХХХХХХХХХХХХХХ"" КАК ТипЗаписи,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
		|	ДАТАВРЕМЯ(1, 1, 1, 0, 0, 0) КАК Период,
		|	ДД.Регистратор,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КАК РазделУчета,
		|	ЗНАЧЕНИЕ(Справочник.Организации.ПустаяСсылка) КАК Организация,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КАК АналитикаУчетаНоменклатуры,
		|	ДД.ДокументПоступления,
		|	ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка) КАК ВидЗапасов,
		//++ НЕ УТ
		|	ЗНАЧЕНИЕ(Справочник.ГруппыАналитическогоУчетаНоменклатуры.ПустаяСсылка) КАК ГруппаПродукции,
		//-- НЕ УТ
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка) КАК АналитикаУчетаПартий,
		|	0 КАК Количество,
		|	0 КАК Стоимость,
		|	0 КАК СтоимостьБезНДС,
		|	0 КАК СтоимостьРегл,
		|	0 КАК НДСРегл,
		|	0 КАК ПостояннаяРазница,
		|	0 КАК ВременнаяРазница,
		|	ЛОЖЬ КАК Первичное,
		|	ЛОЖЬ КАК СохранятьРегл,
		|	ДАТАВРЕМЯ(1, 1, 1, 0, 0, 0) КАК ПериодПоступления,
		|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПустаяСсылка) КАК ХозяйственнаяОперация,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КАК КорРазделУчета,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КАК КорАналитикаУчетаНоменклатуры,
		|	ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка) КАК КорВидЗапасов,
		|	ДАТАВРЕМЯ(1, 1, 1, 0, 0, 0) КАК ДатаРегистратора,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка) КАК НалогообложениеПартии,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка) КАК НалогообложениеНДС,
		|	ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка) КАК Назначение,
		|	ДД.ДокументИсточник,
		//++ НЕ УТ
		|	ЗНАЧЕНИЕ(Справочник.СтатьиКалькуляции.ПустаяСсылка) КАК СтатьяКалькуляции,
		|	ЗНАЧЕНИЕ(Справочник.РесурсныеСпецификации.ПустаяСсылка) КАК Спецификация,
		|	ДД.ЗаказНаПроизводство,
		|	0 КАК КодСтрокиПродукция,
		|	ЗНАЧЕНИЕ(Справочник.ЭтапыПроизводства.ПустаяСсылка) КАК Этап,
		//-- НЕ УТ
		|	ДД.СтатьяРасходовСписания,
		|	ДД.АналитикаРасходов,
		|	ДД.ПодразделениеРасходов,
		|	0 КАК НомерГруппыЗатрат,
		|	ДД.АналитикаАктивовПассивов,
		|	ДД.ИдентификаторСтроки,
		|	ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка) КАК Номенклатура,
		|	ДД.СтатьяСписанияНДС,
		|	ДД.АналитикаСписанияНДС
		|//ВоВременнуюТаблицу ПОМЕСТИТЬ ИсходныеДанные
		|ИЗ
		|	РегистрНакопления.ПартииПроизводственныхЗатрат КАК ДД
		|";
КонецФункции

Функция ТекстОстаткиПартийПроизводства() // использует ПрошлыеПоступления
	// передачи материалов в производство и в переработку, возвраты материалов из производства и от переработчика.
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстОстаткиПартийПроизводства"" КАК ЗапросИсточник,
		|	(ВЫБОР
		|		КОГДА ДД.КоличествоОстаток < 0 ТОГДА 5
		|		ИНАЧЕ 10 КОНЕЦ) КАК Приоритет,
		|	(ВЫБОР
		|		КОГДА ДД.КоличествоОстаток < 0 ТОГДА ""ОстатокСторно""
		|		ИНАЧЕ ""Остаток"" КОНЕЦ) КАК ТипЗаписи,
		|	ИСТИНА КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
		|	ЕСТЬNULL(Периодика.Период, &НачалоПериода) КАК Период,
		|	ЕСТЬNULL(Периодика.Регистратор, ДД.ДокументПоступления) КАК Регистратор,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты) КАК РазделУчета,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ДокументПоступления,
		|	ДД.ВидЗапасов,
		//++ НЕ УТ
		|	ДД.ВидЗапасов.ГруппаПродукции КАК ГруппаПродукции,
		//-- НЕ УТ
		|	ДД.АналитикаУчетаПартий,
		|	ДД.КоличествоОстаток КАК Количество,
		|	ДД.СтоимостьОстаток КАК Стоимость,
		|	ДД.СтоимостьБезНДСОстаток КАК СтоимостьБезНДС,
		|	ДД.СтоимостьРеглОстаток КАК СтоимостьРегл,
		|	ДД.НДСРеглОстаток КАК НДСРегл,
		|	ДД.ПостояннаяРазницаОстаток КАК ПостояннаяРазница,
		|	ДД.ВременнаяРазницаОстаток КАК ВременнаяРазница,
		|	ИСТИНА КАК Первичное,
		|	ЛОЖЬ КАК СохранятьРегл,
		|	ЕСТЬNULL(Периодика.Период, &НачалоПериода) КАК ПериодПоступления,
		|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПустаяСсылка) КАК ХозяйственнаяОперация,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КАК КорРазделУчета,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КАК КорАналитикаУчетаНоменклатуры,
		|	ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка) КАК КорВидЗапасов,
		|	ДАТАВРЕМЯ(1, 1, 1, 0, 0, 0) КАК ДатаРегистратора,
		|	ДД.АналитикаУчетаПартий.НалогообложениеНДС КАК НалогообложениеПартии,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка) КАК НалогообложениеНДС,
		|	ЕСТЬNULL(ДД.АналитикаУчетаНоменклатуры.Назначение, ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка)) КАК Назначение,
		|	НЕОПРЕДЕЛЕНО КАК ДокументИсточник,
		//++ НЕ УТ
		|	НЕОПРЕДЕЛЕНО КАК СтатьяКалькуляции,
		|	НЕОПРЕДЕЛЕНО КАК Спецификация,
		|	НЕОПРЕДЕЛЕНО КАК ЗаказНаПроизводство,
		|	0 КАК КодСтрокиПродукция,
		|	НЕОПРЕДЕЛЕНО КАК Этап,
		//-- НЕ УТ
		|	НЕОПРЕДЕЛЕНО КАК СтатьяРасходовСписания,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
		|	ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка) КАК ПодразделениеРасходов,
		|	0 КАК НомерГруппыЗатрат,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивовПассивов,
		|	НЕОПРЕДЕЛЕНО КАК ИдентификаторСтроки,
		|	Аналитика.Номенклатура,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаСписанияНДС
		|ИЗ
		|	РегистрНакопления.ПартииПроизводственныхЗатрат.Остатки(&НачалоПериода, Организация В (&МассивОрганизаций)) КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК Аналитика
		|		ПО Аналитика.Ссылка = ДД.АналитикаУчетаНоменклатуры
		|	ЛЕВОЕ СОЕДИНЕНИЕ ПрошлыеПоступления КАК Периодика
		|		ПО Периодика.Ссылка = ДД.ДокументПоступления
		|		И Периодика.Склад = ДД.АналитикаУчетаНоменклатуры.МестоХранения
		|ГДЕ
		|	ДД.КоличествоОстаток <> 0
		|";
КонецФункции

Функция ТекстПоступленияВПроизводство()
	// Передачи материалов в производство и в переработку, возвраты материалов из производства и от переработчика.
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстПоступленияВПроизводство"" КАК ЗапросИсточник,
		|	(ВЫБОР
		|		КОГДА ДД.Количество < 0 ТОГДА 5
		|		ИНАЧЕ 10 КОНЕЦ) КАК Приоритет,
		|	(ВЫБОР
		|		КОГДА ДД.Количество < 0 ТОГДА ""ВозвратСторно""
		|		ИНАЧЕ ""Партия"" КОНЕЦ) КАК ТипЗаписи,
		|	(ВЫБОР
		|		КОГДА ДД.Количество < 0 ТОГДА ЛОЖЬ
		|		ИНАЧЕ ИСТИНА КОНЕЦ) КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты) КАК РазделУчета,
		|	ДД.Организация,
		|	ДД.КорАналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
		|	ДД.ДокументПоступления,
		|	(ВЫБОР
		|		КОГДА ДД.КорВидЗапасов <> ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка)
		|		 И ДД.КорВидЗапасов.ТипЗапасов <> ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.КомиссионныйТовар)
		|			ТОГДА ДД.КорВидЗапасов
		|		ИНАЧЕ ДД.ВидЗапасов КОНЕЦ) КАК ВидЗапасов,
		//++ НЕ УТ
		|	ДД.КорВидЗапасов.ГруппаПродукции КАК ГруппаПродукции,
		//-- НЕ УТ
		|	ДД.АналитикаУчетаПартий,
		|	СУММА(ДД.Количество) КАК Количество,
		|	СУММА(ДД.Стоимость) КАК Стоимость,
		|	СУММА(ДД.СтоимостьБезНДС) КАК СтоимостьБезНДС,
		|	СУММА(ДД.СтоимостьРегл) КАК СтоимостьРегл,
		|	СУММА(ВЫБОР
		|			КОГДА ДД.СтатьяСписанияНДС <> ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка)
		|			ТОГДА 0
		|			ИНАЧЕ ДД.НДСРегл
		|		КОНЕЦ) КАК НДСРегл,
		|	СУММА(ДД.ПостояннаяРазница) КАК ПостояннаяРазница,
		|	СУММА(ДД.ВременнаяРазница) КАК ВременнаяРазница,
		|	ИСТИНА КАК Первичное,
		|	ЛОЖЬ КАК СохранятьРегл,
		|	(ВЫБОР
		|		КОГДА ДД.Количество < 0 ТОГДА &НачалоПериода
		|		ИНАЧЕ ДД.Период КОНЕЦ) КАК ПериодПоступления,
		|	ДД.ХозяйственнаяОперация,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыНаСкладах) КАК КорРазделУчета,
		|	ДД.АналитикаУчетаНоменклатуры КАК КорАналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов КАК КорВидЗапасов,
		|	ДАТАВРЕМЯ(1, 1, 1, 0, 0, 0) КАК ДатаРегистратора,
		|	ДД.АналитикаУчетаПартий.НалогообложениеНДС КАК НалогообложениеПартии,
		|	ДД.НалогообложениеНДС,
		|	ЕСТЬNULL(ДД.КорАналитикаУчетаНоменклатуры.Назначение, ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка)) КАК Назначение,
		|	ДД.ДокументИсточник,
		//++ НЕ УТ
		|	НЕОПРЕДЕЛЕНО КАК СтатьяКалькуляции,
		|	НЕОПРЕДЕЛЕНО КАК Спецификация,
		|	НЕОПРЕДЕЛЕНО КАК ЗаказНаПроизводство,
		|	0 КАК КодСтрокиПродукция,
		|	НЕОПРЕДЕЛЕНО КАК Этап,
		//-- НЕ УТ
		|	НЕОПРЕДЕЛЕНО КАК СтатьяРасходовСписания,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
		|	ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка) КАК ПодразделениеРасходов,
		|	0 КАК НомерГруппыЗатрат,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивовПассивов,
		|	НЕОПРЕДЕЛЕНО КАК ИдентификаторСтроки,
		|	Аналитика.Номенклатура,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаСписанияНДС
		|ИЗ
		|	РегистрНакопления.ПартииТоваровОрганизаций КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК Аналитика
		|		ПО Аналитика.Ссылка = ДД.АналитикаУчетаНоменклатуры
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ МатериалыИРаботыВПроизводстве КАК Затраты
		|		ПО Затраты.Регистратор = ДД.Регистратор
		|		И Затраты.АналитикаУчетаНоменклатуры = ДД.КорАналитикаУчетаНоменклатуры
		|	ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ВидыЗапасов КАК СпрВидыЗапасов
		|		ПО СпрВидыЗапасов.Ссылка = ДД.ВидЗапасов
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И НЕ ДД.Первичное
		|	И ЕСТЬNULL(СпрВидыЗапасов.ТипЗапасов, НЕОПРЕДЕЛЕНО) <> ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.КомиссионныйТовар)
		|	И &ПартионныйУчетВключен
		|СГРУППИРОВАТЬ ПО
		|	(ВЫБОР
		|		КОГДА ДД.Количество < 0 ТОГДА 5
		|		ИНАЧЕ 10 КОНЕЦ),
		|	(ВЫБОР
		|		КОГДА ДД.Количество < 0 ТОГДА ""ВозвратСторно""
		|		ИНАЧЕ ""Партия"" КОНЕЦ),
		|	(ВЫБОР
		|		КОГДА ДД.Количество < 0 ТОГДА ЛОЖЬ
		|		ИНАЧЕ ИСТИНА КОНЕЦ),
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.КорАналитикаУчетаНоменклатуры,
		|	ДД.ДокументПоступления,
		|	(ВЫБОР
		|		КОГДА ДД.КорВидЗапасов <> ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка)
		|		 И ДД.КорВидЗапасов.ТипЗапасов <> ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.КомиссионныйТовар)
		|			ТОГДА ДД.КорВидЗапасов
		|		ИНАЧЕ ДД.ВидЗапасов КОНЕЦ),
		//++ НЕ УТ
		|	ДД.КорВидЗапасов.ГруппаПродукции,
		//-- НЕ УТ
		|	ДД.АналитикаУчетаПартий,
		|	(ВЫБОР
		|		КОГДА ДД.Количество < 0 ТОГДА &НачалоПериода
		|		ИНАЧЕ ДД.Период КОНЕЦ),
		|	ДД.ХозяйственнаяОперация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов,
		|	ДД.НалогообложениеНДС,
		|	ЕСТЬNULL(ДД.КорАналитикаУчетаНоменклатуры.Назначение, ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка)),
		|	ДД.ДокументИсточник,
		|	Аналитика.Номенклатура
		|";
КонецФункции

Функция ТекстПервичныеПартииПроизводства()
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстПервичныеПартииПроизводства"" КАК ЗапросИсточник,
		|	(ВЫБОР
		|		КОГДА ДД.Количество < 0 ТОГДА 5
		|		ИНАЧЕ 10 КОНЕЦ) КАК Приоритет,
		|	(ВЫБОР
		|		КОГДА НЕ Корректировка.Ссылка ЕСТЬ NULL И ДД.Количество <= 0 ТОГДА ""Корректировка""
		|		КОГДА ДД.Количество < 0 ТОГДА ""ПартияСторно""
		|		ИНАЧЕ ""Партия"" КОНЕЦ) КАК ТипЗаписи,
		|	(ВЫБОР
		|		КОГДА НЕ Корректировка.Ссылка ЕСТЬ NULL И ДД.Количество <= 0 ТОГДА ЛОЖЬ
		|		ИНАЧЕ ИСТИНА КОНЕЦ) КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты) КАК РазделУчета,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ДокументПоступления,
		|	ДД.ВидЗапасов,
		//++ НЕ УТ
		|	ДД.ВидЗапасов.ГруппаПродукции КАК ГруппаПродукции,
		//-- НЕ УТ
		|	ДД.АналитикаУчетаПартий,
		|	СУММА(ДД.Количество) КАК Количество,
		|	СУММА(ДД.Стоимость) КАК Стоимость,
		|	СУММА(ДД.СтоимостьБезНДС) КАК СтоимостьБезНДС,
		|	СУММА(ДД.СтоимостьРегл) КАК СтоимостьРегл,
		|	СУММА(ДД.НДСРегл) КАК НДСРегл,
		|	СУММА(ДД.ПостояннаяРазница) КАК ПостояннаяРазница,
		|	СУММА(ДД.ВременнаяРазница) КАК ВременнаяРазница,
		|	ИСТИНА КАК Первичное,
		|	ЛОЖЬ КАК СохранятьРегл,
		|	(ВЫБОР
		|		КОГДА НЕ Корректировка.Ссылка ЕСТЬ NULL ТОГДА Поступление.Дата
		|		ИНАЧЕ ДД.Период КОНЕЦ) КАК ПериодПоступления,
		|	НЕОПРЕДЕЛЕНО КАК ХозяйственнаяОперация,
		|	НЕОПРЕДЕЛЕНО КАК КорРазделУчета,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаУчетаНоменклатуры,
		|	НЕОПРЕДЕЛЕНО КАК КорВидЗапасов,
		|	ДАТАВРЕМЯ(1, 1, 1, 0, 0, 0) КАК ДатаРегистратора,
		|	ДД.АналитикаУчетаПартий.НалогообложениеНДС КАК НалогообложениеПартии,
		|	НЕОПРЕДЕЛЕНО КАК НалогообложениеНДС,
		|	ЕСТЬNULL(ДД.АналитикаУчетаНоменклатуры.Назначение, ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка)) КАК Назначение,
		|	НЕОПРЕДЕЛЕНО КАК ДокументИсточник,
		//++ НЕ УТ
		|	НЕОПРЕДЕЛЕНО КАК СтатьяКалькуляции,
		|	НЕОПРЕДЕЛЕНО КАК Спецификация,
		|	НЕОПРЕДЕЛЕНО КАК ЗаказНаПроизводство,
		|	0 КАК КодСтрокиПродукция,
		|	НЕОПРЕДЕЛЕНО КАК Этап,
		//-- НЕ УТ
		|	НЕОПРЕДЕЛЕНО КАК СтатьяРасходовСписания,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
		|	ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка) КАК ПодразделениеРасходов,
		|	0 КАК НомерГруппыЗатрат,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивовПассивов,
		|	НЕОПРЕДЕЛЕНО КАК ИдентификаторСтроки,
		|	Аналитика.Номенклатура,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаСписанияНДС
		|ИЗ
		|	РегистрНакопления.ПартииПроизводственныхЗатрат КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК Аналитика
		|		ПО Аналитика.Ссылка = ДД.АналитикаУчетаНоменклатуры
		|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.КорректировкаПриобретения КАК Корректировка
		|		ПО Корректировка.Ссылка = ДД.Регистратор
		|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.ПриобретениеТоваровУслуг КАК Поступление
		|		ПО Поступление.Ссылка = ДД.ДокументПоступления
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|	И (ДД.Регистратор ССЫЛКА Документ.ПриобретениеТоваровУслуг
		|		ИЛИ ДД.Регистратор ССЫЛКА Документ.КорректировкаПриобретения
		|		ИЛИ ДД.Регистратор ССЫЛКА Документ.ВводОстатков
		//++ НЕ УТ
		|		ИЛИ ДД.Регистратор ССЫЛКА Документ.ВыпускПродукции
		|		ИЛИ ДД.Регистратор ССЫЛКА Документ.ПоступлениеОтПереработчика
		//-- НЕ УТ
		|		)
		|СГРУППИРОВАТЬ ПО
		|	(ВЫБОР
		|		КОГДА ДД.Количество < 0 ТОГДА 5
		|		ИНАЧЕ 10 КОНЕЦ),
		|	(ВЫБОР
		|		КОГДА НЕ Корректировка.Ссылка ЕСТЬ NULL И ДД.Количество <= 0 ТОГДА ""Корректировка""
		|		КОГДА ДД.Количество < 0 ТОГДА ""ПартияСторно""
		|		ИНАЧЕ ""Партия"" КОНЕЦ),
		|	(ВЫБОР
		|		КОГДА НЕ Корректировка.Ссылка ЕСТЬ NULL И ДД.Количество <= 0 ТОГДА ЛОЖЬ
		|		ИНАЧЕ ИСТИНА КОНЕЦ),
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ДокументПоступления,
		|	ДД.ВидЗапасов,
		|	ЕСТЬNULL(ДД.АналитикаУчетаНоменклатуры.Назначение, ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка)),
		|	(ВЫБОР
		|		КОГДА НЕ Корректировка.Ссылка ЕСТЬ NULL ТОГДА Поступление.Дата
		|		ИНАЧЕ ДД.Период КОНЕЦ),
		|	ДД.АналитикаУчетаПартий,
		|	Аналитика.Номенклатура
		|";
КонецФункции

Функция ТекстПервичныеПеремещенияПартийПроизводства()
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстПервичныеПеремещенияПартийПроизводства"" КАК ЗапросИсточник,
		|	90 КАК Приоритет,
		|	""Перемещение"" КАК ТипЗаписи,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты) КАК РазделУчета,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ДокументПоступления,
		|	ДД.ВидЗапасов,
		//++ НЕ УТ
		|	ДД.ВидЗапасов.ГруппаПродукции КАК ГруппаПродукции,
		//-- НЕ УТ
		|	ДД.АналитикаУчетаПартий,
		|	СУММА(ДД.Количество) КАК Количество,
		|	0 КАК Стоимость,
		|	0 КАК СтоимостьБезНДС,
		|	СУММА(ДД.СтоимостьРегл) КАК СтоимостьРегл,
		|	СУММА(ДД.НДСРегл) КАК НДСРегл,
		|	0 КАК ПостояннаяРазница,
		|	0 КАК ВременнаяРазница,
		|	ИСТИНА КАК Первичное,
		|	ИСТИНА КАК СохранятьРегл,
		|	ДД.Период КАК ПериодПоступления,
		|	НЕОПРЕДЕЛЕНО КАК ХозяйственнаяОперация,
		|	НЕОПРЕДЕЛЕНО КАК КорРазделУчета,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаУчетаНоменклатуры,
		|	НЕОПРЕДЕЛЕНО КАК КорВидЗапасов,
		|	ДАТАВРЕМЯ(1, 1, 1, 0, 0, 0) КАК ДатаРегистратора,
		|	ДД.АналитикаУчетаПартий.НалогообложениеНДС КАК НалогообложениеПартии,
		|	НЕОПРЕДЕЛЕНО КАК НалогообложениеНДС,
		|	ЕСТЬNULL(ДД.АналитикаУчетаНоменклатуры.Назначение, ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка)) КАК Назначение,
		|	ДД.Регистратор КАК ДокументИсточник,
		//++ НЕ УТ
		|	НЕОПРЕДЕЛЕНО КАК СтатьяКалькуляции,
		|	НЕОПРЕДЕЛЕНО КАК Спецификация,
		|	НЕОПРЕДЕЛЕНО КАК ЗаказНаПроизводство,
		|	0 КАК КодСтрокиПродукция,
		|	НЕОПРЕДЕЛЕНО КАК Этап,
		//-- НЕ УТ
		|	НЕОПРЕДЕЛЕНО КАК СтатьяРасходовСписания,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
		|	ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка) КАК ПодразделениеРасходов,
		|	0 КАК НомерГруппыЗатрат,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивовПассивов,
		|	НЕОПРЕДЕЛЕНО КАК ИдентификаторСтроки,
		|	Аналитика.Номенклатура,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаСписанияНДС
		|ИЗ
		|	РегистрНакопления.ПартииПроизводственныхЗатрат КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК Аналитика
		|		ПО Аналитика.Ссылка = ДД.АналитикаУчетаНоменклатуры
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|	И ДД.Регистратор ССЫЛКА Документ.ПередачаТоваровМеждуОрганизациями
		|СГРУППИРОВАТЬ ПО
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ДокументПоступления,
		|	ДД.ВидЗапасов,
		|	ЕСТЬNULL(ДД.АналитикаУчетаНоменклатуры.Назначение, ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка)),
		|	ДД.АналитикаУчетаПартий,
		|	Аналитика.Номенклатура
		|";
КонецФункции

Функция ТекстПотребленияВПроизводстве()
	// распределение материалов на выпуск, списание
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстПотребленияВПроизводстве"" КАК ЗапросИсточник,
		|	(ВЫБОР
		|		КОГДА ДД.Количество < 0 ТОГДА 35
		|		ИНАЧЕ 40 КОНЕЦ) КАК Приоритет,
		|	(ВЫБОР
		|		КОГДА НЕ Корректировка.Ссылка ЕСТЬ NULL И ДД.Количество < 0
		|			ТОГДА ""Возврат""
		|		КОГДА ДД.Количество < 0 ТОГДА ""Сторно""
		|		ИНАЧЕ ""Потребление"" КОНЕЦ) КАК ТипЗаписи,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ДД.ВидДвижения,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты) КАК РазделУчета,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	НЕОПРЕДЕЛЕНО КАК ДокументПоступления,
		|	ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка) КАК ВидЗапасов,
		//++ НЕ УТ
		|	(ВЫБОР
		|		КОГДА НЕ СпрНоменклатура.ГруппаАналитическогоУчета ЕСТЬ NULL ТОГДА СпрНоменклатура.ГруппаАналитическогоУчета
		//++ НЕ УТКА
		|		КОГДА НЕ ПродукцияЗаказа.ГруппаАналитическогоУчета ЕСТЬ NULL ТОГДА ПродукцияЗаказа.ГруппаАналитическогоУчета
		//-- НЕ УТКА
		|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.ГруппыАналитическогоУчетаНоменклатуры.ПустаяСсылка) КОНЕЦ) КАК ГруппаПродукции,
		//-- НЕ УТ
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка) КАК АналитикаУчетаПартий,
		|	СУММА(ДД.Количество) КАК Количество,
		|	0 КАК Стоимость,
		|	0 КАК СтоимостьБезНДС,
		|	0 КАК СтоимостьРегл,
		|	0 КАК НДСРегл,
		|	0 КАК ПостояннаяРазница,
		|	0 КАК ВременнаяРазница,
		|	ЛОЖЬ КАК Первичное,
		|	ЛОЖЬ КАК СохранятьРегл,
		|	(ВЫБОР
		|		КОГДА ДД.Количество < 0 ТОГДА ДОБАВИТЬКДАТЕ(&НачалоПериода, СЕКУНДА, -1)
		|		ИНАЧЕ ДД.Период КОНЕЦ) КАК ПериодПоступления,
		|	(ВЫБОР
		|		КОГДА НЕ АналитикаПолучатель.КлючАналитики ЕСТЬ NULL
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПеремещениеТоваров)
		|		КОГДА ДД.СтатьяРасходов <> ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка)
		|		 И ДД.СтатьяРасходов <> НЕОПРЕДЕЛЕНО
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеТоваров)
		|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПустаяСсылка) КОНЕЦ) КАК ХозяйственнаяОперация,
		|	(ВЫБОР
		|		КОГДА НЕ АналитикаПолучатель.КлючАналитики ЕСТЬ NULL
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты)
		|		ИНАЧЕ НЕОПРЕДЕЛЕНО КОНЕЦ) КАК КорРазделУчета,
		|	(ВЫБОР КОГДА НЕ Передача.Ссылка ЕСТЬ NULL ТОГДА ДД.АналитикаУчетаНоменклатуры
		//++ НЕ УТ
		|		КОГДА НЕ Возврат.Ссылка ЕСТЬ NULL ТОГДА ДД.АналитикаУчетаПродукции
		//-- НЕ УТ
		|		ИНАЧЕ ЕСТЬNULL(АналитикаПолучатель.КлючАналитики, ДД.АналитикаУчетаПродукции) КОНЕЦ) КАК КорАналитикаУчетаНоменклатуры,
		|	ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка) КАК КорВидЗапасов,
		|	ДАТАВРЕМЯ(1, 1, 1, 0, 0, 0) КАК ДатаРегистратора,
		|	ДД.НалогообложениеНДС КАК НалогообложениеПартии,
		|	ДД.НалогообложениеНДС,
		|	ДД.Назначение,
		|	ЕСТЬNULL(Корректировка.ДокументОснование, НЕОПРЕДЕЛЕНО) КАК ДокументИсточник,
		//++ НЕ УТ
		|	ДД.СтатьяКалькуляции,
		|	(ВЫБОР
		|		КОГДА ДД.ЗаказНаПроизводство ССЫЛКА Документ.ВыпускПродукции
		|			ТОГДА ЗНАЧЕНИЕ(Справочник.РесурсныеСпецификации.ПустаяСсылка)
		|		ИНАЧЕ ДД.Спецификация КОНЕЦ) КАК Спецификация,
		|	ДД.ЗаказНаПроизводство,
		|	ВЫБОР 
		|		КОГДА СтрокиПереработчика.НомерГруппыЗатрат ЕСТЬ NULL
		|			ТОГДА ДД.КодСтрокиПродукция
		|		ИНАЧЕ 0
		|	КОНЕЦ КАК КодСтрокиПродукция,
		|	ДД.Этап,
		//-- НЕ УТ
		|	ДД.СтатьяРасходов КАК СтатьяРасходовСписания,
		|	ДД.АналитикаРасходов,
		|	ДД.ПодразделениеПолучатель КАК ПодразделениеРасходов,
		|	ВЫБОР
		//++ НЕ УТ
		|		КОГДА НЕ СтрокиПереработчика.НомерГруппыЗатрат ЕСТЬ NULL
		|			ТОГДА СтрокиПереработчика.НомерГруппыЗатрат
		//-- НЕ УТ
		|		КОГДА ИСТИНА
		|			ТОГДА 0
		|	КОНЕЦ КАК НомерГруппыЗатрат,
		|	ДД.АналитикаАктивовПассивов,
		|	ДД.ИдентификаторСтроки,
		|	ДД.Номенклатура,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаСписанияНДС
		|ИЗ
		|	РегистрНакопления.МатериалыИРаботыВПроизводстве КАК ДД
		|	ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаНоменклатуры КАК АналитикаПолучатель
		|		ПО АналитикаПолучатель.Номенклатура = ДД.АналитикаУчетаНоменклатуры.Номенклатура
		|		И АналитикаПолучатель.Характеристика = ДД.АналитикаУчетаНоменклатуры.Характеристика
		|		И АналитикаПолучатель.Серия = ДД.АналитикаУчетаНоменклатуры.Серия
		|		И АналитикаПолучатель.МестоХранения = ДД.ПодразделениеПолучатель
		|		И АналитикаПолучатель.Назначение = ДД.Назначение
		//++ НЕ УТ
		|		И АналитикаПолучатель.СтатьяКалькуляции = ЗНАЧЕНИЕ(Справочник.СтатьиКалькуляции.ПустаяСсылка)
		//-- НЕ УТ
		|		И ДД.ПодразделениеПолучатель <> ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка)
		|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.ПередачаТоваровМеждуОрганизациями КАК Передача
		|		ПО Передача.Ссылка = ДД.Регистратор
		|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.КорректировкаРеализации КАК Корректировка
		|		ПО Корректировка.Ссылка = ДД.Регистратор
		//++ НЕ УТ
		|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.ВозвратМатериаловИзПроизводства КАК Возврат
		|		ПО Возврат.Ссылка = ДД.Регистратор
		|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.СписаниеЗатратНаВыпуск КАК СписаниеЗатрат
		|		ПО СписаниеЗатрат.Ссылка = ДД.Регистратор
		|	ЛЕВОЕ СОЕДИНЕНИЕ Справочник.Номенклатура КАК СпрНоменклатура
		|		ПО СпрНоменклатура.Ссылка = СписаниеЗатрат.Номенклатура
		|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.ЗаказПереработчику.Продукция КАК СтрокиПереработчика
		|		ПО СтрокиПереработчика.Ссылка = ДД.ЗаказНаПроизводство
		|		И СтрокиПереработчика.КодСтроки = ДД.КодСтрокиПродукция
		//-- НЕ УТ

		//++ НЕ УТКА
		|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.ЗаказНаПроизводство.Продукция КАК СтрокиЗаказа
		|		ПО СтрокиЗаказа.Ссылка = ДД.ЗаказНаПроизводство
		|		И СтрокиЗаказа.КодСтроки = ДД.КодСтрокиПродукция
		|	ЛЕВОЕ СОЕДИНЕНИЕ Справочник.Номенклатура КАК ПродукцияЗаказа
		|		ПО ПродукцияЗаказа.Ссылка = СтрокиЗаказа.Номенклатура
		//-- НЕ УТКА
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		//++ НЕ УТ
		|	И (НЕ ДД.Регистратор ССЫЛКА Документ.ВозвратМатериаловИзПроизводства ИЛИ НЕ &ПартионныйУчетВключен)
		|	И (НЕ ДД.Регистратор ССЫЛКА Документ.ВозвратСырьяОтПереработчика ИЛИ НЕ &ПартионныйУчетВключен)
		|	И НЕ ДД.Регистратор ССЫЛКА Документ.ОтчетПереработчика
		//-- НЕ УТ
		|СГРУППИРОВАТЬ ПО
		|	(ВЫБОР
		|		КОГДА ДД.Количество < 0 ТОГДА 35
		|		ИНАЧЕ 40 КОНЕЦ),
		|	(ВЫБОР
		|		КОГДА НЕ Корректировка.Ссылка ЕСТЬ NULL И ДД.Количество < 0
		|			ТОГДА ""Возврат""
		|		КОГДА ДД.Количество < 0 ТОГДА ""Сторно""
		|		ИНАЧЕ ""Потребление"" КОНЕЦ),
		|	ДД.ВидДвижения,
		|	ДД.Период,
		|	ВЫБОР
		|		КОГДА ДД.Количество < 0 ТОГДА ДОБАВИТЬКДАТЕ(&НачалоПериода, СЕКУНДА, -1)
		|		ИНАЧЕ ДД.Период КОНЕЦ,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		//++ НЕ УТ
		|	(ВЫБОР
		|		КОГДА НЕ СпрНоменклатура.ГруппаАналитическогоУчета ЕСТЬ NULL ТОГДА СпрНоменклатура.ГруппаАналитическогоУчета
		//++ НЕ УТКА
		|		КОГДА НЕ ПродукцияЗаказа.ГруппаАналитическогоУчета ЕСТЬ NULL ТОГДА ПродукцияЗаказа.ГруппаАналитическогоУчета
		//-- НЕ УТКА
		|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.ГруппыАналитическогоУчетаНоменклатуры.ПустаяСсылка) КОНЕЦ),
		//-- НЕ УТ
		|	(ВЫБОР
		|		КОГДА НЕ АналитикаПолучатель.КлючАналитики ЕСТЬ NULL
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПеремещениеТоваров)
		|		КОГДА ДД.СтатьяРасходов <> ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка)
		|		 И ДД.СтатьяРасходов <> НЕОПРЕДЕЛЕНО
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеТоваров)
		|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПустаяСсылка) КОНЕЦ),
		|	(ВЫБОР
		|		КОГДА НЕ АналитикаПолучатель.КлючАналитики ЕСТЬ NULL
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты)
		|		ИНАЧЕ НЕОПРЕДЕЛЕНО КОНЕЦ),
		|	(ВЫБОР КОГДА НЕ Передача.Ссылка ЕСТЬ NULL ТОГДА ДД.АналитикаУчетаНоменклатуры
		//++ НЕ УТ
		|		КОГДА НЕ Возврат.Ссылка ЕСТЬ NULL ТОГДА ДД.АналитикаУчетаПродукции
		//-- НЕ УТ
		|		ИНАЧЕ ЕСТЬNULL(АналитикаПолучатель.КлючАналитики, ДД.АналитикаУчетаПродукции) КОНЕЦ),
		|	ДД.НалогообложениеНДС,
		|	ДД.Назначение,
		|	ЕСТЬNULL(Корректировка.ДокументОснование, НЕОПРЕДЕЛЕНО),
		//++ НЕ УТ
		|	ДД.СтатьяКалькуляции,
		|	(ВЫБОР
		|		КОГДА ДД.ЗаказНаПроизводство ССЫЛКА Документ.ВыпускПродукции
		|			ТОГДА ЗНАЧЕНИЕ(Справочник.РесурсныеСпецификации.ПустаяСсылка)
		|		ИНАЧЕ ДД.Спецификация КОНЕЦ),
		|	ДД.ЗаказНаПроизводство,
		|	ВЫБОР 
		|		КОГДА СтрокиПереработчика.НомерГруппыЗатрат ЕСТЬ NULL
		|			ТОГДА ДД.КодСтрокиПродукция
		|		ИНАЧЕ 0
		|	КОНЕЦ,
		|	ДД.Этап,
		//-- НЕ УТ
		|	ВЫБОР
		//++ НЕ УТ
		|		КОГДА НЕ СтрокиПереработчика.НомерГруппыЗатрат ЕСТЬ NULL
		|			ТОГДА СтрокиПереработчика.НомерГруппыЗатрат
		//-- НЕ УТ
		|		КОГДА ИСТИНА
		|			ТОГДА 0
		|	КОНЕЦ,
		|	ДД.СтатьяРасходов,
		|	ДД.АналитикаРасходов,
		|	ДД.ПодразделениеПолучатель,
		|	ДД.АналитикаАктивовПассивов,
		|	ДД.ИдентификаторСтроки,
		|	ДД.Номенклатура
		|";
КонецФункции

Функция ТекстРеализацииРаботПрошлыхМесяцев() // использует ПрошлыеРеализации
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстРеализацииРаботПрошлыхМесяцев"" КАК ЗапросИсточник,
		|	10 КАК Приоритет,
		|	""Прошлое"" КАК ТипЗаписи,
		|	ИСТИНА КАК РасчетЗавершен,
		|	ДД.ВидДвижения КАК ВидДвижения,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты) КАК РазделУчета,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ДокументПоступления,
		|	ДД.ВидЗапасов,
		//++ НЕ УТ
		|	ДД.ВидЗапасов.ГруппаПродукции КАК ГруппаПродукции,
		//-- НЕ УТ
		|	ДД.АналитикаУчетаПартий,
		|	СУММА(ДД.Количество) КАК Количество,
		|	СУММА(ДД.Стоимость) КАК Стоимость,
		|	СУММА(ДД.СтоимостьБезНДС) КАК СтоимостьБезНДС,
		|	СУММА(ДД.СтоимостьРегл) КАК СтоимостьРегл,
		|	СУММА(ДД.НДСРегл) КАК НДСРегл,
		|	СУММА(ДД.ПостояннаяРазница) КАК ПостояннаяРазница,
		|	СУММА(ДД.ВременнаяРазница) КАК ВременнаяРазница,
		|	ИСТИНА КАК Первичное,
		|	ИСТИНА КАК СохранятьРегл,
		|	ДД.Период КАК ПериодПоступления,
		|	НЕОПРЕДЕЛЕНО КАК ХозяйственнаяОперация,
		|	НЕОПРЕДЕЛЕНО КАК КорРазделУчета,
		|	ДД.АналитикаУчетаНоменклатуры КАК КорАналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов КАК КорВидЗапасов,
		|	ДАТАВРЕМЯ(1, 1, 1, 0, 0, 0) КАК ДатаРегистратора,
		|	ДД.АналитикаУчетаПартий.НалогообложениеНДС КАК НалогообложениеПартии,
		|	ДД.НалогообложениеНДС,
		|	Аналитика.Назначение КАК Назначение,
		|	ДД.Регистратор КАК ДокументИсточник,
		//++ НЕ УТ
		|	НЕОПРЕДЕЛЕНО КАК СтатьяКалькуляции,
		|	НЕОПРЕДЕЛЕНО КАК Спецификация,
		|	НЕОПРЕДЕЛЕНО КАК ЗаказНаПроизводство,
		|	0. КАК КодСтрокиПродукция,
		|	НЕОПРЕДЕЛЕНО КАК Этап,
		//-- НЕ УТ
		|	НЕОПРЕДЕЛЕНО КАК СтатьяРасходовСписания,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
		|	ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка) КАК ПодразделениеРасходов,
		|	0. КАК НомерГруппыЗатрат,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивовПассивов,
		|	НЕОПРЕДЕЛЕНО КАК ИдентификаторСтроки,
		|	Аналитика.Номенклатура,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаСписанияНДС
		|ИЗ
		|	РегистрНакопления.ПартииПроизводственныхЗатрат КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК Аналитика
		|		ПО Аналитика.Ссылка = ДД.АналитикаУчетаНоменклатуры
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ПрошлыеРеализации КАК Прошлые
		|		ПО ДД.Регистратор = Прошлые.ДокументРеализации
		|		И ДД.АналитикаУчетаНоменклатуры = Прошлые.АналитикаУчетаНоменклатуры
		|ГДЕ
		|	ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|СГРУППИРОВАТЬ ПО
		|	ДД.ВидДвижения,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ДокументПоступления,
		|	ДД.ВидЗапасов,
		//++ НЕ УТ
		|	ДД.ВидЗапасов.ГруппаПродукции,
		//-- НЕ УТ
		|	ДД.АналитикаУчетаПартий,
		|	ДД.АналитикаУчетаПартий.НалогообложениеНДС,
		|	ДД.НалогообложениеНДС,
		|	Аналитика.Назначение,
		|	Аналитика.Номенклатура
		|";
КонецФункции

//++ НЕ УТ

Функция ТекстПервичныеПартииПроизводстваБезПУ()
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстПервичныеПартииПроизводстваБезПУ"" КАК ЗапросИсточник,
		|	10 КАК Приоритет,
		|	""Партия"" КАК ТипЗаписи,
		|	ИСТИНА КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты) КАК РазделУчета,
		|	ВЫБОР
		|		КОГДА ДД.ОрганизацияОтгрузки = ЗНАЧЕНИЕ(Справочник.Организации.ПустаяСсылка) ТОГДА
		|			ДД.Организация
		|		ИНАЧЕ
		|			ДД.ОрганизацияОтгрузки
		|	КОНЕЦ КАК Организация,
		|	ДД.КорАналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
		|	НЕОПРЕДЕЛЕНО КАК ДокументПоступления,
		|	ЕСТЬNULL(КорВидыЗапасов.Ссылка, ДД.ВидЗапасов) КАК ВидЗапасов,
		|	ЕСТЬNULL(КорВидыЗапасов.ГруппаПродукции, ДД.ВидЗапасов.ГруппаПродукции) КАК ГруппаПродукции,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаПартий,
		|	СУММА(ДД.Количество) КАК Количество,
		|	0 КАК Стоимость,
		|	0 КАК СтоимостьБезНДС,
		|	0 КАК СтоимостьРегл,
		|	0 КАК НДСРегл,
		|	0 КАК ПостояннаяРазница,
		|	0 КАК ВременнаяРазница,
		|	ИСТИНА КАК Первичное,
		|	ЛОЖЬ КАК СохранятьРегл,
		|	ДД.Период КАК ПериодПоступления,
		|	НЕОПРЕДЕЛЕНО КАК ХозяйственнаяОперация,
		|	НЕОПРЕДЕЛЕНО КАК КорРазделУчета,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаУчетаНоменклатуры,
		|	НЕОПРЕДЕЛЕНО КАК КорВидЗапасов,
		|	ДАТАВРЕМЯ(1, 1, 1, 0, 0, 0) КАК ДатаРегистратора,
		|	НЕОПРЕДЕЛЕНО КАК НалогообложениеПартии,
		|	НЕОПРЕДЕЛЕНО КАК НалогообложениеНДС,
		|	ЕСТЬNULL(ДД.КорАналитикаУчетаНоменклатуры.Назначение, ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка)) КАК Назначение,
		|	НЕОПРЕДЕЛЕНО КАК ДокументИсточник,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяКалькуляции,
		|	НЕОПРЕДЕЛЕНО КАК Спецификация,
		|	НЕОПРЕДЕЛЕНО КАК ЗаказНаПроизводство,
		|	0 КАК КодСтрокиПродукция,
		|	НЕОПРЕДЕЛЕНО КАК Этап,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяРасходовСписания,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
		|	ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка) КАК ПодразделениеРасходов,
		|	0 КАК НомерГруппыЗатрат,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивовПассивов,
		|	НЕОПРЕДЕЛЕНО КАК ИдентификаторСтроки,
		|	ДД.Номенклатура,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаСписанияНДС
		|ИЗ
		|	РегистрНакопления.ТоварыОрганизаций КАК ДД
		|	ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ВидыЗапасов КАК КорВидыЗапасов
		|		ПО КорВидыЗапасов.Ссылка = ДД.КорВидЗапасов
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		|	И НЕ &ПартионныйУчетВключен
		|	И (ДД.Регистратор ССЫЛКА Документ.ПередачаМатериаловВПроизводство
		|		ИЛИ ДД.Регистратор ССЫЛКА Документ.ПередачаСырьяПереработчику)
		|СГРУППИРОВАТЬ ПО
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.ОрганизацияОтгрузки,
		|	ДД.КорАналитикаУчетаНоменклатуры,
		|	ЕСТЬNULL(КорВидыЗапасов.Ссылка, ДД.ВидЗапасов),
		|	ЕСТЬNULL(КорВидыЗапасов.ГруппаПродукции, ДД.ВидЗапасов.ГруппаПродукции),
		|	ЕСТЬNULL(ДД.КорАналитикаУчетаНоменклатуры.Назначение, ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка)),
		|	ДД.Номенклатура
		|";
КонецФункции

Функция ТекстДополнениеПартийПроизводства()
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстДополнениеПартийПроизводства"" КАК ЗапросИсточник,
		|	10 КАК Приоритет,
		|	(ВЫБОР
		|		КОГДА ДД.Регистратор ССЫЛКА Документ.ОтчетПереработчика И ДД.ДокументПоступления = ДД.Регистратор
		|			ТОГДА ""Дополнение""
		|		ИНАЧЕ ""Списание"" КОНЕЦ) КАК ТипЗаписи,
		|	(ВЫБОР
		|		КОГДА ДД.Регистратор ССЫЛКА Документ.ОтчетПереработчика И ДД.ДокументПоступления = ДД.Регистратор
		|			ТОГДА ИСТИНА
		|		ИНАЧЕ ЛОЖЬ КОНЕЦ) КАК РасчетЗавершен,
		|	ДД.ВидДвижения,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты) КАК РазделУчета,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ДокументПоступления,
		|	ДД.ВидЗапасов,
		|	ДД.ВидЗапасов.ГруппаПродукции КАК ГруппаПродукции,
		|	ДД.АналитикаУчетаПартий,
		|	СУММА(ДД.Количество) КАК Количество,
		|	СУММА(ДД.Стоимость) КАК Стоимость,
		|	СУММА(ДД.СтоимостьБезНДС) КАК СтоимостьБезНДС,
		|	СУММА(ДД.СтоимостьРегл) КАК СтоимостьРегл,
		|	СУММА(ДД.НДСРегл) КАК НДСРегл,
		|	СУММА(ДД.ПостояннаяРазница) КАК ПостояннаяРазница,
		|	СУММА(ДД.ВременнаяРазница) КАК ВременнаяРазница,
		|	ИСТИНА КАК Первичное,
		|	ЛОЖЬ КАК СохранятьРегл,
		|	ДД.Период КАК ПериодПоступления,
		|	НЕОПРЕДЕЛЕНО КАК ХозяйственнаяОперация,
		|	НЕОПРЕДЕЛЕНО КАК КорРазделУчета,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаУчетаНоменклатуры,
		|	НЕОПРЕДЕЛЕНО КАК КорВидЗапасов,
		|	ДАТАВРЕМЯ(1, 1, 1, 0, 0, 0) КАК ДатаРегистратора,
		|	ДД.АналитикаУчетаПартий.НалогообложениеНДС КАК НалогообложениеПартии,
		|	НЕОПРЕДЕЛЕНО КАК НалогообложениеНДС,
		|	ЕСТЬNULL(ДД.АналитикаУчетаНоменклатуры.Назначение, ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка)) КАК Назначение,
		|	ДД.ДокументИсточник КАК ДокументИсточник,
		|	ДД.СтатьяКалькуляции,
		|	НЕОПРЕДЕЛЕНО КАК Спецификация,
		|	ДД.ЗаказНаПроизводство,
		|	ДД.КодСтрокиПродукция,
		|	ДД.Этап,
		|	ДД.СтатьяРасходовСписания КАК СтатьяРасходовСписания,
		|	ДД.АналитикаРасходов КАК АналитикаРасходов,
		|	ДД.ПодразделениеРасходов КАК ПодразделениеРасходов,
		|	ДД.НомерГруппыЗатрат,
		|	ДД.АналитикаАктивовПассивов,
		|	ДД.ИдентификаторСтроки,
		|	Аналитика.Номенклатура,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаСписанияНДС
		|ИЗ
		|	РегистрНакопления.ПартииПроизводственныхЗатрат КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК Аналитика
		|		ПО Аналитика.Ссылка = ДД.АналитикаУчетаНоменклатуры
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И (ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) И ДД.Регистратор ССЫЛКА Документ.ВыпускПродукции
		|		ИЛИ ДД.Регистратор ССЫЛКА Документ.ОтчетПереработчика И ДД.ДокументПоступления = ДД.Регистратор)
		|СГРУППИРОВАТЬ ПО
		|	(ВЫБОР
		|		КОГДА ДД.Регистратор ССЫЛКА Документ.ОтчетПереработчика И ДД.ДокументПоступления = ДД.Регистратор
		|			ТОГДА ""Дополнение""
		|		ИНАЧЕ ""Списание"" КОНЕЦ),
		|	(ВЫБОР
		|		КОГДА ДД.Регистратор ССЫЛКА Документ.ОтчетПереработчика И ДД.ДокументПоступления = ДД.Регистратор
		|			ТОГДА ИСТИНА
		|		ИНАЧЕ ЛОЖЬ КОНЕЦ),
		|	ДД.ВидДвижения,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ДокументПоступления,
		|	ДД.ДокументИсточник,
		|	ДД.ВидЗапасов,
		|	ЕСТЬNULL(ДД.АналитикаУчетаНоменклатуры.Назначение, ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка)),
		|	ДД.АналитикаУчетаПартий,
		|	ДД.СтатьяКалькуляции,
		|	ДД.ЗаказНаПроизводство,
		|	ДД.КодСтрокиПродукция,
		|	ДД.Этап,
		|	ДД.СтатьяРасходовСписания,
		|	ДД.АналитикаРасходов,
		|	ДД.ПодразделениеРасходов,
		|	ДД.НомерГруппыЗатрат,
		|	ДД.АналитикаАктивовПассивов,
		|	ДД.ИдентификаторСтроки,
		|	Аналитика.Номенклатура
		|";
КонецФункции

Функция ТекстДополнениеПрошлыеДвижения() // использует МатериалыИРаботыРегистраторы
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстДополнениеПрошлыеДвижения"" КАК ЗапросИсточник,
		|	10 КАК Приоритет,
		|	""Дополнение"" КАК ТипЗаписи,
		|	ИСТИНА КАК РасчетЗавершен,
		|	ДД.ВидДвижения,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты) КАК РазделУчета,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ДокументПоступления,
		|	ДД.ВидЗапасов,
		|	ДД.ВидЗапасов.ГруппаПродукции КАК ГруппаПродукции,
		|	ДД.АналитикаУчетаПартий,
		|	СУММА(ДД.Количество) КАК Количество,
		|	СУММА(ДД.Стоимость) КАК Стоимость,
		|	СУММА(ДД.СтоимостьБезНДС) КАК СтоимостьБезНДС,
		|	СУММА(ДД.СтоимостьРегл) КАК СтоимостьРегл,
		|	СУММА(ДД.НДСРегл) КАК НДСРегл,
		|	СУММА(ДД.ПостояннаяРазница) КАК ПостояннаяРазница,
		|	СУММА(ДД.ВременнаяРазница) КАК ВременнаяРазница,
		|	ИСТИНА КАК Первичное,
		|	ЛОЖЬ КАК СохранятьРегл,
		|	ДД.Период КАК ПериодПоступления,
		|	НЕОПРЕДЕЛЕНО КАК ХозяйственнаяОперация,
		|	НЕОПРЕДЕЛЕНО КАК КорРазделУчета,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаУчетаНоменклатуры,
		|	НЕОПРЕДЕЛЕНО КАК КорВидЗапасов,
		|	ДАТАВРЕМЯ(1, 1, 1, 0, 0, 0) КАК ДатаРегистратора,
		|	НЕОПРЕДЕЛЕНО КАК НалогообложениеПартии,
		|	ДД.НалогообложениеНДС,
		|	НЕОПРЕДЕЛЕНО КАК Назначение,
		|	ДД.ДокументИсточник КАК ДокументИсточник,
		|	ДД.СтатьяКалькуляции,
		|	НЕОПРЕДЕЛЕНО КАК Спецификация,
		|	ДД.ЗаказНаПроизводство,
		|	ДД.КодСтрокиПродукция,
		|	ДД.Этап,
		|	ДД.СтатьяРасходовСписания,
		|	ДД.АналитикаРасходов,
		|	ДД.ПодразделениеРасходов,
		|	ДД.НомерГруппыЗатрат,
		|	ДД.АналитикаАктивовПассивов,
		|	ДД.ИдентификаторСтроки,
		|	Аналитика.Номенклатура,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаСписанияНДС
		|ИЗ
		|	РегистрНакопления.ПартииПроизводственныхЗатрат КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК Аналитика
		|		ПО Аналитика.Ссылка = ДД.АналитикаУчетаНоменклатуры
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ МатериалыИРаботыРегистраторы КАК Движения
		|		ПО Движения.Регистратор = ДД.Регистратор
		|ГДЕ
		|	(ДД.Период < &НачалоПериода ИЛИ ДД.Период > &ОкончаниеПериода)
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		|СГРУППИРОВАТЬ ПО
		|	ДД.ВидДвижения,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ДокументПоступления,
		|	ДД.ДокументИсточник,
		|	ДД.ВидЗапасов,
		|	ДД.АналитикаУчетаПартий,
		|	ДД.НалогообложениеНДС,
		|	ДД.СтатьяКалькуляции,
		|	ДД.ЗаказНаПроизводство,
		|	ДД.КодСтрокиПродукция,
		|	ДД.Этап,
		|	ДД.СтатьяРасходовСписания,
		|	ДД.АналитикаРасходов,
		|	ДД.ПодразделениеРасходов,
		|	ДД.НомерГруппыЗатрат,
		|	ДД.АналитикаАктивовПассивов,
		|	ДД.ИдентификаторСтроки,
		|	Аналитика.Номенклатура
		|";
КонецФункции

Функция ТекстПеремещенияВПроизводстве()
	// распределение материалов на выпуск, списание
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстПеремещенияВПроизводстве"" КАК ЗапросИсточник,
		|	90 КАК Приоритет,
		|	""Перемещение"" КАК ТипЗаписи,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ДД.ВидДвижения,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты) КАК РазделУчета,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	НЕОПРЕДЕЛЕНО КАК ДокументПоступления,
		|	ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка) КАК ВидЗапасов,
		|	ЗНАЧЕНИЕ(Справочник.ГруппыАналитическогоУчетаНоменклатуры.ПустаяСсылка) КАК ГруппаПродукции,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка) КАК АналитикаУчетаПартий,
		|	СУММА(ДД.Количество) КАК Количество,
		|	0 КАК Стоимость,
		|	0 КАК СтоимостьБезНДС,
		|	0 КАК СтоимостьРегл,
		|	0 КАК НДСРегл,
		|	0 КАК ПостояннаяРазница,
		|	0 КАК ВременнаяРазница,
		|	ЛОЖЬ КАК Первичное,
		|	ЛОЖЬ КАК СохранятьРегл,
		|	ДД.Период КАК ПериодПоступления,
		|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПустаяСсылка) КАК ХозяйственнаяОперация,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты) КАК КорРазделУчета,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаУчетаНоменклатуры,
		|	НЕОПРЕДЕЛЕНО КАК КорВидЗапасов,
		|	ДАТАВРЕМЯ(1, 1, 1, 0, 0, 0) КАК ДатаРегистратора,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка) КАК НалогообложениеПартии,
		|	НЕОПРЕДЕЛЕНО КАК НалогообложениеНДС,
		|	ДД.Назначение,
		|	ДД.Регистратор КАК ДокументИсточник,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяКалькуляции,
		|	НЕОПРЕДЕЛЕНО КАК Спецификация,
		|	НЕОПРЕДЕЛЕНО КАК ЗаказНаПроизводство,
		|	НЕОПРЕДЕЛЕНО КАК КодСтрокиПродукция,
		|	НЕОПРЕДЕЛЕНО КАК Этап,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяРасходовСписания,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
		|	ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка) КАК ПодразделениеРасходов,
		|	0 КАК НомерГруппыЗатрат,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивовПассивов,
		|	НЕОПРЕДЕЛЕНО КАК ИдентификаторСтроки,
		|	ДД.Номенклатура,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаСписанияНДС
		|ИЗ
		|	РегистрНакопления.МатериалыИРаботыВПроизводстве КАК ДД
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|	И ДД.Регистратор ССЫЛКА Документ.ПеремещениеМатериаловВПроизводстве
		|СГРУППИРОВАТЬ ПО
		|	ДД.ВидДвижения,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.Назначение,
		|	ДД.Номенклатура
		|";
КонецФункции
	
Функция ТекстПотребленияОтчетомПереработчика()
	// распределение материалов на выпуск, списание
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстПотребленияОтчетомПереработчика"" КАК ЗапросИсточник,
		|	90 КАК Приоритет,
		|	""ПотреблениеАвто"" КАК ТипЗаписи,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) КАК ВидДвижения,
		|	ДД.Дата КАК Период,
		|	ДД.Ссылка КАК Регистратор,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты) КАК РазделУчета,
		|	ДД.Организация,
		|	Строки.АналитикаУчетаНоменклатуры,
		|	НЕОПРЕДЕЛЕНО КАК ДокументПоступления,
		|	Строки.ВидЗапасов КАК ВидЗапасов,
		|	Строки.ВидЗапасов.ГруппаПродукции КАК ГруппаПродукции,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка) КАК АналитикаУчетаПартий,
		|	СУММА(Строки.Количество) КАК Количество,
		|	0 КАК Стоимость,
		|	0 КАК СтоимостьБезНДС,
		|	0 КАК СтоимостьРегл,
		|	0 КАК НДСРегл,
		|	0 КАК ПостояннаяРазница,
		|	0 КАК ВременнаяРазница,
		|	ЛОЖЬ КАК Первичное,
		|	ЛОЖЬ КАК СохранятьРегл,
		|	ДД.Дата КАК ПериодПоступления,
		|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПустаяСсылка) КАК ХозяйственнаяОперация,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты) КАК КорРазделУчета,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаУчетаНоменклатуры,
		|	НЕОПРЕДЕЛЕНО КАК КорВидЗапасов,
		|	ДАТАВРЕМЯ(1, 1, 1, 0, 0, 0) КАК ДатаРегистратора,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка) КАК НалогообложениеПартии,
		|	НЕОПРЕДЕЛЕНО КАК НалогообложениеНДС,
		|	Аналитика.Назначение КАК Назначение,
		|	НЕОПРЕДЕЛЕНО КАК ДокументИсточник,
		|	Строки.СтатьяКалькуляции КАК СтатьяКалькуляции,
		|	НЕОПРЕДЕЛЕНО КАК Спецификация,
		|	(ВЫБОР
		|		КОГДА ДД.ПоЗаказам ТОГДА ДД.ЗаказПереработчику
		|		ИНАЧЕ Строки.ДокументПоступления КОНЕЦ) КАК ЗаказНаПроизводство,
		|	НЕОПРЕДЕЛЕНО КАК КодСтрокиПродукция,
		|	НЕОПРЕДЕЛЕНО КАК Этап,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяРасходовСписания,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
		|	ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка) КАК ПодразделениеРасходов,
		|	Строки.НомерГруппыЗатрат,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивовПассивов,
		|	НЕОПРЕДЕЛЕНО КАК ИдентификаторСтроки,
		|	Аналитика.Номенклатура,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаСписанияНДС
		|ИЗ
		|	Документ.ОтчетПереработчика КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ОтчетПереработчика.ВидыЗапасов КАК Строки
		|		ПО Строки.Ссылка = ДД.Ссылка
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК Аналитика
		|		ПО Аналитика.Ссылка = Строки.АналитикаУчетаНоменклатуры
		|ГДЕ
		|	ДД.Дата МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Проведен
		|СГРУППИРОВАТЬ ПО
		|	ДД.Дата,
		|	ДД.Ссылка,
		|	ДД.Организация,
		|	Строки.АналитикаУчетаНоменклатуры,
		|	Строки.ВидЗапасов,
		|	(ВЫБОР
		|		КОГДА ДД.ПоЗаказам ТОГДА ДД.ЗаказПереработчику
		|		ИНАЧЕ Строки.ДокументПоступления КОНЕЦ),
		|	Аналитика.Назначение,
		|	Строки.НомерГруппыЗатрат,
		|	Строки.СтатьяКалькуляции,
		|	Аналитика.Номенклатура
		|";
КонецФункции
	
Функция ТекстПотребленияОтчетомПереработчикаВозвратныеОтходы()
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстПотребленияОтчетомПереработчикаВозвратныеОтходы"" КАК ЗапросИсточник,
		|	90 КАК Приоритет,
		|	""Сторно"" КАК ТипЗаписи,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) КАК ВидДвижения,
		|	ДД.Дата КАК Период,
		|	ДД.Ссылка КАК Регистратор,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты) КАК РазделУчета,
		|	ДД.Организация,
		|	Строки.АналитикаУчетаНоменклатуры,
		|	НЕОПРЕДЕЛЕНО КАК ДокументПоступления,
		|	ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка) КАК ВидЗапасов,
		|	ЗНАЧЕНИЕ(Справочник.ГруппыАналитическогоУчетаНоменклатуры.ПустаяСсылка) КАК ГруппаПродукции,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка) КАК АналитикаУчетаПартий,
		|	-СУММА(Строки.Количество) КАК Количество,
		|	0 КАК Стоимость,
		|	0 КАК СтоимостьБезНДС,
		|	0 КАК СтоимостьРегл,
		|	0 КАК НДСРегл,
		|	0 КАК ПостояннаяРазница,
		|	0 КАК ВременнаяРазница,
		|	ЛОЖЬ КАК Первичное,
		|	ЛОЖЬ КАК СохранятьРегл,
		|	ДД.Дата КАК ПериодПоступления,
		|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПустаяСсылка) КАК ХозяйственнаяОперация,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты) КАК КорРазделУчета,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаУчетаНоменклатуры,
		|	НЕОПРЕДЕЛЕНО КАК КорВидЗапасов,
		|	ДАТАВРЕМЯ(1, 1, 1, 0, 0, 0) КАК ДатаРегистратора,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка) КАК НалогообложениеПартии,
		|	НЕОПРЕДЕЛЕНО КАК НалогообложениеНДС,
		|	ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка) КАК Назначение,
		|	НЕОПРЕДЕЛЕНО КАК ДокументИсточник,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяКалькуляции,
		|	НЕОПРЕДЕЛЕНО КАК Спецификация,
		|	(ВЫБОР
		|		КОГДА ДД.ПоЗаказам ТОГДА ДД.ЗаказПереработчику
		|		ИНАЧЕ Строки.ДокументПоступления КОНЕЦ) КАК ЗаказНаПроизводство,
		|	НЕОПРЕДЕЛЕНО КАК КодСтрокиПродукция,
		|	НЕОПРЕДЕЛЕНО КАК Этап,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяРасходовСписания,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
		|	ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка) КАК ПодразделениеРасходов,
		|	Строки.НомерГруппыЗатрат,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивовПассивов,
		|	НЕОПРЕДЕЛЕНО КАК ИдентификаторСтроки,
		|	Аналитика.Номенклатура,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяСписанияНДС,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаСписанияНДС
		|ИЗ
		|	Документ.ОтчетПереработчика КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ОтчетПереработчика.ВозвратныеОтходы КАК Строки
		|		ПО Строки.Ссылка = ДД.Ссылка
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК Аналитика
		|		ПО Аналитика.Ссылка = Строки.АналитикаУчетаНоменклатуры
		|ГДЕ
		|	ДД.Дата МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Проведен
		|СГРУППИРОВАТЬ ПО
		|	ДД.Дата,
		|	ДД.Ссылка,
		|	ДД.Организация,
		|	Строки.АналитикаУчетаНоменклатуры,
		|	(ВЫБОР
		|		КОГДА ДД.ПоЗаказам ТОГДА ДД.ЗаказПереработчику
		|		ИНАЧЕ Строки.ДокументПоступления КОНЕЦ),
		|	Строки.НомерГруппыЗатрат,
		|	Аналитика.Номенклатура
		|";
КонецФункции
//-- НЕ УТ
#КонецОбласти

//++ НЕ УТ
#Область РасчетПартийНезавершенногоПроизводства

// В партионном учете версии 2.2 - этап 8, РаспределениеМатериаловМеждуОстаткомНЗПиВыходнымиИзделиями.

Функция ДанныеДляПартийНЗП(НачалоПериода, ОкончаниеПериода, МассивОрганизаций)
	ТекстСортировка = "
		|УПОРЯДОЧИТЬ ПО
		|	Организация, ЗаказНаПроизводство, Приоритет, Период, Регистратор
		|";
	ТекстИндексы = "
		|ИНДЕКСИРОВАТЬ ПО
		|	Организация
		|";
	ИсходныйТекстЗапроса =
		ТекстПартииНЗПИнициализация() + ";" // вт ПрошлыеПоступленияНЗП, ЗаказыКРаспределению, ДолиСтоимости, ВыпускиБезЗаказов, РаспределениеНаВыпускиБезЗаказов, РаспределенияПоБазе, ПрошлыеРаспоряженияНаВыпускПродукции
		+ ТекстОписаниеДанныхДляПартийНЗП()
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстОстаткиПартийНЗП() // использует ПрошлыеПоступления
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстПервичныеПартииНЗП() // использует ДолиСтоимости
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстПервичныеПартииПереработчик() // использует ДолиСтоимости
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстДополнениеПартийНЗП()
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстДополнениеПрошлыеПартииНЗП() // использует МатериалыИРаботыВПроизводстве
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстПервичныеПартииНЗПБезЗаказов() // использует ВыпускиБезЗаказов, РаспределениеНаВыпускиБезЗаказов
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстПартииРаспределеноПоБазе() // использует ВыпускиБезЗаказов

		//++ НЕ УТКА
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстМаршрутныеЛисты()
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстПрошлыеМаршрутныеЛисты()
		//-- НЕ УТКА
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстОтчетыПереработчика()
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстСписанияЗатратНаВыпуск()
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстСписанияЗатратНаВыпускПоБазе() // использует РаспределенияПоБазе

		//++ НЕ УТКА
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстВыпускиПоЗаказам()
		//-- НЕ УТКА
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстВыпускиБезЗаказов()
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстВыпускиБезЗаказовБезСписанияЗатратНаВыпуск()
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстВыпускиБезЗаказовБезСписанияЗатратНаВыпускСписаниеНаРасходы()
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстПоступленияОтПереработчиков()
		//++ НЕ УТКА
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстДавальческиеПолуфабрикаты() // использует ДолиСтоимости
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстДавальческаяПродукция()
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстОтчетыДавальцам()
		//-- НЕ УТКА
		+ ТекстИндексы;
	МВТ = Новый МенеджерВременныхТаблиц;	
	ИсходныйЗапрос = Новый Запрос(СтрЗаменить(ИсходныйТекстЗапроса, "//ВоВременнуюТаблицу", ""));
	ИсходныйЗапрос.УстановитьПараметр("НачалоПериода", НачалоПериода);
	ИсходныйЗапрос.УстановитьПараметр("ОкончаниеПериода", ОкончаниеПериода);	
	ИсходныйЗапрос.УстановитьПараметр("МассивОрганизаций", МассивОрганизаций);	
	ИсходныйЗапрос.МенеджерВременныхТаблиц = МВТ;
	ИсходныйЗапрос.Выполнить();
	
	Запрос = Новый Запрос(ТекстОписаниеДанныхДляПартийНЗП());
	РасчетныеПартии = Запрос.Выполнить().Выгрузить();
	
	ВременнаяТаблицаДанныхПоОтбору("ЗаказНаПроизводство", ТекстСортировка, РасчетныеПартии, МВТ);
	
	Возврат МВТ;
КонецФункции

Функция РасчетныеПартииНЗП(ДанныеДляРасчета, Регистраторы, ЦепочкиДвижений = Неопределено, Тест = Ложь, РассчитатьПартии = Истина)
	
	// Шаг 1: создаем буфер накопления рассчитанных партий.
	Запрос = Новый Запрос(ТекстОписаниеДанныхДляПартийНЗП());
	РасчетныеПартии = Запрос.Выполнить().Выгрузить();
	
	// Шаг 2: обсчитываем цепочки движений.
	КонтекстЦепочек = ОписаниеЦепочек("Распределение, ЗатратыБезЗаказа, Перемещение, Партия, Остаток, 
	|Сторно, Выпуск, ВыпускБезЗаказа, Переработка, ОтчетДавальцу, ПолуфабрикатДавальца, ПродукцияДавальца, Дополнение");
	
	ПоляПотреблений = "Организация, ЗаказНаПроизводство, КодСтрокиПродукция, Спецификация, ДокументВыпуска, НомерГруппыЗатрат";
	ДобавитьОписаниеПриемника(КонтекстЦепочек, "Распределение", ПоляПотреблений);
	ДобавитьОписаниеИсточника(КонтекстЦепочек, "Распределение", "Партия", ПоляПотреблений);
	ДобавитьОписаниеИсточника(КонтекстЦепочек, "Распределение", "Остаток", ПоляПотреблений);
	ДобавитьОписаниеИсточника(КонтекстЦепочек, "Распределение", "ПолуфабрикатДавальца", ПоляПотреблений);
	
	ДобавитьОписаниеПриемника(КонтекстЦепочек, "ЗатратыБезЗаказа", "Регистратор");
	ДобавитьОписаниеИсточника(КонтекстЦепочек, "ЗатратыБезЗаказа", "Партия", "Регистратор");
	ДобавитьОписаниеИсточника(КонтекстЦепочек, "ЗатратыБезЗаказа", "ПолуфабрикатДавальца", "Регистратор");
	
	ДобавитьОписаниеПриемника(КонтекстЦепочек, "Выпуск", "Организация, ЗаказНаПроизводство, КодСтрокиПродукция, Спецификация, Продукция, ХарактеристикаПродукции");
	ДобавитьОписаниеИсточника(КонтекстЦепочек, "Выпуск", "Распределение", "Организация, ЗаказНаПроизводство, КодСтрокиПродукция, Спецификация, Продукция, ХарактеристикаПродукции");
	
	ДобавитьОписаниеПриемника(КонтекстЦепочек, "ПолуфабрикатДавальца", "Организация, Назначение, Продукция, ХарактеристикаПродукции");
	ДобавитьОписаниеИсточника(КонтекстЦепочек, "ПолуфабрикатДавальца", "ПродукцияДавальца", "Организация, Назначение, Продукция, ХарактеристикаПродукции");
	
	ДобавитьОписаниеПриемника(КонтекстЦепочек, "ПродукцияДавальца", "Организация, Назначение, Продукция, ХарактеристикаПродукции");
	ДобавитьОписаниеИсточника(КонтекстЦепочек, "ПродукцияДавальца", "Выпуск", "Организация, Назначение, Продукция, ХарактеристикаПродукции");
	ДобавитьОписаниеИсточника(КонтекстЦепочек, "ПродукцияДавальца", "ВыпускБезЗаказа", "Организация, Назначение, Продукция, ХарактеристикаПродукции");
	
	ДобавитьОписаниеПриемника(КонтекстЦепочек, "ОтчетДавальцу", "Организация, Назначение, Продукция, ХарактеристикаПродукции");
	ДобавитьОписаниеИсточника(КонтекстЦепочек, "ОтчетДавальцу", "ПродукцияДавальца", "Организация, Назначение, Продукция, ХарактеристикаПродукции");
	
	ДобавитьОписаниеПриемника(КонтекстЦепочек, "Переработка", "Организация, ЗаказНаПроизводство, Продукция, ХарактеристикаПродукции, ДокументВыпуска, Назначение");
	ДобавитьОписаниеИсточника(КонтекстЦепочек, "Переработка", "Распределение", "Организация, ЗаказНаПроизводство, Продукция, ХарактеристикаПродукции, ДокументВыпуска, Назначение");
	
	ДобавитьОписаниеПриемника(КонтекстЦепочек, "ВыпускБезЗаказа", "Регистратор, КодСтрокиПродукция");
	ДобавитьОписаниеИсточника(КонтекстЦепочек, "ВыпускБезЗаказа", "ЗатратыБезЗаказа", "ДокументВыпуска, КодСтрокиПродукция");

	
	// Шаг 3: замена ложных партий на первичные партии в расчетных строках по результатам построение графа замен.
	КонтекстДвижений = ОписаниеДвижений(
		"ПартииНезавершенногоПроизводства",
		"ПартииНезавершенногоПроизводства",
		ПереченьПолей(РасчетныеПартии.Колонки),
		ПоляПотреблений,
		"Количество, Стоимость, СтоимостьБезНДС, СтоимостьРегл, НДСРегл, ПостояннаяРазница, ВременнаяРазница",
		"Знаменатель", "Знаменатель", "ДокументИсточник", "Период");
	КонтекстДвижений.Вставить("ПоляСуммирования", "Количество, Стоимость, СтоимостьБезНДС, СтоимостьРегл, НДСРегл, ПостояннаяРазница, ВременнаяРазница");
	КонтекстДвижений.Вставить("ПоляГруппировки", ПереченьПолей(РасчетныеПартии.Колонки, КонтекстДвижений.ПоляСуммирования));
	ЦепочкиДвижений(КонтекстЦепочек, ДанныеДляРасчета);
	Если РассчитатьПартии Тогда
		РассчитатьПартииПоЦепочкам(КонтекстДвижений, ДанныеДляРасчета, РасчетныеПартии, Регистраторы, Тест);
	КонецЕсли;
	ЦепочкиДвижений = ДанныеДляРасчета;
		
	// Шаг 4: Удаляем нерассчитанные партии.
	Если Не Тест Тогда
		УдалитьНезаписываемыеСтроки(КонтекстДвижений.Контекст, РасчетныеПартии);
	КонецЕсли;
	
	Возврат РасчетныеПартии;
	
КонецФункции

Функция ТекстПартииНЗПИнициализация() // вт ПрошлыеПоступления, ЗаказыКРаспределению, ДолиСтоимости, ВыпускиБезЗаказов, РаспределениеНаВыпускиБезЗаказов, РаспределенияПоБазе, МатериалыИРаботыВПроизводстве, ПрошлыеРаспоряженияНаВыпускПродукции
	Возврат "
		|ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	ДД.ДокументПоступления КАК Ссылка,
		|	ДД.АналитикаУчетаНоменклатуры.МестоХранения КАК Склад,
		|	МАКСИМУМ(Периодика.Регистратор) КАК Регистратор,
		|	МАКСИМУМ(Периодика.Период) КАК Период
		|ПОМЕСТИТЬ
		|	ПрошлыеПоступления
		|ИЗ
		|	РегистрНакопления.ПартииНезавершенногоПроизводства.Остатки(&НачалоПериода, Организация В (&МассивОрганизаций)) КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрНакопления.ПартииПроизводственныхЗатрат КАК Периодика
		|		ПО Периодика.Период < &НачалоПериода
		|		И Периодика.ДокументПоступления = ДД.ДокументПоступления
		|		И Периодика.АналитикаУчетаНоменклатуры.МестоХранения = ДД.АналитикаУчетаНоменклатуры.МестоХранения
		|ГДЕ
		|	ДД.ДокументПоступления <> НЕОПРЕДЕЛЕНО
		|	И Периодика.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|	И Периодика.Количество > 0
		|СГРУППИРОВАТЬ ПО
		|	ДД.ДокументПоступления,
		|	ДД.АналитикаУчетаНоменклатуры.МестоХранения
		|;
		|////////////////////////////////////////////////////////////////////////////

		//++ НЕ УТКА
		|ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	Т.Распоряжение.Распоряжение КАК Заказ,
		|	Т.Распоряжение.КодСтроки КАК КодСтроки
		|ПОМЕСТИТЬ
		|	ЗаказыКРаспределению
		|ИЗ
		|	РегистрНакопления.РаспоряженияНаВыпускПродукции.ОстаткиИОбороты(&НачалоПериода, &ОкончаниеПериода, , , Распоряжение.Организация В (&МассивОрганизаций)) КАК Т
		|ГДЕ
		|	Т.ЗаказаноПриход <> 0
		|	ИЛИ Т.ЗаказаноКонечныйОстаток <> 0
		|;
		|////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ДД.Распоряжение КАК Распоряжение,
		|	ДД.Номенклатура КАК Номенклатура,
		|	ДД.Характеристика КАК Характеристика,
		|	МаршрутныйЛист.Организация КАК Организация,
		|	МаршрутныйЛист.Распоряжение КАК ЗаказНаПроизводство,
		|	МаршрутныйЛист.КодСтроки КАК КодСтрокиПродукция,
		|	МаршрутныйЛист.Этап КАК Этап,
		|	МАКСИМУМ(ВЫБОР ДД.ДоляСтоимости
		|			КОГДА 0
		|				ТОГДА 1
		|			ИНАЧЕ ДД.ДоляСтоимости
		|	КОНЕЦ) КАК ДоляСтоимости,
		|	СУММА(ДД.КОформлению) КАК Произведено
		|ПОМЕСТИТЬ ПрошлыеРаспоряженияНаВыпускПродукции
		|ИЗ
		|	РегистрНакопления.РаспоряженияНаВыпускПродукции КАК ДД
		|	ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.РаспоряженияНаВыпускПродукции КАК Приходы
		|		ПО Приходы.Регистратор = ДД.Распоряжение
		|		И Приходы.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.МаршрутныйЛистПроизводства КАК МаршрутныйЛист
		|		ПО МаршрутныйЛист.Ссылка = ДД.Распоряжение
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И МаршрутныйЛист.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		|	И ДД.ТипСтоимости = ЗНАЧЕНИЕ(Перечисление.ТипыСтоимостиВыходныхИзделий.Рассчитывается)
		|	И Приходы.Регистратор ЕСТЬ NULL
		|СГРУППИРОВАТЬ ПО
		|	ДД.Распоряжение,
		|	ДД.Номенклатура,
		|	ДД.Характеристика,
		|	МаршрутныйЛист.Организация,
		|	МаршрутныйЛист.Распоряжение,
		|	МаршрутныйЛист.КодСтроки,
		|	МаршрутныйЛист.Этап
		|;
		|////////////////////////////////////////////////////////////////////////////

		//-- НЕ УТКА
		|ВЫБРАТЬ
		|	ДолиСтоимости.ЗаказНаПроизводство КАК ЗаказНаПроизводство,
		|	ДолиСтоимости.КодСтрокиПродукция КАК КодСтрокиПродукция,
		|	ДолиСтоимости.Спецификация КАК Спецификация,
		|	ДолиСтоимости.НомерГруппыЗатрат,
		|	СУММА(ДолиСтоимости.ДоляСтоимости) КАК ДоляСтоимости
		|ПОМЕСТИТЬ
		|	ДолиСтоимости
		|ИЗ
		|	(ВЫБРАТЬ
		|		Строки.ЗаказПереработчику КАК ЗаказНаПроизводство,
		|		0 КАК КодСтрокиПродукция,
		|		НЕОПРЕДЕЛЕНО КАК Спецификация,
		|		Строки.НомерГруппыЗатрат,
		|		СУММА(ВЫБОР Строки.ДоляСтоимости КОГДА 0 ТОГДА 1
		|			ИНАЧЕ Строки.ДоляСтоимости КОНЕЦ) КАК ДоляСтоимости
		|	ИЗ
		|		Документ.ОтчетПереработчика КАК ДД
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ОтчетПереработчика.Продукция КАК Строки
		|			ПО Строки.Ссылка = ДД.Ссылка
		|	ГДЕ
		|		ДД.Дата МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|		И ДД.Организация В (&МассивОрганизаций)
		|		И ДД.Проведен
		|	СГРУППИРОВАТЬ ПО
		|		Строки.ЗаказПереработчику,
		|		Строки.НомерГруппыЗатрат
		|	
		|	ОБЪЕДИНИТЬ ВСЕ
		|	
		|	ВЫБРАТЬ
		|		Строки.ДокументПоступления КАК ЗаказНаПроизводство,
		|		0 КАК КодСтрокиПродукция,
		|		НЕОПРЕДЕЛЕНО КАК Спецификация,
		|		Строки.НомерГруппыЗатрат,
		|		СУММА(ВЫБОР Строки.ДоляСтоимости КОГДА 0 ТОГДА 1
		|			ИНАЧЕ Строки.ДоляСтоимости КОНЕЦ) КАК ДоляСтоимости
		|	ИЗ
		|		Документ.ОтчетПереработчика КАК ДД
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ОтчетПереработчика.Продукция КАК Строки
		|			ПО Строки.Ссылка = ДД.Ссылка
		|	ГДЕ
		|		ДД.Дата МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|		И ДД.Организация В (&МассивОрганизаций)
		|		И ДД.Проведен
		|	СГРУППИРОВАТЬ ПО
		|		Строки.ДокументПоступления,
		|		Строки.НомерГруппыЗатрат
		//++ НЕ УТКА
		|
		|	ОБЪЕДИНИТЬ ВСЕ
		|
		|	ВЫБРАТЬ
		|		МаршрутныйЛист.Распоряжение КАК ЗаказНаПроизводство,
		|		МаршрутныйЛист.КодСтроки КАК КодСтрокиПродукция,
		|		Этапы.Владелец КАК Спецификация,
		|		0 КАК НомерГруппыЗатрат,
		|		СУММА(ВЫБОР ДД.ДоляСтоимости КОГДА 0 ТОГДА 1
		|			ИНАЧЕ ДД.ДоляСтоимости КОНЕЦ
		|			* (МаршрутныйЛист.Произведено + МаршрутныйЛист.Брак)) КАК ДоляСтоимости
		|	ИЗ
		|		РегистрНакопления.РаспоряженияНаВыпускПродукции КАК ДД
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.МаршрутныйЛистПроизводства КАК МаршрутныйЛист
		|			ПО МаршрутныйЛист.Ссылка = ДД.Распоряжение
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ЭтапыПроизводства КАК Этапы
		|			ПО Этапы.Ссылка = МаршрутныйЛист.Этап
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ЗаказыКРаспределению КАК Заказы
		|			ПО Заказы.Заказ = МаршрутныйЛист.Распоряжение
		|				И Заказы.КодСтроки = МаршрутныйЛист.КодСтроки
		|	ГДЕ
		|		ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|		И МаршрутныйЛист.Организация В (&МассивОрганизаций)
		|		И ДД.Активность
		|		И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|		И ДД.ТипСтоимости = ЗНАЧЕНИЕ(Перечисление.ТипыСтоимостиВыходныхИзделий.Рассчитывается)
		|	СГРУППИРОВАТЬ ПО
		|		МаршрутныйЛист.Распоряжение,
		|		МаршрутныйЛист.КодСтроки,
		|		Этапы.Владелец
		|	
		|	ОБЪЕДИНИТЬ ВСЕ
		|	
		|	ВЫБРАТЬ
		|		МаршрутныйЛист.ЗаказНаПроизводство КАК ЗаказНаПроизводство,
		|		МаршрутныйЛист.КодСтрокиПродукция КАК КодСтрокиПродукция,
		|		Этапы.Владелец КАК Спецификация,
		|		0 КАК НомерГруппыЗатрат,
		|		СУММА(МаршрутныйЛист.ДоляСтоимости
		|			* МаршрутныйЛист.Произведено) КАК ДоляСтоимости
		|	ИЗ
		|		ПрошлыеРаспоряженияНаВыпускПродукции КАК МаршрутныйЛист
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ЭтапыПроизводства КАК Этапы
		|			ПО Этапы.Ссылка = МаршрутныйЛист.Этап
		|	СГРУППИРОВАТЬ ПО
		|		МаршрутныйЛист.ЗаказНаПроизводство,
		|		МаршрутныйЛист.КодСтрокиПродукция,
		|		Этапы.Владелец
		//-- НЕ УТКА
		|	)КАК ДолиСтоимости
		|
		|СГРУППИРОВАТЬ ПО
		|	ДолиСтоимости.ЗаказНаПроизводство,
		|	ДолиСтоимости.КодСтрокиПродукция,
		|	ДолиСтоимости.Спецификация,
		|	ДолиСтоимости.НомерГруппыЗатрат
		|	
		|;
		|////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ДД.Ссылка КАК Распоряжение,
		|	СУММА(ВЫБОР Выходы.ДоляСтоимости КОГДА 0 ТОГДА 1
		|		ИНАЧЕ Выходы.ДоляСтоимости КОНЕЦ) КАК ДоляСтоимости
		|ПОМЕСТИТЬ
		|	ВыпускиБезЗаказов
		|ИЗ
		|	Документ.СписаниеЗатратНаВыпуск КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.СписаниеЗатратНаВыпуск.ВыходныеИзделия КАК Выходы
		|		ПО Выходы.Ссылка = ДД.Ссылка
		|ГДЕ
		|	ДД.Дата МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Проведен
		|СГРУППИРОВАТЬ ПО
		|	ДД.Ссылка
		|;
		|////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ДД.Регистратор КАК Регистратор,
		|	ДД.ЗаказНаПроизводство КАК ДокументВыпуска,
		|	ДД.КодСтрокиПродукция КАК КодСтроки,
		|	Выпуск.Номенклатура КАК Номенклатура,
		|	Выпуск.Характеристика КАК Характеристика,
		|	МАКСИМУМ(Выпуск.Количество) КАК ДоляСтоимости
		|ПОМЕСТИТЬ
		|	РаспределениеНаВыпускиБезЗаказов
		|ИЗ
		|	РегистрНакопления.ПартииПроизводственныхЗатрат КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ВыпускПродукции.Товары КАК Выпуск
		|	ПО Выпуск.Ссылка = ДД.ЗаказНаПроизводство
		|		И Выпуск.КодСтроки = ДД.КодСтрокиПродукция
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И (ДД.Регистратор ССЫЛКА Документ.РаспределениеПроизводственныхЗатрат
		|		ИЛИ ДД.Регистратор ССЫЛКА Документ.СписаниеЗатратНаВыпуск)
		|	И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		|	И ДД.ЗаказНаПроизводство ССЫЛКА Документ.ВыпускПродукции
		|СГРУППИРОВАТЬ ПО
		|	ДД.Регистратор,
		|	ДД.ЗаказНаПроизводство,
		|	ДД.КодСтрокиПродукция,
		|	Выпуск.Номенклатура,
		|	Выпуск.Характеристика
		|;
		|////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	Списание.Ссылка КАК СписаниеНаВыпуск,
		|	ДД.Период,
		|	ДД.Регистратор
		|ПОМЕСТИТЬ
		|	РаспределенияПоБазе
		|ИЗ
		|	РегистрНакопления.МатериалыИРаботыВПроизводстве КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.СписаниеЗатратНаВыпуск КАК Списание
		|		ПО Списание.Ссылка = ДД.ЗаказНаПроизводство
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|;
		|////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	ДД.Регистратор
		|ПОМЕСТИТЬ
		|	МатериалыИРаботыВПроизводстве
		|ИЗ
		|	РегистрНакопления.МатериалыИРаботыВПроизводстве КАК ДД
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|;
		|////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	Строки.ЗаказПереработчику,
		|	Строки.КодСтроки,
		|	ЕСТЬNULL(ПродукцияЗаказа.Назначение, ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка)) КАК Назначение,
		|	Строки.Номенклатура,
		|	Строки.Характеристика
		|ПОМЕСТИТЬ
		|	ПродукцияЗаказовПереработчику
		|ИЗ
		|	Документ.ОтчетПереработчика КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ОтчетПереработчика.Продукция КАК Строки
		|		ПО Строки.Ссылка = ДД.Ссылка
		|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.ЗаказПереработчику.Продукция КАК ПродукцияЗаказа
		|		ПО ПродукцияЗаказа.Ссылка = Строки.ЗаказПереработчику
		|		И ПродукцияЗаказа.КодСтроки = Строки.КодСтроки
		|		И ПродукцияЗаказа.Номенклатура = Строки.Номенклатура
		|ГДЕ
		|	ДД.Дата МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Проведен
		|";
КонецФункции

Функция ТекстОписаниеДанныхДляПартийНЗП()
	Возврат "
		|ВЫБРАТЬ ПЕРВЫЕ 0
		|	ВЫРАЗИТЬ("""" КАК СТРОКА(80)) КАК ЗапросИсточник,
		|	0 КАК Приоритет,
		|	""ХХХХХХХХХХХХХХХХХХХХ"" КАК ТипЗаписи,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
		|	ДАТАВРЕМЯ(1, 1, 1, 0, 0, 0) КАК Период,
		|	ДД.Регистратор,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КАК РазделУчета,
		|	ЗНАЧЕНИЕ(Справочник.Организации.ПустаяСсылка) КАК Организация,
		|	ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка) КАК Подразделение,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КАК АналитикаУчетаНоменклатуры,
		|	ДД.ДокументПоступления,
		|	ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка) КАК ВидЗапасов,
		|	ЗНАЧЕНИЕ(Справочник.ГруппыАналитическогоУчетаНоменклатуры.ПустаяСсылка) КАК ГруппаПродукции,
		|	ДД.ЗаказНаПроизводство,
		|	0 КАК КодСтрокиПродукция,
		|	ЗНАЧЕНИЕ(Справочник.РесурсныеСпецификации.ПустаяСсылка) КАК Спецификация,
		|	ЗНАЧЕНИЕ(Справочник.ЭтапыПроизводства.ПустаяСсылка) КАК Этап,
		|	ЗНАЧЕНИЕ(Справочник.СтатьиКалькуляции.ПустаяСсылка) КАК СтатьяКалькуляции,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка) КАК АналитикаУчетаПартий,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КАК АналитикаУчетаПродукции,
		|	0 КАК Знаменатель,
		|	0 КАК КоличествоПродукции,
		|	0 КАК Количество,
		|	0 КАК Стоимость,
		|	0 КАК СтоимостьБезНДС,
		|	0 КАК СтоимостьРегл,
		|	0 КАК НДСРегл,
		|	0 КАК ПостояннаяРазница,
		|	0 КАК ВременнаяРазница,
		|	ЛОЖЬ КАК Первичное,
		|	ЛОЖЬ КАК СохранятьРегл,
		|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПустаяСсылка) КАК ХозяйственнаяОперация,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КАК КорРазделУчета,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КАК КорАналитикаУчетаНоменклатуры,
		|	ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка) КАК КорВидЗапасов,
		|	ДАТАВРЕМЯ(1, 1, 1, 0, 0, 0) КАК ДатаРегистратора,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка) КАК НалогообложениеПартии,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка) КАК НалогообложениеНДС,
		|	ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка) КАК Назначение,
		|	ДД.ДокументИсточник,
		|	ДД.ДокументВыпуска,
		|	0 КАК НомерГруппыЗатрат,
		|	ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка) КАК Продукция,
		|	ЗНАЧЕНИЕ(Справочник.ХарактеристикиНоменклатуры.ПустаяСсылка) КАК ХарактеристикаПродукции,
		|	ЗНАЧЕНИЕ(Справочник.СерииНоменклатуры.ПустаяСсылка) КАК Серия
		|//ВоВременнуюТаблицу ПОМЕСТИТЬ ИсходныеДанные
		|ИЗ
		|	РегистрНакопления.ПартииНезавершенногоПроизводства КАК ДД
		|";
КонецФункции

Функция ТекстОстаткиПартийНЗП() // использует ПрошлыеПоступления
	// передачи материалов в производство и в переработку, возвраты материалов из производства и от переработчика.
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстОстаткиПартийНЗП"" КАК ЗапросИсточник,
		|	10 КАК Приоритет,
		|	""Остаток"" КАК ТипЗаписи,
		|	ИСТИНА КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
		|	ЕСТЬNULL(Периодика.Период, &НачалоПериода) КАК Период,
		|	ЕСТЬNULL(Периодика.Регистратор, ДД.ДокументПоступления) КАК Регистратор,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты) КАК РазделУчета,
		|	ДД.Организация,
		|	Аналитика.МестоХранения КАК Подразделение,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ДокументПоступления,
		|	ДД.ВидЗапасов,
		|	ДД.ВидЗапасов.ГруппаПродукции КАК ГруппаПродукции,
		|	ДД.ЗаказНаПроизводство,
		|	ДД.КодСтрокиПродукция,
		|	ЕСТЬNULL(Этапы.Владелец, ЗНАЧЕНИЕ(Справочник.РесурсныеСпецификации.ПустаяСсылка)) КАК Спецификация,
		|	ДД.Этап,
		|	ДД.СтатьяКалькуляции,
		|	ДД.АналитикаУчетаПартий,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаПродукции,
		|	ЕСТЬNULL(Доли.ДоляСтоимости, 1) КАК Знаменатель,
		|	0 КАК КоличествоПродукции,
		|	ДД.КоличествоОстаток КАК Количество,
		|	ДД.СтоимостьОстаток КАК Стоимость,
		|	ДД.СтоимостьБезНДСОстаток КАК СтоимостьБезНДС,
		|	ДД.СтоимостьРеглОстаток КАК СтоимостьРегл,
		|	ДД.НДСРеглОстаток КАК НДСРегл,
		|	ДД.ПостояннаяРазницаОстаток КАК ПостояннаяРазница,
		|	ДД.ВременнаяРазницаОстаток КАК ВременнаяРазница,
		|	ИСТИНА КАК Первичное,
		|	ЛОЖЬ КАК СохранятьРегл,
		|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПустаяСсылка) КАК ХозяйственнаяОперация,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КАК КорРазделУчета,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КАК КорАналитикаУчетаНоменклатуры,
		|	ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка) КАК КорВидЗапасов,
		|	ДАТАВРЕМЯ(1, 1, 1, 0, 0, 0) КАК ДатаРегистратора,
		|	ЕСТЬNULL(ДД.АналитикаУчетаПартий.НалогообложениеНДС, НЕОПРЕДЕЛЕНО) КАК НалогообложениеПартии,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка) КАК НалогообложениеНДС,
		|	ДД.АналитикаУчетаНоменклатуры.Назначение КАК Назначение,
		|	ЕСТЬNULL(Периодика.Регистратор, ДД.ДокументПоступления) КАК ДокументИсточник,
		|	НЕОПРЕДЕЛЕНО КАК ДокументВыпуска,
		|	0 КАК НомерГруппыЗатрат,
		|	НЕОПРЕДЕЛЕНО КАК Продукция,
		|	НЕОПРЕДЕЛЕНО КАК ХарактеристикаПродукции,
		|	НЕОПРЕДЕЛЕНО КАК Серия
		|ИЗ
		|	РегистрНакопления.ПартииНезавершенногоПроизводства.Остатки(&НачалоПериода, Организация В (&МассивОрганизаций)) КАК ДД
		|	ЛЕВОЕ СОЕДИНЕНИЕ ПрошлыеПоступления КАК Периодика
		|		ПО Периодика.Ссылка = ДД.ДокументПоступления
		|		И Периодика.Склад = ДД.АналитикаУчетаНоменклатуры.МестоХранения
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК Аналитика
		|		ПО Аналитика.Ссылка = ДД.АналитикаУчетаНоменклатуры
		|	ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ЭтапыПроизводства КАК Этапы
		|		ПО Этапы.Ссылка = ДД.Этап
		|	ЛЕВОЕ СОЕДИНЕНИЕ ДолиСтоимости КАК Доли
		|		ПО Доли.ЗаказНаПроизводство = ДД.ЗаказНаПроизводство
		|		И Доли.КодСтрокиПродукция = ДД.КодСтрокиПродукция
		|		И Доли.Спецификация = Этапы.Владелец
		|";
КонецФункции

Функция ТекстПервичныеПартииНЗП() // использует ДолиСтоимости
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстПервичныеПартииНЗП"" КАК ЗапросИсточник,
		|	10 КАК Приоритет,
		|	""Партия"" КАК ТипЗаписи,
		|	ИСТИНА КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
		|	ДАТАВРЕМЯ(1, 1, 1, 0, 0, 0) КАК Период,
		|	НЕОПРЕДЕЛЕНО КАК Регистратор,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КАК РазделУчета,
		|	ДД.Организация,
		|	Аналитика.МестоХранения КАК Подразделение,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ДокументПоступления,
		|	ДД.ВидЗапасов,
		|	ДД.ВидЗапасов.ГруппаПродукции КАК ГруппаПродукции,
		|	ДД.ЗаказНаПроизводство,
		|	ДД.КодСтрокиПродукция,
		|	Этапы.Владелец КАК Спецификация,
		|	ДД.Этап,
		|	ДД.СтатьяКалькуляции,
		|	ДД.АналитикаУчетаПартий,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаПродукции,
		|	МАКСИМУМ(ЕСТЬNULL(Доли.ДоляСтоимости, 1)) КАК Знаменатель,
		|	0 КАК КоличествоПродукции,
		|	СУММА(ДД.Количество) КАК Количество,
		|	СУММА(ДД.Стоимость) КАК Стоимость,
		|	СУММА(ДД.СтоимостьБезНДС) КАК СтоимостьБезНДС,
		|	СУММА(ДД.СтоимостьРегл) КАК СтоимостьРегл,
		|	СУММА(ДД.НДСРегл) КАК НДСРегл,
		|	СУММА(ДД.ПостояннаяРазница) КАК ПостояннаяРазница,
		|	СУММА(ДД.ВременнаяРазница) КАК ВременнаяРазница,
		|	ИСТИНА КАК Первичное,
		|	ЛОЖЬ КАК СохранятьРегл,
		|	НЕОПРЕДЕЛЕНО КАК ХозяйственнаяОперация,
		|	НЕОПРЕДЕЛЕНО КАК КорРазделУчета,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаУчетаНоменклатуры,
		|	НЕОПРЕДЕЛЕНО КАК КорВидЗапасов,
		|	ДАТАВРЕМЯ(1, 1, 1, 0, 0, 0) КАК ДатаРегистратора,
		|	ЕСТЬNULL(ДД.АналитикаУчетаПартий.НалогообложениеНДС, НЕОПРЕДЕЛЕНО) КАК НалогообложениеПартии,
		|	НЕОПРЕДЕЛЕНО КАК НалогообложениеНДС,
		|	ДД.АналитикаУчетаНоменклатуры.Назначение КАК Назначение,
		|	ДД.ДокументИсточник,
		|	НЕОПРЕДЕЛЕНО КАК ДокументВыпуска,
		|	ДД.НомерГруппыЗатрат,
		|	НЕОПРЕДЕЛЕНО КАК Продукция,
		|	НЕОПРЕДЕЛЕНО КАК ХарактеристикаПродукции,
		|	НЕОПРЕДЕЛЕНО КАК Серия
		|ИЗ
		|	РегистрНакопления.ПартииПроизводственныхЗатрат КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ЭтапыПроизводства КАК Этапы
		|		ПО Этапы.Ссылка = ДД.Этап
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК Аналитика
		|		ПО Аналитика.Ссылка = ДД.АналитикаУчетаНоменклатуры
		|	ЛЕВОЕ СОЕДИНЕНИЕ ДолиСтоимости КАК Доли
		|		ПО Доли.ЗаказНаПроизводство = ДД.ЗаказНаПроизводство
		|		И Доли.КодСтрокиПродукция = ДД.КодСтрокиПродукция
		|		И Доли.Спецификация = Этапы.Владелец
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		|	И ДД.СтатьяКалькуляции <> ЗНАЧЕНИЕ(Справочник.СтатьиКалькуляции.ПустаяСсылка)
		|СГРУППИРОВАТЬ ПО
		|	ДД.Организация,
		|	Аналитика.МестоХранения,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.АналитикаУчетаНоменклатуры.Назначение,
		|	ДД.ДокументПоступления,
		|	ДД.ВидЗапасов,
		|	ДД.ЗаказНаПроизводство,
		|	ДД.КодСтрокиПродукция,
		|	Этапы.Владелец,
		|	ДД.Этап,
		|	ДД.СтатьяКалькуляции,
		|	ДД.АналитикаУчетаПартий,
		|	ДД.ДокументИсточник,
		|	ДД.НомерГруппыЗатрат
		|";
КонецФункции

Функция ТекстПервичныеПартииПереработчик() // использует ДолиСтоимости
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстПервичныеПартииПереработчик"" КАК ЗапросИсточник,
		|	10 КАК Приоритет,
		|	""Партия"" КАК ТипЗаписи,
		|	ИСТИНА КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
		|	ДД.Период КАК Период,
		|	ДД.Регистратор КАК Регистратор,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КАК РазделУчета,
		|	ДД.Организация,
		|	Аналитика.МестоХранения КАК Подразделение,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ДокументПоступления,
		|	ДД.ВидЗапасов,
		|	ДД.ВидЗапасов.ГруппаПродукции КАК ГруппаПродукции,
		|	(ВЫБОР
		|		КОГДА ДД.ЗаказНаПроизводство ССЫЛКА Документ.ПоступлениеОтПереработчика ТОГДА НЕОПРЕДЕЛЕНО
		|		ИНАЧЕ ДД.ЗаказНаПроизводство КОНЕЦ) КАК ЗаказНаПроизводство,
		|	0 КАК КодСтрокиПродукция,
		|	ЗНАЧЕНИЕ(Справочник.РесурсныеСпецификации.ПустаяСсылка) КАК Спецификация,
		|	НЕОПРЕДЕЛЕНО КАК Этап,
		|	ДД.СтатьяКалькуляции,
		|	ДД.АналитикаУчетаПартий,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаПродукции,
		|	МАКСИМУМ(ЕСТЬNULL(Доли.ДоляСтоимости, 1)) КАК Знаменатель,
		|	0 КАК КоличествоПродукции,
		|	СУММА(ДД.Количество) КАК Количество,
		|	СУММА(ДД.Стоимость) КАК Стоимость,
		|	СУММА(ДД.СтоимостьБезНДС) КАК СтоимостьБезНДС,
		|	СУММА(ДД.СтоимостьРегл) КАК СтоимостьРегл,
		|	СУММА(ДД.НДСРегл) КАК НДСРегл,
		|	СУММА(ДД.ПостояннаяРазница) КАК ПостояннаяРазница,
		|	СУММА(ДД.ВременнаяРазница) КАК ВременнаяРазница,
		|	ИСТИНА КАК Первичное,
		|	ЛОЖЬ КАК СохранятьРегл,
		|	НЕОПРЕДЕЛЕНО КАК ХозяйственнаяОперация,
		|	НЕОПРЕДЕЛЕНО КАК КорРазделУчета,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаУчетаНоменклатуры,
		|	НЕОПРЕДЕЛЕНО КАК КорВидЗапасов,
		|	ДАТАВРЕМЯ(1, 1, 1, 0, 0, 0) КАК ДатаРегистратора,
		|	ЕСТЬNULL(ДД.АналитикаУчетаПартий.НалогообложениеНДС, НЕОПРЕДЕЛЕНО) КАК НалогообложениеПартии,
		|	НЕОПРЕДЕЛЕНО КАК НалогообложениеНДС,
		|	ДД.АналитикаУчетаНоменклатуры.Назначение КАК Назначение,
		|	ДД.ДокументИсточник,
		|	(ВЫБОР
		|		КОГДА ДД.ЗаказНаПроизводство ССЫЛКА Документ.ПоступлениеОтПереработчика ТОГДА ДД.ЗаказНаПроизводство
		|		ИНАЧЕ НЕОПРЕДЕЛЕНО КОНЕЦ) КАК ДокументВыпуска,
		|	ДД.НомерГруппыЗатрат,
		|	НЕОПРЕДЕЛЕНО КАК Продукция,
		|	НЕОПРЕДЕЛЕНО КАК ХарактеристикаПродукции,
		|	НЕОПРЕДЕЛЕНО КАК Серия
		|ИЗ
		|	РегистрНакопления.ПартииПроизводственныхЗатрат КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК Аналитика
		|		ПО Аналитика.Ссылка = ДД.АналитикаУчетаНоменклатуры
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ДолиСтоимости КАК Доли
		|		ПО Доли.ЗаказНаПроизводство = ДД.ЗаказНаПроизводство
		|		И Доли.НомерГруппыЗатрат = ДД.НомерГруппыЗатрат
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		|	И (ДД.Регистратор ССЫЛКА Документ.ОтчетПереработчика
		|		ИЛИ (ТИПЗНАЧЕНИЯ(ДД.ЗаказНаПроизводство) = ТИП(Документ.ЗаказПереработчику)
		|			И НЕ ДД.ЗаказНаПроизводство = ЗНАЧЕНИЕ(Документ.ЗаказПереработчику.ПустаяСсылка)))
		|
		|СГРУППИРОВАТЬ ПО
		|	ДД.Организация,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	Аналитика.МестоХранения,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.АналитикаУчетаНоменклатуры.Назначение,
		|	ДД.ДокументПоступления,
		|	ДД.ВидЗапасов,
		|	(ВЫБОР
		|		КОГДА ДД.ЗаказНаПроизводство ССЫЛКА Документ.ПоступлениеОтПереработчика ТОГДА НЕОПРЕДЕЛЕНО
		|		ИНАЧЕ ДД.ЗаказНаПроизводство КОНЕЦ),
		|	ДД.СтатьяКалькуляции,
		|	ДД.АналитикаУчетаПартий,
		|	ДД.ДокументИсточник,
		|	ДД.ЗаказНаПроизводство,
		|	ДД.НомерГруппыЗатрат
		|";
КонецФункции

Функция ТекстДополнениеПартийНЗП()
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстДополнениеПартийНЗП"" КАК ЗапросИсточник,
		|	10 КАК Приоритет,
		|	""Дополнение"" КАК ТипЗаписи,
		|	ИСТИНА КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты) КАК РазделУчета,
		|	ДД.Организация,
		|	Аналитика.МестоХранения КАК Подразделение,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ДокументПоступления,
		|	ДД.ВидЗапасов,
		|	ДД.ВидЗапасов.ГруппаПродукции КАК ГруппаПродукции,
		|	ВЫБОР
		|		КОГДА ДД.ЗаказНаПроизводство = НЕОПРЕДЕЛЕНО
		|			ТОГДА ЕСТЬNULL(Этапы.Владелец, ДД.Спецификация)
		|		ИНАЧЕ ДД.ЗаказНаПроизводство
		|	КОНЕЦ КАК ЗаказНаПроизводство,
		|	ДД.КодСтрокиПродукция КАК КодСтрокиПродукция,
		|	ЕСТЬNULL(Этапы.Владелец, ДД.Спецификация) КАК Спецификация,
		|	ДД.Этап,
		|	ДД.СтатьяКалькуляции,
		|	ДД.АналитикаУчетаПартий,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаПродукции,
		|	0 КАК Знаменатель,
		|	0 КАК КоличествоПродукции,
		|	СУММА(ДД.Количество) КАК Количество,
		|	СУММА(ДД.Стоимость) КАК Стоимость,
		|	СУММА(ДД.СтоимостьБезНДС) КАК СтоимостьБезНДС,
		|	СУММА(ДД.СтоимостьРегл) КАК СтоимостьРегл,
		|	СУММА(ДД.НДСРегл) КАК НДСРегл,
		|	СУММА(ДД.ПостояннаяРазница) КАК ПостояннаяРазница,
		|	СУММА(ДД.ВременнаяРазница) КАК ВременнаяРазница,
		|	ИСТИНА КАК Первичное,
		|	ЛОЖЬ КАК СохранятьРегл,
		|	НЕОПРЕДЕЛЕНО КАК ХозяйственнаяОперация,
		|	НЕОПРЕДЕЛЕНО КАК КорРазделУчета,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаУчетаНоменклатуры,
		|	НЕОПРЕДЕЛЕНО КАК КорВидЗапасов,
		|	ДАТАВРЕМЯ(1, 1, 1, 0, 0, 0) КАК ДатаРегистратора,
		|	НЕОПРЕДЕЛЕНО КАК НалогообложениеПартии,
		|	НЕОПРЕДЕЛЕНО КАК НалогообложениеНДС,
		|	ДД.АналитикаУчетаНоменклатуры.Назначение КАК Назначение,
		|	ДД.ДокументИсточник,
		|	ВЫБОР
		|		КОГДА ДД.ЗаказНаПроизводство ССЫЛКА Документ.ВыпускПродукции
		|			ТОГДА ДД.ЗаказНаПроизводство
		|		ИНАЧЕ НЕОПРЕДЕЛЕНО
		|	КОНЕЦ КАК ДокументВыпуска,
		|	ДД.НомерГруппыЗатрат КАК НомерГруппыЗатрат,
		|	ВЫБОР
		//++ НЕ УТКА
		|		КОГДА НЕ Заказ.Номенклатура ЕСТЬ NULL ТОГДА Заказ.Номенклатура
		//-- НЕ УТКА
		|		КОГДА НЕ ЗаказПереработчику.Номенклатура ЕСТЬ NULL ТОГДА ЗаказПереработчику.Номенклатура
		|		КОГДА НЕ Выпуск.Номенклатура ЕСТЬ NULL ТОГДА Выпуск.Номенклатура
		|		ИНАЧЕ ЕСТЬNULL(КорАналитика.Номенклатура, НЕОПРЕДЕЛЕНО)
		|	КОНЕЦ КАК Продукция,
		|	ВЫБОР
		//++ НЕ УТКА
		|		КОГДА НЕ Заказ.Характеристика ЕСТЬ NULL ТОГДА Заказ.Характеристика
		//-- НЕ УТКА
		|		КОГДА НЕ ЗаказПереработчику.Характеристика ЕСТЬ NULL ТОГДА ЗаказПереработчику.Характеристика
		|		КОГДА НЕ Выпуск.Характеристика ЕСТЬ NULL ТОГДА Выпуск.Характеристика
		|		ИНАЧЕ ЕСТЬNULL(КорАналитика.Характеристика, НЕОПРЕДЕЛЕНО)
		|	КОНЕЦ КАК ХарактеристикаПродукции,
		|	НЕОПРЕДЕЛЕНО КАК Серия
		|ИЗ
		|	РегистрНакопления.ПартииПроизводственныхЗатрат КАК ДД
		|	ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ЭтапыПроизводства КАК Этапы
		|		ПО Этапы.Ссылка = ДД.Этап
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК Аналитика
		|		ПО Аналитика.Ссылка = ДД.АналитикаУчетаНоменклатуры
		|	ЛЕВОЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК КорАналитика
		|		ПО КорАналитика.Ссылка = ДД.КорАналитикаУчетаНоменклатуры
		//++ НЕ УТКА
		|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.ЗаказНаПроизводство.Продукция КАК Заказ
		|		ПО Заказ.Ссылка = ДД.ЗаказНаПроизводство
		|		И Заказ.КодСтроки = ДД.КодСтрокиПродукция
		//-- НЕ УТКА
		|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.ЗаказПереработчику.Продукция КАК ЗаказПереработчику
		|		ПО ЗаказПереработчику.Ссылка = ДД.ЗаказНаПроизводство
		|		И ЗаказПереработчику.НомерГруппыЗатрат = ДД.НомерГруппыЗатрат
		|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.ВыпускПродукции.Товары КАК Выпуск
		|		ПО Выпуск.Ссылка = ДД.ЗаказНаПроизводство
		|		И Выпуск.КодСтроки = ДД.КодСтрокиПродукция
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		|	И (ДД.Регистратор ССЫЛКА Документ.РаспределениеПроизводственныхЗатрат
		//++ НЕ УТКА
		|		ИЛИ ДД.Регистратор ССЫЛКА Документ.МаршрутныйЛистПроизводства
		//-- НЕ УТКА
		|		)
		|	И (ДД.СтатьяРасходовСписания = ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка)
		|		ИЛИ ДД.СтатьяРасходовСписания = НЕОПРЕДЕЛЕНО)
		|	И ЗаказПереработчику.Ссылка ЕСТЬ NULL
		|СГРУППИРОВАТЬ ПО
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	Аналитика.МестоХранения,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ДокументПоступления,
		|	ДД.ВидЗапасов,
		|	ДД.ЗаказНаПроизводство,
		|	ВЫБОР
		|		КОГДА ДД.ЗаказНаПроизводство = НЕОПРЕДЕЛЕНО
		|			ТОГДА ЕСТЬNULL(Этапы.Владелец, ДД.Спецификация)
		|		ИНАЧЕ ДД.ЗаказНаПроизводство
		|	КОНЕЦ,
		|	ДД.КодСтрокиПродукция,
		|	Этапы.Владелец,
		|	ДД.Спецификация,
		|	ДД.Этап,
		|	ДД.СтатьяКалькуляции,
		|	ДД.АналитикаУчетаПартий,
		|	ДД.ДокументИсточник,
		|	ДД.НомерГруппыЗатрат,
		|	ВЫБОР
		//++ НЕ УТКА
		|		КОГДА НЕ Заказ.Номенклатура ЕСТЬ NULL ТОГДА Заказ.Номенклатура
		//-- НЕ УТКА
		|		КОГДА НЕ ЗаказПереработчику.Номенклатура ЕСТЬ NULL ТОГДА ЗаказПереработчику.Номенклатура
		|		КОГДА НЕ Выпуск.Номенклатура ЕСТЬ NULL ТОГДА Выпуск.Номенклатура
		|		ИНАЧЕ ЕСТЬNULL(КорАналитика.Номенклатура, НЕОПРЕДЕЛЕНО)
		|	КОНЕЦ,
		|	ВЫБОР
		//++ НЕ УТКА
		|		КОГДА НЕ Заказ.Характеристика ЕСТЬ NULL ТОГДА Заказ.Характеристика
		//-- НЕ УТКА
		|		КОГДА НЕ ЗаказПереработчику.Характеристика ЕСТЬ NULL ТОГДА ЗаказПереработчику.Характеристика
		|		КОГДА НЕ Выпуск.Характеристика ЕСТЬ NULL ТОГДА Выпуск.Характеристика
		|		ИНАЧЕ ЕСТЬNULL(КорАналитика.Характеристика, НЕОПРЕДЕЛЕНО)
		|	КОНЕЦ
		|";
КонецФункции

Функция ТекстДополнениеПрошлыеПартииНЗП() // использует МатериалыИРаботыВПроизводстве
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстДополнениеПрошлыеПартииНЗП"" КАК ЗапросИсточник,
		|	10 КАК Приоритет,
		|	""Дополнение"" КАК ТипЗаписи,
		|	ИСТИНА КАК РасчетЗавершен,
		|	ДД.ВидДвижения,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты) КАК РазделУчета,
		|	ДД.Организация,
		|	НЕОПРЕДЕЛЕНО КАК Подразделение,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ДокументПоступления,
		|	ДД.ВидЗапасов,
		|	НЕОПРЕДЕЛЕНО КАК ГруппаПродукции,
		|	ДД.ЗаказНаПроизводство,
		|	ДД.КодСтрокиПродукция,
		|	НЕОПРЕДЕЛЕНО КАК Спецификация,
		|	ДД.Этап,
		|	ДД.СтатьяКалькуляции,
		|	ДД.АналитикаУчетаПартий,
		|	ДД.АналитикаУчетаПродукции КАК АналитикаУчетаПродукции,
		|	0 КАК Знаменатель,
		|	0 КАК КоличествоПродукции,
		|	СУММА(ДД.Количество) КАК Количество,
		|	СУММА(ДД.Стоимость) КАК Стоимость,
		|	СУММА(ДД.СтоимостьБезНДС) КАК СтоимостьБезНДС,
		|	СУММА(ДД.СтоимостьРегл) КАК СтоимостьРегл,
		|	СУММА(ДД.НДСРегл) КАК НДСРегл,
		|	СУММА(ДД.ПостояннаяРазница) КАК ПостояннаяРазница,
		|	СУММА(ДД.ВременнаяРазница) КАК ВременнаяРазница,
		|	ИСТИНА КАК Первичное,
		|	ЛОЖЬ КАК СохранятьРегл,
		|	НЕОПРЕДЕЛЕНО КАК ХозяйственнаяОперация,
		|	НЕОПРЕДЕЛЕНО КАК КорРазделУчета,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаУчетаНоменклатуры,
		|	НЕОПРЕДЕЛЕНО КАК КорВидЗапасов,
		|	ДАТАВРЕМЯ(1, 1, 1, 0, 0, 0) КАК ДатаРегистратора,
		|	НЕОПРЕДЕЛЕНО КАК НалогообложениеПартии,
		|	НЕОПРЕДЕЛЕНО КАК НалогообложениеНДС,
		|	НЕОПРЕДЕЛЕНО КАК Назначение,
		|	ДД.ДокументИсточник,
		|	НЕОПРЕДЕЛЕНО КАК ДокументВыпуска,
		|	0 КАК НомерГруппыЗатрат,
		|	ДД.Продукция,
		|	ДД.ХарактеристикаПродукции,
		|	НЕОПРЕДЕЛЕНО КАК Серия
		|ИЗ
		|	РегистрНакопления.ПартииНезавершенногоПроизводства КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ МатериалыИРаботыВПроизводстве КАК Движения
		|		ПО Движения.Регистратор = ДД.Регистратор
		|ГДЕ
		|	(ДД.Период < &НачалоПериода ИЛИ ДД.Период > &ОкончаниеПериода)
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|СГРУППИРОВАТЬ ПО
		|	ДД.ВидДвижения,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ДокументПоступления,
		|	ДД.ВидЗапасов,
		|	ДД.ЗаказНаПроизводство,
		|	ДД.КодСтрокиПродукция,
		|	ДД.Этап,
		|	ДД.СтатьяКалькуляции,
		|	ДД.АналитикаУчетаПартий,
		|	ДД.АналитикаУчетаПродукции,
		|	ДД.ДокументИсточник,
		|	ДД.Продукция,
		|	ДД.ХарактеристикаПродукции
		|";
КонецФункции

Функция ТекстПервичныеПартииНЗПБезЗаказов() // использует РаспределениеНаВыпускиБезЗаказов
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстПервичныеПартииНЗПБезЗаказов"" КАК ЗапросИсточник,
		|	10 КАК Приоритет,
		|	(ВЫБОР
		|		КОГДА ДД.ЗаказНаПроизводство ССЫЛКА Документ.ВыпускПродукции ТОГДА ""ЗатратыБезЗаказа""
		|		ИНАЧЕ ""Партия"" КОНЕЦ) КАК ТипЗаписи,
		|	ИСТИНА КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	(ВЫБОР
		|		КОГДА ДД.ЗаказНаПроизводство ССЫЛКА Документ.ВыпускПродукции
		|			И ТИПЗНАЧЕНИЯ(ЕСТЬNULL(Распределение.Регистратор, НЕОПРЕДЕЛЕНО)) <>ТИП(Документ.РаспределениеПроизводственныхЗатрат)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты)
		|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КОНЕЦ) КАК РазделУчета,
		|	ДД.Организация,
		|	Аналитика.МестоХранения КАК Подразделение,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ДокументПоступления,
		|	ДД.ВидЗапасов,
		|	ДД.ВидЗапасов.ГруппаПродукции КАК ГруппаПродукции,
		|	НЕОПРЕДЕЛЕНО КАК ЗаказНаПроизводство,
		|	ДД.КодСтрокиПродукция,
		|	ДД.Спецификация КАК Спецификация,
		|	ЗНАЧЕНИЕ(Справочник.ЭтапыПроизводства.ПустаяСсылка) КАК Этап,
		|	ДД.СтатьяКалькуляции,
		|	ДД.АналитикаУчетаПартий,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаПродукции,
		|	МАКСИМУМ(ЕСТЬNULL(Распределение.ДоляСтоимости, 1)) КАК Знаменатель,
		|	0 КАК КоличествоПродукции,
		|	СУММА(ДД.Количество) КАК Количество,
		|	СУММА(ДД.Стоимость) КАК Стоимость,
		|	СУММА(ДД.СтоимостьБезНДС) КАК СтоимостьБезНДС,
		|	СУММА(ДД.СтоимостьРегл) КАК СтоимостьРегл,
		|	СУММА(ДД.НДСРегл) КАК НДСРегл,
		|	СУММА(ДД.ПостояннаяРазница) КАК ПостояннаяРазница,
		|	СУММА(ДД.ВременнаяРазница) КАК ВременнаяРазница,
		|	ИСТИНА КАК Первичное,
		|	ЛОЖЬ КАК СохранятьРегл,
		|	НЕОПРЕДЕЛЕНО КАК ХозяйственнаяОперация,
		|	НЕОПРЕДЕЛЕНО КАК КорРазделУчета,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаУчетаНоменклатуры,
		|	НЕОПРЕДЕЛЕНО КАК КорВидЗапасов,
		|	ДАТАВРЕМЯ(1, 1, 1, 0, 0, 0) КАК ДатаРегистратора,
		|	ЕСТЬNULL(ДД.АналитикаУчетаПартий.НалогообложениеНДС, НЕОПРЕДЕЛЕНО) КАК НалогообложениеПартии,
		|	НЕОПРЕДЕЛЕНО КАК НалогообложениеНДС,
		|	ДД.АналитикаУчетаНоменклатуры.Назначение КАК Назначение,
		|	ДД.ДокументИсточник,
		|	Распределение.ДокументВыпуска КАК ДокументВыпуска,
		|	ДД.НомерГруппыЗатрат,
		|	ЕСТЬNULL(Распределение.Номенклатура, НЕОПРЕДЕЛЕНО) КАК Продукция,
		|	ЕСТЬNULL(Распределение.Характеристика, НЕОПРЕДЕЛЕНО) КАК ХарактеристикаПродукции,
		|	НЕОПРЕДЕЛЕНО КАК Серия
		|ИЗ
		|	РегистрНакопления.ПартииПроизводственныхЗатрат КАК ДД
		|	ЛЕВОЕ СОЕДИНЕНИЕ РаспределениеНаВыпускиБезЗаказов КАК Распределение
		|		ПО Распределение.Регистратор = ДД.Регистратор
		|		И Распределение.ДокументВыпуска = ДД.ЗаказНаПроизводство
		|		И Распределение.КодСтроки = ДД.КодСтрокиПродукция
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК Аналитика
		|		ПО Аналитика.Ссылка = ДД.АналитикаУчетаНоменклатуры
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		|	И (ДД.ЗаказНаПроизводство = НЕОПРЕДЕЛЕНО
		|		ИЛИ ДД.ЗаказНаПроизводство ССЫЛКА Документ.ВыпускПродукции)
		|	И ДД.СтатьяКалькуляции <> ЗНАЧЕНИЕ(Справочник.СтатьиКалькуляции.ПустаяСсылка)
		|	И НЕ ДД.Регистратор ССЫЛКА Документ.РеализацияТоваровУслуг
		|	И НЕ ДД.Регистратор ССЫЛКА Документ.АктВыполненныхРабот
		|	И НЕ ДД.Регистратор ССЫЛКА Документ.ОтчетОРозничныхПродажах
		|	И НЕ ДД.Регистратор ССЫЛКА Документ.ПередачаТоваровМеждуОрганизациями
		|СГРУППИРОВАТЬ ПО
		|	(ВЫБОР
		|		КОГДА ДД.ЗаказНаПроизводство ССЫЛКА Документ.ВыпускПродукции ТОГДА ""ЗатратыБезЗаказа""
		|		ИНАЧЕ ""Партия"" КОНЕЦ),
		|	ДД.Период,
		|	ДД.Регистратор,
		|	(ВЫБОР
		|		КОГДА ДД.ЗаказНаПроизводство ССЫЛКА Документ.ВыпускПродукции
		|			И ТИПЗНАЧЕНИЯ(ЕСТЬNULL(Распределение.Регистратор, НЕОПРЕДЕЛЕНО)) <>ТИП(Документ.РаспределениеПроизводственныхЗатрат)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты)
		|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КОНЕЦ),
		|	ДД.Организация,
		|	Аналитика.МестоХранения,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.АналитикаУчетаНоменклатуры.Назначение,
		|	ДД.ДокументПоступления,
		|	ДД.ВидЗапасов,
		|	ДД.Спецификация,
		|	ДД.СтатьяКалькуляции,
		|	ДД.АналитикаУчетаПартий,
		|	ДД.ЗаказНаПроизводство,
		|	ДД.КодСтрокиПродукция,
		|	ДД.ДокументИсточник,
		|	Распределение.ДокументВыпуска,
		|	ДД.НомерГруппыЗатрат,
		|	ЕСТЬNULL(Распределение.Номенклатура, НЕОПРЕДЕЛЕНО),
		|	ЕСТЬNULL(Распределение.Характеристика, НЕОПРЕДЕЛЕНО)
		|";
КонецФункции

Функция ТекстПартииРаспределеноПоБазе() // использует ВыпускиБезЗаказов
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстПартииРаспределеноПоБазе"" КАК ЗапросИсточник,
		|	10 КАК Приоритет,
		|	""Партия"" КАК ТипЗаписи,
		|	ИСТИНА КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КАК РазделУчета,
		|	ДД.Организация,
		|	Аналитика.МестоХранения КАК Подразделение,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ДокументПоступления,
		|	ДД.ВидЗапасов,
		|	ДД.ВидЗапасов.ГруппаПродукции КАК ГруппаПродукции,
		|	НЕОПРЕДЕЛЕНО КАК ЗаказНаПроизводство,
		|	ДД.КодСтрокиПродукция,
		|	ДД.Спецификация КАК Спецификация,
		|	ЗНАЧЕНИЕ(Справочник.ЭтапыПроизводства.ПустаяСсылка) КАК Этап,
		|	ДД.СтатьяКалькуляции,
		|	ДД.АналитикаУчетаПартий,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаПродукции,
		|	МАКСИМУМ(Выпуски.ДоляСтоимости) КАК Знаменатель,
		|	0 КАК КоличествоПродукции,
		|	СУММА(ДД.Количество) КАК Количество,
		|	СУММА(ДД.Стоимость) КАК Стоимость,
		|	СУММА(ДД.СтоимостьБезНДС) КАК СтоимостьБезНДС,
		|	СУММА(ДД.СтоимостьРегл) КАК СтоимостьРегл,
		|	СУММА(ДД.НДСРегл) КАК НДСРегл,
		|	СУММА(ДД.ПостояннаяРазница) КАК ПостояннаяРазница,
		|	СУММА(ДД.ВременнаяРазница) КАК ВременнаяРазница,
		|	ИСТИНА КАК Первичное,
		|	ЛОЖЬ КАК СохранятьРегл,
		|	НЕОПРЕДЕЛЕНО КАК ХозяйственнаяОперация,
		|	НЕОПРЕДЕЛЕНО КАК КорРазделУчета,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаУчетаНоменклатуры,
		|	НЕОПРЕДЕЛЕНО КАК КорВидЗапасов,
		|	ДАТАВРЕМЯ(1, 1, 1, 0, 0, 0) КАК ДатаРегистратора,
		|	ЕСТЬNULL(ДД.АналитикаУчетаПартий.НалогообложениеНДС, НЕОПРЕДЕЛЕНО) КАК НалогообложениеПартии,
		|	НЕОПРЕДЕЛЕНО КАК НалогообложениеНДС,
		|	ДД.АналитикаУчетаНоменклатуры.Назначение КАК Назначение,
		|	ДД.ДокументИсточник,
		|	НЕОПРЕДЕЛЕНО КАК ДокументВыпуска,
		|	ДД.НомерГруппыЗатрат,
		|	НЕОПРЕДЕЛЕНО КАК Продукция,
		|	НЕОПРЕДЕЛЕНО КАК ХарактеристикаПродукции,
		|	НЕОПРЕДЕЛЕНО КАК Серия
		|ИЗ
		|	РегистрНакопления.ПартииПроизводственныхЗатрат КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВыпускиБезЗаказов КАК Выпуски
		|		ПО Выпуски.Распоряжение = ДД.ЗаказНаПроизводство
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК Аналитика
		|		ПО Аналитика.Ссылка = ДД.АналитикаУчетаНоменклатуры
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		|	И ДД.ЗаказНаПроизводство ССЫЛКА Документ.СписаниеЗатратНаВыпуск
		|	И ДД.Регистратор ССЫЛКА Документ.РаспределениеПроизводственныхЗатрат
		|СГРУППИРОВАТЬ ПО
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	Аналитика.МестоХранения,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.АналитикаУчетаНоменклатуры.Назначение,
		|	ДД.ДокументПоступления,
		|	ДД.ВидЗапасов,
		|	ДД.Спецификация,
		|	ДД.СтатьяКалькуляции,
		|	ДД.АналитикаУчетаПартий,
		|	ДД.ЗаказНаПроизводство,
		|	ДД.КодСтрокиПродукция,
		|	ДД.ДокументИсточник,
		|	ДД.НомерГруппыЗатрат
		|";
КонецФункции

//++ НЕ УТКА

Функция ТекстМаршрутныеЛисты()
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстМаршрутныеЛисты"" КАК ЗапросИсточник,
		|	40 КАК Приоритет,
		|	""Распределение"" КАК ТипЗаписи,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
		|	ДАТАВРЕМЯ(1, 1, 1, 0, 0, 0) КАК Период,
		|	НЕОПРЕДЕЛЕНО КАК Регистратор,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КАК РазделУчета,
		|	МаршрутныйЛист.Организация,
		|	НЕОПРЕДЕЛЕНО КАК Подразделение,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаНоменклатуры,
		|	НЕОПРЕДЕЛЕНО КАК ДокументПоступления,
		|	НЕОПРЕДЕЛЕНО КАК ВидЗапасов,
		|	НЕОПРЕДЕЛЕНО КАК ГруппаПродукции,
		|	МаршрутныйЛист.Распоряжение КАК ЗаказНаПроизводство,
		|	МаршрутныйЛист.КодСтроки КАК КодСтрокиПродукция,
		|	Этапы.Владелец КАК Спецификация,
		|	НЕОПРЕДЕЛЕНО КАК Этап,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяКалькуляции,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаПартий,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаПродукции,
		|	СУММА(ВЫБОР ДД.ДоляСтоимости КОГДА 0 ТОГДА 1
		|		ИНАЧЕ ДД.ДоляСтоимости КОНЕЦ
		|		* (МаршрутныйЛист.Произведено + МаршрутныйЛист.Брак)) КАК Знаменатель,
		|	СУММА(ДД.Заказано) КАК КоличествоПродукции,
		|	0 КАК Количество,
		|	0 КАК Стоимость,
		|	0 КАК СтоимостьБезНДС,
		|	0 КАК СтоимостьРегл,
		|	0 КАК НДСРегл,
		|	0 КАК ПостояннаяРазница,
		|	0 КАК ВременнаяРазница,
		|	ЛОЖЬ КАК Первичное,
		|	ЛОЖЬ КАК СохранятьРегл,
		|	НЕОПРЕДЕЛЕНО КАК ХозяйственнаяОперация,
		|	НЕОПРЕДЕЛЕНО КАК КорРазделУчета,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаУчетаНоменклатуры,
		|	НЕОПРЕДЕЛЕНО КАК КорВидЗапасов,
		|	ДАТАВРЕМЯ(1, 1, 1, 0, 0, 0) КАК ДатаРегистратора,
		|	НЕОПРЕДЕЛЕНО КАК НалогообложениеПартии,
		|	НЕОПРЕДЕЛЕНО КАК НалогообложениеНДС,
		|	НЕОПРЕДЕЛЕНО КАК Назначение,
		|	НЕОПРЕДЕЛЕНО КАК ДокументИсточник,
		|	НЕОПРЕДЕЛЕНО КАК ДокументВыпуска,
		|	0 КАК НомерГруппыЗатрат,
		|	ДД.Номенклатура КАК Продукция,
		|	ДД.Характеристика КАК ХарактеристикаПродукции,
		|	НЕОПРЕДЕЛЕНО КАК Серия
		|ИЗ
		|	РегистрНакопления.РаспоряженияНаВыпускПродукции КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.МаршрутныйЛистПроизводства КАК МаршрутныйЛист
		|		ПО МаршрутныйЛист.Ссылка = ДД.Распоряжение
		|	ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ЭтапыПроизводства КАК Этапы
		|		ПО Этапы.Ссылка = МаршрутныйЛист.Этап
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И МаршрутныйЛист.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|	И ДД.ТипСтоимости = ЗНАЧЕНИЕ(Перечисление.ТипыСтоимостиВыходныхИзделий.Рассчитывается)
		|	И ДД.Заказано <> 0
		|СГРУППИРОВАТЬ ПО
		|	МаршрутныйЛист.Организация,
		|	МаршрутныйЛист.Распоряжение,
		|	МаршрутныйЛист.КодСтроки,
		|	Этапы.Владелец,
		|	ДД.Номенклатура,
		|	ДД.Характеристика
		|";
КонецФункции

Функция ТекстПрошлыеМаршрутныеЛисты()
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстПрошлыеМаршрутныеЛисты"" КАК ЗапросИсточник,
		|	40 КАК Приоритет,
		|	""Распределение"" КАК ТипЗаписи,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
		|	ДАТАВРЕМЯ(1, 1, 1, 0, 0, 0) КАК Период,
		|	НЕОПРЕДЕЛЕНО КАК Регистратор,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КАК РазделУчета,
		|	МаршрутныйЛист.Организация,
		|	НЕОПРЕДЕЛЕНО КАК Подразделение,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаНоменклатуры,
		|	НЕОПРЕДЕЛЕНО КАК ДокументПоступления,
		|	НЕОПРЕДЕЛЕНО КАК ВидЗапасов,
		|	НЕОПРЕДЕЛЕНО КАК ГруппаПродукции,
		|	МаршрутныйЛист.ЗаказНаПроизводство КАК ЗаказНаПроизводство,
		|	МаршрутныйЛист.КодСтрокиПродукция КАК КодСтрокиПродукция,
		|	Этапы.Владелец КАК Спецификация,
		|	НЕОПРЕДЕЛЕНО КАК Этап,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяКалькуляции,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаПартий,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаПродукции,
		|	СУММА(МаршрутныйЛист.ДоляСтоимости
		|		* МаршрутныйЛист.Произведено) КАК Знаменатель,
		|	СУММА(МаршрутныйЛист.ДоляСтоимости
		|		* МаршрутныйЛист.Произведено) КАК КоличествоПродукции,
		|	0 КАК Количество,
		|	0 КАК Стоимость,
		|	0 КАК СтоимостьБезНДС,
		|	0 КАК СтоимостьРегл,
		|	0 КАК НДСРегл,
		|	0 КАК ПостояннаяРазница,
		|	0 КАК ВременнаяРазница,
		|	ЛОЖЬ КАК Первичное,
		|	ЛОЖЬ КАК СохранятьРегл,
		|	НЕОПРЕДЕЛЕНО КАК ХозяйственнаяОперация,
		|	НЕОПРЕДЕЛЕНО КАК КорРазделУчета,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаУчетаНоменклатуры,
		|	НЕОПРЕДЕЛЕНО КАК КорВидЗапасов,
		|	ДАТАВРЕМЯ(1, 1, 1, 0, 0, 0) КАК ДатаРегистратора,
		|	НЕОПРЕДЕЛЕНО КАК НалогообложениеПартии,
		|	НЕОПРЕДЕЛЕНО КАК НалогообложениеНДС,
		|	НЕОПРЕДЕЛЕНО КАК Назначение,
		|	НЕОПРЕДЕЛЕНО КАК ДокументИсточник,
		|	НЕОПРЕДЕЛЕНО КАК ДокументВыпуска,
		|	0 КАК НомерГруппыЗатрат,
		|	МаршрутныйЛист.Номенклатура КАК Продукция,
		|	МаршрутныйЛист.Характеристика КАК ХарактеристикаПродукции,
		|	НЕОПРЕДЕЛЕНО КАК Серия
		|ИЗ
		|	ПрошлыеРаспоряженияНаВыпускПродукции КАК МаршрутныйЛист
		|	ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ЭтапыПроизводства КАК Этапы
		|		ПО Этапы.Ссылка = МаршрутныйЛист.Этап
		|СГРУППИРОВАТЬ ПО
		|	МаршрутныйЛист.Организация,
		|	МаршрутныйЛист.ЗаказНаПроизводство,
		|	МаршрутныйЛист.КодСтрокиПродукция,
		|	Этапы.Владелец,
		|	МаршрутныйЛист.Номенклатура,
		|	МаршрутныйЛист.Характеристика
		|";
КонецФункции

//-- НЕ УТКА

Функция ТекстОтчетыПереработчика()
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстОтчетыПереработчика"" КАК ЗапросИсточник,
		|	40 КАК Приоритет,
		|	""Распределение"" КАК ТипЗаписи,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
		|	ДАТАВРЕМЯ(1, 1, 1, 0, 0, 0) КАК Период,
		|	НЕОПРЕДЕЛЕНО КАК Регистратор,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты) КАК РазделУчета,
		|	ДД.Организация,
		|	НЕОПРЕДЕЛЕНО КАК Подразделение,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаНоменклатуры,
		|	НЕОПРЕДЕЛЕНО КАК ДокументПоступления,
		|	НЕОПРЕДЕЛЕНО КАК ВидЗапасов,
		|	НЕОПРЕДЕЛЕНО КАК ГруппаПродукции,
		|	(ВЫБОР
		|		КОГДА ДД.ПоЗаказам ТОГДА Строки.ЗаказПереработчику
		|		ИНАЧЕ НЕОПРЕДЕЛЕНО КОНЕЦ) КАК ЗаказНаПроизводство,
		|	0 КАК КодСтрокиПродукция,
		|	ЗНАЧЕНИЕ(Справочник.РесурсныеСпецификации.ПустаяСсылка) КАК Спецификация,
		|	НЕОПРЕДЕЛЕНО КАК Этап,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяКалькуляции,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаПартий,
		|	Строки.АналитикаУчетаНоменклатуры КАК АналитикаУчетаПродукции,
		|	СУММА(ВЫБОР Строки.ДоляСтоимости КОГДА 0 ТОГДА 1
		|		ИНАЧЕ Строки.ДоляСтоимости КОНЕЦ) КАК Знаменатель,
		|	СУММА(Строки.Количество) КАК КоличествоПродукции,
		|	0 КАК Количество,
		|	0 КАК Стоимость,
		|	0 КАК СтоимостьБезНДС,
		|	0 КАК СтоимостьРегл,
		|	0 КАК НДСРегл,
		|	0 КАК ПостояннаяРазница,
		|	0 КАК ВременнаяРазница,
		|	ЛОЖЬ КАК Первичное,
		|	ЛОЖЬ КАК СохранятьРегл,
		|	НЕОПРЕДЕЛЕНО КАК ХозяйственнаяОперация,
		|	НЕОПРЕДЕЛЕНО КАК КорРазделУчета,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаУчетаНоменклатуры,
		|	НЕОПРЕДЕЛЕНО КАК КорВидЗапасов,
		|	ДАТАВРЕМЯ(1, 1, 1, 0, 0, 0) КАК ДатаРегистратора,
		|	НЕОПРЕДЕЛЕНО КАК НалогообложениеПартии,
		|	НЕОПРЕДЕЛЕНО КАК НалогообложениеНДС,
		|	ЕСТЬNULL(ПродукцияЗаказа.Назначение, ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка)) КАК Назначение,
		|	НЕОПРЕДЕЛЕНО КАК ДокументИсточник,
		|	(ВЫБОР
		|		КОГДА ДД.ПоЗаказам ТОГДА НЕОПРЕДЕЛЕНО
		|		ИНАЧЕ Строки.ДокументПоступления КОНЕЦ) КАК ДокументВыпуска,
		|	Строки.НомерГруппыЗатрат,
		|	Строки.Номенклатура КАК Продукция,
		|	Строки.Характеристика КАК ХарактеристикаПродукции,
		|	НЕОПРЕДЕЛЕНО КАК Серия
		|ИЗ
		|	Документ.ОтчетПереработчика КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ОтчетПереработчика.Продукция КАК Строки
		|		ПО Строки.Ссылка = ДД.Ссылка
		|	ЛЕВОЕ СОЕДИНЕНИЕ ПродукцияЗаказовПереработчику КАК ПродукцияЗаказа
		|		ПО ПродукцияЗаказа.ЗаказПереработчику = Строки.ЗаказПереработчику
		|		И ПродукцияЗаказа.КодСтроки = Строки.КодСтроки
		|		И ПродукцияЗаказа.Номенклатура = Строки.Номенклатура
		|		И ПродукцияЗаказа.Характеристика = Строки.Характеристика
		|ГДЕ
		|	ДД.Дата МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Проведен
		|СГРУППИРОВАТЬ ПО
		|	ДД.Организация,
		|	Строки.АналитикаУчетаНоменклатуры,
		|	(ВЫБОР
		|		КОГДА ДД.ПоЗаказам ТОГДА Строки.ЗаказПереработчику
		|		ИНАЧЕ НЕОПРЕДЕЛЕНО КОНЕЦ),
		|	Строки.Номенклатура,
		|	Строки.Характеристика,
		|	(ВЫБОР
		|		КОГДА ДД.ПоЗаказам ТОГДА НЕОПРЕДЕЛЕНО
		|		ИНАЧЕ Строки.ДокументПоступления КОНЕЦ),
		|	Строки.НомерГруппыЗатрат,
		|	ЕСТЬNULL(ПродукцияЗаказа.Назначение, ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка))
		|";
КонецФункции

Функция ТекстСписанияЗатратНаВыпуск()
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстСписанияЗатратНаВыпуск"" КАК ЗапросИсточник,
		|	40 КАК Приоритет,
		|	""ЗатратыБезЗаказа"" КАК ТипЗаписи,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
		|	ДД.Дата КАК Период,
		|	ДД.Ссылка КАК Регистратор,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты) КАК РазделУчета,
		|	ДД.Организация,
		|	НЕОПРЕДЕЛЕНО КАК Подразделение,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаНоменклатуры,
		|	НЕОПРЕДЕЛЕНО КАК ДокументПоступления,
		|	НЕОПРЕДЕЛЕНО КАК ВидЗапасов,
		|	НЕОПРЕДЕЛЕНО КАК ГруппаПродукции,
		|	ДД.Спецификация КАК ЗаказНаПроизводство,
		|	Выходы.КодСтроки КАК КодСтрокиПродукция,
		|	ДД.Спецификация КАК Спецификация,
		|	ЗНАЧЕНИЕ(Справочник.ЭтапыПроизводства.ПустаяСсылка) КАК Этап,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяКалькуляции,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаПартий,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаПродукции,
		|	МАКСИМУМ(ЕСТЬNULL(Распределение.ДоляСтоимости, 1)) КАК Знаменатель,
		|	СУММА(Выходы.Количество) КАК КоличествоПродукции,
		|	0 КАК Количество,
		|	0 КАК Стоимость,
		|	0 КАК СтоимостьБезНДС,
		|	0 КАК СтоимостьРегл,
		|	0 КАК НДСРегл,
		|	0 КАК ПостояннаяРазница,
		|	0 КАК ВременнаяРазница,
		|	ЛОЖЬ КАК Первичное,
		|	ЛОЖЬ КАК СохранятьРегл,
		|	НЕОПРЕДЕЛЕНО КАК ХозяйственнаяОперация,
		|	НЕОПРЕДЕЛЕНО КАК КорРазделУчета,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаУчетаНоменклатуры,
		|	НЕОПРЕДЕЛЕНО КАК КорВидЗапасов,
		|	ДАТАВРЕМЯ(1, 1, 1, 0, 0, 0) КАК ДатаРегистратора,
		|	НЕОПРЕДЕЛЕНО КАК НалогообложениеПартии,
		|	НЕОПРЕДЕЛЕНО КАК НалогообложениеНДС,
		|	НЕОПРЕДЕЛЕНО КАК Назначение,
		|	Выходы.Распоряжение КАК ДокументИсточник,
		|	Выходы.Распоряжение КАК ДокументВыпуска,
		|	0 КАК НомерГруппыЗатрат,
		|	ДД.Номенклатура КАК Продукция,
		|	ДД.Характеристика КАК ХарактеристикаПродукции,
		|	ЗНАЧЕНИЕ(Справочник.СерииНоменклатуры.ПустаяСсылка) КАК Серия
		|ИЗ
		|	Документ.СписаниеЗатратНаВыпуск КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.СписаниеЗатратНаВыпуск.ВыходныеИзделия КАК Выходы
		|		ПО Выходы.Ссылка = ДД.Ссылка
		|	ЛЕВОЕ СОЕДИНЕНИЕ РаспределениеНаВыпускиБезЗаказов КАК Распределение
		|		ПО Распределение.Регистратор = ДД.Ссылка
		|		И Распределение.ДокументВыпуска = Выходы.Распоряжение
		|		И Распределение.КодСтроки = Выходы.КодСтроки
		|ГДЕ
		|	ДД.Дата МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Проведен
		|СГРУППИРОВАТЬ ПО
		|	ДД.Дата,
		|	ДД.Ссылка,
		|	ДД.Организация,
		|	ДД.Спецификация,
		|	Выходы.Распоряжение,
		|	Выходы.КодСтроки,
		|	ДД.Номенклатура,
		|	ДД.Характеристика
		|";
КонецФункции

Функция ТекстСписанияЗатратНаВыпускПоБазе() // использует РаспределенияПоБазе
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстСписанияЗатратНаВыпускПоБазе"" КАК ЗапросИсточник,
		|	40 КАК Приоритет,
		|	""ЗатратыБезЗаказа"" КАК ТипЗаписи,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
		|	Распределение.Период,
		|	Распределение.Регистратор,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты) КАК РазделУчета,
		|	ДД.Организация,
		|	НЕОПРЕДЕЛЕНО КАК Подразделение,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаНоменклатуры,
		|	НЕОПРЕДЕЛЕНО КАК ДокументПоступления,
		|	НЕОПРЕДЕЛЕНО КАК ВидЗапасов,
		|	НЕОПРЕДЕЛЕНО КАК ГруппаПродукции,
		|	ДД.Спецификация КАК ЗаказНаПроизводство,
		|	Выходы.КодСтроки КАК КодСтрокиПродукция,
		|	ДД.Спецификация КАК Спецификация,
		|	ЗНАЧЕНИЕ(Справочник.ЭтапыПроизводства.ПустаяСсылка) КАК Этап,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяКалькуляции,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаПартий,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаПродукции,
		|	СУММА(ВЫБОР Выходы.ДоляСтоимости КОГДА 0 ТОГДА 1
		|		ИНАЧЕ Выходы.ДоляСтоимости КОНЕЦ) КАК Знаменатель,
		|	СУММА(Выходы.Количество) КАК КоличествоПродукции,
		|	0 КАК Количество,
		|	0 КАК Стоимость,
		|	0 КАК СтоимостьБезНДС,
		|	0 КАК СтоимостьРегл,
		|	0 КАК НДСРегл,
		|	0 КАК ПостояннаяРазница,
		|	0 КАК ВременнаяРазница,
		|	ЛОЖЬ КАК Первичное,
		|	ЛОЖЬ КАК СохранятьРегл,
		|	НЕОПРЕДЕЛЕНО КАК ХозяйственнаяОперация,
		|	НЕОПРЕДЕЛЕНО КАК КорРазделУчета,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаУчетаНоменклатуры,
		|	НЕОПРЕДЕЛЕНО КАК КорВидЗапасов,
		|	ДАТАВРЕМЯ(1, 1, 1, 0, 0, 0) КАК ДатаРегистратора,
		|	НЕОПРЕДЕЛЕНО КАК НалогообложениеПартии,
		|	НЕОПРЕДЕЛЕНО КАК НалогообложениеНДС,
		|	НЕОПРЕДЕЛЕНО КАК Назначение,
		|	Выходы.Распоряжение КАК ДокументИсточник,
		|	Выходы.Распоряжение КАК ДокументВыпуска,
		|	0 КАК НомерГруппыЗатрат,
		|	ДД.Номенклатура КАК Продукция,
		|	ДД.Характеристика КАК ХарактеристикаПродукции,
		|	ЗНАЧЕНИЕ(Справочник.СерииНоменклатуры.ПустаяСсылка) КАК Серия
		|ИЗ
		|	Документ.СписаниеЗатратНаВыпуск КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ РаспределенияПоБазе КАК Распределение
		|		ПО Распределение.СписаниеНаВыпуск = ДД.Ссылка
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.СписаниеЗатратНаВыпуск.ВыходныеИзделия КАК Выходы
		|		ПО Выходы.Ссылка = ДД.Ссылка
		|ГДЕ
		|	ДД.Дата МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Проведен
		|СГРУППИРОВАТЬ ПО
		|	Распределение.Период,
		|	Распределение.Регистратор,
		|	ДД.Организация,
		|	ДД.Спецификация,
		|	Выходы.Распоряжение,
		|	Выходы.КодСтроки,
		|	ДД.Номенклатура,
		|	ДД.Характеристика
		|";
КонецФункции

//++ НЕ УТКА

Функция ТекстВыпускиПоЗаказам()
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстВыпускиПоЗаказам"" КАК ЗапросИсточник,
		|	90 КАК Приоритет,
		|	""Выпуск"" КАК ТипЗаписи,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) КАК ВидДвижения,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	(ВЫБОР
		|		КОГДА ЗаказДавальца.Ссылка ЕСТЬ NULL ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты)
		|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КОНЕЦ) КАК РазделУчета,
		|	МаршрутныйЛист.Организация,
		|	НЕОПРЕДЕЛЕНО КАК Подразделение,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаНоменклатуры,
		|	НЕОПРЕДЕЛЕНО КАК ДокументПоступления,
		|	НЕОПРЕДЕЛЕНО КАК ВидЗапасов,
		|	НЕОПРЕДЕЛЕНО КАК ГруппаПродукции,
		|	МаршрутныйЛист.Распоряжение КАК ЗаказНаПроизводство,
		|	МаршрутныйЛист.КодСтроки КАК КодСтрокиПродукция,
		|	Этапы.Владелец КАК Спецификация,
		|	НЕОПРЕДЕЛЕНО КАК Этап,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяКалькуляции,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаПартий,
		|	ДД.АналитикаУчетаНоменклатуры КАК АналитикаУчетаПродукции,
		|	СУММА(ДД.Заказано) КАК Знаменатель,
		|	СУММА(ДД.Заказано) КАК КоличествоПродукции,
		|	0 КАК Количество,
		|	0 КАК Стоимость,
		|	0 КАК СтоимостьБезНДС,
		|	0 КАК СтоимостьРегл,
		|	0 КАК НДСРегл,
		|	0 КАК ПостояннаяРазница,
		|	0 КАК ВременнаяРазница,
		|	ЛОЖЬ КАК Первичное,
		|	ЛОЖЬ КАК СохранятьРегл,
		|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукции) КАК ХозяйственнаяОперация,
		|	(ВЫБОР
		|		КОГДА Аналитика.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Склад)
		|		 И Аналитика.СкладскаяТерритория.ЦеховаяКладовая
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты) 
		|		КОГДА Аналитика.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Склад)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыНаСкладах)
		|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты) КОНЕЦ) КАК КорРазделУчета,
		|	ДД.АналитикаУчетаНоменклатуры КАК КорАналитикаУчетаНоменклатуры,
		|	(ВЫБОР
		|		КОГДА ДД.ВидЗапасов.ТипЗапасов = ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.Услуга)
		|			ТОГДА ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка)
		|		ИНАЧЕ ДД.ВидЗапасов
		|	КОНЕЦ) КАК КорВидЗапасов,
		|	ДАТАВРЕМЯ(1, 1, 1, 0, 0, 0) КАК ДатаРегистратора,
		|	НЕОПРЕДЕЛЕНО КАК НалогообложениеПартии,
		|	НЕОПРЕДЕЛЕНО КАК НалогообложениеНДС,
		|	ДД.АналитикаУчетаНоменклатуры.Назначение КАК Назначение,
		|	НЕОПРЕДЕЛЕНО КАК ДокументИсточник,
		|	НЕОПРЕДЕЛЕНО КАК ДокументВыпуска,
		|	0 КАК НомерГруппыЗатрат,
		|	ДД.Номенклатура КАК Продукция,
		|	ДД.Характеристика КАК ХарактеристикаПродукции,
		|	НЕОПРЕДЕЛЕНО КАК Серия
		|ИЗ
		|	РегистрНакопления.РаспоряженияНаВыпускПродукции КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.МаршрутныйЛистПроизводства КАК МаршрутныйЛист
		|		ПО МаршрутныйЛист.Ссылка = ДД.Распоряжение
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК Аналитика
		|		ПО Аналитика.Ссылка = ДД.АналитикаУчетаНоменклатуры
		|	ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ЭтапыПроизводства КАК Этапы
		|		ПО Этапы.Ссылка = МаршрутныйЛист.Этап
		|	ЛЕВОЕ СОЕДИНЕНИЕ Справочник.Назначения КАК Назначения
		|		ПО Назначения.Ссылка = ДД.АналитикаУчетаНоменклатуры.Назначение
		|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.ЗаказДавальца КАК ЗаказДавальца
		|		ПО ЗаказДавальца.Ссылка = Назначения.Заказ
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И МаршрутныйЛист.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		|	И ДД.ТипСтоимости = ЗНАЧЕНИЕ(Перечисление.ТипыСтоимостиВыходныхИзделий.Рассчитывается)
		|СГРУППИРОВАТЬ ПО
		|	ДД.Период,
		|	ДД.Регистратор,
		|	(ВЫБОР
		|		КОГДА ЗаказДавальца.Ссылка ЕСТЬ NULL ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты)
		|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КОНЕЦ),
		|	МаршрутныйЛист.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	(ВЫБОР
		|		КОГДА ДД.ВидЗапасов.ТипЗапасов = ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.Услуга)
		|			ТОГДА ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка)
		|		ИНАЧЕ ДД.ВидЗапасов
		|	КОНЕЦ),
		|	МаршрутныйЛист.Распоряжение,
		|	МаршрутныйЛист.КодСтроки,
		|	Этапы.Владелец,
		|	(ВЫБОР
		|		КОГДА Аналитика.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Склад)
		|		 И Аналитика.СкладскаяТерритория.ЦеховаяКладовая
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты)
		|		КОГДА Аналитика.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Склад)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыНаСкладах)
		|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты) КОНЕЦ),
		|	ДД.Номенклатура,
		|	ДД.Характеристика
		|";
КонецФункции

Функция ТекстДавальческиеПолуфабрикаты() // использует ДолиСтоимости
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстДавальческиеПолуфабрикаты"" КАК ЗапросИсточник,
		|	10 КАК Приоритет,
		|	""ПолуфабрикатДавальца"" КАК ТипЗаписи,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КАК РазделУчета,
		|	ДД.Организация,
		|	Аналитика.МестоХранения КАК Подразделение,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаНоменклатуры,
		|	ДД.ДокументПоступления,
		|	НЕОПРЕДЕЛЕНО КАК ВидЗапасов,
		|	НЕОПРЕДЕЛЕНО КАК ГруппаПродукции,
		|	ДД.ЗаказНаПроизводство,
		|	ДД.КодСтрокиПродукция,
		|	Этапы.Владелец КАК Спецификация,
		|	ДД.Этап,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяКалькуляции,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаПартий,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаПродукции,
		|	СУММА(ДД.Количество) КАК Знаменатель,
		|	МАКСИМУМ(
		|		ВЫБОР
		|			КОГДА НЕ Доли.ДоляСтоимости ЕСТЬ NULL ТОГДА Доли.ДоляСтоимости
		|			КОГДА НЕ ВыпускБезЗаказа.Количество ЕСТЬ NULL ТОГДА ВыпускБезЗаказа.Количество
		|			ИНАЧЕ 1 КОНЕЦ) КАК КоличествоПродукции,
		|	0 КАК Количество,
		|	0 КАК Стоимость,
		|	0 КАК СтоимостьБезНДС,
		|	0 КАК СтоимостьРегл,
		|	0 КАК НДСРегл,
		|	0 КАК ПостояннаяРазница,
		|	0 КАК ВременнаяРазница,
		|	ЛОЖЬ КАК Первичное,
		|	ЛОЖЬ КАК СохранятьРегл,
		|	НЕОПРЕДЕЛЕНО КАК ХозяйственнаяОперация,
		|	НЕОПРЕДЕЛЕНО КАК КорРазделУчета,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаУчетаНоменклатуры,
		|	НЕОПРЕДЕЛЕНО КАК КорВидЗапасов,
		|	ДАТАВРЕМЯ(1, 1, 1, 0, 0, 0) КАК ДатаРегистратора,
		|	НЕОПРЕДЕЛЕНО КАК НалогообложениеПартии,
		|	НЕОПРЕДЕЛЕНО КАК НалогообложениеНДС,
		|	ДД.АналитикаУчетаНоменклатуры.Назначение КАК Назначение,
		|	НЕОПРЕДЕЛЕНО КАК ДокументИсточник,
		|	ЕСТЬNULL(ВыпускБезЗаказа.Ссылка, НЕОПРЕДЕЛЕНО) КАК ДокументВыпуска,
		|	ДД.НомерГруппыЗатрат,
		|	Аналитика.Номенклатура КАК Продукция,
		|	Аналитика.Характеристика КАК ХарактеристикаПродукции,
		|	НЕОПРЕДЕЛЕНО КАК Серия
		|ИЗ
		|	РегистрНакопления.ПартииПроизводственныхЗатрат КАК ДД
		|	ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ЭтапыПроизводства КАК Этапы
		|		ПО Этапы.Ссылка = ДД.Этап
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК Аналитика
		|		ПО Аналитика.Ссылка = ДД.АналитикаУчетаНоменклатуры
		|	ЛЕВОЕ СОЕДИНЕНИЕ ДолиСтоимости КАК Доли
		|		ПО Доли.ЗаказНаПроизводство = ДД.ЗаказНаПроизводство
		|		И Доли.КодСтрокиПродукция = ДД.КодСтрокиПродукция
		|		И Доли.Спецификация = Этапы.Владелец
		|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.ВыпускПродукции.Товары КАК ВыпускБезЗаказа
		|		ПО ВыпускБезЗаказа.Ссылка = ДД.ЗаказНаПроизводство
		|		И ВыпускБезЗаказа.КодСтроки = ДД.КодСтрокиПродукция
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		|	И ДД.СтатьяКалькуляции <> ЗНАЧЕНИЕ(Справочник.СтатьиКалькуляции.ПустаяСсылка)
		|	И ДД.ВидЗапасов.ТипЗапасов = ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.ПолуфабрикатДавальца)
		|	И ДД.ДокументПоступления ССЫЛКА Документ.ВыпускПродукции
		|СГРУППИРОВАТЬ ПО
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	Аналитика.МестоХранения,
		|	ДД.ДокументПоступления,
		|	ДД.ЗаказНаПроизводство,
		|	ДД.КодСтрокиПродукция,
		|	Этапы.Владелец,
		|	ДД.Этап,
		|	ДД.АналитикаУчетаНоменклатуры.Назначение,
		|	Аналитика.Номенклатура,
		|	Аналитика.Характеристика,
		|	ЕСТЬNULL(ВыпускБезЗаказа.Ссылка, НЕОПРЕДЕЛЕНО),
		|	ДД.НомерГруппыЗатрат
		|";
КонецФункции

Функция ТекстДавальческаяПродукция()
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстДавальческаяПродукция"" КАК ЗапросИсточник,
		|	45 КАК Приоритет,
		|	""ПродукцияДавальца"" КАК ТипЗаписи,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
		|	ДАТАВРЕМЯ(1, 1, 1, 0, 0, 0) КАК Период,
		|	НЕОПРЕДЕЛЕНО КАК Регистратор,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КАК РазделУчета,
		|	ДД.Организация,
		|	НЕОПРЕДЕЛЕНО КАК Подразделение,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаНоменклатуры,
		|	НЕОПРЕДЕЛЕНО КАК ДокументПоступления,
		|	НЕОПРЕДЕЛЕНО КАК ВидЗапасов,
		|	НЕОПРЕДЕЛЕНО КАК ГруппаПродукции,
		|	НЕОПРЕДЕЛЕНО КАК ЗаказНаПроизводство,
		|	0 КАК КодСтрокиПродукция,
		|	НЕОПРЕДЕЛЕНО КАК Спецификация,
		|	НЕОПРЕДЕЛЕНО КАК Этап,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяКалькуляции,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаПартий,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаПродукции,
		|	СУММА(Строки.Количество) КАК Знаменатель,
		|	СУММА(Строки.Количество) КАК КоличествоПродукции,
		|	0 КАК Количество,
		|	0 КАК Стоимость,
		|	0 КАК СтоимостьБезНДС,
		|	0 КАК СтоимостьРегл,
		|	0 КАК НДСРегл,
		|	0 КАК ПостояннаяРазница,
		|	0 КАК ВременнаяРазница,
		|	ЛОЖЬ КАК Первичное,
		|	ЛОЖЬ КАК СохранятьРегл,
		|	НЕОПРЕДЕЛЕНО КАК ХозяйственнаяОперация,
		|	НЕОПРЕДЕЛЕНО КАК КорРазделУчета,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаУчетаНоменклатуры,
		|	НЕОПРЕДЕЛЕНО КАК КорВидЗапасов,
		|	ДАТАВРЕМЯ(1, 1, 1, 0, 0, 0) КАК ДатаРегистратора,
		|	НЕОПРЕДЕЛЕНО КАК НалогообложениеПартии,
		|	НЕОПРЕДЕЛЕНО КАК НалогообложениеНДС,
		|	Строки.Назначение КАК Назначение,
		|	НЕОПРЕДЕЛЕНО КАК ДокументИсточник,
		|	НЕОПРЕДЕЛЕНО КАК ДокументВыпуска,
		|	0 КАК НомерГруппыЗатрат,
		|	Строки.Номенклатура КАК Продукция,
		|	Строки.Характеристика КАК ХарактеристикаПродукции,
		|	НЕОПРЕДЕЛЕНО КАК Серия
		|ИЗ
		|	Документ.ВыпускПродукции КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ВыпускПродукции.Товары КАК Строки
		|		ПО Строки.Ссылка = ДД.Ссылка
		|ГДЕ
		|	ДД.Дата МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Проведен
		|	И Строки.ВидЗапасов.ТипЗапасов = ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.ПолуфабрикатДавальца)
		|СГРУППИРОВАТЬ ПО
		|	ДД.Организация,
		|	Строки.Назначение,
		|	Строки.Номенклатура,
		|	Строки.Характеристика
		|";
КонецФункции

Функция ТекстОтчетыДавальцам()
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстОтчетыДавальцам"" КАК ЗапросИсточник,
		|	90 КАК Приоритет,
		|	""ОтчетДавальцу"" КАК ТипЗаписи,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) КАК ВидДвижения,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты) КАК РазделУчета,
		|	ДД.Организация,
		|	НЕОПРЕДЕЛЕНО КАК Подразделение,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаНоменклатуры,
		|	НЕОПРЕДЕЛЕНО КАК ДокументПоступления,
		|	НЕОПРЕДЕЛЕНО КАК ВидЗапасов,
		|	НЕОПРЕДЕЛЕНО КАК ГруппаПродукции,
		|	НЕОПРЕДЕЛЕНО КАК ЗаказНаПроизводство,
		|	0 КАК КодСтрокиПродукция,
		|	НЕОПРЕДЕЛЕНО КАК Спецификация,
		|	НЕОПРЕДЕЛЕНО КАК Этап,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяКалькуляции,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаПартий,
		|	ДД.АналитикаУчетаНоменклатуры КАК АналитикаУчетаПродукции,
		|	СУММА(ДД.Количество) КАК Знаменатель,
		|	СУММА(ДД.Количество) КАК КоличествоПродукции,
		|	0 КАК Количество,
		|	0 КАК Стоимость,
		|	0 КАК СтоимостьБезНДС,
		|	0 КАК СтоимостьРегл,
		|	0 КАК НДСРегл,
		|	0 КАК ПостояннаяРазница,
		|	0 КАК ВременнаяРазница,
		|	ЛОЖЬ КАК Первичное,
		|	ЛОЖЬ КАК СохранятьРегл,
		|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукции) КАК ХозяйственнаяОперация,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты) КАК КорРазделУчета,
		|	ДД.АналитикаУчетаНоменклатуры КАК КорАналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов КАК КорВидЗапасов,
		|	ДАТАВРЕМЯ(1, 1, 1, 0, 0, 0) КАК ДатаРегистратора,
		|	НЕОПРЕДЕЛЕНО КАК НалогообложениеПартии,
		|	НЕОПРЕДЕЛЕНО КАК НалогообложениеНДС,
		|	ДД.АналитикаУчетаНоменклатуры.Назначение КАК Назначение,
		|	НЕОПРЕДЕЛЕНО КАК ДокументИсточник,
		|	НЕОПРЕДЕЛЕНО КАК ДокументВыпуска,
		|	0 КАК НомерГруппыЗатрат,
		|	Аналитика.Номенклатура КАК Продукция,
		|	Аналитика.Характеристика КАК ХарактеристикаПродукции,
		|	НЕОПРЕДЕЛЕНО КАК Серия
		|ИЗ
		|	РегистрНакопления.ВыпускПродукции КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК Аналитика
		|		ПО Аналитика.Ссылка = ДД.АналитикаУчетаНоменклатуры
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И ДД.Регистратор ССЫЛКА Документ.ОтчетДавальцу
		|СГРУППИРОВАТЬ ПО
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов,
		|	ДД.АналитикаУчетаНоменклатуры.Назначение,
		|	Аналитика.Номенклатура,
		|	Аналитика.Характеристика
		|";
КонецФункции
//-- НЕ УТКА

Функция ТекстВыпускиБезЗаказов()
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстВыпускиБезЗаказов"" КАК ЗапросИсточник,
		|	90 КАК Приоритет,
		|	""ВыпускБезЗаказа"" КАК ТипЗаписи,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) КАК ВидДвижения,
		|	ДД.Период,
		|	ДД.Регистратор,
		//++ НЕ УТКА
		|	(ВЫБОР
		|		КОГДА ЗаказДавальца.Ссылка ЕСТЬ NULL ТОГДА
		//-- НЕ УТКА
		|		 ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты)
		//++ НЕ УТКА
		|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КОНЕЦ)
		//-- НЕ УТКА
		|		  КАК РазделУчета,
		|	ДД.Организация,
		|	НЕОПРЕДЕЛЕНО КАК Подразделение,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаНоменклатуры,
		|	НЕОПРЕДЕЛЕНО КАК ДокументПоступления,
		|	НЕОПРЕДЕЛЕНО КАК ВидЗапасов,
		|	НЕОПРЕДЕЛЕНО КАК ГруппаПродукции,
		|	НЕОПРЕДЕЛЕНО КАК ЗаказНаПроизводство,
		|	ДД.КодСтроки КАК КодСтрокиПродукция,
		|	НЕОПРЕДЕЛЕНО КАК Спецификация,
		|	НЕОПРЕДЕЛЕНО КАК Этап,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяКалькуляции,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаПартий,
		|	ДД.АналитикаУчетаПродукции,
		|	СУММА(ДД.Количество) КАК Знаменатель,
		|	СУММА(ДД.Количество) КАК КоличествоПродукции,
		|	0 КАК Количество,
		|	0 КАК Стоимость,
		|	0 КАК СтоимостьБезНДС,
		|	0 КАК СтоимостьРегл,
		|	0 КАК НДСРегл,
		|	0 КАК ПостояннаяРазница,
		|	0 КАК ВременнаяРазница,
		|	ЛОЖЬ КАК Первичное,
		|	ЛОЖЬ КАК СохранятьРегл,
		|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукции) КАК ХозяйственнаяОперация,
		|	ДД.КорРазделУчета,
		|	ДД.АналитикаУчетаПродукции КАК КорАналитикаУчетаНоменклатуры,
		|	(ВЫБОР 
		|		КОГДА ДД.КорВидЗапасов.ТипЗапасов = ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.Услуга)
		|			ТОГДА НЕОПРЕДЕЛЕНО
		|		ИНАЧЕ ДД.КорВидЗапасов КОНЕЦ) КАК КорВидЗапасов,
		|	ДАТАВРЕМЯ(1, 1, 1, 0, 0, 0) КАК ДатаРегистратора,
		|	НЕОПРЕДЕЛЕНО КАК НалогообложениеПартии,
		|	НЕОПРЕДЕЛЕНО КАК НалогообложениеНДС,
		|	ДД.Назначение,
		|	НЕОПРЕДЕЛЕНО КАК ДокументИсточник,
		|	ДД.Распоряжение КАК ДокументВыпуска,
		|	0 КАК НомерГруппыЗатрат,
		|	ДД.Номенклатура КАК Продукция,
		|	ДД.Характеристика КАК ХарактеристикаПродукции,
		|	НЕОПРЕДЕЛЕНО КАК Серия
		|ИЗ
		|	РегистрНакопления.РаспоряженияНаСписаниеПоНормативам КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ВыпускПродукции.Товары КАК Выпуск
		|		ПО Выпуск.Ссылка = ДД.Регистратор
		|		И Выпуск.КодСтроки = ДД.КодСтроки
		//++ НЕ УТКА
		|	ЛЕВОЕ СОЕДИНЕНИЕ Справочник.Назначения КАК Назначения
		|		ПО Назначения.Ссылка = ДД.Назначение
		|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.ЗаказДавальца КАК ЗаказДавальца
		|		ПО ЗаказДавальца.Ссылка = Назначения.Заказ
		//-- НЕ УТКА
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|	И Выпуск.ТипСтоимости <> ЗНАЧЕНИЕ(Перечисление.ТипыСтоимостиВыходныхИзделий.Фиксированная)
		|СГРУППИРОВАТЬ ПО
		|	ДД.Период,
		|	ДД.Регистратор,
		//++ НЕ УТКА
		|	(ВЫБОР
		|		КОГДА ЗаказДавальца.Ссылка ЕСТЬ NULL ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты)
		|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КОНЕЦ),
		//-- НЕ УТКА
		|	ДД.Организация,
		|	ДД.Распоряжение,
		|	ДД.КодСтроки,
		|	ДД.АналитикаУчетаПродукции,
		|	ДД.Номенклатура,
		|	ДД.Характеристика,
		|	(ВЫБОР 
		|		КОГДА ДД.КорВидЗапасов.ТипЗапасов = ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.Услуга)
		|			ТОГДА НЕОПРЕДЕЛЕНО
		|		ИНАЧЕ ДД.КорВидЗапасов КОНЕЦ),
		|	ДД.КорРазделУчета,
		|	ДД.Назначение,
		|	ДД.Распоряжение
		|";
КонецФункции

Функция ТекстВыпускиБезЗаказовБезСписанияЗатратНаВыпуск()
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстВыпускиБезЗаказовБезСписанияЗатратНаВыпуск"" КАК ЗапросИсточник,
		|	90 КАК Приоритет,
		|	""ВыпускБезЗаказа"" КАК ТипЗаписи,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) КАК ВидДвижения,
		|	ДД.Дата КАК Период,
		|	ДД.Ссылка КАК Регистратор,
		//++ НЕ УТКА
		|	(ВЫБОР
		|		КОГДА ЗаказДавальца.Ссылка ЕСТЬ NULL ТОГДА
		//-- НЕ УТКА
		|		 ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты)
		//++ НЕ УТКА
		|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КОНЕЦ)
		//-- НЕ УТКА
		|		  КАК РазделУчета,
		|	ДД.Организация,
		|	НЕОПРЕДЕЛЕНО КАК Подразделение,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаНоменклатуры,
		|	НЕОПРЕДЕЛЕНО КАК ДокументПоступления,
		|	НЕОПРЕДЕЛЕНО КАК ВидЗапасов,
		|	НЕОПРЕДЕЛЕНО КАК ГруппаПродукции,
		|	НЕОПРЕДЕЛЕНО КАК ЗаказНаПроизводство,
		|	Т.КодСтроки КАК КодСтрокиПродукция,
		|	НЕОПРЕДЕЛЕНО КАК Спецификация,
		|	НЕОПРЕДЕЛЕНО КАК Этап,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяКалькуляции,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаПартий,
		|	Т.АналитикаУчетаНоменклатуры КАК АналитикаУчетаПродукции,
		|	СУММА(Т.Количество) КАК Знаменатель,
		|	СУММА(Т.Количество) КАК КоличествоПродукции,
		|	0 КАК Количество,
		|	0 КАК Стоимость,
		|	0 КАК СтоимостьБезНДС,
		|	0 КАК СтоимостьРегл,
		|	0 КАК НДСРегл,
		|	0 КАК ПостояннаяРазница,
		|	0 КАК ВременнаяРазница,
		|	ЛОЖЬ КАК Первичное,
		|	ЛОЖЬ КАК СохранятьРегл,
		|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукции) КАК ХозяйственнаяОперация,
		|	(ВЫБОР ДД.НаправлениеВыпуска
		|		КОГДА ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукцииВПодразделение)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты)
		|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыНаСкладах) КОНЕЦ) КАК КорРазделУчета,
		|	Т.АналитикаУчетаНоменклатуры КАК КорАналитикаУчетаНоменклатуры,
		|	Т.ВидЗапасов КАК КорВидЗапасов,
		|	ДАТАВРЕМЯ(1, 1, 1, 0, 0, 0) КАК ДатаРегистратора,
		|	НЕОПРЕДЕЛЕНО КАК НалогообложениеПартии,
		|	НЕОПРЕДЕЛЕНО КАК НалогообложениеНДС,
		|	Т.Назначение,
		|	НЕОПРЕДЕЛЕНО КАК ДокументИсточник,
		|	ДД.Ссылка КАК ДокументВыпуска,
		|	0 КАК НомерГруппыЗатрат,
		|	Т.Номенклатура КАК Продукция,
		|	Т.Характеристика КАК ХарактеристикаПродукции,
		|	НЕОПРЕДЕЛЕНО КАК Серия
		|ИЗ
		|	Документ.ВыпускПродукции КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ВыпускПродукции.Товары КАК Т
		|		ПО Т.Ссылка = ДД.Ссылка
		//++ НЕ УТКА
		|	ЛЕВОЕ СОЕДИНЕНИЕ Справочник.Назначения КАК Назначения
		|		ПО Назначения.Ссылка = Т.Назначение
		|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.ЗаказДавальца КАК ЗаказДавальца
		|		ПО ЗаказДавальца.Ссылка = Назначения.Заказ
		//-- НЕ УТКА
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.СтруктураПредприятия КАК СП
		|		ПО СП.Ссылка = ДД.Подразделение
		|		И НЕ СП.ИспользуетсяСписаниеЗатратНаВыпуск
		|ГДЕ
		|	ДД.Дата МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Проведен
		|	И НЕ ДД.ВыпускПоРаспоряжениям
		|	И НЕ Т.СписатьНаРасходы
		|СГРУППИРОВАТЬ ПО
		|	ДД.Дата,
		|	ДД.Ссылка,
		//++ НЕ УТКА
		|	(ВЫБОР
		|		КОГДА ЗаказДавальца.Ссылка ЕСТЬ NULL ТОГДА
		|		 ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты)
		|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КОНЕЦ),
		//-- НЕ УТКА
		|	ДД.Организация,
		|	Т.КодСтроки,
		|	Т.АналитикаУчетаНоменклатуры,
		|	(ВЫБОР ДД.НаправлениеВыпуска
		|		КОГДА ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукцииВПодразделение)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты)
		|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыНаСкладах) КОНЕЦ),
		|	Т.Номенклатура,
		|	Т.Характеристика,
		|	Т.ВидЗапасов,
		|	Т.Назначение
		|";
КонецФункции

Функция ТекстВыпускиБезЗаказовБезСписанияЗатратНаВыпускСписаниеНаРасходы()
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстВыпускиБезЗаказовБезСписанияЗатратНаВыпускСписаниеНаРасходы"" КАК ЗапросИсточник,
		|	90 КАК Приоритет,
		|	""ВыпускБезЗаказа"" КАК ТипЗаписи,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) КАК ВидДвижения,
		|	ДД.Дата КАК Период,
		|	ДД.Ссылка КАК Регистратор,
		//++ НЕ УТКА
		|	(ВЫБОР
		|		КОГДА ЗаказДавальца.Ссылка ЕСТЬ NULL ТОГДА
		//-- НЕ УТКА
		|		 ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты)
		//++ НЕ УТКА
		|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КОНЕЦ)
		//-- НЕ УТКА
		|		  КАК РазделУчета,
		|	ДД.Организация,
		|	НЕОПРЕДЕЛЕНО КАК Подразделение,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаНоменклатуры,
		|	НЕОПРЕДЕЛЕНО КАК ДокументПоступления,
		|	НЕОПРЕДЕЛЕНО КАК ВидЗапасов,
		|	НЕОПРЕДЕЛЕНО КАК ГруппаПродукции,
		|	НЕОПРЕДЕЛЕНО КАК ЗаказНаПроизводство,
		|	Т.КодСтроки КАК КодСтрокиПродукция,
		|	НЕОПРЕДЕЛЕНО КАК Спецификация,
		|	НЕОПРЕДЕЛЕНО КАК Этап,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяКалькуляции,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаПартий,
		|	АналитикаВПодразделении.КлючАналитики КАК АналитикаУчетаПродукции,
		|	СУММА(Т.Количество) КАК Знаменатель,
		|	СУММА(Т.Количество) КАК КоличествоПродукции,
		|	0 КАК Количество,
		|	0 КАК Стоимость,
		|	0 КАК СтоимостьБезНДС,
		|	0 КАК СтоимостьРегл,
		|	0 КАК НДСРегл,
		|	0 КАК ПостояннаяРазница,
		|	0 КАК ВременнаяРазница,
		|	ЛОЖЬ КАК Первичное,
		|	ЛОЖЬ КАК СохранятьРегл,
		|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукции) КАК ХозяйственнаяОперация,
		|	(ВЫБОР ДД.НаправлениеВыпуска
		|		КОГДА ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукцииВПодразделение)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты)
		|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыНаСкладах) КОНЕЦ) КАК КорРазделУчета,
		|	АналитикаВПодразделении.КлючАналитики КАК КорАналитикаУчетаНоменклатуры,
		|	Т.ВидЗапасов КАК КорВидЗапасов,
		|	ДАТАВРЕМЯ(1, 1, 1, 0, 0, 0) КАК ДатаРегистратора,
		|	НЕОПРЕДЕЛЕНО КАК НалогообложениеПартии,
		|	НЕОПРЕДЕЛЕНО КАК НалогообложениеНДС,
		|	Т.Назначение,
		|	НЕОПРЕДЕЛЕНО КАК ДокументИсточник,
		|	ДД.Ссылка КАК ДокументВыпуска,
		|	0 КАК НомерГруппыЗатрат,
		|	Т.Номенклатура КАК Продукция,
		|	Т.Характеристика КАК ХарактеристикаПродукции,
		|	НЕОПРЕДЕЛЕНО КАК Серия
		|ИЗ
		|	Документ.ВыпускПродукции КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ВыпускПродукции.Товары КАК Т
		|		ПО Т.Ссылка = ДД.Ссылка
		//++ НЕ УТКА
		|	ЛЕВОЕ СОЕДИНЕНИЕ Справочник.Назначения КАК Назначения
		|		ПО Назначения.Ссылка = Т.Назначение
		|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.ЗаказДавальца КАК ЗаказДавальца
		|		ПО ЗаказДавальца.Ссылка = Назначения.Заказ
		//-- НЕ УТКА
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ
		|		РегистрСведений.АналитикаУчетаНоменклатуры КАК АналитикаВПодразделении
		|	ПО
		|		Т.Номенклатура = АналитикаВПодразделении.Номенклатура
		|		И Т.Характеристика = АналитикаВПодразделении.Характеристика
		|		И ДД.Подразделение = АналитикаВПодразделении.МестоХранения
		|		И ВЫБОР
		|			КОГДА Т.СтатусУказанияСерий = 14
		|			ТОГДА Т.Серия = АналитикаВПодразделении.Серия
		|			ИНАЧЕ АналитикаВПодразделении.Серия = ЗНАЧЕНИЕ(Справочник.СерииНоменклатуры.ПустаяСсылка)
		|		   КОНЕЦ
		|		И Т.Назначение = АналитикаВПодразделении.Назначение
		|		И АналитикаВПодразделении.СтатьяКалькуляции = ЗНАЧЕНИЕ(Справочник.СтатьиКалькуляции.ПустаяСсылка)
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.СтруктураПредприятия КАК СП
		|		ПО СП.Ссылка = ДД.Подразделение
		|		И НЕ СП.ИспользуетсяСписаниеЗатратНаВыпуск
		|ГДЕ
		|	ДД.Дата МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Проведен
		|	И НЕ ДД.ВыпускПоРаспоряжениям
		|	И Т.СписатьНаРасходы
		|СГРУППИРОВАТЬ ПО
		|	ДД.Дата,
		|	ДД.Ссылка,
		//++ НЕ УТКА
		|	(ВЫБОР
		|		КОГДА ЗаказДавальца.Ссылка ЕСТЬ NULL ТОГДА
		|		 ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты)
		|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КОНЕЦ),
		//-- НЕ УТКА
		|	ДД.Организация,
		|	Т.КодСтроки,
		|	АналитикаВПодразделении.КлючАналитики,
		|	(ВЫБОР ДД.НаправлениеВыпуска
		|		КОГДА ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукцииВПодразделение)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты)
		|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыНаСкладах) КОНЕЦ),
		|	Т.Номенклатура,
		|	Т.Характеристика,
		|	Т.ВидЗапасов,
		|	Т.Назначение
		|";
КонецФункции

Функция ТекстПоступленияОтПереработчиков()
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстПоступленияОтПереработчиков"" КАК ЗапросИсточник,
		|	90 КАК Приоритет,
		|	""Переработка"" КАК ТипЗаписи,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) КАК ВидДвижения,
		|	ДД.Дата КАК Период,
		|	ДД.Ссылка КАК Регистратор,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты) КАК РазделУчета,
		|	ДД.Организация,
		|	НЕОПРЕДЕЛЕНО КАК Подразделение,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаНоменклатуры,
		|	НЕОПРЕДЕЛЕНО КАК ДокументПоступления,
		|	НЕОПРЕДЕЛЕНО КАК ВидЗапасов,
		|	НЕОПРЕДЕЛЕНО КАК ГруппаПродукции,
		|	(ВЫБОР
		|		КОГДА Строки.ЗаказПереработчику = ЗНАЧЕНИЕ(Документ.ЗаказПереработчику.ПустаяСсылка) ТОГДА НЕОПРЕДЕЛЕНО
		|		ИНАЧЕ Строки.ЗаказПереработчику КОНЕЦ) КАК ЗаказНаПроизводство,
		|	0 КАК КодСтрокиПродукция,
		|	НЕОПРЕДЕЛЕНО КАК Спецификация,
		|	НЕОПРЕДЕЛЕНО КАК Этап,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяКалькуляции,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаПартий,
		|	Строки.АналитикаУчетаНоменклатуры КАК АналитикаУчетаПродукции,
		|	СУММА(Строки.Количество) КАК Знаменатель,
		|	СУММА(Строки.Количество) КАК КоличествоПродукции,
		|	0 КАК Количество,
		|	0 КАК Стоимость,
		|	0 КАК СтоимостьБезНДС,
		|	0 КАК СтоимостьРегл,
		|	0 КАК НДСРегл,
		|	0 КАК ПостояннаяРазница,
		|	0 КАК ВременнаяРазница,
		|	ЛОЖЬ КАК Первичное,
		|	ЛОЖЬ КАК СохранятьРегл,
		|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукции) КАК ХозяйственнаяОперация,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыНаСкладах) КАК КорРазделУчета,
		|	Строки.АналитикаУчетаНоменклатуры КАК КорАналитикаУчетаНоменклатуры,
		|	Строки.ВидЗапасов КАК КорВидЗапасов,
		|	ДАТАВРЕМЯ(1, 1, 1, 0, 0, 0) КАК ДатаРегистратора,
		|	НЕОПРЕДЕЛЕНО КАК НалогообложениеПартии,
		|	НЕОПРЕДЕЛЕНО КАК НалогообложениеНДС,
		|	(ВЫБОР
		|		КОГДА Строки.ЗаказПереработчику = ЗНАЧЕНИЕ(Документ.ЗаказПереработчику.ПустаяСсылка) ТОГДА ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка)
		|		ИНАЧЕ Строки.Назначение КОНЕЦ) КАК Назначение,
		|	НЕОПРЕДЕЛЕНО КАК ДокументИсточник,
		|	(ВЫБОР
		|		КОГДА Строки.ЗаказПереработчику = ЗНАЧЕНИЕ(Документ.ЗаказПереработчику.ПустаяСсылка) ТОГДА ДД.Ссылка
		|		ИНАЧЕ НЕОПРЕДЕЛЕНО КОНЕЦ) КАК ДокументВыпуска,
		|	0 КАК НомерГруппыЗатрат,
		|	Строки.Номенклатура КАК Продукция,
		|	Строки.Характеристика КАК ХарактеристикаПродукции,
		|	НЕОПРЕДЕЛЕНО КАК Серия
		|ИЗ
		|	Документ.ПоступлениеОтПереработчика КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ПоступлениеОтПереработчика.Товары КАК Строки
		|		ПО Строки.Ссылка = ДД.Ссылка
		|ГДЕ
		|	ДД.Дата МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Проведен
		|СГРУППИРОВАТЬ ПО
		|	ДД.Дата,
		|	ДД.Ссылка,
		|	ДД.Организация,
		|	Строки.АналитикаУчетаНоменклатуры,
		|	Строки.ВидЗапасов,
		|	(ВЫБОР
		|		КОГДА Строки.ЗаказПереработчику = ЗНАЧЕНИЕ(Документ.ЗаказПереработчику.ПустаяСсылка) ТОГДА НЕОПРЕДЕЛЕНО
		|		ИНАЧЕ Строки.ЗаказПереработчику КОНЕЦ),
		|	(ВЫБОР
		|		КОГДА Строки.ЗаказПереработчику = ЗНАЧЕНИЕ(Документ.ЗаказПереработчику.ПустаяСсылка) ТОГДА ДД.Ссылка
		|		ИНАЧЕ НЕОПРЕДЕЛЕНО КОНЕЦ),
		|	Строки.Номенклатура,
		|	Строки.Характеристика,
		|	(ВЫБОР
		|		КОГДА Строки.ЗаказПереработчику = ЗНАЧЕНИЕ(Документ.ЗаказПереработчику.ПустаяСсылка) ТОГДА ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка)
		|		ИНАЧЕ Строки.Назначение КОНЕЦ)
		|";
КонецФункции

#КонецОбласти

#Область РасчетТрудозатратНезавершенногоПроизводства

// В партионном учете версии 2.2 - этап 6, РаспределениеТрудозатрат

Функция ДанныеДляТрудозатратНЗП(НачалоПериода, ОкончаниеПериода, МассивОрганизаций)
	ТекстСортировка = "
		|УПОРЯДОЧИТЬ ПО
		|	Организация, ЗаказНаПроизводство, КодСтрокиПродукция, Спецификация, Продукция, ХарактеристикаПродукции,
		|	Приоритет, Период, Регистратор 
		|";
	ТекстИндексы = "
		|ИНДЕКСИРОВАТЬ ПО
		|	Организация
		|";
	ИсходныйТекстЗапроса =
		ТекстТрудозатратыНЗПИнициализация() + ";" // вт ЗаказыКРаспределению, ДолиСтоимости, ВыпускиБезЗаказов, ПриходыБезЗаказов, КРаспределению, ОстаткиБезЗаказов
		+ ТекстОписаниеДанныхДляТрудозатратНЗП()
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстОстаткиТрудозатратБезЗаказов()
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстПервичныеТрудозатратыБезЗаказов()
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстДополнениеТрудозатратБезЗаказов()
		//++ НЕ УТКА
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстОстаткиТрудозатратНЗП()
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстПервичныеТрудозатратыНЗП() // использует ДолиСтоимости
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстТрудозатратыМаршрутныеЛисты()
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстТрудозатратыВыпускиПоЗаказам()
		//-- НЕ УТКА
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстТрудозатратыБезЗаказовПотребление() // Использует ВыпускиБезЗаказов
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстТрудозатратыБезЗаказовПотреблениеАвто() // Использует ВыпускиБезЗаказов
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстТрудозатратыБезЗаказовПеремещение()
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстТрудозатратыБезЗаказовРаспределение() // Использует КРаспределению
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстТрудозатратыВыпускиБезЗаказов()
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстТрудозатратыБезЗаказовНЗП()
		//++ НЕ УТКА
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстТрудозатратыОтчетыДавальцам()
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстТрудозатратыДавальческиеПолуфабрикаты() // использует ДолиСтоимости

		//-- НЕ УТКА
		+ ТекстИндексы;
	МВТ = Новый МенеджерВременныхТаблиц;	
	ИсходныйЗапрос = Новый Запрос(СтрЗаменить(ИсходныйТекстЗапроса, "//ВоВременнуюТаблицу", ""));
	ИсходныйЗапрос.УстановитьПараметр("НачалоПериода", НачалоПериода);
	ИсходныйЗапрос.УстановитьПараметр("ОкончаниеПериода", ОкончаниеПериода);	
	ИсходныйЗапрос.УстановитьПараметр("МассивОрганизаций", МассивОрганизаций);	
	ИсходныйЗапрос.МенеджерВременныхТаблиц = МВТ;
	ИсходныйЗапрос.Выполнить();
	
	Запрос = Новый Запрос(ТекстОписаниеДанныхДляТрудозатратНЗП());
	РасчетныеПартии = Запрос.Выполнить().Выгрузить();
	
	ВременнаяТаблицаДанныхПоОтбору("Организация", ТекстСортировка, РасчетныеПартии, МВТ);
	
	Возврат МВТ;
КонецФункции

Функция РасчетныеТрудозатратыНЗП(ДанныеДляРасчета, Регистраторы, ЦепочкиДвижений = Неопределено, Тест = Ложь)
	
	// Шаг 1: создаем буфер накопления рассчитанных партий
	Запрос = Новый Запрос(ТекстОписаниеДанныхДляТрудозатратНЗП());
	РасчетныеПартии = Запрос.Выполнить().Выгрузить();
	
	// Шаг 2: обсчитываем цепочки движений
	КонтекстЦепочек = ОписаниеЦепочек("Партия, ПартияБезЗаказа, НЗП, Остаток, ОстатокБезЗаказа, Дополнение, МаршрутныйЛист, Распределение, Потребление, ПотреблениеАвто, Перемещение,
	|Выпуск, ВыпускБезЗаказа, ОтчетДавальцу, ПолуфабрикатДавальца");
	
	ПоляПотреблений = "Организация, ЗаказНаПроизводство, КодСтрокиПродукция, Спецификация";
	ДобавитьОписаниеПриемника(КонтекстЦепочек, "МаршрутныйЛист", ПоляПотреблений);
	ДобавитьОписаниеИсточника(КонтекстЦепочек, "МаршрутныйЛист", "Партия", ПоляПотреблений);
	ДобавитьОписаниеИсточника(КонтекстЦепочек, "МаршрутныйЛист", "Остаток", ПоляПотреблений);
	ДобавитьОписаниеИсточника(КонтекстЦепочек, "МаршрутныйЛист", "ПолуфабрикатДавальца", ПоляПотреблений);
	
	ДобавитьОписаниеПриемника(КонтекстЦепочек, "ПолуфабрикатДавальца", "Организация, Назначение, Продукция, ХарактеристикаПродукции");
	ДобавитьОписаниеИсточника(КонтекстЦепочек, "ПолуфабрикатДавальца", "Выпуск", "Организация, Назначение, Продукция, ХарактеристикаПродукции");
	
	ДобавитьОписаниеПриемника(КонтекстЦепочек, "Выпуск", "Организация, ЗаказНаПроизводство, КодСтрокиПродукция, Спецификация, Продукция, ХарактеристикаПродукции");
	ДобавитьОписаниеИсточника(КонтекстЦепочек, "Выпуск", "МаршрутныйЛист", "Организация, ЗаказНаПроизводство, КодСтрокиПродукция, Спецификация, Продукция, ХарактеристикаПродукции");
	
	ДобавитьОписаниеПриемника(КонтекстЦепочек, "Потребление", "РазделУчета, Организация, Подразделение, ВидРабот, ВидФондаВзносов");
	ДобавитьОписаниеИсточника(КонтекстЦепочек, "Потребление", "ПартияБезЗаказа", "РазделУчета, Организация, Подразделение, ВидРабот, ВидФондаВзносов");
	ДобавитьОписаниеИсточника(КонтекстЦепочек, "Потребление", "ОстатокБезЗаказа", "РазделУчета, Организация, Подразделение, ВидРабот, ВидФондаВзносов");
	
	ДобавитьОписаниеПриемника(КонтекстЦепочек, "НЗП", "Организация, Подразделение, ВидРабот, ВидФондаВзносов");
	ДобавитьОписаниеИсточника(КонтекстЦепочек, "НЗП", "ПартияБезЗаказа", "Организация, Подразделение, ВидРабот, ВидФондаВзносов");
	
	ДобавитьОписаниеПриемника(КонтекстЦепочек, "ПотреблениеАвто", "РазделУчета, Организация, Подразделение, ВидРабот, ВидФондаВзносов");
	ДобавитьОписаниеИсточника(КонтекстЦепочек, "ПотреблениеАвто", "Распределение", "РазделУчета, Организация, Подразделение, ВидРабот, ВидФондаВзносов");
	
	ДобавитьОписаниеПриемника(КонтекстЦепочек, "Распределение", "РазделУчета, Организация, Подразделение, ВидРабот, ВидФондаВзносов");
	ДобавитьОписаниеИсточника(КонтекстЦепочек, "Распределение", "ПартияБезЗаказа", "РазделУчета, Организация, Подразделение, ВидРабот, ВидФондаВзносов");
	
	ДобавитьОписаниеПриемника(КонтекстЦепочек, "Перемещение", "Регистратор");
	ДобавитьОписаниеИсточника(КонтекстЦепочек, "Перемещение", "Потребление", "Регистратор");
	ДобавитьОписаниеИсточника(КонтекстЦепочек, "Перемещение", "ПотреблениеАвто", "Регистратор");
	
	ДобавитьОписаниеПриемника(КонтекстЦепочек, "ВыпускБезЗаказа", "ДокументВыпуска, КодСтроки");
	ДобавитьОписаниеИсточника(КонтекстЦепочек, "ВыпускБезЗаказа", "Перемещение", "ДокументВыпуска, КодСтроки");
	
	ДобавитьОписаниеПриемника(КонтекстЦепочек, "ОтчетДавальцу", "Организация, Назначение, Продукция, ХарактеристикаПродукции");
	ДобавитьОписаниеИсточника(КонтекстЦепочек, "ОтчетДавальцу", "Выпуск", "Организация, Назначение, Продукция, ХарактеристикаПродукции");
	ДобавитьОписаниеИсточника(КонтекстЦепочек, "ОтчетДавальцу", "ВыпускБезЗаказа", "Организация, Назначение, Продукция, ХарактеристикаПродукции");
	
	// Шаг 3: замена ложных партий на первичные партии в расчетных строках по результатам построение графа замен.
	КонтекстДвижений = ОписаниеДвижений(
		"ТрудозатратыНезавершенногоПроизводства",
		"ТрудозатратыНезавершенногоПроизводства",
		ПереченьПолей(РасчетныеПартии.Колонки),
		ПоляПотреблений,
		"Количество, НормативнаяСтоимость, Стоимость, СтоимостьРегл",
		"Знаменатель", "Знаменатель", "ДокументИсточник", "Период",
		"ГруппаПродукции");
	КонтекстДвижений.Вставить("ПоляСуммирования", "Количество, НормативнаяСтоимость, Стоимость, СтоимостьРегл");
	КонтекстДвижений.Вставить("ПоляГруппировки", ПереченьПолей(РасчетныеПартии.Колонки, КонтекстДвижений.ПоляСуммирования));
	ЦепочкиДвижений(КонтекстЦепочек, ДанныеДляРасчета);
	РассчитатьПартииПоЦепочкам(КонтекстДвижений, ДанныеДляРасчета, РасчетныеПартии, Регистраторы, Тест);
	ЦепочкиДвижений = ДанныеДляРасчета;
		
	// Шаг 4: Удаляем нерассчитанные партии
	Если Не Тест Тогда
		УдалитьНезаписываемыеСтроки(КонтекстДвижений.Контекст, РасчетныеПартии);
	КонецЕсли;
	
	Возврат РасчетныеПартии;
	
КонецФункции

Функция ТекстТрудозатратыНЗПИнициализация() // вт ЗаказыКРаспределению, ВтВидыФондов, ДолиСтоимости, ВыпускиБезЗаказов, ПриходыБезЗаказов, КРаспределению, ОстаткиБезЗаказов
	Возврат "
		//++ НЕ УТКА
		|ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	Т.Распоряжение.Распоряжение КАК Заказ,
		|	Т.Распоряжение.КодСтроки КАК КодСтроки
		|ПОМЕСТИТЬ
		|	ЗаказыКРаспределению
		|ИЗ
		|	РегистрНакопления.РаспоряженияНаВыпускПродукции.ОстаткиИОбороты(&НачалоПериода, &ОкончаниеПериода, , , Распоряжение.Организация В (&МассивОрганизаций)) КАК Т
		|ГДЕ
		|	Т.ЗаказаноПриход <> 0
		|	ИЛИ Т.ЗаказаноКонечныйОстаток <> 0
		|;
		|////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	МаршрутныйЛист.Распоряжение КАК ЗаказНаПроизводство,
		|	МаршрутныйЛист.КодСтроки КАК КодСтрокиПродукция,
		|	Этапы.Владелец КАК Спецификация,
		|	СУММА(ВЫБОР ДД.ДоляСтоимости КОГДА 0 ТОГДА 1
		|		ИНАЧЕ ДД.ДоляСтоимости КОНЕЦ
		|		* (МаршрутныйЛист.Произведено + МаршрутныйЛист.Брак)) КАК ДоляСтоимости
		|ПОМЕСТИТЬ
		|	ДолиСтоимости
		|ИЗ
		|	РегистрНакопления.РаспоряженияНаВыпускПродукции КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.МаршрутныйЛистПроизводства КАК МаршрутныйЛист
		|		ПО МаршрутныйЛист.Ссылка = ДД.Распоряжение
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ЭтапыПроизводства КАК Этапы
		|		ПО Этапы.Ссылка = МаршрутныйЛист.Этап
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ЗаказыКРаспределению КАК Заказы
		|		ПО Заказы.Заказ = МаршрутныйЛист.Распоряжение
		|			И Заказы.КодСтроки = МаршрутныйЛист.КодСтроки
		|ГДЕ
		|	ДД.Период >= &НачалоПериода
		|	И МаршрутныйЛист.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|	И ДД.ТипСтоимости = ЗНАЧЕНИЕ(Перечисление.ТипыСтоимостиВыходныхИзделий.Рассчитывается)
		|СГРУППИРОВАТЬ ПО
		|	МаршрутныйЛист.Распоряжение,
		|	МаршрутныйЛист.КодСтроки,
		|	Этапы.Владелец
		|;
		|////////////////////////////////////////////////////////////////////////////

		//-- НЕ УТКА
		|ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	ДД.Организация,
		|	ДД.Подразделение,
		|	ДД.ВидРабот,
		|	ДД.ВидФондаВзносов КАК ВидФондаВзносов
		|ПОМЕСТИТЬ ВтВидыФондов
		|ИЗ
		|	РегистрНакопления.ТрудозатратыНезавершенногоПроизводства КАК ДД
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|	И ДД.КодСтрокиПродукция = 0
		|;
		|////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ДД.Ссылка КАК Ссылка,
		|	СУММА(Выходы.Количество) КАК Количество,
		|	СУММА(Выходы.ДоляСтоимости) КАК ДоляСтоимости
		|ПОМЕСТИТЬ
		|	ВыпускиБезЗаказов
		|ИЗ
		|	Документ.СписаниеЗатратНаВыпуск КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.СписаниеЗатратНаВыпуск.ВыходныеИзделия КАК Выходы
		|		ПО Выходы.Ссылка = ДД.Ссылка
		|ГДЕ
		|	ДД.Дата МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Проведен
		|СГРУППИРОВАТЬ ПО
		|	ДД.Ссылка
		|;
		|////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ДД.Организация,
		|	ДД.Подразделение,
		|	ДД.ВидРабот,
		|	ДД.ГруппаПродукции,
		|	ДД.КоличествоПриход КАК Количество
		|ПОМЕСТИТЬ
		|	ПриходыБезЗаказов
		|ИЗ
		|	РегистрНакопления.ТрудозатратыНезавершенногоПроизводства.Обороты(&НачалоПериода, &ОкончаниеПериода, Период, Организация В (&МассивОрганизаций) 
		//++ НЕ УТКА
		|		И ЗаказНаПроизводство = ЗНАЧЕНИЕ(Документ.ЗаказНаПроизводство.ПустаяСсылка)
		//-- НЕ УТКА
		|	) КАК ДД
		|;
		|////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	Реквизиты.Организация,
		|	РеквизитыНоменклатуры.ГруппаАналитическогоУчета КАК ГруппаПродукции,
		|	ВидыРабот.Подразделение,
		|	ВидыРабот.ВидРабот,
		|	СУММА(ВидыРабот.Количество) КАК Количество
		|ПОМЕСТИТЬ ТрудозатратыНЗП
		|ИЗ
		|	Документ.ИзделияИЗатратыНЗП КАК Реквизиты
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ИзделияИЗатратыНЗП.Трудозатраты КАК ВидыРабот
		|		ПО Реквизиты.Ссылка = ВидыРабот.Ссылка
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Номенклатура КАК РеквизитыНоменклатуры
		|		ПО Реквизиты.Номенклатура = РеквизитыНоменклатуры.Ссылка
		|ГДЕ
		|	Реквизиты.Дата МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И Реквизиты.Организация В (&МассивОрганизаций)
		|	И Реквизиты.Проведен
		|
		|СГРУППИРОВАТЬ ПО
		|	Реквизиты.Организация,
		|	РеквизитыНоменклатуры.ГруппаАналитическогоУчета,
		|	ВидыРабот.Подразделение,
		|	ВидыРабот.ВидРабот		
		|;
		|
		|////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ДД.Организация,
		|	ВидыРабот.Подразделение,
		|	ВидыРабот.ВидРабот,
		|	ДД.Номенклатура.ГруппаАналитическогоУчета КАК ГруппаПродукции,
		|	СУММА(ВидыРабот.Количество)
		|ПОМЕСТИТЬ КРаспределению
		|ИЗ
		|	Документ.СписаниеЗатратНаВыпуск КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.СписаниеЗатратНаВыпуск.Трудозатраты КАК ВидыРабот
		|		ПО ВидыРабот.Ссылка = ДД.Ссылка
		|ГДЕ
		|	ДД.Дата МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Проведен
		|
		|СГРУППИРОВАТЬ ПО
		|	ДД.Организация,
		|	ВидыРабот.Подразделение,
		|	ВидыРабот.ВидРабот,
		|	ДД.Номенклатура.ГруппаАналитическогоУчета
		|;
		|
		|////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ДД.Организация,
		|	ДД.Подразделение,
		|	ДД.ВидРабот,
		|	ДД.ГруппаПродукции,
		|	ДД.КоличествоОстаток КАК Знаменатель
		|ПОМЕСТИТЬ
		|	ОстаткиБезЗаказов
		|ИЗ
		|	РегистрНакопления.ТрудозатратыНезавершенногоПроизводства.Остатки(&НачалоПериода, Организация В (&МассивОрганизаций)) КАК ДД
		//++ НЕ УТКА
		|ГДЕ
		|	ДД.ЗаказНаПроизводство = ЗНАЧЕНИЕ(Документ.ЗаказНаПроизводство.ПустаяСсылка)
		//-- НЕ УТКА
		|";
КонецФункции

Функция ТекстОписаниеДанныхДляТрудозатратНЗП()
	Возврат "
		|ВЫБРАТЬ ПЕРВЫЕ 0
		|	0 КАК Приоритет,
		|	""ХХХХХХХХХХХХХХХХХХХХ"" КАК ТипЗаписи,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
		|	ДАТАВРЕМЯ(1, 1, 1, 0, 0, 0) КАК Период,
		|	ДД.Регистратор,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КАК РазделУчета,
		|	ЗНАЧЕНИЕ(Справочник.Организации.ПустаяСсылка) КАК Организация,
		|	ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка) КАК Подразделение,
		|	ДД.ЗаказНаПроизводство,
		|	0 КАК КодСтрокиПродукция,
		|	ЗНАЧЕНИЕ(Перечисление.ВидыФондовВзносов.ПустаяСсылка) КАК ВидФондаВзносов,
		|	ЗНАЧЕНИЕ(Справочник.РесурсныеСпецификации.ПустаяСсылка) КАК Спецификация,
		|	ЗНАЧЕНИЕ(Справочник.ЭтапыПроизводства.ПустаяСсылка) КАК Этап,
		|	ЗНАЧЕНИЕ(Справочник.СтатьиКалькуляции.ПустаяСсылка) КАК СтатьяКалькуляции,
		|	ЗНАЧЕНИЕ(Справочник.ВидыРаботСотрудников.ПустаяСсылка) КАК ВидРабот,
		|	ЗНАЧЕНИЕ(Справочник.ГруппыАналитическогоУчетаНоменклатуры.ПустаяСсылка) КАК ГруппаПродукции,
		|	0 КАК Знаменатель,
		|	0 КАК КоличествоПродукции,
		|	0 КАК Количество,
		|	0 КАК НормативнаяСтоимость,
		|	0 КАК Стоимость,
		|	0 КАК СтоимостьРегл,
		|	ЛОЖЬ КАК Первичное,
		|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПустаяСсылка) КАК ХозяйственнаяОперация,
		|	ЗНАЧЕНИЕ(Справочник.ФизическиеЛица.ПустаяСсылка) КАК Сотрудник,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КАК КорАналитикаУчетаПродукции,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КАК КорРазделУчета,
		|	ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка) КАК КорВидЗапасовПродукции,
		|	ЗНАЧЕНИЕ(Справочник.СтатьиКалькуляции.ПустаяСсылка) КАК СтатьяКалькуляцииБезЗаказа,
		|	ДД.ДокументВыпуска,
		|	0 КАК КодСтроки,
		|	ДД.Регистратор КАК ДокументИсточник,
		|	ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка) КАК Продукция,
		|	ЗНАЧЕНИЕ(Справочник.ХарактеристикиНоменклатуры.ПустаяСсылка) КАК ХарактеристикаПродукции,
		|	ЗНАЧЕНИЕ(Справочник.СерииНоменклатуры.ПустаяСсылка) КАК Серия,
		|	ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка) КАК Назначение
		|//ВоВременнуюТаблицу ПОМЕСТИТЬ ИсходныеДанные
		|ИЗ
		|	РегистрНакопления.ТрудозатратыНезавершенногоПроизводства КАК ДД
		|";
КонецФункции

Функция ТекстОстаткиТрудозатратБезЗаказов() // использует ОстаткиБезЗаказов
	Возврат "
		|ВЫБРАТЬ
		|	10 КАК Приоритет,
		|	""ОстатокБезЗаказа"" КАК ТипЗаписи,
		|	ИСТИНА КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
		|	&НачалоПериода КАК Период,
		|	НЕОПРЕДЕЛЕНО КАК Регистратор,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КАК РазделУчета,
		|	ДД.Организация,
		|	ДД.Подразделение,
		|	НЕОПРЕДЕЛЕНО КАК ЗаказНаПроизводство,
		|	0 КАК КодСтрокиПродукция,
		|	ДД.ВидФондаВзносов,
		|	НЕОПРЕДЕЛЕНО КАК Спецификация,
		|	НЕОПРЕДЕЛЕНО КАК Этап,
		|	ДД.СтатьяКалькуляции,
		|	ДД.ВидРабот,
		|	ДД.ГруппаПродукции,
		|	Остатки.Знаменатель,
		|	0 КАК КоличествоПродукции,
		|	ДД.КоличествоОстаток КАК Количество,
		|	ДД.НормативнаяСтоимостьОстаток КАК НормативнаяСтоимость,
		|	ДД.СтоимостьОстаток КАК Стоимость,
		|	ДД.СтоимостьРеглОстаток КАК СтоимостьРегл,
		|	ИСТИНА КАК Первичное,
		|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПустаяСсылка) КАК ХозяйственнаяОперация,
		|	НЕОПРЕДЕЛЕНО КАК Сотрудник,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаУчетаПродукции,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КорРазделУчета,
		|	ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка) КАК КорВидЗапасовПродукции,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяКалькуляцииБезЗаказа,
		|	НЕОПРЕДЕЛЕНО КАК ДокументВыпуска,
		|	0 КАК КодСтроки,
		|	НЕОПРЕДЕЛЕНО КАК ДокументИсточник,
		|	НЕОПРЕДЕЛЕНО КАК Продукция,
		|	НЕОПРЕДЕЛЕНО КАК ХарактеристикаПродукции,
		|	НЕОПРЕДЕЛЕНО КАК Серия,
		|	НЕОПРЕДЕЛЕНО КАК Назначение
		|ИЗ
		|	РегистрНакопления.ТрудозатратыНезавершенногоПроизводства.Остатки(&НачалоПериода, Организация В (&МассивОрганизаций)) КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ОстаткиБезЗаказов КАК Остатки
		|		ПО Остатки.Организация = ДД.Организация
		|		И Остатки.Подразделение = ДД.Подразделение
		|		И Остатки.ВидРабот = ДД.ВидРабот
		|		И Остатки.ГруппаПродукции = ДД.ГруппаПродукции
		//++ НЕ УТКА
		|ГДЕ
		|	ДД.ЗаказНаПроизводство = ЗНАЧЕНИЕ(Документ.ЗаказНаПроизводство.ПустаяСсылка)
		//-- НЕ УТКА
		|";
КонецФункции

Функция ТекстПервичныеТрудозатратыБезЗаказов() // использует ПриходыБезЗаказов
	Возврат "
		|ВЫБРАТЬ
		|	10 КАК Приоритет,
		|	""ПартияБезЗаказа"" КАК ТипЗаписи,
		|	ИСТИНА КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
		|	&НачалоПериода КАК Период,
		|	НЕОПРЕДЕЛЕНО КАК Регистратор,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КАК РазделУчета,
		|	ДД.Организация,
		|	ДД.Подразделение,
		|	НЕОПРЕДЕЛЕНО КАК ЗаказНаПроизводство,
		|	0 КАК КодСтрокиПродукция,
		|	ДД.ВидФондаВзносов,
		|	НЕОПРЕДЕЛЕНО КАК Спецификация,
		|	НЕОПРЕДЕЛЕНО КАК Этап,
		|	ДД.СтатьяКалькуляции,
		|	ДД.ВидРабот,
		|	ДД.ГруппаПродукции,
		|	Приходы.Количество КАК Знаменатель,
		|	0 КАК КоличествоПродукции,
		|	СУММА(ДД.Количество) КАК Количество,
		|	СУММА(ДД.НормативнаяСтоимость) КАК НормативнаяСтоимость,
		|	СУММА(ДД.Стоимость) КАК Стоимость,
		|	СУММА(ДД.СтоимостьРегл) КАК СтоимостьРегл,
		|	ИСТИНА КАК Первичное,
		|	НЕОПРЕДЕЛЕНО КАК ХозяйственнаяОперация,
		|	НЕОПРЕДЕЛЕНО КАК Сотрудник,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаУчетаПродукции,
		|	НЕОПРЕДЕЛЕНО КАК КорРазделУчета,
		|	НЕОПРЕДЕЛЕНО КАК КорВидЗапасовПродукции,
		|	ДД.СтатьяКалькуляцииБезЗаказа,
		|	НЕОПРЕДЕЛЕНО КАК ДокументВыпуска,
		|	0 КАК КодСтроки,
		|	НЕОПРЕДЕЛЕНО КАК ДокументИсточник,
		|	НЕОПРЕДЕЛЕНО КАК Продукция,
		|	НЕОПРЕДЕЛЕНО КАК ХарактеристикаПродукции,
		|	НЕОПРЕДЕЛЕНО КАК Серия,
		|	НЕОПРЕДЕЛЕНО КАК Назначение
		|ИЗ
		|	РегистрНакопления.ТрудозатратыНезавершенногоПроизводства КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ПриходыБезЗаказов КАК Приходы
		|		ПО Приходы.Организация = ДД.Организация
		|		И Приходы.Подразделение = ДД.Подразделение
		|		И Приходы.ВидРабот = ДД.ВидРабот
		|		И Приходы.ГруппаПродукции = ДД.ГруппаПродукции
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|	И ДД.КодСтрокиПродукция = 0
		|СГРУППИРОВАТЬ ПО
		|	ДД.Организация,
		|	ДД.Подразделение,
		|	ДД.ВидФондаВзносов,
		|	ДД.СтатьяКалькуляции,
		|	ДД.ВидРабот,
		|	ДД.ГруппаПродукции,
		|	Приходы.Количество,
		|	ДД.СтатьяКалькуляцииБезЗаказа
		|";
КонецФункции

Функция ТекстДополнениеТрудозатратБезЗаказов()
	Возврат "
		|ВЫБРАТЬ
		|	10 КАК Приоритет,
		|	""Дополнение"" КАК ТипЗаписи,
		|	ИСТИНА КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты) КАК РазделУчета,
		|	ДД.Организация,
		|	ДД.Подразделение,
		|	НЕОПРЕДЕЛЕНО КАК ЗаказНаПроизводство,
		|	0 КАК КодСтрокиПродукция,
		|	ДД.ВидФондаВзносов,
		|	НЕОПРЕДЕЛЕНО КАК Спецификация,
		|	НЕОПРЕДЕЛЕНО КАК Этап,
		|	ДД.СтатьяКалькуляции,
		|	ДД.ВидРабот,
		|	ДД.ГруппаПродукции,
		|	0 КАК Знаменатель,
		|	0 КАК КоличествоПродукции,
		|	СУММА(ДД.Количество) КАК Количество,
		|	СУММА(ДД.НормативнаяСтоимость) КАК НормативнаяСтоимость,
		|	СУММА(ДД.Стоимость) КАК Стоимость,
		|	СУММА(ДД.СтоимостьРегл) КАК СтоимостьРегл,
		|	ИСТИНА КАК Первичное,
		|	НЕОПРЕДЕЛЕНО КАК ХозяйственнаяОперация,
		|	ДД.Сотрудник,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаУчетаПродукции,
		|	НЕОПРЕДЕЛЕНО КАК КорРазделУчета,
		|	НЕОПРЕДЕЛЕНО КАК КорВидЗапасовПродукции,
		|	ДД.СтатьяКалькуляцииБезЗаказа,
		|	НЕОПРЕДЕЛЕНО КАК ДокументВыпуска,
		|	0 КАК КодСтроки,
		|	НЕОПРЕДЕЛЕНО КАК ДокументИсточник,
		|	НЕОПРЕДЕЛЕНО КАК Продукция,
		|	НЕОПРЕДЕЛЕНО КАК ХарактеристикаПродукции,
		|	НЕОПРЕДЕЛЕНО КАК Серия,
		|	НЕОПРЕДЕЛЕНО КАК Назначение
		|ИЗ
		|	РегистрНакопления.ТрудозатратыНезавершенногоПроизводства КАК ДД
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|	И ДД.КодСтрокиПродукция = 0
		|СГРУППИРОВАТЬ ПО
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.Подразделение,
		|	ДД.ВидФондаВзносов,
		|	ДД.СтатьяКалькуляции,
		|	ДД.ВидРабот,
		|	ДД.ГруппаПродукции,
		|	ДД.Сотрудник,
		|	ДД.СтатьяКалькуляцииБезЗаказа
		|";
КонецФункции

//++ НЕ УТКА

Функция ТекстОстаткиТрудозатратНЗП() // использует ДолиСтоимости
	Возврат "
		|ВЫБРАТЬ
		|	10 КАК Приоритет,
		|	""Остаток"" КАК ТипЗаписи,
		|	ИСТИНА КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
		|	&НачалоПериода КАК Период,
		|	НЕОПРЕДЕЛЕНО КАК Регистратор,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КАК РазделУчета,
		|	ДД.Организация,
		|	ДД.Подразделение,
		|	ДД.ЗаказНаПроизводство,
		|	ДД.КодСтрокиПродукция,
		|	ДД.ВидФондаВзносов,
		|	Этапы.Владелец КАК Спецификация,
		|	ДД.Этап,
		|	ДД.СтатьяКалькуляции,
		|	ДД.ВидРабот,
		|	ДД.ГруппаПродукции,
		|	ЕСТЬNULL(Доли.ДоляСтоимости, 1) КАК Знаменатель,
		|	0 КАК КоличествоПродукции,
		|	ДД.КоличествоОстаток КАК Количество,
		|	ДД.НормативнаяСтоимостьОстаток КАК НормативнаяСтоимость,
		|	ДД.СтоимостьОстаток КАК Стоимость,
		|	ДД.СтоимостьРеглОстаток КАК СтоимостьРегл,
		|	ИСТИНА КАК Первичное,
		|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПустаяСсылка) КАК ХозяйственнаяОперация,
		|	НЕОПРЕДЕЛЕНО КАК Сотрудник,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаУчетаПродукции,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КорРазделУчета,
		|	ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка) КАК КорВидЗапасовПродукции,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяКалькуляцииБезЗаказа,
		|	НЕОПРЕДЕЛЕНО КАК ДокументВыпуска,
		|	0 КАК КодСтроки,
		|	НЕОПРЕДЕЛЕНО КАК ДокументИсточник,
		|	НЕОПРЕДЕЛЕНО КАК Продукция,
		|	НЕОПРЕДЕЛЕНО КАК ХарактеристикаПродукции,
		|	НЕОПРЕДЕЛЕНО КАК Серия,
		|	НЕОПРЕДЕЛЕНО КАК Назначение
		|ИЗ
		|	РегистрНакопления.ТрудозатратыНезавершенногоПроизводства.Остатки(&НачалоПериода, Организация В (&МассивОрганизаций)) КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ЭтапыПроизводства КАК Этапы
		|		ПО Этапы.Ссылка = ДД.Этап
		|	ЛЕВОЕ СОЕДИНЕНИЕ ДолиСтоимости КАК Доли
		|		ПО Доли.ЗаказНаПроизводство = ДД.ЗаказНаПроизводство
		|		И Доли.КодСтрокиПродукция = ДД.КодСтрокиПродукция
		|		И Доли.Спецификация = Этапы.Владелец
		|ГДЕ
		|	ДД.КодСтрокиПродукция > 0
		|";
КонецФункции

Функция ТекстПервичныеТрудозатратыНЗП() // использует ДолиСтоимости
	Возврат "
		|ВЫБРАТЬ
		|	10 КАК Приоритет,
		|	""Партия"" КАК ТипЗаписи,
		|	ИСТИНА КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты) КАК РазделУчета,
		|	ДД.Организация,
		|	ДД.Подразделение,
		|	ДД.ЗаказНаПроизводство,
		|	ДД.КодСтрокиПродукция,
		|	ДД.ВидФондаВзносов,
		|	Этапы.Владелец КАК Спецификация,
		|	ДД.Этап,
		|	ДД.СтатьяКалькуляции,
		|	ДД.ВидРабот,
		|	ДД.ГруппаПродукции,
		|	МАКСИМУМ(ЕСТЬNULL(Доли.ДоляСтоимости, 1)) КАК Знаменатель,
		|	0 КАК КоличествоПродукции,
		|	СУММА(ДД.Количество) КАК Количество,
		|	СУММА(ДД.НормативнаяСтоимость) КАК НормативнаяСтоимость,
		|	СУММА(ДД.Стоимость) КАК Стоимость,
		|	СУММА(ДД.СтоимостьРегл) КАК СтоимостьРегл,
		|	ИСТИНА КАК Первичное,
		|	НЕОПРЕДЕЛЕНО КАК ХозяйственнаяОперация,
		|	ДД.Сотрудник,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаУчетаПродукции,
		|	НЕОПРЕДЕЛЕНО КАК КорРазделУчета,
		|	НЕОПРЕДЕЛЕНО КАК КорВидЗапасовПродукции,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяКалькуляцииБезЗаказа,
		|	НЕОПРЕДЕЛЕНО КАК ДокументВыпуска,
		|	0 КАК КодСтроки,
		|	НЕОПРЕДЕЛЕНО КАК ДокументИсточник,
		|	НЕОПРЕДЕЛЕНО КАК Продукция,
		|	НЕОПРЕДЕЛЕНО КАК ХарактеристикаПродукции,
		|	НЕОПРЕДЕЛЕНО КАК Серия,
		|	НЕОПРЕДЕЛЕНО КАК Назначение
		|ИЗ
		|	РегистрНакопления.ТрудозатратыНезавершенногоПроизводства КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ЭтапыПроизводства КАК Этапы
		|		ПО Этапы.Ссылка = ДД.Этап
		|	ЛЕВОЕ СОЕДИНЕНИЕ ДолиСтоимости КАК Доли
		|		ПО Доли.ЗаказНаПроизводство = ДД.ЗаказНаПроизводство
		|		И Доли.КодСтрокиПродукция = ДД.КодСтрокиПродукция
		|		И Доли.Спецификация = Этапы.Владелец
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|	И ДД.КодСтрокиПродукция > 0
		|СГРУППИРОВАТЬ ПО
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.Подразделение,
		|	ДД.ЗаказНаПроизводство,
		|	ДД.КодСтрокиПродукция,
		|	ДД.ВидФондаВзносов,
		|	Этапы.Владелец,
		|	ДД.Этап,
		|	ДД.СтатьяКалькуляции,
		|	ДД.ВидРабот,
		|	ДД.ГруппаПродукции,
		|	ДД.Сотрудник
		|";
КонецФункции

Функция ТекстТрудозатратыМаршрутныеЛисты()
	Возврат "
		|ВЫБРАТЬ
		|	10 КАК Приоритет,
		|	""МаршрутныйЛист"" КАК ТипЗаписи,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
		|	ДД.Период,
		|	НЕОПРЕДЕЛЕНО КАК Регистратор,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты) КАК РазделУчета,
		|	МаршрутныйЛист.Организация,
		|	НЕОПРЕДЕЛЕНО КАК Подразделение,
		|	МаршрутныйЛист.Распоряжение КАК ЗаказНаПроизводство,
		|	МаршрутныйЛист.КодСтроки КАК КодСтрокиПродукция,
		|	НЕОПРЕДЕЛЕНО КАК ВидФондаВзносов,
		|	Этапы.Владелец КАК Спецификация,
		|	МаршрутныйЛист.Этап,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяКалькуляции,
		|	НЕОПРЕДЕЛЕНО КАК ВидРабот,
		|	(ВЫБОР
		|		КОГДА НЕ ПродукцияЗаказа.ГруппаАналитическогоУчета ЕСТЬ NULL ТОГДА ПродукцияЗаказа.ГруппаАналитическогоУчета
		|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.ГруппыАналитическогоУчетаНоменклатуры.ПустаяСсылка) КОНЕЦ) КАК ГруппаПродукции,
		|	СУММА(ВЫБОР ДД.ДоляСтоимости КОГДА 0 ТОГДА 1
		|		ИНАЧЕ ДД.ДоляСтоимости КОНЕЦ
		|		* (МаршрутныйЛист.Произведено + МаршрутныйЛист.Брак)) КАК Знаменатель,
		|	СУММА(ДД.Заказано) КАК КоличествоПродукции,
		|	0 КАК Количество,
		|	0 КАК НормативнаяСтоимость,
		|	0 КАК Стоимость,
		|	0 КАК СтоимостьРегл,
		|	ЛОЖЬ КАК Первичное,
		|	НЕОПРЕДЕЛЕНО КАК ХозяйственнаяОперация,
		|	НЕОПРЕДЕЛЕНО КАК Сотрудник,
		|	ДД.АналитикаУчетаНоменклатуры КАК КорАналитикаУчетаПродукции,
		|	НЕОПРЕДЕЛЕНО КАК КорРазделУчета,
		|	НЕОПРЕДЕЛЕНО КАК КорВидЗапасовПродукции,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяКалькуляцииБезЗаказа,
		|	НЕОПРЕДЕЛЕНО КАК ДокументВыпуска,
		|	0 КАК КодСтроки,
		|	НЕОПРЕДЕЛЕНО КАК ДокументИсточник,
		|	ДД.Номенклатура КАК Продукция,
		|	ДД.Характеристика КАК ХарактеристикаПродукции,
		|	НЕОПРЕДЕЛЕНО КАК Серия,
		|	НЕОПРЕДЕЛЕНО КАК Назначение
		|ИЗ
		|	РегистрНакопления.РаспоряженияНаВыпускПродукции КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.МаршрутныйЛистПроизводства КАК МаршрутныйЛист
		|		ПО МаршрутныйЛист.Ссылка = ДД.Распоряжение
		|	ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ЭтапыПроизводства КАК Этапы
		|		ПО Этапы.Ссылка = МаршрутныйЛист.Этап
		|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.ЗаказНаПроизводство.Продукция КАК СтрокиЗаказа
		|		ПО СтрокиЗаказа.Ссылка = МаршрутныйЛист.Распоряжение
		|		И СтрокиЗаказа.КодСтроки = МаршрутныйЛист.КодСтроки
		|	ЛЕВОЕ СОЕДИНЕНИЕ Справочник.Номенклатура КАК ПродукцияЗаказа
		|		ПО ПродукцияЗаказа.Ссылка = СтрокиЗаказа.Номенклатура
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И МаршрутныйЛист.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|	И ДД.ТипСтоимости = ЗНАЧЕНИЕ(Перечисление.ТипыСтоимостиВыходныхИзделий.Рассчитывается)
		|СГРУППИРОВАТЬ ПО
		|	ДД.Период,
		|	МаршрутныйЛист.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	МаршрутныйЛист.Распоряжение,
		|	МаршрутныйЛист.КодСтроки,
		|	Этапы.Владелец,
		|	МаршрутныйЛист.Этап,
		|	(ВЫБОР
		|		КОГДА НЕ ПродукцияЗаказа.ГруппаАналитическогоУчета ЕСТЬ NULL ТОГДА ПродукцияЗаказа.ГруппаАналитическогоУчета
		|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.ГруппыАналитическогоУчетаНоменклатуры.ПустаяСсылка) КОНЕЦ),
		|	ДД.Номенклатура,
		|	ДД.Характеристика
		|";
КонецФункции

Функция ТекстТрудозатратыВыпускиПоЗаказам()
	Возврат "
		|ВЫБРАТЬ
		|	90 КАК Приоритет,
		|	""Выпуск"" КАК ТипЗаписи,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) КАК ВидДвижения,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	(ВЫБОР
		|		КОГДА ЗаказДавальца.Ссылка ЕСТЬ NULL ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты)
		|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КОНЕЦ) КАК РазделУчета,
		|	МаршрутныйЛист.Организация,
		|	НЕОПРЕДЕЛЕНО КАК Подразделение,
		|	МаршрутныйЛист.Распоряжение КАК ЗаказНаПроизводство,
		|	МаршрутныйЛист.КодСтроки КАК КодСтрокиПродукция,
		|	НЕОПРЕДЕЛЕНО КАК ВидФондаВзносов,
		|	Этапы.Владелец КАК Спецификация,
		|	МаршрутныйЛист.Этап,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяКалькуляции,
		|	НЕОПРЕДЕЛЕНО КАК ВидРабот,
		|	НЕОПРЕДЕЛЕНО КАК ГруппаПродукции,
		|	СУММА(ДД.Заказано) КАК Знаменатель,
		|	СУММА(ДД.Заказано) КАК КоличествоПродукции,
		|	0 КАК Количество,
		|	0 КАК НормативнаяСтоимость,
		|	0 КАК Стоимость,
		|	0 КАК СтоимостьРегл,
		|	ЛОЖЬ КАК Первичное,
		|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукции) КАК ХозяйственнаяОперация,
		|	НЕОПРЕДЕЛЕНО КАК Сотрудник,
		|	ДД.АналитикаУчетаНоменклатуры КАК КорАналитикаУчетаПродукции,
		|	(ВЫБОР
		|		КОГДА Аналитика.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Склад)
		|		 И Аналитика.СкладскаяТерритория.ЦеховаяКладовая
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты) 
		|		КОГДА Аналитика.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Склад)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыНаСкладах)
		|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты) КОНЕЦ) КАК КорРазделУчета,
		|	ДД.ВидЗапасов КАК КорВидЗапасовПродукции,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяКалькуляцииБезЗаказа,
		|	НЕОПРЕДЕЛЕНО КАК ДокументВыпуска,
		|	0 КАК КодСтроки,
		|	НЕОПРЕДЕЛЕНО КАК ДокументИсточник,
		|	ДД.Номенклатура КАК Продукция,
		|	ДД.Характеристика КАК ХарактеристикаПродукции,
		|	НЕОПРЕДЕЛЕНО КАК Серия,
		|	ДД.АналитикаУчетаНоменклатуры.Назначение КАК Назначение
		|ИЗ
		|	РегистрНакопления.РаспоряженияНаВыпускПродукции КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.МаршрутныйЛистПроизводства КАК МаршрутныйЛист
		|		ПО МаршрутныйЛист.Ссылка = ДД.Распоряжение
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК Аналитика
		|		ПО Аналитика.Ссылка = ДД.АналитикаУчетаНоменклатуры
		|	ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ЭтапыПроизводства КАК Этапы
		|		ПО Этапы.Ссылка = МаршрутныйЛист.Этап
		|	ЛЕВОЕ СОЕДИНЕНИЕ Справочник.Назначения КАК Назначения
		|		ПО Назначения.Ссылка = МаршрутныйЛист.Назначение
		|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.ЗаказДавальца КАК ЗаказДавальца
		|		ПО ЗаказДавальца.Ссылка = Назначения.Заказ
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И МаршрутныйЛист.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		|	И ДД.ТипСтоимости = ЗНАЧЕНИЕ(Перечисление.ТипыСтоимостиВыходныхИзделий.Рассчитывается)
		|СГРУППИРОВАТЬ ПО
		|	ДД.Период,
		|	ДД.Регистратор,
		|	(ВЫБОР
		|		КОГДА ЗаказДавальца.Ссылка ЕСТЬ NULL ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты)
		|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КОНЕЦ),
		|	МаршрутныйЛист.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов,
		|	ДД.АналитикаУчетаНоменклатуры.Назначение,
		|	МаршрутныйЛист.Распоряжение,
		|	МаршрутныйЛист.КодСтроки,
		|	Этапы.Владелец,
		|	МаршрутныйЛист.Этап,
		|	(ВЫБОР
		|		КОГДА Аналитика.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Склад)
		|		 И Аналитика.СкладскаяТерритория.ЦеховаяКладовая
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты)
		|		КОГДА Аналитика.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Склад)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыНаСкладах)
		|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты) КОНЕЦ), // КорРазделУчета
		|	ДД.Номенклатура,
		|	ДД.Характеристика
		|";
КонецФункции
//-- НЕ УТКА

Функция ТекстТрудозатратыБезЗаказовНЗП()
	
	Возврат "
		|ВЫБРАТЬ
		|	1 КАК Приоритет,
		|	""НЗП"" КАК ТипЗаписи,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) КАК ВидДвижения,
		|	ДОБАВИТЬКДАТЕ(&ОкончаниеПериода, Секунда, 1) КАК Период,
		|	НЕОПРЕДЕЛЕНО КАК Регистратор,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КАК РазделУчета,
		|	ДД.Организация,
		|	ДД.Подразделение,
		|	НЕОПРЕДЕЛЕНО КАК ЗаказНаПроизводство,
		|	0 КАК КодСтрокиПродукция,
		|	ВтВидыФондов.ВидФондаВзносов КАК ВидФондаВзносов,
		|	НЕОПРЕДЕЛЕНО КАК Спецификация,
		|	НЕОПРЕДЕЛЕНО КАК Этап,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяКалькуляции,
		|	ДД.ВидРабот,
		|	ДД.ГруппаПродукции,
		|	ДД.Количество КАК Знаменатель,
		|	0 КАК КоличествоПродукции,
		|	0 КАК Количество,
		|	0 КАК НормативнаяСтоимость,
		|	0 КАК Стоимость,
		|	0 КАК СтоимостьРегл,
		|	ЛОЖЬ КАК Первичное,
		|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПустаяСсылка) КАК ХозяйственнаяОперация,
		|	НЕОПРЕДЕЛЕНО КАК Сотрудник,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаУчетаПродукции,
		|	НЕОПРЕДЕЛЕНО КАК КорРазделУчета,
		|	НЕОПРЕДЕЛЕНО КАК КорВидЗапасовПродукции,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяКалькуляцииБезЗаказа,
		|	НЕОПРЕДЕЛЕНО КАК ДокументВыпуска,
		|	0 КАК КодСтроки,
		|	НЕОПРЕДЕЛЕНО КАК ДокументИсточник,
		|	НЕОПРЕДЕЛЕНО КАК Продукция,
		|	НЕОПРЕДЕЛЕНО КАК ХарактеристикаПродукции,
		|	НЕОПРЕДЕЛЕНО КАК Серия,
		|	НЕОПРЕДЕЛЕНО КАК Назначение
		|ИЗ
		|	ТрудозатратыНЗП КАК ДД
		|	ЛЕВОЕ СОЕДИНЕНИЕ ВтВидыФондов КАК ВтВидыФондов
		|		ПО ВтВидыФондов.Организация = ДД.Организация
		|		И ВтВидыФондов.Подразделение = ДД.Подразделение
		|		И ВтВидыФондов.ВидРабот = ДД.ВидРабот
		|";
	
КонецФункции

Функция ТекстТрудозатратыБезЗаказовПотребление() // Использует ВыпускиБезЗаказов
	Возврат "
		|ВЫБРАТЬ
		|	40 КАК Приоритет,
		|	""Потребление"" КАК ТипЗаписи,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) КАК ВидДвижения,
		|	ДД.Дата КАК Период,
		|	ДД.Ссылка КАК Регистратор,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КАК РазделУчета,
		|	ДД.Организация,
		|	ВидыРабот.Подразделение,
		|	НЕОПРЕДЕЛЕНО КАК ЗаказНаПроизводство,
		|	0 КАК КодСтрокиПродукция,
		|	ВтВидыФондов.ВидФондаВзносов КАК ВидФондаВзносов,
		|	НЕОПРЕДЕЛЕНО КАК Спецификация,
		|	НЕОПРЕДЕЛЕНО КАК Этап,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяКалькуляции,
		|	ВидыРабот.ВидРабот,
		|	ДД.Номенклатура.ГруппаАналитическогоУчета КАК ГруппаПродукции,
		|	СУММА(ВидыРабот.Количество) КАК Знаменатель,
		|	МАКСИМУМ(ВЫБОР Выпуски.ДоляСтоимости КОГДА 0 ТОГДА Выпуски.Количество
		|		ИНАЧЕ Выпуски.ДоляСтоимости КОНЕЦ) КАК КоличествоПродукции,
		|	0 КАК Количество,
		|	0 КАК НормативнаяСтоимость,
		|	0 КАК Стоимость,
		|	0 КАК СтоимостьРегл,
		|	ЛОЖЬ КАК Первичное,
		|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПустаяСсылка) КАК ХозяйственнаяОперация,
		|	НЕОПРЕДЕЛЕНО КАК Сотрудник,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаУчетаПродукции,
		|	НЕОПРЕДЕЛЕНО КАК КорРазделУчета,
		|	НЕОПРЕДЕЛЕНО КАК КорВидЗапасовПродукции,
		|	ВидыРабот.СтатьяКалькуляции КАК СтатьяКалькуляцииБезЗаказа,
		|	НЕОПРЕДЕЛЕНО КАК ДокументВыпуска,
		|	0 КАК КодСтроки,
		|	НЕОПРЕДЕЛЕНО КАК ДокументИсточник,
		|	НЕОПРЕДЕЛЕНО КАК Продукция,
		|	НЕОПРЕДЕЛЕНО КАК ХарактеристикаПродукции,
		|	НЕОПРЕДЕЛЕНО КАК Серия,
		|	НЕОПРЕДЕЛЕНО КАК Назначение
		|ИЗ
		|	Документ.СписаниеЗатратНаВыпуск КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.СписаниеЗатратНаВыпуск.Трудозатраты КАК ВидыРабот
		|		ПО ВидыРабот.Ссылка = ДД.Ссылка
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВыпускиБезЗаказов КАК Выпуски
		|		ПО Выпуски.Ссылка = ДД.Ссылка
		|	ЛЕВОЕ СОЕДИНЕНИЕ ВтВидыФондов КАК ВтВидыФондов
		|		ПО ВтВидыФондов.Организация = ДД.Организация
		|		И ВтВидыФондов.Подразделение = ВидыРабот.Подразделение
		|		И ВтВидыФондов.ВидРабот = ВидыРабот.ВидРабот
		|ГДЕ
		|	ДД.Дата МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Проведен
		|СГРУППИРОВАТЬ ПО
		|	ДД.Дата,
		|	ДД.Ссылка,
		|	ДД.Организация,
		|	ВидыРабот.Подразделение,
		|	ВидыРабот.ВидРабот,
		|	ВидыРабот.СтатьяКалькуляции,
		|	ВтВидыФондов.ВидФондаВзносов,
		|	ДД.Номенклатура.ГруппаАналитическогоУчета
		|";
КонецФункции

Функция ТекстТрудозатратыБезЗаказовПотреблениеАвто() // Использует ВыпускиБезЗаказов
	Возврат "
		|ВЫБРАТЬ
		|	45 КАК Приоритет,
		|	""ПотреблениеАвто"" КАК ТипЗаписи,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) КАК ВидДвижения,
		|	ДД.Дата КАК Период,
		|	ДД.Ссылка КАК Регистратор,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КАК РазделУчета,
		|	ДД.Организация,
		|	ВидыРабот.Подразделение,
		|	НЕОПРЕДЕЛЕНО КАК ЗаказНаПроизводство,
		|	0. КАК КодСтрокиПродукция,
		|	ВтВидыФондов.ВидФондаВзносов КАК ВидФондаВзносов,
		|	НЕОПРЕДЕЛЕНО КАК Спецификация,
		|	НЕОПРЕДЕЛЕНО КАК Этап,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяКалькуляции,
		|	ВидыРабот.ВидРабот,
		|	ДД.Номенклатура.ГруппаАналитическогоУчета КАК ГруппаПродукции,
		|	СУММА(ВидыРабот.Количество) КАК Знаменатель,
		|	МАКСИМУМ(ВЫБОР Выпуски.ДоляСтоимости КОГДА 0 ТОГДА Выпуски.Количество
		|		ИНАЧЕ Выпуски.ДоляСтоимости КОНЕЦ) КАК КоличествоПродукции,
		|	0. КАК Количество,
		|	0. КАК НормативнаяСтоимость,
		|	0. КАК Стоимость,
		|	0. КАК СтоимостьРегл,
		|	ЛОЖЬ КАК Первичное,
		|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПустаяСсылка) КАК ХозяйственнаяОперация,
		|	НЕОПРЕДЕЛЕНО КАК Сотрудник,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаПродукции,
		|	НЕОПРЕДЕЛЕНО КАК КорРазделУчета,
		|	НЕОПРЕДЕЛЕНО КАК КорВидЗапасов,
		|	ВидыРабот.СтатьяКалькуляции КАК СтатьяКалькуляцииБезЗаказа,
		|	НЕОПРЕДЕЛЕНО КАК ДокументВыпуска,
		|	0. КАК КодСтроки,
		|	НЕОПРЕДЕЛЕНО КАК ДокументИсточник,
		|	НЕОПРЕДЕЛЕНО КАК Продукция,
		|	НЕОПРЕДЕЛЕНО КАК ХарактеристикаПродукции,
		|	НЕОПРЕДЕЛЕНО КАК Серия,
		|	НЕОПРЕДЕЛЕНО КАК Назначение
		|ИЗ
		|	Документ.СписаниеЗатратНаВыпуск КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.СписаниеЗатратНаВыпуск.Трудозатраты КАК ВидыРабот
		|		ПО ВидыРабот.Ссылка = ДД.Ссылка
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВыпускиБезЗаказов КАК Выпуски
		|		ПО Выпуски.Ссылка = ДД.Ссылка
		|	ЛЕВОЕ СОЕДИНЕНИЕ ВтВидыФондов КАК ВтВидыФондов
		|		ПО ВтВидыФондов.Организация = ДД.Организация
		|		И ВтВидыФондов.Подразделение = ВидыРабот.Подразделение
		|		И ВтВидыФондов.ВидРабот = ВидыРабот.ВидРабот
		|ГДЕ
		|	ДД.Дата МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Проведен
		|СГРУППИРОВАТЬ ПО
		|	ДД.Дата,
		|	ДД.Ссылка,
		|	ДД.Организация,
		|	ВидыРабот.Подразделение,
		|	ВидыРабот.ВидРабот,
		|	ВидыРабот.СтатьяКалькуляции,
		|	ВтВидыФондов.ВидФондаВзносов,
		|	ДД.Номенклатура.ГруппаАналитическогоУчета
		|";
КонецФункции

Функция ТекстТрудозатратыБезЗаказовПеремещение()
	Возврат "
		|ВЫБРАТЬ
		|	60 КАК Приоритет,
		|	""Перемещение"" КАК ТипЗаписи,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
		|	ДД.Дата КАК Период,
		|	ДД.Ссылка КАК Регистратор,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты) КАК РазделУчета,
		|	ДД.Организация,
		|	НЕОПРЕДЕЛЕНО КАК Подразделение,
		|	НЕОПРЕДЕЛЕНО КАК ЗаказНаПроизводство,
		|	0 КАК КодСтрокиПродукция,
		|	НЕОПРЕДЕЛЕНО КАК ВидФондаВзносов,
		|	НЕОПРЕДЕЛЕНО КАК Спецификация,
		|	НЕОПРЕДЕЛЕНО КАК Этап,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяКалькуляции,
		|	НЕОПРЕДЕЛЕНО КАК ВидРабот,
		|	НЕОПРЕДЕЛЕНО КАК ГруппаПродукции,
		|	СУММА(ВЫБОР Выходы.ДоляСтоимости КОГДА 0 ТОГДА Выходы.Количество
		|		ИНАЧЕ Выходы.ДоляСтоимости КОНЕЦ) КАК Знаменатель,
		|	СУММА(Выходы.Количество) КАК КоличествоПродукции,
		|	0 КАК Количество,
		|	0 КАК НормативнаяСтоимость,
		|	0 КАК Стоимость,
		|	0 КАК СтоимостьРегл,
		|	ЛОЖЬ КАК Первичное,
		|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПустаяСсылка) КАК ХозяйственнаяОперация,
		|	НЕОПРЕДЕЛЕНО КАК Сотрудник,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаУчетаПродукции,
		|	НЕОПРЕДЕЛЕНО КАК КорРазделУчета,
		|	НЕОПРЕДЕЛЕНО КАК КорВидЗапасовПродукции,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяКалькуляцииБезЗаказа,
		|	Выходы.Распоряжение КАК ДокументВыпуска,
		|	Выходы.КодСтроки КАК КодСтроки,
		|	Выходы.Распоряжение КАК ДокументИсточник,
		|	Выходы.Номенклатура КАК Продукция,
		|	Выходы.Характеристика КАК ХарактеристикаПродукции,
		|	Выходы.Серия,
		|	НЕОПРЕДЕЛЕНО КАК Назначение
		|ИЗ
		|	Документ.СписаниеЗатратНаВыпуск КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.СписаниеЗатратНаВыпуск.ВыходныеИзделия КАК Выходы
		|		ПО Выходы.Ссылка = ДД.Ссылка
		|ГДЕ
		|	ДД.Дата МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Проведен
		|СГРУППИРОВАТЬ ПО
		|	ДД.Дата,
		|	ДД.Ссылка,
		|	ДД.Организация,
		|	Выходы.Номенклатура,
		|	Выходы.Характеристика,
		|	Выходы.Серия,
		|	Выходы.Распоряжение,
		|	Выходы.КодСтроки,
		|	Выходы.Распоряжение,
		|	Выходы.КодСтроки
		|";
КонецФункции

Функция ТекстТрудозатратыБезЗаказовРаспределение() // Использует КРаспределению
	Возврат "
		|ВЫБРАТЬ
		|	2 КАК Приоритет,
		|	""Распределение"" КАК ТипЗаписи,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) КАК ВидДвижения,
		|	ДОБАВИТЬКДАТЕ(&ОкончаниеПериода, Секунда, 2) КАК Период,
		|	НЕОПРЕДЕЛЕНО КАК Регистратор,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КАК РазделУчета,
		|	ДД.Организация,
		|	ДД.Подразделение,
		|	НЕОПРЕДЕЛЕНО КАК ЗаказНаПроизводство,
		|	0 КАК КодСтрокиПродукция,
		|	ВтВидыФондов.ВидФондаВзносов КАК ВидФондаВзносов,
		|	НЕОПРЕДЕЛЕНО КАК Спецификация,
		|	НЕОПРЕДЕЛЕНО КАК Этап,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяКалькуляции,
		|	ДД.ВидРабот,
		|	ДД.ГруппаПродукции КАК ГруппаПродукции,
		// Остаток от распределения.
		|	999999999999 КАК Знаменатель,
		|	ДД.Количество КАК КоличествоПродукции,
		|	0 КАК Количество,
		|	0 КАК НормативнаяСтоимость,
		|	0 КАК Стоимость,
		|	0 КАК СтоимостьРегл,
		|	ЛОЖЬ КАК Первичное,
		|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПустаяСсылка) КАК ХозяйственнаяОперация,
		|	НЕОПРЕДЕЛЕНО КАК Сотрудник,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаУчетаПродукции,
		|	НЕОПРЕДЕЛЕНО КАК КорРазделУчета,
		|	НЕОПРЕДЕЛЕНО КАК КорВидЗапасовПродукции,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяКалькуляцииБезЗаказа,
		|	НЕОПРЕДЕЛЕНО КАК ДокументВыпуска,
		|	НЕОПРЕДЕЛЕНО КАК КодСтроки,
		|	НЕОПРЕДЕЛЕНО КАК ДокументИсточник,
		|	НЕОПРЕДЕЛЕНО КАК Продукция,
		|	НЕОПРЕДЕЛЕНО КАК ХарактеристикаПродукции,
		|	НЕОПРЕДЕЛЕНО КАК Серия,
		|	НЕОПРЕДЕЛЕНО КАК Назначение
		|ИЗ
		|	КРаспределению КАК ДД
		|	ЛЕВОЕ СОЕДИНЕНИЕ ВтВидыФондов КАК ВтВидыФондов
		|		ПО ВтВидыФондов.Организация = ДД.Организация
		|		И ВтВидыФондов.Подразделение = ДД.Подразделение
		|		И ВтВидыФондов.ВидРабот = ДД.ВидРабот
		|";
КонецФункции
	
Функция ТекстТрудозатратыВыпускиБезЗаказов()
	Возврат "
		|ВЫБРАТЬ
		|	90 КАК Приоритет,
		|	""ВыпускБезЗаказа"" КАК ТипЗаписи,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) КАК ВидДвижения,
		|	ДД.Период,
		|	ДД.Регистратор,
		//++ НЕ УТКА
		|	(ВЫБОР
		|		КОГДА ЗаказДавальца.Ссылка ЕСТЬ NULL ТОГДА
		//-- НЕ УТКА
		|		 ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты)
		//++ НЕ УТКА
		|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КОНЕЦ)
		//-- НЕ УТКА
		|		  КАК РазделУчета,
		|	ДД.Организация,
		|	НЕОПРЕДЕЛЕНО КАК Подразделение,
		|	НЕОПРЕДЕЛЕНО КАК ЗаказНаПроизводство,
		|	0 КАК КодСтрокиПродукция,
		|	НЕОПРЕДЕЛЕНО КАК ВидФондаВзносов,
		|	НЕОПРЕДЕЛЕНО КАК Спецификация,
		|	НЕОПРЕДЕЛЕНО КАК Этап,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяКалькуляции,
		|	НЕОПРЕДЕЛЕНО КАК ВидРабот,
		|	НЕОПРЕДЕЛЕНО КАК ГруппаПродукции,
		|	СУММА(ДД.Количество) КАК Знаменатель,
		|	СУММА(ДД.Количество) КАК КоличествоПродукции,
		|	0 КАК Количество,
		|	0 КАК НормативнаяСтоимость,
		|	0 КАК Стоимость,
		|	0 КАК СтоимостьРегл,
		|	ЛОЖЬ КАК Первичное,
		|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукции) КАК ХозяйственнаяОперация,
		|	НЕОПРЕДЕЛЕНО КАК Сотрудник,
		|	ДД.АналитикаУчетаПродукции КАК КорАналитикаУчетаПродукции,
		|	(ВЫБОР
		|		КОГДА Аналитика.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Склад)
		|		 И Аналитика.СкладскаяТерритория.ЦеховаяКладовая
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты) 
		|		КОГДА Аналитика.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Склад)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыНаСкладах)
		|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты) КОНЕЦ) КАК КорРазделУчета,
		|	(ВЫБОР 
		|		КОГДА ДД.КорВидЗапасов.ТипЗапасов = ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.Услуга)
		|			ТОГДА НЕОПРЕДЕЛЕНО
		|		ИНАЧЕ ДД.КорВидЗапасов КОНЕЦ) КАК КорВидЗапасовПродукции,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяКалькуляцииБезЗаказа,
		|	ДД.Регистратор КАК ДокументВыпуска,
		|	ДД.КодСтроки КАК КодСтроки,
		|	НЕОПРЕДЕЛЕНО КАК ДокументИсточник,
		|	Аналитика.Номенклатура КАК Продукция,
		|	Аналитика.Характеристика КАК ХарактеристикаПродукции,
		|	Аналитика.Серия КАК Серия,
		|	ДД.Назначение КАК Назначение
		|ИЗ
		|	РегистрНакопления.РаспоряженияНаСписаниеПоНормативам КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК Аналитика
		|		ПО Аналитика.Ссылка = ДД.АналитикаУчетаПродукции
		|	ЛЕВОЕ СОЕДИНЕНИЕ Справочник.Назначения КАК Назначения
		|		ПО Назначения.Ссылка = ДД.Назначение
		//++ НЕ УТКА
		|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.ЗаказДавальца КАК ЗаказДавальца
		|		ПО ЗаказДавальца.Ссылка = Назначения.Заказ
		//-- НЕ УТКА
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|СГРУППИРОВАТЬ ПО
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		//++ НЕ УТКА
		|	(ВЫБОР
		|		КОГДА ЗаказДавальца.Ссылка ЕСТЬ NULL ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты)
		|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КОНЕЦ),
		//-- НЕ УТКА
		|	ДД.АналитикаУчетаПродукции,
		|	ДД.КорВидЗапасов,
		|	ДД.Назначение,
		|	ДД.КодСтроки,
		|	(ВЫБОР
		|		КОГДА Аналитика.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Склад)
		|		 И Аналитика.СкладскаяТерритория.ЦеховаяКладовая
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты) 
		|		КОГДА Аналитика.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Склад)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыНаСкладах)
		|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты) КОНЕЦ), // КорРазделУчета
		|	ДД.КодСтроки,
		|	(ВЫБОР 
		|		КОГДА ДД.КорВидЗапасов.ТипЗапасов = ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.Услуга)
		|			ТОГДА НЕОПРЕДЕЛЕНО
		|		ИНАЧЕ ДД.КорВидЗапасов КОНЕЦ),
		|	Аналитика.Номенклатура,
		|	Аналитика.Характеристика,
		|	Аналитика.Серия
		|";
КонецФункции
	
//++ НЕ УТКА	
Функция ТекстТрудозатратыОтчетыДавальцам()
	Возврат "
		|ВЫБРАТЬ
		|	95 КАК Приоритет,
		|	""ОтчетДавальцу"" КАК ТипЗаписи,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) КАК ВидДвижения,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты) КАК РазделУчета,
		|	ДД.Организация,
		|	НЕОПРЕДЕЛЕНО КАК Подразделение,
		|	НЕОПРЕДЕЛЕНО КАК ЗаказНаПроизводство,
		|	0 КАК КодСтрокиПродукция,
		|	НЕОПРЕДЕЛЕНО КАК ВидФондаВзносов,
		|	ДД.Спецификация КАК Спецификация,
		|	НЕОПРЕДЕЛЕНО КАК Этап,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяКалькуляции,
		|	НЕОПРЕДЕЛЕНО КАК ВидРабот,
		|	НЕОПРЕДЕЛЕНО КАК ГруппаПродукции,
		|	СУММА(ДД.Количество) КАК Знаменатель,
		|	СУММА(ДД.Количество) КАК КоличествоПродукции,
		|	0 КАК Количество,
		|	0 КАК НормативнаяСтоимость,
		|	0 КАК Стоимость,
		|	0 КАК СтоимостьРегл,
		|	ЛОЖЬ КАК Первичное,
		|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукции) КАК ХозяйственнаяОперация,
		|	НЕОПРЕДЕЛЕНО КАК Сотрудник,
		|	ДД.АналитикаУчетаНоменклатуры КАК КорАналитикаУчетаПродукции,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты) КАК КорРазделУчета,
		|	ДД.ВидЗапасов КАК КорВидЗапасовПродукции,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяКалькуляцииБезЗаказа,
		|	ДД.Регистратор КАК ДокументВыпуска,
		|	ДД.КодСтроки КАК КодСтроки,
		|	НЕОПРЕДЕЛЕНО КАК ДокументИсточник,
		|	Аналитика.Номенклатура КАК Продукция,
		|	Аналитика.Характеристика КАК ХарактеристикаПродукции,
		|	Аналитика.Серия КАК Серия,
		|	ДД.АналитикаУчетаНоменклатуры.Назначение КАК Назначение
		|ИЗ
		|	РегистрНакопления.ВыпускПродукции КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК Аналитика
		|		ПО Аналитика.Ссылка = ДД.АналитикаУчетаНоменклатуры
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И ДД.Регистратор ССЫЛКА Документ.ОтчетДавальцу
		|СГРУППИРОВАТЬ ПО
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.КодСтроки,
		|	ДД.Организация,
		|	ДД.Спецификация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов,
		|	ДД.АналитикаУчетаНоменклатуры.Назначение,
		|	Аналитика.Номенклатура,
		|	Аналитика.Характеристика,
		|	Аналитика.Серия
		|";
КонецФункции
	
Функция ТекстТрудозатратыДавальческиеПолуфабрикаты() // использует ДолиСтоимости
	Возврат "
		|ВЫБРАТЬ
		|	10 КАК Приоритет,
		|	""ПолуфабрикатДавальца"" КАК ТипЗаписи,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КАК РазделУчета,
		|	ДД.Организация,
		|	Аналитика.МестоХранения КАК Подразделение,
		|	ДД.ЗаказНаПроизводство,
		|	ДД.КодСтрокиПродукция,
		|	НЕОПРЕДЕЛЕНО КАК ВидФондаВзносов,
		|	Этапы.Владелец КАК Спецификация,
		|	ДД.Этап,
		|	ДД.СтатьяКалькуляции,
		|	НЕОПРЕДЕЛЕНО КАК ВидРабот,
		|	НЕОПРЕДЕЛЕНО КАК ГруппаПродукции,
		|	СУММА(ДД.Количество) КАК Знаменатель,
		|	МАКСИМУМ(ЕСТЬNULL(Доли.ДоляСтоимости, 1)) КАК КоличествоПродукции,
		|	0 КАК Количество,
		|	0 КАК НормативнаяСтоимость,
		|	0 КАК Стоимость,
		|	0 КАК СтоимостьРегл,
		|	ИСТИНА КАК Первичное,
		|	НЕОПРЕДЕЛЕНО КАК ХозяйственнаяОперация,
		|	НЕОПРЕДЕЛЕНО КАК Сотрудник,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаУчетаПродукции,
		|	НЕОПРЕДЕЛЕНО КАК КорРазделУчета,
		|	НЕОПРЕДЕЛЕНО КАК КорВидЗапасовПродукции,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяКалькуляцииБезЗаказа,
		|	НЕОПРЕДЕЛЕНО КАК ДокументВыпуска,
		|	НЕОПРЕДЕЛЕНО КАК КодСтроки,
		|	НЕОПРЕДЕЛЕНО КАК ДокументИсточник,
		|	Аналитика.Номенклатура КАК Продукция,
		|	Аналитика.Характеристика КАК ХарактеристикаПродукции,
		|	НЕОПРЕДЕЛЕНО КАК Серия,
		|	ДД.АналитикаУчетаНоменклатуры.Назначение КАК Назначение
		|ИЗ
		|	РегистрНакопления.ПартииПроизводственныхЗатрат КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ЭтапыПроизводства КАК Этапы
		|		ПО Этапы.Ссылка = ДД.Этап
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК Аналитика
		|		ПО Аналитика.Ссылка = ДД.АналитикаУчетаНоменклатуры
		|	ЛЕВОЕ СОЕДИНЕНИЕ ДолиСтоимости КАК Доли
		|		ПО Доли.ЗаказНаПроизводство = ДД.ЗаказНаПроизводство
		|		И Доли.КодСтрокиПродукция = ДД.КодСтрокиПродукция
		|		И Доли.Спецификация = Этапы.Владелец
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		|	И ДД.СтатьяКалькуляции <> ЗНАЧЕНИЕ(Справочник.СтатьиКалькуляции.ПустаяСсылка)
		|	И ДД.ВидЗапасов.ТипЗапасов = ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.ПолуфабрикатДавальца)
		|	И ДД.ДокументПоступления ССЫЛКА Документ.ВыпускПродукции
		|СГРУППИРОВАТЬ ПО
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	Аналитика.МестоХранения,
		|	ДД.ЗаказНаПроизводство,
		|	ДД.КодСтрокиПродукция,
		|	Этапы.Владелец,
		|	ДД.Этап,
		|	ДД.СтатьяКалькуляции,
		|	ДД.АналитикаУчетаНоменклатуры.Назначение,
		|	Аналитика.Номенклатура,
		|	Аналитика.Характеристика
		|";
КонецФункции	
//-- НЕ УТКА
#КонецОбласти


#Область РасчетПрочихРасходовНезавершенногоПроизводстваПоБазе

// В партионном учете версии 2.2 - этап 16, РаспределениеПостатейныхРасходовПоБазе

#Область РасходыКРаспределению

Функция ДанныеДляРасходовКРаспределению(НачалоПериода, ОкончаниеПериода, МассивОрганизаций)
	
	ТекстСортировка = "
		|УПОРЯДОЧИТЬ ПО
		|	Регистратор, ТипЗаписи
		|";
	ИсходныйТекстЗапроса =
		ТекстРасходыКРаспределениюИнициализация() + ";" // вт ВТПриход, ВТПоступило, ДолиСтоимости, ДолиСписанияКосвенныхРасходов
		+ ТекстОписаниеДанныхДляРасходовКРаспределению()
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстРасходыКРаспределениюПартия() // использует ВТПоступило, ДолиСтоимости, ДолиСписанияКосвенныхРасходов
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстРасходыКРаспределениюПотребление() // использует ДолиСтоимости
		+ ТекстСортировка;
	ИсходныйЗапрос = Новый Запрос(ИсходныйТекстЗапроса);
	ИсходныйЗапрос.УстановитьПараметр("НачалоПериода", НачалоПериода);
	ИсходныйЗапрос.УстановитьПараметр("ОкончаниеПериода", ОкончаниеПериода);
	ИсходныйЗапрос.УстановитьПараметр("КонецПериода",  ОкончаниеПериода);
	ИсходныйЗапрос.УстановитьПараметр("ГраницаКонецПериода", Новый Граница(ОкончаниеПериода, ВидГраницы.Включая));
	ИсходныйЗапрос.УстановитьПараметр("МассивОрганизаций", МассивОрганизаций);	
	ИсходныйЗапрос.УстановитьПараметр("МассивНормируемыхРасходов", Перечисления.ВидыРасходовНУ.НормируемыеРасходы());
	ИсходныйЗапрос.УстановитьПараметр("СписокПодразделений", Неопределено);
	ИсходныйЗапрос.УстановитьПараметр("ПоВсемОрганизациям", Ложь);
	ИсходныйЗапрос.УстановитьПараметр("ПоВсемПодразделениям", Истина);
	ИсходныйЗапрос.УстановитьПараметр("ВариантыРаспределенияРасходов", 
		ОбщегоНазначенияУТКлиентСервер.Массив(Перечисления.ВариантыРаспределенияРасходов.НаПроизводственныеЗатраты));
	ДанныеДляРасчета = ИсходныйЗапрос.Выполнить();
	Возврат ДанныеДляРасчета;
	
КонецФункции

Функция РасчетныеРасходыКРаспределению(ДанныеДляРасчета, Регистраторы, ВнутренниеДанные = Неопределено, Тест = Истина, КоличествоЗаписей = 0)
	
	// Шаг 1: создаем буфер накопления рассчитанных данных
	Запрос = Новый Запрос(ТекстОписаниеДанныхДляРасходовКРаспределению());
	РасчетныеДанные = Запрос.Выполнить().Выгрузить();
	КоличествоЗаписей = РасчетныеДанные.Количество();
	
	// Шаг 2: готовим описание обсчета
	КонтекстЦепочек = ОписаниеЦепочек("Партия, Потребление");
	
	ПоляПотреблений = "Регистратор";
	КонтекстДвижений = ОписаниеДвижений(
		"ПрочиеРасходыНезавершенногоПроизводстваПоБазе",
		"ПрочиеРасходыНезавершенногоПроизводства",
		ПереченьПолей(РасчетныеДанные.Колонки),
		ПоляПотреблений,
		"Партия",
		"Знаменатель", "Знаменатель", "", "Регистратор");
	
	// Шаг 3: обсчитываем потребления из партий
	ДобавитьОписаниеПриемника(КонтекстЦепочек, "Потребление", ПоляПотреблений);
	ДобавитьОписаниеИсточника(КонтекстЦепочек, "Потребление", "Партия", ПоляПотреблений);
	
	ЦепочкиДвижений = ЦепочкиДвиженийЗапросом(КонтекстЦепочек, ДанныеДляРасчета);
	РассчитатьПартииПоЦепочкамИзВыборки(КонтекстДвижений, ДанныеДляРасчета, РасчетныеДанные, ЦепочкиДвижений, Регистраторы, Тест);

	// Шаг 4: Удаляем строки, не требующие записи в базу.
	УдалитьНезаписываемыеСтроки(КонтекстДвижений.Контекст, РасчетныеДанные);
	
	// Шаг 5: Сортировка партий для дальнейшей записи
	РасчетныеДанные.Сортировать("Регистратор", Новый СравнениеЗначений);
	Возврат РасчетныеДанные;
	
КонецФункции

Функция ТекстРасходыКРаспределениюИнициализация() // вт ВТПриход, ВТПоступило, ДолиСтоимости, ДолиСписанияКосвенныхРасходов
	Возврат Документы.РаспределениеПрочихЗатрат.ТекстЗапросаПоступилоПрочихРасходов()
	+ ТекстДолиСтоимости() + ";" 
	+ ТекстДолиСтоимостиВручнуюПоСтатьям() + ";" + "
	|ВЫБРАТЬ
	|	Расходы.Организация КАК Организация,
	|	Расходы.Подразделение КАК Подразделение,
	|	Расходы.НаправлениеДеятельности КАК НаправлениеДеятельности,
	|	Расходы.СтатьяРасходов КАК СтатьяРасходов,
	|	Расходы.АналитикаРасходов КАК АналитикаРасходов,
	|	СУММА(
	|		ВЫБОР
	|			КОГДА Расходы.СтатьяРасходов.ВариантРаспределенияРасходовУпр = ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаПроизводственныеЗатраты)
	|				ТОГДА Расходы.Сумма
	|			ИНАЧЕ
	|				0
	|		КОНЕЦ) КАК Сумма,
	|	СУММА(
	|		ВЫБОР
	|			КОГДА Расходы.СтатьяРасходов.ВариантРаспределенияРасходовУпр = ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаПроизводственныеЗатраты)
	|				ТОГДА Расходы.СуммаБезНДС
	|			ИНАЧЕ
	|				0
	|		КОНЕЦ) КАК СуммаБезНДС,
	|	СУММА(
	|		ВЫБОР
	|			КОГДА Расходы.СтатьяРасходов.ВариантРаспределенияРасходовРегл = ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаПроизводственныеЗатраты)
	|				ТОГДА Расходы.СуммаРегл
	|			ИНАЧЕ
	|				0
	|		КОНЕЦ) КАК СуммаРегл,
	|	СУММА(
	|		ВЫБОР
	|			КОГДА Расходы.СтатьяРасходов.ВариантРаспределенияРасходовРегл = ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаПроизводственныеЗатраты)
	|				ТОГДА Расходы.ПостояннаяРазница
	|			ИНАЧЕ
	|				0
	|		КОНЕЦ) КАК ПостояннаяРазница,
	|	СУММА(
	|		ВЫБОР
	|			КОГДА Расходы.СтатьяРасходов.ВариантРаспределенияРасходовРегл = ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаПроизводственныеЗатраты)
	|				ТОГДА Расходы.ВременнаяРазница
	|			ИНАЧЕ
	|				0
	|		КОНЕЦ) КАК ВременнаяРазница,
	|	СУММА(
	|		ВЫБОР
	|			КОГДА Расходы.СтатьяРасходов.ВариантРаспределенияРасходовУпр = ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаПроизводственныеЗатраты)
	|				ТОГДА Расходы.СуммаУпр
	|			ИНАЧЕ
	|				0
	|		КОНЕЦ) КАК СуммаУпр
	|ПОМЕСТИТЬ ОбработанныеРасходы
	|ИЗ
	|	(ВЫБРАТЬ
	|		Расходы.Организация КАК Организация,
	|		Расходы.Подразделение КАК Подразделение,
	|		Расходы.НаправлениеДеятельности КАК НаправлениеДеятельности,
	|		Расходы.СтатьяРасходов КАК СтатьяРасходов,
	|		Расходы.АналитикаРасходов КАК АналитикаРасходов,
	|		Расходы.Сумма КАК Сумма,
	|		Расходы.СуммаБезНДС КАК СуммаБезНДС,
	|		Расходы.СуммаРегл КАК СуммаРегл,
	|		Расходы.ПостояннаяРазница КАК ПостояннаяРазница,
	|		Расходы.ВременнаяРазница КАК ВременнаяРазница,
	|		Расходы.СуммаУпр КАК СуммаУпр
	|	ИЗ
	|		РасходыКРаспределению КАК Расходы
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		Расходы.Организация,
	|		Расходы.Подразделение,
	|		Расходы.НаправлениеДеятельности,
	|		Расходы.СтатьяРасходов,
	|		Расходы.АналитикаРасходов,
	|		ВЫБОР
	|			КОГДА Расходы.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|				ТОГДА -1
	|			ИНАЧЕ
	|				1
	|		КОНЕЦ * Расходы.Сумма,
	|		ВЫБОР
	|			КОГДА Расходы.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|				ТОГДА -1
	|			ИНАЧЕ
	|				1
	|		КОНЕЦ * Расходы.СуммаБезНДС,
	|		ВЫБОР
	|			КОГДА Расходы.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|				ТОГДА -1
	|			ИНАЧЕ
	|				1
	|		КОНЕЦ * Расходы.СуммаРегл,
	|		ВЫБОР
	|			КОГДА Расходы.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|				ТОГДА -1
	|			ИНАЧЕ
	|				1
	|		КОНЕЦ * Расходы.ПостояннаяРазница,
	|		ВЫБОР
	|			КОГДА Расходы.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|				ТОГДА -1
	|			ИНАЧЕ
	|				1
	|		КОНЕЦ * Расходы.ВременнаяРазница,
	|		ВЫБОР
	|			КОГДА Расходы.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|				ТОГДА -1
	|			ИНАЧЕ
	|				1
	|		КОНЕЦ * Расходы.СуммаУпр
	|	ИЗ
	|		РегистрНакопления.ПрочиеРасходы КАК Расходы
	|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ РасходыКРаспределению КАК РасходыКРаспределению
	|			ПО Расходы.Организация = РасходыКРаспределению.Организация
	|				И Расходы.Подразделение = РасходыКРаспределению.Подразделение
	|				И Расходы.НаправлениеДеятельности = РасходыКРаспределению.НаправлениеДеятельности
	|				И Расходы.СтатьяРасходов = РасходыКРаспределению.СтатьяРасходов
	|				И Расходы.АналитикаРасходов = РасходыКРаспределению.АналитикаРасходов
	|	ГДЕ
	|		Расходы.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
	|		И Расходы.Активность
	|		И (Расходы.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|			ИЛИ ТИПЗНАЧЕНИЯ(Расходы.Регистратор) = ТИП(Документ.РасчетСебестоимостиТоваров))
	|		И Расходы.РасчетСебестоимости) КАК Расходы
	|
	|СГРУППИРОВАТЬ ПО
	|	Расходы.СтатьяРасходов,
	|	Расходы.АналитикаРасходов,
	|	Расходы.Организация,
	|	Расходы.Подразделение,
	|	Расходы.НаправлениеДеятельности
	|;
	|
	|ВЫБРАТЬ
	|	Доли.Организация,
	|	СУММА(Доли.ДоляРасходовНаРекламу) КАК ДоляРасходовНаРекламу,
	|	СУММА(Доли.ДоляПредставительскихРасходов) КАК ДоляПредставительскихРасходов,
	|	СУММА(Доли.ДоляРасходовНаДобровольноеМедицинскоеСтрахование) КАК ДоляРасходовНаДобровольноеМедицинскоеСтрахование,
	|	СУММА(Доли.ДоляРасходовНаДобровольноеСтрахованиеЖизни) КАК ДоляРасходовНаДобровольноеСтрахованиеЖизни,
	|	СУММА(Доли.ДоляРасходовНаДобровольноеСтрахованиеОтНесчастныхСлучаев) КАК ДоляРасходовНаДобровольноеСтрахованиеОтНесчастныхСлучаев,
	|	СУММА(Доли.ДоляРасходовНаВозмещениеПроцентовРаботникам) КАК ДоляРасходовНаВозмещениеПроцентовРаботникам
	|ПОМЕСТИТЬ
	|	ДолиСписанияКосвенныхРасходов
	|ИЗ
	|	РегистрСведений.ДолиСписанияКосвенныхРасходов КАК Доли
	|ГДЕ
	|	Доли.ПериодРасчета МЕЖДУ &НачалоПериода И &ОкончаниеПериода
	|	И Доли.Организация В (ВЫБРАТЬ РАЗЛИЧНЫЕ Т.ГоловнаяОрганизация ИЗ Справочник.Организации КАК Т ГДЕ Т.Ссылка В (&МассивОрганизаций))
	|	И Доли.Активность
	|СГРУППИРОВАТЬ ПО
	|	Доли.Организация
	|";
КонецФункции

Функция ТекстОписаниеДанныхДляРасходовКРаспределению()
	Возврат "
	|ВЫБРАТЬ ПЕРВЫЕ 0
	|	0 КАК Приоритет,
	|	""ХХХХХХХХХХХХХХХХХХХХ"" КАК ТипЗаписи,
	|	ЛОЖЬ КАК РасчетЗавершен,
	|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КАК РазделУчета,
	|	Т.Регистратор КАК Регистратор,
	|	Т.СтатьяКалькуляции КАК СтатьяКалькуляции,
	|	""ХХХХХХХХХХХХХХХХХХХХ"" КАК Направление,
	|	0 КАК Знаменатель,
	|	0 КАК ДоляСтоимости,
	|	0 КАК Стоимость,
	|	0 КАК СтоимостьБезНДС,
	|	0 КАК СтоимостьРегл,
	|	0 КАК ПостояннаяРазница,
	|	0 КАК ВременнаяРазница
	|ИЗ
	|	РегистрНакопления.ПрочиеРасходыНезавершенногоПроизводства КАК Т
	|";
КонецФункции

Функция ТекстДолиСтоимости() //вт ДолиСтоимости
	Возврат "
	|ВЫБРАТЬ
	|	Т.Регистратор КАК Регистратор,
	|	Т.СтатьяКалькуляции КАК СтатьяКалькуляции,
	|	СУММА(Т.ПоПравилам + Т.ПоБазе) КАК ДоляСтоимостиПоПравилам,
	|	СУММА(Т.Вручную + Т.ВыпускиБезРаспоряжения) КАК ВсегоДолейСтоимостиВручную,
	|	СУММА(Т.Списание) КАК ВсегоДолейСтоимостиСписание,
	|	СУММА(Т.ПоПравилам + Т.ПоБазе + Т.Вручную + Т.ВыпускиБезРаспоряжения + Т.Списание) КАК ВсегоДолейСтоимости
	|ПОМЕСТИТЬ
	|	ДолиСтоимости
	|ИЗ (
	|	ВЫБРАТЬ
	|		Т.Ссылка КАК Регистратор,
	|		Т.СтатьяКалькуляции КАК СтатьяКалькуляции,
	|		ВЫБОР 
	|			КОГДА Т.ДоляСтоимостиНаПроизводство = 0
	|				И Т.ВсегоДолейСтоимости = 0
	|				ТОГДА 100
	|			ИНАЧЕ
	|				Т.ДоляСтоимостиНаПроизводство
	|		КОНЕЦ КАК ПоПравилам,
	|		0 КАК ПоБазе,
	|		0 КАК Вручную,
	|		0 КАК ВыпускиБезРаспоряжения,
	|		0 КАК Списание
	|	ИЗ
	|		Документ.РаспределениеПрочихЗатрат КАК Т
	|	ГДЕ
	|		Т.Дата МЕЖДУ &НачалоПериода И &ОкончаниеПериода
	|		И Т.Проведен
	|		И Т.РаспределятьПоПартиям
	|		И НЕ Т.ПартииУказаныВручную
	|		И НЕ Т.ПодразделенияУказаныВручную
	|
	|	ОБЪЕДИНИТЬ ВСЕ
	|
	|	ВЫБРАТЬ
	|		Т.Ссылка КАК Регистратор,
	|		ДД.СтатьяКалькуляции КАК СтатьяКалькуляции,
	|		0 КАК ПоПравилам,
	|		Т.ДоляСтоимости КАК ПоБазе,
	|		0 КАК Вручную,
	|		0 КАК ВыпускиБезРаспоряжения,
	|		0 КАК Списание
	|	ИЗ
	|		Документ.РаспределениеПрочихЗатрат.ПоБазе КАК Т
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.РаспределениеПрочихЗатрат КАК ДД
	|		ПО Т.Ссылка = ДД.Ссылка
	|			И ДД.Дата МЕЖДУ &НачалоПериода И &ОкончаниеПериода
	|			И ДД.Проведен
	|
	|	ОБЪЕДИНИТЬ ВСЕ
	|
	|	ВЫБРАТЬ
	|		Т.Ссылка КАК Регистратор,
	|		ДД.СтатьяКалькуляции КАК СтатьяКалькуляции,
	|		0 КАК ПоПравилам,
	|		0 КАК ПоБазе,
	|		Т.ДоляСтоимости КАК Вручную,
	|		0 КАК ВыпускиБезРаспоряжения,
	|		0 КАК Списание
	|	ИЗ
	|		Документ.РаспределениеПрочихЗатрат.Вручную КАК Т
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.РаспределениеПрочихЗатрат КАК ДД
	|		ПО Т.Ссылка = ДД.Ссылка
	|			И ДД.Дата МЕЖДУ &НачалоПериода И &ОкончаниеПериода
	|			И ДД.Проведен
	|
	|	ОБЪЕДИНИТЬ ВСЕ
	|
	|	ВЫБРАТЬ
	|		Т.Ссылка КАК Регистратор,
	|		ДД.СтатьяКалькуляции КАК СтатьяКалькуляции,
	|		0 КАК ПоПравилам,
	|		0 КАК ПоБазе,
	|		0 КАК Вручную,
	|		Т.ДоляСтоимости КАК ВыпускиБезРаспоряжения,
	|		0 КАК Списание
	|	ИЗ
	|		Документ.РаспределениеПрочихЗатрат.ВыпускиБезРаспоряжения КАК Т
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.РаспределениеПрочихЗатрат КАК ДД
	|		ПО Т.Ссылка = ДД.Ссылка
	|			И ДД.Дата МЕЖДУ &НачалоПериода И &ОкончаниеПериода
	|			И ДД.Проведен
	|
	|	ОБЪЕДИНИТЬ ВСЕ
	|
	|	ВЫБРАТЬ
	|		Т.Ссылка КАК Регистратор,
	|		ДД.СтатьяКалькуляции КАК СтатьяКалькуляции,
	|		0 КАК ПоПравилам,
	|		0 КАК ПоБазе,
	|		0 КАК Вручную,
	|		0 КАК ВыпускиБезРаспоряжения,
	|		Т.ДоляСтоимости КАК Списание
	|	ИЗ
	|		Документ.РаспределениеПрочихЗатрат.Списание КАК Т
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.РаспределениеПрочихЗатрат КАК ДД
	|		ПО Т.Ссылка = ДД.Ссылка
	|			И ДД.Дата МЕЖДУ &НачалоПериода И &ОкончаниеПериода
	|			И ДД.Проведен
	|	) КАК Т
	|СГРУППИРОВАТЬ ПО
	|	Т.Регистратор,
	|	Т.СтатьяКалькуляции
	|";
КонецФункции

Функция ТекстДолиСтоимостиВручнуюПоСтатьям() //вт ДолиСтоимостиВручнуюПоСтатьям
	Возврат "
	|ВЫБРАТЬ
	|	Т.Регистратор,
	|	Т.СтатьяКалькуляции,
	|	СУММА(Т.Вручную + Т.ВыпускиБезРаспоряжения) КАК ВсегоДолейСтоимостиВручную
	|ПОМЕСТИТЬ
	|	ДолиСтоимостиВручнуюПоСтатьям
	|ИЗ (
	|	ВЫБРАТЬ
	|		Т.Ссылка КАК Регистратор,
	|		Т.СтатьяКалькуляции КАК СтатьяКалькуляции,
	|		Т.ДоляСтоимости КАК Вручную,
	|		0 КАК ВыпускиБезРаспоряжения
	|	ИЗ
	|		Документ.РаспределениеПрочихЗатрат.Вручную КАК Т
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.РаспределениеПрочихЗатрат КАК ДД
	|		ПО Т.Ссылка = ДД.Ссылка
	|			И ДД.Дата МЕЖДУ &НачалоПериода И &ОкончаниеПериода
	|			И ДД.Проведен
	|
	|	ОБЪЕДИНИТЬ ВСЕ
	|
	|	ВЫБРАТЬ
	|		Т.Ссылка КАК Регистратор,
	|		Т.СтатьяКалькуляции КАК СтатьяКалькуляции,
	|		0 КАК Вручную,
	|		Т.ДоляСтоимости КАК ВыпускиБезРаспоряжения
	|	ИЗ
	|		Документ.РаспределениеПрочихЗатрат.ВыпускиБезРаспоряжения КАК Т
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.РаспределениеПрочихЗатрат КАК ДД
	|		ПО Т.Ссылка = ДД.Ссылка
	|			И ДД.Дата МЕЖДУ &НачалоПериода И &ОкончаниеПериода
	|			И ДД.Проведен
	|	) КАК Т
	|СГРУППИРОВАТЬ ПО
	|	Т.СтатьяКалькуляции,
	|	Т.Регистратор
	|";
КонецФункции

Функция ТекстРасходыКРаспределениюПартия() // использует ВТПоступило, ДолиСтоимости, ДолиСписанияКосвенныхРасходов
	Возврат "
	|ВЫБРАТЬ
	|	10 КАК Приоритет,
	|	""Партия"" КАК ТипЗаписи,
	|	ИСТИНА КАК РасчетЗавершен,
	|	НЕОПРЕДЕЛЕНО КАК РазделУчета,
	|	ДД.Ссылка КАК Регистратор,
	|	НЕОПРЕДЕЛЕНО КАК СтатьяКалькуляции,
	|	"""" КАК Направление,
	|	ДолиСтоимости.ВсегоДолейСтоимости КАК Знаменатель,
	|	ДолиСтоимости.ВсегоДолейСтоимости КАК ДоляСтоимости,
	|	Т.Сумма КАК Стоимость,
	|	Т.СуммаБезНДС КАК СтоимостьБезНДС,
	|	Т.СуммаРегл КАК СтоимостьРегл,
	|	ВЫБОР
	|		КОГДА СР.ВидРасходов В (&МассивНормируемыхРасходов) // Косвенные расходы
	|				ИЛИ СР.ВариантРаспределенияРасходовНУ = ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаНаправленияДеятельности)
	|			ТОГДА ВЫБОР
	|					КОГДА СР.ВидРасходов В (&МассивНормируемыхРасходов) ТОГДА // Нормируемые расходы
	|						ВЫБОР СР.ВидРасходов
	|							КОГДА ЗНАЧЕНИЕ(Перечисление.ВидыРасходовНУ.РасходыНаРекламуНормируемые)
	|								ТОГДА (Т.СуммаРегл - Т.ПостояннаяРазница
	|									  - Т.ВременнаяРазница) * (1 - ЕСТЬNULL(ДолиСписания.ДоляРасходовНаРекламу, 0))
	|							КОГДА ЗНАЧЕНИЕ(Перечисление.ВидыРасходовНУ.ПредставительскиеРасходы)
	|								ТОГДА (Т.СуммаРегл - Т.ПостояннаяРазница
	|									  - Т.ВременнаяРазница) * (1 - ЕСТЬNULL(ДолиСписания.ДоляПредставительскихРасходов, 0))
	|							КОГДА ЗНАЧЕНИЕ(Перечисление.ВидыРасходовНУ.ДобровольноеЛичноеСтрахование)
	|								ТОГДА (Т.СуммаРегл - Т.ПостояннаяРазница
	|									  - Т.ВременнаяРазница) * (1 - ЕСТЬNULL(ДолиСписания.ДоляРасходовНаДобровольноеМедицинскоеСтрахование, 0))
	|							КОГДА ЗНАЧЕНИЕ(Перечисление.ВидыРасходовНУ.ДобровольноеСтрахованиеПоДоговорамДолгосрочногоСтрахованияЖизниРаботников)
	|								ТОГДА (Т.СуммаРегл - Т.ПостояннаяРазница
	|									  - Т.ВременнаяРазница) * (1 - ЕСТЬNULL(ДолиСписания.ДоляРасходовНаДобровольноеСтрахованиеЖизни, 0))
	|							КОГДА ЗНАЧЕНИЕ(Перечисление.ВидыРасходовНУ.ДобровольноеЛичноеСтрахованиеНаСлучайСмертиИлиУтратыРаботоспособности)
	|								ТОГДА(Т.СуммаРегл - Т.ПостояннаяРазница
	|									  - Т.ВременнаяРазница) * (1 - ЕСТЬNULL(ДолиСписания.ДоляРасходовНаДобровольноеСтрахованиеОтНесчастныхСлучаев, 0))
	|							КОГДА ЗНАЧЕНИЕ(Перечисление.ВидыРасходовНУ.РасходыНаВозмещениеЗатратРаботниковПоУплатеПроцентов)
	|								ТОГДА (Т.СуммаРегл - Т.ПостояннаяРазница
	|									  - Т.ВременнаяРазница) * (1 - ЕСТЬNULL(ДолиСписания.ДоляРасходовНаВозмещениеПроцентовРаботникам, 0))
	|						КОНЕЦ
	|					ИНАЧЕ
	|						Т.ПостояннаяРазница
	|				 КОНЕЦ
	|		ИНАЧЕ Т.ПостояннаяРазница
	|	КОНЕЦ КАК ПостояннаяРазница,
	|	ВЫБОР
	|		КОГДА СР.ВидРасходов В (&МассивНормируемыхРасходов) // Косвенные расходы
	|				ИЛИ СР.ВариантРаспределенияРасходовНУ = ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаНаправленияДеятельности)
	|			ТОГДА ВЫБОР
	|					КОГДА СР.ВидРасходов В (&МассивНормируемыхРасходов) ТОГДА // Нормируемые расходы
	|						ВЫБОР СР.ВидРасходов
	|							КОГДА ЗНАЧЕНИЕ(Перечисление.ВидыРасходовНУ.РасходыНаРекламуНормируемые)
	|								ТОГДА Т.СуммаРегл - (Т.СуммаРегл - Т.ПостояннаяРазница - Т.ВременнаяРазница)
	|									  * (1 - ЕСТЬNULL(ДолиСписания.ДоляРасходовНаРекламу, 0))
	|							КОГДА ЗНАЧЕНИЕ(Перечисление.ВидыРасходовНУ.ПредставительскиеРасходы)
	|								ТОГДА Т.СуммаРегл - (Т.СуммаРегл - Т.ПостояннаяРазница - Т.ВременнаяРазница)
	|									  * (1 - ЕСТЬNULL(ДолиСписания.ДоляПредставительскихРасходов, 0))
	|							КОГДА ЗНАЧЕНИЕ(Перечисление.ВидыРасходовНУ.ДобровольноеЛичноеСтрахование)
	|								ТОГДА Т.СуммаРегл - (Т.СуммаРегл - Т.ПостояннаяРазница - Т.ВременнаяРазница)
	|									  * (1 - ЕСТЬNULL(ДолиСписания.ДоляРасходовНаДобровольноеМедицинскоеСтрахование, 0))
	|							КОГДА ЗНАЧЕНИЕ(Перечисление.ВидыРасходовНУ.ДобровольноеСтрахованиеПоДоговорамДолгосрочногоСтрахованияЖизниРаботников)
	|								ТОГДА Т.СуммаРегл - (Т.СуммаРегл - Т.ПостояннаяРазница - Т.ВременнаяРазница)
	|									  * (1 - ЕСТЬNULL(ДолиСписания.ДоляРасходовНаДобровольноеСтрахованиеЖизни, 0))
	|							КОГДА ЗНАЧЕНИЕ(Перечисление.ВидыРасходовНУ.ДобровольноеЛичноеСтрахованиеНаСлучайСмертиИлиУтратыРаботоспособности)
	|								ТОГДА Т.СуммаРегл - (Т.СуммаРегл - Т.ПостояннаяРазница - Т.ВременнаяРазница)
	|									  * (1 - ЕСТЬNULL(ДолиСписания.ДоляРасходовНаДобровольноеСтрахованиеОтНесчастныхСлучаев, 0))
	|							КОГДА ЗНАЧЕНИЕ(Перечисление.ВидыРасходовНУ.РасходыНаВозмещениеЗатратРаботниковПоУплатеПроцентов)
	|								ТОГДА Т.СуммаРегл - (Т.СуммаРегл - Т.ПостояннаяРазница - Т.ВременнаяРазница)
	|									  * (1 - ЕСТЬNULL(ДолиСписания.ДоляРасходовНаВозмещениеПроцентовРаботникам, 0))
	|						КОНЕЦ
	|					ИНАЧЕ
	|						(Т.СуммаРегл - Т.ПостояннаяРазница)
	|				 КОНЕЦ
	|		ИНАЧЕ Т.ВременнаяРазница
	|	КОНЕЦ КАК ВременнаяРазница
	|ИЗ
	|	Документ.РаспределениеПрочихЗатрат КАК ДД
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ОбработанныеРасходы КАК Т
	|	ПО Т.Организация = ДД.Организация
	|		И Т.Подразделение = ДД.Подразделение
	|		И Т.НаправлениеДеятельности = ДД.НаправлениеДеятельности
	|		И Т.СтатьяРасходов = ДД.СтатьяРасходов
	|		И Т.АналитикаРасходов = ДД.АналитикаРасходов
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ДолиСтоимости КАК ДолиСтоимости
	|		ПО ДолиСтоимости.Регистратор = ДД.Ссылка
	|	ЛЕВОЕ СОЕДИНЕНИЕ ДолиСписанияКосвенныхРасходов КАК ДолиСписания
	|		ПО ДолиСписания.Организация = ДД.Организация.ГоловнаяОрганизация
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ПланВидовХарактеристик.СтатьиРасходов КАК СР
	|		ПО СР.Ссылка = ДД.СтатьяРасходов
	|ГДЕ
	|	ДД.Дата МЕЖДУ &НачалоПериода И &ОкончаниеПериода
	|	И ДД.Организация В (&МассивОрганизаций)
	|	И ДД.Проведен
	|";
КонецФункции

Функция ТекстРасходыКРаспределениюПотребление() // использует ДолиСтоимости
	Возврат "
	|ВЫБРАТЬ
	|	20 КАК Приоритет,
	|	""Потребление"" КАК ТипЗаписи,
	|	ЛОЖЬ КАК РасчетЗавершен,
	|	НЕОПРЕДЕЛЕНО КАК РазделУчета,
	|	Доли.Регистратор КАК Регистратор,
	|	Доли.СтатьяКалькуляции КАК СтатьяКалькуляции,
	|	""ПоПравилам"" КАК Направление,
	|	Доли.ДоляСтоимостиПоПравилам КАК Знаменатель,
	|	Доли.ДоляСтоимостиПоПравилам КАК ДоляСтоимости,
	|	0 КАК Стоимость,
	|	0 КАК СтоимостьБезНДС,
	|	0 КАК СтоимостьРегл,
	|	0 КАК ПостояннаяРазница,
	|	0 КАК ВременнаяРазница
	|ИЗ
	|	ДолиСтоимости КАК Доли
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	20 КАК Приоритет,
	|	""Потребление"" КАК ТипЗаписи,
	|	ЛОЖЬ КАК РасчетЗавершен,
	|	НЕОПРЕДЕЛЕНО КАК РазделУчета,
	|	Доли.Регистратор КАК Регистратор,
	|	Доли.СтатьяКалькуляции КАК СтатьяКалькуляции,
	|	""Вручную"" КАК Направление,
	|	Доли.ВсегоДолейСтоимостиВручную КАК Знаменатель,
	|	Доли.ВсегоДолейСтоимостиВручную КАК ДоляСтоимости,
	|	0 КАК Стоимость,
	|	0 КАК СтоимостьБезНДС,
	|	0 КАК СтоимостьРегл,
	|	0 КАК ПостояннаяРазница,
	|	0 КАК ВременнаяРазница
	|ИЗ
	|	ДолиСтоимостиВручнуюПоСтатьям КАК Доли
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	20 КАК Приоритет,
	|	""Потребление"" КАК ТипЗаписи,
	|	ЛОЖЬ КАК РасчетЗавершен,
	|	НЕОПРЕДЕЛЕНО КАК РазделУчета,
	|	Доли.Регистратор КАК Регистратор,
	|	Доли.СтатьяКалькуляции КАК СтатьяКалькуляции,
	|	""Списание"" КАК Направление,
	|	Доли.ВсегоДолейСтоимостиСписание КАК Знаменатель,
	|	Доли.ВсегоДолейСтоимостиСписание КАК ДоляСтоимости,
	|	0 КАК Стоимость,
	|	0 КАК СтоимостьБезНДС,
	|	0 КАК СтоимостьРегл,
	|	0 КАК ПостояннаяРазница,
	|	0 КАК ВременнаяРазница
	|ИЗ
	|	ДолиСтоимости КАК Доли
	|";
КонецФункции

#КонецОбласти

#Область ПоПодразделениям

Функция ДанныеДляПрочихРасходовНЗППоПодразделениямПоБазе(НачалоПериода, ОкончаниеПериода, МассивОрганизаций, РасчетныеРасходыКРаспределению)
	
	ТекстСортировка = "
		|УПОРЯДОЧИТЬ ПО
		|	Период, Регистратор, ТипЗаписи, ПодразделениеПриемник
		|";
	ИсходныйТекстЗапроса =
		ТекстПрочиеРасходыНЗППоПодразделениямПоБазеИнициализация() + ";" //вт ВТПриход, ВТПоступило, ОтборПоГруппамПродукции, РасходыКРаспределению, Распределить
		+ ТекстВыпускРаботСписанныхНаЗатратыБезЗаказа() + ";"//вт ВыпускРаботСписанныхНаЗатратыБезЗаказа
		+ ТекстДанныеПоСтоимостиМатЗатрат() // вт Данные_СтоимостьМатЗатрат
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстДанныеПоСтоимостиМатЗатратБезПУ() + ";"
		+ ТекстДанныеПоЗатратамНаОплатуТрудаБезЗаказа() // вт Данные_ЗатратыНаОплатуТруда

		//++ НЕ УТКА
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстДанныеПоЗатратамНаОплатуТрудаНЗП()
		//-- НЕ УТКА
		+ ";"
		+ ТекстПоказателиПриИзменении() // вт ЗначенияПоказателей
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстПоказателиЕжемесячно() + ";"
		+ ТекстПоПодразделениямБазаРаспределенияМатЗатраты() //вт БазаРаспределения, использует Распределить, Данные_СтоимостьМатЗатрат, ОтборПоПодразделениям, ОтборПоГруппамПродукции, ВыпускРаботСписанныхНаЗатратыБезЗаказа
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстПоПодразделениямБазаРаспределенияОплатаТруда() //использует Распределить, Данные_ЗатратыНаОплатуТруда, ОтборПоПодразделениям, ОтборПоГруппамПродукции, ВыпускРаботСписанныхНаЗатратыБезЗаказа
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстПоПодразделениямБазаРаспределенияПоПоказателям() //использует Распределить, ЗначенияПоказателей, ОтборПоПодразделениям
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстПоПодразделениямБазаРаспределенияВручную() + ";" // использует Распределить
		+ ТекстОбщиеСуммыПоРегистратору() + ";" // вт ОбщиеСуммы, использует БазаРаспределения
		+ ТекстОписаниеДанныхДляПрочихРасходовНЗППоПодразделениямПоБазе()
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстПоПодразделениямПартия() // использует Распределить, ОбщиеСуммы
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстПоПодразделениям() // использует БазаРаспределения
		+ ТекстСортировка;
	ИсходныйЗапрос = Новый Запрос(ИсходныйТекстЗапроса);
	ИсходныйЗапрос.УстановитьПараметр("НачалоПериода", НачалоПериода);
	ИсходныйЗапрос.УстановитьПараметр("ОкончаниеПериода", ОкончаниеПериода);
	ИсходныйЗапрос.УстановитьПараметр("КонецПериода",     ОкончаниеПериода);
	ИсходныйЗапрос.УстановитьПараметр("ГраницаКонецПериода", Новый Граница(ОкончаниеПериода, ВидГраницы.Включая));
	ИсходныйЗапрос.УстановитьПараметр("МассивОрганизаций", МассивОрганизаций);	
	ИсходныйЗапрос.УстановитьПараметр("СписокПодразделений", Неопределено);
	ИсходныйЗапрос.УстановитьПараметр("ПоВсемОрганизациям", Ложь);
	ИсходныйЗапрос.УстановитьПараметр("ПоВсемПодразделениям", Истина);
	ИсходныйЗапрос.УстановитьПараметр("ПартионныйУчетВключен", РасчетСебестоимостиПовтИсп.ПартионныйУчетВерсии21(НачалоПериода));
	ИсходныйЗапрос.УстановитьПараметр("АналитическийУчетПоГруппамПродукции", ПолучитьФункциональнуюОпцию("АналитическийУчетПоГруппамПродукции"));
	ИсходныйЗапрос.УстановитьПараметр("РасчетныеРасходыКРаспределению", РасчетныеРасходыКРаспределению);
	ИсходныйЗапрос.УстановитьПараметр("ФормироватьВыпускРаботСписанныхНаЗатраты", Истина);
	ИсходныйЗапрос.УстановитьПараметр("УчитыватьСебестоимостьТоваровПоНазначениям",
		РасчетСебестоимостиПовтИсп.СебестоимостьТоваровПоНазначениям(НачалоПериода));
	ИсходныйЗапрос.УстановитьПараметр("ВариантыРаспределенияРасходов", 
		ОбщегоНазначенияУТКлиентСервер.Массив(Перечисления.ВариантыРаспределенияРасходов.НаПроизводственныеЗатраты));
		
	МВТ = Новый МенеджерВременныхТаблиц;
	СформироватьПодразделенияПриемникиРасходов(НачалоПериода, ОкончаниеПериода, МассивОрганизаций, МВТ);
	ИсходныйЗапрос.МенеджерВременныхТаблиц = МВТ;
	ДанныеДляРасчета = ИсходныйЗапрос.Выполнить();
	МВТ.Закрыть();
	Возврат ДанныеДляРасчета;
	
КонецФункции

Функция РасчетныеПрочиеРасходыНЗППоПодразделениямПоБазе(ДанныеДляРасчета, Регистраторы, ВнутренниеДанные = Неопределено, Тест = Истина, КоличествоЗаписей = 0)
	
	// Шаг 1: создаем буфер накопления рассчитанных данных
	Запрос = Новый Запрос(ТекстОписаниеДанныхДляПрочихРасходовНЗППоПодразделениямПоБазе());
	РасчетныеДанные = Запрос.Выполнить().Выгрузить();
	КоличествоЗаписей = РасчетныеДанные.Количество();
	
	// Шаг 2: готовим описание обсчета
	КонтекстЦепочек = ОписаниеЦепочек("Партия, ПоПодразделениям");
	
	ПоляПотреблений = "Регистратор";
	КонтекстДвижений = ОписаниеДвижений(
		"ПрочиеРасходыНезавершенногоПроизводстваПоБазе",
		"ПрочиеРасходыНезавершенногоПроизводства",
		ПереченьПолей(РасчетныеДанные.Колонки),
		ПоляПотреблений,
		"Партия",
		"Знаменатель", "Знаменатель", "", "Регистратор", "Период");
	
	// Шаг 3: обсчитываем потребления из партий
	ДобавитьОписаниеПриемника(КонтекстЦепочек, "ПоПодразделениям", ПоляПотреблений);
	ДобавитьОписаниеИсточника(КонтекстЦепочек, "ПоПодразделениям", "Партия", ПоляПотреблений);
	
	ЦепочкиДвижений = ЦепочкиДвиженийЗапросом(КонтекстЦепочек, ДанныеДляРасчета);
	РассчитатьПартииПоЦепочкамИзВыборки(КонтекстДвижений, ДанныеДляРасчета, РасчетныеДанные, ЦепочкиДвижений, Регистраторы, Тест);

	// Шаг 4: Удаляем строки, не требующие записи в базу.
	УдалитьНезаписываемыеСтроки(КонтекстДвижений.Контекст, РасчетныеДанные);
	
	// Шаг 5: Сортировка партий для дальнейшей записи
	РасчетныеДанные.Сортировать("Регистратор", Новый СравнениеЗначений);
	Возврат РасчетныеДанные;
	
КонецФункции

Функция ТекстПрочиеРасходыНЗППоПодразделениямПоБазеИнициализация() //вт ВТПриход, ВТПоступило, ОтборПоГруппамПродукции, РасходыКРаспределению, Распределить
	Возврат Документы.РаспределениеПрочихЗатрат.ТекстЗапросаПоступилоПрочихРасходов()
	+ ТекстОтборПоГруппамПродукции() + ";" + "
	|ВЫБРАТЬ
	|	Т.Регистратор,
	|	Т.Направление,
	|	Т.ДоляСтоимости,
	|	Т.Стоимость,
	|	Т.СтоимостьБезНДС,
	|	Т.СтоимостьРегл,
	|	Т.ПостояннаяРазница,
	|	Т.ВременнаяРазница
	|ПОМЕСТИТЬ
	|	РасчетныеРасходыКРаспределению
	|ИЗ
	|	&РасчетныеРасходыКРаспределению КАК Т
	|;
	|ВЫБРАТЬ
	|	ДД.Ссылка КАК Регистратор,
	|	ДД.Дата,
	|	ДД.Организация,
	|	ДД.Подразделение КАК ПодразделениеИсточник,
	|	ДД.НаправлениеДеятельности КАК НаправлениеДеятельности,
	|	ДД.СтатьяРасходов,
	|	ДД.АналитикаРасходов,
	|	ДД.БазаРаспределенияПоПодразделениям КАК БазаРаспределения,
	|	ДД.Показатель КАК Показатель,
	|	Р.ДоляСтоимости КАК ДоляСтоимости,
	|	(ВЫБОР КОГДА НЕ ДД.ПодразделенияУказаныВручную
	|		ТОГДА ДД.СтатьяКалькуляции
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО КОНЕЦ) КАК СтатьяКалькуляции,
	|	Р.Стоимость,
	|	Р.СтоимостьБезНДС,
	|	Р.СтоимостьРегл,
	|	Р.ПостояннаяРазница,
	|	Р.ВременнаяРазница
	|ПОМЕСТИТЬ
	|	Распределить
	|ИЗ
	|	Документ.РаспределениеПрочихЗатрат КАК ДД
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ РасходыКРаспределению КАК Т
	|	ПО Т.Организация = ДД.Организация
	|		И Т.Подразделение = ДД.Подразделение
	|		И Т.НаправлениеДеятельности = ДД.НаправлениеДеятельности
	|		И Т.СтатьяРасходов = ДД.СтатьяРасходов
	|		И Т.АналитикаРасходов = ДД.АналитикаРасходов
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ РасчетныеРасходыКРаспределению КАК Р
	|		ПО Р.Регистратор = ДД.Ссылка
	|		И Р.Направление = ""ПоПравилам""
	|ГДЕ
	|	ДД.Дата МЕЖДУ &НачалоПериода И &ОкончаниеПериода
	|	И ДД.Организация В (&МассивОрганизаций)
	|	И ДД.РаспределятьПоПодразделениям
	|	И ДД.Проведен
	|	И Р.ДоляСтоимости <> 0
	|";
КонецФункции

Функция ТекстОписаниеДанныхДляПрочихРасходовНЗППоПодразделениямПоБазе()
	Возврат "
		|ВЫБРАТЬ ПЕРВЫЕ 0
		|	0 КАК Приоритет,
		|	""ХХХХХХХХХХХХХХХХХХХХ"" КАК ТипЗаписи,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КАК РазделУчета,
		|	ДАТАВРЕМЯ(1, 1, 1, 0, 0, 0) КАК Период,
		|	Т.Регистратор КАК Регистратор,
		|	ЗНАЧЕНИЕ(Справочник.Организации.ПустаяСсылка) КАК Организация,
		|	ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка) КАК ПодразделениеИсточник,
		|	ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка) КАК НаправлениеДеятельности,
		|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) КАК СтатьяРасходов,
		|	Т.АналитикаРасходов КАК АналитикаРасходов,
		|	ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка) КАК ПодразделениеПриемник,
		|	ЗНАЧЕНИЕ(Справочник.СтатьиКалькуляции.ПустаяСсылка) КАК СтатьяКалькуляции,
		|	0 КАК Знаменатель,
		|	0 КАК ДоляСтоимости,
		|	0 КАК Стоимость,
		|	0 КАК СтоимостьБезНДС,
		|	0 КАК СтоимостьРегл,
		|	0 КАК ПостояннаяРазница,
		|	0 КАК ВременнаяРазница
		|ИЗ
		|	РегистрНакопления.ПрочиеРасходыНезавершенногоПроизводства КАК Т
		|";
КонецФункции

#Область ДанныеДляБазыРаспределенияПоПодразделениям

Функция ТекстПоказателиПриИзменении()//вт ЗначенияПоказателей
	Возврат "
	|ВЫБРАТЬ
	|	Т.Показатель,
	|	Т.Подразделение,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыБазыРаспределенияРасходов.ВводитсяПриИзменении) КАК БазаРаспределения,
	|	Т.ЗначениеПоказателя
	|ПОМЕСТИТЬ
	|	ЗначенияПоказателей
	|ИЗ
	|	РегистрСведений.ЗначенияПоказателейДляРаспределенияРасходов.СрезПоследних(
	|			&НачалоПериода,
	|			Показатель В
	|				(ВЫБРАТЬ
	|					Показатели.Ссылка
	|				ИЗ
	|				Справочник.ПравилаРаспределенияРасходов КАК Показатели
	|				ГДЕ
	|					Показатели.ПометкаУдаления = ЛОЖЬ
	|					И Показатели.БазаРаспределения = 
	|						ЗНАЧЕНИЕ(Перечисление.ТипыБазыРаспределенияРасходов.ВводитсяПриИзменении)
	|				)
	|																							) КАК Т
	|";
КонецФункции

Функция ТекстПоказателиЕжемесячно()
	Возврат "
	|ВЫБРАТЬ
	|	Т.Показатель,
	|	Т.Подразделение,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыБазыРаспределенияРасходов.ВводитсяЕжемесячно) КАК БазаРаспределения,
	|	Т.ЗначениеПоказателя
	|ИЗ
	|	РегистрСведений.ЗначенияПоказателейДляРаспределенияРасходов КАК Т
	|ГДЕ
	|	Т.Период = &НачалоПериода
	|	И Т.Показатель В
	|			(ВЫБРАТЬ
	|				Показатели.Ссылка
	|			ИЗ
	|				Справочник.ПравилаРаспределенияРасходов КАК Показатели
	|			ГДЕ
	|				Показатели.ПометкаУдаления = ЛОЖЬ
	|				И Показатели.БазаРаспределения = 
	|					ЗНАЧЕНИЕ(Перечисление.ТипыБазыРаспределенияРасходов.ВводитсяЕжемесячно)
	|			)
	|";
КонецФункции

#КонецОбласти

#Область ИтоговаяБазаРаспределенияПоПодразделениям

Функция ТекстПоПодразделениямБазаРаспределенияМатЗатраты() //вт БазаРаспределения, использует Распределить, Данные_СтоимостьМатЗатрат, ОтборПоПодразделениям, ВыпускРаботСписанныхНаЗатратыБезЗаказа, ОтборПоГруппамПродукции
	Возврат "
	|ВЫБРАТЬ
	|	Т.Регистратор,
	|	Т.Дата,
	|	ЛОЖЬ КАК ГруппироватьСуммыПоПодразделениям,
	|	Т.СтатьяКалькуляции,
	|	Т.Подразделение КАК ПодразделениеПриемник,
	|	Т.НаправлениеДеятельности КАК НаправлениеДеятельности,
	|	0 КАК Количество,
	|	0 КАК Объем,
	|	0 КАК Вес,
	|	СУММА(Т.Стоимость) КАК Стоимость
	|ПОМЕСТИТЬ
	|	БазаРаспределения
	|ИЗ
	|	(ВЫБРАТЬ
	|	Строки.Регистратор,
	|	Строки.Дата,
	|	Строки.СтатьяКалькуляции,
	|	Данные.Подразделение,
	|	Строки.НаправлениеДеятельности,
	|	Данные.ГруппаПродукции,
	|	Данные.Стоимость
	|	ИЗ
	|		Распределить КАК Строки
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Данные_СтоимостьМатЗатрат КАК Данные
	|			ПО (Данные.Организация = Строки.Организация
	|				ИЛИ Данные.Организация = ЗНАЧЕНИЕ(Справочник.Организации.ПустаяСсылка))
	|			И Данные.БазаРаспределения = Строки.БазаРаспределения
	|			И (Данные.НаправлениеДеятельности = Строки.НаправлениеДеятельности ИЛИ Строки.НаправлениеДеятельности = ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка))
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ОтборПоПодразделениям КАК ОП
	|			ПО ОП.Регистратор = Строки.Регистратор
	|				И (ОП.Подразделение = Данные.Подразделение
	|					ИЛИ ОП.Подразделение = ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка))
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВыпускРаботСписанныхНаЗатратыБезЗаказа КАК ВыпускРабот
	|			ПО ВыпускРабот.Распоряжение = Данные.ДокументВыпуска
	|				И ВыпускРабот.КодСтроки = Данные.КодСтрокиПродукция
	|	ГДЕ
	|		НЕ(Строки.Организация = ЕСТЬNULL(ВыпускРабот.Организация, ЛОЖЬ)
	|			И Строки.ПодразделениеИсточник = ЕСТЬNULL(ВыпускРабот.ПодразделениеПриемник, ЛОЖЬ)
	|			И Строки.СтатьяРасходов = ЕСТЬNULL(ВыпускРабот.СтатьяРасходов, ЛОЖЬ)
	|			И Строки.АналитикаРасходов = ЕСТЬNULL(ВыпускРабот.АналитикаРасходов, ЛОЖЬ))
	|	) КАК Т
	|ГДЕ
	|	(Т.Регистратор, Т.ГруппаПродукции) В (
	|												ВЫБРАТЬ
	|													Т.Регистратор,
	|													Т.ГруппаПродукции
	|												ИЗ
	|													ОтборПоГруппамПродукции КАК Т)
	|	ИЛИ
	|	(Т.Регистратор, ЗНАЧЕНИЕ(Справочник.ГруппыАналитическогоУчетаНоменклатуры.ПустаяСсылка)) В (
	|												ВЫБРАТЬ
	|													Т.Регистратор,
	|													Т.ГруппаПродукции
	|												ИЗ
	|													ОтборПоГруппамПродукции КАК Т)
	|СГРУППИРОВАТЬ ПО
	|	Т.Регистратор,
	|	Т.Дата,
	|	Т.СтатьяКалькуляции,
	|	Т.Подразделение,
	|	Т.НаправлениеДеятельности
	|";
КонецФункции

Функция ТекстПоПодразделениямБазаРаспределенияОплатаТруда() // использует Распределить, Данные_ЗатратыНаОплатуТруда, ОтборПоПодразделениям, ВыпускРаботСписанныхНаЗатратыБезЗаказа, ОтборПоГруппамПродукции
	Возврат "
	|ВЫБРАТЬ
	|	Т.Регистратор,
	|	Т.Дата,
	|	ЛОЖЬ КАК ГруппироватьСуммыПоПодразделениям,
	|	Т.СтатьяКалькуляции,
	|	Т.Подразделение КАК ПодразделениеПриемник,
	|	Т.НаправлениеДеятельности КАК НаправлениеДеятельности,
	|	0 КАК Количество,
	|	0 КАК Объем,
	|	0 КАК Вес,
	|	СУММА(Т.Стоимость) КАК Стоимость
	|ИЗ
	|	(ВЫБРАТЬ
	|	Строки.Регистратор,
	|	Строки.Дата,
	|	Строки.СтатьяКалькуляции,
	|	Данные.Подразделение,
	|	Строки.НаправлениеДеятельности,
	|	Данные.ГруппаПродукции,
	|	Данные.Стоимость
	|	ИЗ
	|		Распределить КАК Строки
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Данные_ЗатратыНаОплатуТруда КАК Данные
	|			ПО (Данные.Организация = Строки.Организация
	|				ИЛИ Данные.Организация = ЗНАЧЕНИЕ(Справочник.Организации.ПустаяСсылка))
	|			И Данные.БазаРаспределения = Строки.БазаРаспределения
	|			И (Данные.НаправлениеДеятельности = Строки.НаправлениеДеятельности ИЛИ Строки.НаправлениеДеятельности = ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка))
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ОтборПоПодразделениям КАК ОП
	|			ПО ОП.Регистратор = Строки.Регистратор
	|				И (ОП.Подразделение = Данные.Подразделение
	|					ИЛИ ОП.Подразделение = ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка))
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВыпускРаботСписанныхНаЗатратыБезЗаказа КАК ВыпускРабот
	|			ПО ВыпускРабот.Распоряжение = Данные.ДокументВыпуска
	|				И ВыпускРабот.КодСтроки = Данные.КодСтрокиПродукция
	|	ГДЕ
	|		НЕ(Строки.Организация = ЕСТЬNULL(ВыпускРабот.Организация, ЛОЖЬ)
	|			И Строки.ПодразделениеИсточник = ЕСТЬNULL(ВыпускРабот.ПодразделениеПриемник, ЛОЖЬ)
	|			И Строки.СтатьяРасходов = ЕСТЬNULL(ВыпускРабот.СтатьяРасходов, ЛОЖЬ)
	|			И Строки.АналитикаРасходов = ЕСТЬNULL(ВыпускРабот.АналитикаРасходов, ЛОЖЬ))
	|	) КАК Т
	|ГДЕ
	|	(Т.Регистратор, Т.ГруппаПродукции) В (
	|												ВЫБРАТЬ
	|													Т.Регистратор,
	|													Т.ГруппаПродукции
	|												ИЗ
	|													ОтборПоГруппамПродукции КАК Т)
	|	ИЛИ
	|	(Т.Регистратор, ЗНАЧЕНИЕ(Справочник.ГруппыАналитическогоУчетаНоменклатуры.ПустаяСсылка)) В (
	|												ВЫБРАТЬ
	|													Т.Регистратор,
	|													Т.ГруппаПродукции
	|												ИЗ
	|													ОтборПоГруппамПродукции КАК Т)
	|СГРУППИРОВАТЬ ПО
	|	Т.Регистратор,
	|	Т.Дата,
	|	Т.СтатьяКалькуляции,
	|	Т.Подразделение,
	|	Т.НаправлениеДеятельности
	|";
КонецФункции

Функция ТекстПоПодразделениямБазаРаспределенияПоПоказателям() // использует Распределить, ЗначенияПоказателей, ОтборПоПодразделениям
	Возврат "
	|ВЫБРАТЬ
	|	Т.Регистратор,
	|	Т.Дата,
	|	ЛОЖЬ КАК ГруппироватьСуммыПоПодразделениям,
	|	Т.СтатьяКалькуляции,
	|	Т.Подразделение КАК ПодразделениеПриемник,
	|	ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка) КАК НаправлениеДеятельности,
	|	0 КАК Количество,
	|	0 КАК Объем,
	|	0 КАК Вес,
	|	СУММА(Т.Стоимость) КАК Стоимость
	|ИЗ
	|	(ВЫБРАТЬ
	|	Строки.Регистратор,
	|	Строки.Дата,
	|	Строки.СтатьяКалькуляции,
	|	Данные.Подразделение,
	|	ЗНАЧЕНИЕ(Справочник.ГруппыАналитическогоУчетаНоменклатуры.ПустаяСсылка) КАК ГруппаПродукции,
	|	Данные.ЗначениеПоказателя КАК Стоимость
	|	ИЗ
	|		Распределить КАК Строки
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ЗначенияПоказателей КАК Данные
	|			ПО Данные.БазаРаспределения = Строки.БазаРаспределения
	|			И Данные.Показатель = Строки.Показатель
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ОтборПоПодразделениям КАК ОП
	|			ПО ОП.Регистратор = Строки.Регистратор
	|				И (ОП.Подразделение = Данные.Подразделение
	|					ИЛИ ОП.Подразделение = ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка))
	|	) КАК Т
	|СГРУППИРОВАТЬ ПО
	|	Т.Регистратор,
	|	Т.Дата,
	|	Т.СтатьяКалькуляции,
	|	Т.Подразделение
	|";
КонецФункции

Функция ТекстПоПодразделениямБазаРаспределенияВручную() // использует Распределить
	Возврат "
	|ВЫБРАТЬ
	|	ДД.Регистратор,
	|	ДД.Дата,
	|	ЛОЖЬ КАК ГруппироватьСуммыПоПодразделениям,
	|	Строки.СтатьяКалькуляции,
	|	Строки.Подразделение КАК ПодразделениеПриемник,
	|	ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка) КАК НаправлениеДеятельности,
	|	0 КАК Количество,
	|	0 КАК Объем,
	|	0 КАК Вес,
	|	СУММА(Строки.ДоляСтоимости) КАК Стоимость
	|ИЗ
	|	Распределить КАК ДД
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.РаспределениеПрочихЗатрат.ПоБазе КАК Строки
	|		ПО Строки.Ссылка = ДД.Регистратор
	|СГРУППИРОВАТЬ ПО
	|	ДД.Регистратор,
	|	ДД.Дата,
	|	Строки.СтатьяКалькуляции,
	|	Строки.Подразделение
	|";
КонецФункции

#КонецОбласти

#Область ФормированиеТаблицыДанныхДляРасчетаПоПодразделениям

Функция ТекстПоПодразделениямПартия() // использует Распределить, ОбщиеСуммы
	Возврат "
	|ВЫБРАТЬ
	|	10 КАК Приоритет,
	|	""Партия"" КАК ТипЗаписи,
	|	ИСТИНА КАК РасчетЗавершен,
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) КАК ВидДвижения,
	|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КАК РазделУчета,
	|	ДД.Дата КАК Период,
	|	ДД.Регистратор,
	|	ДД.Организация,
	|	ДД.ПодразделениеИсточник,
	|	ДД.НаправлениеДеятельности,
	|	ДД.СтатьяРасходов,
	|	ДД.АналитикаРасходов,
	|	НЕОПРЕДЕЛЕНО КАК ПодразделениеПриемник,
	|	НЕОПРЕДЕЛЕНО КАК СтатьяКалькуляции,
	|	Итог.ОбщаяСтоимость КАК Знаменатель,
	|	ДД.ДоляСтоимости,
	|	ДД.Стоимость,
	|	ДД.СтоимостьБезНДС,
	|	ДД.СтоимостьРегл,
	|	ДД.ПостояннаяРазница,
	|	ДД.ВременнаяРазница
	|ИЗ
	|	Распределить КАК ДД
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ОбщиеСуммы КАК Итог
	|		ПО Итог.Регистратор = ДД.Регистратор
	|";
КонецФункции

Функция ТекстПоПодразделениям() // использует БазаРаспределения
	Возврат "
	|ВЫБРАТЬ
	|	20 КАК Приоритет,
	|	""ПоПодразделениям"" КАК ТипЗаписи,
	|	ЛОЖЬ КАК РасчетЗавершен,
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
	|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КАК РазделУчета,
	|	ДД.Дата КАК Период,
	|	ДД.Регистратор,
	|	НЕОПРЕДЕЛЕНО КАК Организация,
	|	НЕОПРЕДЕЛЕНО КАК ПодразделениеИсточник,
	|	ДД.НаправлениеДеятельности КАК НаправлениеДеятельности,
	|	НЕОПРЕДЕЛЕНО КАК СтатьяРасходов,
	|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
	|	ДД.ПодразделениеПриемник КАК ПодразделениеПриемник,
	|	ДД.СтатьяКалькуляции КАК СтатьяКалькуляции,
	|	ДД.Стоимость КАК Знаменатель,
	|	0 КАК ДоляСтоимости,
	|	0 КАК Стоимость,
	|	0 КАК СтоимостьБезНДС,
	|	0 КАК СтоимостьРегл,
	|	0 КАК ПостояннаяРазница,
	|	0 КАК ВременнаяРазница
	|ИЗ
	|	БазаРаспределения КАК ДД
	|";
КонецФункции

#КонецОбласти

#КонецОбласти

#Область ПоЭтапам

Функция ДанныеДляПрочихРасходовНЗППоЭтапамПоБазе(НачалоПериода, ОкончаниеПериода, МассивОрганизаций, РасчетныеРасходыКРаспределению, РасчетноеРаспределениеПоПодразделениям)
	
	ТекстСортировка = "
		|УПОРЯДОЧИТЬ ПО
		|	Период, Регистратор, ТипЗаписи, ПодразделениеПриемник
		|";
	ИсходныйТекстЗапроса =
		ТекстПрочиеРасходыНЗППоЭтапамПоБазеИнициализация() + ";" //вт ОтборПоМатериалам, ОтборПоВидамРабот, ОтборПоГруппамПродукции, ДанныеРаспределенияПоПодразделениям, РасходыКРаспределению, Распределить
		+ ТекстВыпускРаботСписанныхНаЗатратыБезЗаказа() + ";"//вт ВыпускРаботСписанныхНаЗатратыБезЗаказа
		+ ТекстДанныеПоСтоимостиМатЗатрат() //вт Данные_СтоимостьМатЗатрат
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстДанныеПоСтоимостиМатЗатратБезПУ() + ";"
		+ ТекстДанныеПоЗатратамНаОплатуТрудаБезЗаказа() //вт Данные_ЗатратыНаОплатуТруда

		//++ НЕ УТКА
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстДанныеПоЗатратамНаОплатуТрудаНЗП()
		//-- НЕ УТКА
		+ ";"
		+ ТекстДанныеПоНормативнымЗатратамНаОплатуТрудаБезЗаказа() // вт Данные_НормативныеЗатратыНаОплатуТруда

		//++ НЕ УТКА
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстДанныеПоНормативнымЗатратамНаОплатуТрудаНЗП()
		//-- НЕ УТКА
		+ ";"
		+ ТекстДанныеПоУказаннымМатериалам() + ";" // вт ДанныеПоУказаннымМатериалам
		+ ТекстДанныеПоПродукции() + ";" // вт ФактЭтапов_ПоПродукции, ПланЭтаповПоЗаказам_ПоПродукции, Данные_ПоПродукции
		+ ТекстДанныеПоПлановойСтоимости() + ";" // вт ФактЭтапов_ПоПлановойСтоимости, ПланЭтаповПоЗаказам_ПоПлановойСтоимости, Данные_ПоПлановойСтоимости
		+ ТекстДанныеПоУказаннымТрудозатратам() + ";" // вт Данные_ПоУказаннымТрудозатратам
		+ ТекстПоЭтапамБазаПоСтоимостиМатЗатрат() //вт БазаРаспределения, использует Распределить, Данные_СтоимостьМатЗатрат, ОтборПоГруппамПродукции, ВыпускРаботСписанныхНаЗатратыБезЗаказа
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстПоЭтапамБазаПоЗатратамНаОплатуТруда() // использует Распределить, Данные_ЗатратыНаОплатуТруда, ОтборПоГруппамПродукции, ВыпускРаботСписанныхНаЗатратыБезЗаказа
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстПоЭтапамБазаПоНормативнымЗатратамНаОплатуТруда() // использует Распределить, Данные_НормативныеЗатратыНаОплатуТруда, ОтборПоГруппамПродукции, ВыпускРаботСписанныхНаЗатратыБезЗаказа
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстПоЭтапамБазаПоУказаннымМатериалам() // использует Распределить, Данные_ПоУказаннымМатериалам, ОтборПоМатериалам, ОтборПоГруппамПродукции, ВыпускРаботСписанныхНаЗатратыБезЗаказа
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстПоЭтапамБазаПоПродукции() // вт Распределить, Данные_ПоПродукции, ОтборПоГруппамПродукции, ВыпускРаботСписанныхНаЗатратыБезЗаказа
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстПоЭтапамБазаПоПлановойСтоимости() // использует Распределить, Данные_ПоПлановойСтоимости, ОтборПоГруппамПродукции, ВыпускРаботСписанныхНаЗатратыБезЗаказа
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстПоЭтапамБазаПоКоличествуУказанныхТрудозатрат() // использует Распределить, Данные_ПоУказаннымТрудозатратам, ОтборПоВидамРабот, ОтборПоГруппамПродукции, ВыпускРаботСписанныхНаЗатратыБезЗаказа
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстПоЭтапамБазаВручнуюПоЗаказам() // использует Распределить
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстПоЭтапамБазаВручнуюПоВыпускамБезРаспоряжения() + ";" // использует Распределить, ВыпускРаботСписанныхНаЗатратыБезЗаказа
		+ ТекстОбщиеСуммыПоРегистратору() + ";" // вт ОбщиеСуммы, использует БазаРаспределения
		+ ТекстОписаниеДанныхДляПрочихРасходовНЗППоЭтапамПоБазе()
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстПоЭтапамПартия() // использует Распределить, ОбщиеСуммы
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстПоЭтапам() // использует БазаРаспределения
		+ ТекстСортировка;
	ИсходныйТекстЗапроса = СтрЗаменить(ИсходныйТекстЗапроса, "&Вес", Справочники.УпаковкиЕдиницыИзмерения.ТекстЗапросаВесУпаковки("СН.ЕдиницаИзмерения", "СН"));
	ИсходныйТекстЗапроса = СтрЗаменить(ИсходныйТекстЗапроса, "&Объем", Справочники.УпаковкиЕдиницыИзмерения.ТекстЗапросаОбъемУпаковки("СН.ЕдиницаИзмерения", "СН"));
	ИсходныйЗапрос = Новый Запрос(ИсходныйТекстЗапроса);
	ИсходныйЗапрос.УстановитьПараметр("НачалоПериода", НачалоПериода);
	ИсходныйЗапрос.УстановитьПараметр("ОкончаниеПериода", ОкончаниеПериода);
	ИсходныйЗапрос.УстановитьПараметр("КонецПериода",     ОкончаниеПериода);
	ИсходныйЗапрос.УстановитьПараметр("ГраницаКонецПериода", Новый Граница(ОкончаниеПериода, ВидГраницы.Включая));
	ИсходныйЗапрос.УстановитьПараметр("МассивОрганизаций", МассивОрганизаций);	
	ИсходныйЗапрос.УстановитьПараметр("СписокПодразделений", Неопределено);
	ИсходныйЗапрос.УстановитьПараметр("ПоВсемОрганизациям", Ложь);
	ИсходныйЗапрос.УстановитьПараметр("ПоВсемПодразделениям", Истина);
	ИсходныйЗапрос.УстановитьПараметр("РасчетныеРасходыКРаспределению", РасчетныеРасходыКРаспределению);
	ИсходныйЗапрос.УстановитьПараметр("РасчетноеРаспределениеПоПодразделениям", РасчетноеРаспределениеПоПодразделениям);
	ИсходныйЗапрос.УстановитьПараметр("ПартионныйУчетВключен", РасчетСебестоимостиПовтИсп.ПартионныйУчетВерсии21(НачалоПериода));
	ИсходныйЗапрос.УстановитьПараметр("АналитическийУчетПоГруппамПродукции", ПолучитьФункциональнуюОпцию("АналитическийУчетПоГруппамПродукции"));
	ИсходныйЗапрос.УстановитьПараметр("ВидПлановыхЦен", Справочники.ВидыЦен.ВидЦеныПоУмолчанию(Константы.ВидЦеныПлановойСтоимостиМатериаловРабот.Получить()));
	ИсходныйЗапрос.УстановитьПараметр("ФормироватьВыпускРаботСписанныхНаЗатраты", Истина);
	ИсходныйЗапрос.УстановитьПараметр("УчитыватьСебестоимостьТоваровПоНазначениям",
		РасчетСебестоимостиПовтИсп.СебестоимостьТоваровПоНазначениям(НачалоПериода));
	ИсходныйЗапрос.УстановитьПараметр("ВариантыРаспределенияРасходов", 
		ОбщегоНазначенияУТКлиентСервер.Массив(Перечисления.ВариантыРаспределенияРасходов.НаПроизводственныеЗатраты));
	
	МВТ = Новый МенеджерВременныхТаблиц;
	СформироватьПодразделенияПриемникиРасходов(НачалоПериода, ОкончаниеПериода, МассивОрганизаций, МВТ);
	
	ИсходныйЗапрос.МенеджерВременныхТаблиц = МВТ;
	ДанныеДляРасчета = ИсходныйЗапрос.Выполнить();
	
	МВТ.Закрыть();
	
	Возврат ДанныеДляРасчета;
	
КонецФункции

Функция РасчетныеПрочиеРасходыНЗППоЭтапамПоБазе(ДанныеДляРасчета, Регистраторы, ВнутренниеДанные = Неопределено, Тест = Ложь, КоличествоЗаписей = 0)
	
	// Шаг 1: создаем буфер накопления рассчитанных данных
	Запрос = Новый Запрос(ТекстОписаниеДанныхДляПрочихРасходовНЗППоЭтапамПоБазе());
	РасчетныеДанные = Запрос.Выполнить().Выгрузить();
	КоличествоЗаписей = РасчетныеДанные.Количество();
	
	// Шаг 2: готовим описание обсчета
	КонтекстЦепочек = ОписаниеЦепочек("Партия, ПоЭтапам");
	
	ПоляПотреблений = "Регистратор, Подразделение";
	КонтекстДвижений = ОписаниеДвижений(
		"ПрочиеРасходыНезавершенногоПроизводстваПоБазе",
		"ПрочиеРасходыНезавершенногоПроизводства",
		ПереченьПолей(РасчетныеДанные.Колонки),
		ПоляПотреблений,
		"Партия",
		"Знаменатель", "Знаменатель", "", "Регистратор, Подразделение", "Период");
	
	// Шаг 3: обсчитываем потребления из партий
	ДобавитьОписаниеПриемника(КонтекстЦепочек, "ПоЭтапам", ПоляПотреблений);
	ДобавитьОписаниеИсточника(КонтекстЦепочек, "ПоЭтапам", "Партия", ПоляПотреблений);
	
	ЦепочкиДвижений = ЦепочкиДвиженийЗапросом(КонтекстЦепочек, ДанныеДляРасчета);
	РассчитатьПартииПоЦепочкамИзВыборки(КонтекстДвижений, ДанныеДляРасчета, РасчетныеДанные, ЦепочкиДвижений, Регистраторы, Тест);

	// Шаг 4: Удаляем строки, не требующие записи в базу.
	УдалитьНезаписываемыеСтроки(КонтекстДвижений.Контекст, РасчетныеДанные);
	
	// Шаг 5: Сортировка партий для дальнейшей записи
	РасчетныеДанные.Сортировать("Регистратор", Новый СравнениеЗначений);
	Возврат РасчетныеДанные;
	
КонецФункции

Функция ТекстПрочиеРасходыНЗППоЭтапамПоБазеИнициализация() //вт ОтборПоМатериалам, ОтборПоВидамРабот, ОтборПоГруппамПродукции, ДанныеРаспределенияПоПодразделениям, РасходыКРаспределению, Распределить
	Возврат Документы.РаспределениеПрочихЗатрат.ТекстЗапросаПоступилоПрочихРасходов()
	+ ТекстОтборПоМатериалам() + ";"
	+ ТекстОтборПоВидамРабот() + ";"
	+ ТекстОтборПоГруппамПродукции() + ";"
	+ ТекстДанныеРаспределенияПоПодразделениям() + ";"
	+ ТекстРасходыКРаспределению() + ";" + "
	|ВЫБРАТЬ
	|	Т.Регистратор,
	|	Т.Период,
	|	Т.Организация,
	|	Т.НаправлениеДеятельности,
	|	Т.ПодразделениеИсточник,
	|	Т.ПодразделениеПриемник,
	|	Т.ПодразделениеПриемник КАК Подразделение,
	|	Т.СтатьяРасходов,
	|	Т.АналитикаРасходов,
	|	Т.СтатьяКалькуляции,
	|	Д.БазаРаспределенияПоПартиям КАК БазаРаспределения,
	|	Д.ПартииУказаныВручную,
	|	Д.ПодразделенияУказаныВручную,		
	|	ИСТИНА КАК ГруппироватьСуммыПоПодразделениям,
	|	Т.ДоляСтоимости,
	|	Т.Стоимость,
	|	Т.СтоимостьБезНДС,
	|	Т.СтоимостьРегл,
	|	Т.ПостояннаяРазница,
	|	Т.ВременнаяРазница
	|ПОМЕСТИТЬ
	|	Распределить
	|ИЗ
	|	ДанныеРаспределенияПоПодразделениям КАК Т
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.РаспределениеПрочихЗатрат КАК Д
	|		ПО Д.Ссылка = Т.Регистратор
	|		И Д.РаспределятьПоПартиям
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	Д.Ссылка КАК Регистратор,
	|	Д.Дата КАК Период,
	|	Д.Организация,
	|	Д.НаправлениеДеятельности,
	|	Д.Подразделение КАК ПодразделениеИсточник,
	|	НЕОПРЕДЕЛЕНО КАК ПодразделениеПриемник,
	|	(ВЫБОР
	|		КОГДА Д.НаправлениеРаспределения = ЗНАЧЕНИЕ(Перечисление.НаправлениеРаспределенияПоПодразделениям.Текущее)
	|		ТОГДА Д.Подразделение
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка) КОНЕЦ) КАК Подразделение,
	|	Д.СтатьяРасходов,
	|	Д.АналитикаРасходов,
	|	Д.СтатьяКалькуляции,
	|	Д.БазаРаспределенияПоПартиям КАК БазаРаспределения,
	|	Д.ПартииУказаныВручную,
	|	Д.ПодразделенияУказаныВручную,		
	|	ЛОЖЬ КАК ГруппироватьСуммыПоПодразделениям,
	|	Р.ДоляСтоимости КАК ДоляСтоимости,
	|	Р.Стоимость,
	|	Р.СтоимостьБезНДС,
	|	Р.СтоимостьРегл,
	|	Р.ПостояннаяРазница,
	|	Р.ВременнаяРазница
	|ИЗ
	|	Документ.РаспределениеПрочихЗатрат КАК Д
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ РасходыКРаспределению КАК Т
	|	ПО Т.Организация = Д.Организация
	|		И Т.Подразделение = Д.Подразделение
	|		И Т.НаправлениеДеятельности = Д.НаправлениеДеятельности
	|		И Т.СтатьяРасходов = Д.СтатьяРасходов
	|		И Т.АналитикаРасходов = Д.АналитикаРасходов
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ РасчетныеРасходыКРаспределению КАК Р
	|		ПО Р.Регистратор = Д.Ссылка
	|		И Р.Направление = ""ПоПравилам""
	|ГДЕ
	|	Д.Дата МЕЖДУ &НачалоПериода И &ОкончаниеПериода
	|	И Д.Организация В (&МассивОрганизаций)
	|	И Д.РаспределятьПоПартиям
	|	И НЕ Д.РаспределятьПоПодразделениям
	|	И НЕ Д.ПартииУказаныВручную
	|	И Д.Проведен
	|	И Р.ДоляСтоимости <> 0
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	Д.Ссылка КАК Регистратор,
	|	Д.Дата КАК Период,
	|	Д.Организация,
	|	Д.НаправлениеДеятельности,
	|	Д.Подразделение КАК ПодразделениеИсточник,
	|	НЕОПРЕДЕЛЕНО КАК ПодразделениеПриемник,
	|	ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка) КАК Подразделение,
	|	Д.СтатьяРасходов,
	|	Д.АналитикаРасходов,
	|	Р.СтатьяКалькуляции,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыБазыРаспределенияРасходов.ПустаяСсылка) КАК БазаРаспределения,
	|	Д.ПартииУказаныВручную,
	|	Д.ПодразделенияУказаныВручную,		
	|	ЛОЖЬ КАК ГруппироватьСуммыПоПодразделениям,
	|	Р.ДоляСтоимости КАК ДоляСтоимости,
	|	Р.Стоимость,
	|	Р.СтоимостьБезНДС,
	|	Р.СтоимостьРегл,
	|	Р.ПостояннаяРазница,
	|	Р.ВременнаяРазница
	|ИЗ
	|	Документ.РаспределениеПрочихЗатрат КАК Д
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ РасходыКРаспределению КАК Т
	|	ПО Т.Организация = Д.Организация
	|		И Т.Подразделение = Д.Подразделение
	|		И Т.НаправлениеДеятельности = Д.НаправлениеДеятельности
	|		И Т.СтатьяРасходов = Д.СтатьяРасходов
	|		И Т.АналитикаРасходов = Д.АналитикаРасходов
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ РасчетныеРасходыКРаспределению КАК Р
	|		ПО Р.Регистратор = Д.Ссылка
	|		И Р.Направление = ""Вручную""
	|ГДЕ
	|	Д.Дата МЕЖДУ &НачалоПериода И &ОкончаниеПериода
	|	И Д.Организация В (&МассивОрганизаций)
	|	И Д.ПартииУказаныВручную
	|	И Д.Проведен
	|	И Р.ДоляСтоимости <> 0
	|;
	|
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	ДокументыСОтборами.Регистратор
	|ПОМЕСТИТЬ ДокументыСОтборами
	|ИЗ
	|	(ВЫБРАТЬ
	|		Т.Регистратор
	|	ИЗ
	|		Распределить КАК Т
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ОтборПоМатериалам КАК Отбор
	|		ПО Т.Регистратор = Отбор.Регистратор
	|
	|	ОБЪЕДИНИТЬ ВСЕ
	|
	|	ВЫБРАТЬ
	|		Т.Регистратор
	|	ИЗ
	|		Распределить КАК Т
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ОтборПоВидамРабот КАК Отбор
	|		ПО Т.Регистратор = Отбор.Регистратор) КАК ДокументыСОтборами
	|";
КонецФункции

Функция ТекстОписаниеДанныхДляПрочихРасходовНЗППоЭтапамПоБазе()
	Возврат "
		|ВЫБРАТЬ ПЕРВЫЕ 0
		|	0 КАК Приоритет,
		|	""ХХХХХХХХХХХХХХХХХХХХ"" КАК ТипЗаписи,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КАК РазделУчета,
		|	ДАТАВРЕМЯ(1, 1, 1, 0, 0, 0) КАК Период,
		|	Т.Регистратор КАК Регистратор,
		|	ЗНАЧЕНИЕ(Справочник.Организации.ПустаяСсылка) КАК Организация,
		|	ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка) КАК ПодразделениеИсточник,
		|	ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка) КАК ПодразделениеПриемник,
		|	ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка) КАК Подразделение,
		|	ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка) КАК НаправлениеДеятельности,
		|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) КАК СтатьяРасходов,
		|	Т.АналитикаРасходов КАК АналитикаРасходов,
		|	ЗНАЧЕНИЕ(Справочник.СтатьиКалькуляции.ПустаяСсылка) КАК СтатьяКалькуляции,
		|	НЕОПРЕДЕЛЕНО КАК ЗаказНаПроизводство,
		|	0 КАК КодСтрокиПродукция,
		|	ЗНАЧЕНИЕ(Справочник.ЭтапыПроизводства.ПустаяСсылка) КАК Этап,
		|	Т.ДокументВыпуска КАК ДокументВыпуска,
		|	Т.ДокументДвижения КАК ДокументДвижения,
		|	ЗНАЧЕНИЕ(Справочник.ГруппыАналитическогоУчетаНоменклатуры.ПустаяСсылка) КАК ГруппаПродукции,
		|	0 КАК Знаменатель,
		|	0 КАК ДоляСтоимости,
		|	0 КАК Стоимость,
		|	0 КАК СтоимостьБезНДС,
		|	0 КАК СтоимостьРегл,
		|	0 КАК ПостояннаяРазница,
		|	0 КАК ВременнаяРазница
		|ИЗ
		|	РегистрНакопления.ПрочиеРасходыНезавершенногоПроизводства КАК Т
		|";
КонецФункции

#Область Инициализация

Функция ТекстДанныеРаспределенияПоПодразделениям() // вт ДанныеРаспределенияПоПодразделениям
	Возврат "
	|ВЫБРАТЬ
	|	Т.Регистратор КАК Регистратор,
	|	Т.Период КАК Период,
	|	Т.Организация КАК Организация,
	|	Т.ПодразделениеИсточник,
	|	Т.ПодразделениеПриемник,
	|	Т.НаправлениеДеятельности,
	|	Т.СтатьяРасходов КАК СтатьяРасходов,
	|	Т.АналитикаРасходов КАК АналитикаРасходов,
	|	Т.СтатьяКалькуляции КАК СтатьяКалькуляции,
	|	Т.ДоляСтоимости КАК ДоляСтоимости,
	|	Т.Стоимость КАК Стоимость,
	|	Т.СтоимостьБезНДС КАК СтоимостьБезНДС,
	|	Т.СтоимостьРегл КАК СтоимостьРегл,
	|	Т.ПостояннаяРазница КАК ПостояннаяРазница,
	|	Т.ВременнаяРазница КАК ВременнаяРазница
	|ПОМЕСТИТЬ
	|	ДанныеРаспределенияПоПодразделениям
	|ИЗ
	|	&РасчетноеРаспределениеПоПодразделениям КАК Т
	|";
КонецФункции

Функция ТекстРасходыКРаспределению() // вт РасходыКРаспределению
	Возврат "
	|ВЫБРАТЬ
	|	Т.Регистратор,
	|	Т.Направление,
	|	Т.СтатьяКалькуляции,
	|	Т.ДоляСтоимости,
	|	Т.Стоимость,
	|	Т.СтоимостьБезНДС,
	|	Т.СтоимостьРегл,
	|	Т.ПостояннаяРазница,
	|	Т.ВременнаяРазница
	|ПОМЕСТИТЬ
	|	РасчетныеРасходыКРаспределению
	|ИЗ
	|	&РасчетныеРасходыКРаспределению КАК Т
	|";
КонецФункции

#КонецОбласти

#Область ДанныеДляБазыРаспределенияПоЭтапам

Функция ТекстДанныеПоНормативнымЗатратамНаОплатуТрудаБезЗаказа() // вт Данные_НормативныеЗатратыНаОплатуТруда
	Возврат "
	|ВЫБРАТЬ
	|	Т.Организация,
	|	Т.Подразделение КАК Подразделение,
	|	Выпуск.Назначение.НаправлениеДеятельности КАК НаправлениеДеятельности,
	|	НЕОПРЕДЕЛЕНО КАК ЗаказНаПроизводство,
	|	НЕОПРЕДЕЛЕНО КАК Этап,
	|	Т.КодСтроки КАК КодСтрокиПродукция,
	|	Т.ВидРабот,
	|	СА.Номенклатура КАК Продукция,
	|	Т.ГруппаПродукции,
	|	Т.ДокументВыпуска,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыБазыРаспределенияРасходов.СуммаРасходовНаОплатуТруда) КАК БазаРаспределения,
	|	СУММА(Т.НормативнаяСтоимость) КАК Стоимость
	|ПОМЕСТИТЬ
	|	Данные_НормативныеЗатратыНаОплатуТруда
	|ИЗ
	|	РегистрНакопления.ТрудозатратыНезавершенногоПроизводства КАК Т
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК СА
	|		ПО СА.Ссылка = Т.КорАналитикаУчетаПродукции
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ВыпускПродукции.Товары КАК Выпуск
	|		ПО Т.ДокументВыпуска = Выпуск.Ссылка
	|		И  Т.КодСтроки = Выпуск.КодСтроки
	|ГДЕ
	|	Т.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
	|	И Т.Организация В (&МассивОрганизаций)
	|	И Т.Активность
	|	И Т.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|	И Т.КодСтрокиПродукция = 0
	|СГРУППИРОВАТЬ ПО
	|	Т.Организация,
	|	Т.Подразделение,
	|	Выпуск.Назначение.НаправлениеДеятельности,
	|	Т.КодСтроки,
	|	Т.ВидРабот,
	|	СА.Номенклатура,
	|	Т.ГруппаПродукции,
	|	Т.ДокументВыпуска
	|";
КонецФункции

//++ НЕ УТКА

Функция ТекстДанныеПоНормативнымЗатратамНаОплатуТрудаНЗП()
	Возврат "
	|ВЫБРАТЬ
	|	Т.Организация,
	|	Т.Подразделение,
	|	ЗаказПродукция.Назначение.НаправлениеДеятельности КАК НаправлениеДеятельности,
	|	Т.ЗаказНаПроизводство,
	|	Т.Этап,
	|	Т.КодСтрокиПродукция,
	|	Т.ВидРабот,
	|	Т.Продукция,
	|	Т.ГруппаПродукции,
	|	НЕОПРЕДЕЛЕНО КАК ДокументВыпуска,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыБазыРаспределенияРасходов.СуммаРасходовНаОплатуТруда) КАК БазаРаспределения,
	|	СУММА(Т.НормативнаяСтоимость) КАК Стоимость
	|ИЗ
	|	РегистрНакопления.ТрудозатратыНезавершенногоПроизводства КАК Т
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.ЗаказНаПроизводство.Продукция КАК ЗаказПродукция
	|			ПО Т.ЗаказНаПроизводство = ЗаказПродукция.Ссылка
	|				И Т.КодСтрокиПродукция = ЗаказПродукция.КодСтроки
	|ГДЕ
	|	Т.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
	|	И Т.Организация В (&МассивОрганизаций)
	|	И Т.Активность
	|	И Т.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|	И Т.КодСтрокиПродукция <> 0
	|СГРУППИРОВАТЬ ПО
	|	Т.Организация,
	|	Т.Подразделение,
	|	ЗаказПродукция.Назначение.НаправлениеДеятельности,
	|	Т.ЗаказНаПроизводство,
	|	Т.Этап,
	|	Т.КодСтрокиПродукция,
	|	Т.ВидРабот,
	|	Т.Продукция,
	|	Т.ГруппаПродукции
	|";
КонецФункции
//-- НЕ УТКА

#КонецОбласти

#Область ИтоговаяБазаРаспределенияПоЭтапам

Функция ТекстПоЭтапамБазаПоСтоимостиМатЗатрат() //вт БазаРаспределения, использует Распределить, Данные_СтоимостьМатЗатрат, ОтборПоГруппамПродукции, ВыпускРаботСписанныхНаЗатратыБезЗаказа
	Возврат "
	|ВЫБРАТЬ
	|	ДД.Регистратор,
	|	ДД.Период,
	|	(ВЫБОР
	|		КОГДА НЕ &АналитическийУчетПоГруппамПродукции
	|			ТОГДА ЗНАЧЕНИЕ(Справочник.ГруппыАналитическогоУчетаНоменклатуры.ПустаяСсылка)
	|			ИНАЧЕ Данные.ГруппаПродукции КОНЕЦ) КАК ГруппаПродукции,
	|	Данные.ЗаказНаПроизводство,
	|	Данные.КодСтрокиПродукция,
	|	Данные.НаправлениеДеятельности,
	|	Данные.Этап,
	|	Данные.ДокументВыпуска,
	|	ДД.БазаРаспределения,
	|	ДД.Подразделение,
	|	ДД.СтатьяКалькуляции,
	|	Данные.Подразделение КАК ПодразделениеПриемник,
	|	ДД.ГруппироватьСуммыПоПодразделениям,
	|	0 КАК Количество,
	|	0 КАК Объем,
	|	0 КАК Вес,
	|	СУММА(Данные.Стоимость) КАК Стоимость
	|ПОМЕСТИТЬ
	|	БазаРаспределения
	|ИЗ
	|	Распределить КАК ДД
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Данные_СтоимостьМатЗатрат КАК Данные
	|		ПО Данные.Организация = ДД.Организация
	|		И (Данные.Подразделение = ДД.Подразделение ИЛИ ДД.Подразделение = ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка))
	|		И (Данные.НаправлениеДеятельности = ДД.НаправлениеДеятельности ИЛИ ДД.НаправлениеДеятельности = ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка))
	|		И ДД.БазаРаспределения = ЗНАЧЕНИЕ(Перечисление.ТипыБазыРаспределенияРасходов.СуммаМатериальныхЗатрат)
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ОтборПоГруппамПродукции КАК ОГ
	|		ПО ОГ.Регистратор = ДД.Регистратор
	|		И (ОГ.ГруппаПродукции = Данные.ГруппаПродукции
	|			ИЛИ ОГ.ГруппаПродукции = ЗНАЧЕНИЕ(Справочник.ГруппыАналитическогоУчетаНоменклатуры.ПустаяСсылка))
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ОтборПоПодразделениям КАК ОП
	|		ПО ОП.Регистратор = ДД.Регистратор
	|		И (ОП.Подразделение = Данные.Подразделение ИЛИ ОП.Подразделение = ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка))
	|	ЛЕВОЕ СОЕДИНЕНИЕ ВыпускРаботСписанныхНаЗатратыБезЗаказа КАК ВыпускРабот
	|			ПО ВыпускРабот.Распоряжение = Данные.ДокументВыпуска
	|				И ВыпускРабот.КодСтроки = Данные.КодСтрокиПродукция
	|ГДЕ
	|	НЕ(ДД.Организация = ЕСТЬNULL(ВыпускРабот.Организация, ЛОЖЬ)
	|		И ДД.ПодразделениеИсточник = ЕСТЬNULL(ВыпускРабот.ПодразделениеПриемник, ЛОЖЬ)
	|		И ДД.СтатьяРасходов = ЕСТЬNULL(ВыпускРабот.СтатьяРасходов, ЛОЖЬ)
	|		И ДД.АналитикаРасходов = ЕСТЬNULL(ВыпускРабот.АналитикаРасходов, ЛОЖЬ))
	|СГРУППИРОВАТЬ ПО
	|	ДД.Регистратор,
	|	ДД.Период,
	|	(ВЫБОР
	|		КОГДА НЕ &АналитическийУчетПоГруппамПродукции
	|			ТОГДА ЗНАЧЕНИЕ(Справочник.ГруппыАналитическогоУчетаНоменклатуры.ПустаяСсылка)
	|			ИНАЧЕ Данные.ГруппаПродукции КОНЕЦ),
	|	Данные.ЗаказНаПроизводство,
	|	Данные.КодСтрокиПродукция,
	|	Данные.Этап,
	|	Данные.ДокументВыпуска,
	|	ДД.БазаРаспределения,
	|	ДД.Подразделение,
	|	ДД.СтатьяКалькуляции,
	|	Данные.Подразделение,
	|	Данные.НаправлениеДеятельности,
	|	ДД.ГруппироватьСуммыПоПодразделениям
	|";
КонецФункции

Функция ТекстПоЭтапамБазаПоЗатратамНаОплатуТруда() // использует Распределить, Данные_ЗатратыНаОплатуТруда, ОтборПоГруппамПродукции, ВыпускРаботСписанныхНаЗатратыБезЗаказа
	Возврат "
	|ВЫБРАТЬ
	|	ДД.Регистратор,
	|	ДД.Период,
	|	(ВЫБОР
	|		КОГДА НЕ &АналитическийУчетПоГруппамПродукции
	|			ТОГДА ЗНАЧЕНИЕ(Справочник.ГруппыАналитическогоУчетаНоменклатуры.ПустаяСсылка)
	|			ИНАЧЕ Данные.ГруппаПродукции КОНЕЦ) КАК ГруппаПродукции,
	|	Данные.ЗаказНаПроизводство,
	|	Данные.КодСтрокиПродукция,
	|	Данные.НаправлениеДеятельности,
	|	Данные.Этап,
	|	Данные.ДокументВыпуска,
	|	ДД.БазаРаспределения,
	|	ДД.Подразделение,
	|	ДД.СтатьяКалькуляции,
	|	Данные.Подразделение КАК ПодразделениеПриемник,
	|	ДД.ГруппироватьСуммыПоПодразделениям,
	|	0 КАК Количество,
	|	0 КАК Объем,
	|	0 КАК Вес,
	|	СУММА(Данные.Стоимость) КАК Стоимость
	|ИЗ
	|	Распределить КАК ДД
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Данные_ЗатратыНаОплатуТруда КАК Данные
	|		ПО Данные.Организация = ДД.Организация
	|		И (Данные.Подразделение = ДД.Подразделение ИЛИ ДД.Подразделение = ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка))
	|		И (Данные.НаправлениеДеятельности = ДД.НаправлениеДеятельности ИЛИ ДД.НаправлениеДеятельности = ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка))
	|		И ДД.БазаРаспределения = ЗНАЧЕНИЕ(Перечисление.ТипыБазыРаспределенияРасходов.СуммаРасходовНаОплатуТруда)
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ОтборПоГруппамПродукции КАК ОГ
	|		ПО ОГ.Регистратор = ДД.Регистратор
	|		И (ОГ.ГруппаПродукции = Данные.ГруппаПродукции
	|			ИЛИ ОГ.ГруппаПродукции = ЗНАЧЕНИЕ(Справочник.ГруппыАналитическогоУчетаНоменклатуры.ПустаяСсылка))
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ОтборПоПодразделениям КАК ОП
	|		ПО ОП.Регистратор = ДД.Регистратор
	|		И (ОП.Подразделение = Данные.Подразделение ИЛИ ОП.Подразделение = ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка))
	|	ЛЕВОЕ СОЕДИНЕНИЕ ВыпускРаботСписанныхНаЗатратыБезЗаказа КАК ВыпускРабот
	|			ПО ВыпускРабот.Распоряжение = Данные.ДокументВыпуска
	|				И ВыпускРабот.КодСтроки = Данные.КодСтрокиПродукция
	|ГДЕ
	|	НЕ(ДД.Организация = ЕСТЬNULL(ВыпускРабот.Организация, ЛОЖЬ)
	|		И ДД.ПодразделениеИсточник = ЕСТЬNULL(ВыпускРабот.ПодразделениеПриемник, ЛОЖЬ)
	|		И ДД.СтатьяРасходов = ЕСТЬNULL(ВыпускРабот.СтатьяРасходов, ЛОЖЬ)
	|		И ДД.АналитикаРасходов = ЕСТЬNULL(ВыпускРабот.АналитикаРасходов, ЛОЖЬ))
	|СГРУППИРОВАТЬ ПО
	|	ДД.Регистратор,
	|	ДД.Период,
	|	(ВЫБОР
	|		КОГДА НЕ &АналитическийУчетПоГруппамПродукции
	|			ТОГДА ЗНАЧЕНИЕ(Справочник.ГруппыАналитическогоУчетаНоменклатуры.ПустаяСсылка)
	|			ИНАЧЕ Данные.ГруппаПродукции КОНЕЦ),
	|	Данные.ЗаказНаПроизводство,
	|	Данные.КодСтрокиПродукция,
	|	Данные.Этап,
	|	Данные.ДокументВыпуска,
	|	ДД.БазаРаспределения,
	|	ДД.Подразделение,
	|	ДД.СтатьяКалькуляции,
	|	Данные.Подразделение,
	|	Данные.НаправлениеДеятельности,
	|	ДД.ГруппироватьСуммыПоПодразделениям
	|";
КонецФункции

Функция ТекстПоЭтапамБазаПоНормативнымЗатратамНаОплатуТруда() // использует Распределить, Данные_НормативныеЗатратыНаОплатуТруда, ОтборПоГруппамПродукции, ВыпускРаботСписанныхНаЗатратыБезЗаказа
	Возврат "
	|ВЫБРАТЬ
	|	ДД.Регистратор,
	|	ДД.Период,
	|	(ВЫБОР
	|		КОГДА НЕ &АналитическийУчетПоГруппамПродукции
	|			ТОГДА ЗНАЧЕНИЕ(Справочник.ГруппыАналитическогоУчетаНоменклатуры.ПустаяСсылка)
	|			ИНАЧЕ Данные.ГруппаПродукции КОНЕЦ) КАК ГруппаПродукции,
	|	Данные.ЗаказНаПроизводство,
	|	Данные.КодСтрокиПродукция,
	|	Данные.НаправлениеДеятельности,
	|	Данные.Этап,
	|	Данные.ДокументВыпуска,
	|	ДД.БазаРаспределения,
	|	ДД.Подразделение,
	|	ДД.СтатьяКалькуляции,
	|	Данные.Подразделение КАК ПодразделениеПриемник,
	|	ДД.ГруппироватьСуммыПоПодразделениям,
	|	0 КАК Количество,
	|	0 КАК Объем,
	|	0 КАК Вес,
	|	СУММА(Данные.Стоимость) КАК Стоимость
	|ИЗ
	|	Распределить КАК ДД
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Данные_НормативныеЗатратыНаОплатуТруда КАК Данные
	|		ПО Данные.Организация = ДД.Организация
	|		И (Данные.Подразделение = ДД.Подразделение ИЛИ ДД.Подразделение = ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка))
	|		И (Данные.НаправлениеДеятельности = ДД.НаправлениеДеятельности ИЛИ ДД.НаправлениеДеятельности = ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка))
	|		И ДД.БазаРаспределения = ЗНАЧЕНИЕ(Перечисление.ТипыБазыРаспределенияРасходов.НормативыОплатыТруда)
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ОтборПоГруппамПродукции КАК ОГ
	|		ПО ОГ.Регистратор = ДД.Регистратор
	|		И (ОГ.ГруппаПродукции = Данные.ГруппаПродукции
	|			ИЛИ ОГ.ГруппаПродукции = ЗНАЧЕНИЕ(Справочник.ГруппыАналитическогоУчетаНоменклатуры.ПустаяСсылка))
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ОтборПоПодразделениям КАК ОП
	|		ПО ОП.Регистратор = ДД.Регистратор
	|		И (ОП.Подразделение = Данные.Подразделение ИЛИ ОП.Подразделение = ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка))
	|	ЛЕВОЕ СОЕДИНЕНИЕ ВыпускРаботСписанныхНаЗатратыБезЗаказа КАК ВыпускРабот
	|			ПО ВыпускРабот.Распоряжение = Данные.ДокументВыпуска
	|				И ВыпускРабот.КодСтроки = Данные.КодСтрокиПродукция
	|ГДЕ
	|	НЕ(ДД.Организация = ЕСТЬNULL(ВыпускРабот.Организация, ЛОЖЬ)
	|		И ДД.ПодразделениеИсточник = ЕСТЬNULL(ВыпускРабот.ПодразделениеПриемник, ЛОЖЬ)
	|		И ДД.СтатьяРасходов = ЕСТЬNULL(ВыпускРабот.СтатьяРасходов, ЛОЖЬ)
	|		И ДД.АналитикаРасходов = ЕСТЬNULL(ВыпускРабот.АналитикаРасходов, ЛОЖЬ))
	|СГРУППИРОВАТЬ ПО
	|	ДД.Регистратор,
	|	ДД.Период,
	|	(ВЫБОР
	|		КОГДА НЕ &АналитическийУчетПоГруппамПродукции
	|			ТОГДА ЗНАЧЕНИЕ(Справочник.ГруппыАналитическогоУчетаНоменклатуры.ПустаяСсылка)
	|			ИНАЧЕ Данные.ГруппаПродукции КОНЕЦ),
	|	Данные.ЗаказНаПроизводство,
	|	Данные.КодСтрокиПродукция,
	|	Данные.Этап,
	|	Данные.ДокументВыпуска,
	|	ДД.БазаРаспределения,
	|	ДД.Подразделение,
	|	ДД.СтатьяКалькуляции,
	|	Данные.Подразделение,
	|	Данные.НаправлениеДеятельности,
	|	ДД.ГруппироватьСуммыПоПодразделениям
	|";
КонецФункции

Функция ТекстПоЭтапамБазаПоУказаннымМатериалам() // использует Распределить, Данные_ПоУказаннымМатериалам, ОтборПоМатериалам, ОтборПоГруппамПродукции, ВыпускРаботСписанныхНаЗатратыБезЗаказа
	Возврат "
	|ВЫБРАТЬ
	|	ДД.Регистратор,
	|	ДД.Период,
	|	(ВЫБОР
	|		КОГДА НЕ &АналитическийУчетПоГруппамПродукции
	|			ТОГДА ЗНАЧЕНИЕ(Справочник.ГруппыАналитическогоУчетаНоменклатуры.ПустаяСсылка)
	|			ИНАЧЕ Данные.ГруппаПродукции КОНЕЦ) КАК ГруппаПродукции,
	|	Данные.ЗаказНаПроизводство,
	|	Данные.КодСтрокиПродукция,
	|	Данные.НаправлениеДеятельности,
	|	Данные.Этап,
	|	(ВЫБОР
	|		КОГДА Данные.ЗаказНаПроизводство ССЫЛКА Документ.ВыпускПродукции
	|			ТОГДА Данные.ЗаказНаПроизводство
	|			ИНАЧЕ НЕОПРЕДЕЛЕНО КОНЕЦ) КАК ДокументВыпуска,
	|	ДД.БазаРаспределения,
	|	ДД.Подразделение,
	|	ДД.СтатьяКалькуляции,
	|	Данные.Подразделение КАК ПодразделениеПриемник,
	|	ДД.ГруппироватьСуммыПоПодразделениям,
	|	СУММА(Данные.Количество) КАК Количество,
	|	СУММА(Данные.Объем) КАК Объем,
	|	СУММА(Данные.Вес) КАК Вес,
	|	0 КАК Стоимость
	|ИЗ
	|	Распределить КАК ДД
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Данные_ПоУказаннымМатериалам КАК Данные
	|		ПО Данные.Организация = ДД.Организация
	|		И (Данные.Подразделение = ДД.Подразделение ИЛИ ДД.Подразделение = ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка))
	|		И (Данные.НаправлениеДеятельности = ДД.НаправлениеДеятельности ИЛИ ДД.НаправлениеДеятельности = ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка))
	|		И (ДД.БазаРаспределения = ЗНАЧЕНИЕ(Перечисление.ТипыБазыРаспределенияРасходов.КоличествоУказанныхМатериалов)
	|			ИЛИ ДД.БазаРаспределения = ЗНАЧЕНИЕ(Перечисление.ТипыБазыРаспределенияРасходов.ОбъемУказанныхМатериалов)
	|			ИЛИ ДД.БазаРаспределения = ЗНАЧЕНИЕ(Перечисление.ТипыБазыРаспределенияРасходов.ВесУказанныхМатериалов))
	|	ЛЕВОЕ СОЕДИНЕНИЕ ДокументыСОтборами КАК ДокументыСОтборами
	|		ПО ДокументыСОтборами.Регистратор = ДД.Регистратор
	|	ЛЕВОЕ СОЕДИНЕНИЕ ОтборПоМатериалам КАК ОМ
	|		ПО ОМ.Регистратор = ДД.Регистратор
	|		И ОМ.Материал = Данные.Материал
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ОтборПоГруппамПродукции КАК ОГ
	|		ПО ОГ.Регистратор = ДД.Регистратор
	|		И (ОГ.ГруппаПродукции = Данные.ГруппаПродукции
	|			ИЛИ ОГ.ГруппаПродукции = ЗНАЧЕНИЕ(Справочник.ГруппыАналитическогоУчетаНоменклатуры.ПустаяСсылка))
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ОтборПоПодразделениям КАК ОП
	|		ПО ОП.Регистратор = ДД.Регистратор
	|		И (ОП.Подразделение = Данные.Подразделение ИЛИ ОП.Подразделение = ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка))
	|	ЛЕВОЕ СОЕДИНЕНИЕ ВыпускРаботСписанныхНаЗатратыБезЗаказа КАК ВыпускРабот
	|			ПО ВыпускРабот.Распоряжение = Данные.ЗаказНаПроизводство
	|				И ВыпускРабот.КодСтроки = Данные.КодСтрокиПродукция
	|ГДЕ
	|	НЕ(ДД.Организация = ЕСТЬNULL(ВыпускРабот.Организация, ЛОЖЬ)
	|		И ДД.ПодразделениеИсточник = ЕСТЬNULL(ВыпускРабот.ПодразделениеПриемник, ЛОЖЬ)
	|		И ДД.СтатьяРасходов = ЕСТЬNULL(ВыпускРабот.СтатьяРасходов, ЛОЖЬ)
	|		И ДД.АналитикаРасходов = ЕСТЬNULL(ВыпускРабот.АналитикаРасходов, ЛОЖЬ))
	|	И (ДокументыСОтборами.Регистратор ЕСТЬ NULL
	|		ИЛИ НЕ ОМ.Регистратор ЕСТЬ NULL)
	|
	|СГРУППИРОВАТЬ ПО
	|	ДД.Регистратор,
	|	ДД.Период,
	|	(ВЫБОР
	|		КОГДА НЕ &АналитическийУчетПоГруппамПродукции
	|			ТОГДА ЗНАЧЕНИЕ(Справочник.ГруппыАналитическогоУчетаНоменклатуры.ПустаяСсылка)
	|			ИНАЧЕ Данные.ГруппаПродукции КОНЕЦ),
	|	Данные.ЗаказНаПроизводство,
	|	Данные.КодСтрокиПродукция,
	|	Данные.Этап,
	|	(ВЫБОР
	|		КОГДА Данные.ЗаказНаПроизводство ССЫЛКА Документ.ВыпускПродукции
	|			ТОГДА Данные.ЗаказНаПроизводство
	|			ИНАЧЕ НЕОПРЕДЕЛЕНО КОНЕЦ),
	|	ДД.БазаРаспределения,
	|	ДД.Подразделение,
	|	ДД.СтатьяКалькуляции,
	|	Данные.Подразделение,
	|	Данные.НаправлениеДеятельности,
	|	ДД.ГруппироватьСуммыПоПодразделениям
	|";
КонецФункции

Функция ТекстПоЭтапамБазаПоПродукции() // вт Распределить, Данные_ПоПродукции, ОтборПоГруппамПродукции, ВыпускРаботСписанныхНаЗатратыБезЗаказа
	Возврат "
	|ВЫБРАТЬ
	|	ДД.Регистратор,
	|	ДД.Период,
	|	(ВЫБОР
	|		КОГДА НЕ &АналитическийУчетПоГруппамПродукции
	|			ТОГДА ЗНАЧЕНИЕ(Справочник.ГруппыАналитическогоУчетаНоменклатуры.ПустаяСсылка)
	|			ИНАЧЕ Данные.ГруппаПродукции КОНЕЦ) КАК ГруппаПродукции,
	|	(ВЫБОР
	|		КОГДА Данные.ЗаказНаПроизводство ССЫЛКА Документ.ВыпускПродукции ТОГДА НЕОПРЕДЕЛЕНО
	|		ИНАЧЕ Данные.ЗаказНаПроизводство КОНЕЦ) КАК ЗаказНаПроизводство,
	|	Данные.КодСтрокиПродукция,
	|	Данные.НаправлениеДеятельности,
	|	Данные.Этап,
	|	(ВЫБОР
	|		КОГДА Данные.ЗаказНаПроизводство ССЫЛКА Документ.ВыпускПродукции ТОГДА Данные.ЗаказНаПроизводство
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО КОНЕЦ) КАК ДокументВыпуска,
	|	ДД.БазаРаспределения,
	|	ДД.Подразделение,
	|	ДД.СтатьяКалькуляции,
	|	Данные.Подразделение КАК ПодразделениеПриемник,
	|	ДД.ГруппироватьСуммыПоПодразделениям,
	|	СУММА(Данные.Количество) КАК Количество,
	|	СУММА(Данные.Объем) КАК Объем,
	|	СУММА(Данные.Вес) КАК Вес,
	|	0 КАК Стоимость
	|ИЗ
	|	Распределить КАК ДД
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Данные_ПоПродукции КАК Данные
	|		ПО Данные.Организация = ДД.Организация
	|		И (Данные.Подразделение = ДД.Подразделение ИЛИ ДД.Подразделение = ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка))
	|		И (Данные.НаправлениеДеятельности = ДД.НаправлениеДеятельности ИЛИ ДД.НаправлениеДеятельности = ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка))
	|		И (ДД.БазаРаспределения = ЗНАЧЕНИЕ(Перечисление.ТипыБазыРаспределенияРасходов.КоличествоПродукции)
	|			ИЛИ ДД.БазаРаспределения = ЗНАЧЕНИЕ(Перечисление.ТипыБазыРаспределенияРасходов.ОбъемПродукции)
	|			ИЛИ ДД.БазаРаспределения = ЗНАЧЕНИЕ(Перечисление.ТипыБазыРаспределенияРасходов.ВесПродукции))
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ОтборПоГруппамПродукции КАК ОГ
	|		ПО ОГ.Регистратор = ДД.Регистратор
	|		И (ОГ.ГруппаПродукции = Данные.ГруппаПродукции
	|			ИЛИ ОГ.ГруппаПродукции = ЗНАЧЕНИЕ(Справочник.ГруппыАналитическогоУчетаНоменклатуры.ПустаяСсылка))
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ОтборПоПодразделениям КАК ОП
	|		ПО ОП.Регистратор = ДД.Регистратор
	|		И (ОП.Подразделение = Данные.Подразделение ИЛИ ОП.Подразделение = ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка))
	|	ЛЕВОЕ СОЕДИНЕНИЕ ВыпускРаботСписанныхНаЗатратыБезЗаказа КАК ВыпускРабот
	|			ПО ВыпускРабот.Распоряжение = Данные.ЗаказНаПроизводство
	|				И ВыпускРабот.КодСтроки = Данные.КодСтрокиПродукция
	|ГДЕ
	|	НЕ(ДД.Организация = ЕСТЬNULL(ВыпускРабот.Организация, ЛОЖЬ)
	|		И ДД.ПодразделениеИсточник = ЕСТЬNULL(ВыпускРабот.ПодразделениеПриемник, ЛОЖЬ)
	|		И ДД.СтатьяРасходов = ЕСТЬNULL(ВыпускРабот.СтатьяРасходов, ЛОЖЬ)
	|		И ДД.АналитикаРасходов = ЕСТЬNULL(ВыпускРабот.АналитикаРасходов, ЛОЖЬ))
	|СГРУППИРОВАТЬ ПО
	|	ДД.Регистратор,
	|	ДД.Период,
	|	(ВЫБОР
	|		КОГДА НЕ &АналитическийУчетПоГруппамПродукции
	|			ТОГДА ЗНАЧЕНИЕ(Справочник.ГруппыАналитическогоУчетаНоменклатуры.ПустаяСсылка)
	|			ИНАЧЕ Данные.ГруппаПродукции КОНЕЦ),
	|	(ВЫБОР
	|		КОГДА Данные.ЗаказНаПроизводство ССЫЛКА Документ.ВыпускПродукции ТОГДА НЕОПРЕДЕЛЕНО
	|		ИНАЧЕ Данные.ЗаказНаПроизводство КОНЕЦ),
	|	Данные.КодСтрокиПродукция,
	|	Данные.Этап,
	|	(ВЫБОР
	|		КОГДА Данные.ЗаказНаПроизводство ССЫЛКА Документ.ВыпускПродукции ТОГДА Данные.ЗаказНаПроизводство
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО КОНЕЦ),
	|	ДД.БазаРаспределения,
	|	ДД.Подразделение,
	|	ДД.СтатьяКалькуляции,
	|	Данные.Подразделение,
	|	Данные.НаправлениеДеятельности,
	|	ДД.ГруппироватьСуммыПоПодразделениям
	|";
КонецФункции

Функция ТекстПоЭтапамБазаПоПлановойСтоимости() // использует Распределить, Данные_ПоПлановойСтоимости, ОтборПоГруппамПродукции, ВыпускРаботСписанныхНаЗатратыБезЗаказа
	Возврат "
	|ВЫБРАТЬ
	|	ДД.Регистратор,
	|	ДД.Период,
	|	(ВЫБОР
	|		КОГДА НЕ &АналитическийУчетПоГруппамПродукции
	|			ТОГДА ЗНАЧЕНИЕ(Справочник.ГруппыАналитическогоУчетаНоменклатуры.ПустаяСсылка)
	|			ИНАЧЕ Данные.ГруппаПродукции КОНЕЦ) КАК ГруппаПродукции,
	|	(ВЫБОР
	|		КОГДА Данные.ЗаказНаПроизводство ССЫЛКА Документ.ВыпускПродукции ТОГДА НЕОПРЕДЕЛЕНО
	|		ИНАЧЕ Данные.ЗаказНаПроизводство КОНЕЦ) КАК ЗаказНаПроизводство,
	|	Данные.КодСтрокиПродукция,
	|	Данные.НаправлениеДеятельности,
	|	Данные.Этап,
	|	(ВЫБОР
	|		КОГДА Данные.ЗаказНаПроизводство ССЫЛКА Документ.ВыпускПродукции ТОГДА Данные.ЗаказНаПроизводство
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО КОНЕЦ) КАК ДокументВыпуска,
	|	ДД.БазаРаспределения,
	|	ДД.Подразделение,
	|	ДД.СтатьяКалькуляции,
	|	Данные.Подразделение КАК ПодразделениеПриемник,
	|	ДД.ГруппироватьСуммыПоПодразделениям,
	|	СУММА(Данные.Количество) КАК Количество,
	|	0 КАК Объем,
	|	0 КАК Вес,
	|	СУММА(Данные.Количество * Цены.Цена) КАК Стоимость
	|ИЗ
	|	Распределить КАК ДД
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Данные_ПоПлановойСтоимости КАК Данные
	|		ПО Данные.Организация = ДД.Организация
	|		И (Данные.Подразделение = ДД.Подразделение ИЛИ ДД.Подразделение = ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка))
	|		И (Данные.НаправлениеДеятельности = ДД.НаправлениеДеятельности ИЛИ ДД.НаправлениеДеятельности = ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка))
	|		И ДД.БазаРаспределения = ЗНАЧЕНИЕ(Перечисление.ТипыБазыРаспределенияРасходов.ПлановаяСтоимостьПродукции)
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ОтборПоГруппамПродукции КАК ОГ
	|		ПО ОГ.Регистратор = ДД.Регистратор
	|		И (ОГ.ГруппаПродукции = Данные.ГруппаПродукции
	|			ИЛИ ОГ.ГруппаПродукции = ЗНАЧЕНИЕ(Справочник.ГруппыАналитическогоУчетаНоменклатуры.ПустаяСсылка))
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ОтборПоПодразделениям КАК ОП
	|		ПО ОП.Регистратор = ДД.Регистратор
	|		И (ОП.Подразделение = Данные.Подразделение ИЛИ ОП.Подразделение = ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка))
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.ЦеныНоменклатуры.СрезПоследних(&ОкончаниеПериода, ВидЦены = &ВидПлановыхЦен) КАК Цены
	|		ПО Цены.Номенклатура = Данные.Номенклатура
	|		И Цены.Характеристика = Данные.Характеристика
	|	ЛЕВОЕ СОЕДИНЕНИЕ ВыпускРаботСписанныхНаЗатратыБезЗаказа КАК ВыпускРабот
	|			ПО ВыпускРабот.Распоряжение = Данные.ЗаказНаПроизводство
	|				И ВыпускРабот.КодСтроки = Данные.КодСтрокиПродукция
	|ГДЕ
	|	НЕ(ДД.Организация = ЕСТЬNULL(ВыпускРабот.Организация, ЛОЖЬ)
	|		И ДД.ПодразделениеИсточник = ЕСТЬNULL(ВыпускРабот.ПодразделениеПриемник, ЛОЖЬ)
	|		И ДД.СтатьяРасходов = ЕСТЬNULL(ВыпускРабот.СтатьяРасходов, ЛОЖЬ)
	|		И ДД.АналитикаРасходов = ЕСТЬNULL(ВыпускРабот.АналитикаРасходов, ЛОЖЬ))
	|СГРУППИРОВАТЬ ПО
	|	ДД.Регистратор,
	|	ДД.Период,
	|	(ВЫБОР
	|		КОГДА НЕ &АналитическийУчетПоГруппамПродукции
	|			ТОГДА ЗНАЧЕНИЕ(Справочник.ГруппыАналитическогоУчетаНоменклатуры.ПустаяСсылка)
	|			ИНАЧЕ Данные.ГруппаПродукции КОНЕЦ),
	|	(ВЫБОР
	|		КОГДА Данные.ЗаказНаПроизводство ССЫЛКА Документ.ВыпускПродукции ТОГДА НЕОПРЕДЕЛЕНО
	|		ИНАЧЕ Данные.ЗаказНаПроизводство КОНЕЦ),
	|	Данные.КодСтрокиПродукция,
	|	Данные.Этап,
	|	(ВЫБОР
	|		КОГДА Данные.ЗаказНаПроизводство ССЫЛКА Документ.ВыпускПродукции ТОГДА Данные.ЗаказНаПроизводство
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО КОНЕЦ),
	|	ДД.БазаРаспределения,
	|	ДД.Подразделение,
	|	ДД.СтатьяКалькуляции,
	|	Данные.Подразделение,
	|	Данные.НаправлениеДеятельности,
	|	ДД.ГруппироватьСуммыПоПодразделениям
	|";
КонецФункции

Функция ТекстПоЭтапамБазаПоКоличествуУказанныхТрудозатрат() // использует Распределить, Данные_ПоУказаннымТрудозатратам, ОтборПоВидамРабот, ОтборПоГруппамПродукции, ВыпускРаботСписанныхНаЗатратыБезЗаказа
	Возврат "
	|ВЫБРАТЬ
	|	ДД.Регистратор,
	|	ДД.Период,
	|	(ВЫБОР
	|		КОГДА НЕ &АналитическийУчетПоГруппамПродукции
	|			ТОГДА ЗНАЧЕНИЕ(Справочник.ГруппыАналитическогоУчетаНоменклатуры.ПустаяСсылка)
	|			ИНАЧЕ Данные.ГруппаПродукции КОНЕЦ) КАК ГруппаПродукции,
	|	(ВЫБОР
	|		КОГДА Данные.ДокументВыпуска <> ЗНАЧЕНИЕ(Документ.ВыпускПродукции.ПустаяСсылка) И Данные.ДокументВыпуска <> НЕОПРЕДЕЛЕНО ТОГДА НЕОПРЕДЕЛЕНО
	|		ИНАЧЕ Данные.ЗаказНаПроизводство КОНЕЦ) КАК ЗаказНаПроизводство,
	|	(ВЫБОР
	|		КОГДА Данные.ДокументВыпуска <> ЗНАЧЕНИЕ(Документ.ВыпускПродукции.ПустаяСсылка) И Данные.ДокументВыпуска <> НЕОПРЕДЕЛЕНО ТОГДА Данные.КодСтроки
	|		ИНАЧЕ Данные.КодСтрокиПродукция КОНЕЦ) КАК КодСтрокиПродукция,
	|	Данные.НаправлениеДеятельности,
	|	Данные.Этап,
	|	Данные.ДокументВыпуска КАК ДокументВыпуска,
	|	ДД.БазаРаспределения,
	|	ДД.Подразделение,
	|	ДД.СтатьяКалькуляции,
	|	Данные.Подразделение КАК ПодразделениеПриемник,
	|	ДД.ГруппироватьСуммыПоПодразделениям,
	|	СУММА(Данные.Количество) КАК Количество,
	|	0 КАК Объем,
	|	0 КАК Вес,
	|	0 КАК Стоимость
	|ИЗ
	|	Распределить КАК ДД
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Данные_ПоУказаннымТрудозатратам КАК Данные
	|		ПО Данные.Организация = ДД.Организация
	|		И (Данные.Подразделение = ДД.Подразделение ИЛИ ДД.Подразделение = ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка))
	|		И (Данные.НаправлениеДеятельности = ДД.НаправлениеДеятельности ИЛИ ДД.НаправлениеДеятельности = ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка))
	|		И ДД.БазаРаспределения = ЗНАЧЕНИЕ(Перечисление.ТипыБазыРаспределенияРасходов.КоличествоРаботУказанныхВидов)
	|	ЛЕВОЕ СОЕДИНЕНИЕ ДокументыСОтборами КАК ДокументыСОтборами
	|		ПО ДокументыСОтборами.Регистратор = ДД.Регистратор
	|	ЛЕВОЕ СОЕДИНЕНИЕ ОтборПоВидамРабот КАК ОР
	|		ПО ОР.Регистратор = ДД.Регистратор
	|		И ОР.ВидРабот = Данные.ВидРабот
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ОтборПоГруппамПродукции КАК ОГ
	|		ПО ОГ.Регистратор = ДД.Регистратор
	|		И (ОГ.ГруппаПродукции = Данные.ГруппаПродукции
	|			ИЛИ ОГ.ГруппаПродукции = ЗНАЧЕНИЕ(Справочник.ГруппыАналитическогоУчетаНоменклатуры.ПустаяСсылка))
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ОтборПоПодразделениям КАК ОП
	|		ПО ОП.Регистратор = ДД.Регистратор
	|		И (ОП.Подразделение = Данные.Подразделение ИЛИ ОП.Подразделение = ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка))
	|	ЛЕВОЕ СОЕДИНЕНИЕ ВыпускРаботСписанныхНаЗатратыБезЗаказа КАК ВыпускРабот
	|			ПО ВыпускРабот.Распоряжение = Данные.ДокументВыпуска
	|				И ВыпускРабот.КодСтроки = Данные.КодСтрокиПродукция
	|ГДЕ
	|	НЕ(ДД.Организация = ЕСТЬNULL(ВыпускРабот.Организация, ЛОЖЬ)
	|		И ДД.ПодразделениеИсточник = ЕСТЬNULL(ВыпускРабот.ПодразделениеПриемник, ЛОЖЬ)
	|		И ДД.СтатьяРасходов = ЕСТЬNULL(ВыпускРабот.СтатьяРасходов, ЛОЖЬ)
	|		И ДД.АналитикаРасходов = ЕСТЬNULL(ВыпускРабот.АналитикаРасходов, ЛОЖЬ))
	|	И (ДокументыСОтборами.Регистратор ЕСТЬ NULL
	|		ИЛИ НЕ ОР.Регистратор ЕСТЬ NULL)
	|
	|СГРУППИРОВАТЬ ПО
	|	ДД.Регистратор,
	|	ДД.Период,
	|	(ВЫБОР
	|		КОГДА НЕ &АналитическийУчетПоГруппамПродукции
	|			ТОГДА ЗНАЧЕНИЕ(Справочник.ГруппыАналитическогоУчетаНоменклатуры.ПустаяСсылка)
	|			ИНАЧЕ Данные.ГруппаПродукции КОНЕЦ),
	|	(ВЫБОР
	|		КОГДА Данные.ДокументВыпуска <> ЗНАЧЕНИЕ(Документ.ВыпускПродукции.ПустаяСсылка) И Данные.ДокументВыпуска <> НЕОПРЕДЕЛЕНО ТОГДА НЕОПРЕДЕЛЕНО
	|		ИНАЧЕ Данные.ЗаказНаПроизводство КОНЕЦ),
	|	(ВЫБОР
	|		КОГДА Данные.ДокументВыпуска <> ЗНАЧЕНИЕ(Документ.ВыпускПродукции.ПустаяСсылка) И Данные.ДокументВыпуска <> НЕОПРЕДЕЛЕНО ТОГДА Данные.КодСтроки
	|		ИНАЧЕ Данные.КодСтрокиПродукция КОНЕЦ),
	|	Данные.Этап,
	|	Данные.ДокументВыпуска,
	|	ДД.БазаРаспределения,
	|	ДД.Подразделение,
	|	ДД.СтатьяКалькуляции,
	|	Данные.Подразделение,
	|	Данные.НаправлениеДеятельности,
	|	ДД.ГруппироватьСуммыПоПодразделениям
	|";
КонецФункции

Функция ТекстПоЭтапамБазаВручнуюПоЗаказам() // использует Распределить
	Возврат "
	|ВЫБРАТЬ
	|	ДД.Регистратор,
	|	ДД.Период,
	|	ВЫБОР
	|		КОГДА НЕ &АналитическийУчетПоГруппамПродукции ТОГДА 
	|			ЗНАЧЕНИЕ(Справочник.ГруппыАналитическогоУчетаНоменклатуры.ПустаяСсылка)
	|		ИНАЧЕ
	|			ВЫБОР
	//++ НЕ УТКА
	|				КОГДА НЕ ТабПродукция.Ссылка ЕСТЬ NULL ТОГДА ТабПродукция.Номенклатура.ГруппаАналитическогоУчета
	//-- НЕ УТКА
	|				КОГДА НЕ ПродукцияОтПереработчика.Ссылка ЕСТЬ NULL ТОГДА ПродукцияОтПереработчика.Номенклатура.ГруппаАналитическогоУчета
	|			КОНЕЦ
	|	КОНЕЦ КАК ГруппаПродукции,
	|	Данные.ЗаказНаПроизводство,
	|	Данные.КодСтрокиПродукция,
	//++ НЕ УТКА
	|	ВЫБОР КОГДА ИСТИНА ТОГДА ТабПродукция.Назначение.НаправлениеДеятельности ИНАЧЕ
	//-- НЕ УТКА
	|	НЕОПРЕДЕЛЕНО
	//++ НЕ УТКА
	|	КОНЕЦ
	//-- НЕ УТКА
	|		КАК НаправлениеДеятельности,
	|	Данные.Этап,
	|	НЕОПРЕДЕЛЕНО КАК ДокументВыпуска,
	|	ДД.БазаРаспределения,
	|	ДД.Подразделение,
	|	Данные.СтатьяКалькуляции,
	|	ЕСТЬNULL(ЗП.Подразделение, Данные.Этап.Подразделение) КАК ПодразделениеПриемник,
	|	ДД.ГруппироватьСуммыПоПодразделениям,
	|	СУММА(Данные.ДоляСтоимости) КАК Количество,
	|	0 КАК Объем,
	|	0 КАК Вес,
	|	0 КАК Стоимость
	|ИЗ
	|	Распределить КАК ДД
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.РаспределениеПрочихЗатрат.Вручную КАК Данные
	|		ПО Данные.Ссылка = ДД.Регистратор
	|		И ДД.ПартииУказаныВручную
	|		И ДД.СтатьяКалькуляции = Данные.СтатьяКалькуляции
	//++ НЕ УТКА
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.ЗаказНаПроизводство.Продукция КАК ТабПродукция
	|		ПО &АналитическийУчетПоГруппамПродукции
	|		И Данные.ЗаказНаПроизводство = ТабПродукция.Ссылка
	|		И Данные.КодСтрокиПродукция = ТабПродукция.КодСтроки
	//-- НЕ УТКА
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.ЗаказПереработчику.Продукция КАК ПродукцияОтПереработчика
	|		ПО &АналитическийУчетПоГруппамПродукции
	|		И Данные.ЗаказНаПроизводство = ПродукцияОтПереработчика.Ссылка
	|		И Данные.КодСтрокиПродукция = ПродукцияОтПереработчика.КодСтроки
	|
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.ЗаказПереработчику КАК ЗП
	|		ПО Данные.ЗаказНаПроизводство = ЗП.Ссылка
	|СГРУППИРОВАТЬ ПО
	|	ДД.Регистратор,
	|	ДД.Период,
	|	ВЫБОР
	|		КОГДА НЕ &АналитическийУчетПоГруппамПродукции ТОГДА 
	|			ЗНАЧЕНИЕ(Справочник.ГруппыАналитическогоУчетаНоменклатуры.ПустаяСсылка)
	|		ИНАЧЕ
	|			ВЫБОР
	//++ НЕ УТКА
	|				КОГДА НЕ ТабПродукция.Ссылка ЕСТЬ NULL ТОГДА ТабПродукция.Номенклатура.ГруппаАналитическогоУчета
	//-- НЕ УТКА
	|				КОГДА НЕ ПродукцияОтПереработчика.Ссылка ЕСТЬ NULL ТОГДА ПродукцияОтПереработчика.Номенклатура.ГруппаАналитическогоУчета
	|			КОНЕЦ
	|	КОНЕЦ,
	|	Данные.ЗаказНаПроизводство,
	|	Данные.КодСтрокиПродукция,
	//++ НЕ УТКА
	|	ВЫБОР КОГДА ИСТИНА ТОГДА ТабПродукция.Назначение.НаправлениеДеятельности ИНАЧЕ НЕОПРЕДЕЛЕНО КОНЕЦ,
	//-- НЕ УТКА
	|	Данные.Этап,
	|	ДД.БазаРаспределения,
	|	ДД.Подразделение,
	|	Данные.СтатьяКалькуляции,
	|	ЕСТЬNULL(ЗП.Подразделение, Данные.Этап.Подразделение),
	|	ДД.ГруппироватьСуммыПоПодразделениям
	|";
КонецФункции

Функция ТекстПоЭтапамБазаВручнуюПоВыпускамБезРаспоряжения() // использует Распределить, ВыпускРаботСписанныхНаЗатратыБезЗаказа
	Возврат "
	|ВЫБРАТЬ
	|	ДД.Регистратор,
	|	ДД.Период,
	|	(ВЫБОР
	|		КОГДА НЕ &АналитическийУчетПоГруппамПродукции
	|		ТОГДА ЗНАЧЕНИЕ(Справочник.ГруппыАналитическогоУчетаНоменклатуры.ПустаяСсылка)
	|		ИНАЧЕ (ВЫБОР
	|					КОГДА НЕ Строки.Номенклатура ЕСТЬ NULL
	|					ТОГДА Строки.Номенклатура.ГруппаАналитическогоУчета
	|					ИНАЧЕ ЗНАЧЕНИЕ(Справочник.ГруппыАналитическогоУчетаНоменклатуры.ПустаяСсылка) КОНЕЦ)
	|		КОНЕЦ) КАК ГруппаПродукции,
	|	НЕОПРЕДЕЛЕНО КАК ЗаказНаПроизводство,
	|	Данные.КодСтроки КАК КодСтрокиПродукция,
	|	Строки.Назначение.НаправлениеДеятельности КАК НаправлениеДеятельности,
	|	ЗНАЧЕНИЕ(Справочник.ЭтапыПроизводства.ПустаяСсылка) КАК Этап,
	|	Данные.ДокументВыпуска КАК ДокументВыпуска,
	|	ДД.БазаРаспределения,
	|	ДД.Подразделение,
	|	Данные.СтатьяКалькуляции,
	|	ВП.Подразделение КАК ПодразделениеПриемник,
	|	ДД.ГруппироватьСуммыПоПодразделениям,
	|	СУММА(Данные.ДоляСтоимости) КАК Количество,
	|	0 КАК Объем,
	|	0 КАК Вес,
	|	0 КАК Стоимость
	|ИЗ
	|	Распределить КАК ДД
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.РаспределениеПрочихЗатрат.ВыпускиБезРаспоряжения КАК Данные
	|		ПО Данные.Ссылка = ДД.Регистратор
	|		И ДД.ПартииУказаныВручную
	|		И ДД.СтатьяКалькуляции = Данные.СтатьяКалькуляции
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ВыпускПродукции КАК ВП
	|		ПО ВП.Ссылка = Данные.ДокументВыпуска
	|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.ВыпускПродукции.Товары КАК Строки
	|		ПО &АналитическийУчетПоГруппамПродукции
	|		И Строки.Ссылка = Данные.ДокументВыпуска
	|		И Строки.КодСтроки = Данные.КодСтроки,
	|	ЛЕВОЕ СОЕДИНЕНИЕ ВыпускРаботСписанныхНаЗатратыБезЗаказа КАК ВыпускРабот
	|			ПО ВыпускРабот.Распоряжение = Данные.ДокументВыпуска
	|				И ВыпускРабот.КодСтроки = Данные.КодСтроки
	|ГДЕ
	|	НЕ(ДД.Организация = ЕСТЬNULL(ВыпускРабот.Организация, ЛОЖЬ)
	|		И ДД.ПодразделениеИсточник = ЕСТЬNULL(ВыпускРабот.ПодразделениеПриемник, ЛОЖЬ)
	|		И ДД.СтатьяРасходов = ЕСТЬNULL(ВыпускРабот.СтатьяРасходов, ЛОЖЬ)
	|		И ДД.АналитикаРасходов = ЕСТЬNULL(ВыпускРабот.АналитикаРасходов, ЛОЖЬ))
	|СГРУППИРОВАТЬ ПО
	|	ДД.Регистратор,
	|	ДД.Период,
	|	(ВЫБОР
	|		КОГДА НЕ &АналитическийУчетПоГруппамПродукции
	|		ТОГДА ЗНАЧЕНИЕ(Справочник.ГруппыАналитическогоУчетаНоменклатуры.ПустаяСсылка)
	|		ИНАЧЕ (ВЫБОР
	|					КОГДА НЕ Строки.Номенклатура ЕСТЬ NULL
	|					ТОГДА Строки.Номенклатура.ГруппаАналитическогоУчета
	|					ИНАЧЕ ЗНАЧЕНИЕ(Справочник.ГруппыАналитическогоУчетаНоменклатуры.ПустаяСсылка) КОНЕЦ)
	|		КОНЕЦ),
	|	Данные.КодСтроки,
	|	Данные.ДокументВыпуска,
	|	ДД.БазаРаспределения,
	|	ДД.Подразделение,
	|	Данные.СтатьяКалькуляции,
	|	ВП.Подразделение,
	|	ДД.ГруппироватьСуммыПоПодразделениям,
	|	Строки.Назначение.НаправлениеДеятельности
	|";
КонецФункции

#КонецОбласти

#Область ФормированиеТаблицыДанныхДляРасчетаПоЭтапам

Функция ТекстПоЭтапамПартия() // использует Распределить, ОбщиеСуммы
	Возврат "
	|ВЫБРАТЬ
	|	10 КАК Приоритет,
	|	""Партия"" КАК ТипЗаписи,
	|	ИСТИНА КАК РасчетЗавершен,
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) КАК ВидДвижения,
	|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КАК РазделУчета,
	|	ДД.Период,
	|	ДД.Регистратор,
	|	ДД.Организация,
	|	ДД.ПодразделениеИсточник,
	|	ДД.ПодразделениеПриемник,
	|	ДД.Подразделение,
	|	ДД.НаправлениеДеятельности,
	|	ДД.СтатьяРасходов,
	|	ДД.АналитикаРасходов,
	|	ДД.СтатьяКалькуляции,
	|	НЕОПРЕДЕЛЕНО КАК ЗаказНаПроизводство,
	|	0 КАК КодСтрокиПродукция,
	|	НЕОПРЕДЕЛЕНО КАК Этап,
	|	НЕОПРЕДЕЛЕНО КАК ДокументВыпуска,
	|	НЕОПРЕДЕЛЕНО КАК ДокументДвижения,
	|	НЕОПРЕДЕЛЕНО КАК ГруппаПродукции,
	|	(ВЫБОР ДД.БазаРаспределения
	|		КОГДА ЗНАЧЕНИЕ(Перечисление.ТипыБазыРаспределенияРасходов.КоличествоУказанныхМатериалов) ТОГДА Итог.ОбщееКоличество
	|		КОГДА ЗНАЧЕНИЕ(Перечисление.ТипыБазыРаспределенияРасходов.ОбъемУказанныхМатериалов) ТОГДА Итог.ОбщийОбъем
	|		КОГДА ЗНАЧЕНИЕ(Перечисление.ТипыБазыРаспределенияРасходов.ВесУказанныхМатериалов) ТОГДА Итог.ОбщийВес
	|		КОГДА ЗНАЧЕНИЕ(Перечисление.ТипыБазыРаспределенияРасходов.КоличествоПродукции) ТОГДА Итог.ОбщееКоличество
	|		КОГДА ЗНАЧЕНИЕ(Перечисление.ТипыБазыРаспределенияРасходов.ОбъемПродукции) ТОГДА Итог.ОбщийОбъем
	|		КОГДА ЗНАЧЕНИЕ(Перечисление.ТипыБазыРаспределенияРасходов.ВесПродукции) ТОГДА Итог.ОбщийВес
	|		КОГДА ЗНАЧЕНИЕ(Перечисление.ТипыБазыРаспределенияРасходов.КоличествоРаботУказанныхВидов) ТОГДА Итог.ОбщееКоличество
	|		КОГДА ЗНАЧЕНИЕ(Перечисление.ТипыБазыРаспределенияРасходов.ПлановаяСтоимостьПродукции) ТОГДА Итог.ОбщаяСтоимость
	|		КОГДА ЗНАЧЕНИЕ(Перечисление.ТипыБазыРаспределенияРасходов.СуммаМатериальныхЗатрат) ТОГДА Итог.ОбщаяСтоимость
	|		КОГДА ЗНАЧЕНИЕ(Перечисление.ТипыБазыРаспределенияРасходов.СуммаРасходовНаОплатуТруда) ТОГДА Итог.ОбщаяСтоимость
	|		КОГДА ЗНАЧЕНИЕ(Перечисление.ТипыБазыРаспределенияРасходов.НормативыОплатыТруда) ТОГДА Итог.ОбщаяСтоимость
	|		КОГДА ЗНАЧЕНИЕ(Перечисление.ТипыБазыРаспределенияРасходов.ПустаяСсылка) ТОГДА Итог.ОбщееКоличество
	|		ИНАЧЕ 0
	|	КОНЕЦ) КАК Знаменатель,
	|	ДД.ДоляСтоимости,
	|	ДД.Стоимость,
	|	ДД.СтоимостьБезНДС,
	|	ДД.СтоимостьРегл,
	|	ДД.ПостояннаяРазница,
	|	ДД.ВременнаяРазница
	|ИЗ
	|	Распределить КАК ДД
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ОбщиеСуммы КАК Итог
	|		ПО Итог.Регистратор = ДД.Регистратор
	|			И Итог.СтатьяКалькуляции = ДД.СтатьяКалькуляции
	|			И (Итог.ПодразделениеПриемник = ДД.Подразделение
	|				ИЛИ НЕ ДД.ГруппироватьСуммыПоПодразделениям)
	|";
КонецФункции

Функция ТекстПоЭтапам() // использует БазаРаспределения
	Возврат "
	|ВЫБРАТЬ
	|	20 КАК Приоритет,
	|	""ПоЭтапам"" КАК ТипЗаписи,
	|	ЛОЖЬ КАК РасчетЗавершен,
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
	|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КАК РазделУчета,
	|	ДД.Период,
	|	ДД.Регистратор,
	|	НЕОПРЕДЕЛЕНО КАК Организация,
	|	НЕОПРЕДЕЛЕНО КАК ПодразделениеИсточник,
	|	ДД.ПодразделениеПриемник,
	|	ДД.Подразделение,
	|	ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка) КАК НаправлениеДеятельности,
	|	НЕОПРЕДЕЛЕНО КАК СтатьяРасходов,
	|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
	|	ДД.СтатьяКалькуляции КАК СтатьяКалькуляции,
	|	ДД.ЗаказНаПроизводство,
	|	ДД.КодСтрокиПродукция,
	|	ДД.Этап,
	|	ДД.ДокументВыпуска,
	|	ДД.Регистратор КАК ДокументДвижения,
	|	ДД.ГруппаПродукции,
	|	(ВЫБОР ДД.БазаРаспределения
	|		КОГДА ЗНАЧЕНИЕ(Перечисление.ТипыБазыРаспределенияРасходов.КоличествоУказанныхМатериалов) ТОГДА ДД.Количество
	|		КОГДА ЗНАЧЕНИЕ(Перечисление.ТипыБазыРаспределенияРасходов.ОбъемУказанныхМатериалов) ТОГДА ДД.Объем
	|		КОГДА ЗНАЧЕНИЕ(Перечисление.ТипыБазыРаспределенияРасходов.ВесУказанныхМатериалов) ТОГДА ДД.Вес
	|		КОГДА ЗНАЧЕНИЕ(Перечисление.ТипыБазыРаспределенияРасходов.КоличествоПродукции) ТОГДА ДД.Количество
	|		КОГДА ЗНАЧЕНИЕ(Перечисление.ТипыБазыРаспределенияРасходов.ОбъемПродукции) ТОГДА ДД.Объем
	|		КОГДА ЗНАЧЕНИЕ(Перечисление.ТипыБазыРаспределенияРасходов.ВесПродукции) ТОГДА ДД.Вес
	|		КОГДА ЗНАЧЕНИЕ(Перечисление.ТипыБазыРаспределенияРасходов.КоличествоРаботУказанныхВидов) ТОГДА ДД.Количество
	|		КОГДА ЗНАЧЕНИЕ(Перечисление.ТипыБазыРаспределенияРасходов.ПлановаяСтоимостьПродукции) ТОГДА ДД.Стоимость
	|		КОГДА ЗНАЧЕНИЕ(Перечисление.ТипыБазыРаспределенияРасходов.СуммаМатериальныхЗатрат) ТОГДА ДД.Стоимость
	|		КОГДА ЗНАЧЕНИЕ(Перечисление.ТипыБазыРаспределенияРасходов.СуммаРасходовНаОплатуТруда) ТОГДА ДД.Стоимость
	|		КОГДА ЗНАЧЕНИЕ(Перечисление.ТипыБазыРаспределенияРасходов.НормативыОплатыТруда) ТОГДА ДД.Стоимость
	|		КОГДА ЗНАЧЕНИЕ(Перечисление.ТипыБазыРаспределенияРасходов.ПустаяСсылка) ТОГДА ДД.Количество
	|		ИНАЧЕ 0
	|	КОНЕЦ) КАК Знаменатель,
	|	0 КАК ДоляСтоимости,
	|	0 КАК Стоимость,
	|	0 КАК СтоимостьБезНДС,
	|	0 КАК СтоимостьРегл,
	|	0 КАК ПостояннаяРазница,
	|	0 КАК ВременнаяРазница
	|ИЗ
	|	БазаРаспределения КАК ДД
	|";
КонецФункции

#КонецОбласти

#КонецОбласти

#Область РаспределениеПрочихРасходов

Функция ДанныеДляПрочихРасходов(НачалоПериода, ОкончаниеПериода, МассивОрганизаций, РасчетныеРасходыКРаспределению)
	
	ТекстСортировка = "
		|УПОРЯДОЧИТЬ ПО
		|	Период, Регистратор, ТипЗаписи
		|";
	ИсходныйТекстЗапроса =
		ТекстПрочиеРасходыИнициализация() + ";" //вт ВТПриход, ВТПоступило, РасходыКРаспределению, Распределить
		+ ТекстОписаниеДанныхДляПрочихРасходов()
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстПрочиеРасходыПартия() // использует Распределить
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстПрочиеРасходыПотребление() // использует Распределить
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстПрочиеРасходыСписание() // использует Распределить
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстПрочиеРасходыДополнение()
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстПрочиеРасходыСписаниеФиксированнойСтоимости()
		+ ТекстСортировка;
	ИсходныйЗапрос = Новый Запрос(ИсходныйТекстЗапроса);
	
	ИсходныйЗапрос.УстановитьПараметр("НачалоПериода", НачалоПериода);
	ИсходныйЗапрос.УстановитьПараметр("ОкончаниеПериода", ОкончаниеПериода);
	ИсходныйЗапрос.УстановитьПараметр("КонецПериода", ОкончаниеПериода);
	ИсходныйЗапрос.УстановитьПараметр("ГраницаКонецПериода", Новый Граница(ОкончаниеПериода, ВидГраницы.Включая));
	ИсходныйЗапрос.УстановитьПараметр("МассивОрганизаций", МассивОрганизаций);	
	ИсходныйЗапрос.УстановитьПараметр("СписокОрганизаций", МассивОрганизаций);
	ИсходныйЗапрос.УстановитьПараметр("СписокПодразделений", Неопределено);
	ИсходныйЗапрос.УстановитьПараметр("ПоВсемОрганизациям", Ложь);
	ИсходныйЗапрос.УстановитьПараметр("ПоВсемПодразделениям", Истина);
	ИсходныйЗапрос.УстановитьПараметр("РасчетныеРасходыКРаспределению", РасчетныеРасходыКРаспределению);
	ИсходныйЗапрос.УстановитьПараметр("ВариантыРаспределенияРасходов", 
		ОбщегоНазначенияУТКлиентСервер.Массив(Перечисления.ВариантыРаспределенияРасходов.НаПроизводственныеЗатраты));
		
	ДанныеДляРасчета = ИсходныйЗапрос.Выполнить();

	Возврат ДанныеДляРасчета;
	
КонецФункции

Функция РасчетныеПрочиеРасходы(ДанныеДляРасчета, Регистраторы, ВнутренниеДанные = Неопределено, Тест = Ложь, КоличествоЗаписей = 0)
	
	// Шаг 1: создаем буфер накопления рассчитанных данных
	Запрос = Новый Запрос(ТекстОписаниеДанныхДляПрочихРасходов());
	РасчетныеДанные = Запрос.Выполнить().Выгрузить();
	КоличествоЗаписей = РасчетныеДанные.Количество();
	
	// Шаг 2: готовим описание обсчета
	КонтекстЦепочек = ОписаниеЦепочек("Партия, Списание, Потребление, Дополнение");
	
	ПоляПотреблений = "Регистратор";
	КонтекстДвижений = ОписаниеДвижений(
		"ПрочиеРасходыПоБазе",
		"ПрочиеРасходы",
		ПереченьПолей(РасчетныеДанные.Колонки),
		ПоляПотреблений,
		"Списание",
		"ДоляСтоимости", "ДоляСтоимости", "", "Регистратор");
	
	// Шаг 3: обсчитываем потребления из партий
	ДобавитьОписаниеПриемника(КонтекстЦепочек, "Списание", ПоляПотреблений);
	ДобавитьОписаниеИсточника(КонтекстЦепочек, "Списание", "Партия", ПоляПотреблений);
	
	ДобавитьОписаниеПриемника(КонтекстЦепочек, "Потребление", "Регистратор, СтатьяРасходов, АналитикаРасходов");
	ДобавитьОписаниеИсточника(КонтекстЦепочек, "Потребление", "Списание", "Регистратор, КорСтатьяРасходов, КорАналитикаРасходов");
	
	ЦепочкиДвижений = ЦепочкиДвиженийЗапросом(КонтекстЦепочек, ДанныеДляРасчета);
	РассчитатьПартииПоЦепочкамИзВыборки(КонтекстДвижений, ДанныеДляРасчета, РасчетныеДанные, ЦепочкиДвижений, Регистраторы, Тест);

	// Шаг 4: Удаляем строки, не требующие записи в базу.
	УдалитьНезаписываемыеСтроки(КонтекстДвижений.Контекст, РасчетныеДанные);
	
	// Шаг 5: Сортировка партий для дальнейшей записи
	РасчетныеДанные.Сортировать("Регистратор", Новый СравнениеЗначений);
	Возврат РасчетныеДанные;
	
КонецФункции

Функция ТекстПрочиеРасходыИнициализация() //вт ВТПриход, ВТПоступило, РасходыКРаспределению, Распределить
	Возврат Документы.РаспределениеПрочихЗатрат.ТекстЗапросаПоступилоПрочихРасходов() + "
	|ВЫБРАТЬ
	|	Т.Регистратор,
	|	Т.Направление,
	|	Т.ДоляСтоимости,
	|	Т.Стоимость,
	|	Т.СтоимостьБезНДС,
	|	Т.СтоимостьРегл,
	|	Т.ПостояннаяРазница,
	|	Т.ВременнаяРазница
	|ПОМЕСТИТЬ
	|	РасчетныеРасходыКРаспределению
	|ИЗ
	|	&РасчетныеРасходыКРаспределению КАК Т
	|;
	|ВЫБРАТЬ
	|	Д.Ссылка КАК Регистратор,
	|	Д.Дата КАК Период,
	|	Д.Организация,
	|	Д.Подразделение КАК ПодразделениеИсточник,
	|	НЕОПРЕДЕЛЕНО КАК ПодразделениеПриемник,
	|	Д.Подразделение КАК Подразделение,
	|	Д.НаправлениеДеятельности,
	|	Д.СтатьяРасходов,
	|	Д.АналитикаРасходов,
	|	Д.СтатьяКалькуляции,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыБазыРаспределенияРасходов.ПустаяСсылка) КАК БазаРаспределения,
	|	ЛОЖЬ КАК ГруппироватьСуммыПоПодразделениям,
	|	Расходы.ДоляСтоимости КАК ДоляСтоимости,
	|	Расходы.Стоимость КАК Сумма,
	|	Расходы.СтоимостьБезНДС КАК СуммаБезНДС,
	|	Расходы.СтоимостьРегл КАК СуммаРегл,
	|	Расходы.ПостояннаяРазница,
	|	Расходы.ВременнаяРазница
	|ПОМЕСТИТЬ
	|	Распределить
	|ИЗ
	|	Документ.РаспределениеПрочихЗатрат КАК Д
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ РасходыКРаспределению КАК Т
	|	ПО Т.Организация = Д.Организация
	|		И Т.Подразделение = Д.Подразделение
	|		И Т.НаправлениеДеятельности = Д.НаправлениеДеятельности
	|		И Т.СтатьяРасходов = Д.СтатьяРасходов
	|		И Т.АналитикаРасходов = Д.АналитикаРасходов
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ РасчетныеРасходыКРаспределению КАК Расходы
	|		ПО Расходы.Регистратор = Д.Ссылка
	|		И Расходы.Направление = ""Списание""
	|ГДЕ
	|	Д.Дата МЕЖДУ &НачалоПериода И &ОкончаниеПериода
	|	И Д.Организация В (&МассивОрганизаций)
	|	И Д.Проведен
	|	И Расходы.ДоляСтоимости <> 0
	|";
КонецФункции

Функция ТекстПрочиеРасходыПартия() // использует Распределить
	Возврат "
	|ВЫБРАТЬ
	|	10 КАК Приоритет,
	|	""Партия"" КАК ТипЗаписи,
	|	ИСТИНА КАК РасчетЗавершен,
	|	НЕОПРЕДЕЛЕНО КАК РазделУчета,
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) КАК ВидДвижения,
	|	ДД.Период,
	|	ДД.Регистратор КАК Регистратор,
	|	ДД.Организация,
	|	ДД.Подразделение,
	|	ДД.НаправлениеДеятельности,
	|	ДД.СтатьяРасходов,
	|	ДД.АналитикаРасходов,
	|	НЕОПРЕДЕЛЕНО КАК ХозяйственнаяОперация,
	|	ДД.Регистратор КАК ДокументДвижения,
	|	НЕОПРЕДЕЛЕНО КАК КорСтатьяРасходов,
	|	НЕОПРЕДЕЛЕНО КАК КорАналитикаРасходов,
	|	НЕОПРЕДЕЛЕНО КАК КорПодразделение,
	|	НЕОПРЕДЕЛЕНО КАК ГруппаПродукции,
	|	ДД.ДоляСтоимости КАК Знаменатель,
	|	ДД.ДоляСтоимости,
	|	ДД.Сумма,
	|	ДД.СуммаБезНДС,
	|	ДД.СуммаРегл,
	|	ДД.ПостояннаяРазница,
	|	ДД.ВременнаяРазница
	|ИЗ
	|	Распределить КАК ДД
	|";
КонецФункции

Функция ТекстПрочиеРасходыПотребление() // использует Распределить
	Возврат "
	|ВЫБРАТЬ
	|	20 КАК Приоритет,
	|	""Потребление"" КАК ТипЗаписи,
	|	ЛОЖЬ КАК РасчетЗавершен,
	|	НЕОПРЕДЕЛЕНО КАК РазделУчета,
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
	|	ДД.Период,
	|	ДД.Регистратор,
	|	ДД.Организация,
	|	ДД.Подразделение,
	|	Строки.НаправлениеДеятельности,
	|	Строки.СтатьяРасходов,
	|	Строки.АналитикаРасходов,
	|	НЕОПРЕДЕЛЕНО КАК ХозяйственнаяОперация,
	|	ДД.Регистратор КАК ДокументДвижения,
	|	ДД.СтатьяРасходов КАК КорСтатьяРасходов,
	|	ДД.АналитикаРасходов КАК КорАналитикаРасходов,
	|	ДД.Подразделение КАК КорПодразделение,
	|	НЕОПРЕДЕЛЕНО КАК ГруппаПродукции,
	|	СУММА(Строки.ДоляСтоимости) КАК Знаменатель,
	|	СУММА(Строки.ДоляСтоимости) КАК ДоляСтоимости,
	|	0 КАК Сумма,
	|	0 КАК СуммаБезНДС,
	|	0 КАК СуммаРегл,
	|	0 КАК ПостояннаяРазница,
	|	0 КАК ВременнаяРазница
	|ИЗ
	|	Распределить КАК ДД
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.РаспределениеПрочихЗатрат.Списание КАК Строки
	|	ПО Строки.Ссылка = ДД.Регистратор
	|СГРУППИРОВАТЬ ПО
	|	ДД.Период,
	|	ДД.Регистратор,
	|	ДД.Организация,
	|	ДД.Подразделение,
	|	Строки.НаправлениеДеятельности,
	|	Строки.СтатьяРасходов,
	|	Строки.АналитикаРасходов,
	|	ДД.СтатьяРасходов,
	|	ДД.АналитикаРасходов
	|";
КонецФункции

Функция ТекстПрочиеРасходыСписание() // использует Распределить
	Возврат "
	|ВЫБРАТЬ
	|	30 КАК Приоритет,
	|	""Списание"" КАК ТипЗаписи,
	|	ЛОЖЬ КАК РасчетЗавершен,
	|	НЕОПРЕДЕЛЕНО КАК РазделУчета,
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) КАК ВидДвижения,
	|	ДД.Период,
	|	ДД.Регистратор,
	|	ДД.Организация,
	|	ДД.Подразделение,
	|	ДД.НаправлениеДеятельности,
	|	ДД.СтатьяРасходов,
	|	ДД.АналитикаРасходов,
	|	НЕОПРЕДЕЛЕНО КАК ХозяйственнаяОперация,
	|	ДД.Регистратор КАК ДокументДвижения,
	|	Строки.СтатьяРасходов КАК КорСтатьяРасходов,
	|	Строки.АналитикаРасходов КАК КорАналитикаРасходов,
	|	ДД.Подразделение КАК КорПодразделение,
	|	НЕОПРЕДЕЛЕНО КАК ГруппаПродукции,
	|	СУММА(Строки.ДоляСтоимости) КАК Знаменатель,
	|	СУММА(Строки.ДоляСтоимости) КАК ДоляСтоимости,
	|	0 КАК Сумма,
	|	0 КАК СуммаБезНДС,
	|	0 КАК СуммаРегл,
	|	0 КАК ПостояннаяРазница,
	|	0 КАК ВременнаяРазница
	|ИЗ
	|	Распределить КАК ДД
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.РаспределениеПрочихЗатрат.Списание КАК Строки
	|	ПО Строки.Ссылка = ДД.Регистратор
	|СГРУППИРОВАТЬ ПО
	|	ДД.Период,
	|	ДД.Регистратор,
	|	ДД.Организация,
	|	ДД.Подразделение,
	|	ДД.НаправлениеДеятельности,
	|	ДД.СтатьяРасходов,
	|	ДД.АналитикаРасходов,
	|	Строки.СтатьяРасходов,
	|	Строки.АналитикаРасходов
	|";
КонецФункции

Функция ТекстПрочиеРасходыДополнение()
	Возврат "
	|ВЫБРАТЬ
	|	40 КАК Приоритет,
	|	""Дополнение"" КАК ТипЗаписи,
	|	ИСТИНА КАК РасчетЗавершен,
	|	НЕОПРЕДЕЛЕНО КАК РазделУчета,
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) КАК ВидДвижения,
	|	Расходы.Период,
	|	Расходы.Регистратор,
	|	Расходы.Организация,
	|	Распределение.Подразделение,
	|	Распределение.НаправлениеДеятельности КАК НаправлениеДеятельности,
	|	Расходы.СтатьяРасходов,
	|	Расходы.АналитикаРасходов,
	|	НЕОПРЕДЕЛЕНО КАК ХозяйственнаяОперация,
	|	Расходы.Регистратор КАК ДокументДвижения,
	|	НЕОПРЕДЕЛЕНО КАК КорСтатьяРасходов,
	|	НЕОПРЕДЕЛЕНО КАК КорАналитикаРасходов,
	|	Расходы.Подразделение КАК КорПодразделение,
	|	Расходы.ГруппаПродукции КАК ГруппаПродукции,
	|	0 КАК Знаменатель,
	|	0 КАК ДоляСтоимости,
	|	СУММА(Расходы.Стоимость) КАК Сумма,
	|	СУММА(Расходы.СтоимостьБезНДС) КАК СуммаБезНДС,
	|	СУММА(Расходы.СтоимостьРегл) КАК СуммаРегл,
	|	СУММА(Расходы.ПостояннаяРазница) КАК ПостояннаяРазница,
	|	СУММА(Расходы.ВременнаяРазница) КАК ВременнаяРазница
	|ИЗ
	|	РегистрНакопления.ПрочиеРасходыНезавершенногоПроизводства КАК Расходы
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.РаспределениеПрочихЗатрат КАК Распределение
	|		ПО Распределение.Ссылка = Расходы.Регистратор
	|ГДЕ
	|	Расходы.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
	|	И Расходы.Организация В (&МассивОрганизаций)
	|	И Расходы.Активность
	|	И НЕ Расходы.РасчетСебестоимости
	|	И Расходы.Регистратор ССЫЛКА Документ.РаспределениеПрочихЗатрат
	|	И Расходы.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|СГРУППИРОВАТЬ ПО
	|	Расходы.Период,
	|	Расходы.Регистратор,
	|	Расходы.Организация,
	|	Распределение.Подразделение,
	|	Распределение.НаправлениеДеятельности,
	|	Расходы.СтатьяРасходов,
	|	Расходы.АналитикаРасходов,
	|	Расходы.Подразделение,
	|	Расходы.ГруппаПродукции
	|ИМЕЮЩИЕ
	|	СУММА(Расходы.Стоимость) <> 0
	|	ИЛИ СУММА(Расходы.СтоимостьБезНДС) <> 0
	|	ИЛИ СУММА(Расходы.СтоимостьРегл) <> 0
	|	ИЛИ СУММА(Расходы.ПостояннаяРазница) <> 0
	|	ИЛИ СУММА(Расходы.ВременнаяРазница) <> 0
	|";
КонецФункции

Функция ТекстПрочиеРасходыСписаниеФиксированнойСтоимости()
	Возврат "
	|ВЫБРАТЬ
	|	40 КАК Приоритет,
	|	""Дополнение"" КАК ТипЗаписи,
	|	ИСТИНА КАК РасчетЗавершен,
	|	НЕОПРЕДЕЛЕНО КАК РазделУчета,
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) КАК ВидДвижения,
	|	Т.Период,
	|	Т.Регистратор,
	|	Т.Организация,
	|	Т.Подразделение,
	|	Т.НаправлениеДеятельности,
	|	Т.СтатьяРасходов,
	|	Т.АналитикаРасходов,
	|	НЕОПРЕДЕЛЕНО КАК ХозяйственнаяОперация,
	|	Т.Регистратор КАК ДокументДвижения,
	|	НЕОПРЕДЕЛЕНО КАК КорСтатьяРасходов,
	|	НЕОПРЕДЕЛЕНО КАК КорАналитикаРасходов,
	|	Т.Подразделение КАК КорПодразделение,
	|	Т.ГруппаПродукции КАК ГруппаПродукции,
	|	0. КАК Знаменатель,
	|	0. КАК ДоляСтоимости,
	|	СУММА(Т.Сумма) КАК Сумма,
	|	СУММА(Т.СуммаБезНДС) КАК СуммаБезНДС,
	|	СУММА(Т.СуммаРегл) КАК СуммаРегл,
	|	СУММА(Т.ПостояннаяРазница) КАК ПостояннаяРазница,
	|	СУММА(Т.ВременнаяРазница) КАК ВременнаяРазница
	|ИЗ
	|	РегистрНакопления.ПрочиеРасходы КАК Т
	|ГДЕ
	|	Т.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
	|	И Т.Организация В (&МассивОрганизаций)
	|	И Т.Активность
	|	И Т.Регистратор ССЫЛКА Документ.ВыпускПродукции
	|	И Т.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|	И Т.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукцииФиксированнаяСтоимость)
	|СГРУППИРОВАТЬ ПО
	|	Т.Период,
	|	Т.Регистратор,
	|	Т.Организация,
	|	Т.СтатьяРасходов,
	|	Т.АналитикаРасходов,
	|	Т.Подразделение,
	|	Т.НаправлениеДеятельности,
	|	Т.ГруппаПродукции
	|";
КонецФункции

#КонецОбласти

#Область ОбщиеПроцедуры

Процедура СформироватьПодразделенияПриемникиРасходов(НачалоПериода, ОкончаниеПериода, МассивОрганизаций, МВТ) //вт ОтборПоПодразделениям
	
	Запрос = Новый Запрос;
	Запрос.МенеджерВременныхТаблиц = МВТ;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	ДД.Ссылка КАК Регистратор,
		|	ДД.Подразделение КАК Подразделение
		|ПОМЕСТИТЬ ОтборПоПодразделениям
		|ИЗ
		|	Документ.РаспределениеПрочихЗатрат.ОтборПоПодразделениям КАК ДД
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.РаспределениеПрочихЗатрат КАК Т
		|		ПО ДД.Ссылка = Т.Ссылка
		|ГДЕ
		|	Т.Дата МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И Т.Организация В(&МассивОрганизаций)
		|	И Т.Проведен
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	ДД.Ссылка,
		|	ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка)
		|ИЗ
		|	Документ.РаспределениеПрочихЗатрат КАК ДД
		|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.РаспределениеПрочихЗатрат.ОтборПоПодразделениям КАК Т
		|		ПО ДД.Ссылка = Т.Ссылка
		|ГДЕ
		|	ДД.Дата МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В(&МассивОрганизаций)
		|	И ДД.Проведен
		|	И Т.Ссылка ЕСТЬ NULL";
	
	Запрос.УстановитьПараметр("НачалоПериода",		НачалоПериода);
	Запрос.УстановитьПараметр("ОкончаниеПериода",	КонецДня(ОкончаниеПериода));
	Запрос.УстановитьПараметр("МассивОрганизаций", МассивОрганизаций);	
	
	Запрос.Выполнить();
	
КонецПроцедуры

Функция ТекстОбщиеСуммыПоРегистратору() // вт ОбщиеСуммы, использует БазаРаспределения
	Возврат "
	|ВЫБРАТЬ
	|	ДД.Регистратор,
	|	ДД.СтатьяКалькуляции,
	|	(ВЫБОР
	|		КОГДА ДД.ГруппироватьСуммыПоПодразделениям ТОГДА ДД.ПодразделениеПриемник
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО КОНЕЦ) КАК ПодразделениеПриемник,
	|	СУММА(ДД.Количество) КАК ОбщееКоличество,
	|	СУММА(ДД.Объем) КАК ОбщийОбъем,
	|	СУММА(ДД.Вес) КАК ОбщийВес,
	|	СУММА(ДД.Стоимость) КАК ОбщаяСтоимость
	|ПОМЕСТИТЬ
	|	ОбщиеСуммы
	|ИЗ
	|	БазаРаспределения КАК ДД
	|СГРУППИРОВАТЬ ПО
	|	ДД.Регистратор,
	|	ДД.СтатьяКалькуляции,
	|	(ВЫБОР
	|		КОГДА ДД.ГруппироватьСуммыПоПодразделениям ТОГДА ДД.ПодразделениеПриемник
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО КОНЕЦ)
	|";
КонецФункции

Функция ТекстОтборПоГруппамПродукции() //вт ОтборПоГруппамПродукции
	Возврат "
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	Т.Регистратор,
	|	Т.ГруппаПродукции
	|ПОМЕСТИТЬ
	|	ОтборПоГруппамПродукции
	|ИЗ (
	|	ВЫБРАТЬ
	|		ДД.Ссылка КАК Регистратор,
	|		Т.ГруппаПродукции,
	|		0
	|	ИЗ
	|		Документ.РаспределениеПрочихЗатрат.ОтборПоГруппамПродукции КАК Т
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.РаспределениеПрочихЗатрат КАК ДД
	|		ПО Т.Ссылка = ДД.Ссылка
	|	ГДЕ
	|		ДД.Дата МЕЖДУ &НачалоПериода И &ОкончаниеПериода
	|		И ДД.Проведен
	|
	|	ОБЪЕДИНИТЬ ВСЕ
	|
	|	ВЫБРАТЬ
	|		ДД.Ссылка КАК Регистратор,
	|		ЗНАЧЕНИЕ(Справочник.ГруппыАналитическогоУчетаНоменклатуры.ПустаяСсылка),
	|		СУММА(ВЫБОР
	|					КОГДА Т.ГруппаПродукции ЕСТЬ NULL ТОГДА 0
	|					ИНАЧЕ 1 КОНЕЦ)
	|	ИЗ
	|		Документ.РаспределениеПрочихЗатрат КАК ДД
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.РаспределениеПрочихЗатрат.ОтборПоГруппамПродукции КАК Т
	|		ПО ДД.Ссылка = Т.Ссылка
	|	ГДЕ
	|		ДД.Дата МЕЖДУ &НачалоПериода И &ОкончаниеПериода
	|		И ДД.Проведен
	|	СГРУППИРОВАТЬ ПО
	|		ДД.Ссылка
	|	ИМЕЮЩИЕ
	|		СУММА(ВЫБОР
	|					КОГДА Т.ГруппаПродукции ЕСТЬ NULL ТОГДА 0
	|					ИНАЧЕ 1 КОНЕЦ) = 0
	|	) КАК Т
	|";
КонецФункции

Функция ТекстОтборПоМатериалам() //вт ОтборПоМатериалам
	Возврат "
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	Т.Ссылка КАК Регистратор,
	|	Т.Материал
	|ПОМЕСТИТЬ
	|	ОтборПоМатериалам
	|ИЗ
	|	Документ.РаспределениеПрочихЗатрат.ОтборПоМатериалам КАК Т
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.РаспределениеПрочихЗатрат КАК ДД
	|	ПО ДД.Ссылка = Т.Ссылка
	|ГДЕ
	|	ДД.Дата МЕЖДУ &НачалоПериода И &ОкончаниеПериода
	|	И ДД.Проведен
	|";
КонецФункции

Функция ТекстОтборПоВидамРабот() //вт ОтборПоВидамРабот
	Возврат "
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	Т.Ссылка КАК Регистратор,
	|	Т.ВидРабот
	|ПОМЕСТИТЬ
	|	ОтборПоВидамРабот
	|ИЗ
	|	Документ.РаспределениеПрочихЗатрат.ОтборПоВидамРабот КАК Т
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.РаспределениеПрочихЗатрат КАК ДД
	|	ПО ДД.Ссылка = Т.Ссылка
	|ГДЕ
	|	ДД.Дата МЕЖДУ &НачалоПериода И &ОкончаниеПериода
	|	И ДД.Проведен
	|";
КонецФункции

Функция ТекстВыпускРаботСписанныхНаЗатратыБезЗаказа() //вт ВыпускРаботСписанныхНаЗатратыБезЗаказа
	Возврат "
	|ВЫБРАТЬ
	|	Выпуск.Ссылка КАК Распоряжение,
	|	Выпуск.КодСтроки КАК КодСтроки,
	|	ДД.Организация КАК Организация,
	|	Выпуск.Подразделение КАК ПодразделениеПриемник,
	|	Выпуск.Назначение.НаправлениеДеятельности КАК НаправлениеДеятельности,
	|	Выпуск.СтатьяРасходов КАК СтатьяРасходов,
	|	Выпуск.АналитикаРасходов КАК АналитикаРасходов
	|ПОМЕСТИТЬ
	|	ВыпускРаботСписанныхНаЗатратыБезЗаказа
	|ИЗ
	|	Документ.ВыпускПродукции.Товары КАК Выпуск
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ВыпускПродукции КАК ДД
	|		ПО ДД.Ссылка = Выпуск.Ссылка
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ПланВидовХарактеристик.СтатьиРасходов КАК Статьи
	|		ПО Статьи.Ссылка = Выпуск.СтатьяРасходов
	|		И (Статьи.ВариантРаспределенияРасходовУпр = ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаПроизводственныеЗатраты)
	|			И Статьи.ВариантРаспределенияРасходовРегл = ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаПроизводственныеЗатраты))
	|ГДЕ
	|	&ФормироватьВыпускРаботСписанныхНаЗатраты
	|	И ДД.Дата МЕЖДУ &НачалоПериода И &ОкончаниеПериода
	|	И ДД.Организация В (&МассивОрганизаций)
	|	И ДД.Проведен
	|	И НЕ ДД.ВыпускПоРаспоряжениям
	|";
КонецФункции

Функция ТекстДанныеПоСтоимостиМатЗатрат() //вт Данные_СтоимостьМатЗатрат
	Возврат "
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	СпрОрганизации.ГоловнаяОрганизация КАК Организация,
	|	СпрОрганизации.Ссылка КАК ОбособленноеПодразделение
	|ПОМЕСТИТЬ
	|	ВтГоловныеОрганизации
	|ИЗ
	|	Справочник.Организации КАК СпрОрганизации
	|ГДЕ
	|	СпрОрганизации.Ссылка В (&МассивОрганизаций)
	|ИНДЕКСИРОВАТЬ ПО
	|	Организация;
	|
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	ГоловныеОрганизации.ОбособленноеПодразделение КАК Организация
	|ПОМЕСТИТЬ
	|	ОрганизацииСФИФОСкользящая
	|ИЗ
	|	РегистрСведений.УчетнаяПолитикаФинансовогоУчета.СрезПоследних(&ОкончаниеПериода, Организация В
	|			(ВЫБРАТЬ
	|				ГоловныеОрганизации.Организация
	|			ИЗ
	|				ВтГоловныеОрганизации КАК ГоловныеОрганизации)) КАК ДД
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВтГоловныеОрганизации КАК ГоловныеОрганизации
	|		ПО ГоловныеОрганизации.Организация = ДД.Организация
	|ГДЕ
	|	ДД.МетодОценкиСтоимостиТоваров = ЗНАЧЕНИЕ(Перечисление.МетодыОценкиСтоимостиТоваров.ФИФОСкользящаяОценка)
	|;
	|	
	|УНИЧТОЖИТЬ ВтГоловныеОрганизации;
	|	
	|ВЫБРАТЬ
	|	Т.Организация,
	|	Т.Подразделение,
	|	Т.НаправлениеДеятельности,
	|	Т.ЗаказНаПроизводство,
	|	Т.Этап,
	|	Т.КодСтрокиПродукция,
	|	Т.Продукция,
	|	Т.ДокументВыпуска,
	|	Т.ГруппаПродукции,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыБазыРаспределенияРасходов.СуммаМатериальныхЗатрат) КАК БазаРаспределения,
	|	ВЫРАЗИТЬ(СУММА(
	|		(ВЫБОР
	|			КОГДА НЕ ФИФОСкользящая.Организация ЕСТЬ NULL И Т.Стоимость <> 0 ТОГДА Т.Стоимость
	|			ИНАЧЕ Т.Количество *
	|				(ЕСТЬNULL(Цены.Стоимость, 0) + ЕСТЬNULL(Цены.СтоимостьДопРасходы, 0)) КОНЕЦ)) КАК ЧИСЛО(31,2)) КАК Стоимость,
	|	ВЫРАЗИТЬ(СУММА(
	|		(ВЫБОР
	|			КОГДА НЕ ФИФОСкользящая.Организация ЕСТЬ NULL И Т.СтоимостьБезНДС <> 0 ТОГДА Т.СтоимостьБезНДС
	|			ИНАЧЕ Т.Количество * 
	|				(ЕСТЬNULL(Цены.СтоимостьБезНДС, 0) + ЕСТЬNULL(Цены.СтоимостьДопРасходыБезНДС, 0)) КОНЕЦ)) КАК ЧИСЛО(31,2)) КАК СтоимостьБезНДС,
	|	ВЫРАЗИТЬ(СУММА(
	|		(ВЫБОР
	|			КОГДА НЕ ФИФОСкользящая.Организация ЕСТЬ NULL И Т.СтоимостьРегл <> 0 ТОГДА Т.СтоимостьРегл
	|			ИНАЧЕ Т.Количество * ЕСТЬNULL(Цены.СтоимостьРегл, 0) КОНЕЦ)) КАК ЧИСЛО(31,2)) КАК СтоимостьРегл
	|ПОМЕСТИТЬ Данные_СтоимостьМатЗатрат
	|ИЗ (
	|	ВЫБРАТЬ
	|		НАЧАЛОПЕРИОДА(Д.Период, МЕСЯЦ) КАК Период,
	|		Д.Организация,
	|		ЕСТЬNULL(ОтчетПереработчика.Подразделение, Д.АналитикаУчетаНоменклатуры.Подразделение) КАК Подразделение,
	|		Д.ЗаказНаПроизводство,
	|		ВЫБОР
	|			КОГДА Д.КодСтрокиПродукция = 0
	|				ТОГДА ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)
	//++ НЕ УТКА
	|			КОГДА Д.КодСтрокиПродукция <> 0 И НЕ ЗаказПродукция.Назначение.НаправлениеДеятельности ЕСТЬ NULL
	|				ТОГДА ЗаказПродукция.Назначение.НаправлениеДеятельности
	//-- НЕ УТКА
	|			ИНАЧЕ ЕСТЬNULL(Выпуск.Назначение.НаправлениеДеятельности, ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка))
	|		КОНЕЦ КАК НаправлениеДеятельности,
	|		Д.Этап,
	|		Д.КодСтрокиПродукция,
	|		Д.АналитикаУчетаНоменклатуры,
	|		Д.ВидЗапасов,
	|		Д.Продукция,
	|		Д.ДокументВыпуска,
	|		(ВЫБОР
	|			КОГДА НЕ &АналитическийУчетПоГруппамПродукции ТОГДА ЗНАЧЕНИЕ(Справочник.ГруппыАналитическогоУчетаНоменклатуры.ПустаяСсылка)
	|			ИНАЧЕ Д.Продукция.ГруппаАналитическогоУчета КОНЕЦ) КАК ГруппаПродукции,
	|		Д.Количество,
	|		Д.Стоимость,
	|		Д.СтоимостьБезНДС,
	|		Д.СтоимостьРегл
	|	ИЗ
	|		РегистрНакопления.ПартииНезавершенногоПроизводства КАК Д
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.ОтчетПереработчика КАК ОтчетПереработчика
	|			ПО Д.Регистратор = ОтчетПереработчика.Ссылка
	//++ НЕ УТКА
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.ЗаказНаПроизводство.Продукция КАК ЗаказПродукция
	|			ПО Д.ЗаказНаПроизводство = ЗаказПродукция.Ссылка
	|				И Д.КодСтрокиПродукция = ЗаказПродукция.КодСтроки
	//-- НЕ УТКА
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.ВыпускПродукции.Товары КАК Выпуск
	|			ПО Д.ДокументВыпуска = Выпуск.Ссылка
	|				И Д.КодСтрокиПродукция = Выпуск.КодСтроки
	|	ГДЕ
	|		&ПартионныйУчетВключен
	|		И Д.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
	|		И Д.Организация В (&МассивОрганизаций)
	|		И Д.Активность
	|		И (Д.СтатьяКалькуляции.ТипЗатрат = ЗНАЧЕНИЕ(Перечисление.ТипыЗатрат.Материальные)
	|			ИЛИ
	|			Д.СтатьяКалькуляции = ЗНАЧЕНИЕ(Справочник.СтатьиКалькуляции.ПустаяСсылка)
	|			И Д.Регистратор ССЫЛКА Документ.ОтчетПереработчика)
	|		И Д.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|		И Д.Продукция <> ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка)
	|	) КАК Т
	|
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК ИсходнаяАналитика
	|		ПО Т.АналитикаУчетаНоменклатуры = ИсходнаяАналитика.Ссылка
	|
	|	ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаНоменклатуры КАК АналитикаБезНазначения
	|		ПО ИсходнаяАналитика.Номенклатура 			= АналитикаБезНазначения.Номенклатура
	|		И ИсходнаяАналитика.Характеристика 		= АналитикаБезНазначения.Характеристика
	|		И ИсходнаяАналитика.Серия 				= АналитикаБезНазначения.Серия
	|		И ИсходнаяАналитика.МестоХранения 		= АналитикаБезНазначения.МестоХранения
	|		И АналитикаБезНазначения.Назначение 	= ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка)
	|		И ИсходнаяАналитика.СтатьяКалькуляции 	= АналитикаБезНазначения.СтатьяКалькуляции
	|
	|	ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.СтоимостьТоваров КАК Цены
	|		ПО Цены.Организация = Т.Организация
	|		И Цены.Период = Т.Период
	|		И (ВЫБОР 
	|			КОГДА НЕ &УчитыватьСебестоимостьТоваровПоНазначениям
	|				ТОГДА Цены.АналитикаУчетаНоменклатуры = АналитикаБезНазначения.КлючАналитики
	|			ИНАЧЕ Цены.АналитикаУчетаНоменклатуры = Т.АналитикаУчетаНоменклатуры КОНЕЦ)
	|		И Цены.ВидЗапасов = Т.ВидЗапасов 
	|		И Цены.РазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты)
	|	ЛЕВОЕ СОЕДИНЕНИЕ ОрганизацииСФИФОСкользящая КАК ФИФОСкользящая
	|		ПО ФИФОСкользящая.Организация = Т.Организация
	|СГРУППИРОВАТЬ ПО
	|	Т.Организация,
	|	Т.Подразделение,
	|	Т.ЗаказНаПроизводство,
	|	Т.НаправлениеДеятельности,
	|	Т.Этап,
	|	Т.КодСтрокиПродукция,
	|	Т.Продукция,
	|	Т.ДокументВыпуска,
	|	Т.ГруппаПродукции
	|ИМЕЮЩИЕ
	|	СУММА(
	|		(ВЫБОР
	|			КОГДА НЕ ФИФОСкользящая.Организация ЕСТЬ NULL И Т.Стоимость <> 0 ТОГДА Т.Стоимость
	|			ИНАЧЕ Т.Количество *
	|				(ЕСТЬNULL(Цены.Стоимость, 0) + ЕСТЬNULL(Цены.СтоимостьДопРасходы, 0)) КОНЕЦ)) > 0
	|";
КонецФункции

Функция ТекстДанныеПоСтоимостиМатЗатратБезПУ()
	Возврат "
	|ВЫБРАТЬ
	|	Т.Организация,
	|	Т.Подразделение,
	|	Т.НаправлениеДеятельности,
	|	Т.ЗаказНаПроизводство,
	|	Т.Этап,
	|	Т.КодСтрокиПродукция,
	|	Т.Продукция,
	|	Т.ДокументВыпуска,
	|	Т.ГруппаПродукции,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыБазыРаспределенияРасходов.СуммаМатериальныхЗатрат) КАК БазаРаспределения,
	|	ВЫРАЗИТЬ(СУММА(Т.Количество * ЕСТЬNULL(С.Стоимость, 0) + Т.Количество * ЕСТЬNULL(С.СтоимостьДопРасходы, 0)) КАК ЧИСЛО(31,2)) КАК Стоимость,
	|	ВЫРАЗИТЬ(СУММА(Т.Количество * ЕСТЬNULL(С.СтоимостьБезНДС, 0) + Т.Количество * ЕСТЬNULL(С.СтоимостьДопРасходыБезНДС, 0)) КАК ЧИСЛО(31,2)) КАК СтоимостьБезНДС,
	|	ВЫРАЗИТЬ(СУММА(Т.Количество * ЕСТЬNULL(С.СтоимостьРегл, 0)) КАК ЧИСЛО(31,2)) КАК СтоимостьРегл
	|ИЗ (
	|	ВЫБРАТЬ
	|		Д.Период,
	|		Д.Организация,
	|		ЕСТЬNULL(ОтчетПереработчика.Подразделение, Д.АналитикаУчетаНоменклатуры.Подразделение) КАК Подразделение,
	|		Д.ЗаказНаПроизводство,
	|		ВЫБОР
	|			КОГДА Д.КодСтрокиПродукция = 0
	|				ТОГДА ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)
	//++ НЕ УТКА
	|			КОГДА Д.КодСтрокиПродукция <> 0 И НЕ ЗаказПродукция.Назначение.НаправлениеДеятельности ЕСТЬ NULL
	|				ТОГДА ЗаказПродукция.Назначение.НаправлениеДеятельности
	//-- НЕ УТКА
	|			ИНАЧЕ ЕСТЬNULL(Выпуск.Назначение.НаправлениеДеятельности, ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка))
	|		КОНЕЦ КАК НаправлениеДеятельности,
	|		Д.Этап,
	|		Д.КодСтрокиПродукция,
	|		Д.Продукция,
	|		Д.АналитикаУчетаНоменклатуры,
	|		Д.ВидЗапасов,
	|		Д.ДокументВыпуска,
	|		(ВЫБОР
	|			КОГДА НЕ &АналитическийУчетПоГруппамПродукции ТОГДА ЗНАЧЕНИЕ(Справочник.ГруппыАналитическогоУчетаНоменклатуры.ПустаяСсылка)
	|			ИНАЧЕ Д.Продукция.ГруппаАналитическогоУчета КОНЕЦ) КАК ГруппаПродукции,
	|		Д.Количество
	|	ИЗ
	|		РегистрНакопления.ПартииНезавершенногоПроизводства КАК Д
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.ОтчетПереработчика КАК ОтчетПереработчика
	|		ПО Д.Регистратор = ОтчетПереработчика.Ссылка
	//++ НЕ УТКА
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.ЗаказНаПроизводство.Продукция КАК ЗаказПродукция
	|			ПО Д.ЗаказНаПроизводство = ЗаказПродукция.Ссылка
	|				И Д.КодСтрокиПродукция = ЗаказПродукция.КодСтроки
	//-- НЕ УТКА
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.ВыпускПродукции.Товары КАК Выпуск
	|			ПО Д.ДокументВыпуска = Выпуск.Ссылка
	|				И Д.КодСтрокиПродукция = Выпуск.КодСтроки
	|	ГДЕ
	|		НЕ &ПартионныйУчетВключен
	|		И Д.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
	|		И Д.Организация В (&МассивОрганизаций)
	|		И Д.Активность
	|		И (Д.СтатьяКалькуляции.ТипЗатрат = ЗНАЧЕНИЕ(Перечисление.ТипыЗатрат.Материальные)
	|			ИЛИ
	|			Д.СтатьяКалькуляции = ЗНАЧЕНИЕ(Справочник.СтатьиКалькуляции.ПустаяСсылка)
	|			И Д.Регистратор ССЫЛКА Документ.ОтчетПереработчика)
	|		И Д.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|		И Д.Продукция <> ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка)
	|	) КАК Т
	|
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК ИсходнаяАналитика
	|	ПО Т.АналитикаУчетаНоменклатуры = ИсходнаяАналитика.Ссылка
	|
	|	ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаНоменклатуры КАК АналитикаБезНазначения
	|	ПО ИсходнаяАналитика.Номенклатура 			= АналитикаБезНазначения.Номенклатура
	|		И ИсходнаяАналитика.Характеристика 		= АналитикаБезНазначения.Характеристика
	|		И ИсходнаяАналитика.Серия 				= АналитикаБезНазначения.Серия
	|		И ИсходнаяАналитика.МестоХранения 		= АналитикаБезНазначения.МестоХранения
	|		И АналитикаБезНазначения.Назначение 	= ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка)
	|		И ИсходнаяАналитика.СтатьяКалькуляции 	= АналитикаБезНазначения.СтатьяКалькуляции
	|
	|	ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.СтоимостьТоваров КАК С
	|	ПО Т.Организация = С.Организация
	|		И С.Период = НАЧАЛОПЕРИОДА(Т.Период, МЕСЯЦ)
	|		И ВЫБОР 
	|			КОГДА НЕ &УчитыватьСебестоимостьТоваровПоНазначениям
	|				ТОГДА С.АналитикаУчетаНоменклатуры = АналитикаБезНазначения.КлючАналитики
	|			ИНАЧЕ
	|				С.АналитикаУчетаНоменклатуры = ИсходнаяАналитика.Ссылка
	|		КОНЕЦ
	|		И Т.ВидЗапасов = С.ВидЗапасов
	|		И С.РазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты)
	|
	|СГРУППИРОВАТЬ ПО
	|	Т.Организация,
	|	Т.Подразделение,
	|	Т.НаправлениеДеятельности,
	|	Т.ЗаказНаПроизводство,
	|	Т.Этап,
	|	Т.КодСтрокиПродукция,
	|	Т.Продукция,
	|	Т.ДокументВыпуска,
	|	Т.ГруппаПродукции
	|ИМЕЮЩИЕ
	|	ВЫРАЗИТЬ(СУММА(Т.Количество * ЕСТЬNULL(С.Стоимость, 0) + Т.Количество * ЕСТЬNULL(С.СтоимостьДопРасходы, 0)) КАК ЧИСЛО(31,2)) > 0
	|";
КонецФункции

Функция ТекстДанныеПоЗатратамНаОплатуТрудаБезЗаказа() //вт Данные_ЗатратыНаОплатуТруда
	Возврат "
	|ВЫБРАТЬ
	|	Т.Организация,
	|	Т.Подразделение КАК Подразделение,
	|	Выпуск.Назначение.НаправлениеДеятельности КАК НаправлениеДеятельности,
	|	НЕОПРЕДЕЛЕНО КАК ЗаказНаПроизводство,
	|	НЕОПРЕДЕЛЕНО КАК Этап,
	|	Т.КодСтроки КАК КодСтрокиПродукция,
	|	Т.ВидРабот,
	|	СА.Номенклатура КАК Продукция,
	|	Т.ГруппаПродукции,
	|	Т.ДокументВыпуска,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыБазыРаспределенияРасходов.СуммаРасходовНаОплатуТруда) КАК БазаРаспределения,
	|	СУММА(Т.Стоимость) КАК Стоимость
	|ПОМЕСТИТЬ
	|	Данные_ЗатратыНаОплатуТруда
	|ИЗ
	|	РегистрНакопления.ТрудозатратыНезавершенногоПроизводства КАК Т
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК СА
	|	ПО СА.Ссылка = Т.КорАналитикаУчетаПродукции
	|
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ВыпускПродукции.Товары КАК Выпуск
	|	ПО Т.ДокументВыпуска = Выпуск.Ссылка
	|	И  Т.КодСтроки = Выпуск.КодСтроки
	|
	|ГДЕ
	|	Т.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
	|	И Т.Организация В (&МассивОрганизаций)
	|	И Т.Активность
	|	И Т.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|	И Т.КодСтрокиПродукция = 0
	|СГРУППИРОВАТЬ ПО
	|	Т.Организация,
	|	Т.Подразделение,
	|	Выпуск.Назначение.НаправлениеДеятельности,
	|	Т.КодСтроки,
	|	Т.ВидРабот,
	|	СА.Номенклатура,
	|	Т.ГруппаПродукции,
	|	Т.ДокументВыпуска
	|";
КонецФункции

//++ НЕ УТКА

Функция ТекстДанныеПоЗатратамНаОплатуТрудаНЗП()
	Возврат "
	|ВЫБРАТЬ
	|	Т.Организация,
	|	Т.Подразделение,
	|	ЕСТЬNULL(ЗаказПродукция.Назначение.НаправлениеДеятельности, ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)) КАК НаправлениеДеятельности,
	|	Т.ЗаказНаПроизводство,
	|	Т.Этап,
	|	Т.КодСтрокиПродукция,
	|	Т.ВидРабот,
	|	Т.Продукция,
	|	Т.ГруппаПродукции,
	|	НЕОПРЕДЕЛЕНО КАК ДокументВыпуска,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыБазыРаспределенияРасходов.СуммаРасходовНаОплатуТруда) КАК БазаРаспределения,
	|	СУММА(Т.Стоимость) КАК Стоимость
	|ИЗ
	|	РегистрНакопления.ТрудозатратыНезавершенногоПроизводства КАК Т
	|
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.ЗаказНаПроизводство.Продукция КАК ЗаказПродукция
	|			ПО Т.ЗаказНаПроизводство = ЗаказПродукция.Ссылка
	|				И Т.КодСтрокиПродукция = ЗаказПродукция.КодСтроки
	|
	|ГДЕ
	|	Т.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
	|	И Т.Организация В (&МассивОрганизаций)
	|	И Т.Активность
	|	И Т.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|	И Т.КодСтрокиПродукция <> 0
	|СГРУППИРОВАТЬ ПО
	|	Т.Организация,
	|	Т.Подразделение,
	|	ЗаказПродукция.Назначение.НаправлениеДеятельности,
	|	Т.ЗаказНаПроизводство,
	|	Т.Этап,
	|	Т.КодСтрокиПродукция,
	|	Т.ВидРабот,
	|	Т.Продукция,
	|	Т.ГруппаПродукции
	|";
КонецФункции
//-- НЕ УТКА

#КонецОбласти

#КонецОбласти


#Область РасчетПрочихРасходовНезавершенногоПроизводства

// В партионном учете версии 2.2 - этап 17, РаспределениеПостатейныхРасходовНаВыходныеИзделия.

Функция ДанныеДляПрочихРасходовНЗП(НачалоПериода, ОкончаниеПериода, МассивОрганизаций)
	ТекстСортировка = "
		|УПОРЯДОЧИТЬ ПО
		|	Организация, ЗаказНаПроизводство, КодСтрокиПродукция, Спецификация, Продукция, ХарактеристикаПродукции,
		|	Приоритет, Период, Регистратор 
		|";
	ТекстИндексы = "
		|ИНДЕКСИРОВАТЬ ПО
		|	Организация
		|";
	ИсходныйТекстЗапроса =
		ТекстПрочиеРасходыНЗПИнициализация() + ";" // вт ЗаказыКРаспределению, ДолиСтоимости, ВыпускиБезЗаказа
		+ ТекстОписаниеДанныхДляПрочихРасходовНЗП()
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстОстаткиПрочихРасходовНЗП() // использует ДолиСтоимости
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстОстаткиПрочихРасходовНЗПуПереработчика() // использует ДолиСтоимости

		//++ НЕ УТКА
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстПервичныеПрочиеРасходыНЗП() // использует ДолиСтоимости
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстПрочиеРасходыРаспределение()
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстПрочиеРасходыВыпускиПоЗаказам()
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстПрочиеРасходыОтчетыДавальцам()
		//-- НЕ УТКА
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстПервичныеПрочиеРасходыНЗПБезЗаказов() // ВыпускиБезЗаказа
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстПервичныеПрочиеРасходыНЗПБезЗаказовПоБазе() // использует СписанияНаВыпуск
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстПервичныеПрочиеРасходыПереработчик() // использует ДолиСтоимости
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстПрочиеРасходыДавальческиеПолуфабрикаты() // использует ДолиСтоимости
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстПрочиеРасходыОтчетыПереработчика()
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстПрочиеРасходыСписанияЗатратНаВыпуск()
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстПрочиеРасходыВыпускиБезЗаказов()
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстПрочиеРасходыВыпускиБезЗаказовБезСписанияЗатратНаВыпуск()
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстПрочиеРасходыПоступленияОтПереработчиков()
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстДополнениеПрочихРасходовНЗП()
		+ ТекстИндексы;
	МВТ = Новый МенеджерВременныхТаблиц;	
	ИсходныйЗапрос = Новый Запрос(СтрЗаменить(ИсходныйТекстЗапроса, "//ВоВременнуюТаблицу", ""));
	ИсходныйЗапрос.УстановитьПараметр("НачалоПериода", НачалоПериода);
	ИсходныйЗапрос.УстановитьПараметр("ОкончаниеПериода", ОкончаниеПериода);	
	ИсходныйЗапрос.УстановитьПараметр("МассивОрганизаций", МассивОрганизаций);	
	ИсходныйЗапрос.МенеджерВременныхТаблиц = МВТ;
	ИсходныйЗапрос.Выполнить();
	
	Запрос = Новый Запрос(ТекстОписаниеДанныхДляПрочихРасходовНЗП());
	РасчетныеПартии = Запрос.Выполнить().Выгрузить();
	
	ВременнаяТаблицаДанныхПоОтбору("Организация", ТекстСортировка, РасчетныеПартии, МВТ);
	
	Возврат МВТ;
КонецФункции

Функция РасчетныеПрочиеРасходыНЗП(ДанныеДляРасчета, Регистраторы, ЦепочкиДвижений = Неопределено, Тест = Ложь)
	
	// Шаг 1: создаем буфер накопления рассчитанных партий
	Запрос = Новый Запрос(ТекстОписаниеДанныхДляПрочихРасходовНЗП());
	РасчетныеПартии = Запрос.Выполнить().Выгрузить();
	
	// Шаг 2: обсчитываем цепочки движений
	КонтекстЦепочек = ОписаниеЦепочек("Дополнение, Распределение, ПоБазеБезЗаказа, СписанияНаВыпуск, Партия, ПартияБезЗаказа, Остаток, Выпуск, ВыпускБезЗаказа, ПолуфабрикатДавальца, ОтчетДавальцу");
	
	ПоляПотреблений = "Организация, ЗаказНаПроизводство, КодСтрокиПродукция, Спецификация";
	ДобавитьОписаниеПриемника(КонтекстЦепочек, "Распределение", ПоляПотреблений);
	ДобавитьОписаниеИсточника(КонтекстЦепочек, "Распределение", "Партия", ПоляПотреблений);
	ДобавитьОписаниеИсточника(КонтекстЦепочек, "Распределение", "Остаток", ПоляПотреблений);
	ДобавитьОписаниеИсточника(КонтекстЦепочек, "Распределение", "ПолуфабрикатДавальца", ПоляПотреблений);
	
	ДобавитьОписаниеПриемника(КонтекстЦепочек, "Выпуск", "Организация, ЗаказНаПроизводство, КодСтрокиПродукция, Спецификация, Продукция, ХарактеристикаПродукции, Получатель");
	ДобавитьОписаниеИсточника(КонтекстЦепочек, "Выпуск", "Распределение", "Организация, ЗаказНаПроизводство, КодСтрокиПродукция, Спецификация, Продукция, ХарактеристикаПродукции, Получатель");
	
	ДобавитьОписаниеПриемника(КонтекстЦепочек, "СписанияНаВыпуск", "Организация, ЗаказНаПроизводство");
	ДобавитьОписаниеИсточника(КонтекстЦепочек, "СписанияНаВыпуск", "ПоБазеБезЗаказа", "Организация, ЗаказНаПроизводство");
	
	ДобавитьОписаниеПриемника(КонтекстЦепочек, "ВыпускБезЗаказа", "Регистратор, КодСтрокиПродукция");
	ДобавитьОписаниеИсточника(КонтекстЦепочек, "ВыпускБезЗаказа", "ПартияБезЗаказа", "ДокументВыпуска, КодСтрокиПродукция");
	ДобавитьОписаниеИсточника(КонтекстЦепочек, "ВыпускБезЗаказа", "СписанияНаВыпуск", "ДокументВыпуска, КодСтрокиПродукция");
	ДобавитьОписаниеИсточника(КонтекстЦепочек, "ВыпускБезЗаказа", "ПолуфабрикатДавальца", "ДокументВыпуска, КодСтрокиПродукция");
	
	ДобавитьОписаниеПриемника(КонтекстЦепочек, "ПолуфабрикатДавальца", "Организация, Назначение, Продукция, ХарактеристикаПродукции");
	ДобавитьОписаниеИсточника(КонтекстЦепочек, "ПолуфабрикатДавальца", "Выпуск", "Организация, Назначение, Продукция, ХарактеристикаПродукции");
	ДобавитьОписаниеИсточника(КонтекстЦепочек, "ПолуфабрикатДавальца", "ВыпускБезЗаказа", "Организация, Назначение, Продукция, ХарактеристикаПродукции");
	
	ДобавитьОписаниеПриемника(КонтекстЦепочек, "ОтчетДавальцу", "Организация, Назначение, Продукция, ХарактеристикаПродукции");
	ДобавитьОписаниеИсточника(КонтекстЦепочек, "ОтчетДавальцу", "Выпуск", "Организация, Назначение, Продукция, ХарактеристикаПродукции");
	ДобавитьОписаниеИсточника(КонтекстЦепочек, "ОтчетДавальцу", "ВыпускБезЗаказа", "Организация, Назначение, Продукция, ХарактеристикаПродукции");
	
	// Шаг 3: замена ложных партий на первичные партии в расчетных строках по результатам построение графа замен.
	КонтекстДвижений = ОписаниеДвижений(
		"ПрочиеРасходыНезавершенногоПроизводства",
		"ПрочиеРасходыНезавершенногоПроизводства",
		ПереченьПолей(РасчетныеПартии.Колонки),
		ПоляПотреблений,
		"ДоляСтоимости, Стоимость, СтоимостьБезНДС, СтоимостьРегл, ПостояннаяРазница, ВременнаяРазница",
		"Знаменатель", "Знаменатель", "ДокументИсточник", "Период");
	КонтекстДвижений.Вставить("ПоляСуммирования", "ДоляСтоимости, Стоимость, СтоимостьБезНДС, СтоимостьРегл, ПостояннаяРазница, ВременнаяРазница");
	КонтекстДвижений.Вставить("ПоляГруппировки", ПереченьПолей(РасчетныеПартии.Колонки, КонтекстДвижений.ПоляСуммирования));
	ЦепочкиДвижений(КонтекстЦепочек, ДанныеДляРасчета);
	РассчитатьПартииПоЦепочкам(КонтекстДвижений, ДанныеДляРасчета, РасчетныеПартии, Регистраторы, Тест);
	ЦепочкиДвижений = ДанныеДляРасчета;
		
	// Шаг 4: Удаляем нерассчитанные партии
	Если Не Тест Тогда
		УдалитьНезаписываемыеСтроки(КонтекстДвижений.Контекст, РасчетныеПартии);
	КонецЕсли;
	
	Возврат РасчетныеПартии;
	
КонецФункции

Функция ТекстПрочиеРасходыНЗПИнициализация() // вт ЗаказыКРаспределению, ДолиСтоимости, ВыпускиБезЗаказов, СписанияНаВыпуск
	Возврат "
		//++ НЕ УТКА
		|ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	ДД.Распоряжение.Распоряжение КАК Заказ,
		|	ДД.Распоряжение.КодСтроки КАК КодСтроки
		|ПОМЕСТИТЬ
		|	ЗаказыКРаспределению
		|ИЗ
		|	РегистрНакопления.РаспоряженияНаВыпускПродукции.ОстаткиИОбороты(&НачалоПериода, &ОкончаниеПериода, , , Распоряжение.Организация В (&МассивОрганизаций)) КАК ДД
		|ГДЕ
		|	ДД.ЗаказаноПриход <> 0
		|	ИЛИ ДД.ЗаказаноКонечныйОстаток <> 0
		|;
		|////////////////////////////////////////////////////////////////////////////

		//-- НЕ УТКА
		|ВЫБРАТЬ
		|	Строки.ЗаказПереработчику КАК ЗаказНаПроизводство,
		|	0 КАК КодСтрокиПродукция,
		|	НЕОПРЕДЕЛЕНО КАК Спецификация,
		|	СУММА(ВЫБОР Строки.ДоляСтоимости КОГДА 0 ТОГДА 1
		|		ИНАЧЕ Строки.ДоляСтоимости КОНЕЦ) КАК ДоляСтоимости
		|ПОМЕСТИТЬ
		|	ДолиСтоимости
		|ИЗ
		|	Документ.ОтчетПереработчика КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ОтчетПереработчика.Продукция КАК Строки
		|		ПО Строки.Ссылка = ДД.Ссылка
		|ГДЕ
		|	ДД.Дата МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Проведен
		|СГРУППИРОВАТЬ ПО
		|	Строки.ЗаказПереработчику
		//++ НЕ УТКА
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	МаршрутныйЛист.Распоряжение КАК ЗаказНаПроизводство,
		|	МаршрутныйЛист.КодСтроки КАК КодСтрокиПродукция,
		|	Этапы.Владелец КАК Спецификация,
		|	СУММА(ВЫБОР ДД.ДоляСтоимости КОГДА 0 ТОГДА 1
		|		ИНАЧЕ ДД.ДоляСтоимости КОНЕЦ
		|		* (МаршрутныйЛист.Произведено + МаршрутныйЛист.Брак)) КАК ДоляСтоимости
		|ИЗ
		|	РегистрНакопления.РаспоряженияНаВыпускПродукции КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.МаршрутныйЛистПроизводства КАК МаршрутныйЛист
		|		ПО МаршрутныйЛист.Ссылка = ДД.Распоряжение
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ЭтапыПроизводства КАК Этапы
		|		ПО Этапы.Ссылка = МаршрутныйЛист.Этап
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ЗаказыКРаспределению КАК Заказы
		|		ПО Заказы.Заказ = МаршрутныйЛист.Распоряжение
		|			И Заказы.КодСтроки = МаршрутныйЛист.КодСтроки
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И МаршрутныйЛист.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|	И ДД.ТипСтоимости = ЗНАЧЕНИЕ(Перечисление.ТипыСтоимостиВыходныхИзделий.Рассчитывается)
		|СГРУППИРОВАТЬ ПО
		|	МаршрутныйЛист.Распоряжение,
		|	МаршрутныйЛист.КодСтроки,
		|	Этапы.Владелец
		//-- НЕ УТКА
		|;
		|////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	Выходы.Распоряжение,
		|	Выходы.КодСтроки,
		|	СУММА(Выходы.Количество) КАК Количество,
		|	СУММА(Выходы.ДоляСтоимости) КАК ДоляСтоимости
		|ПОМЕСТИТЬ
		|	ВыпускиБезЗаказов
		|ИЗ
		|	Документ.СписаниеЗатратНаВыпуск КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.СписаниеЗатратНаВыпуск.ВыходныеИзделия КАК Выходы
		|		ПО Выходы.Ссылка = ДД.Ссылка
		|ГДЕ
		|	ДД.Дата МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Проведен
		|СГРУППИРОВАТЬ ПО
		|	Выходы.Распоряжение,
		|	Выходы.КодСтроки
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|ВЫБРАТЬ
		|	ДД.Ссылка КАК Распоряжение,
		|	Строки.КодСтроки,
		|	СУММА(Строки.Количество) КАК Количество,
		|	1 КАК ДоляСтоимости
		|ИЗ
		|	Документ.ВыпускПродукции КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.СтруктураПредприятия КАК Подразделения
		|		ПО Подразделения.Ссылка = ДД.Подразделение
		|		И НЕ Подразделения.ИспользуетсяСписаниеЗатратНаВыпуск
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ВыпускПродукции.Товары КАК Строки
		|		ПО Строки.Ссылка = ДД.Ссылка
		|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.СписаниеЗатратНаВыпуск.ВыходныеИзделия КАК Выходы
		|		ПО Выходы.Распоряжение = ДД.Ссылка
		|		И Выходы.Ссылка.Проведен
		|ГДЕ
		|	ДД.Дата МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Проведен
		|	И НЕ ДД.ВыпускПоРаспоряжениям
		|	И Выходы.Ссылка ЕСТЬ NULL
		|СГРУППИРОВАТЬ ПО
		|	ДД.Ссылка,
		|	Строки.КодСтроки
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|ВЫБРАТЬ
		|	ДД.Регистратор КАК Распоряжение,
		|	0 КАК КодСтроки,
		|	СУММА(ДД.Количество) КАК Количество,
		|	1 КАК ДоляСтоимости
		|ИЗ
		|	РегистрНакопления.ВыпускПродукции КАК ДД
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И ДД.Регистратор ССЫЛКА Документ.ПоступлениеОтПереработчика
		|	И НЕ ДД.Заказ ССЫЛКА Документ.ЗаказПереработчику
		|СГРУППИРОВАТЬ ПО
		|	ДД.Регистратор
		|;
		|////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ДД.Ссылка,
		|	СУММА(Выходы.Количество) КАК Количество,
		|	СУММА(Выходы.ДоляСтоимости) КАК ДоляСтоимости
		|ПОМЕСТИТЬ
		|	СписанияНаВыпуск
		|ИЗ
		|	Документ.СписаниеЗатратНаВыпуск КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.СписаниеЗатратНаВыпуск.ВыходныеИзделия КАК Выходы
		|		ПО Выходы.Ссылка = ДД.Ссылка
		|ГДЕ
		|	ДД.Дата МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Проведен
		|СГРУППИРОВАТЬ ПО
		|	ДД.Ссылка
		|";
КонецФункции

Функция ТекстОписаниеДанныхДляПрочихРасходовНЗП()
	Возврат "
		|ВЫБРАТЬ ПЕРВЫЕ 0
		|	ВЫРАЗИТЬ("""" КАК СТРОКА(80)) КАК ЗапросИсточник,
		|	0 КАК Приоритет,
		|	""ХХХХХХХХХХХХХХХХХХХХ"" КАК ТипЗаписи,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
		|	ДАТАВРЕМЯ(1, 1, 1, 0, 0, 0) КАК Период,
		|	ДД.Регистратор КАК Регистратор,
		|	ЗНАЧЕНИЕ(Справочник.Организации.ПустаяСсылка) КАК Организация,
		|	ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка) КАК Подразделение,
		|	ДД.ЗаказНаПроизводство КАК ЗаказНаПроизводство,
		|	0 КАК КодСтрокиПродукция,
		|	ЗНАЧЕНИЕ(Справочник.РесурсныеСпецификации.ПустаяСсылка) КАК Спецификация,
		|	ЗНАЧЕНИЕ(Справочник.ЭтапыПроизводства.ПустаяСсылка) КАК Этап,
		|	ЗНАЧЕНИЕ(Справочник.СтатьиКалькуляции.ПустаяСсылка) КАК СтатьяКалькуляции,
		|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) КАК СтатьяРасходов,
		|	ДД.АналитикаРасходов КАК АналитикаРасходов,
		|	ЗНАЧЕНИЕ(Справочник.ГруппыАналитическогоУчетаНоменклатуры.ПустаяСсылка) КАК ГруппаПродукции,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КАК АналитикаУчетаПродукции,
		|	0 КАК Знаменатель,
		|	0 КАК КоличествоПродукции,
		|	0 КАК ДоляСтоимости,
		|	0 КАК Стоимость,
		|	0 КАК СтоимостьБезНДС,
		|	0 КАК СтоимостьРегл,
		|	0 КАК ПостояннаяРазница,
		|	0 КАК ВременнаяРазница,
		|	ЛОЖЬ КАК Первичное,
		|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПустаяСсылка) КАК ХозяйственнаяОперация,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КАК РазделУчета,
		|	ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка) КАК ВидЗапасов,
		|	ДД.ДокументДвижения КАК ДокументДвижения,
		|	ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка) КАК Назначение,
		|	ДД.ДокументИсточник КАК ДокументИсточник,
		|	ДД.ДокументВыпуска КАК ДокументВыпуска,
		|	ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка) КАК Продукция,
		|	ЗНАЧЕНИЕ(Справочник.ХарактеристикиНоменклатуры.ПустаяСсылка) КАК ХарактеристикаПродукции,
		|	ЗНАЧЕНИЕ(Справочник.СерииНоменклатуры.ПустаяСсылка) КАК Серия,
		|	ДД.АналитикаУчетаПродукции.МестоХранения КАК Получатель
		|//ВоВременнуюТаблицу ПОМЕСТИТЬ ИсходныеДанные
		|ИЗ
		|	РегистрНакопления.ПрочиеРасходыНезавершенногоПроизводства КАК ДД
		|";
КонецФункции

Функция ТекстОстаткиПрочихРасходовНЗП() // использует ДолиСтоимости
	// передачи материалов в производство и в переработку, возвраты материалов из производства и от переработчика.
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстОстаткиПрочихРасходовНЗП"" КАК ЗапросИсточник,
		|	10 КАК Приоритет,
		|	""Остаток"" КАК ТипЗаписи,
		|	ИСТИНА КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
		|	&НачалоПериода КАК Период,
		|	НЕОПРЕДЕЛЕНО КАК Регистратор,
		|	ДД.Организация,
		|	ДД.Подразделение,
		|	ДД.ЗаказНаПроизводство,
		|	ДД.КодСтрокиПродукция,
		|	ЭтапыПроизводства.Владелец КАК Спецификация,
		|	ДД.Этап,
		|	ДД.СтатьяКалькуляции,
		|	ДД.СтатьяРасходов,
		|	ДД.АналитикаРасходов,
		|	ДД.ГруппаПродукции,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаПродукции,
		|	ЕСТЬNULL(Доли.ДоляСтоимости, 1) КАК Знаменатель,
		|	0 КАК КоличествоПродукции,
		|	ДД.ДоляСтоимостиОстаток КАК ДоляСтоимости,
		|	ДД.СтоимостьОстаток КАК Стоимость,
		|	ДД.СтоимостьБезНДСОстаток КАК СтоимостьБезНДС,
		|	ДД.СтоимостьРеглОстаток КАК СтоимостьРегл,
		|	ДД.ПостояннаяРазницаОстаток КАК ПостояннаяРазница,
		|	ДД.ВременнаяРазницаОстаток КАК ВременнаяРазница,
		|	ИСТИНА КАК Первичное,
		|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПустаяСсылка) КАК ХозяйственнаяОперация,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КАК РазделУчета,
		|	ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка) КАК ВидЗапасов,
		|	НЕОПРЕДЕЛЕНО КАК ДокументДвижения,
		//++ НЕ УТКА
		|	ЕСТЬNULL(Заказы.Назначение,
		//-- НЕ УТКА
		|	НЕОПРЕДЕЛЕНО
		//++ НЕ УТКА
		|	)
		//-- НЕ УТКА
		|	КАК Назначение,
		|	НЕОПРЕДЕЛЕНО КАК ДокументИсточник,
		|	НЕОПРЕДЕЛЕНО КАК ДокументВыпуска,
		|	НЕОПРЕДЕЛЕНО КАК Продукция,
		|	НЕОПРЕДЕЛЕНО КАК ХарактеристикаПродукции,
		|	НЕОПРЕДЕЛЕНО КАК Серия,
		|	НЕОПРЕДЕЛЕНО КАК Получатель
		|ИЗ
		|	РегистрНакопления.ПрочиеРасходыНезавершенногоПроизводства.Остатки(&НачалоПериода, Организация В (&МассивОрганизаций)) КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ЭтапыПроизводства КАК ЭтапыПроизводства
		|		ПО ЭтапыПроизводства.Ссылка = ДД.Этап
		|	ЛЕВОЕ СОЕДИНЕНИЕ ДолиСтоимости КАК Доли
		|		ПО Доли.ЗаказНаПроизводство = ДД.ЗаказНаПроизводство
		|		И Доли.КодСтрокиПродукция = ДД.КодСтрокиПродукция
		|		И Доли.Спецификация = ЭтапыПроизводства.Владелец
		//++ НЕ УТКА
		|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.ЗаказНаПроизводство КАК Заказы
		|		ПО Заказы.Ссылка = ДД.ЗаказНаПроизводство
		|		И Заказы.ПроизводствоПоЗаказу
		//-- НЕ УТКА
		|";
КонецФункции

Функция ТекстОстаткиПрочихРасходовНЗПуПереработчика() // использует ДолиСтоимости
	// передачи материалов в производство и в переработку, возвраты материалов из производства и от переработчика.
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстОстаткиПрочихРасходовНЗПуПереработчика"" КАК ЗапросИсточник,
		|	10 КАК Приоритет,
		|	""Остаток"" КАК ТипЗаписи,
		|	ИСТИНА КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
		|	&НачалоПериода КАК Период,
		|	НЕОПРЕДЕЛЕНО КАК Регистратор,
		|	ДД.Организация,
		|	ДД.Подразделение,
		|	ДД.ЗаказНаПроизводство,
		|	ДД.КодСтрокиПродукция,
		|	ЗНАЧЕНИЕ(Справочник.РесурсныеСпецификации.ПустаяСсылка) КАК Спецификация,
		|	ДД.Этап,
		|	ДД.СтатьяКалькуляции,
		|	ДД.СтатьяРасходов,
		|	ДД.АналитикаРасходов,
		|	ДД.ГруппаПродукции,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаПродукции,
		|	ЕСТЬNULL(Доли.ДоляСтоимости, 1) КАК Знаменатель,
		|	0 КАК КоличествоПродукции,
		|	ДД.ДоляСтоимостиОстаток КАК ДоляСтоимости,
		|	ДД.СтоимостьОстаток КАК Стоимость,
		|	ДД.СтоимостьБезНДСОстаток КАК СтоимостьБезНДС,
		|	ДД.СтоимостьРеглОстаток КАК СтоимостьРегл,
		|	ДД.ПостояннаяРазницаОстаток КАК ПостояннаяРазница,
		|	ДД.ВременнаяРазницаОстаток КАК ВременнаяРазница,
		|	ИСТИНА КАК Первичное,
		|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПустаяСсылка) КАК ХозяйственнаяОперация,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КАК РазделУчета,
		|	ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка) КАК ВидЗапасов,
		|	НЕОПРЕДЕЛЕНО КАК ДокументДвижения,
		|	НЕОПРЕДЕЛЕНО КАК Назначение,
		|	НЕОПРЕДЕЛЕНО КАК ДокументИсточник,
		|	НЕОПРЕДЕЛЕНО КАК ДокументВыпуска,
		|	НЕОПРЕДЕЛЕНО КАК Продукция,
		|	НЕОПРЕДЕЛЕНО КАК ХарактеристикаПродукции,
		|	НЕОПРЕДЕЛЕНО КАК Серия,
		|	НЕОПРЕДЕЛЕНО КАК Получатель
		|ИЗ
		|	РегистрНакопления.ПрочиеРасходыНезавершенногоПроизводства.Остатки(&НачалоПериода,
		|		Организация В (&МассивОрганизаций)
		|		И ЗаказНаПроизводство ССЫЛКА Документ.ЗаказПереработчику) КАК ДД
		|	ЛЕВОЕ СОЕДИНЕНИЕ ДолиСтоимости КАК Доли
		|		ПО Доли.ЗаказНаПроизводство = ДД.ЗаказНаПроизводство
		|";
КонецФункции

//++ НЕ УТКА

Функция ТекстПервичныеПрочиеРасходыНЗП() // использует ДолиСтоимости
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстПервичныеПрочиеРасходыНЗП"" КАК ЗапросИсточник,
		|	10 КАК Приоритет,
		|	""Партия"" КАК ТипЗаписи,
		|	ИСТИНА КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.Подразделение,
		|	ДД.ЗаказНаПроизводство,
		|	ДД.КодСтрокиПродукция,
		|	ЭтапыПроизводства.Владелец КАК Спецификация,
		|	ДД.Этап,
		|	ДД.СтатьяКалькуляции,
		|	ДД.СтатьяРасходов,
		|	ДД.АналитикаРасходов,
		|	ДД.ГруппаПродукции,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаПродукции,
		|	МАКСИМУМ(ЕСТЬNULL(Доли.ДоляСтоимости, 1)) КАК Знаменатель,
		|	0 КАК КоличествоПродукции,
		|	СУММА(ДД.ДоляСтоимости) КАК ДоляСтоимости,
		|	СУММА(ДД.Стоимость) КАК Стоимость,
		|	СУММА(ДД.СтоимостьБезНДС) КАК СтоимостьБезНДС,
		|	СУММА(ДД.СтоимостьРегл) КАК СтоимостьРегл,
		|	СУММА(ДД.ПостояннаяРазница) КАК ПостояннаяРазница,
		|	СУММА(ДД.ВременнаяРазница) КАК ВременнаяРазница,
		|	ИСТИНА КАК Первичное,
		|	НЕОПРЕДЕЛЕНО КАК ХозяйственнаяОперация,
		|	НЕОПРЕДЕЛЕНО КАК РазделУчета,
		|	НЕОПРЕДЕЛЕНО КАК ВидЗапасов,
		|	ДД.Регистратор КАК ДокументДвижения,
		|	ЕСТЬNULL(Заказы.Назначение, НЕОПРЕДЕЛЕНО) КАК Назначение,
		|	НЕОПРЕДЕЛЕНО КАК ДокументИсточник,
		|	ДД.ДокументВыпуска КАК ДокументВыпуска,
		|	НЕОПРЕДЕЛЕНО КАК Продукция,
		|	НЕОПРЕДЕЛЕНО КАК ХарактеристикаПродукции,
		|	НЕОПРЕДЕЛЕНО КАК Серия,
		|	НЕОПРЕДЕЛЕНО КАК Получатель
		|ИЗ
		|	РегистрНакопления.ПрочиеРасходыНезавершенногоПроизводства КАК ДД
		|	ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ЭтапыПроизводства КАК ЭтапыПроизводства
		|		ПО ЭтапыПроизводства.Ссылка = ДД.Этап
		|	ЛЕВОЕ СОЕДИНЕНИЕ ДолиСтоимости КАК Доли
		|		ПО Доли.ЗаказНаПроизводство = ДД.ЗаказНаПроизводство
		|		И Доли.КодСтрокиПродукция = ДД.КодСтрокиПродукция
		|		И Доли.Спецификация = ЭтапыПроизводства.Владелец
		|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.ЗаказНаПроизводство КАК Заказы
		|		ПО Заказы.Ссылка = ДД.ЗаказНаПроизводство
		|		И Заказы.ПроизводствоПоЗаказу
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|	И ДД.ЗаказНаПроизводство ССЫЛКА Документ.ЗаказНаПроизводство
		|	И НЕ ДД.Регистратор ССЫЛКА Документ.РасчетСебестоимостиТоваров
		|	И НЕ ДД.РасчетСебестоимости
		|СГРУППИРОВАТЬ ПО
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.Подразделение,
		|	ДД.ЗаказНаПроизводство,
		|	ДД.КодСтрокиПродукция,
		|	ЭтапыПроизводства.Владелец,
		|	ДД.Этап,
		|	ДД.СтатьяКалькуляции,
		|	ДД.СтатьяРасходов,
		|	ДД.АналитикаРасходов,
		|	ДД.ГруппаПродукции,
		|	ДД.ДокументВыпуска,
		|	ЕСТЬNULL(Заказы.Назначение, НЕОПРЕДЕЛЕНО)
		|";
КонецФункции

Функция ТекстПрочиеРасходыРаспределение()
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстПрочиеРасходыРаспределение"" КАК ЗапросИсточник,
		|	30 КАК Приоритет,
		|	""Распределение"" КАК ТипЗаписи,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
		|	ДАТАВРЕМЯ(1, 1, 1, 0, 0, 0) КАК Период,
		|	НЕОПРЕДЕЛЕНО КАК Регистратор,
		|	МаршрутныйЛист.Организация,
		|	НЕОПРЕДЕЛЕНО КАК Подразделение,
		|	МаршрутныйЛист.Распоряжение КАК ЗаказНаПроизводство,
		|	МаршрутныйЛист.КодСтроки КАК КодСтрокиПродукция,
		|	Этапы.Владелец КАК Спецификация,
		|	НЕОПРЕДЕЛЕНО КАК Этап,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяКалькуляции,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяРасходов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК ГруппаПродукции,
		|	ДД.АналитикаУчетаНоменклатуры КАК АналитикаУчетаПродукции,
		|	СУММА(ВЫБОР ДД.ДоляСтоимости КОГДА 0 ТОГДА 1
		|		ИНАЧЕ ДД.ДоляСтоимости КОНЕЦ
		|		* (МаршрутныйЛист.Произведено + МаршрутныйЛист.Брак)) КАК Знаменатель,
		|	СУММА(ДД.Заказано) КАК КоличествоПродукции,
		|	0 КАК ДоляСтоимости,
		|	0 КАК Стоимость,
		|	0 КАК СтоимостьБезНДС,
		|	0 КАК СтоимостьРегл,
		|	0 КАК ПостояннаяРазница,
		|	0 КАК ВременнаяРазница,
		|	ЛОЖЬ КАК Первичное,
		|	НЕОПРЕДЕЛЕНО КАК ХозяйственнаяОперация,
		|	НЕОПРЕДЕЛЕНО КАК РазделУчета,
		|	НЕОПРЕДЕЛЕНО КАК ВидЗапасов,
		|	НЕОПРЕДЕЛЕНО КАК ДокументДвижения,
		|	МаршрутныйЛист.Назначение,
		|	НЕОПРЕДЕЛЕНО КАК ДокументИсточник,
		|	НЕОПРЕДЕЛЕНО КАК ДокументВыпуска,
		|	ДД.Номенклатура КАК Продукция,
		|	ДД.Характеристика КАК ХарактеристикаПродукции,
		|	НЕОПРЕДЕЛЕНО КАК Серия,
		|	(ВЫБОР
		|		КОГДА Аналитика.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Подразделение) ТОГДА Аналитика.Подразделение
		|		КОГДА Аналитика.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Склад) ТОГДА Аналитика.СкладскаяТерритория
		|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка) КОНЕЦ) КАК Получатель
		|ИЗ
		|	РегистрНакопления.РаспоряженияНаВыпускПродукции КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.МаршрутныйЛистПроизводства КАК МаршрутныйЛист
		|		ПО МаршрутныйЛист.Ссылка = ДД.Распоряжение
		|	ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ЭтапыПроизводства КАК Этапы
		|		ПО Этапы.Ссылка = МаршрутныйЛист.Этап
		|   ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК Аналитика
		|		ПО Аналитика.Ссылка = ДД.АналитикаУчетаНоменклатуры
		|ГДЕ
		|	ДД.Период >= &НачалоПериода
		|	И МаршрутныйЛист.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|	И ДД.ТипСтоимости = ЗНАЧЕНИЕ(Перечисление.ТипыСтоимостиВыходныхИзделий.Рассчитывается)
		|	И ДД.Заказано <> 0
		|СГРУППИРОВАТЬ ПО
		|	МаршрутныйЛист.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	МаршрутныйЛист.Распоряжение,
		|	МаршрутныйЛист.КодСтроки,
		|	Этапы.Владелец,
		|	МаршрутныйЛист.Этап,
		|	МаршрутныйЛист.Назначение,
		|	ДД.Номенклатура,
		|	ДД.Характеристика,
		|	(ВЫБОР
		|		КОГДА Аналитика.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Подразделение) ТОГДА Аналитика.Подразделение
		|		КОГДА Аналитика.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Склад) ТОГДА Аналитика.СкладскаяТерритория
		|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка) КОНЕЦ)
		|";
КонецФункции

Функция ТекстПрочиеРасходыВыпускиПоЗаказам()
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстПрочиеРасходыВыпускиПоЗаказам"" КАК ЗапросИсточник,
		|	90 КАК Приоритет,
		|	""Выпуск"" КАК ТипЗаписи,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) КАК ВидДвижения,
		|	ДД.Дата КАК Период,
		|	ДД.Ссылка КАК Регистратор,
		|	ДД.Организация,
		|	НЕОПРЕДЕЛЕНО КАК Подразделение,
		|	МаршрутныйЛист.Распоряжение КАК ЗаказНаПроизводство,
		|	МаршрутныйЛист.КодСтроки КАК КодСтрокиПродукция,
		|	Этапы.Владелец КАК Спецификация,
		|	НЕОПРЕДЕЛЕНО КАК Этап,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяКалькуляции,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяРасходов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК ГруппаПродукции,
		|	(ВЫБОР
		|		КОГДА Строки.СписатьНаРасходы ТОГДА АналитикаВПодразделении.КлючАналитики
		|		ИНАЧЕ Строки.АналитикаУчетаНоменклатуры КОНЕЦ) КАК АналитикаУчетаПродукции,
		|	СУММА(Строки.Количество) КАК Знаменатель,
		|	СУММА(Строки.Количество) КАК КоличествоПродукции,
		|	0 КАК ДоляСтоимости,
		|	0 КАК Стоимость,
		|	0 КАК СтоимостьБезНДС,
		|	0 КАК СтоимостьРегл,
		|	0 КАК ПостояннаяРазница,
		|	0 КАК ВременнаяРазница,
		|	ЛОЖЬ КАК Первичное,
		|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукции) КАК ХозяйственнаяОперация,
		|	(ВЫБОР 
		|		КОГДА НЕ ЗаказДавальца.Ссылка ЕСТЬ NULL
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.МатериалыПринятыеВПереработку)
		|		КОГДА Аналитика.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Склад)
		|		 И Аналитика.СкладскаяТерритория.ЦеховаяКладовая
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты) 
		|		КОГДА Аналитика.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Склад)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыНаСкладах)
		|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты) КОНЕЦ) КАК РазделУчета,
		|	Строки.ВидЗапасов,
		|	НЕОПРЕДЕЛЕНО КАК ДокументДвижения,
		|	Строки.Назначение КАК Назначение,
		|	НЕОПРЕДЕЛЕНО КАК ДокументИсточник,
		|	НЕОПРЕДЕЛЕНО КАК ДокументВыпуска,
		|	Строки.Номенклатура КАК Продукция,
		|	Строки.Характеристика КАК ХарактеристикаПродукции,
		|	НЕОПРЕДЕЛЕНО КАК Серия,
		|	(ВЫБОР
		|		КОГДА ДД.НаправлениеВыпуска = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукцииНаСклад)
		|			ТОГДА Строки.Склад
		|		ИНАЧЕ Строки.Подразделение КОНЕЦ) КАК Получатель
		|ИЗ
		|	Документ.ВыпускПродукции КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ВыпускПродукции.Товары КАК Строки
		|		ПО Строки.Ссылка = ДД.Ссылка
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.МаршрутныйЛистПроизводства КАК МаршрутныйЛист
		|		ПО МаршрутныйЛист.Ссылка = Строки.Распоряжение
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК Аналитика
		|		ПО Аналитика.Ссылка = Строки.АналитикаУчетаНоменклатуры
		|	ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ЭтапыПроизводства КАК Этапы
		|		ПО Этапы.Ссылка = МаршрутныйЛист.Этап
		|	ЛЕВОЕ СОЕДИНЕНИЕ Справочник.Назначения КАК Назначения
		|		ПО Назначения.Ссылка = Строки.Назначение
		|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.ЗаказДавальца КАК ЗаказДавальца
		|		ПО ЗаказДавальца.Ссылка = Назначения.Заказ
		|	ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаНоменклатуры КАК АналитикаВПодразделении
		|		ПО АналитикаВПодразделении.Номенклатура = Строки.Номенклатура
		|		И АналитикаВПодразделении.Характеристика = Строки.Характеристика
		|		И АналитикаВПодразделении.МестоХранения = ДД.Подразделение
		|		И АналитикаВПодразделении.Серия = ЗНАЧЕНИЕ(Справочник.СерииНоменклатуры.ПустаяСсылка)
		|		И АналитикаВПодразделении.Назначение = Строки.Назначение
		|		И АналитикаВПодразделении.СтатьяКалькуляции = ЗНАЧЕНИЕ(Справочник.СтатьиКалькуляции.ПустаяСсылка)
		|ГДЕ
		|	ДД.Дата МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Проведен
		|	И Строки.ТипСтоимости = ЗНАЧЕНИЕ(Перечисление.ТипыСтоимостиВыходныхИзделий.Рассчитывается)
		|СГРУППИРОВАТЬ ПО
		|	ДД.Дата,
		|	ДД.Ссылка,
		|	ДД.Организация,
		|	(ВЫБОР
		|		КОГДА Строки.СписатьНаРасходы ТОГДА АналитикаВПодразделении.КлючАналитики
		|		ИНАЧЕ Строки.АналитикаУчетаНоменклатуры КОНЕЦ),
		|	Строки.ВидЗапасов,
		|	МаршрутныйЛист.Распоряжение,
		|	МаршрутныйЛист.КодСтроки,
		|	Этапы.Владелец,
		|	МаршрутныйЛист.Этап,
		|	(ВЫБОР 
		|		КОГДА НЕ ЗаказДавальца.Ссылка ЕСТЬ NULL
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.МатериалыПринятыеВПереработку)
		|		КОГДА Аналитика.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Склад)
		|		 И Аналитика.СкладскаяТерритория.ЦеховаяКладовая
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты) 
		|		КОГДА Аналитика.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Склад)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыНаСкладах)
		|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты) КОНЕЦ), // РазделУчета
		|	Строки.Назначение,
		|	Строки.Номенклатура,
		|	Строки.Характеристика,
		|	(ВЫБОР
		|		КОГДА ДД.НаправлениеВыпуска = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукцииНаСклад)
		|			ТОГДА Строки.Склад
		|		ИНАЧЕ Строки.Подразделение КОНЕЦ)
		|";
КонецФункции

Функция ТекстПрочиеРасходыОтчетыДавальцам()
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстПрочиеРасходыОтчетыДавальцам"" КАК ЗапросИсточник,
		|	90 КАК Приоритет,
		|	""ОтчетДавальцу"" КАК ТипЗаписи,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) КАК ВидДвижения,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	НЕОПРЕДЕЛЕНО КАК Подразделение,
		|	НЕОПРЕДЕЛЕНО КАК ЗаказНаПроизводство,
		|	0 КАК КодСтрокиПродукция,
		|	ЗНАЧЕНИЕ(Справочник.РесурсныеСпецификации.ПустаяСсылка) КАК Спецификация,
		|	НЕОПРЕДЕЛЕНО КАК Этап,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяКалькуляции,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяРасходов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК ГруппаПродукции,
		|	ДД.АналитикаУчетаНоменклатуры КАК АналитикаУчетаПродукции,
		|	СУММА(ДД.Количество) КАК Знаменатель,
		|	СУММА(ДД.Количество) КАК КоличествоПродукции,
		|	0 КАК ДоляСтоимости,
		|	0 КАК Стоимость,
		|	0 КАК СтоимостьБезНДС,
		|	0 КАК СтоимостьРегл,
		|	0 КАК ПостояннаяРазница,
		|	0 КАК ВременнаяРазница,
		|	ЛОЖЬ КАК Первичное,
		|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукции) КАК ХозяйственнаяОперация,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты) КАК РазделУчета,
		|	ДД.ВидЗапасов,
		|	НЕОПРЕДЕЛЕНО КАК ДокументДвижения,
		|	ДД.АналитикаУчетаНоменклатуры.Назначение КАК Назначение,
		|	НЕОПРЕДЕЛЕНО КАК ДокументИсточник,
		|	НЕОПРЕДЕЛЕНО КАК ДокументВыпуска,
		|	Аналитика.Номенклатура КАК Продукция,
		|	Аналитика.Характеристика КАК ХарактеристикаПродукции,
		|	НЕОПРЕДЕЛЕНО КАК Серия,
		|	НЕОПРЕДЕЛЕНО КАК Получатель
		|ИЗ
		|	РегистрНакопления.ВыпускПродукции КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК Аналитика
		|		ПО Аналитика.Ссылка = ДД.АналитикаУчетаНоменклатуры
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И ДД.Регистратор ССЫЛКА Документ.ОтчетДавальцу
		|СГРУППИРОВАТЬ ПО
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.Заказ,
		|	ДД.КодСтроки,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов,
		|	ДД.АналитикаУчетаНоменклатуры.Назначение,
		|	Аналитика.Номенклатура,
		|	Аналитика.Характеристика
		|";
КонецФункции
//-- НЕ УТКА

Функция ТекстПервичныеПрочиеРасходыНЗПБезЗаказов() // использует ВыпускиБезЗаказа
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстПервичныеПрочиеРасходыНЗПБезЗаказов"" КАК ЗапросИсточник,
		|	10 КАК Приоритет,
		|	(ВЫБОР
		|		КОГДА Выпуски.ДоляСтоимости ЕСТЬ NULL ТОГДА ""Партия""
		|		ИНАЧЕ ""ПартияБезЗаказа"" КОНЕЦ) КАК ТипЗаписи,
		|	ИСТИНА КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.Подразделение,
		|	ДД.ЗаказНаПроизводство,
		|	ДД.КодСтрокиПродукция,
		|	ДД.ЗаказНаПроизводство КАК Спецификация,
		|	ДД.Этап,
		|	ДД.СтатьяКалькуляции,
		|	ДД.СтатьяРасходов,
		|	ДД.АналитикаРасходов,
		|	ДД.ГруппаПродукции,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаПродукции,
		|	СУММА(ЕСТЬNULL(Выпуски.Количество, 1)) КАК Знаменатель,
		|	0 КАК КоличествоПродукции,
		|	СУММА(ДД.ДоляСтоимости) КАК ДоляСтоимости,
		|	СУММА(ДД.Стоимость) КАК Стоимость,
		|	СУММА(ДД.СтоимостьБезНДС) КАК СтоимостьБезНДС,
		|	СУММА(ДД.СтоимостьРегл) КАК СтоимостьРегл,
		|	СУММА(ДД.ПостояннаяРазница) КАК ПостояннаяРазница,
		|	СУММА(ДД.ВременнаяРазница) КАК ВременнаяРазница,
		|	ИСТИНА КАК Первичное,
		|	НЕОПРЕДЕЛЕНО КАК ХозяйственнаяОперация,
		|	НЕОПРЕДЕЛЕНО КАК РазделУчета,
		|	НЕОПРЕДЕЛЕНО КАК ВидЗапасов,
		|	ДД.Регистратор КАК ДокументДвижения,
		|	НЕОПРЕДЕЛЕНО КАК Назначение,
		|	ДД.ЗаказНаПроизводство КАК ДокументИсточник,
		|	ДД.ДокументВыпуска КАК ДокументВыпуска,
		|	НЕОПРЕДЕЛЕНО КАК Продукция,
		|	НЕОПРЕДЕЛЕНО КАК ХарактеристикаПродукции,
		|	ЗНАЧЕНИЕ(Справочник.СерииНоменклатуры.ПустаяСсылка) КАК Серия,
		|	НЕОПРЕДЕЛЕНО КАК Получатель
		|ИЗ
		|	РегистрНакопления.ПрочиеРасходыНезавершенногоПроизводства КАК ДД
		|	ЛЕВОЕ СОЕДИНЕНИЕ ВыпускиБезЗаказов КАК Выпуски
		|		ПО Выпуски.Распоряжение = ДД.ДокументВыпуска
		|		И Выпуски.КодСтроки = ДД.КодСтрокиПродукция
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|	И (ДД.ЗаказНаПроизводство ССЫЛКА Справочник.РесурсныеСпецификации
		|		ИЛИ ДД.ЗаказНаПроизводство ССЫЛКА Документ.ВыпускПродукции
		|		ИЛИ ДД.ЗаказНаПроизводство = НЕОПРЕДЕЛЕНО)
		|	И НЕ ДД.Регистратор ССЫЛКА Документ.РасчетСебестоимостиТоваров
		|	И НЕ ДД.РасчетСебестоимости
		|СГРУППИРОВАТЬ ПО
		|	(ВЫБОР
		|		КОГДА Выпуски.ДоляСтоимости ЕСТЬ NULL ТОГДА ""Партия""
		|		ИНАЧЕ ""ПартияБезЗаказа"" КОНЕЦ),
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.Подразделение,
		|	ДД.ЗаказНаПроизводство,
		|	ДД.КодСтрокиПродукция,
		|	ДД.КодСтрокиПродукция,
		|	ДД.ДокументВыпуска,
		|	ДД.Этап,
		|	ДД.СтатьяКалькуляции,
		|	ДД.СтатьяРасходов,
		|	ДД.АналитикаРасходов,
		|	ДД.ГруппаПродукции
		|";
КонецФункции

Функция ТекстПервичныеПрочиеРасходыНЗПБезЗаказовПоБазе() // использует СписанияНаВыпуск
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстПервичныеПрочиеРасходыНЗПБезЗаказовПоБазе"" КАК ЗапросИсточник,
		|	10 КАК Приоритет,
		|	""ПоБазеБезЗаказа"" КАК ТипЗаписи,
		|	ИСТИНА КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.Подразделение,
		|	ДД.ЗаказНаПроизводство,
		|	ДД.КодСтрокиПродукция,
		|	ДД.ЗаказНаПроизводство КАК Спецификация,
		|	ДД.Этап,
		|	ДД.СтатьяКалькуляции,
		|	ДД.СтатьяРасходов,
		|	ДД.АналитикаРасходов,
		|	ДД.ГруппаПродукции,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаПродукции,
		|	СУММА(ВЫБОР ЕСТЬNULL(СписанияНаВыпуск.ДоляСтоимости, 1) КОГДА 0 ТОГДА 1
		|				ИНАЧЕ ЕСТЬNULL(СписанияНаВыпуск.ДоляСтоимости, 1) КОНЕЦ) КАК Знаменатель,
		|	0 КАК КоличествоПродукции,
		|	СУММА(ДД.ДоляСтоимости) КАК ДоляСтоимости,
		|	СУММА(ДД.Стоимость) КАК Стоимость,
		|	СУММА(ДД.СтоимостьБезНДС) КАК СтоимостьБезНДС,
		|	СУММА(ДД.СтоимостьРегл) КАК СтоимостьРегл,
		|	СУММА(ДД.ПостояннаяРазница) КАК ПостояннаяРазница,
		|	СУММА(ДД.ВременнаяРазница) КАК ВременнаяРазница,
		|	ИСТИНА КАК Первичное,
		|	НЕОПРЕДЕЛЕНО КАК ХозяйственнаяОперация,
		|	НЕОПРЕДЕЛЕНО КАК РазделУчета,
		|	НЕОПРЕДЕЛЕНО КАК ВидЗапасов,
		|	ДД.Регистратор КАК ДокументДвижения,
		|	НЕОПРЕДЕЛЕНО КАК Назначение,
		|	ДД.ЗаказНаПроизводство КАК ДокументИсточник,
		|	ДД.ДокументВыпуска КАК ДокументВыпуска,
		|	НЕОПРЕДЕЛЕНО КАК Продукция,
		|	НЕОПРЕДЕЛЕНО КАК ХарактеристикаПродукции,
		|	ЗНАЧЕНИЕ(Справочник.СерииНоменклатуры.ПустаяСсылка) КАК Серия,
		|	НЕОПРЕДЕЛЕНО КАК Получатель
		|ИЗ
		|	РегистрНакопления.ПрочиеРасходыНезавершенногоПроизводства КАК ДД
		|	ЛЕВОЕ СОЕДИНЕНИЕ СписанияНаВыпуск КАК СписанияНаВыпуск
		|		ПО СписанияНаВыпуск.Ссылка = ДД.ЗаказНаПроизводство
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|	И ДД.ЗаказНаПроизводство ССЫЛКА Документ.СписаниеЗатратНаВыпуск
		|	И НЕ ДД.Регистратор ССЫЛКА Документ.РасчетСебестоимостиТоваров
		|	И НЕ ДД.РасчетСебестоимости
		|СГРУППИРОВАТЬ ПО
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.Подразделение,
		|	ДД.ЗаказНаПроизводство,
		|	ДД.КодСтрокиПродукция,
		|	ДД.ДокументВыпуска,
		|	ДД.Этап,
		|	ДД.СтатьяКалькуляции,
		|	ДД.СтатьяРасходов,
		|	ДД.АналитикаРасходов,
		|	ДД.ГруппаПродукции
		|";
КонецФункции

Функция ТекстПервичныеПрочиеРасходыПереработчик() // использует ДолиСтоимости
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстПервичныеПрочиеРасходыПереработчик"" КАК ЗапросИсточник,
		|	10 КАК Приоритет,
		|	""Партия"" КАК ТипЗаписи,
		|	ИСТИНА КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.Подразделение,
		|	ДД.ЗаказНаПроизводство,
		|	0 КАК КодСтрокиПродукция,
		|	ЗНАЧЕНИЕ(Справочник.РесурсныеСпецификации.ПустаяСсылка) КАК Спецификация,
		|	НЕОПРЕДЕЛЕНО КАК Этап,
		|	ДД.СтатьяКалькуляции,
		|	ДД.СтатьяРасходов,
		|	ДД.АналитикаРасходов,
		|	ДД.ГруппаПродукции,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаПродукции,
		|	МАКСИМУМ(ЕСТЬNULL(Доли.ДоляСтоимости, 1)) КАК Знаменатель,
		|	0 КАК КоличествоПродукции,
		|	СУММА(ДД.ДоляСтоимости) КАК ДоляСтоимости,
		|	СУММА(ДД.Стоимость) КАК Стоимость,
		|	СУММА(ДД.СтоимостьБезНДС) КАК СтоимостьБезНДС,
		|	СУММА(ДД.СтоимостьРегл) КАК СтоимостьРегл,
		|	СУММА(ДД.ПостояннаяРазница) КАК ПостояннаяРазница,
		|	СУММА(ДД.ВременнаяРазница) КАК ВременнаяРазница,
		|	ИСТИНА КАК Первичное,
		|	НЕОПРЕДЕЛЕНО КАК ХозяйственнаяОперация,
		|	НЕОПРЕДЕЛЕНО КАК РазделУчета,
		|	НЕОПРЕДЕЛЕНО КАК ВидЗапасов,
		|	ДД.Регистратор КАК ДокументДвижения,
		|	НЕОПРЕДЕЛЕНО КАК Назначение,
		|	НЕОПРЕДЕЛЕНО КАК ДокументИсточник,
		|	ДД.ДокументВыпуска КАК ДокументВыпуска,
		|	НЕОПРЕДЕЛЕНО КАК Продукция,
		|	НЕОПРЕДЕЛЕНО КАК ХарактеристикаПродукции,
		|	НЕОПРЕДЕЛЕНО КАК Серия,
		|	НЕОПРЕДЕЛЕНО КАК Получатель
		|ИЗ
		|	РегистрНакопления.ПрочиеРасходыНезавершенногоПроизводства КАК ДД
		|	ЛЕВОЕ СОЕДИНЕНИЕ ДолиСтоимости КАК Доли
		|		ПО Доли.ЗаказНаПроизводство = ДД.ЗаказНаПроизводство
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|	И ДД.ЗаказНаПроизводство ССЫЛКА Документ.ЗаказПереработчику
		|	И НЕ ДД.Регистратор ССЫЛКА Документ.РасчетСебестоимостиТоваров
		|	И НЕ ДД.РасчетСебестоимости
		|СГРУППИРОВАТЬ ПО
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.Подразделение,
		|	ДД.ЗаказНаПроизводство,
		|	ДД.Этап,
		|	ДД.СтатьяКалькуляции,
		|	ДД.СтатьяРасходов,
		|	ДД.АналитикаРасходов,
		|	ДД.ДокументВыпуска,
		|	ДД.ГруппаПродукции
		|";
КонецФункции

Функция ТекстПрочиеРасходыДавальческиеПолуфабрикаты() // использует ДолиСтоимости
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстПрочиеРасходыДавальческиеПолуфабрикаты"" КАК ЗапросИсточник,
		|	10 КАК Приоритет,
		|	""ПолуфабрикатДавальца"" КАК ТипЗаписи,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	Аналитика.МестоХранения КАК Подразделение,
		|	ДД.ЗаказНаПроизводство,
		|	ДД.КодСтрокиПродукция,
		|	Этапы.Владелец КАК Спецификация,
		|	ДД.Этап,
		|	ДД.СтатьяКалькуляции,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяРасходов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК ГруппаПродукции,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаПродукции,
		|	СУММА(ДД.Количество) КАК Знаменатель,
		|	МАКСИМУМ(
		|		ВЫБОР
		|			КОГДА НЕ Доли.ДоляСтоимости ЕСТЬ NULL ТОГДА Доли.ДоляСтоимости
		|			КОГДА НЕ ВыпускБезЗаказа.Количество ЕСТЬ NULL ТОГДА ВыпускБезЗаказа.Количество
		|			ИНАЧЕ 1 КОНЕЦ) КАК КоличествоПродукции,
		|	0 КАК ДоляСтоимости,
		|	0 КАК Стоимость,
		|	0 КАК СтоимостьБезНДС,
		|	0 КАК СтоимостьРегл,
		|	0 КАК ПостояннаяРазница,
		|	0 КАК ВременнаяРазница,
		|	ИСТИНА КАК Первичное,
		|	НЕОПРЕДЕЛЕНО КАК ХозяйственнаяОперация,
		|	НЕОПРЕДЕЛЕНО КАК РазделУчета,
		|	НЕОПРЕДЕЛЕНО КАК ВидЗапасов,
		|	ДД.Регистратор КАК ДокументДвижения,
		|	ДД.АналитикаУчетаНоменклатуры.Назначение КАК Назначение,
		|	НЕОПРЕДЕЛЕНО КАК ДокументИсточник,
		|	ЕСТЬNULL(ВыпускБезЗаказа.Ссылка, НЕОПРЕДЕЛЕНО) КАК ДокументВыпуска,
		|	Аналитика.Номенклатура КАК Продукция,
		|	Аналитика.Характеристика КАК ХарактеристикаПродукции,
		|	НЕОПРЕДЕЛЕНО КАК Серия,
		|	НЕОПРЕДЕЛЕНО КАК Получатель
		|ИЗ
		|	РегистрНакопления.ПартииПроизводственныхЗатрат КАК ДД
		|	ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ЭтапыПроизводства КАК Этапы
		|		ПО Этапы.Ссылка = ДД.Этап
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК Аналитика
		|		ПО Аналитика.Ссылка = ДД.АналитикаУчетаНоменклатуры
		|	ЛЕВОЕ СОЕДИНЕНИЕ ДолиСтоимости КАК Доли
		|		ПО Доли.ЗаказНаПроизводство = ДД.ЗаказНаПроизводство
		|		И Доли.КодСтрокиПродукция = ДД.КодСтрокиПродукция
		|		И Доли.Спецификация = Этапы.Владелец
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ВыпускПродукции КАК Выпуск
		|		ПО Выпуск.Ссылка = ДД.ДокументПоступления
		|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.ВыпускПродукции.Товары КАК ВыпускБезЗаказа
		|		ПО ВыпускБезЗаказа.Ссылка = ДД.ЗаказНаПроизводство
		|		И ВыпускБезЗаказа.КодСтроки = ДД.КодСтрокиПродукция
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		|	И ДД.СтатьяКалькуляции <> ЗНАЧЕНИЕ(Справочник.СтатьиКалькуляции.ПустаяСсылка)
		|	И ДД.ВидЗапасов.ТипЗапасов = ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.ПолуфабрикатДавальца)
		|	И ДД.ДокументПоступления ССЫЛКА Документ.ВыпускПродукции
		|	И Выпуск.Дата МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|СГРУППИРОВАТЬ ПО
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	Аналитика.МестоХранения,
		|	ДД.ЗаказНаПроизводство,
		|	ДД.КодСтрокиПродукция,
		|	Этапы.Владелец,
		|	ДД.Этап,
		|	ДД.СтатьяКалькуляции,
		|	ДД.АналитикаУчетаНоменклатуры.Назначение,
		|	Аналитика.Номенклатура,
		|	Аналитика.Характеристика,
		|	ЕСТЬNULL(ВыпускБезЗаказа.Ссылка, НЕОПРЕДЕЛЕНО)
		|";
КонецФункции

Функция ТекстПрочиеРасходыОтчетыПереработчика()
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстПрочиеРасходыОтчетыПереработчика"" КАК ЗапросИсточник,
		|	30 КАК Приоритет,
		|	""Распределение"" КАК ТипЗаписи,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
		|	ДД.Дата КАК Период,
		|	НЕОПРЕДЕЛЕНО КАК Регистратор,
		|	ДД.Организация,
		|	НЕОПРЕДЕЛЕНО КАК Подразделение,
		|	Строки.ЗаказПереработчику КАК ЗаказНаПроизводство,
		|	0 КАК КодСтрокиПродукция,
		|	ЗНАЧЕНИЕ(Справочник.РесурсныеСпецификации.ПустаяСсылка) КАК Спецификация,
		|	НЕОПРЕДЕЛЕНО КАК Этап,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяКалькуляции,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяРасходов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК ГруппаПродукции,
		|	Строки.АналитикаУчетаНоменклатуры КАК АналитикаУчетаПродукции,
		|	СУММА(ВЫБОР Строки.ДоляСтоимости КОГДА 0 ТОГДА 1
		|		ИНАЧЕ Строки.ДоляСтоимости КОНЕЦ) КАК Знаменатель,
		|	СУММА(Строки.Количество) КАК КоличествоПродукции,
		|	0 КАК ДоляСтоимости,
		|	0 КАК Стоимость,
		|	0 КАК СтоимостьБезНДС,
		|	0 КАК СтоимостьРегл,
		|	0 КАК ПостояннаяРазница,
		|	0 КАК ВременнаяРазница,
		|	ЛОЖЬ КАК Первичное,
		|	НЕОПРЕДЕЛЕНО КАК ХозяйственнаяОперация,
		|	НЕОПРЕДЕЛЕНО КАК РазделУчета,
		|	НЕОПРЕДЕЛЕНО КАК ВидЗапасов,
		|	НЕОПРЕДЕЛЕНО КАК ДокументДвижения,
		|	НЕОПРЕДЕЛЕНО КАК Назначение,
		|	НЕОПРЕДЕЛЕНО КАК ДокументИсточник,
		|	НЕОПРЕДЕЛЕНО КАК ДокументВыпуска,
		|	Строки.Номенклатура КАК Продукция,
		|	Строки.Характеристика КАК ХарактеристикаПродукции,
		|	НЕОПРЕДЕЛЕНО КАК Серия,
		|	НЕОПРЕДЕЛЕНО КАК Получатель
		|ИЗ
		|	Документ.ОтчетПереработчика КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ОтчетПереработчика.Продукция КАК Строки
		|		ПО Строки.Ссылка = ДД.Ссылка
		|ГДЕ
		|	ДД.Дата МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Проведен
		|	И Строки.ЗаказПереработчику <> ЗНАЧЕНИЕ(Документ.ЗаказПереработчику.ПустаяСсылка)
		|СГРУППИРОВАТЬ ПО
		|	ДД.Дата,
		|	ДД.Организация,
		|	Строки.АналитикаУчетаНоменклатуры,
		|	Строки.ЗаказПереработчику,
		|	Строки.Номенклатура,
		|	Строки.Характеристика
		|";
КонецФункции

Функция ТекстПрочиеРасходыСписанияЗатратНаВыпуск()
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстПрочиеРасходыСписанияЗатратНаВыпуск"" КАК ЗапросИсточник,
		|	30 КАК Приоритет,
		|	""СписанияНаВыпуск"" КАК ТипЗаписи,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
		|	ДАТАВРЕМЯ(1,1,1) КАК Период,
		|	НЕОПРЕДЕЛЕНО КАК Регистратор,
		|	ДД.Организация,
		|	НЕОПРЕДЕЛЕНО КАК Подразделение,
		|	ДД.Ссылка КАК ЗаказНаПроизводство,
		|	Выходы.КодСтроки КАК КодСтрокиПродукция,
		|	ДД.Ссылка КАК Спецификация,
		|	НЕОПРЕДЕЛЕНО КАК Этап,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяКалькуляции,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяРасходов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК ГруппаПродукции,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаПродукции,
		|	СУММА(ВЫБОР Выходы.ДоляСтоимости КОГДА 0 ТОГДА 1
		|		ИНАЧЕ Выходы.ДоляСтоимости КОНЕЦ) КАК Знаменатель,
		|	СУММА(ДД.Количество) КАК КоличествоПродукции,
		|	0 КАК ДоляСтоимости,
		|	0 КАК Стоимость,
		|	0 КАК СтоимостьБезНДС,
		|	0 КАК СтоимостьРегл,
		|	0 КАК ПостояннаяРазница,
		|	0 КАК ВременнаяРазница,
		|	ЛОЖЬ КАК Первичное,
		|	НЕОПРЕДЕЛЕНО КАК ХозяйственнаяОперация,
		|	НЕОПРЕДЕЛЕНО КАК РазделУчета,
		|	НЕОПРЕДЕЛЕНО КАК ВидЗапасов,
		|	НЕОПРЕДЕЛЕНО КАК ДокументДвижения,
		|	НЕОПРЕДЕЛЕНО КАК Назначение,
		|	НЕОПРЕДЕЛЕНО КАК ДокументИсточник,
		|	Выходы.Распоряжение КАК ДокументВыпуска,
		|	Выходы.Номенклатура КАК Продукция,
		|	Выходы.Характеристика КАК ХарактеристикаПродукции,
		|	НЕОПРЕДЕЛЕНО КАК Серия,
		|	НЕОПРЕДЕЛЕНО КАК Получатель
		|ИЗ
		|	Документ.СписаниеЗатратНаВыпуск КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.СписаниеЗатратНаВыпуск.ВыходныеИзделия КАК Выходы
		|		ПО Выходы.Ссылка = ДД.Ссылка
		|ГДЕ
		|	ДД.Дата МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Проведен
		|СГРУППИРОВАТЬ ПО
		|	ДД.Ссылка,
		|	ДД.Организация,
		|	Выходы.Распоряжение,
		|	Выходы.КодСтроки,
		|	Выходы.Номенклатура,
		|	Выходы.Характеристика
		|";
КонецФункции

Функция ТекстПрочиеРасходыВыпускиБезЗаказов()
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстПрочиеРасходыВыпускиБезЗаказов"" КАК ЗапросИсточник,
		|	90 КАК Приоритет,
		|	""ВыпускБезЗаказа"" КАК ТипЗаписи,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) КАК ВидДвижения,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	НЕОПРЕДЕЛЕНО КАК Подразделение,
		|	НЕОПРЕДЕЛЕНО КАК ЗаказНаПроизводство,
		|	ДД.КодСтроки КАК КодСтрокиПродукция,
		|	НЕОПРЕДЕЛЕНО КАК Спецификация,
		|	НЕОПРЕДЕЛЕНО КАК Этап,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяКалькуляции,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяРасходов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК ГруппаПродукции,
		|	ДД.АналитикаУчетаПродукции,
		|	СУММА(ДД.Количество) КАК Знаменатель,
		|	СУММА(ДД.Количество) КАК КоличествоПродукции,
		|	0 КАК ДоляСтоимости,
		|	0 КАК Стоимость,
		|	0 КАК СтоимостьБезНДС,
		|	0 КАК СтоимостьРегл,
		|	0 КАК ПостояннаяРазница,
		|	0 КАК ВременнаяРазница,
		|	ЛОЖЬ КАК Первичное,
		|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукции) КАК ХозяйственнаяОперация,
		//++ НЕ УТКА
		|	(ВЫБОР
		|		КОГДА ЗаказДавальца.Ссылка ЕСТЬ NULL ТОГДА
		//-- НЕ УТКА
		|			ДД.КорРазделУчета
		//++ НЕ УТКА
		|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.МатериалыПринятыеВПереработку) КОНЕЦ)
		//-- НЕ УТКА
		|		КАК РазделУчета,
		|	(ВЫБОР 
		|		КОГДА ДД.КорВидЗапасов.ТипЗапасов = ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.Услуга)
		|			ТОГДА НЕОПРЕДЕЛЕНО
		|		ИНАЧЕ ДД.КорВидЗапасов КОНЕЦ) КАК ВидЗапасов,
		|	НЕОПРЕДЕЛЕНО КАК ДокументДвижения,
		|	ДД.Назначение,
		|	НЕОПРЕДЕЛЕНО КАК ДокументИсточник,
		|	ДД.Распоряжение КАК ДокументВыпуска,
		|	ДД.Номенклатура КАК Продукция,
		|	ДД.Характеристика КАК ХарактеристикаПродукции,
		|	НЕОПРЕДЕЛЕНО КАК Серия,
		|	НЕОПРЕДЕЛЕНО КАК Получатель
		|ИЗ
		|	РегистрНакопления.РаспоряженияНаСписаниеПоНормативам КАК ДД
		|	ЛЕВОЕ СОЕДИНЕНИЕ Справочник.Назначения КАК Назначения
		|		ПО Назначения.Ссылка = ДД.Назначение
		//++ НЕ УТКА
		|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.ЗаказДавальца КАК ЗаказДавальца
		|		ПО ЗаказДавальца.Ссылка = Назначения.Заказ
		//-- НЕ УТКА
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.СтруктураПредприятия КАК Подразделения
		|		ПО Подразделения.Ссылка = ДД.Подразделение
		|		И Подразделения.ИспользуетсяСписаниеЗатратНаВыпуск
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|СГРУППИРОВАТЬ ПО
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.КодСтроки,
		|	ДД.АналитикаУчетаПродукции,
		|	ДД.Номенклатура,
		|	ДД.Характеристика,
		//++ НЕ УТКА
		|	(ВЫБОР
		|		КОГДА ЗаказДавальца.Ссылка ЕСТЬ NULL ТОГДА
		//-- НЕ УТКА
		|			ДД.КорРазделУчета
		//++ НЕ УТКА
		|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.МатериалыПринятыеВПереработку) КОНЕЦ)
		//-- НЕ УТКА
		|		,
		|	(ВЫБОР 
		|		КОГДА ДД.КорВидЗапасов.ТипЗапасов = ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.Услуга)
		|			ТОГДА НЕОПРЕДЕЛЕНО
		|		ИНАЧЕ ДД.КорВидЗапасов КОНЕЦ),
		|	ДД.Распоряжение,
		|	ДД.Назначение
		|";
КонецФункции
	
Функция ТекстПрочиеРасходыВыпускиБезЗаказовБезСписанияЗатратНаВыпуск()
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстПрочиеРасходыВыпускиБезЗаказовБезСписанияЗатратНаВыпуск"" КАК ЗапросИсточник,
		|	90 КАК Приоритет,
		|	""ВыпускБезЗаказа"" КАК ТипЗаписи,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) КАК ВидДвижения,
		|	ДД.Дата КАК Период,
		|	ДД.Ссылка КАК Регистратор,
		|	ДД.Организация,
		|	НЕОПРЕДЕЛЕНО КАК Подразделение,
		|	НЕОПРЕДЕЛЕНО КАК ЗаказНаПроизводство,
		|	Строки.КодСтроки КАК КодСтрокиПродукция,
		|	НЕОПРЕДЕЛЕНО КАК Спецификация,
		|	НЕОПРЕДЕЛЕНО КАК Этап,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяКалькуляции,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяРасходов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК ГруппаПродукции,
		|	(ВЫБОР КОГДА Строки.СписатьНаРасходы ТОГДА АналитикаВПодразделении.КлючАналитики
		|		ИНАЧЕ Строки.АналитикаУчетаНоменклатуры КОНЕЦ) КАК АналитикаУчетаПродукции,
		|	СУММА(Строки.Количество) КАК Знаменатель,
		|	СУММА(Строки.Количество) КАК КоличествоПродукции,
		|	0 КАК ДоляСтоимости,
		|	0 КАК Стоимость,
		|	0 КАК СтоимостьБезНДС,
		|	0 КАК СтоимостьРегл,
		|	0 КАК ПостояннаяРазница,
		|	0 КАК ВременнаяРазница,
		|	ЛОЖЬ КАК Первичное,
		|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукции) КАК ХозяйственнаяОперация,
		|	(ВЫБОР
		//++ НЕ УТКА
		|		КОГДА НЕ ЗаказДавальца.Ссылка ЕСТЬ NULL
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.МатериалыПринятыеВПереработку)
		//-- НЕ УТКА
		|		КОГДА ДД.НаправлениеВыпуска = Значение(Перечисление.ХозяйственныеОперации.ВыпускПродукцииВПодразделение)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты)
		|		КОГДА Строки.АналитикаУчетаНоменклатуры.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Склад)
		|		 И Строки.АналитикаУчетаНоменклатуры.СкладскаяТерритория.ЦеховаяКладовая
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты)
		|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыНаСкладах) КОНЕЦ) КАК РазделУчета,
		|	Строки.ВидЗапасов КАК ВидЗапасов,
		|	НЕОПРЕДЕЛЕНО КАК ДокументДвижения,
		|	Строки.Назначение,
		|	НЕОПРЕДЕЛЕНО КАК ДокументИсточник,
		|	ДД.Ссылка КАК ДокументВыпуска,
		|	Строки.Номенклатура КАК Продукция,
		|	Строки.Характеристика КАК ХарактеристикаПродукции,
		|	НЕОПРЕДЕЛЕНО КАК Серия,
		|	НЕОПРЕДЕЛЕНО КАК Получатель
		|ИЗ
		|	Документ.ВыпускПродукции КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ВыпускПродукции.Товары КАК Строки
		|		ПО Строки.Ссылка = ДД.Ссылка
		|	ЛЕВОЕ СОЕДИНЕНИЕ Справочник.Назначения КАК Назначения
		|		ПО Назначения.Ссылка = Строки.Назначение
		//++ НЕ УТКА
		|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.ЗаказДавальца КАК ЗаказДавальца
		|		ПО ЗаказДавальца.Ссылка = Назначения.Заказ
		//-- НЕ УТКА
		|	ЛЕВОЕ СОЕДИНЕНИЕ
		|		РегистрСведений.АналитикаУчетаНоменклатуры КАК АналитикаВПодразделении
		|	ПО
		|		Строки.Номенклатура = АналитикаВПодразделении.Номенклатура
		|		И Строки.Характеристика = АналитикаВПодразделении.Характеристика
		|		И (ДД.Подразделение = АналитикаВПодразделении.МестоХранения)
		|		И (ВЫБОР
		|			КОГДА Строки.СтатусУказанияСерий = 14 ТОГДА Строки.Серия = АналитикаВПодразделении.Серия
		|			ИНАЧЕ АналитикаВПодразделении.Серия = ЗНАЧЕНИЕ(Справочник.СерииНоменклатуры.ПустаяСсылка) КОНЕЦ)
		|		И Строки.Назначение = АналитикаВПодразделении.Назначение
		|		И АналитикаВПодразделении.СтатьяКалькуляции = ЗНАЧЕНИЕ(Справочник.СтатьиКалькуляции.ПустаяСсылка)
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.СтруктураПредприятия КАК Подразделения
		|		ПО Подразделения.Ссылка = ДД.Подразделение
		|		И НЕ Подразделения.ИспользуетсяСписаниеЗатратНаВыпуск
		|ГДЕ
		|	ДД.Дата МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Проведен
		|	И НЕ ДД.ВыпускПоРаспоряжениям
		|СГРУППИРОВАТЬ ПО
		|	ДД.Дата,
		|	ДД.Ссылка,
		|	ДД.Организация,
		|	Строки.КодСтроки,
		|	(ВЫБОР КОГДА Строки.СписатьНаРасходы ТОГДА АналитикаВПодразделении.КлючАналитики
		|		ИНАЧЕ Строки.АналитикаУчетаНоменклатуры КОНЕЦ),
		|	(ВЫБОР
		//++ НЕ УТКА
		|		КОГДА НЕ ЗаказДавальца.Ссылка ЕСТЬ NULL
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.МатериалыПринятыеВПереработку)
		//-- НЕ УТКА
		|		КОГДА ДД.НаправлениеВыпуска = Значение(Перечисление.ХозяйственныеОперации.ВыпускПродукцииВПодразделение)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты)
		|		КОГДА Строки.АналитикаУчетаНоменклатуры.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Склад)
		|		 И Строки.АналитикаУчетаНоменклатуры.СкладскаяТерритория.ЦеховаяКладовая
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты)
		|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыНаСкладах) КОНЕЦ), // РазделУчета
		|	Строки.ВидЗапасов,
		|	Строки.Назначение,
		|	Строки.Номенклатура,
		|	Строки.Характеристика
		|";
КонецФункции

Функция ТекстПрочиеРасходыПоступленияОтПереработчиков()
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстПрочиеРасходыПоступленияОтПереработчиков"" КАК ЗапросИсточник,
		|	90 КАК Приоритет,
		|	(ВЫБОР
		|		КОГДА Строки.ЗаказПереработчику = ЗНАЧЕНИЕ(Документ.ЗаказПереработчику.ПустаяСсылка) ТОГДА ""ВыпускБезЗаказа""
		|		ИНАЧЕ ""Выпуск"" КОНЕЦ) КАК ТипЗаписи,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) КАК ВидДвижения,
		|	ДД.Дата КАК Период,
		|	ДД.Ссылка КАК Регистратор,
		|	ДД.Организация,
		|	НЕОПРЕДЕЛЕНО КАК Подразделение,
		|	(ВЫБОР
		|		КОГДА Строки.ЗаказПереработчику = ЗНАЧЕНИЕ(Документ.ЗаказПереработчику.ПустаяСсылка) ТОГДА НЕОПРЕДЕЛЕНО
		|		ИНАЧЕ Строки.ЗаказПереработчику КОНЕЦ) КАК ЗаказНаПроизводство,
		|	0 КАК КодСтрокиПродукция,
		|	ЗНАЧЕНИЕ(Справочник.РесурсныеСпецификации.ПустаяСсылка) КАК Спецификация,
		|	НЕОПРЕДЕЛЕНО КАК Этап,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяКалькуляции,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяРасходов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК ГруппаПродукции,
		|	Строки.АналитикаУчетаНоменклатуры КАК АналитикаУчетаПродукции,
		|	СУММА(Строки.Количество) КАК Знаменатель,
		|	СУММА(Строки.Количество) КАК КоличествоПродукции,
		|	0 КАК ДоляСтоимости,
		|	0 КАК Стоимость,
		|	0 КАК СтоимостьБезНДС,
		|	0 КАК СтоимостьРегл,
		|	0 КАК ПостояннаяРазница,
		|	0 КАК ВременнаяРазница,
		|	ЛОЖЬ КАК Первичное,
		|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукции) КАК ХозяйственнаяОперация,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыНаСкладах) КАК РазделУчета,
		|	Строки.ВидЗапасов,
		|	НЕОПРЕДЕЛЕНО КАК ДокументДвижения,
		|	Строки.АналитикаУчетаНоменклатуры.Назначение КАК Назначение,
		|	НЕОПРЕДЕЛЕНО КАК ДокументИсточник,
		|	ДД.Ссылка КАК ДокументВыпуска,
		|	Строки.Номенклатура КАК Продукция,
		|	Строки.Характеристика КАК ХарактеристикаПродукции,
		|	НЕОПРЕДЕЛЕНО КАК Серия,
		|	НЕОПРЕДЕЛЕНО КАК Получатель
		|ИЗ
		|	Документ.ПоступлениеОтПереработчика КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ПоступлениеОтПереработчика.Товары КАК Строки
		|		ПО Строки.Ссылка = ДД.Ссылка
		|ГДЕ
		|	ДД.Дата МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Проведен
		|СГРУППИРОВАТЬ ПО
		|	(ВЫБОР
		|		КОГДА Строки.ЗаказПереработчику = ЗНАЧЕНИЕ(Документ.ЗаказПереработчику.ПустаяСсылка) ТОГДА ""ВыпускБезЗаказа""
		|		ИНАЧЕ ""Выпуск"" КОНЕЦ),
		|	ДД.Дата,
		|	ДД.Ссылка,
		|	ДД.Организация,
		|	(ВЫБОР
		|		КОГДА Строки.ЗаказПереработчику = ЗНАЧЕНИЕ(Документ.ЗаказПереработчику.ПустаяСсылка) ТОГДА НЕОПРЕДЕЛЕНО
		|		ИНАЧЕ Строки.ЗаказПереработчику КОНЕЦ),
		|	Строки.АналитикаУчетаНоменклатуры,
		|	Строки.ВидЗапасов,
		|	Строки.АналитикаУчетаНоменклатуры.Назначение,
		|	Строки.Номенклатура,
		|	Строки.Характеристика
		|";
КонецФункции

Функция ТекстДополнениеПрочихРасходовНЗП()
	Возврат "
		|ВЫБРАТЬ
		|	""ТекстДополнениеПрочихРасходовНЗП"" КАК ЗапросИсточник,
		|	10 КАК Приоритет,
		|	""Дополнение"" КАК ТипЗаписи,
		|	ИСТИНА КАК РасчетЗавершен,
		|	ДД.ВидДвижения,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.Подразделение,
		|	ДД.ЗаказНаПроизводство,
		|	ДД.КодСтрокиПродукция,
		|	НЕОПРЕДЕЛЕНО КАК Спецификация,
		|	ДД.Этап,
		|	ДД.СтатьяКалькуляции,
		|	ДД.СтатьяРасходов,
		|	ДД.АналитикаРасходов,
		|	ДД.ГруппаПродукции,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаПродукции,
		|	0 КАК Знаменатель,
		|	0 КАК КоличествоПродукции,
		|	ДД.ДоляСтоимости,
		|	ДД.Стоимость,
		|	ДД.СтоимостьБезНДС,
		|	ДД.СтоимостьРегл,
		|	ДД.ПостояннаяРазница,
		|	ДД.ВременнаяРазница,
		|	ИСТИНА КАК Первичное,
		|	НЕОПРЕДЕЛЕНО КАК ХозяйственнаяОперация,
		|	НЕОПРЕДЕЛЕНО КАК РазделУчета,
		|	НЕОПРЕДЕЛЕНО КАК ВидЗапасов,
		|	ДД.ДокументДвижения,
		|	НЕОПРЕДЕЛЕНО КАК Назначение,
		|	НЕОПРЕДЕЛЕНО КАК ДокументИсточник,
		|	ДД.ДокументВыпуска,
		|	НЕОПРЕДЕЛЕНО КАК Продукция,
		|	НЕОПРЕДЕЛЕНО КАК ХарактеристикаПродукции,
		|	НЕОПРЕДЕЛЕНО КАК Серия,
		|	НЕОПРЕДЕЛЕНО КАК Получатель
		|ИЗ
		|	РегистрНакопления.ПрочиеРасходыНезавершенногоПроизводства КАК ДД
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		|	И ДД.Регистратор ССЫЛКА Документ.КорректировкаРегистров
		|";
КонецФункции

#КонецОбласти


#Область РасчетСебестоимостиПроизводства

Функция ДанныеДляСебестоимостиПроизводства(НачалоПериода, ОкончаниеПериода, МассивОрганизаций)
	ТекстСортировка = "";
	ИсходныйТекстЗапроса = 
		ТекстСебестоимостьПроизводстваИнициализация() + ";" // вт Возвраты, АналитикаДавальца, ЕстьВозвратныеОтходы
		+ ТекстОписаниеСебестоимость()
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстИсходныеДвиженияСебестоимостиПроизводства()
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстВозвратИзПроизводстваСебестоимость()
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстВозвратИзПроизводстваСебестоимостьБезПУ() // использует Возвраты
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстВозвратИзПроизводстваНаСкладСебестоимость()
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстСписаниеИзПроизводстваСебестоимость()
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстПеремещенияВПроизводствеСебестоимость()
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстПартииНезавершенногоПроизводстваСебестоимость()
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстПартииНезавершенногоПроизводстваУслугиПереработчика()
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстПартииНезавершенногоПроизводстваУслугиПереработчикаВыпуск()
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстТрудозатратыНЗПСебестоимость()
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстПрочиеРасходыНЗПСебестоимость()
		+ ТекстСортировка;
		
	МВТ = Новый МенеджерВременныхТаблиц;	
	ИсходныйЗапрос = Новый Запрос(СтрЗаменить(ИсходныйТекстЗапроса, "//ВоВременнуюТаблицу", ""));
	ИсходныйЗапрос.УстановитьПараметр("НачалоПериода", НачалоПериода);
	ИсходныйЗапрос.УстановитьПараметр("ОкончаниеПериода", ОкончаниеПериода);
	ИсходныйЗапрос.УстановитьПараметр("МассивОрганизаций", МассивОрганизаций);	
	ИсходныйЗапрос.УстановитьПараметр("СебестоимостьПоНазначениям",
		РасчетСебестоимостиПовтИсп.СебестоимостьТоваровПоНазначениям(НачалоПериода));
	ИсходныйЗапрос.УстановитьПараметр("ПартионныйУчетВключен", РасчетСебестоимостиПовтИсп.ПартионныйУчетВерсии21(НачалоПериода));
	ИсходныйЗапрос.МенеджерВременныхТаблиц = МВТ;
	ИсходныйЗапрос.Выполнить();
	УдалитьНеИзменившиесяДанныеСебестоимостиПроизводства(МВТ, НачалоПериода, ОкончаниеПериода);
	Возврат МВТ;
КонецФункции

Функция ТекстСебестоимостьПроизводстваИнициализация() // вт Возвраты, АналитикаДавальца, ЕстьВозвратныеОтходы
	Возврат "
		|ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	ДД.Регистратор,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.КорАналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов
		|ПОМЕСТИТЬ
		|	Возвраты
		|ИЗ
		|	РегистрНакопления.ТоварыОрганизаций КАК ДД
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И ДД.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВозвратИзПроизводства)
		|	И НЕ &ПартионныйУчетВключен
		|;
		|ВЫБРАТЬ
		|	НЕОПРЕДЕЛЕНО КАК Регистратор,
		|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПоПартнерам.ПустаяСсылка) КАК АналитикаУчетаПоПартнерам
		|ПОМЕСТИТЬ
		|	АналитикаДавальца
		|
		//++ НЕ УТКА
		|ОБЪЕДИНИТЬ ВСЕ
		|ВЫБРАТЬ
		|	ДД.Регистратор,
		|	МАКСИМУМ(ДД.АналитикаУчетаПоПартнерам) КАК АналитикаУчетаПоПартнерам
		|ИЗ
		|	РегистрНакопления.СебестоимостьТоваров КАК ДД
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И ДД.Регистратор ССЫЛКА Документ.ОтчетДавальцу
		|	И ДД.АналитикаУчетаНоменклатуры <> ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка)
		|СГРУППИРОВАТЬ ПО
		|	ДД.Регистратор
		//-- НЕ УТКА
		|;
		|ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	ДД.Организация,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов,
		|	ДД.ДокументПоступления
		|ПОМЕСТИТЬ
		|	ЕстьВозвратныеОтходы
		|ИЗ
		|	РегистрНакопления.ПартииПроизводственныхЗатрат КАК ДД
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|	И ДД.Количество < 0
		|	И ДД.ДокументПоступления ССЫЛКА Документ.ВыпускПродукции
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|";
КонецФункции

Функция ТекстИсходныеДвиженияСебестоимостиПроизводства()
	Возврат "
		|ВЫБРАТЬ
		|	ДД.ВидДвижения,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.РазделУчета,
		|	ДД.ВидЗапасов,
		|	ДД.Организация,
		|	ДД.Количество,
		|	ДД.Стоимость,
		|	ДД.СтоимостьБезНДС,
		|	ДД.ДопРасходы,
		|	ДД.ДопРасходыБезНДС,
		|	ДД.СтоимостьРегл,
		|	ДД.ПостояннаяРазница,
		|	ДД.ВременнаяРазница,
		|	ДД.ХозяйственнаяОперация,
		|	ДД.КорАналитикаУчетаНоменклатуры,
		|	ДД.КорРазделУчета,
		|	ДД.КорВидЗапасов,
		|	ДД.КорОрганизация,
		|	ДД.КорСтоимость,
		|	ДД.АналитикаУчетаПоПартнерам,
		|	ДД.ЗаказКлиента,
		|	ДД.Подразделение,
		|	ДД.АналитикаРасходов,
		|	ДД.СтатьяРасходовСписания,
		|	ДД.СтатьяДоходов,
		|	ДД.АналитикаДоходов,
		|	ДД.ПериодПродажи,
		|	ДД.СтатьяАктивовПассивов,
		|	ДД.АналитикаАктивовПассивов,
		|	ДД.ДокументДвижения,
		|	ДД.ИдентификаторСтроки,
		|	ДД.КорНаправлениеДеятельности,
		|	ДД.ГруппаПродукции
		|ИЗ
		|	РегистрНакопления.СебестоимостьТоваров КАК ДД
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И (ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|		ИЛИ ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		|		И ДД.ХозяйственнаяОперация В (
		|			ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеТоваровПоТребованию),
		|			ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РеализацияКлиенту)))
		|	И ДД.Количество <> 0
		|	И (ДД.Регистратор ССЫЛКА Документ.ВыпускПродукции
		|		ИЛИ ДД.Регистратор ССЫЛКА Документ.ПоступлениеОтПереработчика
		//++ НЕ УТКА
		|		ИЛИ ДД.Регистратор ССЫЛКА Документ.ОтчетДавальцу
		//-- НЕ УТКА
		|		ИЛИ (ДД.Регистратор ССЫЛКА Документ.ВозвратМатериаловИзПроизводства И НЕ &ПартионныйУчетВключен))
		|";
КонецФункции
	
Функция ТекстВозвратИзПроизводстваСебестоимость()
	Возврат "
		|ВЫБРАТЬ
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) КАК ВидДвижения,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ВЫБОР
		|		КОГДА &СебестоимостьПоНазначениям
		|			ТОГДА ДД.КорАналитикаУчетаНоменклатуры
		|		ИНАЧЕ КорАналитикаПроизводстваБезНазначения.КлючАналитики
		|	КОНЕЦ КАК АналитикаУчетаНоменклатуры,
		|	ВЫБОР
		|		КОГДА НЕ ДД.КорВидЗапасов = ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка)
		|			И ДД.КорВидЗапасов.ТипЗапасов = ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.МатериалДавальца)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.МатериалыПринятыеВПереработку)
		|		КОГДА НЕ ДД.КорВидЗапасов = ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка)
		|			И ДД.КорВидЗапасов.ТипЗапасов = ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.ПолуфабрикатДавальца)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПринятыеНаОтветхранение)
		|		КОГДА ДД.ВидЗапасов.ТипЗапасов = ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.МатериалДавальца)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.МатериалыПринятыеВПереработку)
		|		КОГДА ДД.ВидЗапасов.ТипЗапасов = ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.ПолуфабрикатДавальца)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПринятыеНаОтветхранение)
		|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты)
		|	КОНЕЦ КАК РазделУчета,
		|	(ВЫБОР
		|		КОГДА ДД.КорВидЗапасов = ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка) ТОГДА ДД.ВидЗапасов
		|		ИНАЧЕ ДД.КорВидЗапасов КОНЕЦ) КАК ВидЗапасов, 
		|	ДД.Организация,
		|	СУММА(-ДД.Количество) КАК Количество,
		|	0 КАК Стоимость,
		|	0 КАК СтоимостьБезНДС,
		|	0 КАК ДопРасходы,
		|	0 КАК ДопРасходыБезНДС,
		|	0 КАК СтоимостьРегл,
		|	0 КАК ПостояннаяРазница,
		|	0 КАК ВременнаяРазница,
		|	ДД.ХозяйственнаяОперация,
		|	ВЫБОР
		|		КОГДА &СебестоимостьПоНазначениям
		|			ТОГДА ДД.АналитикаУчетаНоменклатуры
		|		ИНАЧЕ АналитикаПроизводстваБезНазначения.КлючАналитики
		|	КОНЕЦ КАК КорАналитикаУчетаНоменклатуры,
		|	ВЫБОР
		|		КОГДА ДД.ВидЗапасов.ТипЗапасов = ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.МатериалДавальца)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.МатериалыПринятыеВПереработку)
		|		КОГДА ДД.ВидЗапасов.ТипЗапасов = ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.ПолуфабрикатДавальца)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПринятыеНаОтветхранение)
		|		КОГДА ДД.АналитикаУчетаНоменклатуры.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Склад)
		|		 И ДД.АналитикаУчетаНоменклатуры.СкладскаяТерритория.ЦеховаяКладовая
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты) 
		|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыНаСкладах)
		|	КОНЕЦ КАК КорРазделУчета,
		|	ДД.ВидЗапасов КАК КорВидЗапасов, 
		|	НЕОПРЕДЕЛЕНО КАК КорОрганизация,
		|	0 КАК КорСтоимость,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаПоПартнерам,
		|	НЕОПРЕДЕЛЕНО КАК ЗаказКлиента,
		|	КорАналитикаПроизводства.МестоХранения КАК Подразделение,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяРасходовСписания,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяДоходов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаДоходов,
		|	НЕОПРЕДЕЛЕНО КАК ПериодПродажи,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяАктивовПассивов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивовПассивов,
		|	НЕОПРЕДЕЛЕНО КАК ДокументДвижения,
		|	"""" КАК ИдентификаторСтроки,
		|	НЕОПРЕДЕЛЕНО КАК КорНаправлениеДеятельности,
		|	ДД.КорВидЗапасов.ГруппаПродукции КАК ГруппаПродукции
		|ИЗ
		|	РегистрНакопления.ПартииТоваровОрганизаций КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК АналитикаПроизводства
		|		ПО АналитикаПроизводства.Ссылка = ДД.АналитикаУчетаНоменклатуры
		|	ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаНоменклатуры КАК АналитикаПроизводстваБезНазначения
		|		ПО АналитикаПроизводстваБезНазначения.Номенклатура = АналитикаПроизводства.Номенклатура
		|		И АналитикаПроизводстваБезНазначения.Характеристика = АналитикаПроизводства.Характеристика
		|		И АналитикаПроизводстваБезНазначения.Серия = АналитикаПроизводства.Серия
		|		И АналитикаПроизводстваБезНазначения.МестоХранения = АналитикаПроизводства.МестоХранения
		|		И АналитикаПроизводстваБезНазначения.Назначение = ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка)
		|		И АналитикаПроизводстваБезНазначения.СтатьяКалькуляции = АналитикаПроизводства.СтатьяКалькуляции
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК КорАналитикаПроизводства
		|		ПО КорАналитикаПроизводства.Ссылка = ДД.КорАналитикаУчетаНоменклатуры
		|	ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаНоменклатуры КАК КорАналитикаПроизводстваБезНазначения
		|		ПО КорАналитикаПроизводстваБезНазначения.Номенклатура = КорАналитикаПроизводства.Номенклатура
		|		И КорАналитикаПроизводстваБезНазначения.Характеристика = КорАналитикаПроизводства.Характеристика
		|		И КорАналитикаПроизводстваБезНазначения.Серия = КорАналитикаПроизводства.Серия
		|		И КорАналитикаПроизводстваБезНазначения.МестоХранения = КорАналитикаПроизводства.МестоХранения
		|		И КорАналитикаПроизводстваБезНазначения.Назначение = ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка)
		|		И КорАналитикаПроизводстваБезНазначения.СтатьяКалькуляции = КорАналитикаПроизводства.СтатьяКалькуляции
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И ДД.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВозвратИзПроизводства)
		|	И ДД.ДокументПоступления <> НЕОПРЕДЕЛЕНО
		|	И &ПартионныйУчетВключен
		|СГРУППИРОВАТЬ ПО
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ВЫБОР
		|		КОГДА &СебестоимостьПоНазначениям
		|			ТОГДА ДД.АналитикаУчетаНоменклатуры
		|		ИНАЧЕ АналитикаПроизводстваБезНазначения.КлючАналитики
		|	КОНЕЦ,
		|	ВЫБОР
		|		КОГДА &СебестоимостьПоНазначениям
		|			ТОГДА ДД.КорАналитикаУчетаНоменклатуры
		|		ИНАЧЕ КорАналитикаПроизводстваБезНазначения.КлючАналитики
		|	КОНЕЦ,
		|	ВЫБОР
		|		КОГДА НЕ ДД.КорВидЗапасов = ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка)
		|			И ДД.КорВидЗапасов.ТипЗапасов = ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.МатериалДавальца)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.МатериалыПринятыеВПереработку)
		|		КОГДА НЕ ДД.КорВидЗапасов = ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка)
		|			И ДД.КорВидЗапасов.ТипЗапасов = ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.ПолуфабрикатДавальца)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПринятыеНаОтветхранение)
		|		КОГДА ДД.ВидЗапасов.ТипЗапасов = ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.МатериалДавальца)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.МатериалыПринятыеВПереработку)
		|		КОГДА ДД.ВидЗапасов.ТипЗапасов = ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.ПолуфабрикатДавальца)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПринятыеНаОтветхранение)
		|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты)
		|	КОНЕЦ,
		|	ВЫБОР
		|		КОГДА ДД.ВидЗапасов.ТипЗапасов = ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.МатериалДавальца)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.МатериалыПринятыеВПереработку)
		|		КОГДА ДД.ВидЗапасов.ТипЗапасов = ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.ПолуфабрикатДавальца)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПринятыеНаОтветхранение)
		|		КОГДА ДД.АналитикаУчетаНоменклатуры.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Склад)
		|		 И ДД.АналитикаУчетаНоменклатуры.СкладскаяТерритория.ЦеховаяКладовая
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты)
		|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыНаСкладах)
		|	КОНЕЦ, // КорРазделУчета
		|	ДД.ВидЗапасов,
		|	(ВЫБОР
		|		КОГДА ДД.КорВидЗапасов = ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка) ТОГДА ДД.ВидЗапасов
		|		ИНАЧЕ ДД.КорВидЗапасов КОНЕЦ),
		|	КорАналитикаПроизводства.МестоХранения,
		|	ДД.ХозяйственнаяОперация,
		|	ДД.КорВидЗапасов.ГруппаПродукции
		|";
КонецФункции

Функция ТекстВозвратИзПроизводстваСебестоимостьБезПУ() // использует Возвраты
	Возврат "
		|ВЫБРАТЬ
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) КАК ВидДвижения,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ВЫБОР
		|		КОГДА &СебестоимостьПоНазначениям
		|			ТОГДА ДД.АналитикаУчетаНоменклатуры
		|		ИНАЧЕ АналитикаПроизводстваБезНазначения.КлючАналитики
		|	КОНЕЦ КАК АналитикаУчетаНоменклатуры,
		|	ВЫБОР
		|		КОГДА ДД.ВидЗапасов.ТипЗапасов = ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.МатериалДавальца)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.МатериалыПринятыеВПереработку)
		|		КОГДА ДД.ВидЗапасов.ТипЗапасов = ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.ПолуфабрикатДавальца)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПринятыеНаОтветхранение)
		|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты)
		|	КОНЕЦ КАК РазделУчета,
		|	ДД.ВидЗапасов КАК ВидЗапасов, 
		|	ДД.Организация,
		|	СУММА(ДД.Количество) КАК Количество,
		|	0 КАК Стоимость,
		|	0 КАК СтоимостьБезНДС,
		|	0 КАК ДопРасходы,
		|	0 КАК ДопРасходыБезНДС,
		|	0 КАК СтоимостьРегл,
		|	0 КАК ПостояннаяРазница,
		|	0 КАК ВременнаяРазница,
		|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВозвратИзПроизводства) КАК ХозяйственнаяОперация,
		|	ВЫБОР
		|		КОГДА &СебестоимостьПоНазначениям
		|			ТОГДА Возвраты.АналитикаУчетаНоменклатуры
		|		ИНАЧЕ КорАналитикаПроизводстваБезНазначения.КлючАналитики
		|	КОНЕЦ КАК КорАналитикаУчетаНоменклатуры,
		|	ВЫБОР
		|		КОГДА Возвраты.ВидЗапасов.ТипЗапасов = ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.МатериалДавальца)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.МатериалыПринятыеВПереработку)
		|		КОГДА Возвраты.ВидЗапасов.ТипЗапасов = ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.ПолуфабрикатДавальца)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПринятыеНаОтветхранение)
		|		КОГДА Возвраты.АналитикаУчетаНоменклатуры.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Склад)
		|		 И Возвраты.АналитикаУчетаНоменклатуры.СкладскаяТерритория.ЦеховаяКладовая
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты)
		|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыНаСкладах)
		|	КОНЕЦ КАК КорРазделУчета,
		|	Возвраты.ВидЗапасов КАК КорВидЗапасов, 
		|	НЕОПРЕДЕЛЕНО КАК КорОрганизация,
		|	0 КАК КорСтоимость,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаПоПартнерам,
		|	НЕОПРЕДЕЛЕНО КАК ЗаказКлиента,
		|	АналитикаПроизводства.МестоХранения КАК Подразделение,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяРасходовСписания,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяДоходов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаДоходов,
		|	НЕОПРЕДЕЛЕНО КАК ПериодПродажи,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяАктивовПассивов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивовПассивов,
		|	НЕОПРЕДЕЛЕНО КАК ДокументДвижения,
		|	"""" КАК ИдентификаторСтроки,
		|	НЕОПРЕДЕЛЕНО КАК КорНаправлениеДеятельности,
		|	ДД.ВидЗапасов.ГруппаПродукции КАК ГруппаПродукции
		|ИЗ
		|	РегистрНакопления.ПартииПроизводственныхЗатрат КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК АналитикаПроизводства
		|		ПО АналитикаПроизводства.Ссылка = ДД.АналитикаУчетаНоменклатуры
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Возвраты КАК Возвраты
		|		ПО Возвраты.Регистратор = ДД.Регистратор
		|		И Возвраты.КорАналитикаУчетаНоменклатуры = ДД.АналитикаУчетаНоменклатуры
		|	ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаНоменклатуры КАК АналитикаПроизводстваБезНазначения
		|		ПО АналитикаПроизводстваБезНазначения.Номенклатура = АналитикаПроизводства.Номенклатура
		|		И АналитикаПроизводстваБезНазначения.Характеристика = АналитикаПроизводства.Характеристика
		|		И АналитикаПроизводстваБезНазначения.Серия = АналитикаПроизводства.Серия
		|		И АналитикаПроизводстваБезНазначения.МестоХранения = АналитикаПроизводства.МестоХранения
		|		И АналитикаПроизводстваБезНазначения.Назначение = ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка)
		|		И АналитикаПроизводстваБезНазначения.СтатьяКалькуляции = АналитикаПроизводства.СтатьяКалькуляции
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК КорАналитикаПроизводства
		|		ПО КорАналитикаПроизводства.Ссылка = Возвраты.АналитикаУчетаНоменклатуры
		|	ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаНоменклатуры КАК КорАналитикаПроизводстваБезНазначения
		|		ПО КорАналитикаПроизводстваБезНазначения.Номенклатура = КорАналитикаПроизводства.Номенклатура
		|		И КорАналитикаПроизводстваБезНазначения.Характеристика = КорАналитикаПроизводства.Характеристика
		|		И КорАналитикаПроизводстваБезНазначения.Серия = КорАналитикаПроизводства.Серия
		|		И КорАналитикаПроизводстваБезНазначения.МестоХранения = КорАналитикаПроизводства.МестоХранения
		|		И КорАналитикаПроизводстваБезНазначения.Назначение = ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка)
		|		И КорАналитикаПроизводстваБезНазначения.СтатьяКалькуляции = КорАналитикаПроизводства.СтатьяКалькуляции
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И ДД.Регистратор ССЫЛКА Документ.ВозвратМатериаловИзПроизводства
		|	И НЕ &ПартионныйУчетВключен
		|СГРУППИРОВАТЬ ПО
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ВЫБОР
		|		КОГДА &СебестоимостьПоНазначениям
		|			ТОГДА ДД.АналитикаУчетаНоменклатуры
		|		ИНАЧЕ АналитикаПроизводстваБезНазначения.КлючАналитики
		|	КОНЕЦ,
		|	ВЫБОР
		|		КОГДА &СебестоимостьПоНазначениям
		|			ТОГДА Возвраты.АналитикаУчетаНоменклатуры
		|		ИНАЧЕ КорАналитикаПроизводстваБезНазначения.КлючАналитики
		|	КОНЕЦ,
		|	ВЫБОР
		|		КОГДА ДД.ВидЗапасов.ТипЗапасов = ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.МатериалДавальца)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.МатериалыПринятыеВПереработку)
		|		КОГДА ДД.ВидЗапасов.ТипЗапасов = ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.ПолуфабрикатДавальца)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПринятыеНаОтветхранение)
		|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты)
		|	КОНЕЦ,
		|	ВЫБОР
		|		КОГДА Возвраты.ВидЗапасов.ТипЗапасов = ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.МатериалДавальца)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.МатериалыПринятыеВПереработку)
		|		КОГДА Возвраты.ВидЗапасов.ТипЗапасов = ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.ПолуфабрикатДавальца)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПринятыеНаОтветхранение)
		|		КОГДА Возвраты.АналитикаУчетаНоменклатуры.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Склад)
		|		 И Возвраты.АналитикаУчетаНоменклатуры.СкладскаяТерритория.ЦеховаяКладовая
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты)
		|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыНаСкладах)
		|	КОНЕЦ, // КорРазделУчета
		|	ДД.ВидЗапасов,
		|	Возвраты.ВидЗапасов,
		|	АналитикаПроизводства.МестоХранения,
		|	ДД.ВидЗапасов.ГруппаПродукции
		|";
КонецФункции

Функция ТекстВозвратИзПроизводстваНаСкладСебестоимость()
	Возврат "
		|ВЫБРАТЬ
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ВЫБОР
		|		КОГДА &СебестоимостьПоНазначениям
		|			ТОГДА ДД.АналитикаУчетаНоменклатуры
		|		ИНАЧЕ АналитикаПроизводстваБезНазначения.КлючАналитики
		|	КОНЕЦ КАК АналитикаУчетаНоменклатуры,
		|	ВЫБОР
		|		КОГДА ДД.ВидЗапасов.ТипЗапасов = ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.МатериалДавальца)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.МатериалыПринятыеВПереработку)
		|		КОГДА ДД.ВидЗапасов.ТипЗапасов = ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.ПолуфабрикатДавальца)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПринятыеНаОтветхранение)
		|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыНаСкладах)
		|	КОНЕЦ КАК РазделУчета,
		|	ДД.ВидЗапасов КАК ВидЗапасов, 
		|	ДД.Организация,
		|	СУММА(-ДД.Количество) КАК Количество,
		|	0 КАК Стоимость,
		|	0 КАК СтоимостьБезНДС,
		|	0 КАК ДопРасходы,
		|	0 КАК ДопРасходыБезНДС,
		|	0 КАК СтоимостьРегл,
		|	0 КАК ПостояннаяРазница,
		|	0 КАК ВременнаяРазница,
		|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВозвратИзПроизводства) КАК ХозяйственнаяОперация,
		|	ВЫБОР
		|		КОГДА &СебестоимостьПоНазначениям
		|			ТОГДА ДД.КорАналитикаУчетаНоменклатуры
		|		ИНАЧЕ КорАналитикаПроизводстваБезНазначения.КлючАналитики
		|	КОНЕЦ КАК КорАналитикаУчетаНоменклатуры,
		|	ВЫБОР
		|		КОГДА ДД.КорВидЗапасов.ТипЗапасов = ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.МатериалДавальца)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.МатериалыПринятыеВПереработку)
		|		КОГДА ДД.КорВидЗапасов.ТипЗапасов = ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.ПолуфабрикатДавальца)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПринятыеНаОтветхранение)
		|		КОГДА ДД.АналитикаУчетаНоменклатуры.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Склад)
		|		 И ДД.АналитикаУчетаНоменклатуры.СкладскаяТерритория.ЦеховаяКладовая
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты)
		|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты)
		|	КОНЕЦ КАК КорРазделУчета,
		|	ДД.КорВидЗапасов КАК КорВидЗапасов, 
		|	НЕОПРЕДЕЛЕНО КАК КорОрганизация,
		|	0 КАК КорСтоимость,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаПоПартнерам,
		|	НЕОПРЕДЕЛЕНО КАК ЗаказКлиента,
		|	КорАналитикаПроизводства.МестоХранения КАК Подразделение,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяРасходовСписания,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяДоходов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаДоходов,
		|	НЕОПРЕДЕЛЕНО КАК ПериодПродажи,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяАктивовПассивов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивовПассивов,
		|	НЕОПРЕДЕЛЕНО КАК ДокументДвижения,
		|	"""" КАК ИдентификаторСтроки,
		|	НЕОПРЕДЕЛЕНО КАК КорНаправлениеДеятельности,
		|	ДД.КорВидЗапасов.ГруппаПродукции КАК ГруппаПродукции
		|ИЗ
		|	РегистрНакопления.ПартииТоваровОрганизаций КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК АналитикаПроизводства
		|		ПО АналитикаПроизводства.Ссылка = ДД.АналитикаУчетаНоменклатуры
		|	ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаНоменклатуры КАК АналитикаПроизводстваБезНазначения
		|		ПО АналитикаПроизводстваБезНазначения.Номенклатура = АналитикаПроизводства.Номенклатура
		|		И АналитикаПроизводстваБезНазначения.Характеристика = АналитикаПроизводства.Характеристика
		|		И АналитикаПроизводстваБезНазначения.Серия = АналитикаПроизводства.Серия
		|		И АналитикаПроизводстваБезНазначения.МестоХранения = АналитикаПроизводства.МестоХранения
		|		И АналитикаПроизводстваБезНазначения.Назначение = ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка)
		|		И АналитикаПроизводстваБезНазначения.СтатьяКалькуляции = АналитикаПроизводства.СтатьяКалькуляции
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК КорАналитикаПроизводства
		|		ПО КорАналитикаПроизводства.Ссылка = ДД.КорАналитикаУчетаНоменклатуры
		|	ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаНоменклатуры КАК КорАналитикаПроизводстваБезНазначения
		|		ПО КорАналитикаПроизводстваБезНазначения.Номенклатура = КорАналитикаПроизводства.Номенклатура
		|		И КорАналитикаПроизводстваБезНазначения.Характеристика = КорАналитикаПроизводства.Характеристика
		|		И КорАналитикаПроизводстваБезНазначения.Серия = КорАналитикаПроизводства.Серия
		|		И КорАналитикаПроизводстваБезНазначения.МестоХранения = КорАналитикаПроизводства.МестоХранения
		|		И КорАналитикаПроизводстваБезНазначения.Назначение = ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка)
		|		И КорАналитикаПроизводстваБезНазначения.СтатьяКалькуляции = КорАналитикаПроизводства.СтатьяКалькуляции
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И ДД.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВозвратИзПроизводства)
		|	И &ПартионныйУчетВключен
		|СГРУППИРОВАТЬ ПО
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ВЫБОР
		|		КОГДА &СебестоимостьПоНазначениям
		|			ТОГДА ДД.АналитикаУчетаНоменклатуры
		|		ИНАЧЕ АналитикаПроизводстваБезНазначения.КлючАналитики
		|	КОНЕЦ,
		|	ВЫБОР
		|		КОГДА ДД.ВидЗапасов.ТипЗапасов = ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.МатериалДавальца)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.МатериалыПринятыеВПереработку)
		|		КОГДА ДД.ВидЗапасов.ТипЗапасов = ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.ПолуфабрикатДавальца)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПринятыеНаОтветхранение)
		|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыНаСкладах)
		|	КОНЕЦ,
		|	ВЫБОР
		|		КОГДА ДД.КорВидЗапасов.ТипЗапасов = ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.МатериалДавальца)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.МатериалыПринятыеВПереработку)
		|		КОГДА ДД.КорВидЗапасов.ТипЗапасов = ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.ПолуфабрикатДавальца)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПринятыеНаОтветхранение)
		|		КОГДА ДД.АналитикаУчетаНоменклатуры.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Склад)
		|		 И ДД.АналитикаУчетаНоменклатуры.СкладскаяТерритория.ЦеховаяКладовая
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты)
		|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты)
		|	КОНЕЦ, // КорРазделУчета
		|	ВЫБОР
		|		КОГДА &СебестоимостьПоНазначениям
		|			ТОГДА ДД.КорАналитикаУчетаНоменклатуры
		|		ИНАЧЕ КорАналитикаПроизводстваБезНазначения.КлючАналитики
		|	КОНЕЦ,
		|	ДД.ВидЗапасов, 
		|	ДД.КорВидЗапасов,
		|	КорАналитикаПроизводства.МестоХранения,
		|	ДД.КорВидЗапасов.ГруппаПродукции
		|";
КонецФункции

Функция ТекстСписаниеИзПроизводстваСебестоимость()
	Возврат "
		|ВЫБРАТЬ
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) КАК ВидДвижения,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ВЫБОР
		|		КОГДА &СебестоимостьПоНазначениям
		|			ТОГДА ДД.АналитикаУчетаНоменклатуры
		|		ИНАЧЕ АналитикаБезНазначения.КлючАналитики
		|	КОНЕЦ КАК АналитикаУчетаНоменклатуры,
		|	(ВЫБОР
		|		КОГДА ДД.ВидЗапасов.ТипЗапасов = ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.МатериалДавальца)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.МатериалыПринятыеВПереработку)
		|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты) КОНЕЦ) КАК РазделУчета,
		|	ДД.ВидЗапасов КАК ВидЗапасов, 
		|	ДД.Организация,
		|	СУММА(ДД.Количество) КАК Количество,
		|	0 КАК Стоимость,
		|	0 КАК СтоимостьБезНДС,
		|	0 КАК ДопРасходы,
		|	0 КАК ДопРасходыБезНДС,
		|	0 КАК СтоимостьРегл,
		|	0 КАК ПостояннаяРазница,
		|	0 КАК ВременнаяРазница,
		|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеТоваровПоТребованию) КАК ХозяйственнаяОперация,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаУчетаНоменклатуры,
		|	НЕОПРЕДЕЛЕНО КАК КорРазделУчета,
		|	НЕОПРЕДЕЛЕНО КАК КорВидЗапасов, 
		|	НЕОПРЕДЕЛЕНО КАК КорОрганизация,
		|	0 КАК КорСтоимость,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаПоПартнерам,
		|	НЕОПРЕДЕЛЕНО КАК ЗаказКлиента,
		|	ДД.ПодразделениеРасходов КАК Подразделение,
		|	ДД.АналитикаРасходов,
		|	ДД.СтатьяРасходовСписания,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяДоходов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаДоходов,
		|	НЕОПРЕДЕЛЕНО КАК ПериодПродажи,
		|	ДД.СтатьяРасходовСписания КАК СтатьяАктивовПассивов,
		|	ДД.АналитикаАктивовПассивов,
		|	НЕОПРЕДЕЛЕНО КАК ДокументДвижения,
		|	ДД.ИдентификаторСтроки,
		|	ЕСТЬNULL(ДД.АналитикаУчетаНоменклатуры.Назначение.НаправлениеДеятельности, НЕОПРЕДЕЛЕНО) КАК КорНаправлениеДеятельности,
		|	ДД.ВидЗапасов.ГруппаПродукции КАК ГруппаПродукции
		|ИЗ
		|	РегистрНакопления.ПартииПроизводственныхЗатрат КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК Аналитика
		|		ПО Аналитика.Ссылка = ДД.АналитикаУчетаНоменклатуры
		|	ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаНоменклатуры КАК АналитикаБезНазначения
		|		ПО АналитикаБезНазначения.Номенклатура = Аналитика.Номенклатура
		|		И АналитикаБезНазначения.Характеристика = Аналитика.Характеристика
		|		И АналитикаБезНазначения.Серия = Аналитика.Серия
		|		И АналитикаБезНазначения.МестоХранения = Аналитика.МестоХранения
		|		И АналитикаБезНазначения.Назначение = ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка)
		|		И АналитикаБезНазначения.СтатьяКалькуляции = Аналитика.СтатьяКалькуляции
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И ДД.СтатьяРасходовСписания <> ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка)
		|	И ДД.СтатьяРасходовСписания <> НЕОПРЕДЕЛЕНО
		|	И ЕСТЬNULL(ДД.ВидЗапасов.ТипЗапасов, ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.ПустаяСсылка))
		|		<> ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.ПолуфабрикатДавальца)
		|	И НЕ ДД.Регистратор ССЫЛКА Документ.ВыпускПродукции
		|	И НЕ ДД.Регистратор ССЫЛКА Документ.ПередачаТоваровМеждуОрганизациями
		|СГРУППИРОВАТЬ ПО
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ВЫБОР
		|		КОГДА &СебестоимостьПоНазначениям
		|			ТОГДА ДД.АналитикаУчетаНоменклатуры
		|		ИНАЧЕ АналитикаБезНазначения.КлючАналитики
		|	КОНЕЦ,
		|	(ВЫБОР
		|		КОГДА ДД.ВидЗапасов.ТипЗапасов = ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.МатериалДавальца)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.МатериалыПринятыеВПереработку)
		|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты) КОНЕЦ),
		|	ДД.ВидЗапасов,
		|	ДД.ПодразделениеРасходов,
		|	ДД.АналитикаРасходов,
		|	ДД.СтатьяРасходовСписания,
		|	ДД.АналитикаАктивовПассивов,
		|	ДД.ИдентификаторСтроки,
		|	ЕСТЬNULL(ДД.АналитикаУчетаНоменклатуры.Назначение.НаправлениеДеятельности, НЕОПРЕДЕЛЕНО),
		|	ДД.ВидЗапасов.ГруппаПродукции
		|";
КонецФункции

Функция ТекстПеремещенияВПроизводствеСебестоимость()
	Возврат "
		|ВЫБРАТЬ
		|	ДД.ВидДвижения,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ВЫБОР
		|		КОГДА &СебестоимостьПоНазначениям
		|			ТОГДА ДД.АналитикаУчетаНоменклатуры
		|		ИНАЧЕ АналитикаБезНазначения.КлючАналитики
		|	КОНЕЦ КАК АналитикаУчетаНоменклатуры,
		|	(ВЫБОР
		|		КОГДА ДД.ВидЗапасов.ТипЗапасов = ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.МатериалДавальца)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.МатериалыПринятыеВПереработку)
		|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты) КОНЕЦ) КАК РазделУчета,
		|	ДД.ВидЗапасов КАК ВидЗапасов,
		|	ДД.Организация,
		|	СУММА(ДД.Количество) КАК Количество,
		|	0 КАК Стоимость,
		|	0 КАК СтоимостьБезНДС,
		|	0 КАК ДопРасходы,
		|	0 КАК ДопРасходыБезНДС,
		|	0 КАК СтоимостьРегл,
		|	0 КАК ПостояннаяРазница,
		|	0 КАК ВременнаяРазница,
		|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПеремещениеТоваров) КАК ХозяйственнаяОперация,
		|	ВЫБОР
		|		КОГДА &СебестоимостьПоНазначениям
		|			ТОГДА ДД.КорАналитикаУчетаНоменклатуры
		|		ИНАЧЕ КорАналитикаБезНазначения.КлючАналитики
		|	КОНЕЦ КАК КорАналитикаУчетаНоменклатуры,
		|	(ВЫБОР
		|		КОГДА ДД.ВидЗапасов.ТипЗапасов = ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.МатериалДавальца)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.МатериалыПринятыеВПереработку)
		|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты) КОНЕЦ) КАК КорРазделУчета,
		|	ДД.ВидЗапасов КАК КорВидЗапасов,
		|	НЕОПРЕДЕЛЕНО КАК КорОрганизация,
		|	0 КАК КорСтоимость,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаПоПартнерам,
		|	НЕОПРЕДЕЛЕНО КАК ЗаказКлиента,
		|	НЕОПРЕДЕЛЕНО КАК Подразделение,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяРасходовСписания,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяДоходов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаДоходов,
		|	НЕОПРЕДЕЛЕНО КАК ПериодПродажи,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяАктивовПассивов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивовПассивов,
		|	НЕОПРЕДЕЛЕНО КАК ДокументДвижения,
		|	"""" КАК ИдентификаторСтроки,
		|	НЕОПРЕДЕЛЕНО КАК КорНаправлениеДеятельности,
		|	ДД.ВидЗапасов.ГруппаПродукции КАК ГруппаПродукции
		|ИЗ
		|	РегистрНакопления.ПартииПроизводственныхЗатрат КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК Аналитика
		|		ПО Аналитика.Ссылка = ДД.АналитикаУчетаНоменклатуры
		|	ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаНоменклатуры КАК АналитикаБезНазначения
		|		ПО АналитикаБезНазначения.Номенклатура = Аналитика.Номенклатура
		|		И АналитикаБезНазначения.Характеристика = Аналитика.Характеристика
		|		И АналитикаБезНазначения.Серия = Аналитика.Серия
		|		И АналитикаБезНазначения.МестоХранения = Аналитика.МестоХранения
		|		И АналитикаБезНазначения.Назначение = ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка)
		|		И АналитикаБезНазначения.СтатьяКалькуляции = Аналитика.СтатьяКалькуляции
		|	ЛЕВОЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК КорАналитика
		|		ПО КорАналитика.Ссылка = ДД.КорАналитикаУчетаНоменклатуры
		|	ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаНоменклатуры КАК КорАналитикаБезНазначения
		|		ПО КорАналитикаБезНазначения.Номенклатура = КорАналитика.Номенклатура
		|		И КорАналитикаБезНазначения.Характеристика = КорАналитика.Характеристика
		|		И КорАналитикаБезНазначения.Серия = КорАналитика.Серия
		|		И КорАналитикаБезНазначения.МестоХранения = КорАналитика.МестоХранения
		|		И КорАналитикаБезНазначения.Назначение = ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка)
		|		И КорАналитикаБезНазначения.СтатьяКалькуляции = КорАналитика.СтатьяКалькуляции
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И ДД.Регистратор ССЫЛКА Документ.ПеремещениеМатериаловВПроизводстве
		|	И ЕСТЬNULL(ДД.ВидЗапасов.ТипЗапасов, ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.ПустаяСсылка))
		|		<> ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.ПолуфабрикатДавальца)
		|СГРУППИРОВАТЬ ПО
		|	ДД.ВидДвижения,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ВЫБОР
		|		КОГДА &СебестоимостьПоНазначениям
		|			ТОГДА ДД.АналитикаУчетаНоменклатуры
		|		ИНАЧЕ АналитикаБезНазначения.КлючАналитики
		|	КОНЕЦ,
		|	(ВЫБОР
		|		КОГДА ДД.ВидЗапасов.ТипЗапасов = ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.МатериалДавальца)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.МатериалыПринятыеВПереработку)
		|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты) КОНЕЦ),
		|	ДД.ВидЗапасов,
		|	ВЫБОР
		|		КОГДА &СебестоимостьПоНазначениям
		|			ТОГДА ДД.КорАналитикаУчетаНоменклатуры
		|		ИНАЧЕ КорАналитикаБезНазначения.КлючАналитики
		|	КОНЕЦ,
		|	ДД.ВидЗапасов.ГруппаПродукции
		|";
КонецФункции

Функция ТекстПартииНезавершенногоПроизводстваСебестоимость() // использует ЕстьВозвратныеОтходы
	Возврат "
		|ВЫБРАТЬ
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) КАК ВидДвижения,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	(ВЫБОР
		|		КОГДА &СебестоимостьПоНазначениям ТОГДА ДД.АналитикаУчетаНоменклатуры
		|		ИНАЧЕ АналитикаБезНазначения.КлючАналитики КОНЕЦ) КАК АналитикаУчетаНоменклатуры,
		|	(ВЫБОР
		|		КОГДА ДД.ВидЗапасов.ТипЗапасов = ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.МатериалДавальца)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.МатериалыПринятыеВПереработку)
		|		КОГДА ДД.ВидЗапасов.ТипЗапасов = ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.ПолуфабрикатДавальца)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПринятыеНаОтветхранение)
		|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты) КОНЕЦ) КАК РазделУчета,
		|	(ВЫБОР 
		|		КОГДА ДД.ВидЗапасов.ТипЗапасов = ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.Услуга)
		|			ТОГДА НЕОПРЕДЕЛЕНО
		|		ИНАЧЕ ДД.ВидЗапасов КОНЕЦ) КАК ВидЗапасов,
		|	ДД.Организация,
		|	СУММА(ДД.Количество) КАК Количество,
		|	0 КАК Стоимость,
		|	0 КАК СтоимостьБезНДС,
		|	0 КАК ДопРасходы,
		|	0 КАК ДопРасходыБезНДС,
		|	0 КАК СтоимостьРегл,
		|	0 КАК ПостояннаяРазница,
		|	0 КАК ВременнаяРазница,
		|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукции) КАК ХозяйственнаяОперация,
		|	(ВЫБОР
		|		КОГДА &СебестоимостьПоНазначениям ТОГДА ДД.АналитикаУчетаПродукции
		|		ИНАЧЕ АналитикаПродукцииБезНазначения.КлючАналитики КОНЕЦ) КАК КорАналитикаУчетаНоменклатуры,
		|	(ВЫБОР
		|		КОГДА ДД.ВидЗапасов.ТипЗапасов = ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.МатериалДавальца)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка)
		|		ИНАЧЕ ДД.КорРазделУчета КОНЕЦ) КАК КорРазделУчета,
		|	(ВЫБОР 
		|		КОГДА ДД.КорВидЗапасов.ТипЗапасов = ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.Услуга)
		|			ТОГДА НЕОПРЕДЕЛЕНО
		|		ИНАЧЕ ДД.КорВидЗапасов КОНЕЦ) КАК КорВидЗапасов,
		|	НЕОПРЕДЕЛЕНО КАК КорОрганизация,
		|	0 КАК КорСтоимость,
		|	АналитикаДавальца.АналитикаУчетаПоПартнерам КАК АналитикаУчетаПоПартнерам,
		|	НЕОПРЕДЕЛЕНО КАК ЗаказКлиента,
		|	(ВЫБОР
		|		КОГДА ДД.Регистратор ССЫЛКА Документ.ПоступлениеОтПереработчика ТОГДА Поступление.Подразделение
		|		ИНАЧЕ Аналитика.МестоХранения КОНЕЦ) КАК Подразделение,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяРасходовСписания,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяДоходов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаДоходов,
		|	НЕОПРЕДЕЛЕНО КАК ПериодПродажи,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяАктивовПассивов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивовПассивов,
		|	НЕОПРЕДЕЛЕНО КАК ДокументДвижения,
		|	(ВЫБОР
		|		КОГДА ДД.Количество < 0 И НЕ ЕстьВозвратныеОтходы.ДокументПоступления ЕСТЬ NULL ТОГДА ""ВО""
		|		ИНАЧЕ """" КОНЕЦ) КАК ИдентификаторСтроки,
		|	НЕОПРЕДЕЛЕНО КАК КорНаправлениеДеятельности,
		|	(ВЫБОР
		|		КОГДА ДД.Регистратор ССЫЛКА Документ.ПоступлениеОтПереработчика
		|			ТОГДА АналитикаПродукции.Номенклатура.ГруппаАналитическогоУчета
		|		ИНАЧЕ ДД.ВидЗапасов.ГруппаПродукции КОНЕЦ) КАК ГруппаПродукции
		|ИЗ
		|	РегистрНакопления.ПартииНезавершенногоПроизводства КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК Аналитика
		|		ПО Аналитика.Ссылка = ДД.АналитикаУчетаНоменклатуры
		|	ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаНоменклатуры КАК АналитикаБезНазначения
		|		ПО АналитикаБезНазначения.Номенклатура = Аналитика.Номенклатура
		|		И АналитикаБезНазначения.Характеристика = Аналитика.Характеристика
		|		И АналитикаБезНазначения.Серия = Аналитика.Серия
		|		И АналитикаБезНазначения.МестоХранения = Аналитика.МестоХранения
		|		И АналитикаБезНазначения.Назначение = ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка)
		|		И АналитикаБезНазначения.СтатьяКалькуляции = ЗНАЧЕНИЕ(Справочник.СтатьиКалькуляции.ПустаяСсылка)
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК АналитикаПродукции
		|		ПО АналитикаПродукции.Ссылка = ДД.АналитикаУчетаПродукции
		|	ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаНоменклатуры КАК АналитикаПродукцииБезНазначения
		|		ПО АналитикаПродукцииБезНазначения.Номенклатура = АналитикаПродукции.Номенклатура
		|		И АналитикаПродукцииБезНазначения.Характеристика = АналитикаПродукции.Характеристика
		|		И АналитикаПродукцииБезНазначения.Серия = АналитикаПродукции.Серия
		|		И АналитикаПродукцииБезНазначения.МестоХранения = АналитикаПродукции.МестоХранения
		|		И АналитикаПродукцииБезНазначения.Назначение = ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка)
		|		И АналитикаПродукцииБезНазначения.СтатьяКалькуляции = ЗНАЧЕНИЕ(Справочник.СтатьиКалькуляции.ПустаяСсылка)
		|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.ПоступлениеОтПереработчика КАК Поступление
		|		ПО Поступление.Ссылка = ДД.Регистратор
		|	ЛЕВОЕ СОЕДИНЕНИЕ АналитикаДавальца КАК АналитикаДавальца
		|		ПО АналитикаДавальца.Регистратор = ДД.Регистратор
		|	ЛЕВОЕ СОЕДИНЕНИЕ ЕстьВозвратныеОтходы КАК ЕстьВозвратныеОтходы
		|		ПО ЕстьВозвратныеОтходы.Организация = ДД.Организация
		|		И ЕстьВозвратныеОтходы.АналитикаУчетаНоменклатуры = ДД.АналитикаУчетаНоменклатуры
		|		И ЕстьВозвратныеОтходы.ВидЗапасов = ДД.ВидЗапасов
		|		И ЕстьВозвратныеОтходы.ДокументПоступления = ДД.ДокументПоступления
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И (ДД.ВидЗапасов <> ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка)
		|		ИЛИ Аналитика.Номенклатура.ТипНоменклатуры = ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.Работа)
		|		ИЛИ ДД.ДокументПоступления ССЫЛКА Документ.ОтчетКомитентуОСписании
		|		ИЛИ ДД.ДокументПоступления ССЫЛКА Документ.ОтчетПоКомиссииМеждуОрганизациямиОСписании)
		|	И (ДД.Регистратор ССЫЛКА Документ.ВыпускПродукции
		//++ НЕ УТКА
		|		ИЛИ ДД.Регистратор ССЫЛКА Документ.ОтчетДавальцу
		//-- НЕ УТКА
		|		ИЛИ ДД.Регистратор ССЫЛКА Документ.ПоступлениеОтПереработчика
		|			И Аналитика.Номенклатура.ТипНоменклатуры <> ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.Работа)
		|	)
		|СГРУППИРОВАТЬ ПО
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	(ВЫБОР
		|		КОГДА &СебестоимостьПоНазначениям ТОГДА ДД.АналитикаУчетаНоменклатуры
		|		ИНАЧЕ АналитикаБезНазначения.КлючАналитики КОНЕЦ),
		|	(ВЫБОР
		|		КОГДА &СебестоимостьПоНазначениям ТОГДА ДД.АналитикаУчетаПродукции
		|		ИНАЧЕ АналитикаПродукцииБезНазначения.КлючАналитики КОНЕЦ),
		|	(ВЫБОР
		|		КОГДА ДД.ВидЗапасов.ТипЗапасов = ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.МатериалДавальца)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.МатериалыПринятыеВПереработку)
		|		КОГДА ДД.ВидЗапасов.ТипЗапасов = ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.ПолуфабрикатДавальца)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПринятыеНаОтветхранение)
		|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты) КОНЕЦ),
		|	(ВЫБОР
		|		КОГДА ДД.ВидЗапасов.ТипЗапасов = ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.МатериалДавальца)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка)
		|		ИНАЧЕ ДД.КорРазделУчета КОНЕЦ),
		|	(ВЫБОР 
		|		КОГДА ДД.ВидЗапасов.ТипЗапасов = ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.Услуга)
		|			ТОГДА НЕОПРЕДЕЛЕНО
		|		ИНАЧЕ ДД.ВидЗапасов КОНЕЦ),
		|	(ВЫБОР 
		|		КОГДА ДД.КорВидЗапасов.ТипЗапасов = ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.Услуга)
		|			ТОГДА НЕОПРЕДЕЛЕНО
		|		ИНАЧЕ ДД.КорВидЗапасов КОНЕЦ),
		|	(ВЫБОР
		|		КОГДА ДД.Регистратор ССЫЛКА Документ.ПоступлениеОтПереработчика ТОГДА Поступление.Подразделение
		|		ИНАЧЕ Аналитика.МестоХранения КОНЕЦ),
		|	АналитикаДавальца.АналитикаУчетаПоПартнерам,
		|	(ВЫБОР
		|		КОГДА ДД.Количество < 0 И НЕ ЕстьВозвратныеОтходы.ДокументПоступления ЕСТЬ NULL ТОГДА ""ВО""
		|		ИНАЧЕ """" КОНЕЦ),
		|	(ВЫБОР
		|		КОГДА ДД.Регистратор ССЫЛКА Документ.ПоступлениеОтПереработчика
		|			ТОГДА АналитикаПродукции.Номенклатура.ГруппаАналитическогоУчета
		|		ИНАЧЕ ДД.ВидЗапасов.ГруппаПродукции КОНЕЦ)
		|";
КонецФункции

Функция ТекстПартииНезавершенногоПроизводстваУслугиПереработчика()
	Возврат "
		|ВЫБРАТЬ
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) КАК ВидДвижения,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты) КАК РазделУчета,
		|	ДД.ВидЗапасов КАК ВидЗапасов, 
		|	ДД.Организация,
		|	СУММА(ДД.Количество) КАК Количество,
		|	СУММА(ДД.Стоимость) КАК Стоимость,
		|	СУММА(ДД.СтоимостьБезНДС) КАК СтоимостьБезНДС,
		|	0. КАК ДопРасходы,
		|	0. КАК ДопРасходыБезНДС,
		|	СУММА(ДД.СтоимостьРегл) КАК СтоимостьРегл,
		|	СУММА(ДД.ПостояннаяРазница) КАК ПостояннаяРазница,
		|	СУММА(ДД.ВременнаяРазница) КАК ВременнаяРазница,
		|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукции) КАК ХозяйственнаяОперация,
		|	ДД.АналитикаУчетаПродукции КАК КорАналитикаУчетаНоменклатуры,
		|	ДД.КорРазделУчета КАК КорРазделУчета,
		|	ДД.КорВидЗапасов КАК КорВидЗапасов, 
		|	НЕОПРЕДЕЛЕНО КАК КорОрганизация,
		|	0. КАК КорСтоимость,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаПоПартнерам,
		|	НЕОПРЕДЕЛЕНО КАК ЗаказКлиента,
		|	Поступление.Подразделение КАК Подразделение,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяРасходовСписания,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяДоходов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаДоходов,
		|	НЕОПРЕДЕЛЕНО КАК ПериодПродажи,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяАктивовПассивов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивовПассивов,
		|	ДД.Регистратор КАК ДокументДвижения,
		|	"""" КАК ИдентификаторСтроки,
		|	НЕОПРЕДЕЛЕНО КАК КорНаправлениеДеятельности,
		|	ДД.Продукция.ГруппаАналитическогоУчета КАК ГруппаПродукции
		|ИЗ
		|	РегистрНакопления.ПартииНезавершенногоПроизводства КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК Аналитика
		|		ПО Аналитика.Ссылка = ДД.АналитикаУчетаНоменклатуры
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ПоступлениеОтПереработчика КАК Поступление
		|		ПО Поступление.Ссылка = ДД.Регистратор
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И Аналитика.Номенклатура.ТипНоменклатуры В (
		|		ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.Работа),
		|		ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.Услуга))
		|	И ДД.Регистратор ССЫЛКА Документ.ПоступлениеОтПереработчика
		|СГРУППИРОВАТЬ ПО
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.АналитикаУчетаПродукции,
		|	ДД.АналитикаУчетаНоменклатуры,
		|	ДД.ВидЗапасов,
		|	ДД.КорРазделУчета,
		|	ДД.КорВидЗапасов,
		|	Поступление.Подразделение,
		|	ДД.Продукция.ГруппаАналитическогоУчета
		|";
КонецФункции

Функция ТекстПартииНезавершенногоПроизводстваУслугиПереработчикаВыпуск()
	Возврат "
		|ВЫБРАТЬ
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	(ВЫБОР
		|		КОГДА &СебестоимостьПоНазначениям ТОГДА ДД.АналитикаУчетаПродукции
		|		ИНАЧЕ АналитикаПродукцииБезНазначения.КлючАналитики КОНЕЦ) КАК АналитикаУчетаНоменклатуры,
		|	ДД.КорРазделУчета КАК РазделУчета,
		|	ДД.КорВидЗапасов КАК ВидЗапасов, 
		|	ДД.Организация,
		|	0 КАК Количество,
		|	СУММА(ДД.Стоимость) КАК Стоимость,
		|	СУММА(ДД.СтоимостьБезНДС) КАК СтоимостьБезНДС,
		|	0 КАК ДопРасходы,
		|	0 КАК ДопРасходыБезНДС,
		|	СУММА(ДД.СтоимостьРегл) КАК СтоимостьРегл,
		|	СУММА(ДД.ПостояннаяРазница) КАК ПостояннаяРазница,
		|	СУММА(ДД.ВременнаяРазница) КАК ВременнаяРазница,
		|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукции) КАК ХозяйственнаяОперация,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаУчетаНоменклатуры,
		|	НЕОПРЕДЕЛЕНО КАК КорРазделУчета,
		|	НЕОПРЕДЕЛЕНО КАК КорВидЗапасов, 
		|	НЕОПРЕДЕЛЕНО КАК КорОрганизация,
		|	0. КАК КорСтоимость,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаПоПартнерам,
		|	НЕОПРЕДЕЛЕНО КАК ЗаказКлиента,
		|	Поступление.Подразделение КАК Подразделение,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяРасходовСписания,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяДоходов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаДоходов,
		|	НЕОПРЕДЕЛЕНО КАК ПериодПродажи,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяАктивовПассивов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивовПассивов,
		|	ДД.Регистратор КАК ДокументДвижения,
		|	"""" КАК ИдентификаторСтроки,
		|	НЕОПРЕДЕЛЕНО КАК КорНаправлениеДеятельности,
		|	АналитикаПродукции.Номенклатура.ГруппаАналитическогоУчета КАК ГруппаПродукции
		|ИЗ
		|	РегистрНакопления.ПартииНезавершенногоПроизводства КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК Аналитика
		|		ПО Аналитика.Ссылка = ДД.АналитикаУчетаНоменклатуры
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ПоступлениеОтПереработчика КАК Поступление
		|		ПО Поступление.Ссылка = ДД.Регистратор
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК АналитикаПродукции
		|		ПО АналитикаПродукции.Ссылка = ДД.АналитикаУчетаПродукции
		|	ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаНоменклатуры КАК АналитикаПродукцииБезНазначения
		|		ПО АналитикаПродукцииБезНазначения.Номенклатура = АналитикаПродукции.Номенклатура
		|		И АналитикаПродукцииБезНазначения.Характеристика = АналитикаПродукции.Характеристика
		|		И АналитикаПродукцииБезНазначения.Серия = АналитикаПродукции.Серия
		|		И АналитикаПродукцииБезНазначения.МестоХранения = АналитикаПродукции.МестоХранения
		|		И АналитикаПродукцииБезНазначения.Назначение = ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка)
		|		И АналитикаПродукцииБезНазначения.СтатьяКалькуляции = ЗНАЧЕНИЕ(Справочник.СтатьиКалькуляции.ПустаяСсылка)
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И Аналитика.Номенклатура.ТипНоменклатуры В (
		|		ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.Работа),
		|		ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.Услуга))
		|	И ДД.Регистратор ССЫЛКА Документ.ПоступлениеОтПереработчика
		|СГРУППИРОВАТЬ ПО
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	(ВЫБОР
		|		КОГДА &СебестоимостьПоНазначениям ТОГДА ДД.АналитикаУчетаПродукции
		|		ИНАЧЕ АналитикаПродукцииБезНазначения.КлючАналитики КОНЕЦ),
		|	ДД.КорРазделУчета,
		|	ДД.КорВидЗапасов,
		|	Поступление.Подразделение,
		|	АналитикаПродукции.Номенклатура.ГруппаАналитическогоУчета
		|";
КонецФункции

Функция ТекстТрудозатратыНЗПСебестоимость()
	Возврат "
		|ВЫБРАТЬ
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	(ВЫБОР
		|		КОГДА &СебестоимостьПоНазначениям ТОГДА ДД.КорАналитикаУчетаПродукции
		|		ИНАЧЕ АналитикаПродукцииБезНазначения.КлючАналитики КОНЕЦ) КАК АналитикаУчетаНоменклатуры,
		|	ДД.КорРазделУчета КАК РазделУчета,
		|	(ВЫБОР
		|		КОГДА ДД.КорВидЗапасовПродукции.ТипЗапасов = ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.Услуга)
		|			ТОГДА НЕОПРЕДЕЛЕНО
		|		ИНАЧЕ ДД.КорВидЗапасовПродукции КОНЕЦ) КАК ВидЗапасов,
		|	ДД.Организация,
		|	0 КАК Количество,
		|	СУММА(ДД.Стоимость) КАК Стоимость,
		|	СУММА(ДД.Стоимость) КАК СтоимостьБезНДС,
		|	0 КАК ДопРасходы,
		|	0 КАК ДопРасходыБезНДС,
		|	СУММА(ДД.СтоимостьРегл) КАК СтоимостьРегл,
		|	0 КАК ПостояннаяРазница,
		|	0 КАК ВременнаяРазница,
		|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукции) КАК ХозяйственнаяОперация,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаУчетаНоменклатуры,
		|	НЕОПРЕДЕЛЕНО КАК КорРазделУчета,
		|	НЕОПРЕДЕЛЕНО КАК КорВидЗапасов,
		|	НЕОПРЕДЕЛЕНО КАК КорОрганизация,
		|	0 КАК КорСтоимость,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаПоПартнерам,
		|	НЕОПРЕДЕЛЕНО КАК ЗаказКлиента,
		|	ДД.Подразделение КАК Подразделение,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяРасходовСписания,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяДоходов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаДоходов,
		|	НЕОПРЕДЕЛЕНО КАК ПериодПродажи,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяАктивовПассивов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивовПассивов,
		|	ДД.Регистратор КАК ДокументДвижения,
		|	"""" КАК ИдентификаторСтроки,
		|	НЕОПРЕДЕЛЕНО КАК КорНаправлениеДеятельности,
		|	ДД.ГруппаПродукции
		|ИЗ
		|	РегистрНакопления.ТрудозатратыНезавершенногоПроизводства КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК Аналитика
		|		ПО Аналитика.Ссылка = ДД.КорАналитикаУчетаПродукции
		|	ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаНоменклатуры КАК АналитикаПродукцииБезНазначения
		|		ПО АналитикаПродукцииБезНазначения.Номенклатура = Аналитика.Номенклатура
		|		И АналитикаПродукцииБезНазначения.Характеристика = Аналитика.Характеристика
		|		И АналитикаПродукцииБезНазначения.Серия = Аналитика.Серия
		|		И АналитикаПродукцииБезНазначения.МестоХранения = Аналитика.МестоХранения
		|		И АналитикаПродукцииБезНазначения.Назначение = ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка)
		|		И АналитикаПродукцииБезНазначения.СтатьяКалькуляции = ЗНАЧЕНИЕ(Справочник.СтатьиКалькуляции.ПустаяСсылка)
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И (ДД.Регистратор ССЫЛКА Документ.ВыпускПродукции
		//++ НЕ УТКА
		|		ИЛИ ДД.Регистратор ССЫЛКА Документ.ОтчетДавальцу
		//-- НЕ УТКА
		|		)
		|СГРУППИРОВАТЬ ПО
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	(ВЫБОР
		|		КОГДА &СебестоимостьПоНазначениям ТОГДА ДД.КорАналитикаУчетаПродукции
		|		ИНАЧЕ АналитикаПродукцииБезНазначения.КлючАналитики КОНЕЦ),
		|	ДД.КорРазделУчета,
		|	(ВЫБОР
		|		КОГДА ДД.КорВидЗапасовПродукции.ТипЗапасов = ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.Услуга)
		|			ТОГДА НЕОПРЕДЕЛЕНО
		|		ИНАЧЕ ДД.КорВидЗапасовПродукции КОНЕЦ),
		|	ДД.Подразделение,
		|	ДД.ГруппаПродукции
		|";
КонецФункции

Функция ТекстПрочиеРасходыНЗПСебестоимость()
	Возврат "
		|ВЫБРАТЬ
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	(ВЫБОР
		|		КОГДА &СебестоимостьПоНазначениям ТОГДА ДД.АналитикаУчетаПродукции
		|		ИНАЧЕ АналитикаПродукцииБезНазначения.КлючАналитики КОНЕЦ) КАК АналитикаУчетаНоменклатуры,
		|	ДД.РазделУчета КАК РазделУчета,
		|	(ВЫБОР
		|		КОГДА ДД.ВидЗапасов.ТипЗапасов = ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.Услуга)
		|			ТОГДА НЕОПРЕДЕЛЕНО
		|		ИНАЧЕ ДД.ВидЗапасов КОНЕЦ) КАК ВидЗапасов,
		|	ДД.Организация,
		|	0 КАК Количество,
		|	СУММА(ДД.Стоимость) КАК Стоимость,
		|	СУММА(ДД.СтоимостьБезНДС) КАК СтоимостьБезНДС,
		|	0 КАК ДопРасходы,
		|	0 КАК ДопРасходыБезНДС,
		|	СУММА(ДД.СтоимостьРегл) КАК СтоимостьРегл,
		|	СУММА(ДД.ПостояннаяРазница) КАК ПостояннаяРазница,
		|	СУММА(ДД.ВременнаяРазница) КАК ВременнаяРазница,
		|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукции) КАК ХозяйственнаяОперация,
		|	НЕОПРЕДЕЛЕНО КАК КорАналитикаУчетаНоменклатуры,
		|	НЕОПРЕДЕЛЕНО КАК КорРазделУчета,
		|	НЕОПРЕДЕЛЕНО КАК КорВидЗапасов,
		|	НЕОПРЕДЕЛЕНО КАК КорОрганизация,
		|	0 КАК КорСтоимость,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаУчетаПоПартнерам,
		|	НЕОПРЕДЕЛЕНО КАК ЗаказКлиента,
		|	ДД.Подразделение КАК Подразделение,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяРасходовСписания,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяДоходов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаДоходов,
		|	НЕОПРЕДЕЛЕНО КАК ПериодПродажи,
		|	НЕОПРЕДЕЛЕНО КАК СтатьяАктивовПассивов,
		|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивовПассивов,
		|	ДД.Регистратор КАК ДокументДвижения,
		|	"""" КАК ИдентификаторСтроки,
		|	НЕОПРЕДЕЛЕНО КАК КорНаправлениеДеятельности,
		|	ДД.ГруппаПродукции
		|ИЗ
		|	РегистрНакопления.ПрочиеРасходыНезавершенногоПроизводства КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК Аналитика
		|		ПО Аналитика.Ссылка = ДД.АналитикаУчетаПродукции
		|	ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаНоменклатуры КАК АналитикаПродукцииБезНазначения
		|		ПО АналитикаПродукцииБезНазначения.Номенклатура = Аналитика.Номенклатура
		|		И АналитикаПродукцииБезНазначения.Характеристика = Аналитика.Характеристика
		|		И АналитикаПродукцииБезНазначения.Серия = Аналитика.Серия
		|		И АналитикаПродукцииБезНазначения.МестоХранения = Аналитика.МестоХранения
		|		И АналитикаПродукцииБезНазначения.Назначение = ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка)
		|		И АналитикаПродукцииБезНазначения.СтатьяКалькуляции = ЗНАЧЕНИЕ(Справочник.СтатьиКалькуляции.ПустаяСсылка)
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И НЕ ДД.РасчетСебестоимости
		|	И (ДД.Регистратор ССЫЛКА Документ.ВыпускПродукции
		//++ НЕ УТКА
		|		ИЛИ ДД.Регистратор ССЫЛКА Документ.ОтчетДавальцу
		//-- НЕ УТКА
		|		ИЛИ ДД.Регистратор ССЫЛКА Документ.ПоступлениеОтПереработчика)
		|СГРУППИРОВАТЬ ПО
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	(ВЫБОР
		|		КОГДА &СебестоимостьПоНазначениям ТОГДА ДД.АналитикаУчетаПродукции
		|		ИНАЧЕ АналитикаПродукцииБезНазначения.КлючАналитики КОНЕЦ),
		|	ДД.РазделУчета,
		|	(ВЫБОР
		|		КОГДА ДД.ВидЗапасов.ТипЗапасов = ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.Услуга)
		|			ТОГДА НЕОПРЕДЕЛЕНО
		|		ИНАЧЕ ДД.ВидЗапасов КОНЕЦ),
		|	ДД.Подразделение,
		|	ДД.ГруппаПродукции
		|";
КонецФункции

Функция РегистраторыСебестоимостиПроизводства(ДанныеДляСебестоимостиПроизводства, НачалоПериода, ОкончаниеПериода, МассивОрганизаций)
	// Регистраторы из НеИзменившиесяДокументы не выбираем, чтобы не очистились их движения.
	ТекстЗапроса = "
		|ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	ДД.Регистратор КАК Регистратор
		|ИЗ
		|	РегистрНакопления.СебестоимостьТоваров КАК ДД
		|	ЛЕВОЕ СОЕДИНЕНИЕ НеИзменившиесяДокументы КАК Регистраторы
		|		ПО ДД.Регистратор = Регистраторы.Регистратор
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И (ДД.Регистратор ССЫЛКА Документ.ВыпускПродукции
		|		ИЛИ ДД.Регистратор ССЫЛКА Документ.ПоступлениеОтПереработчика
		//++ НЕ УТКА
		|		ИЛИ ДД.Регистратор ССЫЛКА Документ.ОтчетДавальцу
		//-- НЕ УТКА
		|		ИЛИ ДД.Регистратор ССЫЛКА Документ.РаспределениеПроизводственныхЗатрат
		|		ИЛИ ДД.Регистратор ССЫЛКА Документ.ПеремещениеМатериаловВПроизводстве
		|		ИЛИ ДД.Регистратор ССЫЛКА Документ.ВозвратМатериаловИзПроизводства)
		|	И Регистраторы.Регистратор ЕСТЬ NULL
		|";
	Регистраторы = Новый Соответствие;
	
	Запрос = Новый Запрос(ТекстЗапроса);
	Запрос.МенеджерВременныхТаблиц = ДанныеДляСебестоимостиПроизводства;
	Запрос.УстановитьПараметр("НачалоПериода", НачалоПериода);
	Запрос.УстановитьПараметр("ОкончаниеПериода", ОкончаниеПериода);
	Запрос.УстановитьПараметр("МассивОрганизаций", МассивОрганизаций);	
	Выборка = Запрос.Выполнить().Выбрать();
	Пока Выборка.Следующий() Цикл
		Регистраторы.Вставить(Выборка.Регистратор, Истина);
	КонецЦикла;
	Возврат Регистраторы;
КонецФункции

Процедура УдалитьНеИзменившиесяДанныеСебестоимостиПроизводства(МВТ, НачалоПериода, ОкончаниеПериода)
	
	// Получим из метаданных информацию о структуре регистра
	КолонкиРегистра = Новый Структура;
	ТаблицаРегистра = РегистрыНакопления.СебестоимостьТоваров.СоздатьНаборЗаписей().ВыгрузитьКолонки();
	Для Каждого Колонка Из ТаблицаРегистра.Колонки Цикл
		КолонкиРегистра.Вставить(
			Колонка.Имя,
			Метаданные.РегистрыНакопления.СебестоимостьТоваров.Ресурсы.Найти(Колонка.Имя) <> Неопределено);
	КонецЦикла;
	
	// Получим из текста запроса информацию о полях формируемых записей регистров
	// и сформируем запрос для отбора измененных движений.
	Запрос = Новый Запрос(ТекстОписаниеСебестоимость());
	ТаблицаДвижений = Запрос.Выполнить().Выгрузить();
	
	ТекстПоляГруппировки = "";
	ТекстПриведенныеПоля = "";
	ТекстПоляСуммирования = "";
	ТекстОтбор = "";
	ЭтоРесурсРегистра = Ложь;
	
	Для Каждого Колонка Из ТаблицаДвижений.Колонки Цикл
		Если КолонкиРегистра.Свойство(Колонка.Имя, ЭтоРесурсРегистра) Тогда
			Если ЭтоРесурсРегистра Тогда
				ТекстПоляСуммирования = ТекстПоляСуммирования + ?(ТекстПоляСуммирования = "", "", ", 
					|	") + "Т." + Колонка.Имя + " КАК " + Колонка.Имя;
				ТекстОтбор = ТекстОтбор + ?(ТекстОтбор = "", "", " 
					|	ИЛИ ") + "СУММА(Т." + Колонка.Имя + ") <> 0";
			Иначе
				ТекстПоляГруппировки = ТекстПоляГруппировки + ?(ТекстПоляГруппировки = "", "", ", 
					|	") + "Т." + Колонка.Имя;
				ТекстПриведенныеПоля = ТекстПриведенныеПоля + ?(ТекстПриведенныеПоля = "", "", ", 
					|	") + ТекстПриведениеЗначенияПоляКНужномуТипу(Колонка.Имя, Колонка.ТипЗначения);
			КонецЕсли;
		КонецЕсли;
	КонецЦикла;
	
	Запрос.Текст = "
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	Т.Регистратор
	|ПОМЕСТИТЬ ВТДокументыСНовымиДвижениями
	|ИЗ
	|	ДанныеПредварительные КАК Т
	|;
	|//////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	Т.Период,
	|	Т.Организация,
	|	Т.Регистратор
	|ПОМЕСТИТЬ ВТИзмененныеДокументыКОтражению
	|ИЗ
	|	(ВЫБРАТЬ
	|		%5,
	|		%2
	|	ИЗ
	|		ДанныеПредварительные КАК Т
	|	
	|   ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		%1,
	|		%3
	|	ИЗ
	|		РегистрНакопления.СебестоимостьТоваров КАК Т
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТДокументыСНовымиДвижениями КАК ОтборРегистраторы
	|			ПО Т.Регистратор = ОтборРегистраторы.Регистратор
	|	ГДЕ
	|		Т.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
	|		И НЕ Т.РасчетСебестоимости
	|	) КАК Т
	|СГРУППИРОВАТЬ ПО
	|	%1
	|ИМЕЮЩИЕ
	|	%4
	|;
	|//////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	Т.Регистратор
	|ПОМЕСТИТЬ ВТИзмененныеДокументы
	|ИЗ
	|	ВТИзмененныеДокументыКОтражению КАК Т
	|;
	|//////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	%5,
	|	%2
	|ПОМЕСТИТЬ Данные
	|ИЗ
	|	ДанныеПредварительные КАК Т
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТИзмененныеДокументы КАК ОтборРегистраторы
	|		ПО Т.Регистратор = ОтборРегистраторы.Регистратор
	|;
	|//////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ДанныеПредварительные
	|;
	|//////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	Т.Регистратор
	|ПОМЕСТИТЬ НеИзменившиесяДокументы
	|ИЗ
	|	ВТДокументыСНовымиДвижениями КАК Т
	|	ЛЕВОЕ СОЕДИНЕНИЕ ВТИзмененныеДокументы КАК ИзмененныеДокументы
	|		ПО Т.Регистратор = ИзмененныеДокументы.Регистратор
	|ГДЕ
	|	ИзмененныеДокументы.Регистратор ЕСТЬ NULL
	|;
	|//////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ВТДокументыСНовымиДвижениями
	|";
	
	Запрос.Текст = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
		Запрос.Текст,
		ТекстПоляГруппировки, // %1
		ТекстПоляСуммирования, // %2
		СтрЗаменить(ТекстПоляСуммирования, "Т.", "-Т."), // %3
		ТекстОтбор, // %4
		ТекстПриведенныеПоля); // %5
		
	Запрос.МенеджерВременныхТаблиц = МВТ;
	Запрос.УстановитьПараметр("НачалоПериода", НачалоПериода);
	Запрос.УстановитьПараметр("ОкончаниеПериода", ОкончаниеПериода);
	
	// Сформируем временные таблицы:
	// - Данные - новые движения, отличающиеся от старых движений (хранящихся в ИБ)
	// - НеИзменившиесяДокументы - перечень регистраторов, по которым не изменились движения
	// - ВТИзмененныеДокументы - перечень регистраторов, по которым движения изменились.
	Запрос.Выполнить();
	
КонецПроцедуры

Функция ТекстПриведениеЗначенияПоляКНужномуТипу(ИмяПоля, ТипПоля)
	
	// Используется для приведения значений измерений и реквизитов регистра к типу, указанному в их метаданных.
	// - считаем, что ресурсы приводить к типу не требуется - они всегда корректно выбираются в запросе
	// - в ТипПоля может быть Тип("NULL"), т.к. поле получаем из запроса, а не из самого регистра
	// Без приведения типа нельзя сравнивать новые движения (сформированные запросом) и старые движения (хранящиеся в регистре).
	
	ОсновнойТип = Неопределено;
	ТекстПоля   = "Т." + ИмяПоля;
	ТипыПоля    = ТипПоля.Типы();
	
	Если ТипыПоля.Количество() = 1 Тогда
		ОсновнойТип = ТипыПоля[0];
	ИначеЕсли ТипыПоля.Количество() = 2 Тогда
		Если ТипыПоля[0] = Тип("NULL") Тогда
			ОсновнойТип = ТипыПоля[1];
		ИначеЕсли ТипыПоля[1] = Тип("NULL") Тогда
			ОсновнойТип = ТипыПоля[0];
		Иначе
			Возврат ТекстПоля; // составной тип приводить к какому-то типу не надо
		КонецЕсли;
	Иначе
		Возврат ТекстПоля; // составной тип приводить к какому-то типу не надо
	КонецЕсли;
	
	ПримитивныеТипы    = Новый ОписаниеТипов("Строка, Число, Дата, Булево, Неопределено, Null, ХранилищеЗначения, УникальныйИдентификатор");
	ИмяТипа 		   = "";
	ПустоеЗначениеТипа = "";
	
	Если ПримитивныеТипы.СодержитТип(ОсновнойТип) Тогда
		Если ОсновнойТип = Тип("Строка") Тогда
			ИмяТипа = "Строка";
			ПустоеЗначениеТипа = """""";
		ИначеЕсли ОсновнойТип = Тип("Число") Тогда
			ИмяТипа = "Число";
			ПустоеЗначениеТипа = "0";
		ИначеЕсли ОсновнойТип = Тип("Дата") Тогда
			ИмяТипа = "Дата";
			ПустоеЗначениеТипа = "ДАТАВРЕМЯ(1, 1, 1, 0, 0, 0)";
		ИначеЕсли ОсновнойТип = Тип("Булево") Тогда
			ИмяТипа = "Булево";
			ПустоеЗначениеТипа = "ЛОЖЬ";
		Иначе
			Возврат ТекстПоля; // такой тип не поддерживаем
		КонецЕсли;
	Иначе
		ОбъектМетаданных = Метаданные.НайтиПоТипу(ОсновнойТип);
		Если ОбъектМетаданных = Неопределено Тогда
			Возврат ТекстПоля; // такой тип не поддерживаем
		КонецЕсли;
		ИмяТипа = ОбъектМетаданных.ПолноеИмя();
		ПустоеЗначениеТипа = "ЗНАЧЕНИЕ(" + ИмяТипа + ".ПустаяСсылка)";
	КонецЕсли;
	
	ТекстПоля = "ВЫБОР КОГДА Т." + ИмяПоля + " = НЕОПРЕДЕЛЕНО ИЛИ ТипЗначения(Т." + ИмяПоля + ") <> Тип(" + ИмяТипа + ") ТОГДА " 
		+ ПустоеЗначениеТипа + " ИНАЧЕ Т." + ИмяПоля + " КОНЕЦ КАК " + ИмяПоля;
	
	Возврат ТекстПоля;
	
КонецФункции

#КонецОбласти
//-- НЕ УТ

#Область РасчетПриходыПартийНДСКРаспределению

Функция ДанныеДляПартийНДСКРаспределению(НачалоПериода, ОкончаниеПериода, МассивОрганизаций)
	ТекстСортировка = "";
	ИсходныйТекстЗапроса =
		ТекстОписаниеДанныхДляПартийНДСКРаспределению()
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстПоступленияПартийНДСКРаспределениюИзПартий()
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстПоступленияПартийНДСКРаспределениюИзДопРасходов()
		+ "ОБЪЕДИНИТЬ ВСЕ" + ТекстПоступленияПартийНДСКРаспределениюИзЗатратНаВыпуск()
		+ ТекстСортировка;
	ИсходныйЗапрос = Новый Запрос(ИсходныйТекстЗапроса);
	ИсходныйЗапрос.УстановитьПараметр("НачалоПериода", НачалоПериода);
	ИсходныйЗапрос.УстановитьПараметр("ОкончаниеПериода", ОкончаниеПериода);
	ИсходныйЗапрос.УстановитьПараметр("МассивОрганизаций", МассивОрганизаций);	
	ДанныеДляРасчета = ИсходныйЗапрос.Выполнить().Выгрузить();
	ДанныеДляРасчета.Сортировать("Регистратор", Новый СравнениеЗначений);
	
	Возврат ДанныеДляРасчета;
КонецФункции

Функция ТекстОписаниеДанныхДляПартийНДСКРаспределению()
	Возврат "
		|ВЫБРАТЬ ПЕРВЫЕ 0
		|	0 КАК Приоритет,
		|	""ХХХХХХХХХХХХХХХХ"" КАК ТипЗаписи,
		|	ЛОЖЬ КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
		|	ДАТАВРЕМЯ(1, 1, 1, 0, 0, 0) КАК Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ДД.Подразделение,
		|	ДД.НаправлениеДеятельности,
		|	ДД.СтатьяРасходов,
		|	ДД.АналитикаРасходов,
		|	ДД.АналитикаАктивовПассивов,
		|	ДД.Поставщик,
		|	ДД.ДокументПоступленияРасходов,
		|	ДД.ВидДеятельностиНДС,
		|	ДД.ВидЦенности,
		|	ДД.СтавкаНДС,
		|	ДД.СтоимостьРегл,
		|	ДД.НДСРегл
		|ИЗ
		|	РегистрНакопления.ПартииНДСКРаспределению КАК ДД
		|";
КонецФункции

Функция ТекстПоступленияПартийНДСКРаспределениюИзПартий()
	Возврат "
		|ВЫБРАТЬ
		|	10 КАК Приоритет,
		|	""Партия"" КАК ТипЗаписи,
		|	ИСТИНА КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ВЫБОР
		|		КОГДА НЕ Потребление.Подразделение ЕСТЬ NULL
		|			ТОГДА Потребление.Подразделение
		//++ НЕ УТ
		|		КОГДА НЕ ПередачаМатериалов.Подразделение ЕСТЬ NULL
		|			ТОГДА ПередачаМатериалов.Подразделение
		|		КОГДА НЕ ВозвратМатериалов.Подразделение ЕСТЬ NULL
		|			ТОГДА ВозвратМатериалов.Подразделение
		//-- НЕ УТ
		|		ИНАЧЕ Сторно.Подразделение
		|	КОНЕЦ КАК Подразделение,
		|	ЕСТЬNULL(Потребление.НаправлениеДеятельности,
		|		ЕСТЬNULL(Назначения.НаправлениеДеятельности,
		|			ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка))) КАК НаправлениеДеятельности,
		|	ДД.СтатьяРасходовСписания КАК СтатьяРасходов,
		|	ДД.АналитикаРасходов,
		|	ДД.АналитикаАктивовПассивов,
		|	ДД.АналитикаУчетаПартий.Контрагент КАК Поставщик,
		|	ДД.ДокументПоступления КАК ДокументПоступленияРасходов,
		|	(ВЫБОР
		|		КОГДА ДД.НалогообложениеНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ВводОСВЭксплуатацию)
		|			ТОГДА ДД.НалогообложениеНДС
		|		КОГДА Статья.ВариантРаспределенияРасходовРегл = ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаВнеоборотныеАктивы)
		|		 И Статья.ВидЦенностиНДС = ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.ОС) ТОГДА
		|			(ВЫБОР
		|				КОГДА Статья.ВариантРаздельногоУчетаНДС = ЗНАЧЕНИЕ(Перечисление.ВариантыРаздельногоУчетаНДС.ИзДокумента)
		|				 И ДД.НалогообложениеНДС <> ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
		|					ТОГДА ДД.НалогообложениеНДС
		|				КОГДА Статья.ВариантРаздельногоУчетаНДС = ЗНАЧЕНИЕ(Перечисление.ВариантыРаздельногоУчетаНДС.ИзДокумента)
		|				 И ДД.НалогообложениеНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
		|					ТОГДА ДД.АналитикаУчетаПартий.НалогообложениеНДС
		|				ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ВводОСВЭксплуатацию) КОНЕЦ)
		|		КОГДА Статья.ВариантРаспределенияРасходовРегл = ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаВнеоборотныеАктивы)
		|		 И Статья.ВидЦенностиНДС = ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.НМА)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ВводОСВЭксплуатацию)
		|		КОГДА ДД.НалогообложениеНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
		|			ТОГДА ДД.АналитикаУчетаПартий.НалогообложениеНДС
		|		ИНАЧЕ ДД.НалогообложениеНДС КОНЕЦ) КАК ВидДеятельностиНДС,
		|	(ВЫБОР
		|		КОГДА ТИПЗНАЧЕНИЯ(ДД.ДокументПоступления) = ТИП(Документ.ТаможеннаяДекларацияИмпорт)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.ТаможенныеПлатежи)
		|		КОГДА Аналитика.Номенклатура.ТипНоменклатуры В (
		|				ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.Товар),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.МногооборотнаяТара))
		|			ТОГДА (ВЫБОР
		|				КОГДА ЕСТЬNULL(Аналитика.Номенклатура.ГруппаФинансовогоУчета.ВидЦенностиНДС,
		|						ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.ПустаяСсылка)) = ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.ПустаяСсылка)
		|					ТОГДА ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.Товары)
		|				ИНАЧЕ Аналитика.Номенклатура.ГруппаФинансовогоУчета.ВидЦенностиНДС КОНЕЦ)
		|		КОГДА ЕСТЬNULL(Статья.ВидЦенностиНДС, ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.ПустаяСсылка)) <>
		|				ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.ПустаяСсылка)
		|			ТОГДА Статья.ВидЦенностиНДС
		|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.ПрочиеРаботыИУслуги) КОНЕЦ) КАК ВидЦенности,
		|	ДД.АналитикаУчетаПартий.СтавкаНДС КАК СтавкаНДС,
		|	СУММА(ДД.СтоимостьРегл) КАК СтоимостьРегл,
		|	СУММА(ДД.НДСРегл) КАК НДСРегл
		|ИЗ
		|	РегистрНакопления.ПартииТоваровОрганизаций КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК Аналитика
		|		ПО Аналитика.Ссылка = ДД.АналитикаУчетаНоменклатуры
		|	ЛЕВОЕ СОЕДИНЕНИЕ Справочник.Назначения КАК Назначения
		|		ПО Назначения.Ссылка = Аналитика.Назначение
		|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.ВнутреннееПотребление КАК Потребление
		|		ПО Потребление.Ссылка = ДД.Регистратор
		//++ НЕ УТ
		|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.ПередачаМатериаловВПроизводство КАК ПередачаМатериалов
		|		ПО ПередачаМатериалов.Ссылка = ДД.Регистратор
		|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.ВозвратМатериаловИзПроизводства КАК ВозвратМатериалов
		|		ПО ВозвратМатериалов.Ссылка = ДД.Регистратор
		//-- НЕ УТ
		|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.ПрочееОприходованиеТоваров КАК Сторно
		|		ПО Сторно.Ссылка = ДД.Регистратор
		|	ЛЕВОЕ СОЕДИНЕНИЕ ПланВидовХарактеристик.СтатьиРасходов КАК Статья
		|		ПО Статья.Ссылка = ДД.СтатьяРасходовСписания
		|	ЛЕВОЕ СОЕДИНЕНИЕ ПланВидовХарактеристик.СтатьиАктивовПассивов КАК СтатьяАктивов
		|		ПО СтатьяАктивов.Ссылка = ДД.СтатьяРасходовСписания
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И (Статья.ВариантРаздельногоУчетаНДС = ЗНАЧЕНИЕ(Перечисление.ВариантыРаздельногоУчетаНДС.Распределение)
		|		ИЛИ Статья.ВариантРаспределенияРасходовРегл = ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаВнеоборотныеАктивы)
		|			И Статья.ВидЦенностиНДС = ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.ОС)
		|		ИЛИ ДД.НалогообложениеНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ОпределяетсяРаспределением)
		|		ИЛИ НЕ СтатьяАктивов.Ссылка ЕСТЬ NULL
		|			И ДД.НалогообложениеНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ВводОСВЭксплуатацию))
		|	И ДД.НДСРегл <> 0
		|	И ДД.АналитикаУчетаПартий <> ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка)
		|СГРУППИРОВАТЬ ПО
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ВЫБОР
		|		КОГДА НЕ Потребление.Подразделение ЕСТЬ NULL
		|			ТОГДА Потребление.Подразделение
		//++ НЕ УТ
		|		КОГДА НЕ ПередачаМатериалов.Подразделение ЕСТЬ NULL
		|			ТОГДА ПередачаМатериалов.Подразделение
		|		КОГДА НЕ ВозвратМатериалов.Подразделение ЕСТЬ NULL
		|			ТОГДА ВозвратМатериалов.Подразделение
		//-- НЕ УТ
		|		ИНАЧЕ Сторно.Подразделение
		|	КОНЕЦ,
		|	ЕСТЬNULL(Потребление.НаправлениеДеятельности,
		|		ЕСТЬNULL(Назначения.НаправлениеДеятельности,
		|			ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка))),
		|	ДД.СтатьяРасходовСписания,
		|	ДД.АналитикаРасходов,
		|	ДД.АналитикаАктивовПассивов,
		|	ДД.АналитикаУчетаПартий.Контрагент,
		|	ДД.ДокументПоступления,
		|	(ВЫБОР
		|		КОГДА ДД.НалогообложениеНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ВводОСВЭксплуатацию)
		|			ТОГДА ДД.НалогообложениеНДС
		|		КОГДА Статья.ВариантРаспределенияРасходовРегл = ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаВнеоборотныеАктивы)
		|		 И Статья.ВидЦенностиНДС = ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.ОС) ТОГДА
		|			(ВЫБОР
		|				КОГДА Статья.ВариантРаздельногоУчетаНДС = ЗНАЧЕНИЕ(Перечисление.ВариантыРаздельногоУчетаНДС.ИзДокумента)
		|				 И ДД.НалогообложениеНДС <> ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
		|					ТОГДА ДД.НалогообложениеНДС
		|				КОГДА Статья.ВариантРаздельногоУчетаНДС = ЗНАЧЕНИЕ(Перечисление.ВариантыРаздельногоУчетаНДС.ИзДокумента)
		|				 И ДД.НалогообложениеНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
		|					ТОГДА ДД.АналитикаУчетаПартий.НалогообложениеНДС
		|				ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ВводОСВЭксплуатацию) КОНЕЦ)
		|		КОГДА Статья.ВариантРаспределенияРасходовРегл = ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаВнеоборотныеАктивы)
		|		 И Статья.ВидЦенностиНДС = ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.НМА)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ВводОСВЭксплуатацию)
		|		КОГДА ДД.НалогообложениеНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
		|			ТОГДА ДД.АналитикаУчетаПартий.НалогообложениеНДС
		|		ИНАЧЕ ДД.НалогообложениеНДС КОНЕЦ),
		|	(ВЫБОР
		|		КОГДА ТИПЗНАЧЕНИЯ(ДД.ДокументПоступления) = ТИП(Документ.ТаможеннаяДекларацияИмпорт)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.ТаможенныеПлатежи)
		|		КОГДА Аналитика.Номенклатура.ТипНоменклатуры В (
		|				ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.Товар),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.МногооборотнаяТара))
		|			ТОГДА (ВЫБОР
		|				КОГДА ЕСТЬNULL(Аналитика.Номенклатура.ГруппаФинансовогоУчета.ВидЦенностиНДС,
		|						ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.ПустаяСсылка)) = ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.ПустаяСсылка)
		|					ТОГДА ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.Товары)
		|				ИНАЧЕ Аналитика.Номенклатура.ГруппаФинансовогоУчета.ВидЦенностиНДС КОНЕЦ)
		|		КОГДА ЕСТЬNULL(Статья.ВидЦенностиНДС, ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.ПустаяСсылка)) <>
		|				ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.ПустаяСсылка)
		|			ТОГДА Статья.ВидЦенностиНДС
		|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.ПрочиеРаботыИУслуги) КОНЕЦ),
		|	ДД.АналитикаУчетаПартий.СтавкаНДС
		|";
КонецФункции
	
Функция ТекстПоступленияПартийНДСКРаспределениюИзДопРасходов()
	Возврат "
		|ВЫБРАТЬ
		|	10 КАК Приоритет,
		|	""Партия"" КАК ТипЗаписи,
		|	ИСТИНА КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ВЫБОР
		|		КОГДА НЕ Потребление.Подразделение ЕСТЬ NULL
		|			ТОГДА Потребление.Подразделение
		//++ НЕ УТ
		|		КОГДА НЕ ПередачаМатериалов.Подразделение ЕСТЬ NULL
		|			ТОГДА ПередачаМатериалов.Подразделение
		|		КОГДА НЕ ВозвратМатериалов.Подразделение ЕСТЬ NULL
		|			ТОГДА ВозвратМатериалов.Подразделение
		//-- НЕ УТ
		|		ИНАЧЕ Сторно.Подразделение
		|	КОНЕЦ КАК Подразделение,
		|	ЕСТЬNULL(Потребление.НаправлениеДеятельности,
		|		ЕСТЬNULL(Назначения.НаправлениеДеятельности,
		|			ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка))) КАК НаправлениеДеятельности,
		|	ДД.СтатьяРасходовСписания КАК СтатьяРасходов,
		|	ДД.АналитикаРасходов,
		|	ДД.АналитикаАктивовПассивов,
		|	ДД.АналитикаУчетаПартий.Контрагент КАК Поставщик,
		|	ДД.ДокументПоступленияРасходов,
		|	(ВЫБОР
		|		КОГДА ДД.НалогообложениеНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ВводОСВЭксплуатацию)
		|			ТОГДА ДД.НалогообложениеНДС
		|		КОГДА Статья.ВариантРаспределенияРасходовРегл = ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаВнеоборотныеАктивы)
		|		 И Статья.ВидЦенностиНДС = ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.ОС) ТОГДА
		|			(ВЫБОР
		|				КОГДА Статья.ВариантРаздельногоУчетаНДС = ЗНАЧЕНИЕ(Перечисление.ВариантыРаздельногоУчетаНДС.ИзДокумента)
		|				 И ДД.НалогообложениеНДС <> ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
		|					ТОГДА ДД.НалогообложениеНДС
		|				КОГДА Статья.ВариантРаздельногоУчетаНДС = ЗНАЧЕНИЕ(Перечисление.ВариантыРаздельногоУчетаНДС.ИзДокумента)
		|				 И ДД.НалогообложениеНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
		|					ТОГДА ДД.АналитикаУчетаПартий.НалогообложениеНДС
		|				ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ВводОСВЭксплуатацию) КОНЕЦ)
		|		КОГДА Статья.ВариантРаспределенияРасходовРегл = ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаВнеоборотныеАктивы)
		|		 И Статья.ВидЦенностиНДС = ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.НМА)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ВводОСВЭксплуатацию)
		|		КОГДА ДД.НалогообложениеНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
		|			ТОГДА ДД.АналитикаУчетаПартий.НалогообложениеНДС
		|		ИНАЧЕ ДД.НалогообложениеНДС КОНЕЦ) КАК ВидДеятельностиНДС,
		|	(ВЫБОР
		|		КОГДА ТИПЗНАЧЕНИЯ(ДД.ДокументПоступления) = ТИП(Документ.ТаможеннаяДекларацияИмпорт)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.ТаможенныеПлатежи)
		|		КОГДА Аналитика.Номенклатура.ТипНоменклатуры В (
		|				ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.Товар),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.МногооборотнаяТара))
		|			ТОГДА (ВЫБОР
		|				КОГДА ЕСТЬNULL(Аналитика.Номенклатура.ГруппаФинансовогоУчета.ВидЦенностиНДС,
		|						ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.ПустаяСсылка)) = ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.ПустаяСсылка)
		|					ТОГДА ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.Товары)
		|				ИНАЧЕ Аналитика.Номенклатура.ГруппаФинансовогоУчета.ВидЦенностиНДС КОНЕЦ)
		|		КОГДА ЕСТЬNULL(Статья.ВидЦенностиНДС, ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.ПустаяСсылка)) <>
		|				ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.ПустаяСсылка)
		|			ТОГДА Статья.ВидЦенностиНДС
		|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.ПрочиеРаботыИУслуги) КОНЕЦ) КАК ВидЦенности,
		|	ДД.АналитикаУчетаПартий.СтавкаНДС КАК СтавкаНДС,
		|	СУММА(ДД.СтоимостьРегл) КАК СтоимостьРегл,
		|	СУММА(ДД.НДСРегл) КАК НДСРегл
		|ИЗ
		|	РегистрНакопления.ПартииРасходовНаСебестоимостьТоваров КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК Аналитика
		|		ПО Аналитика.Ссылка = ДД.АналитикаУчетаНоменклатуры
		|	ЛЕВОЕ СОЕДИНЕНИЕ Справочник.Назначения КАК Назначения
		|		ПО Назначения.Ссылка = Аналитика.Назначение
		|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.ВнутреннееПотребление КАК Потребление
		|		ПО Потребление.Ссылка = ДД.Регистратор
		//++ НЕ УТ
		|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.ПередачаМатериаловВПроизводство КАК ПередачаМатериалов
		|		ПО ПередачаМатериалов.Ссылка = ДД.Регистратор
		|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.ВозвратМатериаловИзПроизводства КАК ВозвратМатериалов
		|		ПО ВозвратМатериалов.Ссылка = ДД.Регистратор
		//-- НЕ УТ
		|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.ПрочееОприходованиеТоваров КАК Сторно
		|		ПО Сторно.Ссылка = ДД.Регистратор
		|	ЛЕВОЕ СОЕДИНЕНИЕ ПланВидовХарактеристик.СтатьиРасходов КАК Статья
		|		ПО Статья.Ссылка = ДД.СтатьяРасходовСписания
		|	ЛЕВОЕ СОЕДИНЕНИЕ ПланВидовХарактеристик.СтатьиАктивовПассивов КАК СтатьяАктивов
		|		ПО СтатьяАктивов.Ссылка = ДД.СтатьяРасходовСписания
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И (Статья.ВариантРаздельногоУчетаНДС = ЗНАЧЕНИЕ(Перечисление.ВариантыРаздельногоУчетаНДС.Распределение)
		|		ИЛИ Статья.ВариантРаспределенияРасходовРегл = ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаВнеоборотныеАктивы)
		|			И Статья.ВидЦенностиНДС = ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.ОС)
		|		ИЛИ ДД.НалогообложениеНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ОпределяетсяРаспределением)
		|		ИЛИ НЕ СтатьяАктивов.Ссылка ЕСТЬ NULL
		|			И ДД.НалогообложениеНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ВводОСВЭксплуатацию))
		|	И ДД.НДСРегл <> 0
		|	И ДД.АналитикаУчетаПартий <> ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка)
		//++ НЕ УТ
		|	И НЕ ДД.Регистратор ССЫЛКА Документ.РаспределениеПрочихЗатрат
		|	И НЕ ДД.Регистратор ССЫЛКА Документ.ПоступлениеОтПереработчика
		|	И НЕ ДД.Регистратор ССЫЛКА Документ.ВыпускПродукции
		|	И НЕ ДД.Регистратор ССЫЛКА Документ.РаспределениеПроизводственныхЗатрат
		//-- НЕ УТ

		//++ НЕ УТКА
		|	И НЕ ДД.Регистратор ССЫЛКА Документ.ОтчетДавальцу
		//-- НЕ УТКА
		|СГРУППИРОВАТЬ ПО
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ВЫБОР
		|		КОГДА НЕ Потребление.Подразделение ЕСТЬ NULL
		|			ТОГДА Потребление.Подразделение
		//++ НЕ УТ
		|		КОГДА НЕ ПередачаМатериалов.Подразделение ЕСТЬ NULL
		|			ТОГДА ПередачаМатериалов.Подразделение
		|		КОГДА НЕ ВозвратМатериалов.Подразделение ЕСТЬ NULL
		|			ТОГДА ВозвратМатериалов.Подразделение
		//-- НЕ УТ
		|		ИНАЧЕ Сторно.Подразделение
		|	КОНЕЦ,
		|	ЕСТЬNULL(Потребление.НаправлениеДеятельности,
		|		ЕСТЬNULL(Назначения.НаправлениеДеятельности,
		|			ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка))),
		|	ДД.СтатьяРасходовСписания,
		|	ДД.АналитикаРасходов,
		|	ДД.АналитикаАктивовПассивов,
		|	ДД.АналитикаУчетаПартий.Контрагент,
		|	ДД.ДокументПоступленияРасходов,
		|	(ВЫБОР
		|		КОГДА ДД.НалогообложениеНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ВводОСВЭксплуатацию)
		|			ТОГДА ДД.НалогообложениеНДС
		|		КОГДА Статья.ВариантРаспределенияРасходовРегл = ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаВнеоборотныеАктивы)
		|		 И Статья.ВидЦенностиНДС = ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.ОС) ТОГДА
		|			(ВЫБОР
		|				КОГДА Статья.ВариантРаздельногоУчетаНДС = ЗНАЧЕНИЕ(Перечисление.ВариантыРаздельногоУчетаНДС.ИзДокумента)
		|				 И ДД.НалогообложениеНДС <> ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
		|					ТОГДА ДД.НалогообложениеНДС
		|				КОГДА Статья.ВариантРаздельногоУчетаНДС = ЗНАЧЕНИЕ(Перечисление.ВариантыРаздельногоУчетаНДС.ИзДокумента)
		|				 И ДД.НалогообложениеНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
		|					ТОГДА ДД.АналитикаУчетаПартий.НалогообложениеНДС
		|				ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ВводОСВЭксплуатацию) КОНЕЦ)
		|		КОГДА Статья.ВариантРаспределенияРасходовРегл = ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаВнеоборотныеАктивы)
		|		 И Статья.ВидЦенностиНДС = ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.НМА)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ВводОСВЭксплуатацию)
		|		КОГДА ДД.НалогообложениеНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
		|			ТОГДА ДД.АналитикаУчетаПартий.НалогообложениеНДС
		|		ИНАЧЕ ДД.НалогообложениеНДС КОНЕЦ),
		|	(ВЫБОР
		|		КОГДА ТИПЗНАЧЕНИЯ(ДД.ДокументПоступления) = ТИП(Документ.ТаможеннаяДекларацияИмпорт)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.ТаможенныеПлатежи)
		|		КОГДА Аналитика.Номенклатура.ТипНоменклатуры В (
		|				ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.Товар),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.МногооборотнаяТара))
		|			ТОГДА (ВЫБОР
		|				КОГДА ЕСТЬNULL(Аналитика.Номенклатура.ГруппаФинансовогоУчета.ВидЦенностиНДС,
		|						ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.ПустаяСсылка)) = ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.ПустаяСсылка)
		|					ТОГДА ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.Товары)
		|				ИНАЧЕ Аналитика.Номенклатура.ГруппаФинансовогоУчета.ВидЦенностиНДС КОНЕЦ)
		|		КОГДА ЕСТЬNULL(Статья.ВидЦенностиНДС, ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.ПустаяСсылка)) <>
		|				ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.ПустаяСсылка)
		|			ТОГДА Статья.ВидЦенностиНДС
		|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.ПрочиеРаботыИУслуги) КОНЕЦ),
		|	ДД.АналитикаУчетаПартий.СтавкаНДС
		|";
КонецФункции

Функция ТекстПоступленияПартийНДСКРаспределениюИзЗатратНаВыпуск()
	Возврат "
		|ВЫБРАТЬ
		|	10 КАК Приоритет,
		|	""Партия"" КАК ТипЗаписи,
		|	ИСТИНА КАК РасчетЗавершен,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ЕСТЬNULL(Потребление.Подразделение, Сторно.Подразделение) КАК Подразделение,
		|	ЕСТЬNULL(Потребление.НаправлениеДеятельности,
		|		ЕСТЬNULL(Назначения.НаправлениеДеятельности,
		|			ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка))) КАК НаправлениеДеятельности,
		|	ДД.СтатьяРасходовСписания КАК СтатьяРасходов,
		|	ДД.АналитикаРасходов,
		|	ДД.АналитикаАктивовПассивов,
		|	ДД.АналитикаУчетаПартий.Контрагент КАК Поставщик,
		|	ДД.ДокументПоступления,
		|	(ВЫБОР
		|		КОГДА ДД.НалогообложениеНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ВводОСВЭксплуатацию)
		|			ТОГДА ДД.НалогообложениеНДС
		|		КОГДА Статья.ВариантРаспределенияРасходовРегл = ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаВнеоборотныеАктивы)
		|		 И Статья.ВидЦенностиНДС = ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.ОС) ТОГДА
		|			(ВЫБОР
		|				КОГДА Статья.ВариантРаздельногоУчетаНДС = ЗНАЧЕНИЕ(Перечисление.ВариантыРаздельногоУчетаНДС.ИзДокумента)
		|				 И ДД.НалогообложениеНДС <> ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
		|					ТОГДА ДД.НалогообложениеНДС
		|				КОГДА Статья.ВариантРаздельногоУчетаНДС = ЗНАЧЕНИЕ(Перечисление.ВариантыРаздельногоУчетаНДС.ИзДокумента)
		|				 И ДД.НалогообложениеНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
		|					ТОГДА ДД.АналитикаУчетаПартий.НалогообложениеНДС
		|				ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ВводОСВЭксплуатацию) КОНЕЦ)
		|		КОГДА Статья.ВариантРаспределенияРасходовРегл = ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаВнеоборотныеАктивы)
		|		 И Статья.ВидЦенностиНДС = ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.НМА)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ВводОСВЭксплуатацию)
		|		КОГДА ДД.НалогообложениеНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
		|			ТОГДА ДД.АналитикаУчетаПартий.НалогообложениеНДС
		|		ИНАЧЕ ДД.НалогообложениеНДС КОНЕЦ) КАК ВидДеятельностиНДС,
		|	(ВЫБОР
		|		КОГДА ТИПЗНАЧЕНИЯ(ДД.ДокументПоступления) = ТИП(Документ.ТаможеннаяДекларацияИмпорт)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.ТаможенныеПлатежи)
		|		КОГДА Аналитика.Номенклатура.ТипНоменклатуры В (
		|				ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.Товар),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.МногооборотнаяТара))
		|			ТОГДА (ВЫБОР
		|				КОГДА ЕСТЬNULL(Аналитика.Номенклатура.ГруппаФинансовогоУчета.ВидЦенностиНДС,
		|						ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.ПустаяСсылка)) = ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.ПустаяСсылка)
		|					ТОГДА ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.Товары)
		|				ИНАЧЕ Аналитика.Номенклатура.ГруппаФинансовогоУчета.ВидЦенностиНДС КОНЕЦ)
		|		КОГДА ЕСТЬNULL(Статья.ВидЦенностиНДС, ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.ПустаяСсылка)) <>
		|				ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.ПустаяСсылка)
		|			ТОГДА Статья.ВидЦенностиНДС
		|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.ПрочиеРаботыИУслуги) КОНЕЦ) КАК ВидЦенности,
		|	ДД.АналитикаУчетаПартий.СтавкаНДС КАК СтавкаНДС,
		|	СУММА(ДД.СтоимостьРегл) КАК СтоимостьРегл,
		|	СУММА(ДД.НДСРегл) КАК НДСРегл
		|ИЗ
		|	РегистрНакопления.ПартииЗатратНаВыпуск КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК Аналитика
		|		ПО Аналитика.Ссылка = ДД.АналитикаУчетаНоменклатуры
		|	ЛЕВОЕ СОЕДИНЕНИЕ Справочник.Назначения КАК Назначения
		|		ПО Назначения.Ссылка = Аналитика.Назначение
		|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.ВнутреннееПотребление КАК Потребление
		|		ПО Потребление.Ссылка = ДД.Регистратор
		|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.ПрочееОприходованиеТоваров КАК Сторно
		|		ПО Сторно.Ссылка = ДД.Регистратор
		|	ЛЕВОЕ СОЕДИНЕНИЕ ПланВидовХарактеристик.СтатьиРасходов КАК Статья
		|		ПО Статья.Ссылка = ДД.СтатьяРасходовСписания
		|	ЛЕВОЕ СОЕДИНЕНИЕ ПланВидовХарактеристик.СтатьиАктивовПассивов КАК СтатьяАктивов
		|		ПО СтатьяАктивов.Ссылка = ДД.СтатьяРасходовСписания
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И (Статья.ВариантРаздельногоУчетаНДС = ЗНАЧЕНИЕ(Перечисление.ВариантыРаздельногоУчетаНДС.Распределение)
		|		ИЛИ Статья.ВариантРаспределенияРасходовРегл = ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаВнеоборотныеАктивы)
		|			И Статья.ВидЦенностиНДС = ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.ОС)
		|		ИЛИ ДД.НалогообложениеНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ОпределяетсяРаспределением)
		|		ИЛИ НЕ СтатьяАктивов.Ссылка ЕСТЬ NULL
		|			И ДД.НалогообложениеНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ВводОСВЭксплуатацию))
		|	И ДД.НДСРегл <> 0
		|	И ДД.АналитикаУчетаПартий <> ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка)
		//++ НЕ УТ
		|	И НЕ ДД.Регистратор ССЫЛКА Документ.ВыпускПродукции
		|	И НЕ ДД.Регистратор ССЫЛКА Документ.ПоступлениеОтПереработчика
		|	И НЕ ДД.Регистратор ССЫЛКА Документ.РаспределениеПроизводственныхЗатрат
		|	И НЕ ДД.Регистратор ССЫЛКА Документ.РаспределениеПрочихЗатрат
		//-- НЕ УТ

		//++ НЕ УТКА
		|	И НЕ ДД.Регистратор ССЫЛКА Документ.ОтчетДавальцу
		//-- НЕ УТКА
		|СГРУППИРОВАТЬ ПО
		|	ДД.Период,
		|	ДД.Регистратор,
		|	ДД.Организация,
		|	ЕСТЬNULL(Потребление.Подразделение, Сторно.Подразделение),
		|	ЕСТЬNULL(Потребление.НаправлениеДеятельности,
		|		ЕСТЬNULL(Назначения.НаправлениеДеятельности,
		|			ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка))),
		|	ДД.СтатьяРасходовСписания,
		|	ДД.АналитикаРасходов,
		|	ДД.АналитикаАктивовПассивов,
		|	ДД.АналитикаУчетаПартий.Контрагент,
		|	ДД.ДокументПоступления,
		|	(ВЫБОР
		|		КОГДА ДД.НалогообложениеНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ВводОСВЭксплуатацию)
		|			ТОГДА ДД.НалогообложениеНДС
		|		КОГДА Статья.ВариантРаспределенияРасходовРегл = ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаВнеоборотныеАктивы)
		|		 И Статья.ВидЦенностиНДС = ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.ОС) ТОГДА
		|			(ВЫБОР
		|				КОГДА Статья.ВариантРаздельногоУчетаНДС = ЗНАЧЕНИЕ(Перечисление.ВариантыРаздельногоУчетаНДС.ИзДокумента)
		|				 И ДД.НалогообложениеНДС <> ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
		|					ТОГДА ДД.НалогообложениеНДС
		|				КОГДА Статья.ВариантРаздельногоУчетаНДС = ЗНАЧЕНИЕ(Перечисление.ВариантыРаздельногоУчетаНДС.ИзДокумента)
		|				 И ДД.НалогообложениеНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
		|					ТОГДА ДД.АналитикаУчетаПартий.НалогообложениеНДС
		|				ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ВводОСВЭксплуатацию) КОНЕЦ)
		|		КОГДА Статья.ВариантРаспределенияРасходовРегл = ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаВнеоборотныеАктивы)
		|		 И Статья.ВидЦенностиНДС = ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.НМА)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ВводОСВЭксплуатацию)
		|		КОГДА ДД.НалогообложениеНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
		|			ТОГДА ДД.АналитикаУчетаПартий.НалогообложениеНДС
		|		ИНАЧЕ ДД.НалогообложениеНДС КОНЕЦ),
		|	(ВЫБОР
		|		КОГДА ТИПЗНАЧЕНИЯ(ДД.ДокументПоступления) = ТИП(Документ.ТаможеннаяДекларацияИмпорт)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.ТаможенныеПлатежи)
		|		КОГДА Аналитика.Номенклатура.ТипНоменклатуры В (
		|				ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.Товар),
		|				ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.МногооборотнаяТара))
		|			ТОГДА (ВЫБОР
		|				КОГДА ЕСТЬNULL(Аналитика.Номенклатура.ГруппаФинансовогоУчета.ВидЦенностиНДС,
		|						ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.ПустаяСсылка)) = ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.ПустаяСсылка)
		|					ТОГДА ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.Товары)
		|				ИНАЧЕ Аналитика.Номенклатура.ГруппаФинансовогоУчета.ВидЦенностиНДС КОНЕЦ)
		|		КОГДА ЕСТЬNULL(Статья.ВидЦенностиНДС, ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.ПустаяСсылка)) <>
		|				ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.ПустаяСсылка)
		|			ТОГДА Статья.ВидЦенностиНДС
		|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.ПрочиеРаботыИУслуги) КОНЕЦ),
		|	ДД.АналитикаУчетаПартий.СтавкаНДС
		|";
КонецФункции

#КонецОбласти


#Область Тестирование

Функция ТестТекстОписание(ИмяМетода) Экспорт
	Если ИмяМетода = "ТекстОписаниеПартийТоваров" Тогда
		Возврат ТекстОписаниеПартийТоваров();
		
	ИначеЕсли ИмяМетода = "ТекстОписаниеПартийПереданных" Тогда
		Возврат ТекстОписаниеПартийПереданных();
		
	ИначеЕсли ИмяМетода = "ТекстОписаниеПартийЗатрат" Тогда
		Возврат ТекстОписаниеПартийЗатрат();
		
	ИначеЕсли ИмяМетода = "ТекстОписаниеПартийПрочих" Тогда
		Возврат ТекстОписаниеПартийПрочих();
		
	ИначеЕсли ИмяМетода = "ТекстОписаниеСебестоимость" Тогда
		Возврат ТекстОписаниеСебестоимость();
		
	ИначеЕсли ИмяМетода = "ТекстОписаниеПартийРасходов" Тогда
		Возврат ТекстОписаниеПартийРасходов();
		
	ИначеЕсли ИмяМетода = "ТекстОписаниеДанныхДляПартийНДСКРаспределению" Тогда
		Возврат ТекстОписаниеДанныхДляПартийНДСКРаспределению();	
		
	ИначеЕсли ИмяМетода = "ТекстОписаниеДанныхДляПартийПроизводства" Тогда
		Возврат ТекстОписаниеДанныхДляПартийПроизводства();
		
	//++ НЕ УТ	
	ИначеЕсли ИмяМетода = "ТекстОписаниеРаспределениеМатериаловИРабот" Тогда
		Возврат ТекстОписаниеРаспределениеМатериаловИРабот();
		
	ИначеЕсли ИмяМетода = "ТекстОписаниеДанныхДляПартийНЗП" Тогда
		Возврат ТекстОписаниеДанныхДляПартийНЗП();
		
	ИначеЕсли ИмяМетода = "ТекстОписаниеДанныхДляТрудозатратНЗП" Тогда
		Возврат ТекстОписаниеДанныхДляТрудозатратНЗП();
		
	ИначеЕсли ИмяМетода = "ТекстОписаниеДанныхДляПрочихРасходовНЗППоБазе" Тогда
		Возврат ТекстОписаниеДанныхДляПрочихРасходовНЗППоЭтапамПОБазе();
		
	ИначеЕсли ИмяМетода = "ТекстОписаниеДанныхДляПрочихРасходовНЗП" Тогда
		Возврат ТекстОписаниеДанныхДляПрочихРасходовНЗП();	
	//-- НЕ УТ
		
	КонецЕсли;
	Возврат Неопределено;
КонецФункции

Функция ВыгрузитьИзВременнойТаблицы(МВТ)
	Запрос = Новый Запрос("
	|ВЫБРАТЬ
	|	*
	|ИЗ
	|	Данные КАК ДД
	|");
	Запрос.МенеджерВременныхТаблиц = МВТ;
	Возврат Запрос.Выполнить().Выгрузить();
КонецФункции

Функция ТестДанныеДляПартий(ИмяМетода, НачалоПериода, ОкончаниеПериода, Организация = Неопределено) Экспорт
	
	МассивОрганизаций = РасчетСебестоимостиПрикладныеАлгоритмы.СвязиОрганизацийПоСхемеИнтеркампани(ОкончаниеПериода, Организация);
	
	Если ИмяМетода = "ДанныеДляПартийТоваров" Тогда
		Возврат ВыгрузитьИзВременнойТаблицы(ДанныеДляПартийТоваров(НачалоПериода, ОкончаниеПериода, МассивОрганизаций));
		
	ИначеЕсли ИмяМетода = "ДанныеДляПартийПереданных" Тогда
		Возврат ВыгрузитьИзВременнойТаблицы(ДанныеДляПартийПереданных(НачалоПериода, ОкончаниеПериода, МассивОрганизаций));
		
	ИначеЕсли ИмяМетода = "ДанныеДляПартийЗатрат" Тогда
		Возврат ВыгрузитьИзВременнойТаблицы(ДанныеДляПартийЗатрат(НачалоПериода, ОкончаниеПериода, МассивОрганизаций));
		
	ИначеЕсли ИмяМетода = "ДанныеДляПартийПрочих" Тогда
		Возврат ДанныеДляПартийПрочих(НачалоПериода, ОкончаниеПериода, МассивОрганизаций);
		
	ИначеЕсли ИмяМетода = "ДанныеДляПартийПрочихСебестоимость" Тогда
		Возврат ДанныеДляПартийПрочихСебестоимость(НачалоПериода, ОкончаниеПериода, МассивОрганизаций);
		
	ИначеЕсли ИмяМетода = "ДанныеДляПартийРасходов" Тогда
		Возврат ВыгрузитьИзВременнойТаблицы(ДанныеДляПартийРасходов(НачалоПериода, ОкончаниеПериода, МассивОрганизаций));
		
	ИначеЕсли ИмяМетода = "ДанныеДляПартийНДСКРаспределению" Тогда
		Возврат ДанныеДляПартийНДСКРаспределению(НачалоПериода, ОкончаниеПериода, МассивОрганизаций);	
		
	ИначеЕсли ИмяМетода = "ДанныеДляПартийПроизводства" Тогда
		Возврат ВыгрузитьИзВременнойТаблицы(ДанныеДляПартийПроизводства(НачалоПериода, ОкончаниеПериода, МассивОрганизаций));
		
	//++ НЕ УТ	
	ИначеЕсли ИмяМетода = "ДанныеДляРаспределенияМатериаловИРабот" Тогда
		Возврат ДанныеДляРаспределенияМатериаловИРабот(НачалоПериода, ОкончаниеПериода, МассивОрганизаций).Выгрузить();	
		
	ИначеЕсли ИмяМетода = "ДанныеДляПартийНЗП" Тогда
		Возврат ВыгрузитьИзВременнойТаблицы(ДанныеДляПартийНЗП(НачалоПериода, ОкончаниеПериода, МассивОрганизаций));
		
	ИначеЕсли ИмяМетода = "ДанныеДляТрудозатратНЗП" Тогда
		Возврат ВыгрузитьИзВременнойТаблицы(ДанныеДляТрудозатратНЗП(НачалоПериода, ОкончаниеПериода, МассивОрганизаций));
		
	ИначеЕсли ИмяМетода = "ДанныеДляПрочихРасходовНЗППоБазе" Тогда
		
		ДанныеДляРасходовКРаспределению = ДанныеДляРасходовКРаспределению(НачалоПериода, ОкончаниеПериода, МассивОрганизаций);
		РасчетныеРасходыКРаспределению = РасчетныеРасходыКРаспределению(ДанныеДляРасходовКРаспределению, Неопределено);
		ДанныеДляПрочихРасходовНЗППоПодразделениямПоБазе = 
			ДанныеДляПрочихРасходовНЗППоПодразделениямПоБазе(НачалоПериода, ОкончаниеПериода, МассивОрганизаций, РасчетныеРасходыКРаспределению);
		Регистраторы = Регистраторы(НачалоПериода, ОкончаниеПериода, МассивОрганизаций, "ПрочиеРасходыНезавершенногоПроизводства");
		РасчетныеПрочиеРасходыНЗППоПодразделениямПоБазе = 
			РасчетныеПрочиеРасходыНЗППоПодразделениямПоБазе(ДанныеДляПрочихРасходовНЗППоПодразделениямПоБазе, Регистраторы);
		ДанныеДляПрочихРасходовНЗППоПодразделениямПоБазе = Неопределено;
		Регистраторы= Неопределено;
		Возврат ДанныеДляПрочихРасходовНЗППоЭтапамПоБазе(НачалоПериода,
														 ОкончаниеПериода,
														 МассивОрганизаций,
														 РасчетныеРасходыКРаспределению,
														 РасчетныеПрочиеРасходыНЗППоПодразделениямПоБазе).Выгрузить();
		
	ИначеЕсли ИмяМетода = "ДанныеДляПрочихРасходовНЗП" Тогда
		Возврат ВыгрузитьИзВременнойТаблицы(ДанныеДляПрочихРасходовНЗП(НачалоПериода, ОкончаниеПериода, МассивОрганизаций));
		
	ИначеЕсли ИмяМетода = "ДанныеДляСебестоимостиПроизводства" Тогда
		Возврат ВыгрузитьИзВременнойТаблицы(ДанныеДляСебестоимостиПроизводства(НачалоПериода, ОкончаниеПериода, МассивОрганизаций));
	//-- НЕ УТ

	КонецЕсли;
	
	Возврат Неопределено;
	
КонецФункции

//++ НЕ УТ

Функция ВыборкаИзТаблицы(ДанныеДляПартий)
	Запрос = Новый Запрос("
	|ВЫБРАТЬ
	|	*
	|ПОМЕСТИТЬ
	|	ДанныеДляПартий
	|ИЗ
	|	&ДанныеДляПартий КАК ДанныеДляПартий
	|;
	|ВЫБРАТЬ
	|	*
	|ИЗ
	|	ДанныеДляПартий КАК ДанныеДляПартий
	|");
	Запрос.УстановитьПараметр("ДанныеДляПартий", ДанныеДляПартий);
	Возврат Запрос.Выполнить();
КонецФункции
//-- НЕ УТ

Функция ЗагрузитьВоВременнуюТаблицу(ДанныеДляПартий)
	Запрос = Новый Запрос("
	|ВЫБРАТЬ
	|	*
	|ПОМЕСТИТЬ
	|	Данные
	|ИЗ
	|	&ДанныеДляПартий КАК ДД
	|ИНДЕКСИРОВАТЬ ПО
	|	ДД.К
	|");
	МВТ = Новый МенеджерВременныхТаблиц;
	Запрос.МенеджерВременныхТаблиц = МВТ;
	Запрос.УстановитьПараметр("ДанныеДляПартий", ДанныеДляПартий);
	Запрос.Выполнить();
	Возврат МВТ;
КонецФункции

Функция ТестРасчетныеПартии(ИмяМетода, ДанныеДляПартий, ВнутренниеДанные = Неопределено) Экспорт
	Если ИмяМетода = "РасчетныеПартииТоваров" Тогда
		МВТ = ЗагрузитьВоВременнуюТаблицу(ДанныеДляПартий);
		РасчетныеПартии = РасчетныеПартииТоваров(МВТ, Неопределено, ВнутренниеДанные, Истина);
		ДанныеДляПартий = ВыгрузитьИзВременнойТаблицы(МВТ); 
		Возврат РасчетныеПартии;
		
	ИначеЕсли ИмяМетода = "РасчетныеПартииПереданные" Тогда
		МВТ = ЗагрузитьВоВременнуюТаблицу(ДанныеДляПартий);
		РасчетныеПартии = РасчетныеПартииПереданные(МВТ, Неопределено, ВнутренниеДанные, Истина);
		ДанныеДляПартий = ВыгрузитьИзВременнойТаблицы(МВТ); 
		Возврат РасчетныеПартии;
		
	ИначеЕсли ИмяМетода = "РасчетныеПартииЗатрат" Тогда
		МВТ = ЗагрузитьВоВременнуюТаблицу(ДанныеДляПартий);
		РасчетныеПартии = РасчетныеПартииЗатрат(МВТ, Неопределено, ВнутренниеДанные, Истина);
		ДанныеДляПартий = ВыгрузитьИзВременнойТаблицы(МВТ); 
		Возврат РасчетныеПартии;
		
	ИначеЕсли ИмяМетода = "РасчетныеПартииПрочих" Тогда
		Возврат РасчетныеПартииПрочих(ДанныеДляПартий, Неопределено, ВнутренниеДанные, Истина);
		
	ИначеЕсли ИмяМетода = "РасчетныеПриходыПартийРасходов" Тогда
		Возврат РасчетныеПриходыПартийРасходов(ДанныеДляПартий, Неопределено, ВнутренниеДанные, Истина);
		
	ИначеЕсли ИмяМетода = "РасчетныеПриходыСебестоимости" Тогда
		Возврат РасчетныеПриходыСебестоимости(Дата(1,1,1), ДанныеДляПартий, Неопределено, ВнутренниеДанные, Истина);
		
	ИначеЕсли ИмяМетода = "РасчетныеПартииРасходов" Тогда
		МВТ = ЗагрузитьВоВременнуюТаблицу(ДанныеДляПартий);
		РасчетныеПартии = РасчетныеПартииРасходов(МВТ, Неопределено, ВнутренниеДанные, Истина);
		ДанныеДляПартий = ВыгрузитьИзВременнойТаблицы(МВТ); 
		Возврат РасчетныеПартии;
		
	ИначеЕсли ИмяМетода = "РасчетныеПартииПроизводства" Тогда
		Возврат РасчетныеПартииПроизводства(ЗагрузитьВоВременнуюТаблицу(ДанныеДляПартий), Неопределено, ВнутренниеДанные, Истина);
		
	//++ НЕ УТ	
	ИначеЕсли ИмяМетода = "РасчетноеРаспределениеМатериаловИРабот" Тогда
		Возврат РасчетноеРаспределениеМатериаловИРабот(ВыборкаИзТаблицы(ДанныеДляПартий), Неопределено, ВнутренниеДанные, Истина);
		
	ИначеЕсли ИмяМетода = "РасчетныеПартииНЗП" Тогда
		Возврат РасчетныеПартииНЗП(ЗагрузитьВоВременнуюТаблицу(ДанныеДляПартий), Неопределено, ВнутренниеДанные, Истина);
		
	ИначеЕсли ИмяМетода = "РасчетныеТрудозатратыНЗП" Тогда
		Возврат РасчетныеТрудозатратыНЗП(ЗагрузитьВоВременнуюТаблицу(ДанныеДляПартий), Неопределено, ВнутренниеДанные, Истина);
		
	ИначеЕсли ИмяМетода = "РасчетныеПрочиеРасходыНЗППоБазе" Тогда
		Возврат РасчетныеПрочиеРасходыНЗППоЭтапамПоБазе(ВыборкаИзТаблицы(ДанныеДляПартий), Неопределено, ВнутренниеДанные, Истина);
		
	ИначеЕсли ИмяМетода = "РасчетныеПрочиеРасходыНЗП" Тогда
		Возврат РасчетныеПрочиеРасходыНЗП(ЗагрузитьВоВременнуюТаблицу(ДанныеДляПартий), Неопределено, ВнутренниеДанные, Истина);
	//-- НЕ УТ	
		
	КонецЕсли;
	Возврат Неопределено;
КонецФункции

Функция ТестРассчитать(ИмяМетода, НачалоПериода, ОкончаниеПериода, Организация = Неопределено) Экспорт
	Перем РасчетныеПартии;
	
	МассивОрганизаций = РасчетСебестоимостиПрикладныеАлгоритмы.СвязиОрганизацийПоСхемеИнтеркампани(ОкончаниеПериода, Организация);
	
	Если ИмяМетода = "РассчитатьПартииТоваров" Тогда
		РассчитатьПартииТоваров(НачалоПериода, ОкончаниеПериода, МассивОрганизаций);
		
	ИначеЕсли ИмяМетода = "РассчитатьПартииПереданные" Тогда
		РассчитатьПартииПереданные(НачалоПериода, ОкончаниеПериода, МассивОрганизаций);
		
	ИначеЕсли ИмяМетода = "РассчитатьПартииЗатрат" Тогда
		РассчитатьПартииЗатрат(НачалоПериода, ОкончаниеПериода, МассивОрганизаций);
		
	ИначеЕсли ИмяМетода = "РассчитатьПартииПрочих" Тогда
		РассчитатьПартииПрочих(НачалоПериода, ОкончаниеПериода, МассивОрганизаций);
		
	ИначеЕсли ИмяМетода = "РассчитатьПартииРасходов" Тогда
		РассчитатьПартииРасходов(НачалоПериода, ОкончаниеПериода, МассивОрганизаций);
		
	ИначеЕсли ИмяМетода = "РассчитатьПартииПроизводства" Тогда
		РассчитатьПартииПроизводства(НачалоПериода, ОкончаниеПериода, МассивОрганизаций);		
		
	//++ НЕ УТ
	ИначеЕсли ИмяМетода = "РассчитатьПартииНЗП" Тогда
		РассчитатьПартииНЗП(НачалоПериода, ОкончаниеПериода, МассивОрганизаций);
		
	ИначеЕсли ИмяМетода = "РассчитатьТрудозатраты" Тогда
		РассчитатьТрудозатраты(НачалоПериода, ОкончаниеПериода, МассивОрганизаций);
		
	ИначеЕсли ИмяМетода = "РаспределитьПрочиеРасходыПоБазе" Тогда
		РаспределитьПрочиеРасходыПоБазе(НачалоПериода, ОкончаниеПериода, МассивОрганизаций);
		
	ИначеЕсли ИмяМетода = "РассчитатьПрочиеРасходыНЗП" Тогда
		РассчитатьПрочиеРасходыНЗП(НачалоПериода, ОкончаниеПериода, МассивОрганизаций);
		
	ИначеЕсли ИмяМетода = "РассчитатьСебестоимостьПроизводства" Тогда
		РассчитатьСебестоимостьПроизводства(НачалоПериода, ОкончаниеПериода, МассивОрганизаций);
	//-- НЕ УТ
	
	КонецЕсли;
	
	Возврат РасчетныеПартии;
	
КонецФункции

Процедура ТестЗаписатьРасчет(МенеджерРегистра, РасчетныеПартии) Экспорт
	ЗаписатьРасчетныеПартии(МенеджерРегистра, РасчетныеПартии, Неопределено);
КонецПроцедуры

Функция ТестРассчитатьЦепочкиДвижений(ИмяМетода, НачалоПериода, ОкончаниеПериода, Организация = Неопределено, ВнутренниеДанные = Неопределено) Экспорт
	Перем РасчетныеПартии;
	
	МассивОрганизаций = РасчетСебестоимостиПрикладныеАлгоритмы.СвязиОрганизацийПоСхемеИнтеркампани(ОкончаниеПериода, Организация);
	
	Если ИмяМетода = "ПартииТоваров" Тогда
		ДанныеДляПартийТоваров = ДанныеДляПартийТоваров(НачалоПериода, ОкончаниеПериода, МассивОрганизаций);
		РасчетныеПартии = РасчетныеПартииТоваров(ДанныеДляПартийТоваров, Неопределено, ВнутренниеДанные, Истина, Ложь);
	ИначеЕсли ИмяМетода = "ПартииЗатрат" Тогда
		ДанныеДляПартийЗатрат = ДанныеДляПартийЗатрат(НачалоПериода, ОкончаниеПериода, МассивОрганизаций);
		РасчетныеПартии = РасчетныеПартииЗатрат(ДанныеДляПартийЗатрат, Неопределено, ВнутренниеДанные, Истина, Ложь);
	ИначеЕсли ИмяМетода = "ПартииРасходов" Тогда
		ДанныеДляПартийРасходов = ДанныеДляПартийРасходов(НачалоПериода, ОкончаниеПериода, МассивОрганизаций);
		РасчетныеПартии = РасчетныеПартииРасходов(ДанныеДляПартийРасходов, Неопределено, ВнутренниеДанные, Истина, Ложь);
	//++ НЕ УТ
	ИначеЕсли ИмяМетода = "ПартииНЗП" Тогда
		ДанныеДляПартийНЗП = ДанныеДляПартийНЗП(НачалоПериода, ОкончаниеПериода, МассивОрганизаций);
		РасчетныеПартии = РасчетныеПартииНЗП(ДанныеДляПартийНЗП, Неопределено, ВнутренниеДанные, Истина, Ложь);
	//-- НЕ УТ
	КонецЕсли;
	Возврат РасчетныеПартии;
КонецФункции

// Позволяет отключить все операции записи регистров накопления (для тестирования расчета).
//
Функция ТестированиеБезЗаписи()
	Возврат Ложь;
КонецФункции

#КонецОбласти


#Область КорректировкаОстатков

#Область СебестоимостьТоваров

Процедура КорректировкаНачальныхОстатковРегистраСебестоимостьТоваров(НачалоПериода, МассивОрганизаций, ПартионныйУчетВключен)
	
	// Инициализация параметров расчета.
	МетаданныеРегистра = Метаданные.РегистрыНакопления.СебестоимостьТоваров;
	
	ПараметрыРасчета = РасчетСебестоимостиПрикладныеАлгоритмы.ИнициализироватьОсновныеПараметрыРасчета(НачалоПериода, КонецМесяца(НачалоПериода), МассивОрганизаций);
	РасчетСебестоимостиПрикладныеАлгоритмы.УстановитьТехнологическиеПараметрыРасчета(ПараметрыРасчета);
	
	ПараметрыРасчета.Вставить("ОрганизацииСОстаткамиПоСебестоимости",
		РасчетСебестоимостиПрикладныеАлгоритмы.ОрганизацииСОстаткамиПоСебестоимости(НачалоПериода, МассивОрганизаций));
	
	ПараметрыРасчета.Вставить("ПартионныйУчетВключен",   ПартионныйУчетВключен);
	ПараметрыРасчета.Вставить("МенеджерВременныхТаблиц", Новый МенеджерВременныхТаблиц);
	ПараметрыРасчета.Вставить("НомерЗаданияДоРасчета", 	 -1);
	
	ПараметрыРасчета.Вставить("РегистрыСРасчетнымиОборотами", Новый Структура);
	ПараметрыРасчета.Вставить("РегистрыСРасчетнымиОстатками", Новый Структура);
	ПараметрыРасчета.Вставить("Движения", 					  Новый Структура);
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ИнициализироватьДанныеРегистра(ПараметрыРасчета, МетаданныеРегистра);
	ИнициализироватьДокументыРасчетаСебестоимостиПрошлогоПериода(ПараметрыРасчета);
		
	// Инициализация параметров корректировки.
	ПараметрыКорректировки = ИнициализироватьКорректировкуОстатковРегистра(ПараметрыРасчета, МетаданныеРегистра.ПолноеИмя());
		
	КорректировкаВключитьУчетПоВидамЗапасовСебестоимостьТоваров(ПараметрыРасчета, ПараметрыКорректировки);
	
	Если РасчетСебестоимостиПовтИсп.СебестоимостьТоваровПоНазначениям(НачалоПериода) Тогда
		Если РасчетСебестоимостиПовтИсп.ДатаВключенияОбособленногоУчетаСебестоимостиПоНазначениям() = НачалоПериода Тогда
			КорректировкаВключитьУчетПоНазначениямСебестоимостьТоваров(ПараметрыРасчета, ПараметрыКорректировки);
		КонецЕсли;
	Иначе
		КорректировкаОтключитьУчетПоНазначениямСебестоимостьТоваров(ПараметрыРасчета, ПараметрыКорректировки);
	КонецЕсли;
	
	ЗавершитьКорректировкуОстатковРегистра(ПараметрыРасчета, ПараметрыКорректировки);
	
КонецПроцедуры

Процедура КорректировкаВключитьУчетПоВидамЗапасовСебестоимостьТоваров(ПараметрыРасчета, ПараметрыКорректировки)
	
	НачатьСледующуюКорректировкуОстатковРегистра(
		ПараметрыРасчета,
		ПараметрыКорректировки,
		Перечисления.ТипыЗаписейПартий.СлужебноеВключитьУчетПоВидамЗапасов,
		Истина);
	
	Если НЕ ПараметрыКорректировки.ТребуетсяКорректировка Тогда
		Возврат;
	КонецЕсли;
	
	#Область ПодготовкаДанных
	
	ОписаниеАналитики = СформироватьОписаниеКлючейАналитикУчетаНоменклатуры(, "Назначение");
	
	Запрос = Новый Запрос;
	ИнициализироватьСвойстваЗапроса(Запрос, ПараметрыРасчета);
	
	// Выберем данные для распределения
	
	Запрос.Текст = ТекстЗапросаКорректировкиПолучитьДанныеПартионныхРегистров(); // ВТОстаткиПартионныхРегистровПредварительная для ФИФО скользящая
	
	Запрос.Выполнить();
	
	Запрос.Текст =
	"ВЫБРАТЬ
	|	&ИзмеренияРегистра,
	|	&РесурсыРегистра,
	|	&ПоляАналитикиИменованные
	|ПОМЕСТИТЬ ВТОстаткиСебестоимостиБезВидовЗапасов
	|ИЗ
	|	ВТРасчетныеНачальныеОстаткиСебестоимостьТоваров КАК Т
	|ГДЕ
	|	Т.ВидЗапасов = ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка)
	|	И Т.Организация В (&МассивОрганизаций)
	|	И Т.АналитикаУчетаНоменклатуры.Номенклатура.ТипНоменклатуры <> ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.Работа)
	|	И НЕ (Т.РазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыНаСкладах)
	|		  И Т.АналитикаУчетаНоменклатуры.ТипМестаХранения В
	|			(ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Партнер),
	|			 ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Организация)))
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Т.Организация						КАК Организация,
	|	Т.АналитикаУчетаНоменклатуры		КАК АналитикаУчетаНоменклатуры,
	|	Т.ВидЗапасов						КАК ВидЗапасов,
	|	ВЫБОР
	|		КОГДА Т.ВидЗапасов.ТипЗапасов = ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.КомиссионныйТовар)
	|			ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПринятыеНаКомиссию)
	|		КОГДА Т.ВидЗапасов.ТипЗапасов = ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.МатериалДавальца)
	|			ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.МатериалыПринятыеВПереработку)
	|		КОГДА Т.ВидЗапасов.ТипЗапасов = ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.ПолуфабрикатДавальца)
	|			ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПринятыеНаОтветхранение)
	|		КОГДА ЕСТЬNULL(Т.АналитикаУчетаНоменклатуры.СкладскаяТерритория.ЦеховаяКладовая, ЛОЖЬ)
	|			ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты)
	|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыНаСкладах)
	|	КОНЕЦ								КАК РазделУчета,
	|	Т.КоличествоОстаток					КАК Количество
	|ПОМЕСТИТЬ ВТОстаткиСВидамиЗапасовПредварительная
	|ИЗ
	|	РегистрНакопления.ТоварыОрганизаций.Остатки(&ГраницаКонецПредыдущегоПериода,
	|		Организация В (&ОрганизацииНеФИФОСкользящая)
	|	) КАК Т
	|ГДЕ
	|	Т.КоличествоОстаток > 0
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	Т.Организация						КАК Организация,
	|	Т.АналитикаУчетаНоменклатуры		КАК АналитикаУчетаНоменклатуры,
	|	Т.ВидЗапасов						КАК ВидЗапасов,
	|	ВЫБОР
	|		КОГДА Т.ВидЗапасов.ТипЗапасов = ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.КомиссионныйТовар)
	|			ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПринятыеНаКомиссию)
	|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПереданныеНаКомиссию)
	|	КОНЕЦ								КАК РазделУчета,
	|	Т.КоличествоОстаток					КАК Количество
	|ИЗ
	|	РегистрНакопления.ТоварыПереданныеНаКомиссию.Остатки(&ГраницаКонецПредыдущегоПериода,
	|		Организация В (&ОрганизацииНеФИФОСкользящая)
	|	) КАК Т
	|ГДЕ
	|	Т.КоличествоОстаток > 0
	|
	//++ НЕ УТ
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	Т.ВидЗапасов.Организация 			КАК Организация,
	|	Т.АналитикаУчетаНоменклатуры		КАК АналитикаУчетаНоменклатуры,
	|	Т.ВидЗапасов 						КАК ВидЗапасов,
	|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПереданныеПереработчику) КАК РазделУчета,
	|	Т.КоличествоОстаток КАК Количество
	|ИЗ
	|	РегистрНакопления.ТоварыПереданныеПереработчику.Остатки(&ГраницаКонецПредыдущегоПериода,
	|		ВидЗапасов.Организация В (&ОрганизацииНеФИФОСкользящая)
	|	) КАК Т
	|ГДЕ
	|	Т.КоличествоОстаток > 0
	|
	//-- НЕ УТ
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	Т.ВидЗапасов.Организация			КАК Организация,
	|	Т.АналитикаУчетаНоменклатуры		КАК АналитикаУчетаНоменклатуры,
	|	Т.ВидЗапасов						ВидЗапасов,
	|	ВЫБОР
	|		КОГДА ЕСТЬNULL(Т.АналитикаУчетаНоменклатуры.СкладскаяТерритория.ЦеховаяКладовая, ЛОЖЬ)
	|			ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты)
	|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыНаСкладах)
	|	КОНЕЦ								КАК РазделУчета,
	|	Т.КоличествоОстаток					КАК Количество
	|ИЗ
	|	РегистрНакопления.ТоварыКОформлениюДокументовИмпорта.Остатки(&ГраницаКонецПредыдущегоПериода,
	|		ВидЗапасов.Организация В (&ОрганизацииНеФИФОСкользящая)
	|		И ТипДокументаИмпорта = &ТипДокументаИмпорта
	|	) КАК Т
	|ГДЕ
	|	Т.КоличествоОстаток > 0
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	Т.Организация						КАК Организация,
	|	Т.АналитикаУчетаНоменклатуры		КАК АналитикаУчетаНоменклатуры,
	|	Т.ВидЗапасов						ВидЗапасов,
	|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты) КАК РазделУчета,
	|	Т.КоличествоОстаток					КАК Количество
	|ИЗ
	|	РегистрНакопления.ПартииПроизводственныхЗатрат.Остатки(&ГраницаКонецПредыдущегоПериода,
	|		Организация В (&ОрганизацииНеФИФОСкользящая)
	|	) КАК Т
	|ГДЕ
	|	Т.КоличествоОстаток > 0
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ДокументРеализации.Организация														  КАК Организация,
	|	ЕСТЬNULL(АналитикаПереданнойНоменклатуры.КлючАналитики, Т.АналитикаУчетаНоменклатуры) КАК АналитикаУчетаНоменклатуры,
	|	Т.ВидЗапасов																		  КАК ВидЗапасов,
	|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыВПути) 				  КАК РазделУчета,
	|	Т.Количество																		  КАК Количество
	|ИЗ
	|	Документ.РеализацияТоваровУслуг.ВидыЗапасов КАК Т
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.РеализацияТоваровУслуг КАК ДокументРеализации
	|		ПО Т.Ссылка = ДокументРеализации.Ссылка
	|	ЛЕВОЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК Аналитика
	|		ПО Т.АналитикаУчетаНоменклатуры = Аналитика.Ссылка
	|	ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаНоменклатуры КАК АналитикаПереданнойНоменклатуры
	|	ПО Аналитика.Номенклатура = АналитикаПереданнойНоменклатуры.Номенклатура
	|		И Аналитика.Характеристика = АналитикаПереданнойНоменклатуры.Характеристика
	|		И ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка) = АналитикаПереданнойНоменклатуры.Назначение
	|		И ЗНАЧЕНИЕ(Справочник.СерииНоменклатуры.ПустаяСсылка) = АналитикаПереданнойНоменклатуры.Серия
	|		И ДокументРеализации.Партнер = АналитикаПереданнойНоменклатуры.МестоХранения
	//++ НЕ УТ 
	|		И ЗНАЧЕНИЕ(Справочник.СтатьиКалькуляции.ПустаяСсылка) = АналитикаПереданнойНоменклатуры.СтатьяКалькуляции
	//-- НЕ УТ
	|ГДЕ
	|	ДокументРеализации.Организация В (&ОрганизацииНеФИФОСкользящая)
	|	И ДокументРеализации.ХозяйственнаяОперация В (
	|		ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РеализацияБезПереходаПраваСобственности),
	|		ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РеализацияЧерезКомиссионераБезПереходаПраваСобственности))
	|	И ДокументРеализации.Проведен
	|	И ДокументРеализации.Дата < &НачалоПериода
	|	И ДокументРеализации.ДатаПереходаПраваСобственности >= &НачалоПериода
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Т.Организация,
	|	Т.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
	|	Т.ВидЗапасов,
	|	Т.РазделУчета,
	|	&ПоляАналитикиИменованные,
	|	СУММА(Т.Количество) КАК Количество
	|ПОМЕСТИТЬ ВТОстаткиСВидамиЗапасов
	|ИЗ
	|	ВТОстаткиСВидамиЗапасовПредварительная КАК Т
	|СГРУППИРОВАТЬ ПО
	|	Т.Организация,
	|	Т.АналитикаУчетаНоменклатуры,
	|	Т.ВидЗапасов,
	|	Т.РазделУчета,
	|	&ПоляАналитикиНеИменованные
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	Т.Организация,
	|	Т.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
	|	Т.ВидЗапасов,
	|	Т.РазделУчета,
	|	&ПоляАналитикиИменованные,
	|	СУММА(Т.Количество) КАК Количество
	|ИЗ
	|	ВТОстаткиПартионныхРегистровПредварительная КАК Т
	|СГРУППИРОВАТЬ ПО
	|	Т.Организация,
	|	Т.АналитикаУчетаНоменклатуры,
	|	Т.ВидЗапасов,
	|	Т.РазделУчета,
	|	&ПоляАналитикиНеИменованные
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ВТОстаткиСВидамиЗапасовПредварительная";
	
	РаспределяемыеИзмерения = РасчетСебестоимостиУниверсальныеАлгоритмы.УдалитьЭлементыИзСтрокиШаблона(
		ПараметрыКорректировки.ОписаниеРегистра.ИзмеренияРегистра,
		"%1ВидЗапасов");
		
	Запрос.Текст = СтрЗаменить(Запрос.Текст, "&ИзмеренияРегистра",
		СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(РаспределяемыеИзмерения, "Т."));
	Запрос.Текст = СтрЗаменить(Запрос.Текст, "&РесурсыРегистра",
		СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(ПараметрыКорректировки.ОписаниеРегистра.РесурсыРегистра, "Т."));
	Запрос.Текст = СтрЗаменить(Запрос.Текст, "&ПоляАналитикиИменованные",
		СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(ОписаниеАналитики.ПоляИменованные, "Т."));
	Запрос.Текст = СтрЗаменить(Запрос.Текст, "&ПоляАналитикиНеИменованные",
		СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(ОписаниеАналитики.ПоляНеИменованные, "Т."));

	Запрос.УстановитьПараметр("ТипДокументаИмпорта", ОбщегоНазначения.ИдентификаторОбъектаМетаданных("Документ.ТаможеннаяДекларацияИмпорт"));
	
	Запрос.Выполнить();
	
	#КонецОбласти 
	
	#Область РаспределениеДанных
	
	УчетПоНазначениям = РасчетСебестоимостиПовтИсп.СебестоимостьТоваровПоНазначениям(ПараметрыРасчета.РасчетныйПериод.НачалоПериода);
	
	// Инициализируем распределение
	ПараметрыРаспределения = РасчетСебестоимостиУниверсальныеАлгоритмы.ИнициализироватьПараметрыРаспределенияМетодомУменьшаемогоОстатка(
		"ВТОстаткиСебестоимостиБезВидовЗапасов",
		"ВТОстаткиСВидамиЗапасов",
		РасчетСебестоимостиУниверсальныеАлгоритмы.СоединитьСтроки("Организация, РазделУчета", ОписаниеАналитики.ПереченьПолей));
	
	РаспределяемыеРесурсы = РасчетСебестоимостиУниверсальныеАлгоритмы.УдалитьЭлементыИзСтрокиШаблона(
		ПараметрыКорректировки.ОписаниеРегистра.РесурсыРегистра,
		"%1Количество");
	
	РасчетСебестоимостиУниверсальныеАлгоритмы.ИнициализироватьЧисловыеПоляРаспределенияМетодомУменьшаемогоОстатка(
		ПараметрыРаспределения,
		СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(РаспределяемыеРесурсы, ""));
		
	РасчетСебестоимостиУниверсальныеАлгоритмы.ИнициализироватьПрочиеПоляРаспределенияМетодомУменьшаемогоОстатка(
		ПараметрыРаспределения,
		"Партия, АналитикаУчетаПартий, АналитикаФинансовогоУчета, ВидДеятельностиНДС, АналитикаУчетаНоменклатуры",
		"ВидЗапасов" + ?(УчетПоНазначениям, ", АналитикаУчетаНоменклатуры", ""));
		
	// Распределяем
	РасчетСебестоимостиУниверсальныеАлгоритмы.РаспределитьМетодомУменьшаемогоОстатка(Запрос.МенеджерВременныхТаблиц, ПараметрыРаспределения);
	
	Если НЕ УчетПоНазначениям Тогда
		ЕстьКорректировки = СформироватьАналитикиНоменклатурыБезНазначения(
			ПараметрыРасчета,
			"ВТРезультатРаспределения",
			"ВТРезультатРаспределенияСкорректированный");
	Иначе
		ЕстьКорректировки = Ложь;
	КонецЕсли;
	
	// Добавляем результаты распределения к корректировочным движениям
	ДобавитьКорректировочныеДвиженияРегистра(
		ПараметрыРасчета,
		ПараметрыКорректировки,
		?(ЕстьКорректировки, "ВТРезультатРаспределенияСкорректированный", "ВТРезультатРаспределения") + ", ВТНераспределенныеДанныеИсточника",
		"ВТОстаткиСебестоимостиБезВидовЗапасов",
		Истина,
		Истина);
	
	#КонецОбласти

КонецПроцедуры

Процедура КорректировкаВключитьУчетПоНазначениямСебестоимостьТоваров(ПараметрыРасчета, ПараметрыКорректировки)
	
	НачатьСледующуюКорректировкуОстатковРегистра(
		ПараметрыРасчета,
		ПараметрыКорректировки,
		Перечисления.ТипыЗаписейПартий.СлужебноеВключитьУчетПоНазначениям,
		Истина);
	
	Если НЕ ПараметрыКорректировки.ТребуетсяКорректировка Тогда
		Возврат;
	КонецЕсли;
	
	#Область ПодготовкаДанныхНеФИФОСкользящая
	
	ОписаниеАналитики = СформироватьОписаниеКлючейАналитикУчетаНоменклатуры(, "Назначение");
	
	Запрос = Новый Запрос;
	ИнициализироватьСвойстваЗапроса(Запрос, ПараметрыРасчета);
	
	// Выберем данные для распределения
	Запрос.Текст =
	"ВЫБРАТЬ
	|	&ИзмеренияРегистра,
	|	&РесурсыРегистра,
	|	&ПоляАналитикиИменованные
	|ПОМЕСТИТЬ ВТОстаткиСебестоимостиБезНазначений
	|ИЗ
	|	ВТРасчетныеНачальныеОстаткиСебестоимостьТоваров КАК Т
	|ГДЕ
	|	Т.АналитикаУчетаНоменклатуры.Назначение = ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка)
	|	И Т.Организация В (&ОрганизацииНеФИФОСкользящая)
	|	И Т.РазделУчета <> ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.НезавершенноеПроизводство)
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Ключи.Ссылка КАК Ссылка
	|ПОМЕСТИТЬ ВТАналитикиСНазначениями
	|ИЗ
	|	Справочник.КлючиАналитикиУчетаНоменклатуры КАК Ключи
	|ГДЕ
	|	Ключи.Назначение <> ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка)
	//++ НЕ УТ
	|	И Ключи.СтатьяКалькуляции = ЗНАЧЕНИЕ(Справочник.СтатьиКалькуляции.ПустаяСсылка)
	//-- НЕ УТ
	|ИНДЕКСИРОВАТЬ ПО
	|	Ссылка
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Т.Организация						КАК Организация,
	|	Т.АналитикаУчетаНоменклатуры		КАК АналитикаУчетаНоменклатуры,
	|	Т.ВидЗапасов 						КАК ВидЗапасов,
	|	ВЫБОР
	|		КОГДА Т.ВидЗапасов.ТипЗапасов = ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.КомиссионныйТовар)
	|			ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПринятыеНаКомиссию)
	|		КОГДА Т.ВидЗапасов.ТипЗапасов = ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.МатериалДавальца)
	|			ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.МатериалыПринятыеВПереработку)
	|		КОГДА Т.ВидЗапасов.ТипЗапасов = ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.ПолуфабрикатДавальца)
	|			ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПринятыеНаОтветхранение)
	|		КОГДА ЕСТЬNULL(Т.АналитикаУчетаНоменклатуры.СкладскаяТерритория.ЦеховаяКладовая, ЛОЖЬ)
	|			ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты)
	|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыНаСкладах)
	|	КОНЕЦ								КАК РазделУчета,
	|	Т.КоличествоОстаток					КАК Количество
	|ПОМЕСТИТЬ ВТОстаткиСНазначениямиПредварительная
	|ИЗ
	|	РегистрНакопления.ТоварыОрганизаций.Остатки(&ГраницаКонецПредыдущегоПериода,
	|		Организация В (&ОрганизацииНеФИФОСкользящая)
	|		И АналитикаУчетаНоменклатуры В (ВЫБРАТЬ Т.Ссылка ИЗ ВТАналитикиСНазначениями КАК Т)
	|	) КАК Т
	|ГДЕ
	|	Т.КоличествоОстаток > 0
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	Т.Организация						КАК Организация,
	|	Т.АналитикаУчетаНоменклатуры		КАК АналитикаУчетаНоменклатуры,
	|	Т.ВидЗапасов 						КАК ВидЗапасов,
	|	ВЫБОР
	|		КОГДА Т.ВидЗапасов.ТипЗапасов = ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.КомиссионныйТовар)
	|			ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПринятыеНаКомиссию)
	|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПереданныеНаКомиссию)
	|	КОНЕЦ								КАК РазделУчета,
	|	Т.КоличествоОстаток					КАК Количество
	|ИЗ
	|	РегистрНакопления.ТоварыПереданныеНаКомиссию.Остатки(&ГраницаКонецПредыдущегоПериода,
	|		Организация В (&ОрганизацииНеФИФОСкользящая)
	|		И АналитикаУчетаНоменклатуры В (ВЫБРАТЬ Т.Ссылка ИЗ ВТАналитикиСНазначениями КАК Т)
	|	) КАК Т
	|ГДЕ
	|	Т.КоличествоОстаток > 0
	|
	//++ НЕ УТ
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	Т.ВидЗапасов.Организация 			КАК Организация,
	|	Т.АналитикаУчетаНоменклатуры		КАК АналитикаУчетаНоменклатуры,
	|	Т.ВидЗапасов 						КАК ВидЗапасов,
	|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПереданныеПереработчику) КАК РазделУчета,
	|	Т.КоличествоОстаток КАК Количество
	|ИЗ
	|	РегистрНакопления.ТоварыПереданныеПереработчику.Остатки(&ГраницаКонецПредыдущегоПериода,
	|		ВидЗапасов.Организация В (&ОрганизацииНеФИФОСкользящая)
	|		И АналитикаУчетаНоменклатуры В (ВЫБРАТЬ Т.Ссылка ИЗ ВТАналитикиСНазначениями КАК Т)
	|	) КАК Т
	|ГДЕ
	|	Т.КоличествоОстаток > 0
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	Т.Организация 						КАК Организация,
	|	Т.АналитикаУчетаНоменклатуры		КАК АналитикаУчетаНоменклатуры,
	|	ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка) КАК ВидЗапасов,
	|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты) КАК РазделУчета,
	|	Т.КоличествоОстаток КАК Количество
	|ИЗ
	|	РегистрНакопления.ТоварыПолученныеОтПереработчика.Остатки(&ГраницаКонецПредыдущегоПериода,
	|		Организация В (&ОрганизацииНеФИФОСкользящая)
	|		И АналитикаУчетаНоменклатуры В (ВЫБРАТЬ Т.Ссылка ИЗ ВТАналитикиСНазначениями КАК Т)
	|	) КАК Т
	|ГДЕ
	|	Т.КоличествоОстаток > 0
	|
	//-- НЕ УТ
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	Т.ВидЗапасов.Организация			КАК Организация,
	|	Т.АналитикаУчетаНоменклатуры		КАК АналитикаУчетаНоменклатуры,
	|	Т.ВидЗапасов 						КАК ВидЗапасов,
	|	ВЫБОР
	|		КОГДА ЕСТЬNULL(Т.АналитикаУчетаНоменклатуры.СкладскаяТерритория.ЦеховаяКладовая, ЛОЖЬ)
	|			ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты)
	|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыНаСкладах)
	|	КОНЕЦ								КАК РазделУчета,
	|	Т.КоличествоОстаток					КАК Количество
	|ИЗ
	|	РегистрНакопления.ТоварыКОформлениюДокументовИмпорта.Остатки(&ГраницаКонецПредыдущегоПериода,
	|		ВидЗапасов.Организация В (&ОрганизацииНеФИФОСкользящая)
	|		И ТипДокументаИмпорта = &ТипДокументаИмпорта
	|		И АналитикаУчетаНоменклатуры В (ВЫБРАТЬ Т.Ссылка ИЗ ВТАналитикиСНазначениями КАК Т)
	|	) КАК Т
	|ГДЕ
	|	Т.КоличествоОстаток > 0
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Т.Организация,
	|	Т.АналитикаУчетаНоменклатуры,
	|	Т.ВидЗапасов,
	|	Т.РазделУчета,
	|	&ПоляАналитикиИменованные,
	|	СУММА(Т.Количество) КАК Количество
	|ПОМЕСТИТЬ ВТОстаткиСНазначениями
	|ИЗ
	|	ВТОстаткиСНазначениямиПредварительная КАК Т
	|СГРУППИРОВАТЬ ПО
	|	Т.Организация,
	|	Т.АналитикаУчетаНоменклатуры,
	|	Т.ВидЗапасов,
	|	Т.РазделУчета,
	|	&ПоляАналитикиНеИменованные
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Т.Организация,
	|	Т.Номенклатура КАК АналитикаУчетаНоменклатуры_Номенклатура,
	|	Т.Характеристика КАК АналитикаУчетаНоменклатуры_Характеристика,
	|	Т.Серия КАК АналитикаУчетаНоменклатуры_Серия,
	|	Т.Назначение КАК АналитикаУчетаНоменклатуры_Назначение,
	|	Т.Подразделение КАК АналитикаУчетаНоменклатуры_МестоХранения,
	|	&ПустаяСтатьяКалькуляции КАК АналитикаУчетаНоменклатуры_СтатьяКалькуляции,
	|	Т.КоличествоОстаток КАК Количество
	|ПОМЕСТИТЬ ВТОстаткиМатериалыИРаботыБезАналитик
	|ИЗ
	|	РегистрНакопления.МатериалыИРаботыВПроизводстве.Остатки(&ГраницаКонецПредыдущегоПериода,
	|		Организация В (&ОрганизацииНеФИФОСкользящая)
	|		И Назначение <> ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка)
	|	) КАК Т
	|ГДЕ
	|	Т.КоличествоОстаток > 0
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ВТОстаткиСНазначениямиПредварительная";
	
	Запрос.Текст = СтрЗаменить(Запрос.Текст, "&ИзмеренияРегистра",
		СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(ПараметрыКорректировки.ОписаниеРегистра.ИзмеренияРегистра, "Т."));
	Запрос.Текст = СтрЗаменить(Запрос.Текст, "&РесурсыРегистра",
		СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(ПараметрыКорректировки.ОписаниеРегистра.РесурсыРегистра, "Т."));
	Запрос.Текст = СтрЗаменить(Запрос.Текст, "&ПоляАналитикиИменованные",
		СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(ОписаниеАналитики.ПоляИменованные, "Т."));
	Запрос.Текст = СтрЗаменить(Запрос.Текст, "&ПоляАналитикиНеИменованные",
		СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(ОписаниеАналитики.ПоляНеИменованные, "Т."));
	
	Запрос.УстановитьПараметр("ПустаяСтатьяКалькуляции", "");
	//++ НЕ УТ
	Запрос.УстановитьПараметр("ПустаяСтатьяКалькуляции", Справочники.СтатьиКалькуляции.ПустаяСсылка());
	//-- НЕ УТ

	Запрос.УстановитьПараметр("ТипДокументаИмпорта", ОбщегоНазначения.ИдентификаторОбъектаМетаданных("Документ.ТаможеннаяДекларацияИмпорт"));
	
	Запрос.Выполнить();
	
	#КонецОбласти 
	
	#Область РаспределениеДанныхНеФИФОСкользящая
	
	// Инициализируем распределение
	ПараметрыРаспределения = РасчетСебестоимостиУниверсальныеАлгоритмы.ИнициализироватьПараметрыРаспределенияМетодомУменьшаемогоОстатка(
		"ВТОстаткиСебестоимостиБезНазначений",
		"ВТОстаткиСНазначениями",
		РасчетСебестоимостиУниверсальныеАлгоритмы.СоединитьСтроки("Организация, РазделУчета, ВидЗапасов", ОписаниеАналитики.ПереченьПолей));
		
	РасчетСебестоимостиУниверсальныеАлгоритмы.ИнициализироватьТаблицыРезультатовРаспределения(
		ПараметрыРаспределения,
		"ВТРезультатРаспределения",
		"НераспределенныеОстаткиСебестоимости");
		
	РаспределяемыеРесурсы = РасчетСебестоимостиУниверсальныеАлгоритмы.УдалитьЭлементыИзСтрокиШаблона(
		ПараметрыКорректировки.ОписаниеРегистра.РесурсыРегистра,
		"%1Количество");
	
	РасчетСебестоимостиУниверсальныеАлгоритмы.ИнициализироватьЧисловыеПоляРаспределенияМетодомУменьшаемогоОстатка(
		ПараметрыРаспределения,
		СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(РаспределяемыеРесурсы, ""));
		
	РасчетСебестоимостиУниверсальныеАлгоритмы.ИнициализироватьПрочиеПоляРаспределенияМетодомУменьшаемогоОстатка(
		ПараметрыРаспределения,
		СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(ПараметрыКорректировки.ОписаниеРегистра.ИзмеренияРегистра, ""),
		"АналитикаУчетаНоменклатуры");
	
	// Распределяем
	РасчетСебестоимостиУниверсальныеАлгоритмы.РаспределитьМетодомУменьшаемогоОстатка(Запрос.МенеджерВременныхТаблиц, ПараметрыРаспределения);
	
	ТребуетсяРаспределениеМатериаловИРабот =
		РасчетСебестоимостиПрикладныеАлгоритмы.РазмерВременнойТаблицы(ПараметрыРасчета, "ВТОстаткиМатериалыИРаботыБезАналитик") > 0
		И РасчетСебестоимостиПрикладныеАлгоритмы.РазмерВременнойТаблицы(ПараметрыРасчета, "НераспределенныеОстаткиСебестоимости") > 0;
	
	// Добавляем результаты распределения к корректировочным движениям
	ДобавитьКорректировочныеДвиженияРегистра(
		ПараметрыРасчета,
		ПараметрыКорректировки,
		"ВТРезультатРаспределения" + ?(ТребуетсяРаспределениеМатериаловИРабот, "", ", НераспределенныеОстаткиСебестоимости"),
		"ВТОстаткиСебестоимостиБезНазначений",
		Истина,
		Истина);
		
	#КонецОбласти
	
	#Область ПодготовкаДанныхМатериалыИРаботыНеФИФОСкользящая
	
	СформироватьАналитикиНоменклатурыПоЗначениямПолей(
		ПараметрыРасчета,
		"ВТОстаткиМатериалыИРаботыБезАналитик",
		"ВТОстаткиМатериалыИРаботыСАналитиками",
		"АналитикаУчетаНоменклатуры");
	
	#КонецОбласти
	
	#Область РаспределениеДанныхДанныхМатериалыИРаботыНеФИФОСкользящая
	
	Если ТребуетсяРаспределениеМатериаловИРабот Тогда
		
		// Инициализируем распределение
		ПараметрыРаспределения = РасчетСебестоимостиУниверсальныеАлгоритмы.ИнициализироватьПараметрыРаспределенияМетодомУменьшаемогоОстатка(
			"НераспределенныеОстаткиСебестоимости",
			"ВТОстаткиМатериалыИРаботыСАналитиками",
			РасчетСебестоимостиУниверсальныеАлгоритмы.СоединитьСтроки("Организация", ОписаниеАналитики.ПереченьПолей));
			
		РасчетСебестоимостиУниверсальныеАлгоритмы.ИнициализироватьЧисловыеПоляРаспределенияМетодомУменьшаемогоОстатка(
			ПараметрыРаспределения,
			СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(РаспределяемыеРесурсы, ""));
			
		РасчетСебестоимостиУниверсальныеАлгоритмы.ИнициализироватьПрочиеПоляРаспределенияМетодомУменьшаемогоОстатка(
			ПараметрыРаспределения,
			СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(ПараметрыКорректировки.ОписаниеРегистра.ИзмеренияРегистра, ""),
			"АналитикаУчетаНоменклатуры");
			
		// Распределяем
		РасчетСебестоимостиУниверсальныеАлгоритмы.РаспределитьМетодомУменьшаемогоОстатка(Запрос.МенеджерВременныхТаблиц, ПараметрыРаспределения);
		
		// Добавляем результаты распределения к корректировочным движениям
		ДобавитьКорректировочныеДвиженияРегистра(
			ПараметрыРасчета,
			ПараметрыКорректировки,
			"ВТРезультатРаспределения, ВТНераспределенныеДанныеИсточника",
			,
			Истина);
		
	КонецЕсли;
	
	#КонецОбласти

	#Область ПодготовкаДанныхФИФОСкользящая
	
	Запрос.Текст = ТекстЗапросаКорректировкиПолучитьДанныеПартионныхРегистров();
	
	Запрос.Выполнить();
	
	ЕстьКорректировки = СформироватьАналитикиНоменклатурыБезНазначения(
		ПараметрыРасчета,
		"ВТОстаткиПартионныхРегистровПредварительная",
		"ВТОстаткиСебестоимостиБезНазначений");
		
	Если ЕстьКорректировки Тогда
		
		// Добавляем результаты распределения к корректировочным движениям
		ДобавитьКорректировочныеДвиженияРегистра(
			ПараметрыРасчета,
			ПараметрыКорректировки,
			"ВТОстаткиПартионныхРегистровПредварительная",
			"ВТОстаткиСебестоимостиБезНазначений",
			Истина,
			Истина);
		
	КонецЕсли;
	
	#КонецОбласти

КонецПроцедуры

Процедура КорректировкаОтключитьУчетПоНазначениямСебестоимостьТоваров(ПараметрыРасчета, ПараметрыКорректировки)
	
	НачатьСледующуюКорректировкуОстатковРегистра(
		ПараметрыРасчета,
		ПараметрыКорректировки,
		Перечисления.ТипыЗаписейПартий.СлужебноеОтключитьУчетПоНазначениям,
		Истина);
	
	Если НЕ ПараметрыКорректировки.ТребуетсяКорректировка Тогда
		Возврат;
	КонецЕсли;
	
	#Область ПодготовкаДанных
	
	Запрос = Новый Запрос;
	ИнициализироватьСвойстваЗапроса(Запрос, ПараметрыРасчета);
	
	// Выберем данные для корректировки
	Запрос.Текст =
	"ВЫБРАТЬ
	|	&ИзмеренияРегистра,
	|	&РесурсыРегистра
	|ПОМЕСТИТЬ ВТОстаткиСебестоимостиСНазначением
	|ИЗ
	|	ВТРасчетныеНачальныеОстаткиСебестоимостьТоваров КАК Т
	|ГДЕ
	|	Т.АналитикаУчетаНоменклатуры.Назначение <> ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка)";
	
	Запрос.Текст = СтрЗаменить(Запрос.Текст, "&ИзмеренияРегистра",
		СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(ПараметрыКорректировки.ОписаниеРегистра.ИзмеренияРегистра, "Т."));
	Запрос.Текст = СтрЗаменить(Запрос.Текст, "&РесурсыРегистра",
		СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(ПараметрыКорректировки.ОписаниеРегистра.РесурсыРегистра, "Т."));
	
	Запрос.Выполнить();
	
	ЕстьКорректировки = СформироватьАналитикиНоменклатурыБезНазначения(
		ПараметрыРасчета,
		"ВТОстаткиСебестоимостиСНазначением",
		"ВТОстаткиСебестоимостиБезНазначения");
	
	Если НЕ ЕстьКорректировки Тогда
		Возврат;
	КонецЕсли;
	
	#КонецОбласти 
	
	// Добавляем результаты распределения к корректировочным движениям
	ДобавитьКорректировочныеДвиженияРегистра(
		ПараметрыРасчета,
		ПараметрыКорректировки,
		"ВТОстаткиСебестоимостиБезНазначения",
		"ВТОстаткиСебестоимостиСНазначением",
		Истина,
		Истина);
	
КонецПроцедуры

Функция ТекстЗапросаКорректировкиПолучитьДанныеПартионныхРегистров()
	
	ТекстЗапроса =
	"ВЫБРАТЬ
	|	Т.Организация,
	|	Т.АналитикаУчетаНоменклатуры,
	|	Т.ВидЗапасов,
	|	Т.ДокументПоступления,
	|	Т.АналитикаУчетаПартий,
	|	Т.КоличествоОстаток,
	|	Т.СтоимостьОстаток,
	|	Т.СтоимостьБезНДСОстаток,
	|	Т.ПостояннаяРазницаОстаток,
	|	Т.ВременнаяРазницаОстаток,
	|	ВЫБОР
	|		КОГДА Т.АналитикаУчетаПартий.НалогообложениеНДС В
	|		  (ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаНеОблагаетсяНДС),
	|		   ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаОблагаетсяЕНВД))
	|			 ТОГДА Т.СтоимостьРеглОстаток + Т.НДСРеглОстаток
	|		ИНАЧЕ Т.СтоимостьРеглОстаток
	|	КОНЕЦ КАК СтоимостьРеглОстаток
	|ПОМЕСТИТЬ ВТОстаткиПартииТоваровОрганизаций
	|ИЗ
	|	РегистрНакопления.ПартииТоваровОрганизаций.Остатки(&ГраницаКонецПредыдущегоПериода,
	|		Организация В (&ОрганизацииФИФОСкользящая)) КАК Т
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Т.Организация,
	|	Т.АналитикаУчетаНоменклатуры,
	|	Т.ВидЗапасов,
	|	Т.ДокументПоступления,
	|	Т.АналитикаУчетаПартий,
	|	Т.КоличествоОстаток,
	|	Т.СтоимостьОстаток,
	|	Т.СтоимостьБезНДСОстаток,
	|	Т.ПостояннаяРазницаОстаток,
	|	Т.ВременнаяРазницаОстаток,
	|	ВЫБОР
	|		КОГДА Т.АналитикаУчетаПартий.НалогообложениеНДС В
	|		  (ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаНеОблагаетсяНДС),
	|		   ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаОблагаетсяЕНВД))
	|			 ТОГДА Т.СтоимостьРеглОстаток + Т.НДСРеглОстаток
	|		ИНАЧЕ Т.СтоимостьРеглОстаток
	|	КОНЕЦ КАК СтоимостьРеглОстаток
	|ПОМЕСТИТЬ ВТОстаткиПартииТоваровПереданныеНаКомиссию
	|ИЗ
	|	РегистрНакопления.ПартииТоваровПереданныеНаКомиссию.Остатки(&ГраницаКонецПредыдущегоПериода,
	|		Организация В (&ОрганизацииФИФОСкользящая)) КАК Т
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Т.Организация,
	|	Т.АналитикаУчетаНоменклатуры,
	|	Т.ВидЗапасов,
	|	Т.ДокументПоступления,
	|	Т.СтатьяРасходов,
	|	Т.СтоимостьОстаток,
	|	Т.СтоимостьБезНДСОстаток,
	|	Т.СтоимостьРеглОстаток,
	|	Т.ПостояннаяРазницаОстаток,
	|	Т.ВременнаяРазницаОстаток,
	|	ВЫБОР
	|		КОГДА Т.АналитикаУчетаПартий.НалогообложениеНДС В
	|		  (ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаНеОблагаетсяНДС),
	|		   ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаОблагаетсяЕНВД))
	|			 ТОГДА Т.СтоимостьРеглОстаток + Т.НДСРеглОстаток
	|		ИНАЧЕ Т.СтоимостьРеглОстаток
	|	КОНЕЦ КАК СтоимостьРеглОстаток
	|ПОМЕСТИТЬ ВТОстаткиПартииРасходовНаСебестоимостьТоваров
	|ИЗ
	|	РегистрНакопления.ПартииРасходовНаСебестоимостьТоваров.Остатки(&ГраницаКонецПредыдущегоПериода,
	|		Организация В (&ОрганизацииФИФОСкользящая)) КАК Т
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Т.Организация,
	|	Т.АналитикаУчетаПродукции,
	|	Т.ДокументВыпуска,
	|	Т.КоличествоОстаток,
	|	Т.СтоимостьОстаток,
	|	Т.СтоимостьБезНДСОстаток,
	|	Т.ПостояннаяРазницаОстаток,
	|	Т.ВременнаяРазницаОстаток,
	|	ВЫБОР
	|		КОГДА Т.АналитикаУчетаПартий.НалогообложениеНДС В
	|		  (ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаНеОблагаетсяНДС),
	|		   ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаОблагаетсяЕНВД))
	|			 ТОГДА Т.СтоимостьРеглОстаток + Т.НДСРеглОстаток
	|		ИНАЧЕ Т.СтоимостьРеглОстаток
	|	КОНЕЦ КАК СтоимостьРеглОстаток
	|ПОМЕСТИТЬ ВТОстаткиПартииЗатратНаВыпуск
	|ИЗ
	|	РегистрНакопления.ПартииЗатратНаВыпуск.Остатки(&ГраницаКонецПредыдущегоПериода,
	|		Организация В (&ОрганизацииФИФОСкользящая)
	|		И АналитикаУчетаПродукции <> ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка)) КАК Т
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Т.Организация,
	|	Т.АналитикаУчетаНоменклатуры,
	|	Т.ВидЗапасов,
	|	Т.ДокументПоступления,
	|	Т.АналитикаУчетаПартий,
	|	Т.КоличествоОстаток,
	|	Т.СтоимостьОстаток,
	|	Т.СтоимостьБезНДСОстаток,
	|	Т.ПостояннаяРазницаОстаток,
	|	Т.ВременнаяРазницаОстаток,
	|	ВЫБОР
	|		КОГДА Т.АналитикаУчетаПартий.НалогообложениеНДС В
	|		  (ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаНеОблагаетсяНДС),
	|		   ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаОблагаетсяЕНВД))
	|			 ТОГДА Т.СтоимостьРеглОстаток + Т.НДСРеглОстаток
	|		ИНАЧЕ Т.СтоимостьРеглОстаток
	|	КОНЕЦ КАК СтоимостьРеглОстаток
	|ПОМЕСТИТЬ ВТОстаткиПартииПроизводственныхЗатрат
	|ИЗ
	|	РегистрНакопления.ПартииПроизводственныхЗатрат.Остатки(&ГраницаКонецПредыдущегоПериода,
	|		Организация В (&ОрганизацииФИФОСкользящая)) КАК Т
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////

	//++ НЕ УТ
	|ВЫБРАТЬ
	|	Т.Организация,
	|	Т.АналитикаУчетаНоменклатуры,
	|	Т.ВидЗапасов,
	|	Т.ДокументПоступления,
	|	Т.АналитикаУчетаПартий,
	|	Т.КоличествоОстаток,
	|	Т.СтоимостьОстаток,
	|	Т.СтоимостьБезНДСОстаток,
	|	Т.ПостояннаяРазницаОстаток,
	|	Т.ВременнаяРазницаОстаток,
	|	ВЫБОР
	|		КОГДА Т.АналитикаУчетаПартий.НалогообложениеНДС В
	|		  (ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаНеОблагаетсяНДС),
	|		   ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаОблагаетсяЕНВД))
	|			 ТОГДА Т.СтоимостьРеглОстаток + Т.НДСРеглОстаток
	|		ИНАЧЕ Т.СтоимостьРеглОстаток
	|	КОНЕЦ КАК СтоимостьРеглОстаток
	|ПОМЕСТИТЬ ВТОстаткиПартииНезавершенногоПроизводства
	|ИЗ
	|	РегистрНакопления.ПартииНезавершенногоПроизводства.Остатки(&ГраницаКонецПредыдущегоПериода,
	|		Организация В (&ОрганизацииФИФОСкользящая)) КАК Т
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////

	//-- НЕ УТ
	|ВЫБРАТЬ
	|	Т.РазделУчета 					КАК РазделУчета,
	|	Т.Организация 					КАК Организация,
	|	Т.АналитикаУчетаНоменклатуры 	КАК АналитикаУчетаНоменклатуры,
	|	Т.ВидЗапасов 					КАК ВидЗапасов,
	|	СУММА(Т.Количество) 			КАК Количество,
	|	СУММА(Т.Стоимость) 				КАК Стоимость,
	|	СУММА(Т.СтоимостьБезНДС) 		КАК СтоимостьБезНДС,
	|	СУММА(Т.ПостояннаяРазница) 		КАК ПостояннаяРазница,
	|	СУММА(Т.ВременнаяРазница) 		КАК ВременнаяРазница,
	|	СУММА(Т.СтоимостьРегл) 			КАК СтоимостьРегл,
	|	СУММА(Т.ДопРасходы) 			КАК ДопРасходы,
	|	СУММА(Т.ДопРасходыБезНДС) 		КАК ДопРасходыБезНДС
	|ПОМЕСТИТЬ ВТОстаткиПартионныхРегистровПредварительная
	|ИЗ
	|	(ВЫБРАТЬ
	|		ВЫБОР
	|			КОГДА Т.ВидЗапасов.ТипЗапасов = ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.КомиссионныйТовар)
	|				ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПринятыеНаКомиссию)
	|			КОГДА Т.ВидЗапасов.ТипЗапасов В (ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.МатериалДавальца), ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.ПолуфабрикатДавальца))
	|				ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.МатериалыПринятыеВПереработку)
	|			ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыНаСкладах)
	|		КОНЕЦ КАК РазделУчета,
	|		Т.Организация КАК Организация,
	|		Т.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
	|		Т.ВидЗапасов КАК ВидЗапасов,
	|		Т.КоличествоОстаток КАК Количество,
	|		Т.СтоимостьОстаток КАК Стоимость,
	|		Т.СтоимостьБезНДСОстаток КАК СтоимостьБезНДС,
	|		Т.ПостояннаяРазницаОстаток КАК ПостояннаяРазница,
	|		Т.ВременнаяРазницаОстаток КАК ВременнаяРазница,
	|		Т.СтоимостьРеглОстаток КАК СтоимостьРегл,
	|		0 КАК ДопРасходы,
	|		0 КАК ДопРасходыБезНДС
	|	ИЗ
	|		ВТОстаткиПартииТоваровОрганизаций КАК Т
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПереданныеНаКомиссию),
	|		Т.Организация,
	|		Т.АналитикаУчетаНоменклатуры,
	|		Т.ВидЗапасов,
	|		Т.КоличествоОстаток,
	|		Т.СтоимостьОстаток,
	|		Т.СтоимостьБезНДСОстаток,
	|		Т.ПостояннаяРазницаОстаток,
	|		Т.ВременнаяРазницаОстаток,
	|		Т.СтоимостьРеглОстаток,
	|		0,
	|		0
	|	ИЗ
	|		ВТОстаткиПартииТоваровПереданныеНаКомиссию КАК Т
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		ВЫБОР
	|			КОГДА Т.АналитикаУчетаНоменклатуры.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Склад)
	|				ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыНаСкладах)
	|			КОГДА Т.АналитикаУчетаНоменклатуры.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Подразделение)
	|				ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты)
	|			ИНАЧЕ НЕОПРЕДЕЛЕНО
	|		КОНЕЦ,
	|		Т.Организация,
	|		Т.АналитикаУчетаНоменклатуры,
	|		Т.ВидЗапасов,
	|		0,
	|		Т.СтоимостьОстаток,
	|		Т.СтоимостьБезНДСОстаток,
	|		Т.ПостояннаяРазницаОстаток,
	|		Т.ВременнаяРазницаОстаток,
	|		Т.СтоимостьРеглОстаток,
	|		0,
	|		0
	|	ИЗ
	|		ВТОстаткиПартииРасходовНаСебестоимостьТоваров КАК Т
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВТОстаткиПартииТоваровОрганизаций КАК ПартииТоваров
	|			ПО Т.Организация = ПартииТоваров.Организация
	|			И Т.АналитикаУчетаНоменклатуры = ПартииТоваров.АналитикаУчетаНоменклатуры
	|			И Т.ВидЗапасов = ПартииТоваров.ВидЗапасов
	|			И Т.ДокументПоступления = ПартииТоваров.ДокументПоступления
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВТОстаткиПартииПроизводственныхЗатрат КАК ПартииПроизводства
	|			ПО Т.Организация = ПартииПроизводства.Организация
	|			И Т.АналитикаУчетаНоменклатуры = ПартииПроизводства.АналитикаУчетаНоменклатуры
	|			И Т.ВидЗапасов = ПартииПроизводства.ВидЗапасов
	|			И Т.ДокументПоступления = ПартииПроизводства.ДокументПоступления
	//++ НЕ УТ
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВТОстаткиПартииНезавершенногоПроизводства КАК ПартииНЗП
	|			ПО Т.Организация = ПартииНЗП.Организация
	|			И Т.АналитикаУчетаНоменклатуры = ПартииНЗП.АналитикаУчетаНоменклатуры
	|			И Т.ВидЗапасов = ПартииНЗП.ВидЗапасов
	|			И Т.ДокументПоступления = ПартииНЗП.ДокументПоступления
	//-- НЕ УТ
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		ВЫБОР
	|			КОГДА Т.АналитикаУчетаПродукции.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Склад)
	|				ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыНаСкладах)
	|			КОГДА Т.АналитикаУчетаПродукции.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Подразделение)
	|				ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты)
	|			ИНАЧЕ НЕОПРЕДЕЛЕНО
	|		КОНЕЦ,
	|		Т.Организация,
	|		Т.АналитикаУчетаПродукции,
	|		ЕСТЬNULL(ПартииТоваров.ВидЗапасов, ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка)),
	|		0 КАК КоличествоОстаток,
	|		Т.СтоимостьОстаток,
	|		Т.СтоимостьБезНДСОстаток,
	|		Т.ПостояннаяРазницаОстаток,
	|		Т.ВременнаяРазницаОстаток,
	|		Т.СтоимостьРеглОстаток,
	|		0,
	|		0
	|	ИЗ
	|		ВТОстаткиПартииЗатратНаВыпуск КАК Т
	|			ЛЕВОЕ СОЕДИНЕНИЕ ВТОстаткиПартииТоваровОрганизаций КАК ПартииТоваров
	|			ПО Т.Организация = ПартииТоваров.Организация
	|				И Т.АналитикаУчетаПродукции = ПартииТоваров.АналитикаУчетаНоменклатуры
	|				И Т.ДокументВыпуска = ПартииТоваров.ДокументПоступления
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		ВЫБОР
	|			КОГДА Т.АналитикаУчетаНоменклатуры.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Партнер)
	|				ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПереданныеПереработчику)
	|			ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты)
	|		КОНЕЦ,
	|		Т.Организация,
	|		Т.АналитикаУчетаНоменклатуры,
	|		Т.ВидЗапасов,
	|		Т.КоличествоОстаток,
	|		Т.СтоимостьОстаток,
	|		Т.СтоимостьБезНДСОстаток,
	|		Т.ПостояннаяРазницаОстаток,
	|		Т.ВременнаяРазницаОстаток,
	|		Т.СтоимостьРеглОстаток,
	|		0,
	|		0
	|	ИЗ
	|		ВТОстаткиПартииПроизводственныхЗатрат КАК Т
	//++ НЕ УТ
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты),
	|		Т.Организация,
	|		Т.АналитикаУчетаНоменклатуры,
	|		Т.ВидЗапасов,
	|		Т.КоличествоОстаток,
	|		Т.СтоимостьОстаток,
	|		Т.СтоимостьБезНДСОстаток,
	|		Т.ПостояннаяРазницаОстаток,
	|		Т.ВременнаяРазницаОстаток,
	|		Т.СтоимостьРеглОстаток,
	|		0,
	|		0
	|	ИЗ
	|		ВТОстаткиПартииНезавершенногоПроизводства КАК Т
	//-- НЕ УТ
	|	
	|	) КАК Т
	|
	|СГРУППИРОВАТЬ ПО
	|	Т.РазделУчета,
	|	Т.Организация,
	|	Т.АналитикаУчетаНоменклатуры,
	|	Т.ВидЗапасов
	|
	|ИМЕЮЩИЕ
	|	СУММА(Т.Количество) <> 0
	|";
	
	Возврат ТекстЗапроса;
	
КонецФункции

#КонецОбласти

#Область ВспомогательныеПроцедурыКорректировки

Функция ИнициализироватьКорректировкуОстатковРегистра(ПараметрыРасчета, ИмяРегистра)
	
	ПараметрыКорректировки = Новый Структура;
	
	МетаданныеРегистра = Метаданные.НайтиПоПолномуИмени(ИмяРегистра);
	
	// Описание регистра
	ПараметрыКорректировки.Вставить("МетаданныеРегистра", 	 МетаданныеРегистра); // объект метаданных регистра
	ПараметрыКорректировки.Вставить("ПолноеИмяРегистра", 	 ИмяРегистра); // полное имя регистра из метаданных
	ПараметрыКорректировки.Вставить("ИмяРегистра", 			 МетаданныеРегистра.Имя); // имя регистра из объекта метаданных
	ПараметрыКорректировки.Вставить("ПредставлениеРегистра", МетаданныеРегистра.Синоним); // представление регистра из объекта метаданных
	ПараметрыКорректировки.Вставить("ОписаниеРегистра", 	 ПараметрыРасчета.Движения[ПараметрыКорректировки.ИмяРегистра]); // описание регистра
	
	// Описание временных таблиц
	ПараметрыКорректировки.Вставить("ИмяТаблицыОстатков", "ВТРасчетныеНачальныеОстатки" + ПараметрыКорректировки.ИмяРегистра); // количество таблиц сформированных движений вида ВТКорректировка<ИмяРегистра><НомерТаблицы>
	ПараметрыКорректировки.Вставить("КоличествоСформированныхТаблиц", 0); // количество таблиц сформированных движений вида ВТКорректировка<ИмяРегистра><НомерТаблицы>
	ПараметрыКорректировки.Вставить("ИменаСформированныхТаблиц", ""); // имена всех таблиц вида ВТКорректировка<ИмяРегистра><НомерТаблицы>
	ПараметрыКорректировки.Вставить("СуществующиеТаблицы",
		РасчетСебестоимостиПрикладныеАлгоритмы.ПолучитьПереченьСуществующихВременныхТаблиц(ПараметрыРасчета)); // имена всех таблиц, существовавших до начала корректировки
	
	// Описание корректировки
	ПараметрыКорректировки.Вставить("ТипЗаписиКорректировки", Неопределено); // тип записи текущей корректировки
	
	Возврат ПараметрыКорректировки;
	
КонецФункции

Процедура НачатьСледующуюКорректировкуОстатковРегистра(ПараметрыРасчета, ПараметрыКорректировки,
			ТипЗаписиКорректировки, ОчищатьКорректировкиСледующихПериодов = Ложь) Экспорт
	
	ПараметрыКорректировки.ТипЗаписиКорректировки = ТипЗаписиКорректировки;
	
	// Очистим временные таблицы предыдущих корректировок.
	ИменаУдаляемыхТаблиц = РасчетСебестоимостиПрикладныеАлгоритмы.ПолучитьПереченьСуществующихВременныхТаблиц(
		ПараметрыРасчета,
		РасчетСебестоимостиУниверсальныеАлгоритмы.СоединитьСтроки(ПараметрыКорректировки.СуществующиеТаблицы, ПараметрыКорректировки.ИменаСформированныхТаблиц));
	
	МассивСтрок = СтроковыеФункцииКлиентСервер.РазложитьСтрокуВМассивПодстрок(ИменаУдаляемыхТаблиц, ",", Истина, Истина);
	ИменаУдаляемыхТаблиц = "";
	
	// Не удаляем таблицы расчетных остатков и таблицы сформированных корректировок
	// (в случае, если несколько корректировок разных регистров выполняются одновременно).
	Для Каждого ИмяТаблицы Из МассивСтрок Цикл
		
		Если СтрНачинаетсяС(ИмяТаблицы, "ВТРасчетныеНачальныеОстатки") Тогда
			Продолжить;
		ИначеЕсли СтрНачинаетсяС(ИмяТаблицы, "ВТКорректировка") Тогда
			Продолжить;
		КонецЕсли;
		
		РасчетСебестоимостиУниверсальныеАлгоритмы.ДополнитьСтроку(ИменаУдаляемыхТаблиц, ИмяТаблицы);
		
	КонецЦикла;
	
	РасчетСебестоимостиПрикладныеАлгоритмы.УничтожитьВременныеТаблицы(ПараметрыРасчета, ИменаУдаляемыхТаблиц);
	
	// Обслуживание регистра РасчетСебестоимостиДатыКорректировокОстатков
	РасчетСебестоимостиПрикладныеАлгоритмы.ИнициализироватьОписаниеОрганизацийДляВыполненияКорректировки(ПараметрыРасчета, ПараметрыКорректировки);
	
	ПараметрыРасчета.Вставить("ОрганизацииФИФОСкользящая", Новый Массив);
	ПараметрыРасчета.Вставить("ОрганизацииНеФИФОСкользящая", Новый Массив);
	
	Для Каждого ТекущаяОрганизация Из ПараметрыКорректировки.ОрганизацииДляКорректировки Цикл
			
		ПараметрыУчетнойПолитики = НастройкиНалоговУчетныхПолитик.ДействующиеПараметрыНалоговУчетныхПолитикНаДату("УчетнаяПолитикаФинансовогоУчета",
			ТекущаяОрганизация,
			НачалоМесяца(ПараметрыРасчета.РасчетныйПериод.НачалоПериода - 1));
		Если ПараметрыРасчета.ПартионныйУчетВключен
		 И ПараметрыУчетнойПолитики <> Неопределено
		 И ПараметрыУчетнойПолитики.МетодОценкиСтоимостиТоваров = Перечисления.МетодыОценкиСтоимостиТоваров.ФИФОСкользящаяОценка Тогда
			ПараметрыРасчета.ОрганизацииФИФОСкользящая.Добавить(ТекущаяОрганизация);
		Иначе
			ПараметрыРасчета.ОрганизацииНеФИФОСкользящая.Добавить(ТекущаяОрганизация);
		КонецЕсли;	
		
	КонецЦикла;
	
	Если ОчищатьКорректировкиСледующихПериодов Тогда
		// Очистим движения корректировок в следующих периодах.
		ОчиститьКорректировкиРегистровВСледующихПериодах(ПараметрыРасчета, ПараметрыКорректировки);
	КонецЕсли;
	
	// Инициализируем таблицу расчетных начальных остатков регистра.
	СформироватьТаблицуРасчетныхНачальныхОстатковРегистра(ПараметрыРасчета, ПараметрыКорректировки);
	
КонецПроцедуры

Процедура ДобавитьКорректировочныеДвиженияРегистра(ПараметрыРасчета, ПараметрыКорректировки,
			ИменаТаблицКорректировки, ИменаТаблицСторно = "", УдалятьТаблицыКорректировки = Ложь, УдалятьТаблицыСторно = Ложь) Экспорт
	
	// Подготовим вспомогательные данные.
	ИменаКолонокРегистра  = Новый Структура(СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(ПараметрыКорректировки.ОписаниеРегистра.ПоляОсновнойТаблицыРегистра, ""));
	ИменаРесурсовРегистра = Новый Структура(СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(ПараметрыКорректировки.ОписаниеРегистра.РесурсыРегистра, ""));
	ИменаСлужебныхКолонок = Новый Структура("Регистратор, Период, ВидДвижения, ТипЗаписи");
	
	Если ПараметрыКорректировки.ОписаниеРегистра.ЕстьРасчетПартий Тогда
		ИменаСлужебныхКолонок.Вставить("РасчетПартий");
	КонецЕсли;
	
	ИменаТаблиц = РасчетСебестоимостиУниверсальныеАлгоритмы.СоединитьСтроки(ИменаТаблицКорректировки, ИменаТаблицСторно);
	СтруктураТаблицСторно = Новый Структура(ИменаТаблицСторно);
	
	Запрос = Новый Запрос;
	ИнициализироватьСвойстваЗапроса(Запрос, ПараметрыРасчета);
	Запрос.УстановитьПараметр("ТипЗаписиКорректировки", ПараметрыКорректировки.ТипЗаписиКорректировки);
	
	ШаблонЗапроса =
	"ВЫБРАТЬ
	|	&ПоляПриемника
	|ПОМЕСТИТЬ ИмяПриемника
	|ИЗ
	|	&ИмяИсточника КАК Т
	|	ЛЕВОЕ СОЕДИНЕНИЕ ВТДокументыРасчетаСебестоимостиПрошлогоПериода КАК ДокументыРасчетаСебестоимости
	|		ПО Т.Организация = ДокументыРасчетаСебестоимости.Организация";
	
	Для Каждого КлючИЗначение Из Новый Структура(ИменаТаблиц) Цикл // для каждой таблицы корректировки и сторно
		
		// Источник
		ИмяТаблицыИсточника = КлючИЗначение.Ключ;
		
		СтруктураТаблицыИсточника = РасчетСебестоимостиПрикладныеАлгоритмы.ВыгрузитьВременнуюТаблицу(ПараметрыРасчета, ИмяТаблицыИсточника, 1);
		Если СтруктураТаблицыИсточника.Количество() = 0 Тогда
			Продолжить; // в источнике нет данных
		КонецЕсли;
		
		КолонкиТаблицыИсточника = СтруктураТаблицыИсточника.Колонки;
		
		// Приемник
		ПараметрыКорректировки.КоличествоСформированныхТаблиц = ПараметрыКорректировки.КоличествоСформированныхТаблиц + 1;
		
		ИмяТаблицыПриемника = "ВТКорректировка" + ПараметрыКорректировки.ИмяРегистра + "_" + РасчетСебестоимостиУниверсальныеАлгоритмы.ЧислоВСтрокуБезПробелов(ПараметрыКорректировки.КоличествоСформированныхТаблиц);
		РасчетСебестоимостиУниверсальныеАлгоритмы.ДополнитьСтроку(ПараметрыКорректировки.ИменаСформированныхТаблиц, ИмяТаблицыПриемника);
		
		ТекстПоляПриемника =
		"	ДокументыРасчетаСебестоимости.Ссылка КАК Регистратор,
		|	&КонецПредыдущегоПериода КАК Период,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
		|	&ТипЗаписиКорректировки КАК ТипЗаписи";
		
		Если ПараметрыКорректировки.ОписаниеРегистра.ЕстьРасчетПартий Тогда
			ТекстПоляПриемника = ТекстПоляПриемника + ",
				|	ИСТИНА КАК РасчетПартий";
		КонецЕсли;
		
		Для Каждого КлючИЗначение2 Из ИменаКолонокРегистра Цикл // колонки регистра-приемника
			
			ИмяКолонки = КлючИЗначение2.Ключ;
			
			Если ИменаСлужебныхКолонок.Свойство(ИмяКолонки) Тогда // служебная
				
				Продолжить;// текст уже сформирован
				
			ИначеЕсли КолонкиТаблицыИсточника.Найти(ИмяКолонки) <> Неопределено Тогда // взять колонку из временной таблицы
				
				Если ИменаРесурсовРегистра.Свойство(ИмяКолонки) И СтруктураТаблицСторно.Свойство(ИмяТаблицыИсточника) Тогда
					ТекстЗнак = "-"; // ресурсы сторно со знаком минус
				Иначе
					ТекстЗнак = "";
				КонецЕсли;
				
				ТекстПоле = ТекстЗнак + "Т." + ИмяКолонки;
				
			Иначе // установить пустое значение колонки
				
				ТипЗначенияКолонки = РасчетСебестоимостиУниверсальныеАлгоритмы.ОписанияТиповБезТипаNull(
					ПараметрыКорректировки.ОписаниеРегистра.Таблица.Колонки.Найти(ИмяКолонки).ТипЗначения);
				
				ТекстПоле = "&ПустоеЗначение_" + ИмяКолонки;
				
				Запрос.УстановитьПараметр(
					"ПустоеЗначение_" + ИмяКолонки,
					ТипЗначенияКолонки.ПривестиЗначение(Неопределено));
				
			КонецЕсли;
			
			РасчетСебестоимостиУниверсальныеАлгоритмы.ДополнитьСтроку(
				ТекстПоляПриемника,
				"	" + ТекстПоле + " КАК " + ИмяКолонки);
			
		КонецЦикла; // колонки регистра-приемника
		
		Запрос.Текст = ШаблонЗапроса;
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "ИмяПриемника",  ИмяТаблицыПриемника);
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "&ИмяИсточника",  ИмяТаблицыИсточника);
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "&ПоляПриемника", ТекстПоляПриемника);
		
		Запрос.Выполнить();
		
	КонецЦикла; // добавляемые таблицы
	
	Если УдалятьТаблицыКорректировки Тогда
		РасчетСебестоимостиПрикладныеАлгоритмы.УничтожитьВременныеТаблицы(ПараметрыРасчета, ИменаТаблицКорректировки);
	КонецЕсли;
	
	Если УдалятьТаблицыСторно Тогда
		РасчетСебестоимостиПрикладныеАлгоритмы.УничтожитьВременныеТаблицы(ПараметрыРасчета, ИменаТаблицСторно);
	КонецЕсли;
	
КонецПроцедуры

Процедура ЗавершитьКорректировкуОстатковРегистра(ПараметрыРасчета, ПараметрыКорректировки) Экспорт
	
	#Область ФормированиеТаблицыНовыхДвижений
	
	Запрос = Новый Запрос;
	ИнициализироватьСвойстваЗапроса(Запрос, ПараметрыРасчета);
	Запрос.УстановитьПараметр("ОрганизацииДляКорректировки", ПараметрыКорректировки.ОрганизацииДляКорректировки);
	
	// Если нет сформированных корректировок, то поместим в <ИмяТаблицыНовыхДвижений> только "старые" движения документов, не являющиеся корректировками.
	// Если корректировки есть, то поместим "старые" движения в ВТПрочиеДвиженияДокументовРасчетаСебестоимости и объединим ее с "новыми" корректировочными движениями в <ИмяТаблицыНовыхДвижений>.
	Запрос.Текст =
	"ВЫБРАТЬ
	|	&ПоляРегистра
	|ПОМЕСТИТЬ ВТПрочиеДвиженияДокументовРасчетаСебестоимости
	|ИЗ
	|	&ТаблицаРегистра КАК Т
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТДокументыРасчетаСебестоимостиПрошлогоПериода КАК ДокументыРасчетаСебестоимости
	|		ПО Т.Регистратор = ДокументыРасчетаСебестоимости.Ссылка
	|ГДЕ
	|	Т.Период МЕЖДУ &НачалоПредыдущегоПериода И &КонецПредыдущегоПериода
	|	И Т.Организация В (&ОрганизацииДляКорректировки)
	|	И &ОтборПоТипуЗаписиНеКорректировки
	|;
	|////////////////////////////////////////////////////////////////////////////////
	|
	|ВЫБРАТЬ ПЕРВЫЕ 1
	|	1 КАК Количество
	|ИЗ
	|	ВТПрочиеДвиженияДокументовРасчетаСебестоимости КАК Т";
	
	Запрос.Текст = СтрЗаменить(Запрос.Текст, "&ТаблицаРегистра", СтрШаблон("РегистрНакопления.%1", ПараметрыКорректировки.ИмяРегистра));
	Запрос.Текст = СтрЗаменить(Запрос.Текст, "&ПоляРегистра",
		СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(ПараметрыКорректировки.ОписаниеРегистра.ПоляОсновнойТаблицыРегистра, "Т."));
	Запрос.Текст = СтрЗаменить(Запрос.Текст, "&ОтборПоТипуЗаписиНеКорректировки",
		?(ПараметрыКорректировки.ОписаниеРегистра.ЕстьТипЗаписи, "НЕ (Т.ТипЗаписи В (&ТипыЗаписейКонвертацииДанных))", "ИСТИНА"));
	
	РезультатЗапроса = Запрос.Выполнить();
	
	Если ПараметрыКорректировки.КоличествоСформированныхТаблиц = 0 Тогда
		
		ИмяТаблицыНовыхДвижений = "ВТПрочиеДвиженияДокументовРасчетаСебестоимости"; // могут быть только "прочие" движения документа расчета себестоимости
		
	Иначе
		
		Если ПараметрыКорректировки.КоличествоСформированныхТаблиц = 1 И РезультатЗапроса.Пустой() Тогда
			
			ИмяТаблицыНовыхДвижений = ПараметрыКорректировки.ИменаСформированныхТаблиц; // есть только одна таблица корректировочных движений
			
		Иначе
			
			// Объединим все новые корректировочные движения и "прочие" движения документа расчета себестоимости.
			ИмяТаблицыНовыхДвижений = "ВТНовыеДвиженияПоРегистру" + ПараметрыКорректировки.ИмяРегистра;
			
			РасчетСебестоимостиПрикладныеАлгоритмы.ОбъединитьВременныеТаблицы(
				ПараметрыРасчета,
				РасчетСебестоимостиУниверсальныеАлгоритмы.СоединитьСтроки(
					ПараметрыКорректировки.ИменаСформированныхТаблиц,
					"ВТПрочиеДвиженияДокументовРасчетаСебестоимости"),
				ИмяТаблицыНовыхДвижений,
				ПараметрыКорректировки.ОписаниеРегистра.ПоляОсновнойТаблицыРегистра,
				ПараметрыКорректировки.ОписаниеРегистра.РесурсыРегистра,
				,
				Истина);
			
		КонецЕсли;
		
	КонецЕсли;
	
	#КонецОбласти
	
	#Область ФормированиеТаблицыИзмененныхДокументов
	
	// Сравним движения в <ИмяТаблицыНовыхДвижений> с движениями тех же документов в ИБ.
	ТекстЗапросаВТИзмененныеДокументы = "
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	&ПолеРегистратора
	|ПОМЕСТИТЬ ВТИзмененныеДокументы
	|ИЗ
	|	(ВЫБРАТЬ // новые движения, с плюсом
	|		&ПоляРегистра
	|	ИЗ
	|		&ТаблицаНовыхДвижений КАК Т
	|	ГДЕ
	|		Т.Организация В (&ОрганизацииДляКорректировки)
	|
	|	ОБЪЕДИНИТЬ ВСЕ
	|
	|	ВЫБРАТЬ // старые движения, с минусом
	|		&ПоляРегистраСМинусом
	|	ИЗ
	|		&ТаблицаРегистра КАК Т
	|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТДокументыРасчетаСебестоимостиПрошлогоПериода КАК ДокументыРасчетаСебестоимости
	|			ПО Т.Регистратор = ДокументыРасчетаСебестоимости.Ссылка
	|	ГДЕ
	|		Т.Период МЕЖДУ &НачалоПредыдущегоПериода И &КонецПредыдущегоПериода
	|		И Т.Организация В (&ОрганизацииДляКорректировки)
	|	) КАК Т
	|";
	
	ТекстЗапросаВТДокументыСДвижениями = "
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	Т.Регистратор
	|ПОМЕСТИТЬ ВТДокументыСДвижениями
	|ИЗ
	|	&ТаблицаНовыхДвижений КАК Т
	|";
	
	ТекстЗапросаВТДокументыДляЗаписи = "
	|ВЫБРАТЬ
	|	Т.Регистратор КАК Регистратор,
	|	ВЫБОР КОГДА НовыеДвижения.Регистратор ЕСТЬ NULL ТОГДА ЛОЖЬ ИНАЧЕ ИСТИНА КОНЕЦ КАК ЕстьНовыеДвижения
	|ПОМЕСТИТЬ ВТДокументыДляЗаписи
	|ИЗ
	|	ВТИзмененныеДокументы КАК Т
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВТДокументыСДвижениями КАК НовыеДвижения
	|		ПО Т.Регистратор = НовыеДвижения.Регистратор
	|";
	
	ТекстПоляРегистраСМинусом  = "";
	ТекстОтборНепустыхРесурсов = "";
	ТекстГруппировкаПолей 	   = "";
	
	МассивПолей = СтроковыеФункцииКлиентСервер.РазложитьСтрокуВМассивПодстрок(
		СтрЗаменить(ПараметрыКорректировки.ОписаниеРегистра.ПоляОсновнойТаблицыРегистра, "%1", "Т."),
		",",
		Истина,
		Истина);
	МассивРесурсов = СтроковыеФункцииКлиентСервер.РазложитьСтрокуВМассивПодстрок(
		СтрЗаменить(ПараметрыКорректировки.ОписаниеРегистра.ПоляОтбораНепустыхДвижений, "%1", "Т."),
		",",
		Истина,
		Истина);
	
	Для Каждого ТекущееПоле Из МассивПолей Цикл
		
		ЭтоРесурсРегистра = (МассивРесурсов.Найти(ТекущееПоле) <> Неопределено);
		
		Если ЭтоРесурсРегистра Тогда
			// Ресурс
			ТекстОтборНепустыхРесурсов = ТекстОтборНепустыхРесурсов 
				+ ?(ТекстОтборНепустыхРесурсов = "", "", "
				|	ИЛИ ") + "СУММА(" + ТекущееПоле + ") <> 0";
		Иначе
			// Измерение или реквизит
			ТекстГруппировкаПолей = ТекстГруппировкаПолей 
				+ ?(ТекстГруппировкаПолей = "", "", ",
				|	") + ТекущееПоле;
		КонецЕсли;
		
		ТекстПоляРегистраСМинусом = ТекстПоляРегистраСМинусом 
			+ ?(ТекстПоляРегистраСМинусом = "", "", ",
			|		") + ?(ЭтоРесурсРегистра, "-", "") + ТекущееПоле;
		
	КонецЦикла;
	
	// Дополним текст запроса ТекстЗапросаВТИзмененныеДокументы группировками и отбором
	Если ЗначениеЗаполнено(ТекстГруппировкаПолей) Тогда 
		ТекстЗапросаВТИзмененныеДокументы = ТекстЗапросаВТИзмененныеДокументы + "
			|СГРУППИРОВАТЬ ПО
			|	" + СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(ТекстГруппировкаПолей, "Т.");
	КонецЕсли;
	Если ЗначениеЗаполнено(ТекстОтборНепустыхРесурсов) Тогда 
		ТекстЗапросаВТИзмененныеДокументы = ТекстЗапросаВТИзмененныеДокументы + "
			|ИМЕЮЩИЕ
			|	" + СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(ТекстОтборНепустыхРесурсов, "Т.");
	КонецЕсли;
	
	ТекстыЗапроса = Новый Массив; //Массив из Строка
	
	ТекстыЗапроса.Добавить(ТекстЗапросаВТИзмененныеДокументы);
	ТекстыЗапроса.Добавить(ТекстЗапросаВТДокументыСДвижениями);
	ТекстыЗапроса.Добавить(ТекстЗапросаВТДокументыДляЗаписи);
	
	Запрос.Текст = СтрСоединить(ТекстыЗапроса, ОбщегоНазначения.РазделительПакетаЗапросов());
	
	Запрос.Текст = СтрЗаменить(Запрос.Текст, "&ТаблицаРегистра", СтрШаблон("РегистрНакопления.%1", ПараметрыКорректировки.ИмяРегистра));
	Запрос.Текст = СтрЗаменить(Запрос.Текст, "&ТаблицаНовыхДвижений", ИмяТаблицыНовыхДвижений);
	Запрос.Текст = СтрЗаменить(Запрос.Текст, "&ПоляРегистраСМинусом",
		СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(ТекстПоляРегистраСМинусом, "Т."));
	Запрос.Текст = СтрЗаменить(Запрос.Текст, "&ПолеРегистратора", "Т.Регистратор");
	Запрос.Текст = СтрЗаменить(Запрос.Текст, "&ПоляРегистра",
		СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(ПараметрыКорректировки.ОписаниеРегистра.ПоляОсновнойТаблицыРегистра, "Т."));
	
	Запрос.Выполнить();
	
	#КонецОбласти
	
	#Область ПодготовкаЗаписиДвижений
	
	ПараметрыЗаписи = РасчетСебестоимостиПрикладныеАлгоритмы.ИнициализироватьПараметрыЗаписи(
		ПараметрыРасчета.РасчетныйПериод.НачалоПериода,
		ПараметрыРасчета.НомерЗаданияДоРасчета);
	
	#КонецОбласти
	
	#Область ОчисткаСтарыхДвижений
	
	// Очистим движения документов, у которых нет движений в <ИмяТаблицыНовыхДвижений>, но есть движения в ИБ
	Запрос.Текст =
	"ВЫБРАТЬ
	|	Т.Регистратор
	|ИЗ
	|	ВТДокументыДляЗаписи КАК Т
	|ГДЕ
	|	НЕ Т.ЕстьНовыеДвижения";
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ЗаписатьДвиженияПоРегистру(
		Запрос,
		ПараметрыКорректировки.ОписаниеРегистра.МенеджерРегистра,
		ПараметрыЗаписи);
	
	#КонецОбласти
	
	#Область ЗаписьНовыхДвижений
	
	// Запишем только документы с измененными движениями у которых есть движения в <ИмяТаблицыНовыхДвижений>.
	Запрос.Текст =
	"ВЫБРАТЬ
	|	&ПоляРегистра
	|ИЗ
	|	&ТаблицаНовыхДвижений КАК Т
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВТДокументыДляЗаписи КАК ДокументыДляЗаписи
	|		ПО Т.Регистратор = ДокументыДляЗаписи.Регистратор
	|ГДЕ
	|	ЕСТЬNULL(ДокументыДляЗаписи.ЕстьНовыеДвижения, ЛОЖЬ)
	|УПОРЯДОЧИТЬ ПО
	|	&УпорядочиваниеПолей";
	
	ТекстУпорядочиваниеПолей  = РасчетСебестоимостиУниверсальныеАлгоритмы.СоединитьСтроки(
		"%1Регистратор, %1Период",
		?(ПараметрыКорректировки.ОписаниеРегистра.ЕстьТипЗаписи, "%1ТипЗаписи", ""),
		ПараметрыКорректировки.ОписаниеРегистра.ИзмеренияРегистра,
		ПараметрыКорректировки.ОписаниеРегистра.РесурсыРегистра);
	
	Запрос.Текст = СтрЗаменить(Запрос.Текст, "&ТаблицаНовыхДвижений", ИмяТаблицыНовыхДвижений);
	Запрос.Текст = СтрЗаменить(Запрос.Текст, "&УпорядочиваниеПолей",
		СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(ТекстУпорядочиваниеПолей, "Т."));
	Запрос.Текст = СтрЗаменить(Запрос.Текст, "&ПоляРегистра",
		СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(ПараметрыКорректировки.ОписаниеРегистра.ПоляОсновнойТаблицыРегистра, "Т."));
	
	Попытка
		
		РасчетСебестоимостиПрикладныеАлгоритмы.ЗаписатьДвиженияПоРегистру(
			Запрос,
			ПараметрыКорректировки.ОписаниеРегистра.МенеджерРегистра,
			ПараметрыЗаписи);
		
	Исключение
		
		// Информацию об ошибке добавим в протокол расчета.
		// Затем, по окончании расчета, запишем протокол расчета и только потом вызовем исключение.
		ТекстДляПротокола = ПодробноеПредставлениеОшибки(ИнформацияОбОшибке());
		ТекстДляПротокола = СтрЗаменить(ТекстДляПротокола, РасчетСебестоимостиПрикладныеАлгоритмы.СлужебныйСимвол_ПроблемаУжеЗарегистрирована(), "");
		
		РасчетСебестоимостиПрикладныеАлгоритмы.ЗарегистрироватьПроблемуВыполненияРасчета(
			ПараметрыРасчета,
			,
			НСтр("ru = 'При записи движений диагностированы ошибки';
				|en = 'Errors were found when saving records'", ОбщегоНазначения.КодОсновногоЯзыка()),
			ТекстДляПротокола);
		
	КонецПопытки;
	
	#КонецОбласти
	
	#Область ОкончаниеЗаписиДвижений
	
	// Все данные записаны в ИБ, вспомогательные таблицы больше не нужны.
	ИменаУдаляемыхТаблиц = РасчетСебестоимостиПрикладныеАлгоритмы.ПолучитьПереченьСуществующихВременныхТаблиц(
		ПараметрыРасчета,
		ПараметрыКорректировки.СуществующиеТаблицы);
	
	МассивСтрок = СтроковыеФункцииКлиентСервер.РазложитьСтрокуВМассивПодстрок(ИменаУдаляемыхТаблиц, ",", Истина, Истина);
	ИменаУдаляемыхТаблиц = "";
	
	// Не удаляем таблицы расчетных остатков и таблицы сформированных корректировок
	// (в случае, если несколько корректировок разных регистров выполняются одновременно).
	Для Каждого ИмяТаблицы Из МассивСтрок Цикл
		
		Если СтрНачинаетсяС(ИмяТаблицы, "ВТРасчетныеНачальныеОстатки")
		 И ИмяТаблицы <> ПараметрыКорректировки.ИмяТаблицыОстатков Тогда
			Продолжить;
		ИначеЕсли СтрНачинаетсяС(ИмяТаблицы, "ВТКорректировка")
		 И НЕ СтрНачинаетсяС(ИмяТаблицы, "ВТКорректировка" + ПараметрыКорректировки.ИмяРегистра + "_") Тогда
			Продолжить;
		КонецЕсли;
		
		РасчетСебестоимостиУниверсальныеАлгоритмы.ДополнитьСтроку(ИменаУдаляемыхТаблиц, ИмяТаблицы);
		
	КонецЦикла;
	
	РасчетСебестоимостиПрикладныеАлгоритмы.УничтожитьВременныеТаблицы(ПараметрыРасчета, ИменаУдаляемыхТаблиц);
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ЗафиксироватьФактВыполненияКорректировки(ПараметрыРасчета, ПараметрыКорректировки);
	
	#КонецОбласти
	
КонецПроцедуры


Процедура СформироватьТаблицуРасчетныхНачальныхОстатковРегистра(ПараметрыРасчета, ПараметрыКорректировки)
	
	Запрос = Новый Запрос;
	ИнициализироватьСвойстваЗапроса(Запрос, ПараметрыРасчета);
	
	Запрос.УстановитьПараметр("ОрганизацииДляКорректировки", ПараметрыКорректировки.ОрганизацииДляКорректировки);
	
	// Поля для подстановки в шаблоны.
	ИзмеренияРегистра = СтрЗаменить(ПараметрыКорректировки.ОписаниеРегистра.ИзмеренияРегистра, "%1", "Т.");
	РесурсыРегистраСумма = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
		ПараметрыКорректировки.ОписаниеРегистра.РесурсыРегистраССуффиксом,
		"СУММА(Т.Знак * Т.",
		")");
	РесурсыРегистраОстатки = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
		ПараметрыКорректировки.ОписаниеРегистра.РесурсыРегистраССуффиксом,
		"Т.",
		"Остаток");
	РесурсыРегистраОбороты = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
		ПараметрыКорректировки.ОписаниеРегистра.РесурсыРегистраССуффиксом,
		"Т.",
		"");
		
	ТекстОтборПоТипуЗаписи = ?(ПараметрыКорректировки.ОписаниеРегистра.ЕстьТипЗаписи, "И Т.ТипЗаписи В (&ТипыЗаписейКонвертацииДанных)", "");
	
	// Сформируем отбор по непустым ресурсам регистра.
	ТекстОтборНепустыхРесурсов = "";
	МассивРесурсов = СтроковыеФункцииКлиентСервер.РазложитьСтрокуВМассивПодстрок(
		СтрЗаменить(ПараметрыКорректировки.ОписаниеРегистра.РесурсыРегистра, "%1", "Т."),
		",",
		Истина,
		Истина);
	
	Для Каждого ТекущееПоле Из МассивРесурсов Цикл
		
		ТекстОтборНепустыхРесурсов = ТекстОтборНепустыхРесурсов 
			+ ?(ТекстОтборНепустыхРесурсов = "", "", "
			|	ИЛИ ") + "СУММА(Т.Знак * " + ТекущееПоле + ") <> 0";
		
	КонецЦикла;
	
	ТекстЗапросаОстатков = "
	|ВЫБРАТЬ
	|	&ИзмеренияРегистра,
	|	1 КАК Знак,
	|	&РесурсыРегистраОстатки
	|ПОМЕСТИТЬ ТаблицаОстатковИсточники
	|ИЗ
	|	&ИмяТаблицыОстатковРегистраНакопления КАК Т
	|";
	
	ТекстЗапросаОстатков = СтрЗаменить(ТекстЗапросаОстатков, 
								"&ИмяТаблицыОстатковРегистраНакопления",
								СтрШаблон("РегистрНакопления.%1.Остатки(&ГраницаКонецПредыдущегоПериода,
											|			Организация В (&ОрганизацииДляКорректировки))", 
											ПараметрыКорректировки.ИмяРегистра));
	
	ТекстаЗапросаДвижений = "
	|ВЫБРАТЬ
	|	&ИзмеренияРегистра,
	|	ВЫБОР КОГДА Т.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) ТОГДА -1 ИНАЧЕ 1 КОНЕЦ КАК Знак,
	|	&РесурсыРегистраОбороты
	|ИЗ
	|	&ИмяТаблицыРегистраНакопления КАК Т
	|ГДЕ
	|	Т.Период МЕЖДУ &НачалоПредыдущегоПериода И &КонецПредыдущегоПериода
	|	И Т.Организация В (&ОрганизацииДляКорректировки)
	|	И Т.Регистратор ССЫЛКА Документ.РасчетСебестоимостиТоваров
	|	И Т.Активность
	|	И &ОтборПоТипуЗаписи
	|";
	
	ТекстаЗапросаДвижений = СтрЗаменить(ТекстаЗапросаДвижений, 
								"&ИмяТаблицыРегистраНакопления",
								СтрШаблон("РегистрНакопления.%1", 
											ПараметрыКорректировки.ИмяРегистра));
	
	ТекстыЗапроса = Новый Массив; // Массив из Строка
	ТекстыЗапроса.Добавить(ТекстЗапросаОстатков);
	ТекстыЗапроса.Добавить(ТекстаЗапросаДвижений);
	
	// Сформируем тексты запросов для выборки из таблиц корректировки, уже сформированных при текущем расчете.
	ТекстШаблонТекущейКорректировки = "
	|ВЫБРАТЬ
	|	&ИзмеренияРегистра,
	|	ВЫБОР КОГДА Т.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) ТОГДА -1 ИНАЧЕ 1 КОНЕЦ КАК Знак,
	|	&РесурсыРегистраОбороты
	|ИЗ
	|	&ИмяТаблицыРезультатовКорректировки КАК Т";
	
	Для НомерТаблицы = 1 По ПараметрыКорректировки.КоличествоСформированныхТаблиц Цикл
		
		ТекстВыборкиИзСформированныхКорректировок = СтрЗаменить(ТекстШаблонТекущейКорректировки,
			"&ИзмеренияРегистра", ИзмеренияРегистра);
		ТекстВыборкиИзСформированныхКорректировок = СтрЗаменить(ТекстВыборкиИзСформированныхКорректировок,
			"&РесурсыРегистраОбороты", РесурсыРегистраОбороты);
		ТекстВыборкиИзСформированныхКорректировок = СтрЗаменить(ТекстВыборкиИзСформированныхКорректировок,
			"&ИмяТаблицыРезультатовКорректировки", "ВТКорректировка" + ПараметрыКорректировки.ИмяРегистра + "_"
			+ РасчетСебестоимостиУниверсальныеАлгоритмы.ЧислоВСтрокуБезПробелов(НомерТаблицы));
		
		ТекстыЗапроса.Добавить(ТекстВыборкиИзСформированныхКорректировок);
		
	КонецЦикла;
	
	ТекстЗапросаИсточники = СтрСоединить(ТекстыЗапроса, ОбщегоНазначенияУТ.РазделительЗапросовВОбъединении());
	
	ТекстЗапросаТаблицыОстатков =
	"ВЫБРАТЬ
	|	&ИзмеренияРегистра,
	|	&РесурсыРегистраСумма
	|ПОМЕСТИТЬ ИмяТаблицыОстатков
	|ИЗ
	|	ТаблицаОстатковИсточники КАК Т
	|
	|СГРУППИРОВАТЬ ПО
	|	&ИзмеренияРегистра
	|
	|ИМЕЮЩИЕ
	|	&ОтборНепустыхРесурсов
	|";
	
	ТекстыЗапроса = Новый Массив; // Массив из Строка
	ТекстыЗапроса.Добавить(ТекстЗапросаИсточники);
	ТекстыЗапроса.Добавить(ТекстЗапросаТаблицыОстатков);
	
	ШаблонЗапроса = СтрСоединить(ТекстыЗапроса, ОбщегоНазначения.РазделительПакетаЗапросов());
	
	// Поля для подстановки в шаблоны.
	ИзмеренияРегистра = СтрЗаменить(ПараметрыКорректировки.ОписаниеРегистра.ИзмеренияРегистра, "%1", "Т.");
	РесурсыРегистраСумма = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
		ПараметрыКорректировки.ОписаниеРегистра.РесурсыРегистраССуффиксом,
		"СУММА(Т.Знак * Т.",
		")");
	РесурсыРегистраОстатки = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
		ПараметрыКорректировки.ОписаниеРегистра.РесурсыРегистраССуффиксом,
		"Т.",
		"Остаток");
	РесурсыРегистраОбороты = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
		ПараметрыКорректировки.ОписаниеРегистра.РесурсыРегистраССуффиксом,
		"Т.",
		"");
		
	ТекстОтборПоТипуЗаписи = ?(ПараметрыКорректировки.ОписаниеРегистра.ЕстьТипЗаписи, "Т.ТипЗаписи В (&ТипыЗаписейКонвертацииДанных)", "ИСТИНА");
	
	// Сформируем отбор по непустым ресурсам регистра.
	ТекстОтборНепустыхРесурсов = "";
	МассивРесурсов = СтроковыеФункцииКлиентСервер.РазложитьСтрокуВМассивПодстрок(
		СтрЗаменить(ПараметрыКорректировки.ОписаниеРегистра.РесурсыРегистра, "%1", "Т."),
		",",
		Истина,
		Истина);
	
	Для Каждого ТекущееПоле Из МассивРесурсов Цикл
		
		ТекстОтборНепустыхРесурсов = ТекстОтборНепустыхРесурсов 
			+ ?(ТекстОтборНепустыхРесурсов = "", "", "
			|	ИЛИ ") + "СУММА(Т.Знак * " + ТекущееПоле + ") <> 0";
		
	КонецЦикла;
	
	ТекстОтборНепустыхРесурсов = ?(ТекстОтборНепустыхРесурсов = "", "ИСТИНА", ТекстОтборНепустыхРесурсов);
	
	// Подставим параметры в текстЗапроса
	Запрос.Текст = ШаблонЗапроса;
	
	Если РасчетСебестоимостиПрикладныеАлгоритмы.ВременнаяТаблицаСуществует(ПараметрыРасчета, ПараметрыКорректировки.ИмяТаблицыОстатков) Тогда
		Запрос.Текст =
		"УНИЧТОЖИТЬ ИмяТаблицыОстатков
		|;
		|////////////////////////////////////////////////////////////////////////////////
		|" + Запрос.Текст;
	КонецЕсли;
	
	Запрос.Текст = СтрЗаменить(Запрос.Текст, "ИмяТаблицыОстатков", 		ПараметрыКорректировки.ИмяТаблицыОстатков);
	Запрос.Текст = СтрЗаменить(Запрос.Текст, "&ИзмеренияРегистра", 		ИзмеренияРегистра);
	Запрос.Текст = СтрЗаменить(Запрос.Текст, "&РесурсыРегистраСумма", 	РесурсыРегистраСумма);
	Запрос.Текст = СтрЗаменить(Запрос.Текст, "&РесурсыРегистраОстатки", РесурсыРегистраОстатки);
	Запрос.Текст = СтрЗаменить(Запрос.Текст, "&РесурсыРегистраОбороты", РесурсыРегистраОбороты);
	Запрос.Текст = СтрЗаменить(Запрос.Текст, "&ОтборПоТипуЗаписи",		ТекстОтборПоТипуЗаписи);
	Запрос.Текст = СтрЗаменить(Запрос.Текст, "&ОтборНепустыхРесурсов",	ТекстОтборНепустыхРесурсов);
	
	Запрос.Выполнить();
	
КонецПроцедуры

Процедура ОчиститьКорректировкиРегистровВСледующихПериодах(ПараметрыРасчета, ПараметрыКорректировки)
	
	ПараметрыКорректировки.ОписаниеРегистра = ПараметрыРасчета.Движения[ПараметрыКорректировки.ИмяРегистра];
	
	Запрос = Новый Запрос;
	ИнициализироватьСвойстваЗапроса(Запрос, ПараметрыРасчета);
	
	Запрос.УстановитьПараметр("ТипЗаписиКорректировки", 	 ПараметрыКорректировки.ТипЗаписиКорректировки);
	Запрос.УстановитьПараметр("ОрганизацииДляКорректировки", ПараметрыКорректировки.ОрганизацииДляКорректировки);
	
	Запрос.Текст =
	"ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	Т.Регистратор КАК Регистратор
	|ИЗ
	|	&ИмяРегистра КАК Т
	|ГДЕ
	|	Т.Организация В(&ОрганизацииДляКорректировки)
	|	И Т.Период > &КонецПредыдущегоПериода
	|	И Т.Регистратор ССЫЛКА Документ.РасчетСебестоимостиТоваров
	|	И &ОтборПоТипуЗаписи";
	
	ТекстОтборПоТипуЗаписи = ?(ПараметрыКорректировки.ОписаниеРегистра.ЕстьТипЗаписи,
		"Т.ТипЗаписи = &ТипЗаписиКорректировки
		|	И НЕ Т.ТипЗаписи В (&ТипыЗаписейМногократнойКонвертацииДанных)", "");
	
	Запрос.Текст = СтрЗаменить(Запрос.Текст, "&ИмяРегистра", "РегистрНакопления." + ПараметрыКорректировки.ИмяРегистра);
	Запрос.Текст = СтрЗаменить(Запрос.Текст, "&ОтборПоТипуЗаписи", ТекстОтборПоТипуЗаписи);
	
	РезультатЗапроса = Запрос.Выполнить();
	
	Если НЕ РезультатЗапроса.Пустой() Тогда
		
		Выборка = РезультатЗапроса.Выбрать();
		
		ПараметрыЗаписи = РасчетСебестоимостиПрикладныеАлгоритмы.ИнициализироватьПараметрыЗаписи(
			ПараметрыРасчета.РасчетныйПериод.НачалоПериода,
			ПараметрыРасчета.НомерЗаданияДоРасчета);
		
		РасчетСебестоимостиПрикладныеАлгоритмы.ЗаписатьДвиженияПоРегистру(
			Выборка,
			ПараметрыКорректировки.ОписаниеРегистра.МенеджерРегистра,
			ПараметрыЗаписи);
			
	КонецЕсли;
	
КонецПроцедуры


Процедура ИнициализироватьСвойстваЗапроса(Запрос, ПараметрыРасчета)
	
	РасчетныйПериод = ПараметрыРасчета.РасчетныйПериод;
	
	// Общие параметры
	Запрос.УстановитьПараметр("НачалоПериода",				  			РасчетныйПериод.НачалоПериода);
	Запрос.УстановитьПараметр("КонецПериода",				  			РасчетныйПериод.КонецПериода);
	Запрос.УстановитьПараметр("НачалоПредыдущегоПериода",	  			НачалоМесяца(РасчетныйПериод.НачалоПериода - 1));
	Запрос.УстановитьПараметр("КонецПредыдущегоПериода",	  			РасчетныйПериод.НачалоПериода - 1);
	Запрос.УстановитьПараметр("НачалоСледующегоПериода",	  			РасчетныйПериод.КонецПериода + 1);
	Запрос.УстановитьПараметр("ГраницаНачалоПериода",		  			Новый Граница(РасчетныйПериод.НачалоПериода, ВидГраницы.Исключая));
	Запрос.УстановитьПараметр("ГраницаКонецПериода",		  			Новый Граница(РасчетныйПериод.КонецПериода, ВидГраницы.Включая));
	Запрос.УстановитьПараметр("ГраницаКонецПредыдущегоПериода",			Новый Граница(РасчетныйПериод.НачалоПериода - 1, ВидГраницы.Включая));
	
	Запрос.УстановитьПараметр("МассивОрганизаций",						ПараметрыРасчета.МассивОрганизаций);
	Запрос.УстановитьПараметр("ОрганизацииСОстаткамиПоСебестоимости",	ПараметрыРасчета.ОрганизацииСОстаткамиПоСебестоимости);
	
	Если ПараметрыРасчета.Свойство("ОрганизацииФИФОСкользящая") Тогда
		Запрос.УстановитьПараметр("ОрганизацииФИФОСкользящая",			ПараметрыРасчета.ОрганизацииФИФОСкользящая);
		Запрос.УстановитьПараметр("ОрганизацииНеФИФОСкользящая",		ПараметрыРасчета.ОрганизацииНеФИФОСкользящая);
	КонецЕсли;
	
	Запрос.УстановитьПараметр("ТипыЗаписейКонвертацииДанных",			  РасчетСебестоимостиПрикладныеАлгоритмы.ТипыЗаписейКонвертацииДанных());
	Запрос.УстановитьПараметр("ТипыЗаписейМногократнойКонвертацииДанных", РасчетСебестоимостиПрикладныеАлгоритмы.ТипыЗаписейМногократнойКонвертацииДанных());
	
	Запрос.УстановитьПараметр("УправленческийУчетОрганизаций",
		РасчетСебестоимостиПовтИсп.УправленческийУчетОрганизаций(РасчетныйПериод.НачалоПериода));
	
	Запрос.МенеджерВременныхТаблиц = ПараметрыРасчета.МенеджерВременныхТаблиц;
	
КонецПроцедуры

Процедура ИнициализироватьДокументыРасчетаСебестоимостиПрошлогоПериода(ПараметрыРасчета) Экспорт
	
	Запрос = Новый Запрос;
	ИнициализироватьСвойстваЗапроса(Запрос, ПараметрыРасчета);

	// Выберем все не удаленные документы расчета себестоимости за прошлый период.
	// Если по организации уже существует подходящий документ расчета себестоимости, то новый документ создаваться не будет.
	Запрос.Текст =
	"ВЫБРАТЬ
	|	СпрОрганизации.Ссылка КАК Организация,
	|	МАКСИМУМ(ЕСТЬNULL(РасчетСебестоимостиТоваров.Ссылка, НЕОПРЕДЕЛЕНО)) КАК Ссылка
	|ИЗ
	|	Справочник.Организации КАК СпрОрганизации
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.РасчетСебестоимостиТоваров КАК РасчетСебестоимостиТоваров
	|		ПО (СпрОрганизации.Ссылка = РасчетСебестоимостиТоваров.Организация)
	|			И (РасчетСебестоимостиТоваров.Дата МЕЖДУ &НачалоПредыдущегоПериода И &КонецПредыдущегоПериода)
	|			И (РасчетСебестоимостиТоваров.Проведен)
	|			И (НЕ РасчетСебестоимостиТоваров.ПредварительныйРасчет)
	|ГДЕ
	|	СпрОрганизации.Ссылка В(&ОрганизацииСОстаткамиПоСебестоимости)
	|
	|СГРУППИРОВАТЬ ПО
	|	СпрОрганизации.Ссылка";
	
	ДокументыРасчетаПоОрганизациям = Новый Соответствие;
	ДокументыРасчетаСебестоимости = Новый Массив;
	
	Выборка = Запрос.Выполнить().Выбрать();
	Пока Выборка.Следующий() Цикл
		ДокументыРасчетаПоОрганизациям.Вставить(Выборка.Организация, Выборка.Ссылка);
	КонецЦикла;
	
	Попытка
		
		// Создадим недостающие документы расчета себестоимости по организациям.
		Для Каждого КлючИЗначение Из ДокументыРасчетаПоОрганизациям Цикл
			
			Если ЗначениеЗаполнено(КлючИЗначение.Значение) Тогда
				ДокументыРасчетаСебестоимости.Добавить(КлючИЗначение.Значение);
				Продолжить;
			КонецЕсли;

			ДокументОбъект = Документы.РасчетСебестоимостиТоваров.СоздатьДокумент();
			
			ДанныеЗаполненияДокумента = Новый Структура;
			ДанныеЗаполненияДокумента.Вставить("Дата", 					ПараметрыРасчета.РасчетныйПериод.НачалоПериода - 1);
			ДанныеЗаполненияДокумента.Вставить("Организация", 			КлючИЗначение.Ключ);
			ДанныеЗаполненияДокумента.Вставить("ПредварительныйРасчет", Ложь);
			
			ПараметрыУчетнойПолитики = НастройкиНалоговУчетныхПолитик.ДействующиеПараметрыНалоговУчетныхПолитикНаДату("УчетнаяПолитикаФинансовогоУчета",
				КлючИЗначение.Ключ,
				НачалоМесяца(ПараметрыРасчета.РасчетныйПериод.НачалоПериода - 1)); 
			
			Если ПараметрыУчетнойПолитики <> Неопределено Тогда
				ДанныеЗаполненияДокумента.Вставить("МетодОценки", ПараметрыУчетнойПолитики.МетодОценкиСтоимостиТоваров);
			Иначе
				ДанныеЗаполненияДокумента.Вставить("МетодОценки", Перечисления.МетодыОценкиСтоимостиТоваров.СредняяЗаМесяц);
			КонецЕсли;
			
			ДокументОбъект.Заполнить(ДанныеЗаполненияДокумента);
			
			ДокументОбъект.ДополнительныеСвойства.Вставить("ПропуститьПроверкуЗапретаИзменения", Истина);
				
			ДокументОбъект.Записать(РежимЗаписиДокумента.Проведение);
			
			// Запомним документ
			ДокументыРасчетаСебестоимости.Добавить(ДокументОбъект.Ссылка);
			ДокументыРасчетаПоОрганизациям[КлючИЗначение.Ключ] = ДокументОбъект.Ссылка;
			
		КонецЦикла;
		
		Запрос.УстановитьПараметр("ДокументыРасчетаСебестоимости", ДокументыРасчетаСебестоимости);
		
	Исключение
		
		ТекстДляПротокола = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
			НСтр("ru = 'Не удалось инициализировать документы расчета себестоимости прошлого периода по причине:
				|%1';
				|en = 'Cannot initialize past period cost calculation documents. Reason:
				|%1'"),
			ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()));
		
		ВызватьИсключение РасчетСебестоимостиПрикладныеАлгоритмы.ТекстИсключениеДляРегистрацииПроблемы(ТекстДляПротокола);
		
	КонецПопытки;
	
	// Сформируем временную таблицу ВТДокументыРасчетаСебестоимости
	Запрос.Текст =
	"ВЫБРАТЬ
	|	Т.Ссылка,
	|	Т.МоментВремени,
	|	Т.Организация КАК Организация
	|ПОМЕСТИТЬ ВТДокументыРасчетаСебестоимостиПрошлогоПериода
	|ИЗ
	|	Документ.РасчетСебестоимостиТоваров КАК Т
	|ГДЕ
	|	Т.Ссылка В (&ДокументыРасчетаСебестоимости)
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Организация";
	
	Запрос.Выполнить();
	
КонецПроцедуры

#КонецОбласти

#Область ОперацииСКлючамиАналитик

Функция СформироватьОписаниеКлючейАналитикУчетаНоменклатуры(ИмяРеквизитаАналитики = "АналитикаУчетаНоменклатуры",
			ИсключатьПоля = "", ИсключатьПоляДетализацииМестаХранения = Истина)
	
	ОписаниеКлючей = Новый Структура("ПоляИменованные, ПоляНеИменованные, ПереченьПолей");
	СтруктураИсключемыхПолей = Новый Структура(
		РасчетСебестоимостиУниверсальныеАлгоритмы.СоединитьСтроки(
			ИсключатьПоля,
			?(ИсключатьПоляДетализацииМестаХранения, "ТипМестаХранения, СкладскаяТерритория, Подразделение, Партнер, Контрагент, Договор, Организация", "")));
	
	Для Каждого МетаРеквизиты Из Метаданные.Справочники.КлючиАналитикиУчетаНоменклатуры.Реквизиты Цикл
		
		Если СтруктураИсключемыхПолей.Свойство(МетаРеквизиты.Имя) Тогда
			Продолжить;
		КонецЕсли;
		
		РасчетСебестоимостиУниверсальныеАлгоритмы.ДополнитьСтроку(
			ОписаниеКлючей.ПоляИменованные,
			"%1" + ИмяРеквизитаАналитики + "." + МетаРеквизиты.Имя + " КАК " + ИмяРеквизитаАналитики + "_" + МетаРеквизиты.Имя,,,,
			"," + Символы.ПС + "	");
		
		РасчетСебестоимостиУниверсальныеАлгоритмы.ДополнитьСтроку(
			ОписаниеКлючей.ПоляНеИменованные,
			"%1" + ИмяРеквизитаАналитики + "." + МетаРеквизиты.Имя,,,,
			"," + Символы.ПС + "	");
		
		РасчетСебестоимостиУниверсальныеАлгоритмы.ДополнитьСтроку(
			ОписаниеКлючей.ПереченьПолей,
			ИмяРеквизитаАналитики + "_" + МетаРеквизиты.Имя);
		
	КонецЦикла;
	
	Возврат ОписаниеКлючей;
	
КонецФункции

Функция СформироватьАналитикиНоменклатурыБезНазначения(ПараметрыРасчета,
			ИмяИсходнойТаблицы, ИмяТаблицыПриемника, ИмяПоляАналитики = "АналитикаУчетаНоменклатуры")
	
	Запрос = Новый Запрос;
	ИнициализироватьСвойстваЗапроса(Запрос, ПараметрыРасчета);
	
	Запрос.Текст =
	"ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	&ИмяПоляАналитики КАК АналитикаУчетаНоменклатуры
	|ПОМЕСТИТЬ ВТКлючиАналитикиНоменклатурыСНазначениями
	|ИЗ
	|	&ИмяИсходнойТаблицы КАК Т
	|ГДЕ
	|	&ИмяПоляАналитики <> ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка)
	|	И &ИмяПоляНазначениеАналитики <> ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка)
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ ПЕРВЫЕ 1
	|	Т.АналитикаУчетаНоменклатуры
	|ИЗ
	|	ВТКлючиАналитикиНоменклатурыСНазначениями КАК Т
	|";
	
	Запрос.Текст = СтрЗаменить(Запрос.Текст, "&ИмяИсходнойТаблицы", ИмяИсходнойТаблицы);
	Запрос.Текст = СтрЗаменить(Запрос.Текст, "&ИмяПоляАналитики",   СтрШаблон("Т.%1",ИмяПоляАналитики));
	Запрос.Текст = СтрЗаменить(Запрос.Текст, "&ИмяПоляНазначениеАналитики", СтрШаблон("Т.%1.Назначение",ИмяПоляАналитики));
	
	РезультатЗапроса = Запрос.Выполнить();
	
	Если РезультатЗапроса.Пустой() Тогда
		РасчетСебестоимостиПрикладныеАлгоритмы.УничтожитьВременныеТаблицы(ПараметрыРасчета, "ВТКлючиАналитикиНоменклатурыСНазначениями");
		Возврат Ложь; // корректировка аналитик не требуется
	КонецЕсли;
	
	Запрос.Текст =
	"ВЫБРАТЬ
	|	Т.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
	|	Т.АналитикаУчетаНоменклатуры.Номенклатура КАК Номенклатура,
	|	Т.АналитикаУчетаНоменклатуры.Характеристика КАК Характеристика,
	|	Т.АналитикаУчетаНоменклатуры.Серия КАК Серия,
	|	Т.АналитикаУчетаНоменклатуры.МестоХранения КАК МестоХранения,
	|	Т.АналитикаУчетаНоменклатуры.СтатьяКалькуляции КАК СтатьяКалькуляции,
	|	ЕСТЬNULL(Ключи.Ссылка, НЕОПРЕДЕЛЕНО) КАК АналитикаУчетаНоменклатурыБезНазначения
	|ПОМЕСТИТЬ ВТКлючиАналитикиНоменклатурыБезНазначения
	|ИЗ
	|	ВТКлючиАналитикиНоменклатурыСНазначениями КАК Т
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК Ключи
	|		ПО Т.АналитикаУчетаНоменклатуры.Номенклатура = Ключи.Номенклатура
	|			И Т.АналитикаУчетаНоменклатуры.Характеристика = Ключи.Характеристика
	|			И Т.АналитикаУчетаНоменклатуры.Серия = Ключи.Серия
	|			И Т.АналитикаУчетаНоменклатуры.МестоХранения = Ключи.МестоХранения
	|			И Т.АналитикаУчетаНоменклатуры.СтатьяКалькуляции = Ключи.СтатьяКалькуляции
	|			И (Ключи.Назначение = ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка))
	|			И (Ключи.ПометкаУдаления = ЛОЖЬ)
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	Т.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
	|	Т.Номенклатура КАК Номенклатура,
	|	Т.Характеристика КАК Характеристика,
	|	Т.Серия КАК Серия,
	|	Т.МестоХранения КАК МестоХранения,
	|	Т.СтатьяКалькуляции КАК СтатьяКалькуляции,
	|	ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка) КАК Назначение
	|ИЗ
	|	ВТКлючиАналитикиНоменклатурыБезНазначения КАК Т
	|ГДЕ
	|	Т.АналитикаУчетаНоменклатурыБезНазначения = НЕОПРЕДЕЛЕНО";
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	ТаблицаАналитик = Новый ТаблицаЗначений;
	ТаблицаАналитик.Колонки.Добавить("АналитикаУчетаНоменклатуры", Новый ОписаниеТипов("СправочникСсылка.КлючиАналитикиУчетаНоменклатуры"));
	ТаблицаАналитик.Колонки.Добавить("АналитикаУчетаНоменклатурыБезНазначения", Новый ОписаниеТипов("СправочникСсылка.КлючиАналитикиУчетаНоменклатуры"));
	
	Пока Выборка.Следующий() Цикл
		
		НоваяСтрока = ТаблицаАналитик.Добавить();
		НоваяСтрока.АналитикаУчетаНоменклатуры = Выборка.АналитикаУчетаНоменклатуры;
		
		НоваяСтрока.АналитикаУчетаНоменклатурыБезНазначения = РегистрыСведений.АналитикаУчетаНоменклатуры.СоздатьКлючАналитики(Выборка);
		
	КонецЦикла;
	
	Запрос.УстановитьПараметр("ТаблицаАналитик", ТаблицаАналитик);
	
	Запрос.Текст =
	"ВЫБРАТЬ
	|	Т.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
	|	Т.АналитикаУчетаНоменклатурыБезНазначения КАК АналитикаУчетаНоменклатурыБезНазначения
	|ПОМЕСТИТЬ ВТНовыеКлючиАналитикиНоменклатурыБезНазначения
	|ИЗ
	|	&ТаблицаАналитик КАК Т
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Т.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
	|	ВЫБОР
	|		КОГДА Т.АналитикаУчетаНоменклатурыБезНазначения = НЕОПРЕДЕЛЕНО
	|			ТОГДА НовыеКлючи.АналитикаУчетаНоменклатурыБезНазначения
	|		ИНАЧЕ Т.АналитикаУчетаНоменклатурыБезНазначения
	|	КОНЕЦ КАК АналитикаУчетаНоменклатурыБезНазначения
	|ПОМЕСТИТЬ ВТКлючиДляЗамены
	|ИЗ
	|	ВТКлючиАналитикиНоменклатурыБезНазначения КАК Т
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВТНовыеКлючиАналитикиНоменклатурыБезНазначения КАК НовыеКлючи
	|		ПО Т.АналитикаУчетаНоменклатуры = НовыеКлючи.АналитикаУчетаНоменклатуры
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	&ПоляИсходнойТаблицы
	|ПОМЕСТИТЬ ИмяТаблицыПриемника
	|ИЗ
	|	&ИмяИсходнойТаблицы КАК Т
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВТКлючиДляЗамены КАК НовыеКлючи
	|		ПО &ИмяПоляАналитики = НовыеКлючи.АналитикаУчетаНоменклатуры
	|";
	
	ПоляИсходнойТаблицы    = "";
	КолонкиИсходнойТаблицы = РасчетСебестоимостиПрикладныеАлгоритмы.ВыгрузитьВременнуюТаблицу(
		ПараметрыРасчета,
		ИмяИсходнойТаблицы,
		0).Колонки;
	
	Для Каждого ТекущаяКолонка Из КолонкиИсходнойТаблицы Цикл
		
		Если НРег(ТекущаяКолонка.Имя) = НРег(ИмяПоляАналитики) Тогда
			РасчетСебестоимостиУниверсальныеАлгоритмы.ДополнитьСтроку(
				ПоляИсходнойТаблицы,
				"ЕСТЬNULL(НовыеКлючи.АналитикаУчетаНоменклатурыБезНазначения, Т." + ИмяПоляАналитики + ") КАК " + ИмяПоляАналитики,,,,
				"," + Символы.ПС + "	");
		Иначе
			РасчетСебестоимостиУниверсальныеАлгоритмы.ДополнитьСтроку(
				ПоляИсходнойТаблицы,
				"Т." + ТекущаяКолонка.Имя,,,,
				"," + Символы.ПС + "	");
		КонецЕсли;
		
	КонецЦикла;
	
	Запрос.Текст = СтрЗаменить(Запрос.Текст, "&ИмяИсходнойТаблицы",  ИмяИсходнойТаблицы);
	Запрос.Текст = СтрЗаменить(Запрос.Текст, "ИмяТаблицыПриемника", ИмяТаблицыПриемника);
	Запрос.Текст = СтрЗаменить(Запрос.Текст, "&ИмяПоляАналитики",    СтрШаблон("Т.%1", ИмяПоляАналитики));
	Запрос.Текст = СтрЗаменить(Запрос.Текст, "&ПоляИсходнойТаблицы", ПоляИсходнойТаблицы);
	
	Запрос.Выполнить();
	
	РасчетСебестоимостиПрикладныеАлгоритмы.УничтожитьВременныеТаблицы(ПараметрыРасчета,
		"ВТКлючиАналитикиНоменклатурыСНазначениями, ВТКлючиАналитикиНоменклатурыБезНазначения,
		|ВТНовыеКлючиАналитикиНоменклатурыБезНазначения, ВТКлючиДляЗамены");
	
	Возврат Истина;
	
КонецФункции

Функция СформироватьАналитикиНоменклатурыПоЗначениямПолей(ПараметрыРасчета,
			ИмяИсходнойТаблицы, ИмяТаблицыПриемника, ИмяПоляАналитики = "АналитикаУчетаНоменклатуры")
	
	Запрос = Новый Запрос;
	ИнициализироватьСвойстваЗапроса(Запрос, ПараметрыРасчета);
	
	Запрос.Текст =
	"ВЫБРАТЬ
	|	Т.АналитикаУчетаНоменклатуры_Номенклатура КАК Номенклатура,
	|	Т.АналитикаУчетаНоменклатуры_Характеристика КАК Характеристика,
	|	Т.АналитикаУчетаНоменклатуры_Серия КАК Серия,
	|	Т.АналитикаУчетаНоменклатуры_МестоХранения КАК МестоХранения,
	|	Т.АналитикаУчетаНоменклатуры_Назначение КАК Назначение,
	|	Т.АналитикаУчетаНоменклатуры_СтатьяКалькуляции КАК СтатьяКалькуляции,
	|	ЕСТЬNULL(Ключи.Ссылка, НЕОПРЕДЕЛЕНО) КАК АналитикаУчетаНоменклатуры
	|ПОМЕСТИТЬ ВТПоляКлючейАналитикиНоменклатуры
	|ИЗ
	|	&ИмяИсходнойТаблицы КАК Т
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК Ключи
	|		ПО Т.АналитикаУчетаНоменклатуры_Номенклатура = Ключи.Номенклатура
	|			И Т.АналитикаУчетаНоменклатуры_Характеристика = Ключи.Характеристика
	|			И Т.АналитикаУчетаНоменклатуры_Серия = Ключи.Серия
	|			И Т.АналитикаУчетаНоменклатуры_МестоХранения = Ключи.МестоХранения
	|			И Т.АналитикаУчетаНоменклатуры_Назначение = Ключи.Назначение
	|			И Т.АналитикаУчетаНоменклатуры_СтатьяКалькуляции = Ключи.СтатьяКалькуляции
	|			И (Ключи.ПометкаУдаления = ЛОЖЬ)
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	Т.Номенклатура,
	|	Т.Характеристика,
	|	Т.Серия,
	|	Т.МестоХранения,
	|	Т.Назначение,
	|	Т.СтатьяКалькуляции
	|ИЗ
	|	ВТПоляКлючейАналитикиНоменклатуры КАК Т
	|ГДЕ
	|	Т.АналитикаУчетаНоменклатуры = НЕОПРЕДЕЛЕНО";
	
	Запрос.Текст = СтрЗаменить(Запрос.Текст, "&ИмяИсходнойТаблицы", ИмяИсходнойТаблицы);
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	МетаРеквизиты = Метаданные.Справочники.КлючиАналитикиУчетаНоменклатуры.Реквизиты;
	
	ТаблицаАналитик = Новый ТаблицаЗначений;
	ТаблицаАналитик.Колонки.Добавить("Номенклатура", 	  МетаРеквизиты.Номенклатура.Тип);
	ТаблицаАналитик.Колонки.Добавить("Характеристика", 	  МетаРеквизиты.Характеристика.Тип);
	ТаблицаАналитик.Колонки.Добавить("Серия", 			  МетаРеквизиты.Серия.Тип);
	ТаблицаАналитик.Колонки.Добавить("МестоХранения", 	  МетаРеквизиты.МестоХранения.Тип);
	ТаблицаАналитик.Колонки.Добавить("Назначение", 		  МетаРеквизиты.Назначение.Тип);
	ТаблицаАналитик.Колонки.Добавить("СтатьяКалькуляции", МетаРеквизиты.СтатьяКалькуляции.Тип);
	ТаблицаАналитик.Колонки.Добавить("АналитикаУчетаНоменклатуры", Новый ОписаниеТипов("СправочникСсылка.КлючиАналитикиУчетаНоменклатуры"));
	
	Пока Выборка.Следующий() Цикл
		
		НоваяСтрока = ТаблицаАналитик.Добавить();
		ЗаполнитьЗначенияСвойств(НоваяСтрока, Выборка);
		
		НоваяСтрока.АналитикаУчетаНоменклатуры = РегистрыСведений.АналитикаУчетаНоменклатуры.СоздатьКлючАналитики(Выборка);
		
	КонецЦикла;
	
	Запрос.УстановитьПараметр("ТаблицаАналитик", ТаблицаАналитик);
	
	Запрос.Текст =
	"ВЫБРАТЬ
	|	Т.АналитикаУчетаНоменклатуры,
	|	Т.Номенклатура,
	|	Т.Характеристика,
	|	Т.Серия,
	|	Т.МестоХранения,
	|	Т.Назначение,
	|	Т.СтатьяКалькуляции
	|ПОМЕСТИТЬ ВТНовыеКлючиАналитикиНоменклатуры
	|ИЗ
	|	&ТаблицаАналитик КАК Т
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	&ПоляИсходнойТаблицы
	|ПОМЕСТИТЬ ИмяТаблицыПриемника
	|ИЗ
	|	&ИмяИсходнойТаблицы КАК Т
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВТНовыеКлючиАналитикиНоменклатуры КАК НовыеКлючи
	|		ПО Т.АналитикаУчетаНоменклатуры_Номенклатура = НовыеКлючи.Номенклатура
	|			И Т.АналитикаУчетаНоменклатуры_Характеристика = НовыеКлючи.Характеристика
	|			И Т.АналитикаУчетаНоменклатуры_Серия = НовыеКлючи.Серия
	|			И Т.АналитикаУчетаНоменклатуры_МестоХранения = НовыеКлючи.МестоХранения
	|			И Т.АналитикаУчетаНоменклатуры_Назначение = НовыеКлючи.Назначение
	|			И Т.АналитикаУчетаНоменклатуры_СтатьяКалькуляции = НовыеКлючи.СтатьяКалькуляции
	|";
	
	ПоляИсходнойТаблицы    = "";
	КолонкиИсходнойТаблицы = РасчетСебестоимостиПрикладныеАлгоритмы.ВыгрузитьВременнуюТаблицу(
		ПараметрыРасчета,
		ИмяИсходнойТаблицы,
		0).Колонки;
	
	РасчетСебестоимостиУниверсальныеАлгоритмы.ДополнитьСтроку(
		ПоляИсходнойТаблицы,
		"ЕСТЬNULL(НовыеКлючи.АналитикаУчетаНоменклатуры, ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка)) КАК " + ИмяПоляАналитики,,,,
		"," + Символы.ПС + "	");
	
	Для Каждого ТекущаяКолонка Из КолонкиИсходнойТаблицы Цикл
		
		РасчетСебестоимостиУниверсальныеАлгоритмы.ДополнитьСтроку(
				ПоляИсходнойТаблицы,
				"Т." + ТекущаяКолонка.Имя,,,,
				"," + Символы.ПС + "	");
		
	КонецЦикла;
	
	
	Запрос.Текст = СтрЗаменить(Запрос.Текст, "&ИмяИсходнойТаблицы",  ИмяИсходнойТаблицы);
	Запрос.Текст = СтрЗаменить(Запрос.Текст, "ИмяТаблицыПриемника", ИмяТаблицыПриемника);
	Запрос.Текст = СтрЗаменить(Запрос.Текст, "&ПоляИсходнойТаблицы", ПоляИсходнойТаблицы);
	
	Запрос.Выполнить();
	
	РасчетСебестоимостиПрикладныеАлгоритмы.УничтожитьВременныеТаблицы(ПараметрыРасчета,
		"ВТПоляКлючейАналитикиНоменклатуры, ВТНовыеКлючиАналитикиНоменклатуры");
	
	Возврат Истина;
	
КонецФункции

#КонецОбласти

#КонецОбласти

#Область ВосстановлениеДвижений

// Процедура выполняет перепроведение всех документов за период по регистрам накопления:
// "Себестоимость товаров", "Выручка и себестоимость продаж", "Прочие расходы", "Партии прочих расходов"ю
// Выполняется только при работе механизма автотестирования себестоимости.
// Предназначена для выявления ошибок, связанных с проведением документов по регистрам.
//
Процедура ПерепровестиДокументыПоРегистрам(НачалоПериода, КонецПериода, МассивОрганизаций)
	
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("НачалоПериода",     НачалоПериода);
	Запрос.УстановитьПараметр("КонецПериода",      КонецПериода);
	Запрос.УстановитьПараметр("МассивОрганизаций", МассивОрганизаций);
	
	#Область СебестоимостьТоваров
	
	Запрос.Текст = "
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	ДД.Регистратор КАК Ссылка,
	|	ДД.Организация КАК Организация
	|ИЗ
	|	РегистрНакопления.СебестоимостьТоваров КАК ДД
	|ГДЕ
	|	ДД.Период МЕЖДУ &НачалоПериода И &КонецПериода
	|	И ДД.Организация В (&МассивОрганизаций)
	|	И НЕ ДД.РасчетПартий
	|	И НЕ ДД.РасчетСебестоимости
	|";
	ВыборкаДокументов = Запрос.Выполнить().Выбрать();
	
	ВосстановитьДвиженияДокументовПоРегиструНакопления(
		НачалоПериода,
		КонецПериода,
		МассивОрганизаций,
		ВыборкаДокументов,
		Метаданные.РегистрыНакопления.СебестоимостьТоваров.Имя);
		
	#КонецОбласти
	
	#Область ВыручкаИСебестоимостьПродаж
	
	Запрос.Текст = "
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	ДД.Регистратор КАК Ссылка,
	|	ДД.АналитикаУчетаПоПартнерам.Организация КАК Организация
	|ИЗ
	|	РегистрНакопления.ВыручкаИСебестоимостьПродаж КАК ДД
	|ГДЕ
	|	ДД.Период МЕЖДУ &НачалоПериода И &КонецПериода
	|	И ДД.АналитикаУчетаПоПартнерам.Организация В (&МассивОрганизаций)
	|	И НЕ ДД.РасчетПартий
	|	И НЕ ДД.РасчетСебестоимости
	|";
	ВыборкаДокументов = Запрос.Выполнить().Выбрать();
	
	ВосстановитьДвиженияДокументовПоРегиструНакопления(
		НачалоПериода,
		КонецПериода,
		МассивОрганизаций,
		ВыборкаДокументов,
		Метаданные.РегистрыНакопления.ВыручкаИСебестоимостьПродаж.Имя);
		
	#КонецОбласти
	
	#Область ПрочиеРасходы
	
	Запрос.УстановитьПараметр("ТипыДокументовОСиНМА", РасчетСебестоимостиПрикладныеАлгоритмы.ТипыДокументовОСиНМА());
	
	Запрос.Текст = "
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	ДД.Регистратор КАК Ссылка,
	|	ДД.Организация КАК Организация
	|ИЗ
	|	РегистрНакопления.ПрочиеРасходы КАК ДД
	|ГДЕ
	|	ДД.Период МЕЖДУ &НачалоПериода И &КонецПериода
	|	И ДД.Организация В (&МассивОрганизаций)
	|	И НЕ ДД.РасчетПартий
	|	И НЕ ДД.РасчетСебестоимости
	|	И НЕ ТИПЗНАЧЕНИЯ(ДД.Регистратор) В (&ТипыДокументовОСиНМА)
	|";
	ВыборкаДокументов = Запрос.Выполнить().Выбрать();
	
	ВосстановитьДвиженияДокументовПоРегиструНакопления(
		НачалоПериода,
		КонецПериода,
		МассивОрганизаций,
		ВыборкаДокументов,
		Метаданные.РегистрыНакопления.ПрочиеРасходы.Имя);
		
	#КонецОбласти
	
	#Область ПартииПрочихРасходов
	
	Запрос.Текст = "
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	ДД.Регистратор КАК Ссылка,
	|	ДД.Организация КАК Организация
	|ИЗ
	|	РегистрНакопления.ПартииПрочихРасходов КАК ДД
	|ГДЕ
	|	ДД.Период МЕЖДУ &НачалоПериода И &КонецПериода
	|	И ДД.Организация В (&МассивОрганизаций)
	|	И НЕ ДД.РасчетПартий
	|	И НЕ ТИПЗНАЧЕНИЯ(ДД.Регистратор) В (&ТипыДокументовОСиНМА)
	|";
	ВыборкаДокументов = Запрос.Выполнить().Выбрать();
	
	ВосстановитьДвиженияДокументовПоРегиструНакопления(
		НачалоПериода,
		КонецПериода,
		МассивОрганизаций,
		ВыборкаДокументов,
		Метаданные.РегистрыНакопления.ПартииПрочихРасходов.Имя);
		
	#КонецОбласти
	
КонецПроцедуры

#Область РегистрНакопления_ТоварыОрганизаций
//++ НЕ УТ

Процедура ВосстановитьДвиженияВозвратМатериаловИзПроизводстваПоТоварамОрганизаций(НачалоПериода, ОкончаниеПериода, МассивОрганизаций) Экспорт
	
	Запрос = Новый Запрос;
	Запрос.Текст =
	"ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	ДД.Регистратор КАК Ссылка,
	|	ДД.Организация КАК Организация
	|ИЗ
	|	РегистрНакопления.ТоварыОрганизаций КАК ДД
	|ГДЕ
	|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
	|	И ДД.Организация В (&МассивОрганизаций)
	|	И ДД.Первичное
	|	И ДД.Регистратор ССЫЛКА Документ.ВозвратМатериаловИзПроизводства";
	
	Запрос.УстановитьПараметр("НачалоПериода",     НачалоПериода);
	Запрос.УстановитьПараметр("ОкончаниеПериода",  ОкончаниеПериода);
	Запрос.УстановитьПараметр("МассивОрганизаций", МассивОрганизаций);
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	ВосстановитьДвиженияДокументовПоРегиструНакопления(
	    НачалоПериода,
	    ОкончаниеПериода,
	    МассивОрганизаций,
		Выборка,
		Метаданные.РегистрыНакопления.ТоварыОрганизаций.Имя);
	
КонецПроцедуры
//-- НЕ УТ

Процедура ИсправитьДвиженияВозвратТоваровМеждуОрганизациямиПоТоварамОрганизаций(НачалоПериода, ОкончаниеПериода, МассивОрганизаций)
	
	Запрос = Новый Запрос;
	Запрос.Текст = "
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	ДД.Регистратор КАК Ссылка,
	|	ДД.Организация КАК Организация
	|ИЗ
	|	РегистрНакопления.ТоварыОрганизаций КАК ДД
	|ГДЕ
	|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
	|	И ДД.Организация В (&МассивОрганизаций)
	|	И ДД.Регистратор ССЫЛКА Документ.ВозвратТоваровМеждуОрганизациями
	|	И ДД.Количество < 0
	|	И ДД.КорАналитикаУчетаНоменклатуры = ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка)
	|";
	
	Запрос.УстановитьПараметр("НачалоПериода",     НачалоПериода);
	Запрос.УстановитьПараметр("ОкончаниеПериода",  ОкончаниеПериода);
	Запрос.УстановитьПараметр("МассивОрганизаций", МассивОрганизаций);
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	ВосстановитьДвиженияДокументовПоРегиструНакопления(
	    НачалоПериода,
	    ОкончаниеПериода,
	    МассивОрганизаций,
		Выборка,
		Метаданные.РегистрыНакопления.ТоварыОрганизаций.Имя);
	
КонецПроцедуры

#КонецОбласти


#Область РегистрНакопления_ПартииТоваровОрганизаций

Процедура ВосстановитьДвиженияПоПартиямТоваров(НачалоПериода, ОкончаниеПериода, МассивОрганизаций) Экспорт
	
	Запрос = Новый Запрос("
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	ДД.Ссылка,
	|	ДД.Организация,
	|	СУММА(ДД.Количество)
	|ИЗ (
	|	ВЫБРАТЬ
	|		ДД.Регистратор КАК Ссылка,
	|		ДД.Организация КАК Организация,
	|		СУММА(ДД.Количество) КАК Количество
	|	ИЗ 
	|		РегистрНакопления.ТоварыОрганизаций КАК ДД
	|	ГДЕ
	|		ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
	|		И ДД.Организация В (&МассивОрганизаций)
	|		И ДД.Первичное
	|		И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|	СГРУППИРОВАТЬ ПО
	|		ДД.Регистратор,
	|		ДД.Организация
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		ДД.Регистратор КАК Ссылка,
	|		ДД.Организация КАК Организация,
	|		СУММА(ДД.Количество) КАК Количество
	|	ИЗ 
	|		РегистрНакопления.ТоварыКОформлениюДокументовИмпорта КАК ДД
	|	ГДЕ
	|		ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
	|		И ДД.Организация В (&МассивОрганизаций)
	|		И ДД.Первичное
	|		И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|		И ДД.ТипДокументаИмпорта = &ТипДокументаИмпорта
	|	СГРУППИРОВАТЬ ПО
	|		ДД.Регистратор,
	|		ДД.Организация
	|		
	|	ОБЪЕДИНИТЬ ВСЕ
	|		
	|	ВЫБРАТЬ
	|		ДД.Регистратор КАК Ссылка,
	|		ДД.ОрганизацияВладелец КАК Организация,
	|		СУММА(ДД.Количество) КАК Количество
	|	ИЗ 
	|		РегистрНакопления.ТоварыОрганизацийКПередаче КАК ДД
	|	ГДЕ
	|		ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
	|		И ДД.ВидЗапасовПродавца.Организация В (&МассивОрганизаций)
	|		И ДД.Первичное
	|		И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|	СГРУППИРОВАТЬ ПО
	|		ДД.Регистратор,
	|		ДД.ОрганизацияВладелец
	|		
	|	ОБЪЕДИНИТЬ ВСЕ
	|		
	|	ВЫБРАТЬ
	|		ДД.Регистратор КАК Ссылка,
	|		ДД.ВидЗапасов.Организация КАК Организация,
	|		СУММА(ДД.КоличествоСписано) КАК Количество
	|	ИЗ 
	|		РегистрНакопления.ТоварыКОформлениюОтчетовКомитенту КАК ДД
	|	ГДЕ
	|		ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
	|		И ДД.ВидЗапасов.Организация В (&МассивОрганизаций)
	|		И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|	СГРУППИРОВАТЬ ПО
	|		ДД.Регистратор,
	|		ДД.ВидЗапасов.Организация
	|		
	|	ОБЪЕДИНИТЬ ВСЕ
	|		
	|	ВЫБРАТЬ
	|		ДД.Регистратор КАК Ссылка,
	|		ДД.Организация КАК Организация,
	|		СУММА(-ДД.Количество) КАК Количество
	|	ИЗ 
	|		РегистрНакопления.ПартииТоваровОрганизаций КАК ДД
	|	ГДЕ
	|		ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
	|		И ДД.Организация В (&МассивОрганизаций)
	|		И ДД.Первичное
	|		И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|	СГРУППИРОВАТЬ ПО
	|		ДД.Регистратор,
	|		ДД.Организация
	|	) КАК ДД
	|СГРУППИРОВАТЬ ПО
	|	ДД.Ссылка,
	|	ДД.Организация
	|ИМЕЮЩИЕ
	|	СУММА(ДД.Количество) <> 0
	|");
	
	Запрос.УстановитьПараметр("НачалоПериода",     НачалоПериода);
	Запрос.УстановитьПараметр("ОкончаниеПериода",  ОкончаниеПериода);
	Запрос.УстановитьПараметр("МассивОрганизаций", МассивОрганизаций);
	Запрос.УстановитьПараметр("ТипДокументаИмпорта", ОбщегоНазначения.ИдентификаторОбъектаМетаданных("Документ.ТаможеннаяДекларацияИмпорт"));
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	ВосстановитьДвиженияДокументовПоРегиструНакопления(
	    НачалоПериода,
	    ОкончаниеПериода,
	    МассивОрганизаций,
		Выборка,
		Метаданные.РегистрыНакопления.ПартииТоваровОрганизаций.Имя);
	
КонецПроцедуры

#КонецОбласти

#Область РегистрНакопления_СебестоимостьТоваров

Процедура ИсправитьДвиженияПеремещенийТоваровПоСебестоимостиТоваров(НачалоПериода, ОкончаниеПериода, МассивОрганизаций)
	
	Запрос = Новый Запрос;
	Запрос.Текст = "
	|ВЫБРАТЬ
	|	ДД.Регистратор КАК Ссылка,
	|	ДД.Организация КАК Организация
	|ИЗ 
	|	РегистрНакопления.СебестоимостьТоваров КАК ДД
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ПеремещениеТоваров КАК Перемещение
	|		ПО Перемещение.Ссылка = ДД.Регистратор
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ВидыЗапасов КАК СпрВидыЗапасов
	|		ПО СпрВидыЗапасов.Ссылка = ДД.ВидЗапасов
	|ГДЕ
	|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
	|	И ДД.Организация В (&МассивОрганизаций)
	|	И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|	И СпрВидыЗапасов.РеализацияЗапасовДругойОрганизации
	|";
	
	Запрос.УстановитьПараметр("НачалоПериода",     НачалоПериода);
	Запрос.УстановитьПараметр("ОкончаниеПериода",  ОкончаниеПериода);
	Запрос.УстановитьПараметр("МассивОрганизаций", МассивОрганизаций);
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	ВосстановитьДвиженияДокументовПоРегиструНакопления(
	    НачалоПериода,
	    ОкончаниеПериода,
	    МассивОрганизаций,
		Выборка,
		Метаданные.РегистрыНакопления.СебестоимостьТоваров.Имя);
	
КонецПроцедуры

Процедура ЗаполнитьКорОрганизациюВОперацияхРеглУчет(НачалоПериода, ОкончаниеПериода, МассивОрганизаций)
	
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("НачалоПериода",     НачалоПериода);
	Запрос.УстановитьПараметр("ОкончаниеПериода",  ОкончаниеПериода);
	Запрос.УстановитьПараметр("МассивОрганизаций", МассивОрганизаций);
	
	Запрос.Текст =
		"ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	Т.Регистратор				КАК Ссылка,
		|	Т.Организация				КАК Организация
		|ИЗ
		|	РегистрНакопления.СебестоимостьТоваров КАК Т
		|ГДЕ
		|	Т.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И Т.Активность
		|	И Т.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		|	И Т.ХозяйственнаяОперация В (
		|		ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ЗакупкаУПоставщикаРеглУчет),
		|		ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РеализацияКлиентуРеглУчет))
		|	И Т.КорОрганизация = ЗНАЧЕНИЕ(Справочник.Организации.ПустаяСсылка)
		|";
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	Если Не Выборка.Количество() Тогда
		Возврат;
	КонецЕсли;
	
	ВосстановитьДвиженияДокументовПоРегиструНакопления(
	    НачалоПериода,
	    ОкончаниеПериода,
	    МассивОрганизаций,
		Выборка,
		"СебестоимостьТоваров");
			
КонецПроцедуры

Процедура ИсправитьКорОрганизациюВВозвратеМеждуОрганизациями(НачалоПериода, ОкончаниеПериода, МассивОрганизаций)
	
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("НачалоПериода",     НачалоПериода);
	Запрос.УстановитьПараметр("ОкончаниеПериода",  ОкончаниеПериода);
	Запрос.УстановитьПараметр("МассивОрганизаций", МассивОрганизаций);
	
	Запрос.Текст =
		"ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	Т.Регистратор				КАК Ссылка,
		|	Т.Организация				КАК Организация
		|ИЗ
		|	РегистрНакопления.СебестоимостьТоваров КАК Т
		|ГДЕ
		|	Т.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И Т.Активность
		|	И Т.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		|	И Т.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВозвратТоваровМеждуОрганизациями)
		|	И Т.КорОрганизация <> ЗНАЧЕНИЕ(Справочник.Организации.ПустаяСсылка)
		|";
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	Если Не Выборка.Количество() Тогда
		Возврат;
	КонецЕсли;
	
	ВосстановитьДвиженияДокументовПоРегиструНакопления(
	    НачалоПериода,
	    ОкончаниеПериода,
	    МассивОрганизаций,
		Выборка,
		"СебестоимостьТоваров");
			
КонецПроцедуры

Процедура ИсправитьКорОрганизациюВИсправлениеРазвернутогоСальдо(НачалоПериода, ОкончаниеПериода, МассивОрганизаций)
	
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("НачалоПериода",     НачалоПериода);
	Запрос.УстановитьПараметр("ОкончаниеПериода",  ОкончаниеПериода);
	Запрос.УстановитьПараметр("МассивОрганизаций", МассивОрганизаций);
	
	Запрос.Текст =
	"ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	Т.Регистратор				КАК Ссылка,
	|	Т.Организация				КАК Организация
	|ИЗ
	|	РегистрНакопления.ТоварыОрганизаций КАК Т
	|ГДЕ
	|	Т.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
	|	И Т.Регистратор ССЫЛКА Документ.ИсправлениеРазвернутогоСальдоТоваровОрганизаций
	|	И Т.ОрганизацияОтгрузки = ЗНАЧЕНИЕ(Справочник.Организации.ПустаяСсылка)
	|	И Т.Активность
	|";
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	Если Не Выборка.Количество() Тогда
		Возврат;
	КонецЕсли;
	
	ВосстановитьДвиженияДокументовПоРегиструНакопления(
	    НачалоПериода,
	    ОкончаниеПериода,
	    МассивОрганизаций,
		Выборка,
		"ТоварыОрганизаций");
			
КонецПроцедуры

Процедура ВосстановитьДвиженияПрочегоОприходованияТоваровПоСебестоимостиТоваров(НачалоПериода, ОкончаниеПериода, МассивОрганизаций) Экспорт
	
	Запрос = Новый Запрос;
	Запрос.Текст = ТекстЗапросаПрочиеОприходованияТоваровСДублямиДвиженийСебестоимостиТоваров();
	
	Запрос.УстановитьПараметр("НачалоПериода",     НачалоПериода);
	Запрос.УстановитьПараметр("ОкончаниеПериода",  ОкончаниеПериода);
	Запрос.УстановитьПараметр("МассивОрганизаций", МассивОрганизаций);
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	ВосстановитьДвиженияДокументовПоРегиструНакопления(
	    НачалоПериода,
	    ОкончаниеПериода,
	    МассивОрганизаций,
		Выборка,
		Метаданные.РегистрыНакопления.СебестоимостьТоваров.Имя);
	
	КонецПроцедуры
	
// Возвращает текст запроса, позволяющего получить список документов ПрочееОприходованиеТоваров
// с некорректными (задублированными) движениями по себестоимости товаров.
//
//	Возвращаемое значение:
//		Строка - текст запроса
//
Функция ТекстЗапросаПрочиеОприходованияТоваровСДублямиДвиженийСебестоимостиТоваров() Экспорт
	Возврат "
		|ВЫБРАТЬ
		|	ДД.Ссылка,
		|	ДД.Организация
		|ИЗ (
		|	ВЫБРАТЬ
		|		ДД.Регистратор КАК Ссылка,
		|		ДД.Организация КАК Организация,
		|		СУММА(ДД.Количество) КАК Количество
		|	ИЗ 
		|		РегистрНакопления.СебестоимостьТоваров КАК ДД
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ПрочееОприходованиеТоваров КАК Оприходование
		|			ПО Оприходование.Ссылка = ДД.Регистратор
		|	ГДЕ
		|		ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|		И ДД.Организация В (&МассивОрганизаций)
		|	СГРУППИРОВАТЬ ПО
		|		ДД.Регистратор,
		|		ДД.Организация
		|	
		|	ОБЪЕДИНИТЬ ВСЕ
		|	
		|	ВЫБРАТЬ
		|		ДД.Регистратор КАК Ссылка,
		|		ДД.Организация КАК Организация,
		|		СУММА(-ДД.Количество) КАК Количество
		|	ИЗ 
		|		РегистрНакопления.ТоварыОрганизаций КАК ДД
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ПрочееОприходованиеТоваров КАК Оприходование
		|			ПО Оприходование.Ссылка = ДД.Регистратор
		|	ГДЕ
		|		ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|		И ДД.Организация В (&МассивОрганизаций)
		|	СГРУППИРОВАТЬ ПО
		|		ДД.Регистратор,
		|		ДД.Организация
		|		
		|	) КАК ДД
		|СГРУППИРОВАТЬ ПО
		|	ДД.Ссылка,
		|	ДД.Организация
		|	
		|ИМЕЮЩИЕ
		|	СУММА(ДД.Количество) <> 0
		|";
КонецФункции

Процедура ВосстановитьДвиженияПоСебестоимостиТоваровСформированныеВВерсииПУ22(НачалоПериода, ОкончаниеПериода, МассивОрганизаций) Экспорт
	
	ПартионныйУчетВключен = РасчетСебестоимостиПовтИсп.ПартионныйУчетВерсии21(НачалоПериода);
	
	Если ПартионныйУчетВключен Тогда
		Возврат; // поддерживается только переход ПУ 2.2 -> ПУ выключен
	КонецЕсли;
	
	Запрос = Новый Запрос;
	
	// Перепроведем документы с заполненными полями партионного учета версии 2.2.
	Запрос.Текст = ТекстЗапросаДвиженияПоСебестоимостиТоваровСформированныеВВерсииПУ22();
	
	Запрос.УстановитьПараметр("НачалоПериода",     НачалоПериода);
	Запрос.УстановитьПараметр("ОкончаниеПериода",  ОкончаниеПериода);
	Запрос.УстановитьПараметр("МассивОрганизаций", МассивОрганизаций);
	Запрос.УстановитьПараметр("ТипыЗаписейКонвертацииДанных",
		РасчетСебестоимостиПрикладныеАлгоритмы.ТипыЗаписейКонвертацииДанных());
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	ВосстановитьДвиженияДокументовПоРегиструНакопления(
	    НачалоПериода,
	    ОкончаниеПериода,
	    МассивОрганизаций,
		Выборка,
		Метаданные.РегистрыНакопления.СебестоимостьТоваров.Имя);
	
	// Распроведем документы формирования начальных остатков партионного учета версии 2.2.
	Запрос.Текст = ТекстЗапросаДвиженияПоФормированиюОстатковСебестоимостиТоваровПУ22();
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	Пока Выборка.Следующий() Цикл
		ДокументОстатков = Выборка.Ссылка.ПолучитьОбъект();
		ДокументОстатков.Записать(РежимЗаписиДокумента.ОтменаПроведения);
	КонецЦикла;
	
КонецПроцедуры

Функция ТекстЗапросаДвиженияПоСебестоимостиТоваровСформированныеВВерсииПУ22() Экспорт
	Возврат
		"ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	ДД.Регистратор КАК Ссылка,
		|	ДД.Организация КАК Организация
		|ИЗ
		|	РегистрНакопления.СебестоимостьТоваров КАК ДД
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В(&МассивОрганизаций)
		|	И НЕ ДД.РасчетПартий
		|	И НЕ ДД.РасчетСебестоимости
		|	И ДД.Активность
		|	И НЕ ДД.Регистратор ССЫЛКА Документ.КорректировкаРегистров
		|	И (ДД.Партия <> НЕОПРЕДЕЛЕНО
		|		ИЛИ ДД.АналитикаУчетаПартий <> ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка)
		|		ИЛИ ДД.АналитикаФинансовогоУчета <> НЕОПРЕДЕЛЕНО
		|		ИЛИ ДД.ВидДеятельностиНДС <> ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка))
		|";
КонецФункции

Функция ТекстЗапросаДвиженияПоФормированиюОстатковСебестоимостиТоваровПУ22() Экспорт
	Возврат
		"ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	ДД.Регистратор КАК Ссылка
		|ИЗ
		|	РегистрНакопления.СебестоимостьТоваров КАК ДД
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В(&МассивОрганизаций)
		|	И ДД.ТипЗаписи В (&ТипыЗаписейКонвертацииДанных)
		|	И ДД.Активность
		|	И ДД.Регистратор ССЫЛКА Документ.РасчетСебестоимостиТоваров
		|";
КонецФункции

//++ НЕ УТ

Процедура ВосстановитьДвиженияПоОтчетамПереработчикаСНекорректнойАналитикой(НачалоПериода, ОкончаниеПериода, МассивОрганизаций) Экспорт
	
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("НачалоПериода",     НачалоПериода);
	Запрос.УстановитьПараметр("ОкончаниеПериода",  	   ОкончаниеПериода);
	Запрос.УстановитьПараметр("МассивОрганизаций", МассивОрганизаций);
	
	СписокРегистровКПерезаписи = Новый Массив;
	СписокРегистровКПерезаписи.Добавить("СебестоимостьТоваров");
	СписокРегистровКПерезаписи.Добавить("ПартииПроизводственныхЗатрат");
	СписокРегистровКПерезаписи.Добавить("ПартииНезавершенногоПроизводства");
	
	Запрос.Текст =
		"ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	Т.Регистратор				КАК Ссылка,
		|	Т.Организация				КАК Организация
		|ИЗ
		|	РегистрНакопления.СебестоимостьТоваров КАК Т
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ПартииПроизводственныхЗатрат КАК ПартииПроизводственныхЗатрат
		|		ПО Т.Регистратор = ПартииПроизводственныхЗатрат.Регистратор
		|			И Т.АналитикаУчетаНоменклатуры = ПартииПроизводственныхЗатрат.АналитикаУчетаНоменклатуры
		|			И (ПартииПроизводственныхЗатрат.Активность)
		|ГДЕ
		|	Т.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И Т.Активность
		|	И ТИПЗНАЧЕНИЯ(Т.Регистратор) = ТИП(Документ.ОтчетПереработчика)
		|	И Т.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ЗакупкаУПоставщика)
		|	И ПартииПроизводственныхЗатрат.Регистратор ЕСТЬ NULL";
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	Если Не Выборка.Количество() Тогда
		Возврат;
	КонецЕсли;
	
	Для Каждого РегистрКПерезаписи Из СписокРегистровКПерезаписи Цикл
		
		Выборка.Сбросить();
		
		ВосстановитьДвиженияДокументовПоРегиструНакопления(
		    НачалоПериода,
		    ОкончаниеПериода,
		    МассивОрганизаций,
			Выборка,
			РегистрКПерезаписи);
			
	КонецЦикла;
		
КонецПроцедуры
//-- НЕ УТ

#КонецОбласти

//++ НЕ УТ
#Область РегистрНакопления_ПартииПроизводственныхЗатрат

Процедура ВосстановитьДвиженияВыпускаПродукцииПоПартиямПроизводственныхЗатрат(НачалоПериода, ОкончаниеПериода, МассивОрганизаций) Экспорт
	
	Запрос = Новый Запрос;
	Запрос.Текст = ТекстЗапросаВыпускаПродукцииСНезаполненнымПодразделениемРасходов();
	
	Запрос.УстановитьПараметр("НачалоПериода",     НачалоПериода);
	Запрос.УстановитьПараметр("ОкончаниеПериода",  ОкончаниеПериода);
	Запрос.УстановитьПараметр("МассивОрганизаций", МассивОрганизаций);
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	ВосстановитьДвиженияДокументовПоРегиструНакопления(
	    НачалоПериода,
	    ОкончаниеПериода,
	    МассивОрганизаций,
		Выборка,
		Метаданные.РегистрыНакопления.ПартииПроизводственныхЗатрат.Имя);
	
КонецПроцедуры

// Возвращает текст запроса, позволяющего получить список документов ВыпускПродукции
// с незаполненным реквизитом ПодразделениеРасходов регистра накопления ПартииПроизводственныхЗатрат.
// Этот реквизит добавлен в версии 2.0.10.17х и не заполнен у документов, проведенных до этой версии.
//
//	Возвращаемое значение:
//		Строка - текст запроса
//
Функция ТекстЗапросаВыпускаПродукцииСНезаполненнымПодразделениемРасходов() Экспорт
	Возврат "
		|ВЫБРАТЬ
        |	Выпуск.Ссылка КАК Регистратор,
        |	Выпуск.Организация КАК Организация,
        |	ВыпускТовары.Подразделение КАК ПодразделениеРасходов,
        |	СУММА(ВыпускТовары.Количество) КАК Количество
        |ПОМЕСТИТЬ ВТВыпуск
        |ИЗ
        |	Документ.ВыпускПродукции.Товары КАК ВыпускТовары
        |		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ВыпускПродукции КАК Выпуск
        |		ПО ВыпускТовары.Ссылка = Выпуск.Ссылка
        |ГДЕ
        |	Выпуск.Дата МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И Выпуск.Организация В (&МассивОрганизаций)
        |	И Выпуск.Проведен
        |	И Выпуск.НаправлениеВыпуска = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукцииВПодразделение)
        |	И ВыпускТовары.СписатьНаРасходы
        |
        |СГРУППИРОВАТЬ ПО
        |	Выпуск.Ссылка,
        |	Выпуск.Организация,
        |	ВыпускТовары.Подразделение
        |;
        |
        |////////////////////////////////////////////////////////////////////////////////
        |ВЫБРАТЬ РАЗЛИЧНЫЕ
        |	Выпуск.Регистратор КАК Регистратор
        |ПОМЕСТИТЬ Регистраторы
        |ИЗ
        |	ВТВыпуск КАК Выпуск
        |ИНДЕКСИРОВАТЬ ПО
        |	Регистратор
        |;
        |
        |////////////////////////////////////////////////////////////////////////////////
        |ВЫБРАТЬ РАЗЛИЧНЫЕ
        |	Данные.Регистратор КАК Ссылка,
        |	Данные.Организация
        |ИЗ
        |	(ВЫБРАТЬ
        |		ДД.Регистратор КАК Регистратор,
        |		ДД.Организация КАК Организация,
        |		ДД.ПодразделениеРасходов КАК ПодразделениеРасходов,
        |		ДД.Количество КАК Количество
        |	ИЗ
        |		РегистрНакопления.ПартииПроизводственныхЗатрат КАК ДД
        |			ВНУТРЕННЕЕ СОЕДИНЕНИЕ Регистраторы КАК Регистраторы
        |			ПО ДД.Регистратор = Регистраторы.Регистратор
        |	ГДЕ
        |		ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
        |	
        |	ОБЪЕДИНИТЬ ВСЕ
        |	
        |	ВЫБРАТЬ
        |		Выпуск.Регистратор,
        |		Выпуск.Организация,
        |		Выпуск.ПодразделениеРасходов,
        |		-Выпуск.Количество
        |	ИЗ
        |		ВТВыпуск КАК Выпуск) КАК Данные
        |
        |СГРУППИРОВАТЬ ПО
        |	Данные.Регистратор,
        |	Данные.Организация,
        |	Данные.ПодразделениеРасходов
        |
        |ИМЕЮЩИЕ
        |	СУММА(Данные.Количество) <> 0
		|";
КонецФункции

#КонецОбласти

#Область РегистрНакопления_ПроизводственныеЗатраты

Процедура ВосстановитьДвиженияСписанияЗатратНаВыпускПоПроизводственнымЗатратам(НачалоПериода, ОкончаниеПериода, МассивОрганизаций) Экспорт
	
	Запрос = Новый Запрос;
	Запрос.Текст = ТекстЗапросаСписанияЗатратНаВыпускСНезаполненнымЗаказомНаПроизводство();
	
	Запрос.УстановитьПараметр("НачалоПериода",     НачалоПериода);
	Запрос.УстановитьПараметр("ОкончаниеПериода",  ОкончаниеПериода);
	Запрос.УстановитьПараметр("МассивОрганизаций", МассивОрганизаций);
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	ВосстановитьДвиженияДокументовПоРегиструНакопления(
	    НачалоПериода,
	    ОкончаниеПериода,
	    МассивОрганизаций,
		Выборка,
		Метаданные.РегистрыНакопления.МатериалыИРаботыВПроизводстве.Имя);
	
КонецПроцедуры

// Возвращает текст запроса, позволяющего получить список документов СписанияЗатратНаВыпуск
// с незаполненным реквизитом ЗаказНаПроизводство регистра накопления ПроизводственныеЗатраты.
// 
//	Возвращаемое значение:
//		Строка - текст запроса
//
Функция ТекстЗапросаСписанияЗатратНаВыпускСНезаполненнымЗаказомНаПроизводство() Экспорт
	
	Возврат "
        |ВЫБРАТЬ РАЗЛИЧНЫЕ
        |	ДД.Регистратор КАК Ссылка,
        |	ДД.Организация
        |ИЗ
        |	РегистрНакопления.МатериалыИРаботыВПроизводстве КАК ДД
		|ГДЕ
	    |	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Регистратор ССЫЛКА Документ.СписаниеЗатратНаВыпуск
		|	И ДД.ЗаказНаПроизводство = НЕОПРЕДЕЛЕНО
		|;";
			
КонецФункции

#КонецОбласти
//-- НЕ УТ

#Область РегистрНакопления_ВыручкаИСебестоимостьПродаж

Процедура ВосстановитьДвиженияДокументовСДублямиДвиженийПоВыручкеИСебестоимостиПродаж(НачалоПериода, ОкончаниеПериода, МассивОрганизаций) Экспорт
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		РасчетСебестоимостиПодготовкаДанных.ТекстЗапросаДокументыСДублямиДвиженийПоВыручкеИСебестоимостиПродаж()
		+ "
		|;
		|ВЫБРАТЬ
		|	Т.Ссылка,
		|	Т.Организация
		|ИЗ
		|	ВТРегистраторыСНекорректнымиДвижениями КАК Т";
	
	Запрос.УстановитьПараметр("НачалоПериода",     НачалоПериода);
	Запрос.УстановитьПараметр("КонецПериода",  	   ОкончаниеПериода);
	Запрос.УстановитьПараметр("МассивОрганизаций", МассивОрганизаций);
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	ВосстановитьДвиженияДокументовПоРегиструНакопления(
	    НачалоПериода,
	    ОкончаниеПериода,
	    МассивОрганизаций,
		Выборка,
		Метаданные.РегистрыНакопления.ВыручкаИСебестоимостьПродаж.Имя);
	
КонецПроцедуры

Процедура ВосстановитьДвиженияПоВыручкеИСебестоимостиПродажСформированныеВВерсииПУ22(НачалоПериода, ОкончаниеПериода, МассивОрганизаций) Экспорт
	
	ПартионныйУчетВключен = РасчетСебестоимостиПовтИсп.ПартионныйУчетВерсии21(НачалоПериода);
	
	Если ПартионныйУчетВключен Тогда
		Возврат; // поддерживается только переход ПУ 2.2 -> ПУ выключен
	КонецЕсли;
	
	Запрос = Новый Запрос;
	
	// Перепроведем документы с заполненными полями партионного учета версии 2.2.
	Запрос.Текст = ТекстЗапросаДвиженияПоВыручкеИСебестоимостиПродажСформированныеВВерсииПУ22();
	
	Запрос.УстановитьПараметр("НачалоПериода",     НачалоПериода);
	Запрос.УстановитьПараметр("ОкончаниеПериода",  ОкончаниеПериода);
	Запрос.УстановитьПараметр("МассивОрганизаций", МассивОрганизаций);
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	ВосстановитьДвиженияДокументовПоРегиструНакопления(
	    НачалоПериода,
	    ОкончаниеПериода,
	    МассивОрганизаций,
		Выборка,
		Метаданные.РегистрыНакопления.ВыручкаИСебестоимостьПродаж.Имя);
	
КонецПроцедуры

Функция ТекстЗапросаДвиженияПоВыручкеИСебестоимостиПродажСформированныеВВерсииПУ22() Экспорт
	Возврат
		"ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	ДД.Регистратор КАК Ссылка,
		|	Аналитики.Организация КАК Организация
		|ИЗ
		|	РегистрНакопления.ВыручкаИСебестоимостьПродаж КАК ДД
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаПоПартнерам КАК Аналитики
		|		ПО ДД.АналитикаУчетаПоПартнерам = Аналитики.Ссылка
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И Аналитики.Организация В(&МассивОрганизаций)
		|	И НЕ ДД.РасчетСебестоимости
		|	И ДД.Активность
		|	И НЕ ДД.Регистратор ССЫЛКА Документ.КорректировкаРегистров
		|	И (ДД.Партия <> НЕОПРЕДЕЛЕНО
		|		ИЛИ ДД.АналитикаУчетаПартий <> ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка))
		|";
КонецФункции

#КонецОбласти

#Область УчетСебестоимостиПоВидамЗапасовИНазначениям

// Определяется перечень документов, движения которых не соответствуют условиям:
//	- в движениях не заполнен вид запасов кроме исключений, описанных ниже
//	- движения не соответствуют состоянию функциональной опция учета себестоимости по назначениям

Процедура ЗаполнитьВидыЗапасовИНазначенияВСебестоимостиТоваров(НачалоПериода, ОкончаниеПериода, МассивОрганизаций)
	
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("НачалоПериода",     НачалоПериода);
	Запрос.УстановитьПараметр("КонецПериода",  	   ОкончаниеПериода);
	Запрос.УстановитьПараметр("МассивОрганизаций", МассивОрганизаций);
	Запрос.УстановитьПараметр("ПартионныйУчетВерсии22", Ложь);
	Запрос.УстановитьПараметр("УчитыватьСебестоимостьТоваровПоНазначениям",
		РасчетСебестоимостиПовтИсп.СебестоимостьТоваровПоНазначениям(НачалоПериода));
	Запрос.УстановитьПараметр("ИспользоватьУчетСебестоимости",
		РасчетСебестоимостиПовтИсп.ФормироватьДвиженияПоРегистрамСебестоимости(НачалоПериода));
	
	// Включение учета по видам запасов.
	Запрос.Текст =
		ТекстЗапросаВключениеУчетаСебестоимостиПоВидамЗапасовПУ21()
		+ "
		|;
		|ВЫБРАТЬ
		|	Т.Ссылка,
		|	Т.Организация
		|ИЗ
		|	ВТРегистраторыСНекорректнымиДвижениями КАК Т";
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	ВосстановитьДвиженияДокументовПоРегиструНакопления(
	    НачалоПериода,
	    ОкончаниеПериода,
	    МассивОрганизаций,
		Выборка,
		Метаданные.РегистрыНакопления.СебестоимостьТоваров.Имя);
		
	// Выключение учета по назначениям.	
	Запрос.Текст =
		 РасчетСебестоимостиПодготовкаДанных.ТекстЗапросаВыключениеУчетаСебестоимостиПоНазначениям()
		+ "
		|;
		|ВЫБРАТЬ
		|	Т.Ссылка,
		|	Т.Организация
		|ИЗ
		|	ВТРегистраторыСНекорректнымиДвижениями КАК Т";
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	ВосстановитьДвиженияДокументовПоРегиструНакопления(
	    НачалоПериода,
	    ОкончаниеПериода,
	    МассивОрганизаций,
		Выборка,
		Метаданные.РегистрыНакопления.СебестоимостьТоваров.Имя);
		
	// Включение учета по назначениям.
	Запрос.Текст =
		РасчетСебестоимостиПодготовкаДанных.ТекстЗапросаВключениеУчетаСебестоимостиПоНазначениям()
		+ "
		|;
		|ВЫБРАТЬ
		|	Т.Ссылка,
		|	Т.Организация
		|ИЗ
		|	ВТРегистраторыСНекорректнымиДвижениями КАК Т";
	Запрос.УстановитьПараметр("ТипДокументаИмпорта", ОбщегоНазначения.ИдентификаторОбъектаМетаданных("Документ.ТаможеннаяДекларацияИмпорт"));
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	ВосстановитьДвиженияДокументовПоРегиструНакопления(
	    НачалоПериода,
	    ОкончаниеПериода,
	    МассивОрганизаций,
		Выборка,
		Метаданные.РегистрыНакопления.СебестоимостьТоваров.Имя);
	
	
КонецПроцедуры

Процедура ЗаполнитьВидыЗапасовИНазначенияВВыручкеИСебестоимостиПродаж(НачалоПериода, ОкончаниеПериода, МассивОрганизаций)
	
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("НачалоПериода",     НачалоПериода);
	Запрос.УстановитьПараметр("КонецПериода",  	   ОкончаниеПериода);
	Запрос.УстановитьПараметр("МассивОрганизаций", МассивОрганизаций);
	Запрос.УстановитьПараметр("УчитыватьСебестоимостьТоваровПоНазначениям",
		РасчетСебестоимостиПовтИсп.СебестоимостьТоваровПоНазначениям(НачалоПериода));
	Запрос.УстановитьПараметр("ИспользоватьУчетСебестоимости",
		РасчетСебестоимостиПовтИсп.ФормироватьДвиженияПоРегистрамСебестоимости(НачалоПериода));	
	
	// Включение учета по видам запасов.
	Запрос.Текст =
		РасчетСебестоимостиПодготовкаДанных.ТекстЗапросаВключениеУчетаВыручкиИСебестоимостиПродажПоВидамЗапасов()
		+ "
		|;
		|ВЫБРАТЬ
		|	Т.Ссылка,
		|	Т.Организация
		|ИЗ
		|	ВТРегистраторыСНекорректнымиДвижениями КАК Т";
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	ВосстановитьДвиженияДокументовПоРегиструНакопления(
	    НачалоПериода,
	    ОкончаниеПериода,
	    МассивОрганизаций,
		Выборка,
		Метаданные.РегистрыНакопления.ВыручкаИСебестоимостьПродаж.Имя);
		
	// Выключение учета по назначениям.	
	Запрос.Текст =
		РасчетСебестоимостиПодготовкаДанных.ТекстЗапросаВыключениеУчетаВыручкиИСебестоимостиПродажПоНазначениям()
		+ "
		|;
		|ВЫБРАТЬ
		|	Т.Ссылка,
		|	Т.Организация
		|ИЗ
		|	ВТРегистраторыСНекорректнымиДвижениями КАК Т";
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	ВосстановитьДвиженияДокументовПоРегиструНакопления(
	    НачалоПериода,
	    ОкончаниеПериода,
	    МассивОрганизаций,
		Выборка,
		Метаданные.РегистрыНакопления.ВыручкаИСебестоимостьПродаж.Имя);
		
	// Включение учета по назначениям.
	Запрос.Текст =
		РасчетСебестоимостиПодготовкаДанных.ТекстЗапросаВключениеУчетаВыручкиИСебестоимостиПродажПоНазначениям()
		+ "
		|;
		|ВЫБРАТЬ
		|	Т.Ссылка,
		|	Т.Организация
		|ИЗ
		|	ВТРегистраторыСНекорректнымиДвижениями КАК Т";
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	ВосстановитьДвиженияДокументовПоРегиструНакопления(
	    НачалоПериода,
	    ОкончаниеПериода,
	    МассивОрганизаций,
		Выборка,
		Метаданные.РегистрыНакопления.ВыручкаИСебестоимостьПродаж.Имя);
	
	
КонецПроцедуры

Функция ТекстЗапросаВключениеУчетаСебестоимостиПоВидамЗапасовПУ21()
	Возврат "
		|ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	""СебестоимостьТоваров""			КАК ИмяРегистра,
		|	СебестоимостьТоваров.Регистратор	КАК Ссылка,
		|	СебестоимостьТоваров.Организация	КАК Организация,
		|	1									КАК КодОшибки
		|ПОМЕСТИТЬ ВТРегистраторыСНекорректнымиДвижениями
		|ИЗ
		|	РегистрНакопления.СебестоимостьТоваров КАК СебестоимостьТоваров
		|ГДЕ
		|	СебестоимостьТоваров.Период МЕЖДУ &НачалоПериода И &КонецПериода
		|	И СебестоимостьТоваров.Организация В(&МассивОрганизаций)
		|	И СебестоимостьТоваров.ВидЗапасов = ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка)
		// Выбираем движения с ненулевым количеством, что бы исключеить оффлайные движения
		// т.к. при партионном учета 2.1 нет формального признака, выделяющего оффлайновые движения (например, распределение доп. расходов)
		|	И (СебестоимостьТоваров.Количество <> 0
		// Выбираем движения документа "Таможенная декларация на импорт"
		|		ИЛИ СебестоимостьТоваров.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыСПартией)
		|		ИЛИ СебестоимостьТоваров.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыБезПартии)
		// Выбираем движения документов "Заявление о ввозе товаров с ЕАЭС" и "Корректировка приобретения"
		|		ИЛИ СебестоимостьТоваров.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.КорректировкаСтоимости)
		|		ИЛИ СебестоимостьТоваров.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.КорректировкаПриобретенияПрошлогоПериода))
		|	И СебестоимостьТоваров.АналитикаУчетаНоменклатуры.Номенклатура.ТипНоменклатуры <> ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.Работа)
		// Товары, выкупленные у комитентов
		|	И НЕ (
		|		СебестоимостьТоваров.РазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыНаСкладах)
		|		И (СебестоимостьТоваров.АналитикаУчетаНоменклатуры.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Партнер)
		|			ИЛИ СебестоимостьТоваров.АналитикаУчетаНоменклатуры.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Организация)))
		//++ НЕ УТКА

		// Работы к оформлению отчетов давальцу
		|	И НЕ (
		|		СебестоимостьТоваров.РазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты)
		|		И СебестоимостьТоваров.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Партия)
		|		И СебестоимостьТоваров.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукции)
		|		И СебестоимостьТоваров.КорАналитикаУчетаНоменклатуры <> ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка))
		|	И ТИПЗНАЧЕНИЯ(СебестоимостьТоваров.Регистратор) <> ТИП(Документ.ОтчетДавальцу)	
		//-- НЕ УТКА
		|	И НЕ СебестоимостьТоваров.РасчетСебестоимости
		|	И НЕ СебестоимостьТоваров.Регистратор ССЫЛКА Документ.РасчетСебестоимостиТоваров
		|";
КонецФункции

#КонецОбласти

#Область РегистрНакопления_ПрочиеРасходы

Процедура ИсправитьДвиженияПриходовДопРасходовПоПрочимРасходам(НачалоПериода, ОкончаниеПериода, МассивОрганизаций)
	
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ
	               |	ДД.Регистратор КАК Ссылка,
	               |	ДД.Организация КАК Организация
	               |ИЗ
	               |	РегистрНакопления.ПрочиеРасходы КАК ДД
	               |		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрНакопления.ПартииПрочихРасходов КАК ПартииПрочихРасходов
	               |		ПО ДД.Регистратор = ПартииПрочихРасходов.ДокументПоступленияРасходов
	               |			И ДД.Организация = ПартииПрочихРасходов.Организация
	               |			И ДД.Подразделение = ПартииПрочихРасходов.Подразделение
	               |			И ДД.НаправлениеДеятельности = ПартииПрочихРасходов.НаправлениеДеятельности
	               |			И ДД.СтатьяРасходов = ПартииПрочихРасходов.СтатьяРасходов
	               |			И ДД.АналитикаРасходов = ПартииПрочихРасходов.АналитикаРасходов
	               |			И ДД.ХозяйственнаяОперация = ПартииПрочихРасходов.ХозяйственнаяОперация
	               |			И ДД.Сумма = ПартииПрочихРасходов.Стоимость
	               |			И ДД.СуммаРегл <> ПартииПрочихРасходов.СтоимостьРегл
	               |ГДЕ
	               |	ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	               |	И ДД.Организация В(&МассивОрганизаций)
	               |	И ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
	               |	И ТИПЗНАЧЕНИЯ(ДД.Регистратор) В (ТИП(Документ.ПриобретениеТоваровУслуг), ТИП(Документ.ПриобретениеУслугПрочихАктивов))";
	
	Запрос.УстановитьПараметр("НачалоПериода",     НачалоПериода);
	Запрос.УстановитьПараметр("ОкончаниеПериода",  ОкончаниеПериода);
	Запрос.УстановитьПараметр("МассивОрганизаций", МассивОрганизаций);
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	ВосстановитьДвиженияДокументовПоРегиструНакопления(
	    НачалоПериода,
	    ОкончаниеПериода,
	    МассивОрганизаций,
		Выборка,
		Метаданные.РегистрыНакопления.ПрочиеРасходы.Имя);
	
КонецПроцедуры

#КонецОбласти

// Исправление "внештатных" ситуаций в движениях документов
// По своей сути эти процедуры аналогичны обработчикам обновлений.
// Отличие в том, что обработчики должны поправить все данные в ИБ,
// а эти процедуры исправляют данные только в том периоде, по которому выполняется расчет партий.
// Такой подход позволяет не "портить" данные в уже рассчитанных и закрытых периодах.

Процедура ВосстановитьДвиженияДокументовПоРегиструНакопления(НачалоПериода, КонецПериода, МассивОрганизаций, ВыборкаДокументов, ИмяРегистраНакопления)
	
	ПараметрыРасчета = РасчетСебестоимостиПрикладныеАлгоритмы.ИнициализироватьОсновныеПараметрыРасчета(НачалоПериода, КонецПериода,  МассивОрганизаций);
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ВосстановитьДвиженияДокументовПоРегиструНакопления(
	    ПараметрыРасчета,
		ВыборкаДокументов,
		ИмяРегистраНакопления);
	
КонецПроцедуры

#КонецОбласти


#Область ОписаниеДанныхМеханизма

// Возвращает перечень объектов метаданных, на основании данных которых выполняется расчет партий.
//
// Параметры:
//	ВходящиеДанные - Соответствие - уже инициализированное хранилище для описания входящих данных
//	ТолькоТребующиеПерерасчета - Булево - если установлен, то будет возвращен перечень только тех данных,
//		изменение которых влечет за собой необходимость перерасчета партий и себестоимости
//		При изменении этих данных должна создаваться запись в регистре сведений ЗаданияКРасчетуСебестоимости.
//
// Возвращаемое значение:
//	Соответствие - Ключ - ОбъектМетаданных.
//
Функция ВходящиеДанныеМеханизма(ВходящиеДанные = Неопределено, ТолькоТребующиеПерерасчета = Ложь) Экспорт
	
	Если ВходящиеДанные = Неопределено Тогда
		ВходящиеДанные = Новый Соответствие;
	КонецЕсли;
	
	Если ТолькоТребующиеПерерасчета Тогда
		Значение = Истина; // чтобы можно было проверить вхождение объекта метаданных в это соответствие
	Иначе
		Значение = Неопределено;
	КонецЕсли;
	
	Если НЕ ТолькоТребующиеПерерасчета Тогда
		
		ВходящиеДанные.Вставить(Метаданные.Документы.ВнутреннееПотребление, Значение);
		ВходящиеДанные.Вставить(Метаданные.Документы.ВозвратТоваровМеждуОрганизациями, Значение);
		ВходящиеДанные.Вставить(Метаданные.Документы.ВозвратТоваровОтКлиента, Значение);
		ВходящиеДанные.Вставить(Метаданные.Документы.ЗаказНаПеремещение, Значение);
		ВходящиеДанные.Вставить(Метаданные.Документы.ЗаказПоставщику, Значение);
		ВходящиеДанные.Вставить(Метаданные.Документы.КорректировкаПриобретения, Значение);
		ВходящиеДанные.Вставить(Метаданные.Документы.ПередачаТоваровМеждуОрганизациями, Значение);
		ВходящиеДанные.Вставить(Метаданные.Документы.ПеремещениеТоваров, Значение);
		ВходящиеДанные.Вставить(Метаданные.Документы.ПриобретениеТоваровУслуг, Значение);
		ВходящиеДанные.Вставить(Метаданные.Документы.ПрочееОприходованиеТоваров, Значение);
		ВходящиеДанные.Вставить(Метаданные.Документы.РасчетСебестоимостиТоваров, Значение);
		ВходящиеДанные.Вставить(Метаданные.Документы.РеализацияТоваровУслуг, Значение);
		ВходящиеДанные.Вставить(Метаданные.Документы.СборкаТоваров, Значение);
		ВходящиеДанные.Вставить(Метаданные.Документы.ТаможеннаяДекларацияИмпорт, Значение);
		
		//++ НЕ УТ
		ВходящиеДанные.Вставить(Метаданные.Документы.ВозвратМатериаловИзПроизводства, Значение);
		ВходящиеДанные.Вставить(Метаданные.Документы.ВозвратСырьяОтПереработчика, Значение);
		ВходящиеДанные.Вставить(Метаданные.РегистрыНакопления.ВыпускПродукции, Значение);
		ВходящиеДанные.Вставить(Метаданные.Документы.СписаниеЗатратНаВыпуск, Значение);
		ВходящиеДанные.Вставить(Метаданные.Документы.ПоступлениеОтПереработчика, Значение);
		ВходящиеДанные.Вставить(Метаданные.Документы.ПеремещениеМатериаловВПроизводстве, Значение);
		ВходящиеДанные.Вставить(Метаданные.Документы.ОтчетПереработчика, Значение);
		ВходящиеДанные.Вставить(Метаданные.Документы.ПередачаМатериаловВПроизводство, Значение);
		ВходящиеДанные.Вставить(Метаданные.Документы.ВыпускПродукции, Значение);
		ВходящиеДанные.Вставить(Метаданные.Документы.ЗаказПереработчику, Значение);
		ВходящиеДанные.Вставить(Метаданные.Документы.ИзделияИЗатратыНЗП, Значение);
		//-- НЕ УТ

		//++ НЕ УТКА
		ВходящиеДанные.Вставить(Метаданные.Документы.МаршрутныйЛистПроизводства, Значение);
		ВходящиеДанные.Вставить(Метаданные.Документы.ЗаказДавальца, Значение);
		ВходящиеДанные.Вставить(Метаданные.Документы.ЗаказНаПроизводство, Значение);
		//-- НЕ УТКА
		
		ВходящиеДанные.Вставить(Метаданные.РегистрыСведений.АналитикаУчетаНоменклатуры, Значение);
		ВходящиеДанные.Вставить(Метаданные.РегистрыСведений.АналитикаУчетаПартий, Значение);
		ВходящиеДанные.Вставить(Метаданные.РегистрыСведений.ЗаданияКРасчетуСебестоимости, Значение);
		ВходящиеДанные.Вставить(Метаданные.РегистрыСведений.СтоимостьТоваров, Значение);
		ВходящиеДанные.Вставить(Метаданные.РегистрыСведений.УчетнаяПолитикаФинансовогоУчета, Значение);
		ВходящиеДанные.Вставить(Метаданные.РегистрыСведений.НастройкиУчетаНДС, Значение);
		ВходящиеДанные.Вставить(Метаданные.РегистрыСведений.ЦеныНоменклатуры, Значение);
		
		//++ НЕ УТ
		ВходящиеДанные.Вставить(Метаданные.РегистрыСведений.ДолиСписанияКосвенныхРасходов, Значение);
		ВходящиеДанные.Вставить(Метаданные.РегистрыСведений.ЗначенияПоказателейДляРаспределенияРасходов, Значение);
		//-- НЕ УТ
		
	КонецЕсли;
	
	ВходящиеДанные.Вставить(Метаданные.РегистрыНакопления.ДвиженияНоменклатураДоходыРасходы, Значение);
	ВходящиеДанные.Вставить(Метаданные.РегистрыНакопления.ЗаказыНаПеремещение, Значение);
	ВходящиеДанные.Вставить(Метаданные.РегистрыНакопления.ЗаказыПоставщикам, Значение);
	ВходящиеДанные.Вставить(Метаданные.РегистрыНакопления.МатериалыИРаботыВПроизводстве, Значение);
	ВходящиеДанные.Вставить(Метаданные.РегистрыНакопления.ПартииЗатратНаВыпуск, Значение);
	ВходящиеДанные.Вставить(Метаданные.РегистрыНакопления.ПартииПроизводственныхЗатрат, Значение);
	ВходящиеДанные.Вставить(Метаданные.РегистрыНакопления.ПартииПрочихРасходов, Значение);
	ВходящиеДанные.Вставить(Метаданные.РегистрыНакопления.ПартииРасходовНаСебестоимостьТоваров, Значение);
	ВходящиеДанные.Вставить(Метаданные.РегистрыНакопления.ПартииТоваровОрганизаций, Значение);
	ВходящиеДанные.Вставить(Метаданные.РегистрыНакопления.ПартииТоваровПереданныеНаКомиссию, Значение);
	ВходящиеДанные.Вставить(Метаданные.РегистрыНакопления.ПрочиеРасходы, Значение);
	ВходящиеДанные.Вставить(Метаданные.РегистрыНакопления.СебестоимостьТоваров, Значение);
	ВходящиеДанные.Вставить(Метаданные.РегистрыНакопления.ТоварыКОформлениюОтчетовКомитенту, Значение);
	ВходящиеДанные.Вставить(Метаданные.РегистрыНакопления.ТоварыОрганизаций, Значение);
	ВходящиеДанные.Вставить(Метаданные.РегистрыНакопления.ТоварыКОформлениюДокументовИмпорта, Значение);
	ВходящиеДанные.Вставить(Метаданные.РегистрыНакопления.ТоварыОрганизацийКПередаче, Значение);
	ВходящиеДанные.Вставить(Метаданные.РегистрыНакопления.РезервыТоваровОрганизаций, Значение);
	ВходящиеДанные.Вставить(Метаданные.РегистрыНакопления.ТоварыПереданныеНаКомиссию, Значение);
	
	//++ НЕ УТ
	ВходящиеДанные.Вставить(Метаданные.Документы.РаспределениеПроизводственныхЗатрат, Значение);
	ВходящиеДанные.Вставить(Метаданные.Документы.РаспределениеПрочихЗатрат, Значение);
	
	ВходящиеДанные.Вставить(Метаданные.РегистрыНакопления.ТоварыПолученныеОтПереработчика, Значение);
	ВходящиеДанные.Вставить(Метаданные.РегистрыНакопления.ТрудозатратыНезавершенногоПроизводства, Значение);
	ВходящиеДанные.Вставить(Метаданные.РегистрыНакопления.ПартииНезавершенногоПроизводства, Значение);
	ВходящиеДанные.Вставить(Метаданные.РегистрыНакопления.ПрочиеРасходыНезавершенногоПроизводства, Значение);
	ВходящиеДанные.Вставить(Метаданные.РегистрыНакопления.РаспоряженияНаСписаниеПоНормативам, Значение);
	//-- НЕ УТ

	//++ НЕ УТКА
	ВходящиеДанные.Вставить(Метаданные.РегистрыНакопления.ЭтапыПроизводства, Значение);
	ВходящиеДанные.Вставить(Метаданные.РегистрыНакопления.РаспоряженияНаВыпускПродукции, Значение);
	//-- НЕ УТКА
	
	Возврат ВходящиеДанные;
	
КонецФункции

// Возвращает перечень регистров, обслуживаемых механизмом расчета партий.
//
// Возвращаемое значение:
//	Соответствие - Ключ - ОбъектМетаданных.
//
Функция ИсходящиеДанныеМеханизма(ИсходящиеДанные = Неопределено) Экспорт
	
	// Перечень метаданных регистров, по которым формируются движения по партиям.
	Если ИсходящиеДанные = Неопределено Тогда
		ИсходящиеДанные = Новый Соответствие;
	КонецЕсли;
	
	Значение = Истина; // чтобы можно было проверить вхождение объекта метаданных в это соответствие
	
	ИсходящиеДанные.Вставить(Метаданные.РегистрыНакопления.ДвиженияНоменклатураДоходыРасходы, 		Значение);
	ИсходящиеДанные.Вставить(Метаданные.РегистрыНакопления.МатериалыИРаботыВПроизводстве, 			Значение);
	ИсходящиеДанные.Вставить(Метаданные.РегистрыНакопления.ПартииЗатратНаВыпуск, 					Значение);
	ИсходящиеДанные.Вставить(Метаданные.РегистрыНакопления.ПартииПроизводственныхЗатрат, 			Значение);
	ИсходящиеДанные.Вставить(Метаданные.РегистрыНакопления.ПартииПрочихРасходов, 					Значение);
	ИсходящиеДанные.Вставить(Метаданные.РегистрыНакопления.ПартииРасходовНаСебестоимостьТоваров, 	Значение);
	ИсходящиеДанные.Вставить(Метаданные.РегистрыНакопления.ПартииТоваровОрганизаций, 				Значение);
	ИсходящиеДанные.Вставить(Метаданные.РегистрыНакопления.ПартииТоваровПереданныеНаКомиссию, 		Значение);
	ИсходящиеДанные.Вставить(Метаданные.РегистрыНакопления.ПрочиеРасходы, 							Значение);
	ИсходящиеДанные.Вставить(Метаданные.РегистрыНакопления.СебестоимостьТоваров, 					Значение);
	ИсходящиеДанные.Вставить(Метаданные.РегистрыНакопления.ПартииНДСКРаспределению,					Значение);
	
	//++ НЕ УТ
	ИсходящиеДанные.Вставить(Метаданные.РегистрыНакопления.ПартииНезавершенногоПроизводства, 		Значение);
	ИсходящиеДанные.Вставить(Метаданные.РегистрыНакопления.ПрочиеРасходыНезавершенногоПроизводства, Значение);
	ИсходящиеДанные.Вставить(Метаданные.РегистрыНакопления.ТрудозатратыНезавершенногоПроизводства, 	Значение);
	//-- НЕ УТ
	
	Возврат ИсходящиеДанные;
	
КонецФункции

#КонецОбласти

// Контекстные методы заполнения новой расчетной партии по строке расхода и строке прихода.
#Область ЗаполнитьРасчетнуюПартию

// Используется для ВСЕХ вызовов заполнения расчетной партии
Процедура ЗаполнитьРасчетнуюПартию(Контекст, РасчетнаяПартия, Расход, Приход)
	Если Контекст = "ПартииТоваровОрганизаций" Тогда
		ЗаполнитьПартиюТоваров(РасчетнаяПартия, Расход, Приход);
		
	ИначеЕсли Контекст = "ПартииТоваровПереданныеНаКомиссию" Тогда
		ЗаполнитьПартиюПереданную(РасчетнаяПартия, Расход, Приход);
		
	ИначеЕсли Контекст = "ПартииЗатратНаВыпуск" Тогда
		ЗаполнитьПартиюЗатрат(РасчетнаяПартия, Расход, Приход);
		
	ИначеЕсли Контекст = "ЗаказыПоставщикам" Тогда
		ЗаполнитьЗаказВПриходе(РасчетнаяПартия, Расход, Приход);
		
	ИначеЕсли Контекст = "ПартииПрочихРасходов" Тогда
		ЗаполнитьПартиюПрочих(РасчетнаяПартия, Расход, Приход);
		
	ИначеЕсли Контекст = "ПартииРасходовНаСебестоимостьТоваровПриход" Тогда
		ЗаполнитьПриходПартииРасходов(РасчетнаяПартия, Расход, Приход);
		
	ИначеЕсли Контекст = "ПартииРасходовНаСебестоимостьТоваров" Тогда
		ЗаполнитьПартиюРасходов(РасчетнаяПартия, Расход, Приход);
		
	//++ НЕ УТ
	ИначеЕсли Контекст = "РаспределениеМатериаловИРабот" Тогда
		ЗаполнитьРаспределениеМатериаловИРабот(РасчетнаяПартия, Расход, Приход);
	//-- НЕ УТ	
		
	ИначеЕсли Контекст = "ПартииПроизводственныхЗатрат" Тогда
		ЗаполнитьПартиюПроизводственныхЗатрат(РасчетнаяПартия, Расход, Приход);
		
	//++ НЕ УТ
	ИначеЕсли Контекст = "ПартииНезавершенногоПроизводства" Тогда
		ЗаполнитьПартиюНезавершенногоПроизводства(РасчетнаяПартия, Расход, Приход);
		
	ИначеЕсли Контекст = "ТрудозатратыНезавершенногоПроизводства" Тогда
		ЗаполнитьТрудозатратыНезавершенногоПроизводства(РасчетнаяПартия, Расход, Приход);
		
	ИначеЕсли Контекст = "ПрочиеРасходыНезавершенногоПроизводстваПоБазе" Тогда
		ЗаполнитьПрочиеРасходыНезавершенногоПроизводстваПоБазе(РасчетнаяПартия, Расход, Приход);
		
	ИначеЕсли Контекст = "ПрочиеРасходыПоБазе" Тогда
		ЗаполнитьПрочиеРасходыПоБазе(РасчетнаяПартия, Расход, Приход);
		
	ИначеЕсли Контекст = "ПрочиеРасходыНезавершенногоПроизводства" Тогда
		ЗаполнитьПрочиеРасходыНезавершенногоПроизводства(РасчетнаяПартия, Расход, Приход);
	//-- НЕ УТ
	КонецЕсли;
КонецПроцедуры

Процедура ЗаполнитьПартиюТоваров(РасчетнаяПартия, Расход, Приход) // ПартииТоваровОрганизаций
	ЗаполнитьЗначенияСвойств(РасчетнаяПартия, Расход);
	
	Если ТипЗнч(РасчетнаяПартия.Регистратор) = Тип("ДокументСсылка.КорректировкаНалогообложенияНДСПартийТоваров")
	 И РасчетнаяПартия.ВидДвижения = ВидДвиженияНакопления.Расход
	 И Приход.НалогообложениеПартии <> Перечисления.ТипыНалогообложенияНДС.ПоФактическомуИспользованию Тогда
		Возврат;
	КонецЕсли;
	
	Если Расход.ТипЗаписи = "Корректировка" Тогда
		Если Расход.ВидДвижения = ВидДвиженияНакопления.Приход Тогда
			Приход.Количество = Приход.Количество + Расход.Количество;
			Приход.Стоимость = Приход.Стоимость + Расход.Стоимость;
			Приход.СтоимостьБезНДС = Приход.СтоимостьБезНДС + Расход.СтоимостьБезНДС;
			Приход.СтоимостьРегл = Приход.СтоимостьРегл + Расход.СтоимостьРегл;
			Приход.НДСРегл = Приход.НДСРегл + Расход.НДСРегл;
			Приход.ПостояннаяРазница = Приход.ПостояннаяРазница + Расход.ПостояннаяРазница;
			Приход.ВременнаяРазница = Приход.ВременнаяРазница + Расход.ВременнаяРазница;
		ИначеЕсли Приход.Количество = Расход.Количество Тогда
			РасчетнаяПартия.Стоимость = Приход.Стоимость;
			РасчетнаяПартия.СтоимостьБезНДС = Приход.СтоимостьБезНДС;
			РасчетнаяПартия.СтоимостьРегл = Приход.СтоимостьРегл;
			РасчетнаяПартия.НДСРегл = Приход.НДСРегл;
			РасчетнаяПартия.ПостояннаяРазница = Приход.ПостояннаяРазница;
			РасчетнаяПартия.ВременнаяРазница = Приход.ВременнаяРазница;
			
			Приход.Количество = 0;
			Приход.Стоимость = 0;
			Приход.СтоимостьБезНДС = 0;
			Приход.СтоимостьРегл = 0;
			Приход.НДСРегл = 0;
			Приход.ПостояннаяРазница = 0;
			Приход.ВременнаяРазница = 0;
		Иначе
			РасчетнаяПартия.Стоимость = Мин(Расход.Стоимость, Приход.Стоимость);
			РасчетнаяПартия.СтоимостьБезНДС = Мин(Расход.СтоимостьБезНДС, Приход.СтоимостьБезНДС);
			РасчетнаяПартия.СтоимостьРегл = Мин(Расход.СтоимостьРегл, Приход.СтоимостьРегл);
			РасчетнаяПартия.НДСРегл = Мин(Расход.НДСРегл, Приход.НДСРегл);
			РасчетнаяПартия.ПостояннаяРазница = Мин(Расход.ПостояннаяРазница, Приход.ПостояннаяРазница);
			РасчетнаяПартия.ВременнаяРазница = Мин(Расход.ВременнаяРазница, Приход.ВременнаяРазница);

			Приход.Количество = Приход.Количество - Расход.Количество;
			Приход.Стоимость = Приход.Стоимость - Мин(Расход.Стоимость, Приход.Стоимость);
			Приход.СтоимостьБезНДС = Приход.СтоимостьБезНДС - Мин(Расход.СтоимостьБезНДС, Приход.СтоимостьБезНДС);
			Приход.СтоимостьРегл = Приход.СтоимостьРегл - Мин(Расход.СтоимостьРегл, Приход.СтоимостьРегл);
			Приход.НДСРегл = Приход.НДСРегл - Мин(Расход.НДСРегл, Приход.НДСРегл);
			Приход.ПостояннаяРазница = Приход.ПостояннаяРазница - Мин(Расход.ПостояннаяРазница, Приход.ПостояннаяРазница);
			Приход.ВременнаяРазница = Приход.ВременнаяРазница - Мин(Расход.ВременнаяРазница, Приход.ВременнаяРазница);
		КонецЕсли;
		Расход.Стоимость = 0;
		Расход.СтоимостьБезНДС = 0;
		Расход.СтоимостьРегл = 0;
		Расход.НДСРегл = 0;
		Расход.ПостояннаяРазница = 0;
		Расход.ВременнаяРазница = 0;
		Расход.Количество = 0;
	Иначе	
		// расчетная партия заполняется на наибольшее общее вычитаемое
		Если Расход.ТипЗаписи = "Материал" И Приход.Количество <= Расход.Знаменатель Тогда
			Приход.Знаменатель = ?(Приход.Знаменатель = 0, Приход.Количество, Приход.Знаменатель);
			КоличествоСписания = Приход.Знаменатель / Расход.Знаменатель * Расход.Количество;
			РасчетнаяПартия.Знаменатель = Приход.Знаменатель;
			Расход.Знаменатель = Расход.Знаменатель - Приход.Знаменатель;
		Иначе
			Приход.Знаменатель = 0;
			КоличествоСписания = Мин(Расход.Количество, Приход.Количество);
		КонецЕсли;
		РасходБазис = ?(Расход.Количество <> 0, КоличествоСписания / Расход.Количество, 0);
		ПриходБазис = ?(Приход.Количество <> 0, КоличествоСписания / Приход.Количество, 0);
		
		РасходСтоимостьРегл = Окр(РасходБазис * Расход.СтоимостьРегл, 2);
		РасходНДСРегл = Окр(РасходБазис * Расход.НДСРегл, 2);
		РасходПостояннаяРазница = Окр(РасходБазис * Расход.ПостояннаяРазница, 2);
		РасходВременнаяРазница = Окр(РасходБазис * Расход.ВременнаяРазница, 2);
		
		ПриходСтоимостьРегл = Окр(ПриходБазис * Приход.СтоимостьРегл, 2);
		ПриходНДСРегл = Окр(ПриходБазис * Приход.НДСРегл, 2);
		ПриходПостояннаяРазница = Окр(ПриходБазис * Приход.ПостояннаяРазница, 2);
		ПриходВременнаяРазница = Окр(ПриходБазис * Приход.ВременнаяРазница, 2);
		
		// заполняем показатели расчетной партии
		РасчетнаяПартия.Стоимость = Окр(ПриходБазис * Приход.Стоимость, 2);
		РасчетнаяПартия.СтоимостьБезНДС = Окр(ПриходБазис * Приход.СтоимостьБезНДС, 2);
		РасчетнаяПартия.Количество = Окр(КоличествоСписания, 3);
		
		Если РасчетнаяПартия.СохранятьРегл Тогда
			РасчетнаяПартия.СтоимостьРегл = РасходСтоимостьРегл;
			РасчетнаяПартия.НДСРегл = РасходНДСРегл;
			РасчетнаяПартия.ПостояннаяРазница = РасходПостояннаяРазница;
			РасчетнаяПартия.ВременнаяРазница = РасходВременнаяРазница;
		Иначе
			Если РасчетнаяПартия.ВидДвижения = ВидДвиженияНакопления.Приход
			  И Приход.НалогообложениеНДС = Перечисления.ТипыНалогообложенияНДС.ОпределяетсяРаспределением Тогда
				РасчетнаяПартия.СтоимостьРегл = ПриходСтоимостьРегл;
				РасчетнаяПартия.НДСРегл = 0;
			ИначеЕсли РасчетнаяПартия.ТипЗаписи = "Перемещение"
			 И ТипЗнч(РасчетнаяПартия.Регистратор) = Тип("ДокументСсылка.ПересортицаТоваров") Тогда
			 	Если Приход.НалогообложениеНДС = Перечисления.ТипыНалогообложенияНДС.ПродажаНеОблагаетсяНДС
				 ИЛИ Приход.НалогообложениеНДС = Перечисления.ТипыНалогообложенияНДС.ПродажаОблагаетсяЕНВД Тогда
					РасчетнаяПартия.СтоимостьРегл = ПриходСтоимостьРегл + ПриходНДСРегл;
				Иначе
					РасчетнаяПартия.СтоимостьРегл = ПриходСтоимостьРегл;
				КонецЕсли;
				РасчетнаяПартия.НДСРегл = 0;
		 	Иначе
			 	РасчетнаяПартия.СтоимостьРегл = ПриходСтоимостьРегл;
				РасчетнаяПартия.НДСРегл = ПриходНДСРегл;
			КонецЕсли;
			РасчетнаяПартия.ПостояннаяРазница = ПриходПостояннаяРазница;
			РасчетнаяПартия.ВременнаяРазница = ПриходВременнаяРазница;
		КонецЕсли;
		
		// корректируем базу расчета в потреблении
		Расход.Стоимость = Расход.Стоимость - Окр(РасходБазис * Расход.Стоимость, 2);
		Расход.СтоимостьБезНДС = Расход.СтоимостьБезНДС - Окр(РасходБазис * Расход.СтоимостьБезНДС, 2);
		Расход.СтоимостьРегл = Расход.СтоимостьРегл - РасходСтоимостьРегл;
		Расход.НДСРегл = Расход.НДСРегл - РасходНДСРегл;
		Расход.ПостояннаяРазница = Расход.ПостояннаяРазница - РасходПостояннаяРазница;
		Расход.ВременнаяРазница = Расход.ВременнаяРазница - РасходВременнаяРазница;
		Расход.Количество = Расход.Количество - РасчетнаяПартия.Количество;
		
		// корректируем базу расчета в приходе
		Если НЕ (Расход.ТипЗаписи = "Перемещение"
		 И (Расход.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.РеализацияКлиентуРеглУчет
		  ИЛИ Расход.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.РеализацияТоваровВДругуюОрганизацию)) Тогда
			Приход.Стоимость = Приход.Стоимость - РасчетнаяПартия.Стоимость;
			Приход.СтоимостьБезНДС = Приход.СтоимостьБезНДС - РасчетнаяПартия.СтоимостьБезНДС;
			Приход.СтоимостьРегл = Приход.СтоимостьРегл - ПриходСтоимостьРегл;
			Приход.НДСРегл = Приход.НДСРегл - ПриходНДСРегл;
			Приход.ПостояннаяРазница = Приход.ПостояннаяРазница - ПриходПостояннаяРазница;
			Приход.ВременнаяРазница = Приход.ВременнаяРазница - ПриходВременнаяРазница;
			Приход.Количество = Приход.Количество - РасчетнаяПартия.Количество;
		КонецЕсли;
	
		// Заполняем партионную идентификацию в расчетной партии
		Если Не ЗначениеЗаполнено(РасчетнаяПартия.ДокументПоступления)
		 ИЛИ Не ЗначениеЗаполнено(Расход.РазделУчета)
		 ИЛИ Расход.ТипЗаписи = "Потребление" Тогда
			РасчетнаяПартия.ДокументПоступления = Приход.ДокументПоступления;
			Если (РасчетнаяПартия.ТипЗаписи <> "Сторно") Тогда
				РасчетнаяПартия.ПериодПоступления = Приход.ПериодПоступления;
			КонецЕсли;
		КонецЕсли;
		Если Приход.ТипЗаписи = "Возврат"
		 ИЛИ Приход.РазделУчета = Перечисления.РазделыУчетаСебестоимостиТоваров.ТоварыПереданныеНаКомиссию Тогда
			РасчетнаяПартия.ДокументИсточник = Приход.ДокументИсточник;
		КонецЕсли;
		Если Приход.РазделУчета = Перечисления.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты
		 И Расход.РазделУчета = Перечисления.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты Тогда
			РасчетнаяПартия.ДокументИсточник = Приход.ДокументИсточник;
		КонецЕсли;
		Если РасчетнаяПартия.ТипЗаписи = "Сторно"
		 И (Приход.ТипЗаписи = "Потребление" ИЛИ Приход.ТипЗаписи = "ВозвратКомиссия" ИЛИ Приход.ТипЗаписи = "Перемещение")
		 И (Приход.РазделУчета = Перечисления.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты
			ИЛИ Приход.РазделУчета = Перечисления.РазделыУчетаСебестоимостиТоваров.ТоварыПереданныеНаКомиссию) Тогда
			РасчетнаяПартия.ДокументИсточник = Приход.ДокументИсточник;
		КонецЕсли;
		Если Не ЗначениеЗаполнено(РасчетнаяПартия.ДокументИсточник) Тогда
			РасчетнаяПартия.ДокументИсточник = Приход.Регистратор;
		КонецЕсли;
		Если Не ЗначениеЗаполнено(РасчетнаяПартия.ВидЗапасов) Тогда
			РасчетнаяПартия.ВидЗапасов = Приход.ВидЗапасов;
		КонецЕсли;
		Если Не ЗначениеЗаполнено(РасчетнаяПартия.КорВидЗапасов) И РасчетнаяПартия.ТипЗаписи <> "Перемещение" Тогда
			РасчетнаяПартия.КорВидЗапасов = Приход.ВидЗапасов;
		КонецЕсли;
		Если Не ЗначениеЗаполнено(РасчетнаяПартия.АналитикаУчетаПартий) Тогда
			Если (РасчетнаяПартия.ВидДвижения = ВидДвиженияНакопления.Приход ИЛИ РасчетнаяПартия.ТипЗаписи = "Сторно")
			//++ НЕ УТ
			 И ТипЗнч(РасчетнаяПартия.Регистратор) <> Тип("ДокументСсылка.ВозвратСырьяОтПереработчика")
			//-- НЕ УТ
			 И ТипЗнч(РасчетнаяПартия.Регистратор) <> Тип("ДокументСсылка.КорректировкаРеализации")
			Тогда
				РасчетнаяПартия.АналитикаУчетаПартий =
					АналитикаУчетаПартий(Приход.АналитикаУчетаПартий, Приход.НалогообложениеПартии, Приход.НалогообложениеНДС);
				Если ЗначениеЗаполнено(Приход.НалогообложениеНДС) Тогда
					РасчетнаяПартия.НалогообложениеПартии = Приход.НалогообложениеНДС;
				Иначе
					РасчетнаяПартия.НалогообложениеПартии = Приход.НалогообложениеПартии;
				КонецЕсли;
			Иначе
				РасчетнаяПартия.АналитикаУчетаПартий = Приход.АналитикаУчетаПартий;
				РасчетнаяПартия.НалогообложениеПартии = Приход.НалогообложениеПартии;
			КонецЕсли;
		КонецЕсли;
		
		ЗаполнитьСтатьюИАналитикуСписанияНДС(РасчетнаяПартия, Расход, Приход);
		
	КонецЕсли;
	// По результатам партионной идентификации определяем завершенность расчета
	РасчетнаяПартия.РасчетЗавершен = Приход.РасчетЗавершен;
КонецПроцедуры

Процедура ЗаполнитьПартиюПереданную(РасчетнаяПартия, Расход, Приход) // ПартииТоваровПереданныеНаКомиссию
	ЗаполнитьЗначенияСвойств(РасчетнаяПартия, Расход);
	
	Если Расход.ТипЗаписи = "Возврат" Тогда
		Приход.Количество = Приход.Количество - Расход.Количество;
		Приход.Стоимость = Приход.Стоимость - Расход.Стоимость;
		Приход.СтоимостьБезНДС = Приход.СтоимостьБезНДС - Расход.СтоимостьБезНДС;
		Приход.СтоимостьРегл = Приход.СтоимостьРегл - Расход.СтоимостьРегл;
		Приход.НДСРегл = Приход.НДСРегл - Расход.НДСРегл;
		Приход.ПостояннаяРазница = Приход.ПостояннаяРазница - Расход.ПостояннаяРазница;
		Приход.ВременнаяРазница = Приход.ВременнаяРазница - Расход.ВременнаяРазница;
		
		Расход.Количество = 0;
		Расход.Стоимость = 0;
		Расход.СтоимостьБезНДС = 0;
		Расход.СтоимостьРегл = 0;
		Расход.НДСРегл = 0;
		Расход.ПостояннаяРазница = 0;
		Расход.ВременнаяРазница = 0;
	Иначе	
		Если Расход.Количество = 0 ИЛИ Приход.Количество = 0 Тогда
			Возврат;
		КонецЕсли;
	
		// расчетная партия заполняется на наибольшее общее вычитаемое
		КоличествоСписания = Мин(Расход.Количество, Приход.Количество);
		
		ПотреблениеСтоимость = Окр(КоличествоСписания * Расход.Стоимость / Расход.Количество, 2);
		ПотреблениеСтоимостьБезНДС = Окр(КоличествоСписания * Расход.СтоимостьБезНДС / Расход.Количество, 2);
		ПотреблениеСтоимостьРегл = Окр(КоличествоСписания * Расход.СтоимостьРегл / Расход.Количество, 2);
		ПотреблениеНДСРегл = Окр(КоличествоСписания * Расход.НДСРегл / Расход.Количество, 2);
		ПотреблениеПостояннаяРазница = Окр(КоличествоСписания * Расход.ПостояннаяРазница / Расход.Количество, 2);
		ПотреблениеВременнаяРазница = Окр(КоличествоСписания * Расход.ВременнаяРазница / Расход.Количество, 2);

		ПартияСтоимость = Окр(КоличествоСписания * Приход.Стоимость / Приход.Количество, 2);
		ПартияСтоимостьБезНДС = Окр(КоличествоСписания * Приход.СтоимостьБезНДС / Приход.Количество, 2);
		ПартияСтоимостьРегл = Окр(КоличествоСписания * Приход.СтоимостьРегл / Приход.Количество, 2);
		ПартияНДСРегл = Окр(КоличествоСписания * Приход.НДСРегл / Приход.Количество, 2);
		ПартияПостояннаяРазница = Окр(КоличествоСписания * Приход.ПостояннаяРазница / Приход.Количество, 2);
		ПартияВременнаяРазница = Окр(КоличествоСписания * Приход.ВременнаяРазница / Приход.Количество, 2);

		// заполняем показатели расчетной партии
		РасчетнаяПартия.Количество = КоличествоСписания;
		РасчетнаяПартия.Стоимость = ПартияСтоимость;
		РасчетнаяПартия.СтоимостьБезНДС = ПартияСтоимостьБезНДС;
		РасчетнаяПартия.СтоимостьРегл = ПартияСтоимостьРегл;
		РасчетнаяПартия.НДСРегл = ПартияНДСРегл;
		РасчетнаяПартия.ПостояннаяРазница = ПартияПостояннаяРазница;
		РасчетнаяПартия.ВременнаяРазница = ПартияВременнаяРазница;
		
		// корректируем базу расчета в расходе
		Если Расход <> РасчетнаяПартия Тогда
			Расход.Количество = Расход.Количество - КоличествоСписания;
			Расход.Стоимость = Расход.Стоимость - ПотреблениеСтоимость;
			Расход.СтоимостьБезНДС = Расход.СтоимостьБезНДС - ПотреблениеСтоимостьБезНДС;
			Расход.СтоимостьРегл = Расход.СтоимостьРегл - ПотреблениеСтоимостьРегл;
			Расход.НДСРегл = Расход.НДСРегл - ПотреблениеНДСРегл;
			Расход.ПостояннаяРазница = Расход.ПостояннаяРазница - ПотреблениеПостояннаяРазница;
			Расход.ВременнаяРазница = Расход.ВременнаяРазница - ПотреблениеВременнаяРазница;
		КонецЕсли;
		
		// корректируем базу расчета в партии
		Приход.Количество = Приход.Количество - КоличествоСписания;
		Приход.Стоимость = Приход.Стоимость - ПартияСтоимость;
		Приход.СтоимостьБезНДС = Приход.СтоимостьБезНДС - ПартияСтоимостьБезНДС;
		Приход.СтоимостьРегл = Приход.СтоимостьРегл - ПартияСтоимостьРегл;
		Приход.НДСРегл = Приход.НДСРегл - ПартияНДСРегл;
		Приход.ПостояннаяРазница = Приход.ПостояннаяРазница - ПартияПостояннаяРазница;
		Приход.ВременнаяРазница = Приход.ВременнаяРазница - ПартияВременнаяРазница;
		
		// Заполняем партионную идентификацию в расчетной партии
		РасчетнаяПартия.ДокументПередачиНаКомиссию = Приход.ДокументПередачиНаКомиссию;
		РасчетнаяПартия.АналитикаУчетаПартий = Приход.АналитикаУчетаПартий;
		РасчетнаяПартия.ДокументПоступления = Приход.ДокументПоступления;
	КонецЕсли;
	
	// По результатам партионной идентификации определяем завершенность расчета
	РасчетнаяПартия.РасчетЗавершен = Приход.РасчетЗавершен И
		ЗначениеЗаполнено(РасчетнаяПартия.АналитикаУчетаПартий) И ЗначениеЗаполнено(РасчетнаяПартия.ДокументПоступления);
	
КонецПроцедуры

Процедура ЗаполнитьПартиюЗатрат(РасчетнаяПартия, Расход, Приход) // ПартииЗатратНаВыпуск
	ЗаполнитьЗначенияСвойств(РасчетнаяПартия, Расход);
	
	//++ НЕ УТ
	Если Расход.ТипЗаписи = "ЗатратыПрочие" И Приход.ТипЗаписи = "Потребление" Тогда
		Если ТипЗнч(Приход.ДокументПоступления) = Тип("ДокументСсылка.ВыпускПродукции")
		 И Не ЗначениеЗаполнено(Приход.АналитикаУчетаНоменклатуры) Тогда
			РасчетнаяПартия.Стоимость = 0;
			РасчетнаяПартия.СтоимостьБезНДС = 0;
			РасчетнаяПартия.СтоимостьРегл = 0;
			РасчетнаяПартия.НДСРегл = 0;
			РасчетнаяПартия.ПостояннаяРазница = 0;
			РасчетнаяПартия.ВременнаяРазница = 0;
			РасчетнаяПартия.РасчетЗавершен = Ложь;
		Иначе
			РасчетнаяПартия.Стоимость = Приход.Стоимость;
			РасчетнаяПартия.СтоимостьБезНДС = Приход.СтоимостьБезНДС;
			РасчетнаяПартия.СтоимостьРегл = Приход.СтоимостьРегл;
			РасчетнаяПартия.НДСРегл = Приход.НДСРегл;
			РасчетнаяПартия.ПостояннаяРазница = Приход.ПостояннаяРазница;
			РасчетнаяПартия.ВременнаяРазница = Приход.ВременнаяРазница;
			РасчетнаяПартия.РасчетЗавершен = Истина;
		КонецЕсли;
		Возврат;
	КонецЕсли;
	
	Если Расход.ТипЗаписи = "Продукция" И Приход.ТипЗаписи = "Перемещение"
	 И ТипЗнч(Расход.Регистратор) = Тип("ДокументСсылка.ПоступлениеОтПереработчика")
	 И (ЗначениеЗаполнено(Приход.Продукция) И Расход.Продукция <> Приход.Продукция
	 	ИЛИ НЕ ЗначениеЗаполнено(Приход.Продукция))
	 И (ЗначениеЗаполнено(Приход.ХарактеристикаПродукции) И Расход.ХарактеристикаПродукции <> Приход.ХарактеристикаПродукции
	 	ИЛИ НЕ ЗначениеЗаполнено(Приход.ХарактеристикаПродукции)) Тогда
		Возврат;
	КонецЕсли;
	//-- НЕ УТ
	
	// расчетная партия заполняется на наибольшее общее вычитаемое
	Если Расход.ТипЗаписи = "Выпуск" ИЛИ Расход.ТипЗаписи = "Сборка" ИЛИ Расход.ТипЗаписи = "ВыпускПрочие" Тогда
		ЗнаменательСписания = Мин(Расход.Количество, Приход.Знаменатель);
		РасчетнаяПартия.Знаменатель = Расход.Знаменатель;
	Иначе
		ЗнаменательСписания = Мин(Расход.Знаменатель, Приход.Знаменатель);
		Если Расход.ТипЗаписи = "Перемещение"
		 И Расход.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ПеремещениеТоваров Тогда
			РасчетнаяПартия.Знаменатель = 0;
		ИначеЕсли Расход.ТипЗаписи <> "Перемещение" И Расход.ТипЗаписи <> "Замещение" Тогда
			РасчетнаяПартия.Знаменатель = ЗнаменательСписания;
		КонецЕсли;
	КонецЕсли;
	
	// заполняем показатели расчетной партии
	РасчетнаяПартия.Количество = Окр(ЗнаменательСписания * Приход.Количество / Приход.Знаменатель, 3);
	Если ЗначениеЗаполнено(Приход.АналитикаУчетаНоменклатуры) И РасчетнаяПартия.Количество = 0 Тогда
		РасчетнаяПартия.Стоимость = 0;
		РасчетнаяПартия.СтоимостьБезНДС = 0;
		ПриходСтоимостьРегл = 0;
		ПриходНДСРегл = 0;
		ПриходПостояннаяРазница = 0;
		ПриходВременнаяРазница = 0;
	ИначеЕсли ЗначениеЗаполнено(Приход.АналитикаУчетаНоменклатуры) И РасчетнаяПартия.Количество = Приход.Количество Тогда
		РасчетнаяПартия.Стоимость = Приход.Стоимость;
		РасчетнаяПартия.СтоимостьБезНДС = Приход.СтоимостьБезНДС;
		
		ПриходСтоимостьРегл = Приход.СтоимостьРегл;
		ПриходНДСРегл = Приход.НДСРегл;
		ПриходПостояннаяРазница = Приход.ПостояннаяРазница;
		ПриходВременнаяРазница = Приход.ВременнаяРазница;
	Иначе
		РасчетнаяПартия.Стоимость = Окр(ЗнаменательСписания * Приход.Стоимость / Приход.Знаменатель, 2);
		РасчетнаяПартия.СтоимостьБезНДС = Окр(ЗнаменательСписания * Приход.СтоимостьБезНДС / Приход.Знаменатель, 2);
		
		ПриходСтоимостьРегл = Окр(ЗнаменательСписания * Приход.СтоимостьРегл / Приход.Знаменатель, 2);
		ПриходНДСРегл = Окр(ЗнаменательСписания * Приход.НДСРегл / Приход.Знаменатель, 2);
		ПриходПостояннаяРазница = Окр(ЗнаменательСписания * Приход.ПостояннаяРазница / Приход.Знаменатель, 2);
		ПриходВременнаяРазница = Окр(ЗнаменательСписания * Приход.ВременнаяРазница / Приход.Знаменатель, 2);
	КонецЕсли;
	
	Если РасчетнаяПартия.СохранятьРегл Тогда
		РасчетнаяПартия.СтоимостьРегл = 0;
		РасчетнаяПартия.НДСРегл = 0;
		РасчетнаяПартия.ПостояннаяРазница = 0;
		РасчетнаяПартия.ВременнаяРазница = 0;
	Иначе
		Если РасчетнаяПартия.ВидДвижения = ВидДвиженияНакопления.Приход
		 И Приход.НалогообложениеНДС = Перечисления.ТипыНалогообложенияНДС.ОпределяетсяРаспределением Тогда
			РасчетнаяПартия.НДСРегл = 0;
	 	Иначе
			РасчетнаяПартия.НДСРегл = ПриходНДСРегл;
		КонецЕсли;
		РасчетнаяПартия.СтоимостьРегл = ПриходСтоимостьРегл;
		РасчетнаяПартия.ПостояннаяРазница = ПриходПостояннаяРазница;
		РасчетнаяПартия.ВременнаяРазница = ПриходВременнаяРазница;
	КонецЕсли;
	
	// корректируем базу расчета в приходе
	Приход.Знаменатель = Приход.Знаменатель - ЗнаменательСписания;
	Приход.Количество = Приход.Количество - РасчетнаяПартия.Количество;
	Приход.Стоимость = Приход.Стоимость - РасчетнаяПартия.Стоимость;
	Приход.СтоимостьБезНДС = Приход.СтоимостьБезНДС - РасчетнаяПартия.СтоимостьБезНДС;
	Приход.СтоимостьРегл = Приход.СтоимостьРегл - ПриходСтоимостьРегл;
	Приход.НДСРегл = Приход.НДСРегл - ПриходНДСРегл;
	Приход.ПостояннаяРазница = Приход.ПостояннаяРазница - ПриходПостояннаяРазница;
	Приход.ВременнаяРазница = Приход.ВременнаяРазница - ПриходВременнаяРазница;
	
	Если Не ЗначениеЗаполнено(Приход.АналитикаУчетаНоменклатуры) Тогда
		Приход.Количество = 0;
		РасчетнаяПартия.Количество = 0;
	КонецЕсли;
	
	Если Приход.Количество = 0
	 И Приход.Стоимость = 0
	 И Приход.СтоимостьБезНДС = 0
	 И Приход.СтоимостьРегл = 0
	 И Приход.НДСРегл = 0
	 И Приход.ПостояннаяРазница = 0
	 И Приход.ВременнаяРазница = 0 Тогда
		Приход.Знаменатель = 0;
	КонецЕсли;
	
	// Заполняем партионную идентификацию в расчетной партии
	Если РасчетнаяПартия.ВидДвижения = ВидДвиженияНакопления.Приход ИЛИ РасчетнаяПартия.ТипЗаписи = "Сторно" Тогда
		РасчетнаяПартия.АналитикаУчетаПартий =
			АналитикаУчетаПартий(Приход.АналитикаУчетаПартий, Приход.НалогообложениеПартии, Приход.НалогообложениеНДС);
		Если ЗначениеЗаполнено(Приход.НалогообложениеНДС) Тогда
			РасчетнаяПартия.НалогообложениеПартии = Приход.НалогообложениеНДС;
		Иначе
			РасчетнаяПартия.НалогообложениеПартии = Приход.НалогообложениеПартии;
		КонецЕсли;
	Иначе
		РасчетнаяПартия.АналитикаУчетаПартий = Приход.АналитикаУчетаПартий;
		РасчетнаяПартия.НалогообложениеПартии = Приход.НалогообложениеПартии;
	КонецЕсли;
	РасчетнаяПартия.АналитикаУчетаНоменклатуры = Приход.АналитикаУчетаНоменклатуры;
	РасчетнаяПартия.ВидЗапасов = Приход.ВидЗапасов;
	РасчетнаяПартия.ДокументПоступления = Приход.ДокументПоступления;
	Если Приход.ТипЗаписи = "Затраты" Тогда
		РасчетнаяПартия.АналитикаУчетаПродукции = Приход.АналитикаУчетаПродукции;
	ИначеЕсли Приход.ТипЗаписи = "Распределение" Тогда
		РасчетнаяПартия.СтатьяРасходовСписания = Приход.СтатьяРасходовСписания;
		РасчетнаяПартия.АналитикаРасходов = Приход.АналитикаРасходов;
	КонецЕсли;
	Если НЕ ЗначениеЗаполнено(РасчетнаяПартия.ПодразделениеРасходов) Тогда 
		РасчетнаяПартия.ПодразделениеРасходов = Приход.ПодразделениеРасходов;
	КонецЕсли;
	Если Расход.ТипЗаписи = "Продукция" Тогда
		РасчетнаяПартия.ДокументИсточник = Неопределено;
	КонецЕсли;
	Если РасчетнаяПартия.Количество = 0
	 И РасчетнаяПартия.Стоимость = 0
	 И РасчетнаяПартия.СтоимостьБезНДС = 0
	 И РасчетнаяПартия.СтоимостьРегл = 0
	 И РасчетнаяПартия.НДСРегл = 0
	 И РасчетнаяПартия.ПостояннаяРазница = 0
	 И РасчетнаяПартия.ВременнаяРазница = 0 Тогда
		РасчетнаяПартия.Знаменатель = 0;
		РасчетнаяПартия.РасчетЗавершен = Ложь;
	Иначе
		РасчетнаяПартия.РасчетЗавершен = Приход.РасчетЗавершен;
	КонецЕсли;
	
	ЗаполнитьСтатьюИАналитикуСписанияНДС(РасчетнаяПартия, Расход, Приход);
	
КонецПроцедуры

Процедура ЗаполнитьЗаказВПриходе(РасчетнаяПартия, Расход, Приход) // ЗаказыПоставщикам
	ЗаполнитьЗначенияСвойств(РасчетнаяПартия, Расход);
	РасчетнаяПартия.РасчетЗавершен = Истина;
	Если Неопределено = Приход Тогда
		Возврат;
	КонецЕсли;
	
	// расчетная партия заполняется на наибольшее общее вычитаемое
	КоличествоСписания = ?(Расход.Количество >= Приход.Количество, Приход.Количество, Расход.Количество);
	// заполняем показатели расчетной партии
	РасчетнаяПартия.Стоимость = Окр(КоличествоСписания * Расход.Стоимость / Расход.Количество, 2);
	РасчетнаяПартия.СтоимостьБезНДС = Окр(КоличествоСписания * Расход.СтоимостьБезНДС / Расход.Количество, 2);
	РасчетнаяПартия.СтоимостьРегл = Окр(КоличествоСписания * Расход.СтоимостьРегл / Расход.Количество, 2);
	РасчетнаяПартия.НДСРегл = Окр(КоличествоСписания * Расход.НДСРегл / Расход.Количество, 2);
	РасчетнаяПартия.ПостояннаяРазница = Окр(КоличествоСписания * Расход.ПостояннаяРазница / Расход.Количество, 2);
	РасчетнаяПартия.ВременнаяРазница = Окр(КоличествоСписания * Расход.ВременнаяРазница / Расход.Количество, 2);
	РасчетнаяПартия.Количество = КоличествоСписания;
	// корректируем базу расчета в расходе
	Если Расход <> РасчетнаяПартия Тогда
		Расход.Стоимость = Расход.Стоимость - РасчетнаяПартия.Стоимость;
		Расход.СтоимостьБезНДС = Расход.СтоимостьБезНДС - РасчетнаяПартия.СтоимостьБезНДС;
		Расход.СтоимостьРегл = Расход.СтоимостьРегл - РасчетнаяПартия.СтоимостьРегл;
		Расход.НДСРегл = Расход.НДСРегл - РасчетнаяПартия.НДСРегл;
		Расход.ПостояннаяРазница = Расход.ПостояннаяРазница - РасчетнаяПартия.ПостояннаяРазница;
		Расход.ВременнаяРазница = Расход.ВременнаяРазница - РасчетнаяПартия.ВременнаяРазница;
		Расход.Количество = Расход.Количество - КоличествоСписания;
	КонецЕсли;
	// корректируем базу расчета в приходе
	Приход.Стоимость = Приход.Стоимость - Окр(КоличествоСписания * Приход.Стоимость / Приход.Количество, 2);
	Приход.СтоимостьБезНДС = Приход.СтоимостьБезНДС - Окр(КоличествоСписания * Приход.СтоимостьБезНДС / Приход.Количество, 2);
	Приход.СтоимостьРегл = Приход.СтоимостьРегл - Окр(КоличествоСписания * Приход.СтоимостьРегл / Приход.Количество, 2);
	Приход.НДСРегл = Приход.НДСРегл - Окр(КоличествоСписания * Приход.НДСРегл / Приход.Количество, 2);
	Приход.ПостояннаяРазница = Приход.ПостояннаяРазница - Окр(КоличествоСписания * Приход.ПостояннаяРазница / Приход.Количество, 2);
	Приход.ВременнаяРазница = Приход.ВременнаяРазница - Окр(КоличествоСписания * Приход.ВременнаяРазница / Приход.Количество, 2);
	Приход.Количество = Приход.Количество - КоличествоСписания;
	
	// Заполняем партионную идентификацию в расчетной партии
	РасчетнаяПартия.Заказ = Приход.Заказ;
КонецПроцедуры

Функция АналитикиОбсчетаПартийПрочих(Движение, ПустыеСсылки)
	Результат = Новый Массив;
	Результат.Добавить(Движение.Номенклатура);
	Если Движение.Номенклатура <> Неопределено Тогда
		Результат.Добавить(ПустаяСсылка(Движение.Номенклатура, ПустыеСсылки));
	КонецЕсли;
	Результат.Добавить(Движение.Склад);
	Если Движение.Склад <> Неопределено Тогда
		Результат.Добавить(ПустаяСсылка(Движение.Склад, ПустыеСсылки));
	КонецЕсли;
	Результат.Добавить(Движение.Регистратор);
	Результат.Добавить(ПустаяСсылка(Движение.Регистратор, ПустыеСсылки));
	Возврат Результат;
КонецФункции

Процедура ЗаполнитьПартиюПрочих(РасчетнаяПартия, Расход, Приход) // ПартииПрочихРасходов
	ЗаполнитьЗначенияСвойств(РасчетнаяПартия, Расход);
	Если Неопределено = Приход Тогда
		Возврат;
	КонецЕсли;
	
	РасчетнаяПартия.ТипЗаписи = "Потребление";
	РасчетнаяПартия.ВидДвижения = ВидДвиженияНакопления.Расход;
	РасчетнаяПартия.Период = Макс(Расход.Период, Расход.РасчетныйПериод);
	
	Если Расход.Базис = 0 Тогда
		Возврат;
	КонецЕсли;
	// расчетная партия заполняется на наибольшее общее вычитаемое
	БазисСписания = ?(Расход.Базис >= Приход.Значение.Базис, Приход.Значение.Базис, Расход.Базис);
	// заполняем показатели расчетной партии
	РасчетнаяПартия.Стоимость = Окр(БазисСписания * Расход.Стоимость / Расход.Базис, 2);
	РасчетнаяПартия.СтоимостьБезНДС = Окр(БазисСписания * Расход.СтоимостьБезНДС / Расход.Базис, 2);
	РасчетнаяПартия.СтоимостьРегл = Окр(БазисСписания * Расход.СтоимостьРегл / Расход.Базис, 2);
	РасчетнаяПартия.НДСРегл = Окр(БазисСписания * Расход.НДСРегл / Расход.Базис, 2);
	РасчетнаяПартия.ПостояннаяРазница = Окр(БазисСписания * Расход.ПостояннаяРазница / Расход.Базис, 2);
	РасчетнаяПартия.ВременнаяРазница = Окр(БазисСписания * Расход.ВременнаяРазница / Расход.Базис, 2);
	РасчетнаяПартия.Базис = БазисСписания;
	// корректируем базу расчета в расходе
	Расход.Стоимость = Расход.Стоимость - РасчетнаяПартия.Стоимость;
	Расход.СтоимостьБезНДС = Расход.СтоимостьБезНДС - РасчетнаяПартия.СтоимостьБезНДС;
	Расход.СтоимостьРегл = Расход.СтоимостьРегл - РасчетнаяПартия.СтоимостьРегл;
	Расход.НДСРегл = Расход.НДСРегл - РасчетнаяПартия.НДСРегл;
	Расход.ПостояннаяРазница = Расход.ПостояннаяРазница - РасчетнаяПартия.ПостояннаяРазница;
	Расход.ВременнаяРазница = Расход.ВременнаяРазница - РасчетнаяПартия.ВременнаяРазница;
	Расход.Базис = Расход.Базис - БазисСписания;
	// корректируем базу расчета в приходе
	Приход.Значение.Базис = Приход.Значение.Базис - БазисСписания;
	
	// Заполняем партионную идентификацию в расчетной партии
	Если ТипЗнч(Приход.Ключ) = Тип("ПеречислениеСсылка.ТипыНалогообложенияНДС") Тогда
		РасчетнаяПартия.НалогообложениеНДС = Приход.Ключ;
	Иначе
		РасчетнаяПартия.СтатьяОтраженияРасходов = Приход.Ключ;
	КонецЕсли;
	РасчетнаяПартия.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.РаспределениеРасходовНаСебестоимость;
КонецПроцедуры

Процедура ЗаполнитьПриходПартииРасходов(РасчетнаяПартия, Расход, Приход) // ПартииРасходовНаСебестоимостьТоваровПриход
	ЗаполнитьЗначенияСвойств(РасчетнаяПартия, Расход);
	Если Неопределено = Приход Тогда
		Возврат;
	КонецЕсли;
	
	// расчетная партия заполняется на наибольшее общее вычитаемое
	Если Приход.ПравилоРаспределения = Перечисления.ТипыБазыРаспределенияРасходов.КоличествоТоваров Тогда
		Расход.Базис = Расход.Количество;
	ИначеЕсли Приход.ПравилоРаспределения = Перечисления.ТипыБазыРаспределенияРасходов.ВесТоваров Тогда
		Расход.Базис = Расход.Вес;
	ИначеЕсли Приход.ПравилоРаспределения = Перечисления.ТипыБазыРаспределенияРасходов.ОбъемТоваров Тогда
		Расход.Базис = Расход.Объем;
	Иначе
		Расход.Базис = Расход.Стоимость;
	КонецЕсли;
	БазисСписания = ?(Расход.Базис >= Приход.Базис, Приход.Базис, Расход.Базис);
	// заполняем показатели расчетной партии
	РасчетнаяПартия.Количество = Окр(БазисСписания * Расход.Количество / Расход.Базис, 3);
	РасчетнаяПартия.Вес = Окр(БазисСписания * Расход.Вес / Расход.Базис, 7);
	РасчетнаяПартия.Объем = Окр(БазисСписания * Расход.Объем / Расход.Базис, 7);
	РасчетнаяПартия.Стоимость = Окр(БазисСписания * Приход.Стоимость / Приход.Базис, 2);
	РасчетнаяПартия.СтоимостьБезНДС = Окр(БазисСписания * Приход.СтоимостьБезНДС / Приход.Базис, 2);
	РасчетнаяПартия.СтоимостьРегл = Окр(БазисСписания * Приход.СтоимостьРегл / Приход.Базис, 2);
	РасчетнаяПартия.НДСРегл = Окр(БазисСписания * Приход.НДСРегл / Приход.Базис, 2);
	РасчетнаяПартия.ПостояннаяРазница = Окр(БазисСписания * Приход.ПостояннаяРазница / Приход.Базис, 2);
	РасчетнаяПартия.ВременнаяРазница = Окр(БазисСписания * Приход.ВременнаяРазница / Приход.Базис, 2);
	РасчетнаяПартия.Базис = БазисСписания;
	// корректируем базу расчета в приходе
	Приход.Стоимость = Приход.Стоимость - РасчетнаяПартия.Стоимость;
	Приход.СтоимостьБезНДС = Приход.СтоимостьБезНДС - РасчетнаяПартия.СтоимостьБезНДС;
	Приход.СтоимостьРегл = Приход.СтоимостьРегл - РасчетнаяПартия.СтоимостьРегл;
	Приход.НДСРегл = Приход.НДСРегл - РасчетнаяПартия.НДСРегл;
	Приход.ПостояннаяРазница = Приход.ПостояннаяРазница - РасчетнаяПартия.ПостояннаяРазница;
	Приход.ВременнаяРазница = Приход.ВременнаяРазница - РасчетнаяПартия.ВременнаяРазница;
	Приход.Базис = Приход.Базис - БазисСписания;
	// корректируем базу расчета в расходе
	Расход.Количество = Расход.Количество - РасчетнаяПартия.Количество;
	Расход.Вес = Расход.Вес - РасчетнаяПартия.Вес;
	Расход.Объем = Расход.Объем - РасчетнаяПартия.Объем;
	Расход.Стоимость = Расход.Стоимость - Окр(БазисСписания * Расход.Стоимость / Расход.Базис, 2);
	Расход.СтоимостьБезНДС = Расход.СтоимостьБезНДС - Окр(БазисСписания * Расход.СтоимостьБезНДС / Расход.Базис, 2);
	Расход.СтоимостьРегл = Расход.СтоимостьРегл - Окр(БазисСписания * Расход.СтоимостьРегл / Расход.Базис, 2);
	Расход.НДСРегл = Расход.НДСРегл - Окр(БазисСписания * Расход.НДСРегл / Расход.Базис, 2);
	Расход.ПостояннаяРазница = Расход.ПостояннаяРазница - Окр(БазисСписания * Расход.ПостояннаяРазница / Расход.Базис, 2);
	Расход.ВременнаяРазница = Расход.ВременнаяРазница - Окр(БазисСписания * Расход.ВременнаяРазница / Расход.Базис, 2);
	Расход.Базис = Расход.Базис - БазисСписания;
	
	// Заполняем партионную идентификацию в расчетной партии
	ЗаполнитьЗначенияСвойств(РасчетнаяПартия, Приход,
		"ВидДвижения, Период, Регистратор, ДокументПоступленияРасходов, СтатьяРасходов, ХозяйственнаяОперация,
		|Подразделение, ПравилоРаспределения, НаправлениеДеятельности");
		
	Если ЗначениеЗаполнено(Приход.АналитикаРасходов) Тогда
		РасчетнаяПартия.АналитикаРасходов = Приход.АналитикаРасходов;
	КонецЕсли;
	Если РасчетнаяПартия.ВидДвижения = ВидДвиженияНакопления.Приход Тогда
		РасчетнаяПартия.АналитикаУчетаПартий =
			АналитикаУчетаПартий(Приход.АналитикаУчетаПартий, Приход.НалогообложениеПартии, Приход.НалогообложениеНДС);
		РасчетнаяПартия.НалогообложениеПартии = Приход.НалогообложениеНДС;
	Иначе
		РасчетнаяПартия.АналитикаУчетаПартий = Приход.АналитикаУчетаПартий;
		РасчетнаяПартия.НалогообложениеПартии = Приход.НалогообложениеПартии;
	КонецЕсли;
	Если ЗначениеЗаполнено(РасчетнаяПартия.ВариантРаздельногоУчетаНДС) Тогда
		РасчетнаяПартия.ТипЗаписи = "Услуги";
		РасчетнаяПартия.НалогообложениеНДС = Приход.НалогообложениеПартии;
	Иначе
		РасчетнаяПартия.ТипЗаписи = "Партия";
		РасчетнаяПартия.НалогообложениеНДС = Перечисления.ТипыНалогообложенияНДС.ПустаяСсылка();
	КонецЕсли;
	РасчетнаяПартия.РасчетЗавершен = Истина;
КонецПроцедуры

Процедура ЗаполнитьПартиюРасходов(РасчетнаяПартия, Расход, Приход) // ПартииРасходовНаСебестоимостьТоваров
	ЗаполнитьЗначенияСвойств(РасчетнаяПартия, Расход);
	
	//++ НЕ УТ
	Если Расход.ТипЗаписи = "Продукция" И Приход.ТипЗаписи = "Перемещение"
	 И ТипЗнч(Расход.Регистратор) = Тип("ДокументСсылка.ПоступлениеОтПереработчика")
	 И (ЗначениеЗаполнено(Приход.Продукция) И Расход.Продукция <> Приход.Продукция
	 	ИЛИ НЕ ЗначениеЗаполнено(Приход.Продукция))
	 И (ЗначениеЗаполнено(Приход.ХарактеристикаПродукции) И Расход.ХарактеристикаПродукции <> Приход.ХарактеристикаПродукции
	 	ИЛИ НЕ ЗначениеЗаполнено(Приход.ХарактеристикаПродукции)) Тогда
		Возврат;
	КонецЕсли;
	//-- НЕ УТ
	
	// расчетная партия заполняется на наибольшее общее вычитаемое
	ВключаяКоличество = (Расход.ТипЗаписи <> "Перемещение" И Расход.ТипЗаписи <> "Замещение" И Расход.ТипЗаписи <> "Выпуск" И Расход.ТипЗаписи <> "Затраты");
	СписыватьЗнаменатель = (Приход.Знаменатель = Приход.Количество) И (Приход.Знаменатель <> 0);
	ПриходКоличество = Приход.Количество;
	Если Приход.ТипЗаписи = "Сторно" Тогда
		КоличествоСписания = Мин(Расход.Количество, Приход.Количество);
	ИначеЕсли Приход.ТипЗаписи = "ВыпускПрочие" Тогда
		КоличествоСписания = Мин(Расход.Количество, Приход.Знаменатель);
		ПриходКоличество = Приход.Знаменатель;
		СписыватьЗнаменатель = Истина;
	ИначеЕсли ВключаяКоличество Тогда
		КоличествоСписания = Мин(Расход.Количество, Приход.Количество);
	Иначе
		КоличествоСписания = Приход.Количество;
	КонецЕсли;
	
	Если ПриходКоличество <> 0 Тогда
		ПриходСтоимостьРегл = Окр(КоличествоСписания * Приход.СтоимостьРегл / ПриходКоличество, 2);
		ПриходНДСРегл = Окр(КоличествоСписания * Приход.НДСРегл / ПриходКоличество, 2);
		ПриходПостояннаяРазница = Окр(КоличествоСписания * Приход.ПостояннаяРазница / ПриходКоличество, 2);
		ПриходВременнаяРазница = Окр(КоличествоСписания * Приход.ВременнаяРазница / ПриходКоличество, 2);
	
		// заполняем показатели расчетной партии
		РасчетнаяПартия.Стоимость = Окр(КоличествоСписания * Приход.Стоимость / ПриходКоличество, 2);
		РасчетнаяПартия.СтоимостьБезНДС = Окр(КоличествоСписания * Приход.СтоимостьБезНДС / ПриходКоличество, 2);
	Иначе
		ПриходСтоимостьРегл = 0;
		ПриходНДСРегл = 0;
		ПриходПостояннаяРазница = 0;
		ПриходВременнаяРазница = 0;
		РасчетнаяПартия.Стоимость = 0;
		РасчетнаяПартия.СтоимостьБезНДС = 0;
	КонецЕсли;
	Если РасчетнаяПартия.СохранятьРегл Тогда
		РасчетнаяПартия.СтоимостьРегл = 0;
		РасчетнаяПартия.НДСРегл = 0;
		РасчетнаяПартия.ПостояннаяРазница = 0;
		РасчетнаяПартия.ВременнаяРазница = 0;
	Иначе
		Если РасчетнаяПартия.ВидДвижения = ВидДвиженияНакопления.Приход
		  И Приход.НалогообложениеНДС = Перечисления.ТипыНалогообложенияНДС.ОпределяетсяРаспределением Тогда
			РасчетнаяПартия.СтоимостьРегл = ПриходСтоимостьРегл;
			РасчетнаяПартия.НДСРегл = 0;
		ИначеЕсли РасчетнаяПартия.ТипЗаписи = "Замещение"
	     И ТипЗнч(РасчетнаяПартия.Регистратор) = Тип("ДокументСсылка.ПересортицаТоваров") Тогда
			Если Приход.НалогообложениеНДС = Перечисления.ТипыНалогообложенияНДС.ПродажаНеОблагаетсяНДС
			 ИЛИ Приход.НалогообложениеНДС = Перечисления.ТипыНалогообложенияНДС.ПродажаОблагаетсяЕНВД Тогда
				РасчетнаяПартия.СтоимостьРегл = ПриходСтоимостьРегл + ПриходНДСРегл;
			Иначе
				РасчетнаяПартия.СтоимостьРегл = ПриходСтоимостьРегл;
			КонецЕсли;
			РасчетнаяПартия.НДСРегл = 0;
	 	Иначе
		 	РасчетнаяПартия.СтоимостьРегл = ПриходСтоимостьРегл;
			РасчетнаяПартия.НДСРегл = ПриходНДСРегл;
		КонецЕсли;
		РасчетнаяПартия.ПостояннаяРазница = ПриходПостояннаяРазница;
		РасчетнаяПартия.ВременнаяРазница = ПриходВременнаяРазница;
	КонецЕсли;
	Если ВключаяКоличество Тогда
		РасчетнаяПартия.Количество = КоличествоСписания;
		Если Расход.Количество <> 0 И РасчетнаяПартия.ТипЗаписи <> "ВыпускПрочие" Тогда
			РасчетнаяПартия.Знаменатель = РасчетнаяПартия.Знаменатель * РасчетнаяПартия.Количество / Расход.Количество;
		КонецЕсли;
	КонецЕсли;
	
	// корректируем базу расчета в приходе
	Приход.Стоимость = Приход.Стоимость - РасчетнаяПартия.Стоимость;
	Приход.СтоимостьБезНДС = Приход.СтоимостьБезНДС - РасчетнаяПартия.СтоимостьБезНДС;
	Приход.СтоимостьРегл = Приход.СтоимостьРегл - ПриходСтоимостьРегл;
	Приход.НДСРегл = Приход.НДСРегл - ПриходНДСРегл;
	Приход.ПостояннаяРазница = Приход.ПостояннаяРазница - ПриходПостояннаяРазница;
	Приход.ВременнаяРазница = Приход.ВременнаяРазница - ПриходВременнаяРазница;
	
	Если Приход.ТипЗаписи <> "ВыпускПрочие" Тогда
		Приход.Количество = Приход.Количество - КоличествоСписания;
	КонецЕсли;
	
	Если СписыватьЗнаменатель Тогда
		Приход.Знаменатель = Приход.Знаменатель - КоличествоСписания;
	КонецЕсли;
	
	Если РасчетнаяПартия.ТипЗаписи = "Затраты" Тогда
		Если РасчетнаяПартия.ВариантРаспределенияРасходовУпр <> Перечисления.ВариантыРаспределенияРасходов.НаПроизводственныеЗатраты Тогда
			РасчетнаяПартия.Стоимость = 0;
			РасчетнаяПартия.СтоимостьБезНДС = 0;
		КонецЕсли;
		Если РасчетнаяПартия.ВариантРаспределенияРасходовРегл <> Перечисления.ВариантыРаспределенияРасходов.НаПроизводственныеЗатраты Тогда
			РасчетнаяПартия.СтоимостьРегл = 0;
			РасчетнаяПартия.НДСРегл = 0;
			РасчетнаяПартия.ПостояннаяРазница = 0;
			РасчетнаяПартия.ВременнаяРазница = 0;
		КонецЕсли;
	КонецЕсли;
	
	Если Приход.Стоимость = 0
	 И Приход.СтоимостьБезНДС = 0
	 И Приход.СтоимостьРегл = 0
	 И Приход.НДСРегл = 0
	 И Приход.ПостояннаяРазница = 0
	 И Приход.ВременнаяРазница = 0 Тогда
	 	Приход.Количество = 0;
		Приход.Знаменатель = 0;
	КонецЕсли;
	
	Если РасчетнаяПартия.ВидДвижения = ВидДвиженияНакопления.Приход ИЛИ РасчетнаяПартия.ТипЗаписи = "Сторно" Тогда
		РасчетнаяПартия.АналитикаУчетаПартий =
			АналитикаУчетаПартий(Приход.АналитикаУчетаПартий, Приход.НалогообложениеПартии, Приход.НалогообложениеНДС);
		Если ЗначениеЗаполнено(Приход.НалогообложениеНДС) Тогда
			РасчетнаяПартия.НалогообложениеПартии = Приход.НалогообложениеНДС;
		Иначе
			РасчетнаяПартия.НалогообложениеПартии = Приход.НалогообложениеПартии;
		КонецЕсли;
	Иначе
		РасчетнаяПартия.АналитикаУчетаПартий = Приход.АналитикаУчетаПартий;
		РасчетнаяПартия.НалогообложениеПартии = Приход.НалогообложениеПартии;
	КонецЕсли;

	// Заполняем партионную идентификацию в расчетной партии
	ЗаполнитьЗначенияСвойств(РасчетнаяПартия, Приход,
		"РасчетЗавершен, ДокументПоступленияРасходов, СтатьяРасходов");
//++ НЕ УТ
	Если (Расход.ТипЗаписи = "Распределение" И Приход.ТипЗаписи = "Затраты")
	   ИЛИ (Расход.ТипЗаписи = "Прочее" И Приход.ТипЗаписи = "Затраты")
	   ИЛИ (Расход.ТипЗаписи = "Списание" И Приход.ТипЗаписи = "Прочее") Тогда
		ЗаполнитьЗначенияСвойств(РасчетнаяПартия, Приход, "ДокументПоступления, АналитикаУчетаНоменклатуры, ВидЗапасов");
	КонецЕсли;
	Если Расход.ТипЗаписи = "Продукция" Тогда
		РасчетнаяПартия.ДокументИсточник = Неопределено;
	КонецЕсли;
//-- НЕ УТ
	Если РасчетнаяПартия.Стоимость = 0
	 И РасчетнаяПартия.СтоимостьБезНДС = 0
	 И РасчетнаяПартия.СтоимостьРегл = 0
	 И РасчетнаяПартия.НДСРегл = 0
	 И РасчетнаяПартия.ПостояннаяРазница = 0
	 И РасчетнаяПартия.ВременнаяРазница = 0 Тогда
	 	РасчетнаяПартия.Количество = 0;
		РасчетнаяПартия.Знаменатель = 0;
		РасчетнаяПартия.РасчетЗавершен = Ложь;
	КонецЕсли;		
	
	ЗаполнитьСтатьюИАналитикуСписанияНДС(РасчетнаяПартия, Расход, Приход);
	
КонецПроцедуры

//++ НЕ УТ

Процедура ЗаполнитьРаспределениеМатериаловИРабот(РасчетнаяПартия, Расход, Приход) 
	
	ЗаполнитьЗначенияСвойств(РасчетнаяПартия, Расход);
	Если Неопределено = Приход Тогда
		Возврат;
	КонецЕсли;
	
	// заполняем показатели расчетной партии
	РасчетнаяПартия.ТипЗаписи = "Потребление";
	ЗаполнитьЗначенияСвойств(РасчетнаяПартия, Приход, "Организация, Номенклатура, Характеристика, Подразделение, Серия,
		|АналитикаУчетаНоменклатуры, БазаРаспределения, Назначение, СтатьяКалькуляции");
	
	Если Приход.БазаРаспределения = Перечисления.ТипыБазыРаспределенияРасходов.КоличествоУказанныхМатериалов
	 ИЛИ Приход.БазаРаспределения = Перечисления.ТипыБазыРаспределенияРасходов.КоличествоПродукции
	 ИЛИ Приход.БазаРаспределения = Перечисления.ТипыБазыРаспределенияРасходов.КоличествоРаботУказанныхВидов
	 ИЛИ Приход.БазаРаспределения = Перечисления.ТипыБазыРаспределенияРасходов.НормативРасходаМатериала Тогда
		РасчетнаяПартия.Количество = Окр(Приход.КРаспределению * ?(Приход.Количество = 0, 0, Расход.Количество / Приход.Количество), 3);
		
	ИначеЕсли Приход.БазаРаспределения = Перечисления.ТипыБазыРаспределенияРасходов.ОбъемУказанныхМатериалов
	 ИЛИ Приход.БазаРаспределения = Перечисления.ТипыБазыРаспределенияРасходов.ОбъемПродукции Тогда
		РасчетнаяПартия.Количество = Окр(Приход.КРаспределению * ?(Приход.Объем = 0, 0, Расход.Объем / Приход.Объем), 3);
		
	ИначеЕсли Приход.БазаРаспределения = Перечисления.ТипыБазыРаспределенияРасходов.ВесУказанныхМатериалов
	 ИЛИ Приход.БазаРаспределения = Перечисления.ТипыБазыРаспределенияРасходов.ВесПродукции Тогда
		РасчетнаяПартия.Количество = Окр(Приход.КРаспределению * ?(Приход.Вес = 0, 0, Расход.Вес / Приход.Вес), 3);
		
	ИначеЕсли Приход.БазаРаспределения = Перечисления.ТипыБазыРаспределенияРасходов.ПлановаяСтоимостьПродукции Тогда
		РасчетнаяПартия.Количество = Окр(Приход.КРаспределению * ?(Приход.Стоимость = 0, 0, Расход.Стоимость / Приход.Стоимость), 3);
		
	КонецЕсли;
	РасчетнаяПартия.КРаспределению = Приход.КРаспределению;
	
	// корректируем базу расчета в приходе
	Приход.КРаспределению = Приход.КРаспределению - РасчетнаяПартия.Количество;
	Приход.Количество = Приход.Количество - Расход.Количество;
	Приход.Объем = Приход.Объем - Расход.Объем;
	Приход.Вес = Приход.Вес - Расход.Вес;
	Приход.Стоимость = Приход.Стоимость - Расход.Стоимость;
	
	// корректируем базу расчета в расходе
	Расход.Количество = 0;
	Расход.Объем = 0;
	Расход.Вес = 0;
	Расход.Стоимость = 0;
	
	РасчетнаяПартия.РасчетЗавершен = Истина;
	
КонецПроцедуры
//-- НЕ УТ

Процедура ЗаполнитьПартиюПроизводственныхЗатрат(РасчетнаяПартия, Расход, Приход) // ПартииПроизводственныхЗатрат
	ЗаполнитьЗначенияСвойств(РасчетнаяПартия, Расход);
	
	Если Расход.ТипЗаписи = "Корректировка" Тогда
		Приход.Стоимость = Приход.Стоимость + Расход.Стоимость;
		Приход.СтоимостьБезНДС = Приход.СтоимостьБезНДС + Расход.СтоимостьБезНДС;
		Приход.СтоимостьРегл = Приход.СтоимостьРегл + Расход.СтоимостьРегл;
		Приход.НДСРегл = Приход.НДСРегл + Расход.НДСРегл;
		Приход.ПостояннаяРазница = Приход.ПостояннаяРазница + Расход.ПостояннаяРазница;
		Приход.ВременнаяРазница = Приход.ВременнаяРазница + Расход.ВременнаяРазница;
	ИначеЕсли Расход.ТипЗаписи = "ВозвратСторно" Тогда
		РасчетнаяПартия.Количество = Мин(Приход.Количество, Расход.Количество);
		РасчетнаяПартия.Стоимость = Мин(Приход.Стоимость, Расход.Стоимость);
		РасчетнаяПартия.СтоимостьБезНДС = Мин(Приход.СтоимостьБезНДС, Расход.СтоимостьБезНДС);
		РасчетнаяПартия.СтоимостьРегл = Мин(Приход.СтоимостьРегл, Расход.СтоимостьРегл);
		РасчетнаяПартия.НДСРегл = Мин(Приход.НДСРегл, Расход.НДСРегл);
		РасчетнаяПартия.ПостояннаяРазница = Мин(Приход.ПостояннаяРазница, Расход.ПостояннаяРазница);
		РасчетнаяПартия.ВременнаяРазница = Мин(Приход.ВременнаяРазница, Расход.ВременнаяРазница);
		
		Приход.Количество = Приход.Количество - РасчетнаяПартия.Количество;
		Приход.Стоимость = Приход.Стоимость - РасчетнаяПартия.Стоимость;
		Приход.СтоимостьБезНДС = Приход.СтоимостьБезНДС - РасчетнаяПартия.СтоимостьБезНДС;
		Приход.СтоимостьРегл = Приход.СтоимостьРегл - РасчетнаяПартия.СтоимостьРегл;
		Приход.НДСРегл = Приход.НДСРегл - РасчетнаяПартия.НДСРегл;
		Приход.ПостояннаяРазница = Приход.ПостояннаяРазница - РасчетнаяПартия.ПостояннаяРазница;
		Приход.ВременнаяРазница = Приход.ВременнаяРазница - РасчетнаяПартия.ВременнаяРазница;
		
		Расход.Количество = Расход.Количество - РасчетнаяПартия.Количество;
		Расход.Стоимость = Расход.Стоимость - РасчетнаяПартия.Стоимость;
		Расход.СтоимостьБезНДС = Расход.СтоимостьБезНДС - РасчетнаяПартия.СтоимостьБезНДС;
		Расход.СтоимостьРегл = Расход.СтоимостьРегл - РасчетнаяПартия.СтоимостьРегл;
		Расход.НДСРегл = Расход.НДСРегл - РасчетнаяПартия.НДСРегл;
		Расход.ПостояннаяРазница = Расход.ПостояннаяРазница - РасчетнаяПартия.ПостояннаяРазница;
		Расход.ВременнаяРазница = Расход.ВременнаяРазница - РасчетнаяПартия.ВременнаяРазница;
		
		Если Не ЗначениеЗаполнено(РасчетнаяПартия.ДокументИсточник) Тогда
			РасчетнаяПартия.ДокументИсточник = Приход.Регистратор;
		КонецЕсли;
	Иначе
		Если Приход.Количество = 0 Тогда
			Возврат;
		КонецЕсли;
		
		// расчетная партия заполняется на наибольшее общее вычитаемое
		КоличествоСписания = Мин(Расход.Количество, Приход.Количество);
		
		РасходБазис = ?(Расход.Количество <> 0, КоличествоСписания / Расход.Количество, 0);
		ПриходБазис = ?(Приход.Количество <> 0, КоличествоСписания / Приход.Количество, 0);
		
		РасходСтоимостьРегл = Окр(РасходБазис * Расход.СтоимостьРегл, 2);
		РасходНДСРегл = Окр(РасходБазис * Расход.НДСРегл, 2);
		РасходПостояннаяРазница = Окр(РасходБазис * Расход.ПостояннаяРазница, 2);
		РасходВременнаяРазница = Окр(РасходБазис * Расход.ВременнаяРазница, 2);
		
		ПриходСтоимостьРегл = Окр(ПриходБазис * Приход.СтоимостьРегл, 2);
		ПриходНДСРегл = Окр(ПриходБазис * Приход.НДСРегл, 2);
		ПриходПостояннаяРазница = Окр(ПриходБазис * Приход.ПостояннаяРазница, 2);
		ПриходВременнаяРазница = Окр(ПриходБазис * Приход.ВременнаяРазница, 2);
		
		// заполняем показатели расчетной партии
		РасчетнаяПартия.Стоимость = Окр(КоличествоСписания * Приход.Стоимость / Приход.Количество, 2);
		РасчетнаяПартия.СтоимостьБезНДС = Окр(КоличествоСписания * Приход.СтоимостьБезНДС / Приход.Количество, 2);
		Если РасчетнаяПартия.СохранятьРегл Тогда
			РасчетнаяПартия.СтоимостьРегл = РасходСтоимостьРегл;
			РасчетнаяПартия.НДСРегл = РасходНДСРегл;
			РасчетнаяПартия.ПостояннаяРазница = РасходПостояннаяРазница;
			РасчетнаяПартия.ВременнаяРазница = РасходВременнаяРазница;
		Иначе
			Если РасчетнаяПартия.ВидДвижения = ВидДвиженияНакопления.Приход
			 И Приход.НалогообложениеНДС = Перечисления.ТипыНалогообложенияНДС.ОпределяетсяРаспределением Тогда
				РасчетнаяПартия.НДСРегл = 0;
		 	Иначе
				РасчетнаяПартия.НДСРегл = ПриходНДСРегл;
			КонецЕсли;
			РасчетнаяПартия.СтоимостьРегл = ПриходСтоимостьРегл;
			РасчетнаяПартия.ПостояннаяРазница = ПриходПостояннаяРазница;
			РасчетнаяПартия.ВременнаяРазница = ПриходВременнаяРазница;
		КонецЕсли;
		РасчетнаяПартия.Количество = КоличествоСписания;
		
		// корректируем базу расчета в потреблении
		Расход.Стоимость = Расход.Стоимость - Окр(РасходБазис * Расход.Стоимость, 2);
		Расход.СтоимостьБезНДС = Расход.СтоимостьБезНДС - Окр(РасходБазис * Расход.СтоимостьБезНДС, 2);
		Расход.СтоимостьРегл = Расход.СтоимостьРегл - РасходСтоимостьРегл;
		Расход.НДСРегл = Расход.НДСРегл - РасходНДСРегл;
		Расход.ПостояннаяРазница = Расход.ПостояннаяРазница - РасходПостояннаяРазница;
		Расход.ВременнаяРазница = Расход.ВременнаяРазница - РасходВременнаяРазница;
		Расход.Количество = Расход.Количество - РасчетнаяПартия.Количество;
		
		// корректируем базу расчета в приходе
		Если Расход.ТипЗаписи = "Сторно" И (Приход.ТипЗаписи = "Партия" ИЛИ Приход.ТипЗаписи = "Остаток") Тогда
			Приход.Стоимость = Приход.Стоимость + РасчетнаяПартия.Стоимость;
			Приход.СтоимостьБезНДС = Приход.СтоимостьБезНДС + РасчетнаяПартия.СтоимостьБезНДС;
			Приход.СтоимостьРегл = Приход.СтоимостьРегл + ПриходСтоимостьРегл;
			Приход.НДСРегл = Приход.НДСРегл + ПриходНДСРегл;
			Приход.ПостояннаяРазница = Приход.ПостояннаяРазница + ПриходПостояннаяРазница;
			Приход.ВременнаяРазница = Приход.ВременнаяРазница + ПриходВременнаяРазница;
			Приход.Количество = Приход.Количество + КоличествоСписания;
		Иначе
			Приход.Стоимость = Приход.Стоимость - РасчетнаяПартия.Стоимость;
			Приход.СтоимостьБезНДС = Приход.СтоимостьБезНДС - РасчетнаяПартия.СтоимостьБезНДС;
			Приход.СтоимостьРегл = Приход.СтоимостьРегл - ПриходСтоимостьРегл;
			Приход.НДСРегл = Приход.НДСРегл - ПриходНДСРегл;
			Приход.ПостояннаяРазница = Приход.ПостояннаяРазница - ПриходПостояннаяРазница;
			Приход.ВременнаяРазница = Приход.ВременнаяРазница - ПриходВременнаяРазница;
			Приход.Количество = Приход.Количество - КоличествоСписания;
		КонецЕсли;

		// Заполняем партионную идентификацию в расчетной партии
		Если Не ЗначениеЗаполнено(РасчетнаяПартия.ДокументПоступления) Тогда
			РасчетнаяПартия.ДокументПоступления = Приход.ДокументПоступления;
		КонецЕсли;
		Если Расход.ТипЗаписи = "Перемещение" ИЛИ Приход.ТипЗаписи = "Перемещение" Тогда
			РасчетнаяПартия.ДокументИсточник = Приход.ДокументИсточник;
		ИначеЕсли Не ЗначениеЗаполнено(РасчетнаяПартия.ДокументИсточник) Тогда
			РасчетнаяПартия.ДокументИсточник = Приход.Регистратор;
		КонецЕсли;
		Если Не ЗначениеЗаполнено(РасчетнаяПартия.ВидЗапасов) Тогда
			РасчетнаяПартия.ВидЗапасов = Приход.ВидЗапасов;
		КонецЕсли;
		//++ НЕ УТ
		РасчетнаяПартия.ГруппаПродукции = Приход.ГруппаПродукции;
		//-- НЕ УТ
		Если ЗначениеЗаполнено(РасчетнаяПартия.КорАналитикаУчетаНоменклатуры) Тогда
			РасчетнаяПартия.КорВидЗапасов = РасчетнаяПартия.ВидЗапасов;
		КонецЕсли;
		
		Если Не ЗначениеЗаполнено(РасчетнаяПартия.АналитикаУчетаПартий) Тогда
			Если РасчетнаяПартия.ВидДвижения = ВидДвиженияНакопления.Приход Тогда
				РасчетнаяПартия.АналитикаУчетаПартий =
					АналитикаУчетаПартий(Приход.АналитикаУчетаПартий, Приход.НалогообложениеПартии, Приход.НалогообложениеНДС);
				РасчетнаяПартия.НалогообложениеПартии = Приход.НалогообложениеНДС;
			Иначе
				РасчетнаяПартия.АналитикаУчетаПартий = Приход.АналитикаУчетаПартий;
				РасчетнаяПартия.НалогообложениеПартии = Приход.НалогообложениеПартии;
			КонецЕсли;
		КонецЕсли;
		
		Если НЕ ЗначениеЗаполнено(РасчетнаяПартия.ПодразделениеРасходов) Тогда 
			РасчетнаяПартия.ПодразделениеРасходов = Приход.ПодразделениеРасходов;
		КонецЕсли;
		
		ЗаполнитьСтатьюИАналитикуСписанияНДС(РасчетнаяПартия, Расход, Приход);
		
		Если Расход.ТипЗаписи = "Списание" Тогда
			РасчетнаяПартия.ИдентификаторСтроки = Приход.ИдентификаторСтроки;
		КонецЕсли;
		
	КонецЕсли;
	
	ЗаполнитьЗначенияСвойств(РасчетнаяПартия, Приход, "РасчетЗавершен");
КонецПроцедуры

//++ НЕ УТ

Процедура ЗаполнитьПартиюНезавершенногоПроизводства(РасчетнаяПартия, Расход, Приход) // ПартииНезавершенногоПроизводства
	ЗаполнитьЗначенияСвойств(РасчетнаяПартия, Расход);
	
	Если Приход.Знаменатель = 0 Тогда
		Возврат;
	КонецЕсли;
	
	// расчетная партия заполняется на наибольшее общее вычитаемое
	ЗнаменательСписания = Мин(Расход.Знаменатель, Приход.Знаменатель);
	
	// заполняем показатели расчетной партии
	РасчетнаяПартия.Количество = Окр(ЗнаменательСписания * Приход.Количество / Приход.Знаменатель, 3);
	Если РасчетнаяПартия.Количество = Приход.Количество Тогда
		РасчетнаяПартия.Стоимость = Приход.Стоимость;
		РасчетнаяПартия.СтоимостьБезНДС = Приход.СтоимостьБезНДС;
		РасчетнаяПартия.СтоимостьРегл = Приход.СтоимостьРегл;
		РасчетнаяПартия.НДСРегл = Приход.НДСРегл;
		РасчетнаяПартия.ПостояннаяРазница = Приход.ПостояннаяРазница;
		РасчетнаяПартия.ВременнаяРазница = Приход.ВременнаяРазница;
	ИначеЕсли РасчетнаяПартия.Количество <> 0 Тогда
		РасчетнаяПартия.Стоимость = Окр(ЗнаменательСписания * Приход.Стоимость / Приход.Знаменатель, 2);
		РасчетнаяПартия.СтоимостьБезНДС = Окр(ЗнаменательСписания * Приход.СтоимостьБезНДС / Приход.Знаменатель, 2);
		РасчетнаяПартия.СтоимостьРегл = Окр(ЗнаменательСписания * Приход.СтоимостьРегл / Приход.Знаменатель, 2);
		РасчетнаяПартия.НДСРегл = Окр(ЗнаменательСписания * Приход.НДСРегл / Приход.Знаменатель, 2);
		РасчетнаяПартия.ПостояннаяРазница = Окр(ЗнаменательСписания * Приход.ПостояннаяРазница / Приход.Знаменатель, 2);
		РасчетнаяПартия.ВременнаяРазница = Окр(ЗнаменательСписания * Приход.ВременнаяРазница / Приход.Знаменатель, 2);
	КонецЕсли;
	
	Если Расход.ТипЗаписи = "Распределение" ИЛИ Расход.ТипЗаписи = "ЗатратыБезЗаказа" ИЛИ Расход.ТипЗаписи = "ПолуфабрикатДавальца" Тогда
		РасчетнаяПартия.Знаменатель = Расход.КоличествоПродукции;
	КонецЕсли;
	Если Расход.ТипЗаписи = "Распределение"
	 И (Приход.ТипЗаписи = "Остаток" ИЛИ Приход.ТипЗаписи = "ОстатокСторно" ИЛИ Приход.ТипЗаписи = "ПолуфабрикатДавальца") Тогда
		РасчетнаяПартия.ТипЗаписи = Приход.ТипЗаписи;
	КонецЕсли;
	Если Расход.ТипЗаписи = "ЗатратыБезЗаказа" И Приход.ТипЗаписи = "ПолуфабрикатДавальца" Тогда
		РасчетнаяПартия.ТипЗаписи = Приход.ТипЗаписи;
	КонецЕсли;
	Если Расход.ТипЗаписи = "Выпуск" И Приход.ТипЗаписи = "ПолуфабрикатДавальца" Тогда
		РасчетнаяПартия.ТипЗаписи = Приход.ТипЗаписи;
	КонецЕсли;
	
	// корректируем базу расчета в приходе
	Приход.Стоимость = Приход.Стоимость - РасчетнаяПартия.Стоимость;
	Приход.СтоимостьБезНДС = Приход.СтоимостьБезНДС - РасчетнаяПартия.СтоимостьБезНДС;
	Приход.СтоимостьРегл = Приход.СтоимостьРегл - РасчетнаяПартия.СтоимостьРегл;
	Приход.НДСРегл = Приход.НДСРегл - РасчетнаяПартия.НДСРегл;
	Приход.ПостояннаяРазница = Приход.ПостояннаяРазница - РасчетнаяПартия.ПостояннаяРазница;
	Приход.ВременнаяРазница = Приход.ВременнаяРазница - РасчетнаяПартия.ВременнаяРазница;
	
	Приход.Количество = Приход.Количество - РасчетнаяПартия.Количество;
	Приход.Знаменатель = Приход.Знаменатель - ЗнаменательСписания;

	// Заполняем партионную идентификацию в расчетной партии
	Если (Расход.ТипЗаписи = "Распределение" ИЛИ Расход.ТипЗаписи = "ЗатратыБезЗаказа")
	 И Приход.ТипЗаписи = "ПолуфабрикатДавальца" Тогда
		РасчетнаяПартия.РазделУчета = Перечисления.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка();	
	КонецЕсли;
	РасчетнаяПартия.Подразделение = Приход.Подразделение;
	РасчетнаяПартия.АналитикаУчетаНоменклатуры = Приход.АналитикаУчетаНоменклатуры;
	РасчетнаяПартия.СтатьяКалькуляции = Приход.СтатьяКалькуляции;
	Если Не ЗначениеЗаполнено(РасчетнаяПартия.ЗаказНаПроизводство) ИЛИ РасчетнаяПартия.ТипЗаписи = "ПолуфабрикатДавальца" Тогда
		РасчетнаяПартия.ЗаказНаПроизводство = Приход.ЗаказНаПроизводство;
	КонецЕсли;
	Если Не ЗначениеЗаполнено(РасчетнаяПартия.КодСтрокиПродукция) ИЛИ РасчетнаяПартия.ТипЗаписи = "ПолуфабрикатДавальца" Тогда
		РасчетнаяПартия.КодСтрокиПродукция = Приход.КодСтрокиПродукция;
	КонецЕсли;
	Если Не ЗначениеЗаполнено(РасчетнаяПартия.Этап) ИЛИ РасчетнаяПартия.ТипЗаписи = "ПолуфабрикатДавальца" Тогда
		РасчетнаяПартия.Этап = Приход.Этап;
	КонецЕсли;
	Если Не ЗначениеЗаполнено(РасчетнаяПартия.Спецификация) ИЛИ РасчетнаяПартия.ТипЗаписи = "ПолуфабрикатДавальца" Тогда
		РасчетнаяПартия.Спецификация = Приход.Спецификация;
	КонецЕсли;
	Если Не ЗначениеЗаполнено(РасчетнаяПартия.ДокументПоступления) ИЛИ РасчетнаяПартия.ТипЗаписи = "ПолуфабрикатДавальца" Тогда
		РасчетнаяПартия.ДокументПоступления = Приход.ДокументПоступления;
	КонецЕсли;
	Если Расход.ТипЗаписи = "Распределение" ИЛИ Расход.ТипЗаписи = "Выпуск" ИЛИ Расход.ТипЗаписи = "ВыпускБезСтрок"
	 ИЛИ Расход.ТипЗаписи = "ЗатратыБезЗаказа" ИЛИ Расход.ТипЗаписи = "ВыпускБезЗаказа" ИЛИ Расход.ТипЗаписи = "Переработка"
	 ИЛИ Расход.ТипЗаписи = "ОтчетДавальцу" ИЛИ Расход.ТипЗаписи = "ПродукцияДавальца" Тогда
		РасчетнаяПартия.ДокументИсточник = Приход.ДокументИсточник;
	КонецЕсли;
	Если Расход.ТипЗаписи = "Партия" И Приход.ТипЗаписи = "ЗатратыБезЗаказа" Тогда
		РасчетнаяПартия.ДокументВыпуска = Приход.ДокументВыпуска;
	КонецЕсли;
	Если Не ЗначениеЗаполнено(РасчетнаяПартия.ДокументИсточник) Тогда
		РасчетнаяПартия.ДокументИсточник = Приход.Регистратор;
	КонецЕсли;
	Если Не ЗначениеЗаполнено(РасчетнаяПартия.ВидЗапасов) ИЛИ РасчетнаяПартия.ТипЗаписи = "ПолуфабрикатДавальца" Тогда
		РасчетнаяПартия.ВидЗапасов = Приход.ВидЗапасов;
	КонецЕсли;
	РасчетнаяПартия.ГруппаПродукции = Приход.ГруппаПродукции;
	Если Не ЗначениеЗаполнено(РасчетнаяПартия.Период) И РасчетнаяПартия.ТипЗаписи <> "ПродукцияДавальца" Тогда
		РасчетнаяПартия.Период = Приход.Период;
	КонецЕсли;
	Если Не ЗначениеЗаполнено(РасчетнаяПартия.Регистратор) И РасчетнаяПартия.ТипЗаписи <> "ПродукцияДавальца" Тогда
		РасчетнаяПартия.Регистратор = Приход.Регистратор;
	КонецЕсли;
	Если Не ЗначениеЗаполнено(РасчетнаяПартия.Назначение) Тогда
		РасчетнаяПартия.Назначение = Приход.Назначение;
	КонецЕсли;
	
	Если РасчетнаяПартия.ВидДвижения = ВидДвиженияНакопления.Приход Тогда
		РасчетнаяПартия.АналитикаУчетаПартий =
			АналитикаУчетаПартий(Приход.АналитикаУчетаПартий, Приход.НалогообложениеПартии, Приход.НалогообложениеНДС);
		РасчетнаяПартия.НалогообложениеПартии = Приход.НалогообложениеНДС;
	Иначе
		РасчетнаяПартия.АналитикаУчетаПартий = Приход.АналитикаУчетаПартий;
		РасчетнаяПартия.НалогообложениеПартии = Приход.НалогообложениеПартии;
	КонецЕсли;
	
	ЗаполнитьЗначенияСвойств(РасчетнаяПартия, Приход, "РасчетЗавершен");
	
	Если РасчетнаяПартия.Количество = 0
	 И РасчетнаяПартия.Стоимость = 0
	 И РасчетнаяПартия.СтоимостьБезНДС = 0
	 И РасчетнаяПартия.СтоимостьРегл = 0
	 И РасчетнаяПартия.НДСРегл = 0
	 И РасчетнаяПартия.ПостояннаяРазница = 0
	 И РасчетнаяПартия.ВременнаяРазница = 0 Тогда
		РасчетнаяПартия.Знаменатель = 0;
		РасчетнаяПартия.РасчетЗавершен = Ложь;
	КонецЕсли;
КонецПроцедуры

Процедура ЗаполнитьТрудозатратыНезавершенногоПроизводства(РасчетнаяПартия, Расход, Приход) // ТрудозатратыНезавершенногоПроизводства
	ЗаполнитьЗначенияСвойств(РасчетнаяПартия, Расход);
	Если Приход.Знаменатель = 0 Тогда
		Возврат;
	КонецЕсли;
	
	// расчетная партия заполняется на наибольшее общее вычитаемое
	ЗнаменательСписания = Мин(Расход.Знаменатель, Приход.Знаменатель);
	
	// заполняем показатели расчетной партии
	РасчетнаяПартия.Количество = Окр(ЗнаменательСписания * Приход.Количество / Приход.Знаменатель, 3);
	РасчетнаяПартия.НормативнаяСтоимость = Окр(ЗнаменательСписания * Приход.НормативнаяСтоимость / Приход.Знаменатель, 2);
	РасчетнаяПартия.Стоимость = Окр(ЗнаменательСписания * Приход.Стоимость / Приход.Знаменатель, 2);
	РасчетнаяПартия.СтоимостьРегл = Окр(ЗнаменательСписания * Приход.СтоимостьРегл / Приход.Знаменатель, 2);
	
	Если РасчетнаяПартия.ТипЗаписи = "МаршрутныйЛист" Тогда
		РасчетнаяПартия.Этап = Приход.Этап;
	КонецЕсли;
	Если РасчетнаяПартия.ТипЗаписи = "Выпуск" И Приход.ТипЗаписи = "МаршрутныйЛист" Тогда
		РасчетнаяПартия.Этап = Приход.Этап;
	КонецЕсли;
	
	Если Расход.ТипЗаписи = "МаршрутныйЛист" ИЛИ Расход.ТипЗаписи = "Перемещение"
		ИЛИ Расход.ТипЗаписи = "Распределение" ИЛИ Расход.ТипЗаписи = "Потребление"
		ИЛИ Расход.ТипЗаписи = "ПотреблениеАвто" Тогда
		РасчетнаяПартия.Знаменатель = Расход.КоличествоПродукции;
	КонецЕсли;
	Если Расход.ТипЗаписи = "ОтчетДавальцу" И (Приход.ТипЗаписи = "Выпуск" ИЛИ Приход.ТипЗаписи = "ВыпускБезЗаказа") Тогда
		РасчетнаяПартия.ДокументВыпуска = Приход.ДокументВыпуска;
		РасчетнаяПартия.КодСтроки = Приход.КодСтроки;
		РасчетнаяПартия.ЗаказНаПроизводство = Приход.ЗаказНаПроизводство;
		РасчетнаяПартия.КодСтрокиПродукция = Приход.КодСтрокиПродукция;
		РасчетнаяПартия.Этап = Приход.Этап;
		РасчетнаяПартия.СтатьяКалькуляции = Приход.СтатьяКалькуляции;
	КонецЕсли;
	
	// корректируем базу расчета в приходе
	Приход.Количество = Приход.Количество - РасчетнаяПартия.Количество;
	Приход.НормативнаяСтоимость = Приход.НормативнаяСтоимость - РасчетнаяПартия.НормативнаяСтоимость;
	Приход.Стоимость = Приход.Стоимость - РасчетнаяПартия.Стоимость;
	Приход.СтоимостьРегл = Приход.СтоимостьРегл - РасчетнаяПартия.СтоимостьРегл;
	
	Приход.Знаменатель = Приход.Знаменатель - ЗнаменательСписания;
	
	Если Расход.ТипЗаписи = "Потребление"
		ИЛИ Расход.ТипЗаписи = "ПотреблениеАвто" Тогда
		Расход.Знаменатель = Расход.Знаменатель - ЗнаменательСписания;
	КонецЕсли;
	
	Если Расход.ТипЗаписи <> "ОтчетДавальцу" И Приход.ТипЗаписи = "ПолуфабрикатДавальца" Тогда
		РасчетнаяПартия.ТипЗаписи = Приход.ТипЗаписи;
	КонецЕсли;

	// Заполняем партионную идентификацию в расчетной партии
	Если Не ЗначениеЗаполнено(РасчетнаяПартия.ЗаказНаПроизводство) ИЛИ РасчетнаяПартия.ТипЗаписи = "ПолуфабрикатДавальца" Тогда
		РасчетнаяПартия.ЗаказНаПроизводство = Приход.ЗаказНаПроизводство;
	КонецЕсли;
	Если Не ЗначениеЗаполнено(РасчетнаяПартия.КодСтрокиПродукция) ИЛИ РасчетнаяПартия.ТипЗаписи = "ПолуфабрикатДавальца" Тогда
		РасчетнаяПартия.КодСтрокиПродукция = Приход.КодСтрокиПродукция;
	КонецЕсли;
	Если Не ЗначениеЗаполнено(РасчетнаяПартия.Этап) ИЛИ РасчетнаяПартия.ТипЗаписи = "ПолуфабрикатДавальца" Тогда
		РасчетнаяПартия.Этап = Приход.Этап;
	КонецЕсли;
	
	РасчетнаяПартия.Подразделение = Приход.Подразделение;
	РасчетнаяПартия.ВидФондаВзносов = Приход.ВидФондаВзносов;
	РасчетнаяПартия.СтатьяКалькуляции = Приход.СтатьяКалькуляции;
	РасчетнаяПартия.ВидРабот = Приход.ВидРабот;
	РасчетнаяПартия.ГруппаПродукции = Приход.ГруппаПродукции;
	Если Не ЗначениеЗаполнено(РасчетнаяПартия.ДокументИсточник) Тогда
		РасчетнаяПартия.ДокументИсточник = Приход.Регистратор;
	КонецЕсли;
	Если Не ЗначениеЗаполнено(РасчетнаяПартия.Регистратор) Тогда
		РасчетнаяПартия.Регистратор = Приход.Регистратор;
	КонецЕсли;
	
	Если Не ЗначениеЗаполнено(РасчетнаяПартия.СтатьяКалькуляцииБезЗаказа) Тогда
		РасчетнаяПартия.СтатьяКалькуляцииБезЗаказа = Приход.СтатьяКалькуляцииБезЗаказа;
	КонецЕсли;
	
	ЗаполнитьЗначенияСвойств(РасчетнаяПартия, Приход, "РасчетЗавершен");
КонецПроцедуры

Процедура ЗаполнитьПрочиеРасходыНезавершенногоПроизводстваПоБазе(РасчетнаяПартия, Расход, Приход) // ПрочиеРасходыНезавершенногоПроизводства
	
	ЗаполнитьЗначенияСвойств(РасчетнаяПартия, Расход);
	Если Неопределено = Приход Тогда
		Возврат;
	КонецЕсли;
	
	// заполняем показатели расчетной партии
	Если Расход.ТипЗаписи = "ПоПодразделениям" Тогда
		ЗаполнитьЗначенияСвойств(РасчетнаяПартия, Приход, "Организация, ПодразделениеИсточник, СтатьяРасходов, АналитикаРасходов");
	ИначеЕсли Расход.ТипЗаписи = "ПоЭтапам" Тогда
		Если Не ЗначениеЗаполнено(Расход.ПодразделениеПриемник) Тогда
			Возврат;
		КонецЕсли;
		ЗаполнитьЗначенияСвойств(РасчетнаяПартия, Приход, "Организация, ПодразделениеИсточник, СтатьяРасходов, АналитикаРасходов");
		РасчетнаяПартия.Подразделение = Расход.ПодразделениеПриемник;
	КонецЕсли;
		
	РасчетнаяПартия.ДоляСтоимости = Окр(Приход.ДоляСтоимости * ?(Приход.Знаменатель = 0, 0, Расход.Знаменатель / Приход.Знаменатель), 2);
	Если РасчетнаяПартия.ДоляСтоимости <> 0 Тогда
		// Вычисляем долю стоимости в приходе, и, если она равна 0, то списываем весь остаток из прихода.
		Приход.ДоляСтоимости = Приход.ДоляСтоимости - РасчетнаяПартия.ДоляСтоимости;
		
		Если Приход.ДоляСтоимости = 0 Тогда
			РасчетнаяПартия.Стоимость = Приход.Стоимость;
			РасчетнаяПартия.СтоимостьБезНДС = Приход.СтоимостьБезНДС;
			РасчетнаяПартия.СтоимостьРегл = Приход.СтоимостьРегл;
			РасчетнаяПартия.ПостояннаяРазница = Приход.ПостояннаяРазница;
			РасчетнаяПартия.ВременнаяРазница = Приход.ВременнаяРазница;
		Иначе
			РасчетнаяПартия.Стоимость = Окр(Приход.Стоимость * ?(Приход.Знаменатель = 0, 0, Расход.Знаменатель / Приход.Знаменатель), 2);
			РасчетнаяПартия.СтоимостьБезНДС = Окр(Приход.СтоимостьБезНДС * ?(Приход.Знаменатель = 0, 0, Расход.Знаменатель / Приход.Знаменатель), 2);
			РасчетнаяПартия.СтоимостьРегл = Окр(Приход.СтоимостьРегл * ?(Приход.Знаменатель = 0, 0, Расход.Знаменатель / Приход.Знаменатель), 2);
			РасчетнаяПартия.ПостояннаяРазница = Окр(Приход.ПостояннаяРазница * ?(Приход.Знаменатель = 0, 0, Расход.Знаменатель / Приход.Знаменатель), 2);
			РасчетнаяПартия.ВременнаяРазница = Окр(Приход.ВременнаяРазница * ?(Приход.Знаменатель = 0, 0, Расход.Знаменатель / Приход.Знаменатель), 2);
		КонецЕсли;
		
		// Корректируем базу расчета в приходе
		Приход.Стоимость = Приход.Стоимость - РасчетнаяПартия.Стоимость;
		Приход.СтоимостьБезНДС = Приход.СтоимостьБезНДС - РасчетнаяПартия.СтоимостьБезНДС;
		Приход.СтоимостьРегл = Приход.СтоимостьРегл - РасчетнаяПартия.СтоимостьРегл;
		Приход.ПостояннаяРазница = Приход.ПостояннаяРазница - РасчетнаяПартия.ПостояннаяРазница;
		Приход.ВременнаяРазница = Приход.ВременнаяРазница - РасчетнаяПартия.ВременнаяРазница;
	КонецЕсли;
	Приход.Знаменатель = Приход.Знаменатель - Расход.Знаменатель;
	
	// корректируем базу расчета в расходе
	Расход.Знаменатель = 0;
	
	Если РасчетнаяПартия.ДоляСтоимости = 0
		И РасчетнаяПартия.Стоимость = 0
		И РасчетнаяПартия.СтоимостьБезНДС = 0
		И РасчетнаяПартия.СтоимостьРегл = 0
		И РасчетнаяПартия.ПостояннаяРазница = 0
		И РасчетнаяПартия.ВременнаяРазница = 0 Тогда
		РасчетнаяПартия.РасчетЗавершен = Ложь;
	Иначе
		РасчетнаяПартия.РасчетЗавершен = Истина;
	КонецЕсли;
	
КонецПроцедуры

Процедура ЗаполнитьПрочиеРасходыПоБазе(РасчетнаяПартия, Расход, Приход) // ПрочиеРасходы
	
	ЗаполнитьЗначенияСвойств(РасчетнаяПартия, Расход);
	Если Неопределено = Приход Тогда
		Возврат;
	КонецЕсли;
	
	РасчетнаяПартия.ДоляСтоимости = Окр(Приход.ДоляСтоимости * ?(Приход.Знаменатель = 0, 0, Расход.Знаменатель / Приход.Знаменатель), 2);
	РасчетнаяПартия.Сумма = Окр(Приход.Сумма * ?(Приход.Знаменатель = 0, 0, Расход.Знаменатель / Приход.Знаменатель), 2);
	РасчетнаяПартия.СуммаБезНДС = Окр(Приход.СуммаБезНДС * ?(Приход.Знаменатель = 0, 0, Расход.Знаменатель / Приход.Знаменатель), 2);
	РасчетнаяПартия.СуммаРегл = Окр(Приход.СуммаРегл * ?(Приход.Знаменатель = 0, 0, Расход.Знаменатель / Приход.Знаменатель), 2);
	РасчетнаяПартия.ПостояннаяРазница = Окр(Приход.ПостояннаяРазница * ?(Приход.Знаменатель = 0, 0, Расход.Знаменатель / Приход.Знаменатель), 2);
	РасчетнаяПартия.ВременнаяРазница = Окр(Приход.ВременнаяРазница * ?(Приход.Знаменатель = 0, 0, Расход.Знаменатель / Приход.Знаменатель), 2);
	Если Расход.ТипЗаписи = "Потребление" И Приход.ТипЗаписи = "Списание" Тогда
		РасчетнаяПартия.СуммаБезНДС = 0;
	КонецЕсли;
	
	// корректируем базу расчета в приходе
	Приход.ДоляСтоимости = Приход.ДоляСтоимости - РасчетнаяПартия.ДоляСтоимости;
	Приход.Сумма = Приход.Сумма - РасчетнаяПартия.Сумма;
	Приход.СуммаБезНДС = Приход.СуммаБезНДС - РасчетнаяПартия.СуммаБезНДС;
	Приход.СуммаРегл = Приход.СуммаРегл - РасчетнаяПартия.СуммаРегл;
	Приход.ПостояннаяРазница = Приход.ПостояннаяРазница - РасчетнаяПартия.ПостояннаяРазница;
	Приход.ВременнаяРазница = Приход.ВременнаяРазница - РасчетнаяПартия.ВременнаяРазница;
	Приход.Знаменатель = Приход.Знаменатель - Расход.Знаменатель;
	
	// корректируем базу расчета в расходе
	Расход.Знаменатель = 0;
	
	РасчетнаяПартия.РасчетЗавершен = Истина;
	
КонецПроцедуры

Процедура ЗаполнитьПрочиеРасходыНезавершенногоПроизводства(РасчетнаяПартия, Расход, Приход) // ПрочиеРасходыНезавершенногоПроизводства
	ЗаполнитьЗначенияСвойств(РасчетнаяПартия, Расход);
	Если Приход.Знаменатель = 0 Тогда
		Возврат;
	КонецЕсли;
	
	// расчетная партия заполняется на наибольшее общее вычитаемое
	ЗнаменательСписания = Мин(Расход.Знаменатель, Приход.Знаменатель);
	
	// заполняем показатели расчетной партии
	РасчетнаяПартия.ДоляСтоимости = Окр(ЗнаменательСписания * Приход.ДоляСтоимости / Приход.Знаменатель, 2);
	РасчетнаяПартия.Стоимость = Окр(ЗнаменательСписания * Приход.Стоимость / Приход.Знаменатель, 2);
	РасчетнаяПартия.СтоимостьБезНДС = Окр(ЗнаменательСписания * Приход.СтоимостьБезНДС / Приход.Знаменатель, 2);
	РасчетнаяПартия.СтоимостьРегл = Окр(ЗнаменательСписания * Приход.СтоимостьРегл / Приход.Знаменатель, 2);
	РасчетнаяПартия.ПостояннаяРазница = Окр(ЗнаменательСписания * Приход.ПостояннаяРазница / Приход.Знаменатель, 2);
	РасчетнаяПартия.ВременнаяРазница = Окр(ЗнаменательСписания * Приход.ВременнаяРазница / Приход.Знаменатель, 2);
	
	Если Расход.ТипЗаписи = "Распределение" ИЛИ Расход.ТипЗаписи = "ЗатратыБезЗаказа" ИЛИ Расход.ТипЗаписи = "ПолуфабрикатДавальца"
	 ИЛИ Расход.ТипЗаписи = "СписанияНаВыпуск" Тогда
		РасчетнаяПартия.Знаменатель = Расход.КоличествоПродукции;
	КонецЕсли;	
	
	// корректируем базу расчета в приходе
	Приход.ДоляСтоимости = Приход.ДоляСтоимости - РасчетнаяПартия.ДоляСтоимости;
	Приход.Стоимость = Приход.Стоимость - РасчетнаяПартия.Стоимость;
	Приход.СтоимостьБезНДС = Приход.СтоимостьБезНДС - РасчетнаяПартия.СтоимостьБезНДС;
	Приход.СтоимостьРегл = Приход.СтоимостьРегл - РасчетнаяПартия.СтоимостьРегл;
	Приход.ПостояннаяРазница = Приход.ПостояннаяРазница - РасчетнаяПартия.ПостояннаяРазница;
	Приход.ВременнаяРазница = Приход.ВременнаяРазница - РасчетнаяПартия.ВременнаяРазница;
	
	Приход.Знаменатель = Приход.Знаменатель - ЗнаменательСписания;
	
	Если Расход.ТипЗаписи <> "ОтчетДавальцу" И Приход.ТипЗаписи = "ПолуфабрикатДавальца" Тогда
		РасчетнаяПартия.ТипЗаписи = Приход.ТипЗаписи;
	КонецЕсли;

	// Заполняем партионную идентификацию в расчетной партии
	Если Не ЗначениеЗаполнено(РасчетнаяПартия.Подразделение) ИЛИ РасчетнаяПартия.ТипЗаписи = "ПолуфабрикатДавальца" Тогда
		РасчетнаяПартия.Подразделение = Приход.Подразделение;
	КонецЕсли;
	Если Не ЗначениеЗаполнено(РасчетнаяПартия.ЗаказНаПроизводство) ИЛИ РасчетнаяПартия.ТипЗаписи = "ПолуфабрикатДавальца" Тогда
		РасчетнаяПартия.ЗаказНаПроизводство = Приход.ЗаказНаПроизводство;
	КонецЕсли;
	Если Не ЗначениеЗаполнено(РасчетнаяПартия.КодСтрокиПродукция) ИЛИ РасчетнаяПартия.ТипЗаписи = "ПолуфабрикатДавальца" Тогда
		РасчетнаяПартия.КодСтрокиПродукция = Приход.КодСтрокиПродукция;
	КонецЕсли;
	Если Не ЗначениеЗаполнено(РасчетнаяПартия.Этап) ИЛИ РасчетнаяПартия.ТипЗаписи = "ПолуфабрикатДавальца" Тогда
		РасчетнаяПартия.Этап = Приход.Этап;
	КонецЕсли;
	Если Не ЗначениеЗаполнено(РасчетнаяПартия.Спецификация) ИЛИ РасчетнаяПартия.ТипЗаписи = "ПолуфабрикатДавальца" Тогда
		РасчетнаяПартия.Спецификация = Приход.Спецификация;
	КонецЕсли;
	Если Не ЗначениеЗаполнено(РасчетнаяПартия.СтатьяКалькуляции) ИЛИ РасчетнаяПартия.ТипЗаписи = "ПолуфабрикатДавальца" Тогда
		РасчетнаяПартия.СтатьяКалькуляции = Приход.СтатьяКалькуляции;
	КонецЕсли;
	Если Не ЗначениеЗаполнено(РасчетнаяПартия.ДокументВыпуска)
	 ИЛИ РасчетнаяПартия.ТипЗаписи = "ПолуфабрикатДавальца"
	 ИЛИ РасчетнаяПартия.ТипЗаписи = "ОтчетДавальцу" Тогда
		РасчетнаяПартия.ДокументВыпуска = Приход.ДокументВыпуска;
	КонецЕсли;
	РасчетнаяПартия.СтатьяРасходов = Приход.СтатьяРасходов;
	РасчетнаяПартия.АналитикаРасходов = Приход.АналитикаРасходов;
	РасчетнаяПартия.ГруппаПродукции = Приход.ГруппаПродукции;
	Если Не ЗначениеЗаполнено(РасчетнаяПартия.Период) Тогда
		РасчетнаяПартия.Период = Приход.Период;
	КонецЕсли;
	Если Не ЗначениеЗаполнено(РасчетнаяПартия.Регистратор) Тогда
		РасчетнаяПартия.Регистратор = Приход.Регистратор;
	КонецЕсли;
	Если РасчетнаяПартия.ВидДвижения = ВидДвиженияНакопления.Приход
	 И Не ЗначениеЗаполнено(РасчетнаяПартия.ДокументДвижения) Тогда
		РасчетнаяПартия.ДокументДвижения = Приход.ДокументДвижения;
	КонецЕсли;
	Если РасчетнаяПартия.ТипЗаписи = "ОтчетДавальцу" ИЛИ РасчетнаяПартия.ТипЗаписи = "ПолуфабрикатДавальца" Тогда
		РасчетнаяПартия.ДокументИсточник = Приход.ДокументИсточник;
	КонецЕсли;
	Если Не ЗначениеЗаполнено(РасчетнаяПартия.ДокументИсточник) ИЛИ РасчетнаяПартия.ДокументИсточник = НЕОПРЕДЕЛЕНО Тогда
		РасчетнаяПартия.ДокументИсточник = Приход.Регистратор;
	КонецЕсли;
	
	РасчетнаяПартия.РасчетЗавершен = Приход.РасчетЗавершен;
КонецПроцедуры
//-- НЕ УТ

Процедура ЗаполнитьСтатьюИАналитикуСписанияНДС(РасчетнаяПартия, Расход, Приход)
	
	Период = НачалоМесяца(РасчетнаяПартия.Период);
	
	ПараметрыУчетнойПолитики = НастройкиНалоговУчетныхПолитик.ДействующиеПараметрыНалоговУчетныхПолитикНаДату("НастройкиУчетаНДС",
		РасчетнаяПартия.Организация,
		НачалоМесяца(Период));
		
	Если ПараметрыУчетнойПолитики <> Неопределено
		И ПараметрыУчетнойПолитики.ВариантУчетаНДСПриИзмененииВидаДеятельности = Перечисления.ВариантыУчетаНДСПриИзмененииВидаДеятельностиНаНеоблагаемую.ВключатьВСтоимость Тогда
		Возврат;
	КонецЕсли;
	
	Если УчетНДСУП.ВозможноСписаниеНДС(РасчетнаяПартия.НалогообложениеПартии, РасчетнаяПартия.НалогообложениеНДС)
	 ИЛИ (РасчетнаяПартия.ВидДвижения = ВидДвиженияНакопления.Приход
	  И УчетНДСУП.ВозможноСписаниеНДС(Приход.НалогообложениеПартии, Приход.НалогообложениеНДС)) Тогда
		
		Если ПараметрыУчетнойПолитики <> Неопределено
			И ПараметрыУчетнойПолитики.ВариантУчетаНДСПриИзмененииВидаДеятельности = Перечисления.ВариантыУчетаНДСПриИзмененииВидаДеятельностиНаНеоблагаемую.ВключатьВСтоимостьИлиРасходыВЗависимостиОтПериода Тогда
			
			Если ЗначениеЗаполнено(РасчетнаяПартия.ДокументПоступления) Тогда
				ДатаПартии = НачалоМесяца(ОбщегоНазначения.ЗначениеРеквизитаОбъекта(РасчетнаяПартия.ДокументПоступления, "Дата"));
			Иначе
				ДатаПартии = Дата(1,1,1);
			КонецЕсли;
			
			Если ДатаПартии = Период Тогда
				Возврат;
			КонецЕсли;
			
		КонецЕсли;
		
		Если ПараметрыУчетнойПолитики <> Неопределено
			И УчетНДСУП.ВозможноСписаниеНДС(РасчетнаяПартия.НалогообложениеПартии, РасчетнаяПартия.НалогообложениеНДС) Тогда
			
			Если РасчетнаяПартия.НалогообложениеНДС = Перечисления.ТипыНалогообложенияНДС.ПродажаНеОблагаетсяНДС Тогда
				РасчетнаяПартия.СтатьяСписанияНДС 	 = ПараметрыУчетнойПолитики.СтатьяРасходовНеНДС;
				РасчетнаяПартия.АналитикаСписанияНДС = ПараметрыУчетнойПолитики.АналитикаРасходовНеНДС;
			Иначе
				РасчетнаяПартия.СтатьяСписанияНДС 	 = ПараметрыУчетнойПолитики.СтатьяРасходовЕНВД;
				РасчетнаяПартия.АналитикаСписанияНДС = ПараметрыУчетнойПолитики.АналитикаРасходовЕНВД;
			КонецЕсли;
			
		Иначе
			
			РасчетнаяПартия.НДСРегл = 0;
			
		КонецЕсли;
		
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти

// Общие алгоритмы расчета партий
#Область ОбщиеРасчетныеМетоды

Процедура УдалитьНезаписываемыеСтроки(Контекст, РасчетныеПартии)
	
	УдаляемыеТипы = Новый Структура;
	УдаляемыеРазделы = Новый Соответствие;
	Если Контекст = "ПартииТоваровОрганизаций" Тогда
		УдаляемыеТипы.Вставить("Остаток");
		УдаляемыеТипы.Вставить("Прошлое");
		УдаляемыеРазделы.Вставить(Перечисления.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты, "");
		УдаляемыеРазделы.Вставить(Перечисления.РазделыУчетаСебестоимостиТоваров.ТоварыПереданныеНаКомиссию, "");
		УдалятьНезавершенные = Ложь;
	ИначеЕсли Контекст = "ПартииТоваровПереданныеНаКомиссию" Тогда
		УдаляемыеТипы.Вставить("Остаток");
		УдалятьНезавершенные = Истина;
	ИначеЕсли Контекст = "ПартииРасходовНаСебестоимостьТоваров" Тогда
		УдаляемыеТипы.Вставить("Остаток");
		УдаляемыеТипы.Вставить("Прочее");
		УдаляемыеТипы.Вставить("Прошлое");
		УдаляемыеТипы.Вставить("Услуги");
		УдалятьНезавершенные = Истина;
	ИначеЕсли Контекст = "ПартииЗатратНаВыпуск" Тогда
		УдаляемыеТипы.Вставить("Остаток");
		УдаляемыеТипы.Вставить("Прочее");
		УдаляемыеТипы.Вставить("Прошлое");
		УдалятьНезавершенные = Истина;
	ИначеЕсли Контекст = "ПартииПроизводственныхЗатрат" Тогда
		УдаляемыеТипы.Вставить("Остаток");
		УдаляемыеТипы.Вставить("ОстатокСторно");
		УдалятьНезавершенные = Ложь;	
	ИначеЕсли Контекст = "ПартииНезавершенногоПроизводства" Тогда
		УдаляемыеТипы.Вставить("Остаток");
		УдаляемыеТипы.Вставить("ОстатокСторно");
		УдаляемыеРазделы.Вставить(Перечисления.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка(), "");
		УдалятьНезавершенные = Истина;
	ИначеЕсли Контекст = "ТрудозатратыНезавершенногоПроизводства" Тогда
		УдаляемыеТипы.Вставить("Остаток");
		УдаляемыеТипы.Вставить("НЗП");
		УдаляемыеТипы.Вставить("МаршрутныйЛист");
		УдаляемыеТипы.Вставить("ОстатокБезЗаказа");
		УдаляемыеТипы.Вставить("ПартияБезЗаказа");
		УдаляемыеТипы.Вставить("Потребление");
		УдаляемыеТипы.Вставить("Перемещение");
		УдаляемыеТипы.Вставить("Распределение");
		УдаляемыеТипы.Вставить("ПолуфабрикатДавальца");
		УдаляемыеРазделы.Вставить(Перечисления.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка(), "");
		УдалятьНезавершенные = Истина;
	ИначеЕсли Контекст = "ПрочиеРасходыНезавершенногоПроизводства" Тогда
		УдаляемыеТипы.Вставить("Остаток");
		УдаляемыеТипы.Вставить("Распределение");
		УдаляемыеТипы.Вставить("ПоБазеБезЗаказа");
		УдаляемыеТипы.Вставить("ПолуфабрикатДавальца");
		УдаляемыеРазделы.Вставить(Перечисления.РазделыУчетаСебестоимостиТоваров.МатериалыПринятыеВПереработку, "");
		УдалятьНезавершенные = Истина;
	ИначеЕсли Контекст = "ПрочиеРасходыНезавершенногоПроизводстваКРаспределению" Тогда
		УдаляемыеТипы.Вставить("Партия");
		УдалятьНезавершенные = Истина;
	ИначеЕсли Контекст = "ПрочиеРасходыНезавершенногоПроизводстваПоБазе" Тогда
		УдаляемыеТипы.Вставить("Партия");
		УдалятьНезавершенные = Истина;
	ИначеЕсли Контекст = "ПрочиеРасходыПоБазе" Тогда
		УдаляемыеТипы.Вставить("Партия");
		УдалятьНезавершенные = Истина;
	ИначеЕсли Контекст = "РаспределениеМатериаловИРабот" Тогда
		УдаляемыеТипы.Вставить("Партия");
		УдалятьНезавершенные = Истина;	
	КонецЕсли;
	
	МинимальныйИндекс = 1 - РасчетныеПартии.Количество();
	Для Индекс = МинимальныйИндекс По 0 Цикл
		РасчетнаяПартия = РасчетныеПартии[-Индекс];
		Если УдалятьНезавершенные И РасчетнаяПартия.РасчетЗавершен <> Истина
		 Или УдаляемыеТипы.Свойство(РасчетнаяПартия.ТипЗаписи)
		 Или УдаляемыеРазделы[РасчетнаяПартия.РазделУчета] <> Неопределено
		Тогда
			РасчетныеПартии.Удалить(-Индекс);
		КонецЕсли;
	КонецЦикла;
	
КонецПроцедуры

Функция Регистраторы(НачалоПериода, ОкончаниеПериода, МассивОрганизаций, ИмяРегистра,
			МассивИсключаемыхТипов = Неопределено, МассивПоддерживаемыхТипов = Неопределено)
	
	Если МассивИсключаемыхТипов = Неопределено Тогда
		МассивИсключаемыхТипов = Новый Массив;
	КонецЕсли;
	Если МассивПоддерживаемыхТипов = Неопределено Тогда
		МассивПоддерживаемыхТипов = Новый Массив;
	КонецЕсли;
	
	ШаблонЗапроса = "
		|ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	ДД.Регистратор КАК Регистратор
		|ИЗ
		|	&ШаблонРегистра КАК ДД
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И НЕ ТипЗначения(ДД.Регистратор) В (&МассивИсключаемыхТипов)
		|	И (&ПоддерживаютсяВсеТипы ИЛИ ТипЗначения(ДД.Регистратор) В (&МассивПоддерживаемыхТипов))
		|";
	
	Запрос = Новый Запрос(СтрЗаменить(ШаблонЗапроса, "&ШаблонРегистра", "РегистрНакопления." + ИмяРегистра));
	Запрос.УстановитьПараметр("НачалоПериода", НачалоПериода);
	Запрос.УстановитьПараметр("ОкончаниеПериода", ОкончаниеПериода);
	Запрос.УстановитьПараметр("МассивОрганизаций", МассивОрганизаций);	
	Запрос.УстановитьПараметр("МассивИсключаемыхТипов", МассивИсключаемыхТипов);
	Запрос.УстановитьПараметр("МассивПоддерживаемыхТипов", МассивПоддерживаемыхТипов);
	Запрос.УстановитьПараметр("ПоддерживаютсяВсеТипы", НЕ ЗначениеЗаполнено(МассивПоддерживаемыхТипов));
	
	Регистраторы = Новый Соответствие;
	Выборка = Запрос.Выполнить().Выбрать();
	
	Пока Выборка.Следующий() Цикл
		Регистраторы.Вставить(Выборка.Регистратор, Истина);
	КонецЦикла;
	
	Возврат Регистраторы;
	
КонецФункции

Процедура РегистраторыПартийВПути(НачалоПериода, ОкончаниеПериода, МассивОрганизаций, Регистраторы)
	ТекстЗапроса = "
		|ВЫБРАТЬ
		|	ДД.Ссылка КАК Регистратор
		|ИЗ
		|	Документ.РеализацияТоваровУслуг КАК ДД
		|ГДЕ
		|	(ДД.ДатаПереходаПраваСобственности МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|		ИЛИ ДД.ДатаПереходаПраваСобственности = ДАТАВРЕМЯ(1,1,1))
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Проведен
		|	И ДД.ХозяйственнаяОперация В (
		|		ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РеализацияБезПереходаПраваСобственности),
		|		ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РеализацияЧерезКомиссионераБезПереходаПраваСобственности))
		|";
	Запрос = Новый Запрос(ТекстЗапроса);
	Запрос.УстановитьПараметр("НачалоПериода", НачалоПериода);
	Запрос.УстановитьПараметр("ОкончаниеПериода", ОкончаниеПериода);
	Запрос.УстановитьПараметр("МассивОрганизаций", МассивОрганизаций);	
	Выборка = Запрос.Выполнить().Выбрать();
	Пока Выборка.Следующий() Цикл
		Регистраторы.Вставить(Выборка.Регистратор, Истина);
	КонецЦикла;
КонецПроцедуры

Функция РегистраторыПартийПрочих(НачалоПериода, ОкончаниеПериода, МассивОрганизаций)
	Запрос = Новый Запрос("
		|ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	ДД.Регистратор КАК Регистратор
		|ИЗ
		|	РегистрНакопления.ПартииПрочихРасходов КАК ДД
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрНакопления.СебестоимостьТоваров КАК Себестоимость
		|		ПО Себестоимость.Регистратор = ДД.Регистратор
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ПланВидовХарактеристик.СтатьиРасходов КАК Статьи
		|		ПО Статьи.Ссылка = ДД.СтатьяРасходов
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И ДД.Регистратор = ДД.ДокументПоступленияРасходов
		|	И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|	И Себестоимость.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И НЕ Себестоимость.РасчетСебестоимости
		|	И НЕ Себестоимость.СтатьяРасходовСписания = ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка)
		|	И (Статьи.ВариантРаспределенияРасходовУпр =
		|			ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаСебестоимостьТоваров)
		|		ИЛИ Статьи.ВариантРаспределенияРасходовРегл =
		|			ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаСебестоимостьТоваров))
		|");
	Запрос.УстановитьПараметр("НачалоПериода", НачалоПериода);
	Запрос.УстановитьПараметр("ОкончаниеПериода", ОкончаниеПериода);
	Запрос.УстановитьПараметр("МассивОрганизаций", МассивОрганизаций);	
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	Регистраторы = Новый Соответствие;
	Пока Выборка.Следующий() Цикл
		Регистраторы.Вставить(Выборка.Регистратор, Истина);
	КонецЦикла;
	
	Возврат Регистраторы;
	
КонецФункции

//++ НЕ УТКА

Процедура РегистраторыПрошлыхДвиженийМаршрутныхЛистов(НачалоПериода, ОкончаниеПериода, МассивОрганизаций, Регистраторы)
	
	Запрос = Новый Запрос;
	
	Запрос.Текст =
	"ВЫБРАТЬ
	|	ДД.Регистратор КАК Регистратор,
	|	СУММА(1) КАК Количество
	|ИЗ
	|	(ВЫБРАТЬ РАЗЛИЧНЫЕ
	|		ДД.Регистратор КАК Регистратор
	|	ИЗ
	|		РегистрНакопления.ПартииПроизводственныхЗатрат КАК ДД
	|	ГДЕ
	|		ДД.Период < &НачалоПериода
	|		И ДД.Организация В(&МассивОрганизаций)
	|		И ДД.Регистратор ССЫЛКА Документ.МаршрутныйЛистПроизводства
	|		И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|		И ДД.Активность
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ РАЗЛИЧНЫЕ
	|		ДД.Регистратор
	|	ИЗ
	|		РегистрНакопления.МатериалыИРаботыВПроизводстве КАК ДД
	|	ГДЕ
	|		ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
	|		И ДД.Организация В(&МассивОрганизаций)
	|		И ДД.Регистратор ССЫЛКА Документ.МаршрутныйЛистПроизводства
	|		И ДД.Активность) КАК ДД
	|
	|СГРУППИРОВАТЬ ПО
	|	ДД.Регистратор
	|
	|ИМЕЮЩИЕ
	|	СУММА(1) = 2";
	
	Запрос.УстановитьПараметр("НачалоПериода",     НачалоПериода);
	Запрос.УстановитьПараметр("ОкончаниеПериода",  ОкончаниеПериода);
	Запрос.УстановитьПараметр("МассивОрганизаций", МассивОрганизаций);	
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	Пока Выборка.Следующий() Цикл
		Регистраторы.Вставить(Выборка.Регистратор, Истина);
	КонецЦикла;
	
КонецПроцедуры
//-- НЕ УТКА

Процедура ЗаписатьРасчетныеПартии(МенеджерРегистра, РасчетныеПартии, Регистраторы) Экспорт
	
	Если ТестированиеБезЗаписи() Тогда
		Возврат;
	КонецЕсли;
	
	Если РасчетныеПартии.Количество() = 0 Тогда
		Возврат;
	КонецЕсли;
	
	НачалоЗамера = ТекущаяУниверсальнаяДатаВМиллисекундах();
	КоличествоНенулевыхЗаписей = 0;
	КоличествоРегистраторов = 0;
	
	РасчетныеПартии.Сортировать("Регистратор", Новый СравнениеЗначений);
	
	Движения = МенеджерРегистра.СоздатьНаборЗаписей();
	Движения.ДополнительныеСвойства.Вставить(ИмяДополнительногоСвойстваЗаписываемогоНабора());
	ДатыЗапретаИзмененияУТ.ОтключитьПроверкуДатыЗапретаИзменения(Движения);
	
	Если ИсходящиеДанныеМеханизма().Получить(Движения.Метаданные()) = Неопределено Тогда
		
		ТекстДляПротокола = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
			НСтр("ru = 'Движения по регистру ""%1"" не должны формироваться механизмом расчета партий.';
				|en = 'Records for the ""%1"" register should not be generated by the batch calculator. '"),
			Движения.Метаданные().Имя);
		
		ВызватьИсключение РасчетСебестоимостиПрикладныеАлгоритмы.ТекстИсключениеДляРегистрацииПроблемы(ТекстДляПротокола);
		
	КонецЕсли;
	
	// Получим структуру с ключами, соответствующими ресурсам регистра.
	МетаданныеРегистра = Движения.Метаданные();
	СтруктураРесурсов = Новый Структура;
	Для Каждого МетаРесурс Из МетаданныеРегистра.Ресурсы Цикл
		СтруктураРесурсов.Вставить(МетаРесурс.Имя, 0);
	КонецЦикла;
	
	Регистратор = Неопределено;
	Замещать = Истина;
	Счетчик = 0;
	МаксимумСчетчика = РасчетныеПартии.Количество() - 1;
	
	Пока Счетчик <= МаксимумСчетчика Цикл
		
		РасчетнаяПартия = РасчетныеПартии[Счетчик];
		Если Регистратор <> РасчетнаяПартия.Регистратор Тогда
			Регистратор = РасчетнаяПартия.Регистратор;
			
			Движения.Очистить();
			Движения.Отбор.Регистратор.Установить(Регистратор);
			
			Если Регистраторы <> Неопределено Тогда
				Если Регистраторы[Регистратор] <> Неопределено Тогда
					Замещать = Истина;
					Регистраторы.Удалить(Регистратор);
				Иначе
					Замещать = Ложь;
				КонецЕсли;
			КонецЕсли;
		КонецЕсли;
		
		// Проверим заполненность ресурсов в расчетной партии.
		ЗаполнитьЗначенияСвойств(СтруктураРесурсов, РасчетнаяПартия);
		
		Если НЕ ОбщегоНазначенияУТКлиентСервер.ЗначенияСтруктурыНеЗаполнены(СтруктураРесурсов) Тогда
			Движение = Движения.Добавить();
			ЗаполнитьЗначенияСвойств(Движение, РасчетнаяПартия);
		КонецЕсли;
		
		Счетчик = Счетчик + 1;
		
		Если Счетчик > МаксимумСчетчика Или (Регистратор <> РасчетныеПартии[Счетчик].Регистратор) Тогда
			Если Замещать ИЛИ Движения.Количество() > 0 Тогда
				КоличествоНенулевыхЗаписей = КоличествоНенулевыхЗаписей + Движения.Количество();
				КоличествоРегистраторов = КоличествоРегистраторов + 1;
				Движения.Записать(Замещать);
			КонецЕсли;
		КонецЕсли;
		
	КонецЦикла;
	
	Замер = ТекущаяУниверсальнаяДатаВМиллисекундах() - НачалоЗамера;
	Комментарий = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
		НСтр("ru = 'Записано движений: %1 шт. по %2 док., длительность: %3 сек.';
			|en = 'Records saved: %1 pcs. by %2 doc., duration: %3 sec.'"),
		СокрЛП(КоличествоНенулевыхЗаписей),
		СокрЛП(КоличествоРегистраторов),
		СокрЛП(Замер/1000));
	ЗаписьЖурналаРегистрации(
		НСтр("ru = 'Партионный учет.ЗаписатьРасчетныеПартии';
			|en = 'Batch accounting.ЗаписатьРасчетныеПартии'", ОбщегоНазначения.КодОсновногоЯзыка()),
		УровеньЖурналаРегистрации.Информация,,, Комментарий);
	
КонецПроцедуры

Функция ТекстОтборПоТипамРегистраторовДляСохраненияДвижений()
	
	// Получим перечень метаданные документов, формирующих движения по нескольким организациям.
	МетаданныеСохраняемыхРегистраторов = РасчетСебестоимостиПрикладныеАлгоритмы.ДокументыСРазнымиПериодамиИлиОрганизациямиВДвижениях(Ложь, Истина);
	
	// Сформируем текст для отбора по типу регистратора
	ТекстОтборПоТипамРегистраторов = "";
	
	Для Каждого КлючИЗначение Из МетаданныеСохраняемыхРегистраторов Цикл
		ТекстОтборПоТипамРегистраторов = ТекстОтборПоТипамРегистраторов
			+ ?(ТекстОтборПоТипамРегистраторов = "", "", ", ") + "ТИП(" + КлючИЗначение.Ключ.ПолноеИмя() + ")";
	КонецЦикла;
	
	Возврат "ТИПЗНАЧЕНИЯ(Т.Регистратор) В (" + ТекстОтборПоТипамРегистраторов + ")";
	
КонецФункции

Функция РегистраторыССохраняемымиДвижениями(ИмяРегистра, МенеджерВременныхТаблиц, СтарыеРегистраторы, НачалоПериода, ОкончаниеПериода, МассивОрганизаций)
	
	// Подготовим запрос
	Запрос = Новый Запрос;
	Запрос.МенеджерВременныхТаблиц = МенеджерВременныхТаблиц;
	Запрос.УстановитьПараметр("НачалоПериода",  	НачалоПериода);
	Запрос.УстановитьПараметр("ОкончаниеПериода",  	ОкончаниеПериода);
	Запрос.УстановитьПараметр("МассивОрганизаций",  МассивОрганизаций);
	Запрос.УстановитьПараметр("СтарыеРегистраторы",
		ОбщегоНазначенияУТКлиентСервер.ПреобразоватьСоответствиеИлиСтруктуруВМассив(СтарыеРегистраторы));
	
	// Надо сохранить движения по "другим" организациям из тех регистраторов, которые
	//	- входят в регистраторы таблицы данных для расчета партий
	//  - могут формировать движения по нескольким организациям
	//  - входят в список "старых" регистраторов (для них запись расчетных движений будет выполняться с замещением).
	Запрос.Текст =
	"ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	Т.Регистратор
	|ПОМЕСТИТЬ ВТСохраняемыеРегистраторы
	|ИЗ
	|	Данные КАК Т
	|ГДЕ
	|	%1
	|	И Т.Регистратор В (&СтарыеРегистраторы)
	|;
	|/////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	*
	|ПОМЕСТИТЬ ВТСохраняемыеДвижения
	|ИЗ
	|	РегистрНакопления.%2 КАК Т
	|ГДЕ
	|	Т.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
	|	И Т.Регистратор В (ВЫБРАТЬ Т.Регистратор ИЗ ВТСохраняемыеРегистраторы КАК Т)
	|	И НЕ (Т.Организация В (&МассивОрганизаций))
	|;
	|/////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	Т.Регистратор
	|ИЗ
	|	ВТСохраняемыеДвижения КАК Т
	|";
	
	Запрос.Текст = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
		Запрос.Текст,
		ТекстОтборПоТипамРегистраторовДляСохраненияДвижений(),
		ИмяРегистра);
		
	// Получим перечень регистраторов, у которых нужно сохранить движения
	РегистраторыССохраняемымиДвижениями = Новый Соответствие;
	
	Выборка = Запрос.Выполнить().Выбрать();
	Пока Выборка.Следующий() Цикл
		// При восстановлении сохраненных движений их надо добавлять к сформированным расчетным движениям (без замещения).
		РегистраторыССохраняемымиДвижениями.Вставить(Выборка.Регистратор, Ложь);
	КонецЦикла;
	
	Возврат РегистраторыССохраняемымиДвижениями;
	
КонецФункции

Процедура ЗаписатьСохраняемыеДвижения(МенеджерРегистра, МенеджерВременныхТаблиц, РегистраторыССохраняемымиДвижениями)
	
	Если ТестированиеБезЗаписи() Тогда
		Возврат;
	КонецЕсли;
	
	Если РегистраторыССохраняемымиДвижениями.Количество() = 0 Тогда
		Возврат;
	КонецЕсли;
	
	Запрос = Новый Запрос;
	Запрос.МенеджерВременныхТаблиц = МенеджерВременныхТаблиц;
	
	Запрос.Текст =
	"ВЫБРАТЬ
	|	*
	|ИЗ
	|	ВТСохраняемыеДвижения КАК Т
	|
	|УПОРЯДОЧИТЬ ПО
	|	Т.Регистратор,
	|	Т.НомерСтроки
	|";
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	Движения = МенеджерРегистра.СоздатьНаборЗаписей();
	Движения.ДополнительныеСвойства.Вставить(ИмяДополнительногоСвойстваЗаписываемогоНабора());
	
	Регистратор = Неопределено;
	Замещать = Ложь;
	
	Пока Выборка.Следующий() Цикл
		
		Если Регистратор <> Выборка.Регистратор Тогда
			
			Если Регистратор <> Неопределено Тогда
				Движения.Записать(Замещать);
			КонецЕсли;
			
			Регистратор = Выборка.Регистратор;
			Замещать = РегистраторыССохраняемымиДвижениями.Получить(Регистратор);
			
			Движения.Очистить();
			Движения.Отбор.Регистратор.Установить(Регистратор);
			
		КонецЕсли;
		
		Движение = Движения.Добавить();
		ЗаполнитьЗначенияСвойств(Движение, Выборка);
		
	КонецЦикла;
	
	Если Регистратор <> Неопределено Тогда
		Движения.Записать(Замещать);
	КонецЕсли;
	
КонецПроцедуры

//++ НЕ УТ

Процедура РегистраторыПрочиеРасходы(НачалоПериода, ОкончаниеПериода, МассивОрганизаций, Регистраторы)
	Запрос = Новый Запрос("
		|ВЫБРАТЬ
		|	ДД.Регистратор КАК Регистратор
		|ИЗ
		|	РегистрНакопления.ПрочиеРасходы КАК ДД
		|ГДЕ
		|	ДД.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
		|	И ДД.Организация В (&МассивОрганизаций)
		|	И ДД.Активность
		|	И ДД.Регистратор ССЫЛКА Документ.РаспределениеПрочихЗатрат
		|");
	Запрос.УстановитьПараметр("НачалоПериода", НачалоПериода);
	Запрос.УстановитьПараметр("ОкончаниеПериода", ОкончаниеПериода);
	Запрос.УстановитьПараметр("МассивОрганизаций", МассивОрганизаций);	
	Выборка = Запрос.Выполнить().Выбрать();
	Пока Выборка.Следующий() Цикл
		Регистраторы.Вставить(Выборка.Регистратор, Истина);
	КонецЦикла;
КонецПроцедуры

Процедура ВернутьДокументыКОтражениюВРеглУчете(НачалоПериода, ОкончаниеПериода, МассивОрганизаций)
	
	МВТ = Новый МенеджерВременныхТаблиц;
	Запрос = Новый Запрос("
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	ДД.Регистратор КАК Документ,
	|	ДД.Организация КАК Организация,
	|	НАЧАЛОПЕРИОДА(Партии.Период, ДЕНЬ) КАК ДатаОтражения
	|ПОМЕСТИТЬ
	|	ДокументыКОтражению
	|ИЗ
	|	РегистрСведений.ОтражениеДокументовВРеглУчете КАК ДД
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ 
	|		РегистрНакопления.ПартииПрочихРасходов КАК Партии
	|	ПО 
	|		ДД.Регистратор = Партии.Регистратор
	|ГДЕ
	|	Партии.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
	|	И Партии.Организация В (&МассивОрганизаций)
	|	И Партии.Активность
	|	И Партии.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|	И Партии.СтатьяРасходов.ВариантРаспределенияРасходовРегл =
	|		ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаСебестоимостьТоваров)
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Документ,
	|	Организация
	|");
	Запрос.МенеджерВременныхТаблиц = МВТ;
	Запрос.УстановитьПараметр("НачалоПериода", НачалоПериода);
	Запрос.УстановитьПараметр("ОкончаниеПериода", ОкончаниеПериода);
	Запрос.УстановитьПараметр("МассивОрганизаций", МассивОрганизаций);
	Запрос.Выполнить();
	
	РеглУчетСервер.ВернутьДокументыКОтражению(МВТ);
	
КонецПроцедуры
//++ НЕ УТКА

Процедура ВернутьДокументыКОтражениюВМеждународномУчете(НачалоПериода, ОкончаниеПериода, МассивОрганизаций)
	
	МВТ = Новый МенеджерВременныхТаблиц;
	Запрос = Новый Запрос("
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	ДД.Период КАК Период,
	|	ДД.Регистратор КАК Документ,
	|	ДД.Организация КАК Организация,
	|	НАЧАЛОПЕРИОДА(Партии.Период, ДЕНЬ) КАК ДатаОтражения
	|ПОМЕСТИТЬ
	|	ДокументыКОтражению
	|ИЗ
	|	РегистрСведений.ОтражениеДокументовВМеждународномУчете КАК ДД
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ 
	|		РегистрНакопления.ПартииПрочихРасходов КАК Партии
	|	ПО 
	|		ДД.Регистратор = Партии.Регистратор
	|ГДЕ
	|	Партии.Период МЕЖДУ &НачалоПериода И &ОкончаниеПериода
	|	И Партии.Организация В (&МассивОрганизаций)
	|	И Партии.Активность
	|	И Партии.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|	И Партии.СтатьяРасходов.ВариантРаспределенияРасходовРегл =
	|		ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаСебестоимостьТоваров)
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Период,
	|	Документ,
	|	Организация,
	|	ДатаОтражения
	|");
	Запрос.МенеджерВременныхТаблиц = МВТ;
	Запрос.УстановитьПараметр("НачалоПериода", НачалоПериода);
	Запрос.УстановитьПараметр("ОкончаниеПериода", ОкончаниеПериода);
	Запрос.УстановитьПараметр("МассивОрганизаций", МассивОрганизаций);
	Запрос.Выполнить();
	
	МеждународныйУчетПроведениеСервер.ВернутьДокументыКОтражению(МВТ);
	
КонецПроцедуры
//-- НЕ УТКА

Процедура ВернутьДокументыСДвижениямиПоСебестоимостиКОтражениюВРеглУчете(МВТ)
	
	Запрос = Новый Запрос("
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	ДД.Регистратор КАК Документ,
	|	Регистраторы.Организация КАК Организация,
	|	НАЧАЛОПЕРИОДА(Регистраторы.Период, ДЕНЬ) КАК ДатаОтражения
	|ПОМЕСТИТЬ ДокументыКОтражению
	|ИЗ
	|	РегистрСведений.ОтражениеДокументовВРеглУчете КАК ДД
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТИзмененныеДокументыКОтражению КАК Регистраторы
	|		ПО Регистраторы.Регистратор = ДД.Регистратор
	|		И Регистраторы.Организация = ДД.Организация
	|ГДЕ
	|	ДД.Статус = ЗНАЧЕНИЕ(Перечисление.СтатусыОтраженияДокументовВРеглУчете.ОтраженоВРеглУчете)
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Документ,
	|	Организация
	|");
	Запрос.МенеджерВременныхТаблиц = МВТ;
	Запрос.Выполнить();
	
	РеглУчетСервер.ВернутьДокументыКОтражению(МВТ);
	
КонецПроцедуры

Процедура ВернутьДокументыРаспределенияРасходовПоБазеКОтражениюВРеглУчете(Знач Регистраторы)
	
	МВТ = Новый МенеджерВременныхТаблиц;
	Запрос = Новый Запрос("
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	ДД.Регистратор   КАК Документ,
	|	ДД.Организация  КАК Организация,
	|	ДД.ДатаОтражения КАК ДатаОтражения
	|ПОМЕСТИТЬ
	|	ДокументыКОтражению
	|ИЗ
	|	РегистрСведений.ОтражениеДокументовВРеглУчете КАК ДД
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.РаспределениеПрочихЗатрат КАК Док
	|		ПО Док.Ссылка = ДД.Регистратор
	|ГДЕ
	|	ДД.Статус = ЗНАЧЕНИЕ(Перечисление.СтатусыОтраженияДокументовВРеглУчете.ОтраженоВРеглУчете)
	|	И ДД.Регистратор В (&Регистраторы)
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Документ,
	|	Организация
	|");
	
	Массив = Новый Массив;
	
	Если ТипЗнч(Регистраторы) = Тип("ТаблицаЗначений") Тогда
		Массив = Регистраторы.ВыгрузитьКолонку("Регистратор");
	ИначеЕсли ТипЗнч(Регистраторы) = Тип("Соответствие") Тогда
		Для Каждого Строка Из Регистраторы Цикл
			Массив.Добавить(Строка.Ключ);
		КонецЦикла;
	КонецЕсли;
	
	Запрос.МенеджерВременныхТаблиц = МВТ;
	Запрос.УстановитьПараметр("Регистраторы", Массив);
	Запрос.Выполнить();
	
	РеглУчетСервер.ВернутьДокументыКОтражению(МВТ);
	
КонецПроцедуры
//-- НЕ УТ

Функция ЕстьФИФОСкользящая(НачалоПериода, ОкончаниеПериода, МассивОрганизаций)
	
	Запрос = Новый Запрос;
	Запрос.МенеджерВременныхТаблиц = Новый МенеджерВременныхТаблиц;
	НастройкиНалоговУчетныхПолитик.ДополнитьМенеджерВременныхТаблицДействующимиПараметрамиНалоговУчетныхПолитик(
		Метаданные.РегистрыСведений.УчетнаяПолитикаФинансовогоУчета.Имя,
		Запрос.МенеджерВременныхТаблиц,
		НачалоПериода,
		"ВТУчетнаяПолитикаФинансовогоУчета",
		МассивОрганизаций);
		
	Запрос.Текст =
	"ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	ДД.МетодОценкиСтоимостиТоваров
	|ИЗ
	|	ВТУчетнаяПолитикаФинансовогоУчета КАК ДД
	|ГДЕ
	|	ДД.МетодОценкиСтоимостиТоваров = ЗНАЧЕНИЕ(Перечисление.МетодыОценкиСтоимостиТоваров.ФИФОСкользящаяОценка)
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ ПЕРВЫЕ 1
	|	Расчет.Ссылка.МетодОценки
	|ИЗ
	|	Документ.РасчетСебестоимостиТоваров.Организации КАК Расчет
	|ГДЕ
	|	Расчет.Ссылка.Дата МЕЖДУ &НачалоПериода И &ОкончаниеПериода
	|	И Расчет.Организация В (&МассивОрганизаций)
	|	И Расчет.Ссылка.МетодОценки = ЗНАЧЕНИЕ(Перечисление.МетодыОценкиСтоимостиТоваров.ФИФОСкользящаяОценка)
	|	И Расчет.Ссылка.Проведен";
	
	Запрос.УстановитьПараметр("НачалоПериода",     НачалоПериода);
	Запрос.УстановитьПараметр("ОкончаниеПериода",  ОкончаниеПериода);
	Запрос.УстановитьПараметр("МассивОрганизаций", МассивОрганизаций);	
	
	Результат = Запрос.Выполнить();
	
	Возврат НЕ Результат.Пустой();
	
КонецФункции

Функция ИмяДополнительногоСвойстваЗаписываемогоНабора()
	Возврат "ПартионныйУчет_ЗаписьПартии";
КонецФункции

Процедура ВременнаяТаблицаДанныхПоОтбору(ПолеОтбора, ТекстСортировка, Таблица, МВТ)
	
	// Подготовим необходимые параметры расчета (аналогично параметрам партионного учета версии 2.2).
	ПараметрыРасчета = Новый Структура;
	ПараметрыРасчета.Вставить("МенеджерВременныхТаблиц", МВТ);
	ПараметрыРасчета.Вставить("ОграниченияВыборки", Новый Структура);
	ПараметрыРасчета.ОграниченияВыборки.Вставить("КоличествоСтрокВТЗ", 100000);
	
	// Подготовим параметры нумерации.
	ТекстСортировка = СтрЗаменить(ТекстСортировка, "	", " ");
	ТекстСортировка = СтрЗаменить(ТекстСортировка, Символы.ПС, " ");
	ТекстСортировка = СтрЗаменить(НРег(ТекстСортировка), "упорядочить по", "");
	
	ПараметрыНумерации = РасчетСебестоимостиПрикладныеАлгоритмы.СформироватьПараметрыНумерацииСтрокВременнойТаблицы(
		ПолеОтбора, // разделитель
		"", // ресурсы
		СокрЛП(ТекстСортировка)); // порядок
	
	// Выполним нумерацию строк.
	РасчетСебестоимостиПрикладныеАлгоритмы.ЗаполнитьНомераСтрокВременнойТаблицы(
		ПараметрыРасчета,
		ПараметрыНумерации,
		"ИсходныеДанные",
		"Данные");
	
КонецПроцедуры

Функция КоличествоЗаписей(МВТ)
	Запрос = Новый Запрос("
	|ВЫБРАТЬ
	|	КОЛИЧЕСТВО(РАЗЛИЧНЫЕ ДД.К) КАК Количество
	|ИЗ
	|	Данные КАК ДД
	|");
	Запрос.МенеджерВременныхТаблиц = МВТ;
	Выборка = Запрос.Выполнить().Выбрать();
	Если Выборка.Следующий() Тогда
		Количество = Выборка.Количество;
	Иначе
		Количество = 0;
	КонецЕсли;
	Возврат Количество;
КонецФункции

Функция КоличествоСвязейМеждуЗаписями(МВТ)
	
	Запрос = Новый Запрос;
	Запрос.Текст =
	"ВЫБРАТЬ
	|	КОЛИЧЕСТВО(*) КАК Количество
	|ИЗ
	|	Источники КАК ДД // в таблице Приемники такое же количество записей
	|";
	Запрос.МенеджерВременныхТаблиц = МВТ;
	
	Выборка = Запрос.Выполнить().Выбрать();
	Если Выборка.Следующий() Тогда
		Количество = Выборка.Количество;
	Иначе
		Количество = 0;
	КонецЕсли;
	
	Возврат Количество;
	
КонецФункции

////////////////////////////////////////////////////////////////////////////////
// Распределение приходов на расходы

// Основной расчетный метод - заполняет расчетные партии из данных для расчета
// Поля прямого обращения: ТипЗаписи, ВидДвижения, Регистратор
// Обращения к остальным полям происходит через структуру ОписаниеДвижений.
Процедура РаспределитьПриходыНаРасходы(ОписаниеДвижений, ДанныеДляРасчета, РасчетныеПартии)
	ПредыдущееДвижение = Неопределено;
	ИнвертироватьПоказатели = Ложь;
	// Буфер партий по аналитике - очередь копий партионных движений
	Приходы = Новый Структура("Очередь, Указатель, УказательРестарта", Новый Массив, 0, -1);
	// Буфер потреблений по аналитике - очередь копий движений потребления
	Расходы = Новый Структура("Очередь, Указатель, УказательРестарта", Новый Массив, 0, -1);
	
	Для Каждого Движение Из ДанныеДляРасчета Цикл
		// сменилась аналитика
		Если Не ПоляЗаписейРавны(ПредыдущееДвижение, Движение, ОписаниеДвижений.КлючиСравнения) Тогда
			// сбрасываем оставшийся буфер потреблений (партии не подобраны) в расчетные партии
			Расходы.Указатель = ?(Расходы.УказательРестарта > 0, Расходы.УказательРестарта, Расходы.Указатель);
			Пока Расходы.Указатель < Расходы.Очередь.Количество() Цикл
				Расход = Расходы.Очередь[Расходы.Указатель];
				Если Расход[ОписаниеДвижений.БазисРасхода] > 0 Тогда
					// перемещения, что приведет к очистке документа поступления у перемещения.
					Распределение = РасчетныеПартии.Добавить();
					ЗаполнитьРасчетнуюПартию(ОписаниеДвижений.Контекст, Распределение, Расход, Неопределено);
					ИнвертироватьПоказатели(Распределение, ОписаниеДвижений.Показатели, ИнвертироватьПоказатели);
				КонецЕсли;
				Расходы.Указатель = Расходы.Указатель + 1;
			КонецЦикла;
			// инициализируемся
			ПредыдущееДвижение = Движение;
			Приходы.Очередь.Очистить();
			Приходы.Указатель = 0;
			Приходы.УказательРестарта = -1;
			Расходы.Очередь.Очистить();
			Расходы.Указатель = 0;
			Расходы.УказательРестарта = -1;
		КонецЕсли;
		
		ЭтоПриход = ("Остаток" = Движение.ТипЗаписи) Или ("Партия" = Движение.ТипЗаписи)
			Или ("Перемещение" = Движение.ТипЗаписи) Или ("Сторно" = Движение.ТипЗаписи);
		ИнвертироватьПоказатели = ЭтоПриход И Движение[ОписаниеДвижений.БазисПрихода] < 0
			Или НЕ ЭтоПриход И Движение[ОписаниеДвижений.БазисРасхода] < 0;
		
		Если ЭтоПриход Тогда
			Приход = КопияЗаписиСтруктурой(Движение, ОписаниеДвижений.ПоляРасчета);
			ИнвертироватьПоказатели(Приход, ОписаниеДвижений.Показатели, ИнвертироватьПоказатели);
			// если ранее пропустили расход, то текущий приход начинаем распределять на него
			Если Расходы.УказательРестарта >= 0 Тогда
				Расходы.Указатель = Расходы.УказательРестарта;
				Расходы.УказательРестарта = -1;
			КонецЕсли;
			// покрываем расходы из буфера расходов по очереди (FIFO)
			Пока Приход[ОписаниеДвижений.БазисПрихода] > 0 И Расходы.Указатель < Расходы.Очередь.Количество() Цикл
				Расход = Расходы.Очередь[Расходы.Указатель];
				// приход, сделанный по расходу не может быть распределен на этот расход
				Если Расход.Регистратор = Приход[ОписаниеДвижений.КлючРасхода] Тогда
					Расходы.УказательРестарта = Расходы.Указатель;
					Расходы.Указатель = Расходы.Указатель + 1;
					Продолжить;
				КонецЕсли;
				// добавляем в партии покрытую часть расхода
				Если Расход[ОписаниеДвижений.БазисРасхода] > 0 Тогда
					Распределение = РасчетныеПартии.Добавить();
					ЗаполнитьРасчетнуюПартию(ОписаниеДвижений.Контекст, Распределение, Расход, Приход);
					ИнвертироватьПоказатели(Распределение, ОписаниеДвижений.Показатели, ИнвертироватьПоказатели);
				КонецЕсли;
				// если расход покрыт, то ставим на покрытие следующий расход
				Если Расход[ОписаниеДвижений.БазисРасхода] <= 0 Тогда
					Расходы.Указатель = Расходы.Указатель + 1;
				КонецЕсли;
			КонецЦикла;
			// если приход еще остался, то регистрируемся в буфере приходов
			Если Приход[ОписаниеДвижений.БазисПрихода] > 0 Тогда
				Приходы.Очередь.Добавить(Приход);
			КонецЕсли;
			// приход надо добавить в партии - код должен быть здесь для сохранения сортировки
			Если "Остаток" <> Движение.ТипЗаписи Тогда
				Распределение = РасчетныеПартии.Добавить();
				ЗаполнитьРасчетнуюПартию(ОписаниеДвижений.Контекст, Распределение, Движение, Неопределено);
				ИнвертироватьПоказатели(Распределение, ОписаниеДвижений.Показатели, ИнвертироватьПоказатели);
			КонецЕсли;
		КонецЕсли;
		
		Если "Потребление" = Движение.ТипЗаписи Тогда
			Расход = КопияЗаписиСтруктурой(Движение, ОписаниеДвижений.ПоляРасчета);
			ИнвертироватьПоказатели(Расход, ОписаниеДвижений.Показатели, ИнвертироватьПоказатели);
			// если ранее пропустили приход, то текущий расход начинаем потреблять с него
			Если Приходы.УказательРестарта >= 0 Тогда
				Приходы.Указатель = Приходы.УказательРестарта;
				Приходы.УказательРестарта = -1;
			КонецЕсли;
			// списываем приходы из буфера приходов по очереди (FIFO)
			Пока Расход[ОписаниеДвижений.БазисРасхода] > 0 И Приходы.Указатель < Приходы.Очередь.Количество() Цикл
				Приход = Приходы.Очередь[Приходы.Указатель];
				// приход, сделанный по расходу не может быть распределен на этот расход
				Если Расход.Регистратор = Приход[ОписаниеДвижений.КлючРасхода] Тогда
					Приходы.УказательРестарта = Приходы.Указатель;
					Приходы.Указатель = Приходы.Указатель + 1;
					Продолжить;
				КонецЕсли;
				// добавляем в партии покрытую часть расхода
				Если Приход[ОписаниеДвижений.БазисПрихода] > 0 Тогда
					Распределение = РасчетныеПартии.Добавить();
					ЗаполнитьРасчетнуюПартию(ОписаниеДвижений.Контекст, Распределение, Расход, Приход);
					ИнвертироватьПоказатели(Распределение, ОписаниеДвижений.Показатели, ИнвертироватьПоказатели);
				КонецЕсли;
				// если приход потреблен, то выбираем следующий приход
				Если Приход[ОписаниеДвижений.БазисПрихода] <= 0 Тогда
					Приходы.Указатель = Приходы.Указатель + 1;
				КонецЕсли;
			КонецЦикла;
			// если расход еще остался, то регистрируемся в буфере расходов
			Если Расход[ОписаниеДвижений.БазисРасхода] > 0 Тогда
				Расходы.Очередь.Добавить(Расход);
			КонецЕсли;
		КонецЕсли;
		
	КонецЦикла;
КонецПроцедуры

Функция ОписаниеДвижений(Контекст, ИмяРегистра, ПоляРасчета, КлючиСравнения, Показатели,
						 БазисПрихода, БазисРасхода, КлючРасхода, ПолеПорядка, ПоляСортировки = "", СортировкаПоУсловию = "")
			
	Результат = Новый Структура;
	
	Результат.Вставить("Контекст", 			  		Контекст);
	Результат.Вставить("ИмяРегистра", 		  		ИмяРегистра);
	Результат.Вставить("ПоляРасчета", 		 	 	ПоляРасчета);
	Результат.Вставить("КлючиСравнения", 	  		КлючиСравнения);
	Результат.Вставить("Показатели", 		  		Показатели);
	Результат.Вставить("БазисПрихода", 		  		БазисПрихода);
	Результат.Вставить("БазисРасхода", 		  		БазисРасхода);
	Результат.Вставить("КлючРасхода", 		  		КлючРасхода);
	Результат.Вставить("ПолеПорядка", 		  		ПолеПорядка);
	Результат.Вставить("ПоляСортировки", 	  		ПоляСортировки);
	Результат.Вставить("СортировкаПоУсловию", 		СортировкаПоУсловию);
	
	Возврат Результат;
	
КонецФункции

////////////////////////////////////////////////////////////////////////////////
// Построение цепочек движений для проброса партий

Функция ОписаниеЦепочек(ПереченьТиповЗаписей)
	ОписаниеЦепочек = Новый Структура(ПереченьТиповЗаписей);
	Для Каждого Описание Из ОписаниеЦепочек Цикл
		ОписаниеЦепочек[Описание.Ключ] = Новый Структура("ПоляСвязи, ТипыПриемников, ТипыИсточников");
		ОписаниеЦепочек[Описание.Ключ].ПоляСвязи = Новый Массив;
		ОписаниеЦепочек[Описание.Ключ].ТипыПриемников = Новый Соответствие;
		ОписаниеЦепочек[Описание.Ключ].ТипыИсточников = Новый Соответствие;
	КонецЦикла;
	Возврат ОписаниеЦепочек;
КонецФункции

Процедура ДобавитьОписаниеПриемника(ОписаниеЦепочек, ТипПриемника, ПоляПриемника)
	Для Каждого ОписаниеПоля Из Новый Структура(ПоляПриемника) Цикл
		ОписаниеЦепочек[ТипПриемника].ПоляСвязи.Добавить(ОписаниеПоля.Ключ);
	КонецЦикла;
КонецПроцедуры

Процедура ДобавитьОписаниеИсточника(ОписаниеЦепочек, ТипПриемника, ТипИсточника, ПоляИсточника)
	ПоляСвязи = Новый Массив;
	Для Каждого ОписаниеПоля Из Новый Структура(ПоляИсточника) Цикл
		ПоляСвязи.Добавить(ОписаниеПоля.Ключ);
	КонецЦикла;
	ОписаниеЦепочек[ТипИсточника].ТипыПриемников.Вставить(ТипПриемника, ПоляСвязи);
	ОписаниеЦепочек[ТипПриемника].ТипыИсточников.Вставить(ТипИсточника, ПоляСвязи);
КонецПроцедуры

// Ждем, что источников будем менее десятка и они будут почти всегда уже упорядочены, поэтому делаем сортировку вставками.
Процедура СортироватьИсточники(Источники, ПолеПорядка, РасчетныеПартии)
	Для НомерИсточника1 = 1 По Источники.ВГраница() Цикл
		Если Неопределено = РасчетныеПартии[Источники[НомерИсточника1]] Тогда
			Продолжить;
		КонецЕсли;
		Если ТипЗнч(РасчетныеПартии[Источники[НомерИсточника1]]) = Тип("Массив") Тогда
			Если РасчетныеПартии[Источники[НомерИсточника1]].Количество() = 0 Тогда
				Продолжить;
			КонецЕсли;
			ИсточникУ = РасчетныеПартии[Источники[НомерИсточника1]][0];
		Иначе
			ИсточникУ = РасчетныеПартии[Источники[НомерИсточника1]];
		КонецЕсли;
		Элемент = Новый Структура("Порядок, Источник", ИсточникУ[ПолеПорядка], Источники[НомерИсточника1]);
		НомерИсточника2 = НомерИсточника1 - 1;
		Пока НомерИсточника2 >= 0 Цикл
			Если ТипЗнч(РасчетныеПартии[Источники[НомерИсточника2]]) = Тип("Массив") Тогда
				Если РасчетныеПартии[Источники[НомерИсточника2]].Количество() = 0 Тогда
					НомерИсточника2 = НомерИсточника2 - 1;
					Продолжить;
				КонецЕсли;
				ИсточникХ = РасчетныеПартии[Источники[НомерИсточника2]][0];
			Иначе
				ИсточникХ = РасчетныеПартии[Источники[НомерИсточника2]];
			КонецЕсли;
			Если Неопределено = ИсточникХ Тогда
				НомерИсточника2 = НомерИсточника2 - 1;
				Продолжить;
			КонецЕсли;
			Если ИсточникХ[ПолеПорядка] <= Элемент.Порядок Тогда
				Прервать;
			КонецЕсли;
			Источники[НомерИсточника2 + 1] = Источники[НомерИсточника2];
			НомерИсточника2 = НомерИсточника2 - 1;
		КонецЦикла;
		Источники[НомерИсточника2 + 1] = Элемент.Источник;
	КонецЦикла;
КонецПроцедуры

Процедура СортироватьПриходыПоЛИФО(ПолеПорядка, МассивПриходов)
	Список = Новый СписокЗначений;
	Для Каждого Приход Из МассивПриходов Цикл
		Список.Добавить(Приход, Приход[ПолеПорядка]);
	КонецЦикла;
	Список.СортироватьПоПредставлению(НаправлениеСортировки.Убыв);
	МассивПриходов = Список.ВыгрузитьЗначения();
КонецПроцедуры

Процедура СортироватьИсточникиПоЗначениямПолей(Источники, ЗначенияПолей, Приходы)
	
	Список = Новый СписокЗначений;
	ИндексЭлементаМассива = -1;
	
	Для Каждого ИндексИсточника Из Источники Цикл
		
		ИндексЭлементаМассива = ИндексЭлементаМассива + 1;
		МассивПриходов = Приходы[ИндексИсточника];
		
		Если МассивПриходов = Неопределено ИЛИ МассивПриходов.Количество() = 0 Тогда
			Сдвиг = 0;
		Иначе
			Сдвиг = ЗначенияПолей.Количество();
			Для Каждого ПолеСортировки Из ЗначенияПолей Цикл
				Если МассивПриходов[0][ПолеСортировки.Ключ] = ПолеСортировки.Значение Тогда
					Сдвиг = Сдвиг - 1;
				КонецЕсли;
			КонецЦикла;
		КонецЕсли;
		
		Список.Добавить(ИндексИсточника, Формат(ИндексЭлементаМассива + Сдвиг * Источники.Количество(), "ЧЦ=15; ЧДЦ=; ЧВН=; ЧГ="));
		
	КонецЦикла;
	
	Если Список.Количество() > 0 Тогда
		Список.СортироватьПоПредставлению(НаправлениеСортировки.Возр);
		Источники = Список.ВыгрузитьЗначения();
	КонецЕсли;
	
КонецПроцедуры

Функция ТребуетсяСортировка(Контекст, Расход)
	ТребуетсяСортировка = Истина;
	Если Контекст = "ПартииТоваровОрганизаций" Тогда
		ТребуетсяСортировка = (ТипЗнч(Расход.Регистратор) = Тип("ДокументСсылка.ТаможеннаяДекларацияИмпорт") И Расход.ТипЗаписи = "Потребление")
			ИЛИ (ТипЗнч(Расход.Регистратор) = Тип("ДокументСсылка.ВозвратТоваровПоставщику") И Расход.ТипЗаписи = "Потребление");
	КонецЕсли;
	Возврат ТребуетсяСортировка;
КонецФункции

////////////////////////////////////////////////////////////////////////////////
// Построение цепочек движений с помощью запроса

Процедура ЦепочкиДвижений(ОписаниеЦепочек, МВТ)
	ШаблонЗапроса = "
	|ВЫБРАТЬ
	|	Приемники.К КАК Приемник,
	|	Источники.К КАК Источник
	|ПОМЕСТИТЬ
	|	&Результат
	|ИЗ
	|	Данные КАК Приемники
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Данные КАК Источники
	|		ПО &Условия
	|ГДЕ
	|	Приемники.К <> Источники.К
	|	И Приемники.ТипЗаписи = &ТипПриемника
	|	И Источники.ТипЗаписи = &ТипИсточника
	|;
	|";
	ТекстЗапроса = "";
	Результаты = Новый Массив;
	Для Каждого Описание Из ОписаниеЦепочек Цикл
		ПоляПриемника = Описание.Значение.ПоляСвязи;
		Если ПоляПриемника.Количество() = 0 Тогда
			Продолжить;
		КонецЕсли;
		Для Каждого ОписаниеИсточника Из Описание.Значение.ТипыИсточников Цикл
			ПоляИсточника = ОписаниеИсточника.Значение;
			Если ПоляИсточника.Количество() = 0 Тогда
				Продолжить;
			КонецЕсли;
			НомерПоля = -1;
			Для Каждого ПолеПриемника Из ПоляПриемника Цикл
				НомерПоля = НомерПоля + 1;
				Если НомерПоля = 0 Тогда
					Условия = "Приемники." + ПолеПриемника + " = " + "Источники." + ПоляИсточника[НомерПоля];
				Иначе
					Условия = Условия + Символы.ПС + " И " + "Приемники." + ПолеПриемника + " = " + "Источники." + ПоляИсточника[НомерПоля];
				КонецЕсли;
			КонецЦикла;
			ТекстЗапроса = СтрЗаменить(ШаблонЗапроса, "&Результат", Описание.Ключ + ОписаниеИсточника.Ключ);
			ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "&Условия", Условия);
			Результаты.Добавить(Описание.Ключ + ОписаниеИсточника.Ключ);
			Запрос = Новый Запрос(ТекстЗапроса);
			Запрос.МенеджерВременныхТаблиц = МВТ;
			Запрос.УстановитьПараметр("ТипПриемника", Описание.Ключ);
			Запрос.УстановитьПараметр("ТипИсточника", ОписаниеИсточника.Ключ);
			Запрос.Выполнить();
		КонецЦикла;
	КонецЦикла;
	
	ТекстЗапроса = "
	|ВЫБРАТЬ ПЕРВЫЕ 0
	|	-1 КАК Приемник,
	|	-1 КАК Источник
	|ПОМЕСТИТЬ
	|	Цепочки
	|";
	ШаблонЗапроса = "
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|ВЫБРАТЬ
	|	ДД.Приемник,
	|	ДД.Источник
	|ИЗ
	|	&ИмяТаблицы КАК ДД
	|";
	Для Каждого Результат Из Результаты Цикл
		ТекстЗапроса = ТекстЗапроса + СтрЗаменить(ШаблонЗапроса, "&ИмяТаблицы", Результат);
	КонецЦикла;
	ТекстЗапроса = ТекстЗапроса + ";";
	Для Каждого Результат Из Результаты Цикл
		ТекстЗапроса = ТекстЗапроса + "УНИЧТОЖИТЬ " + Результат + ";";
	КонецЦикла;
	
	Запрос = Новый Запрос(ТекстЗапроса);
	Запрос.МенеджерВременныхТаблиц = МВТ;
	Запрос.Выполнить();
	
	Запрос.Текст =
	"ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	ДД.Приемник КАК Ключ,
	|	ДД.Источник КАК Источник,
	|	0 			КАК Порядок
	|ПОМЕСТИТЬ Источники
	|ИЗ
	|	Цепочки КАК ДД
	|ИНДЕКСИРОВАТЬ ПО
	|	Ключ
	|;
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	ДД.Источник КАК Ключ,
	|	ДД.Приемник	КАК Приемник,
	|	0 			КАК Порядок
	|ПОМЕСТИТЬ Приемники
	|ИЗ
	|	Цепочки КАК ДД
	|ИНДЕКСИРОВАТЬ ПО
	|	Ключ
	|;
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ Цепочки
	|";
	
	Запрос.Выполнить();
	
	ОптимизироватьНумерациюВЦепочках(МВТ);
	
КонецПроцедуры

Процедура ОптимизироватьНумерациюВЦепочках(МенеджерВременныхТаблиц)
	
	РазмерТаблицыДанных = РасчетСебестоимостиПрикладныеАлгоритмы.РазмерВременнойТаблицы(МенеджерВременныхТаблиц, "Данные");
	
	Если РазмерТаблицыДанных = 0 Тогда
		Возврат;
	КонецЕсли;
	
	#Область Инициализация
	
	НачалоЗамера = ТекущаяУниверсальнаяДатаВМиллисекундах();
	
	// Подготовим необходимые параметры расчета (аналогично параметрам партионного учета версии 2.2).
	ПараметрыРасчета = Новый Структура;
	ПараметрыРасчета.Вставить("МенеджерВременныхТаблиц", МенеджерВременныхТаблиц);
	ПараметрыРасчета.Вставить("ОграниченияВыборки", Новый Структура);
	ПараметрыРасчета.ОграниченияВыборки.Вставить("КоличествоСтрокВТЗ", 100000);
	
	Запрос = Новый Запрос;
	Запрос.МенеджерВременныхТаблиц = ПараметрыРасчета.МенеджерВременныхТаблиц;
	
	Запрос.УстановитьПараметр("РазмерТаблицыДанных", РазмерТаблицыДанных);
	Запрос.УстановитьПараметр("КоличествоСтрокВТЗ",  ПараметрыРасчета.ОграниченияВыборки.КоличествоСтрокВТЗ);
	
	// Получим описание структуры временной таблицы Данные.
	Запрос.Текст =
	"ВЫБРАТЬ ПЕРВЫЕ 0
	|	*
	|ИЗ
	|	Данные КАК Т";
	
	ПустаяТаблицаДанных    = Запрос.Выполнить().Выгрузить();
	КолонкиТаблицыДанных   = ПустаяТаблицаДанных.Колонки;
	
	ЕстьПериодПоступленияВДанных = (КолонкиТаблицыДанных.Найти("ПериодПоступления") <> Неопределено);
	ЕстьПериодВДанных 	   		 = (КолонкиТаблицыДанных.Найти("Период") <> Неопределено);
	ЕстьРегистраторВДанных 		 = (КолонкиТаблицыДанных.Найти("Регистратор") <> Неопределено);
	
	ИменаКолонокТаблицыДанные = "";
	Для Каждого ТекущаяКолонка Из КолонкиТаблицыДанных Цикл
		
		ИмяКолонки = ?(ТекущаяКолонка.Имя = "К", "НовыеНомера.НовыйНомерУзла КАК К", "Т." + ТекущаяКолонка.Имя);
		
		ИменаКолонокТаблицыДанные = ИменаКолонокТаблицыДанные + ?(ИменаКолонокТаблицыДанные = "", "", ",
			|	") + ИмяКолонки;
		
	КонецЦикла;
	
	#КонецОбласти
	
	#Область Упорядочивание
	
	// Подготовим данные для упорядочивания записей.
	// Упорядочивание выполняется по полям ПериодПоступления, Период, Регистратор
	// Упорядочивание используется для сортировки узлов одной волны подграфа и для сортировки источников и приемников узла.
	
	Запрос.Текст =
	"ВЫБРАТЬ
	|	Т.К КАК НомерУзла,
	|	%1 КАК ПериодПоступления,
	|	%2 КАК Период,
	|	%3 КАК Регистратор
	|ПОМЕСТИТЬ ВТДанныеДляУпорядочивания
	|ИЗ
	|	Данные КАК Т
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	ПериодПоступления,
	|	Период,
	|	Регистратор";
	
	Запрос.Текст = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
		Запрос.Текст,
		?(ЕстьПериодПоступленияВДанных, "ЕСТЬNULL(Т.ПериодПоступления, ДАТАВРЕМЯ(1,1,1))", "ДАТАВРЕМЯ(1,1,1)"),
		?(ЕстьПериодВДанных, "ЕСТЬNULL(Т.Период, ДАТАВРЕМЯ(1,1,1))", "ДАТАВРЕМЯ(1,1,1)"),
		?(ЕстьРегистраторВДанных, "ЕСТЬNULL(Т.Регистратор, НЕОПРЕДЕЛЕНО)", "ДАТАВРЕМЯ(1,1,1)"));
	
	Запрос.Выполнить(); // создание ВТДанныеДляУпорядочивания
	
	Запрос.Текст =
	"ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	%1 КАК ЗначениеРазделителя,
	|	Т.ПериодПоступления КАК ПериодПоступления,
	|	Т.Период КАК Период,
	|	Т.Регистратор КАК Регистратор
	|ПОМЕСТИТЬ ВТПоляУпорядочивания
	|ИЗ
	|	ВТДанныеДляУпорядочивания КАК Т
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	ПериодПоступления,
	|	Период,
	|	Регистратор";
	
	Запрос.Текст = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
		Запрос.Текст,
		?(ЕстьПериодПоступленияВДанных,
			"НАЧАЛОПЕРИОДА(Т.ПериодПоступления, ДЕНЬ)",
			?(ЕстьПериодВДанных,
				"НАЧАЛОПЕРИОДА(Т.Период, ДЕНЬ)",
				"1")));
	
	Запрос.Выполнить(); // создание ВТПоляУпорядочивания
	
	ПараметрыНумерации = РасчетСебестоимостиПрикладныеАлгоритмы.СформироватьПараметрыНумерацииСтрокВременнойТаблицы(
		"ЗначениеРазделителя", // разделитель
		"", // ресурсы
		"ПериодПоступления, Период, Регистратор", // порядок
		"Порядок", // номер
		"ПериодПоступления, Период, Регистратор", // индекс
		"", // накопление
		Ложь); // не подбирать разделитель
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ЗаполнитьНомераСтрокВременнойТаблицы(
		ПараметрыРасчета,
		ПараметрыНумерации,
		"ВТПоляУпорядочивания");
	
	Запрос.Текст =
	"ВЫБРАТЬ
	|	Т.НомерУзла 			   КАК НомерУзла,
	|	ПоляУпорядочивания.Порядок КАК Порядок
	|ПОМЕСТИТЬ ВТПорядокУзлов
	|ИЗ
	|	ВТДанныеДляУпорядочивания КАК Т
	|   ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТПоляУпорядочивания КАК ПоляУпорядочивания
	|		ПО Т.ПериодПоступления = ПоляУпорядочивания.ПериодПоступления
	|		 И Т.Период = ПоляУпорядочивания.Период
	|		 И Т.Регистратор = ПоляУпорядочивания.Регистратор
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	НомерУзла";
	
	Запрос.Выполнить(); // создание ВТПорядокУзлов
	
	РасчетСебестоимостиПрикладныеАлгоритмы.УничтожитьВременныеТаблицы(ПараметрыРасчета,
		"ВТДанныеДляУпорядочивания, ВТПоляУпорядочивания");
		
	#КонецОбласти
	
	#Область РазбиениеГрафаНаПодграфы
	
	// Выполним разбиение исходного графа данных на несвязанные между собой подграфы.
	// Каждый найденный подграф будет пронумерован от 0 до (количество подграфов - 1) в порядку убывания количества узлов в подграфе.
	// Т.е. подграф с номером 0 будет самым большим, а последние подграфы будут вырожденные (содержат по одному узлу).
	//
	// Разбиение выполняем следующим образов:
	// - для начала каждой вершине присваиваем номер подграфа, равный номеру самой вершины
	// - для каждой вершины i определяем номера подграфов всех ее источников и приемников
	// - если минимальный номер подграфов связанных вершин меньше, чем номер подграфа самой вершины i,
	//	 то присваиваем вершине i этот минимальный номер подграфа
	// - повторяем в цикле действия 2 и 3 до тех пор, пока на очередной итерации ни у одной вершины не изменится номер ее подграфа.
	// Т.е. минимальный номер вершины в каждом подграфе как-бы начинает "расползаться" по этому подграфу - от этой вершины
	// сначала "переходит" на смежные вершины, потом на их смежные вершины и т.д, пока не "займет" весь подграф.
	// В результате каждый подграф будет иметь свой уникальный номер, равный номеру минимальной вершины, входящий в него.
	// Затем сделаем сквозную нумерацию этих подграфов (как написано выше).
	// Например, есть исходный граф ((4-2-1-7) (6) (5-3)):
	// - найдем в нем три подграфа с условными номерами 1, 6 и 3
	// - затем присвоим им номера 0, 2 и 1 соответственно.
	
	Запрос.Текст =
	"ВЫБРАТЬ
	|	Т.К КАК НомерУзла,
	|	Т.К КАК НомерПодграфа
	|ПОМЕСТИТЬ ВТУзлыПодграфов
	|ИЗ
	|	Данные КАК Т
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	НомерУзла
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Т.Ключ КАК НомерУзла,
	|	Т.Источник КАК СвязанныйУзел,
	|	ИСТИНА КАК ЭтоИсточник
	|ПОМЕСТИТЬ ВТСвязиУзлов
	|ИЗ
	|	Источники КАК Т
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	Т.Ключ,
	|	Т.Приемник,
	|	ЛОЖЬ
	|ИЗ
	|	Приемники КАК Т
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	СвязанныйУзел,
	|	ЭтоИсточник";
	
	Запрос.Выполнить(); // создание ВТУзлыПодграфов и ВТСвязиУзлов
	
	ЕстьИзменения 	   = Истина;
	КоличествоИтерацийПоискаПодграфов = 0;
	
	Пока ЕстьИзменения Цикл
		
		КоличествоИтерацийПоискаПодграфов = КоличествоИтерацийПоискаПодграфов + 1;
		
		Запрос.Текст =
		"ВЫБРАТЬ
		|	СвязиУзлов.НомерУзла КАК НомерУзла,
		|	МИНИМУМ(Т.НомерПодграфа) КАК НомерПодграфа
		|ПОМЕСТИТЬ ВТПодграфыСвязанныхУзлов
		|ИЗ
		|	ВТУзлыПодграфов КАК Т
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТСвязиУзлов КАК СвязиУзлов
		|		ПО Т.НомерУзла = СвязиУзлов.СвязанныйУзел
		|
		|СГРУППИРОВАТЬ ПО
		|	СвязиУзлов.НомерУзла
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	НомерУзла
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	Т.НомерУзла КАК НомерУзла,
		|	ПодграфыСвязанныхУзлов.НомерПодграфа КАК НомерПодграфа
		|ПОМЕСТИТЬ ВТИзмененныеПодграфы
		|ИЗ
		|	ВТУзлыПодграфов КАК Т
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТПодграфыСвязанныхУзлов КАК ПодграфыСвязанныхУзлов
		|		ПО Т.НомерУзла = ПодграфыСвязанныхУзлов.НомерУзла
		|ГДЕ
		|	ПодграфыСвязанныхУзлов.НомерПодграфа < Т.НомерПодграфа
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	НомерУзла
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ ВТПодграфыСвязанныхУзлов";
		
		Запрос.Выполнить(); // создание ВТИзмененныеПодграфы
		
		ЕстьИзменения = (РасчетСебестоимостиПрикладныеАлгоритмы.РазмерВременнойТаблицы(ПараметрыРасчета, "ВТИзмененныеПодграфы") > 0);
		
		Если ЕстьИзменения Тогда
			
			Запрос.Текст =
			"ВЫБРАТЬ
			|	Т.НомерУзла,
			|	ВЫБОР КОГДА ИзмененныеПодграфы.НомерУзла ЕСТЬ NULL 
			|		ТОГДА Т.НомерПодграфа
			|		ИНАЧЕ ИзмененныеПодграфы.НомерПодграфа
			|	КОНЕЦ КАК НомерПодграфа
			|ПОМЕСТИТЬ ВТНовыеУзлыПодграфов
			|ИЗ
			|	ВТУзлыПодграфов КАК Т
			|		ЛЕВОЕ СОЕДИНЕНИЕ ВТИзмененныеПодграфы КАК ИзмененныеПодграфы
			|		ПО Т.НомерУзла = ИзмененныеПодграфы.НомерУзла
			|;
			|
			|////////////////////////////////////////////////////////////////////////////////
			|УНИЧТОЖИТЬ ВТУзлыПодграфов
			|;
			|
			|////////////////////////////////////////////////////////////////////////////////
			|ВЫБРАТЬ
			|	Т.НомерУзла,
			|	Т.НомерПодграфа
			|ПОМЕСТИТЬ ВТУзлыПодграфов
			|ИЗ
			|	ВТНовыеУзлыПодграфов КАК Т
			|
			|ИНДЕКСИРОВАТЬ ПО
			|	НомерУзла
			|;
			|
			|////////////////////////////////////////////////////////////////////////////////
			|УНИЧТОЖИТЬ ВТНовыеУзлыПодграфов";
			
			Запрос.Выполнить(); // обновление ВТУзлыПодграфов
			
		КонецЕсли;
		
		РасчетСебестоимостиПрикладныеАлгоритмы.УничтожитьВременныеТаблицы(ПараметрыРасчета, "ВТИзмененныеПодграфы");
		
	КонецЦикла;
	
	Запрос.Текст =
	"ВЫБРАТЬ
	|	Т.НомерПодграфа КАК НомерПодграфа,
	|	СУММА(1) КАК КоличествоУзлов,
	|	СУММА(1) КАК НовыйНомерПервогоУзлаПодграфа
	|ПОМЕСТИТЬ ВТПодграфы
	|ИЗ
	|	ВТУзлыПодграфов КАК Т
	|
	|СГРУППИРОВАТЬ ПО
	|	Т.НомерПодграфа";
	
	Запрос.Выполнить(); // создание ВТПодграфы
	
	ПараметрыНумерации = РасчетСебестоимостиПрикладныеАлгоритмы.СформироватьПараметрыНумерацииСтрокВременнойТаблицы(
		"", // разделитель
		"", // ресурсы
		"КоличествоУзлов УБЫВ, НомерПодграфа", // порядок
		"НовыйНомерПодграфа", // номер
		"НомерПодграфа", // индекс
		"НовыйНомерПервогоУзлаПодграфа"); // накопление
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ЗаполнитьНомераСтрокВременнойТаблицы(
		ПараметрыРасчета,
		ПараметрыНумерации,
		"ВТПодграфы");
	
	#КонецОбласти
	
	#Область ВолновойОбходГрафа
	
	// Для того, чтобы пронумеровать вершины графа от начальных (не имеющих входов) до конечных (не имеющих выходов),
	// необходимо для каждой вершины определить ее "удаленность" от начальной вершины.
	// Вершины с меньшей "удаленностью" от начальных должны иметь меньшие номера чем вершины с большей "удаленность".
	// Т.е. цепочки графа должен иметь вид 1->2->3->4, а не 2->4->1->3.
	// При соблюдении этого условию механизм расчета партий по цепочкам будет работать наиболее оптимальным образом.
	//
	// Для расчета удаленности вершин используем волновой метод:
	// - начальным вершинам присваиваем номер волны 1
	// - вершинам, в которые есть путь из начальных вершин - номер волны 2
	// - и т.д., пока не достигнем конечных вершин.
	// Если после этого останутся вершины, которым не присвоен номер волны,
	// значит эти вершины образуют цикл, в который нет пути из начальных вершин.
	// Обрабатываем такие циклы следующим образом:
	// - выбираем произвольную вершину, принадлежащую этому циклу
	// - присваиваем ей очередной номер волны N и от нее продолжаем обход оставшихся вершин
	// В результате всем вершинам исходного графа будет присвоен некий номер волны.
	
	Запрос.Текст =
	"ВЫБРАТЬ
	|	Т.НомерУзла КАК НомерУзла,
	|	Т.КоличествоПриемников КАК КоличествоПриемников,
	|	Т.КоличествоИсточников КАК КоличествоИсточников,
	|	ВЫБОР
	|		КОГДА Т.КоличествоПриемников = 0 И Т.КоличествоИсточников = 0
	|			ТОГДА &РазмерТаблицыДанных
	|		КОГДА Т.КоличествоИсточников = 0
	|			ТОГДА 1
	|		ИНАЧЕ 0
	|	КОНЕЦ КАК НомерВолны
	|ПОМЕСТИТЬ ВТОписаниеУзлов
	|ИЗ
	|	(ВЫБРАТЬ
	|		Т.НомерУзла КАК НомерУзла,
	|		СУММА(Т.КоличествоПриемников) КАК КоличествоПриемников,
	|		СУММА(Т.КоличествоИсточников) КАК КоличествоИсточников
	|	ИЗ
	|		(ВЫБРАТЬ
	|			Т.НомерУзла КАК НомерУзла,
	|			КОЛИЧЕСТВО(РАЗЛИЧНЫЕ Приемники.Приемник) КАК КоличествоПриемников,
	|			0 КАК КоличествоИсточников
	|		ИЗ
	|			ВТУзлыПодграфов КАК Т
	|				ЛЕВОЕ СОЕДИНЕНИЕ Приемники КАК Приемники
	|				ПО Т.НомерУзла = Приемники.Ключ
	|		
	|		СГРУППИРОВАТЬ ПО
	|			Т.НомерУзла
	|		
	|		ОБЪЕДИНИТЬ ВСЕ
	|		
	|		ВЫБРАТЬ
	|			Т.НомерУзла,
	|			0,
	|			КОЛИЧЕСТВО(РАЗЛИЧНЫЕ Источники.Источник)
	|		ИЗ
	|			ВТУзлыПодграфов КАК Т
	|				ЛЕВОЕ СОЕДИНЕНИЕ Источники КАК Источники
	|				ПО Т.НомерУзла = Источники.Ключ
	|		
	|		СГРУППИРОВАТЬ ПО
	|			Т.НомерУзла) КАК Т
	|	
	|	СГРУППИРОВАТЬ ПО
	|		Т.НомерУзла) КАК Т
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	НомерУзла";
	
	Запрос.Выполнить(); // создание ВТОписаниеУзлов
	
	ЕстьИзменения 	    = Истина;
	НомерВолны    	    = 1;
	НомерВолныДляЦиклов = 0;
	
	Пока ЕстьИзменения Цикл
		
		НомерВолны = НомерВолны + 1;
		Запрос.УстановитьПараметр("НомерВолны", НомерВолны);
		
		Запрос.Текст =
		"ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	Приемники.Приемник КАК НомерУзла
		|ПОМЕСТИТЬ ВТИзменениеОписанияУзлов
		|ИЗ
		|	ВТОписаниеУзлов КАК Т
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Приемники КАК Приемники
		|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТОписаниеУзлов КАК ОписаниеУзловПриемников
		|			ПО Приемники.Приемник = ОписаниеУзловПриемников.НомерУзла
		|				И (ОписаниеУзловПриемников.НомерВолны = 0)
		|		ПО Т.НомерУзла = Приемники.Ключ
		|ГДЕ
		|	Т.НомерВолны = &НомерВолны - 1
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	НомерУзла";
		
		Запрос.Выполнить(); // создание ВТИзменениеОписанияУзлов
		
		ЕстьИзменения = (РасчетСебестоимостиПрикладныеАлгоритмы.РазмерВременнойТаблицы(ПараметрыРасчета, "ВТИзменениеОписанияУзлов") > 0);
		
		Если НЕ ЕстьИзменения Тогда
			
			// Может получиться, что некоторые узла обойти не удалось - эти узлы могут располагаться в циклах, в которые нет пути
			// из начальных вершин ( с номером волны = 1). В этом случае из цикла берем вершину с минимальным номером и
			// минимальным количеством исходящих дуг и продолжаем обход из нее.
			
			Запрос.Текст =
			"ВЫБРАТЬ
			|	КОЛИЧЕСТВО(*) КАК КоличествоУзловВЦиклах
			|ИЗ
			|	ВТОписаниеУзлов КАК Т
			|ГДЕ
			|	Т.НомерВолны = 0
			|";
			
			Выборка = Запрос.Выполнить().Выбрать();
			Выборка.Следующий();
			
			ЕстьИзменения = (Выборка.КоличествоУзловВЦиклах > 0); // если Ложь, то обход графа полностью завершен
				
			Если ЕстьИзменения Тогда
				
				НомерВолныДляЦиклов = ?(ЗначениеЗаполнено(НомерВолныДляЦиклов), НомерВолныДляЦиклов, НомерВолны);
				
				Запрос.Текст =
				"ВЫБРАТЬ
				|	Т.НомерПодграфа КАК НомерПодграфа,
				|	Т.НомерУзла,
				|	ОписаниеУзлов.КоличествоПриемников КАК КоличествоПриемников
				|ПОМЕСТИТЬ ВТУзлыДляОбхода
				|ИЗ
				|	ВТУзлыПодграфов КАК Т
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТОписаниеУзлов КАК ОписаниеУзлов
				|		ПО Т.НомерУзла = ОписаниеУзлов.НомерУзла
				|ГДЕ
				|	ОписаниеУзлов.НомерВолны = 0
				|
				|ИНДЕКСИРОВАТЬ ПО
				|	НомерПодграфа,
				|	КоличествоПриемников
				|;
				|
				|////////////////////////////////////////////////////////////////////////////////
				|ВЫБРАТЬ
				|	Т.НомерПодграфа КАК НомерПодграфа,
				|	МИНИМУМ(Т.КоличествоПриемников) КАК КоличествоПриемников
				|ПОМЕСТИТЬ ВТПодграфыДляОбхода
				|ИЗ
				|	ВТУзлыДляОбхода КАК Т
				|
				|СГРУППИРОВАТЬ ПО
				|	Т.НомерПодграфа
				|
				|ИНДЕКСИРОВАТЬ ПО
				|	НомерПодграфа,
				|	КоличествоПриемников
				|;
				|
				|////////////////////////////////////////////////////////////////////////////////
				|УНИЧТОЖИТЬ ВТИзменениеОписанияУзлов
				|;
				|
				|////////////////////////////////////////////////////////////////////////////////
				|ВЫБРАТЬ
				|	ВТУзлыДляОбхода.НомерПодграфа,
				|	МИНИМУМ(ВТУзлыДляОбхода.НомерУзла) КАК НомерУзла
				|ПОМЕСТИТЬ ВТИзменениеОписанияУзлов
				|ИЗ
				|	ВТУзлыДляОбхода КАК ВТУзлыДляОбхода
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТПодграфыДляОбхода КАК ВТПодграфыДляОбхода
				|		ПО ВТУзлыДляОбхода.НомерПодграфа = ВТПодграфыДляОбхода.НомерПодграфа
				|			И ВТУзлыДляОбхода.КоличествоПриемников = ВТПодграфыДляОбхода.КоличествоПриемников
				|
				|СГРУППИРОВАТЬ ПО
				|	ВТУзлыДляОбхода.НомерПодграфа
				|
				|ИНДЕКСИРОВАТЬ ПО
				|	НомерУзла";
				
				Запрос.Выполнить(); // создание ВТИзменениеОписанияУзлов
				
				РасчетСебестоимостиПрикладныеАлгоритмы.УничтожитьВременныеТаблицы(ПараметрыРасчета, "ВТУзлыДляОбхода, ВТПодграфыДляОбхода");
				
			КонецЕсли;
			
		КонецЕсли;
		
		Если ЕстьИзменения Тогда
			
			Запрос.Текст =
			"ВЫБРАТЬ
			|	Т.НомерУзла,
			|	Т.КоличествоПриемников,
			|	Т.КоличествоИсточников,
			|	ВЫБОР КОГДА ИзменениеОписанияУзлов.НомерУзла ЕСТЬ NULL 
			|		ТОГДА Т.НомерВолны
			|		ИНАЧЕ &НомерВолны
			|	КОНЕЦ КАК НомерВолны
			|ПОМЕСТИТЬ ВТНовоеОписаниеУзлов
			|ИЗ
			|	ВТОписаниеУзлов КАК Т
			|		ЛЕВОЕ СОЕДИНЕНИЕ ВТИзменениеОписанияУзлов КАК ИзменениеОписанияУзлов
			|		ПО Т.НомерУзла = ИзменениеОписанияУзлов.НомерУзла
			|;
			|
			|////////////////////////////////////////////////////////////////////////////////
			|УНИЧТОЖИТЬ ВТОписаниеУзлов
			|;
			|
			|////////////////////////////////////////////////////////////////////////////////
			|ВЫБРАТЬ
			|	Т.НомерУзла,
			|	Т.КоличествоПриемников,
			|	Т.КоличествоИсточников,
			|	Т.НомерВолны
			|ПОМЕСТИТЬ ВТОписаниеУзлов
			|ИЗ
			|	ВТНовоеОписаниеУзлов КАК Т
			|
			|ИНДЕКСИРОВАТЬ ПО
			|	НомерУзла
			|;
			|
			|////////////////////////////////////////////////////////////////////////////////
			|УНИЧТОЖИТЬ ВТНовоеОписаниеУзлов";
			
			Запрос.Выполнить(); // обновление ВТОписаниеУзлов
			
		КонецЕсли;
		
		РасчетСебестоимостиПрикладныеАлгоритмы.УничтожитьВременныеТаблицы(ПараметрыРасчета, "ВТИзменениеОписанияУзлов");
			
	КонецЦикла;
	
	#КонецОбласти
	
	#Область РасчетНовыхНомеровУзлов
	
	// Рассчитаем новые номера вершин исходного графа:
	// - упорядочим все вершины
	// - обойдем получившийся результат и последовательно пронумеруем вершины от 0 до (количество вершин - 1).
	
	Запрос.Текст =
	"ВЫБРАТЬ
	|	ВЫРАЗИТЬ(Подграфы.НовыйНомерПервогоУзлаПодграфа / &КоличествоСтрокВТЗ КАК ЧИСЛО(15,0)) КАК ЗначениеРазделителя,
	|	Подграфы.НомерПодграфа 			КАК НомерПодграфа,
	|	Подграфы.НовыйНомерПодграфа 	КАК НовыйНомерПодграфа,
	|	Т.НомерВолны 					КАК НомерВолны,
	|	Т.НомерУзла 					КАК НомерУзла,
	|	Т.НомерУзла 					КАК НовыйНомерУзла,
	|	ПорядокУзлов.Порядок 			КАК Порядок
	|ПОМЕСТИТЬ ВТНовыеНомераУзлов
	|ИЗ
	|	ВТОписаниеУзлов КАК Т
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТУзлыПодграфов КАК УзлыПодграфов
	|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТПодграфы КАК Подграфы
	|			ПО УзлыПодграфов.НомерПодграфа = Подграфы.НомерПодграфа
	|		ПО Т.НомерУзла = УзлыПодграфов.НомерУзла
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТПорядокУзлов КАК ПорядокУзлов
	|		ПО Т.НомерУзла = ПорядокУзлов.НомерУзла";
	
	Запрос.Выполнить(); // создание ВТНовыеНомераУзлов
	
	ПараметрыНумерации = РасчетСебестоимостиПрикладныеАлгоритмы.СформироватьПараметрыНумерацииСтрокВременнойТаблицы(
		"ЗначениеРазделителя", // разделитель
		"", // ресурсы
		"НовыйНомерПодграфа, НомерВолны, Порядок, НомерУзла", // порядок
		"НовыйНомерУзла", // номер
		"НомерУзла", // индекс
		"", // накопление
		Ложь); // не подбирать разделитель
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ЗаполнитьНомераСтрокВременнойТаблицы(
		ПараметрыРасчета,
		ПараметрыНумерации,
		"ВТНовыеНомераУзлов");
		
	#КонецОбласти
	
	#Область ИзменениеНумерацииВТаблицах
	
	// Заменим старые номера вершин на новые в служебных временных таблицах Данные, Источники, Приемники.
	// В таблицах Источники и Приемники заполним поле Порядок.
	// Это поле относятся к колонкам "Источник" и "Приемник" и предназначено для их сортировки по ФИФО.
	
	Запрос.Текст =
	"ВЫБРАТЬ
	|	Т.НомерУзла 			 КАК Ключ,
	|	Т.СвязанныйУзел 		 КАК Источник,
	|	ПорядокУзлов.Порядок 	 КАК Порядок
	|ПОМЕСТИТЬ Источники_Временная
	|ИЗ
	|	ВТСвязиУзлов КАК Т
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТПорядокУзлов КАК ПорядокУзлов
	|		ПО Т.СвязанныйУзел = ПорядокУзлов.НомерУзла
	|			И Т.ЭтоИсточник = ИСТИНА
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Ключ
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ Источники
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	НовыеНомераКлючей.НовыйНомерУзла 	 КАК Ключ,
	|	НовыеНомераИсточников.НовыйНомерУзла КАК Источник,
	|	Т.Порядок 				 			 КАК Порядок
	|ПОМЕСТИТЬ Источники
	|ИЗ
	|	Источники_Временная КАК Т
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТНовыеНомераУзлов КАК НовыеНомераКлючей
	|		ПО Т.Ключ = НовыеНомераКлючей.НомерУзла
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТНовыеНомераУзлов КАК НовыеНомераИсточников
	|		ПО Т.Источник = НовыеНомераИсточников.НомерУзла
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Ключ
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ Источники_Временная";
	
	Запрос.Выполнить(); // обновление Источники
	
	Запрос.Текст =
	"ВЫБРАТЬ
	|	Т.НомерУзла 			 КАК Ключ,
	|	Т.СвязанныйУзел 		 КАК Приемник,
	|	ПорядокУзлов.Порядок 	 КАК Порядок
	|ПОМЕСТИТЬ Приемники_Временная
	|ИЗ
	|	ВТСвязиУзлов КАК Т
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТПорядокУзлов КАК ПорядокУзлов
	|		ПО Т.СвязанныйУзел = ПорядокУзлов.НомерУзла
	|			И (Т.ЭтоИсточник = ЛОЖЬ)
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Ключ
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ Приемники
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	НовыеНомераКлючей.НовыйНомерУзла 	 КАК Ключ,
	|	НовыеНомераПриемников.НовыйНомерУзла КАК Приемник,
	|	Т.Порядок 				 			 КАК Порядок
	|ПОМЕСТИТЬ Приемники
	|ИЗ
	|	Приемники_Временная КАК Т
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТНовыеНомераУзлов КАК НовыеНомераКлючей
	|		ПО Т.Ключ = НовыеНомераКлючей.НомерУзла
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТНовыеНомераУзлов КАК НовыеНомераПриемников
	|		ПО Т.Приемник = НовыеНомераПриемников.НомерУзла
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Ключ
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ Приемники_Временная";
	
	Запрос.Выполнить(); // обновление Приемники
	
	Запрос.Текст =
	"ВЫБРАТЬ ПЕРВЫЕ 1
	|	ИСТИНА КАК ЕстьРазличия
	|ИЗ
	|	ВТНовыеНомераУзлов КАК Т
	|ГДЕ
	|	Т.НомерУзла <> Т.НовыйНомерУзла";
	
	ЕстьИзменения = НЕ Запрос.Выполнить().Пустой();
	
	Если ЕстьИзменения Тогда
		
		Запрос.Текст =
		"ВЫБРАТЬ
		|	*
		|ПОМЕСТИТЬ Данные_Временная
		|ИЗ
		|	Данные КАК Т
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ Данные
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	%1
		|ПОМЕСТИТЬ Данные
		|ИЗ
		|	Данные_Временная КАК Т
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТНовыеНомераУзлов КАК НовыеНомера
		|		ПО Т.К = НовыеНомера.НомерУзла
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	К
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ Данные_Временная";
		
		Запрос.Текст = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(Запрос.Текст, ИменаКолонокТаблицыДанные);
		
		Запрос.Выполнить(); // обновление Данные
		
	КонецЕсли;
	
	#КонецОбласти
	
	#Область ФормированиеСтатистикиГрафа
	
	// Создадим новые служебные таблицы ОписаниеПодграфов и ОписаниеУзловПодграфов.
	
	Запрос.Текст =
	"ВЫБРАТЬ
	|	Т.НовыйНомерУзла 					КАК НомерУзла,
	|	Т.НовыйНомерПодграфа 				КАК НомерПодграфа,
	|	Т.НомерВолны 						КАК НомерВолны,
	|	Т.Порядок							КАК Порядок,
	|	ОписаниеУзлов.КоличествоПриемников 	КАК КоличествоПриемников,
	|	ОписаниеУзлов.КоличествоИсточников 	КАК КоличествоИсточников
	|ПОМЕСТИТЬ ОписаниеУзловПодграфов
	|ИЗ
	|	ВТНовыеНомераУзлов КАК Т
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТОписаниеУзлов КАК ОписаниеУзлов
	|		ПО Т.НомерУзла = ОписаниеУзлов.НомерУзла
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	НомерУзла
	|;
	|////////////////////////////////////////////////////////////////////////////////
	|
	|ВЫБРАТЬ
	|	Т.НомерПодграфа 					КАК НомерПодграфа,
	|	КОЛИЧЕСТВО(РАЗЛИЧНЫЕ Т.НомерВолны) 	КАК КоличествоВолн,
	|	СУММА(Т.КоличествоИсточников) 		КАК КоличествоСвязей,
	|	КОЛИЧЕСТВО(РАЗЛИЧНЫЕ Т.НомерУзла) 	КАК КоличествоУзлов,
	|	МИНИМУМ(Т.НомерУзла) 				КАК МинимальныйНомерУзла,
	|	МАКСИМУМ(Т.НомерУзла) 				КАК МаксимальныйНомерУзла,
	|	МАКСИМУМ(Т.КоличествоПриемников) 	КАК МаксимумПриемниковУзла,
	|	МАКСИМУМ(Т.КоличествоИсточников) 	КАК МаксимумИсточниковУзла
	|ПОМЕСТИТЬ ОписаниеПодграфов
	|ИЗ
	|	ОписаниеУзловПодграфов КАК Т
	|СГРУППИРОВАТЬ ПО
	|	Т.НомерПодграфа
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	НомерПодграфа";
	
	Запрос.Выполнить(); // создание ОписаниеУзловПодграфов и ОписаниеПодграфов
	
	// Выведем в журнал регистрации подробное описание графа.
	
	ОписаниеГрафа = НСтр("ru = 'Описание цепочек (графа) для расчета:
	|	узлов - %01; дуг - %02; макс. исходящих дуг - %03; макс. входящих дуг - %04;
	|	содержит несвязанных подграфов - %05, в т.ч. вырожденных (из одного узла) - %06;
	|	макс. узлов в одном подграфе - %07; макс. дуг в одном подграфе - %08;
	|	выполнено итераций поиска подграфов - %09, итераций нумерации - %10, в т.ч. из-за циклов - %11';
	|en = 'Chain (graph) description for calculation:
	|	nodes - %01; arcs - %02; max. outgoing arcs - %03; max. incoming arcs - %04;
	|	contains disconnected subgraphs - %05, including degenerate ones (out of one node) - %06;
	|	max. nodes in one subgraph - %07; max. arcs in one subgraph - %08;
	|	completed interations of subgraph search - %09, numbering iterations - %10, including ones due to loops - %11'");
	
	Запрос.УстановитьПараметр("КоличествоИтерацийПоискаПодграфов", 	   КоличествоИтерацийПоискаПодграфов);
	Запрос.УстановитьПараметр("КоличествоИтерацийНумерации", 	   	   НомерВолны - 1);
	Запрос.УстановитьПараметр("КоличествоИтерацийНумерацииИзЗаЦиклов", ?(ЗначениеЗаполнено(НомерВолныДляЦиклов), НомерВолны - НомерВолныДляЦиклов, 0));
	
	Запрос.Текст =
	"ВЫБРАТЬ
	|	1 						 КАК НомерПараметра,
	|	СУММА(Т.КоличествоУзлов) КАК ЗначениеПараметра
	|ИЗ
	|	ОписаниеПодграфов КАК Т
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	2,
	|	СУММА(Т.КоличествоСвязей)
	|ИЗ
	|	ОписаниеПодграфов КАК Т
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	3,
	|	МАКСИМУМ(Т.МаксимумПриемниковУзла)
	|ИЗ
	|	ОписаниеПодграфов КАК Т
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	4,
	|	МАКСИМУМ(Т.МаксимумИсточниковУзла)
	|ИЗ
	|	ОписаниеПодграфов КАК Т
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	5,
	|	КОЛИЧЕСТВО(*)
	|ИЗ
	|	ОписаниеПодграфов КАК Т
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	6,
	|	КОЛИЧЕСТВО(*)
	|ИЗ
	|	ОписаниеПодграфов КАК Т
	|ГДЕ
	|	Т.КоличествоУзлов = 1
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	7,
	|	МАКСИМУМ(Т.КоличествоУзлов)
	|ИЗ
	|	ОписаниеПодграфов КАК Т
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	8,
	|	МАКСИМУМ(Т.КоличествоСвязей)
	|ИЗ
	|	ОписаниеПодграфов КАК Т
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	9,
	|	&КоличествоИтерацийПоискаПодграфов
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	10,
	|	&КоличествоИтерацийНумерации
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	11,
	|	&КоличествоИтерацийНумерацииИзЗаЦиклов
	|
	|УПОРЯДОЧИТЬ ПО
	|	НомерПараметра";
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	Пока Выборка.Следующий() Цикл
		ОписаниеГрафа = СтрЗаменить(
			ОписаниеГрафа,
			"%" + Формат(Выборка.НомерПараметра, "ЧЦ=2; ЧВН="),
			СокрЛП(Выборка.ЗначениеПараметра));
	КонецЦикла;
	
	ОкончаниеЗамера = ТекущаяУниверсальнаяДатаВМиллисекундах();
	ОписаниеГрафа = ОписаниеГрафа + "
		|	" + СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
					НСтр("ru = 'Время подготовки графа: %1 сек.';
						|en = 'Graph preparation time: %1 sec'"),
					Формат((ОкончаниеЗамера - НачалоЗамера)/1000, "ЧГ="));
	
	ИмяСобытия = НСтр("ru = 'Партионный учет.ИнформацияОЦепочках';
						|en = 'Batch accounting.ИнформацияОЦепочках'", ОбщегоНазначения.КодОсновногоЯзыка());
	ЗаписьЖурналаРегистрации(ИмяСобытия, УровеньЖурналаРегистрации.Информация,,, ОписаниеГрафа);
	
	#КонецОбласти
	
	РасчетСебестоимостиПрикладныеАлгоритмы.УничтожитьВременныеТаблицы(ПараметрыРасчета,
		"ВТПорядокУзлов, ВТУзлыПодграфов, ВТСвязиУзлов, ВТПодграфы, ВТОписаниеУзлов, ВТНовыеНомераУзлов");
	
КонецПроцедуры

//++ НЕ УТ

Функция ЦепочкиДвиженийЗапросом(ОписаниеЦепочек, РасчетныеПартии)
	Таблицы = Новый Структура;
	КолонкиЗапроса = РасчетныеПартии.Колонки;
	Для Каждого Описание Из ОписаниеЦепочек Цикл
		ТипЗаписи = Описание.Ключ;
		Если Не Таблицы.Свойство(ТипЗаписи) Тогда
			ДобавитьТаблицу(ТипЗаписи, Таблицы);
		КонецЕсли;
		ДобавитьКолонки(ТипЗаписи, Описание.Значение.ПоляСвязи, КолонкиЗапроса, Таблицы);
		Для Каждого ОписаниеИсточника Из Описание.Значение.ТипыИсточников Цикл
			ТипИсточника = ОписаниеИсточника.Ключ;
			Если Не Таблицы.Свойство(ТипИсточника) Тогда
				ДобавитьТаблицу(ТипИсточника, Таблицы);
			КонецЕсли;
			ДобавитьКолонки(ТипИсточника, ОписаниеИсточника.Значение, КолонкиЗапроса, Таблицы);
		КонецЦикла;
	КонецЦикла;
	МВТ = ДобавитьВременныеТаблицы(РасчетныеПартии, Таблицы);
	ЗаполнитьЦепочки(ОписаниеЦепочек, Таблицы, МВТ);
	Возврат МВТ;
КонецФункции

Процедура ДобавитьТаблицу(ТипЗаписи, Таблицы)
	Таблицы.Вставить(ТипЗаписи, Новый ТаблицаЗначений);
	Колонки = Таблицы[ТипЗаписи].Колонки;
	Колонки.Добавить("К", ОбщегоНазначения.ОписаниеТипаЧисло(15));
КонецПроцедуры

Процедура ДобавитьКолонки(ТипЗаписи, ПоляСвязи, КолонкиЗапроса, Таблицы)
	Колонки = Таблицы[ТипЗаписи].Колонки;
	Для Каждого ПолеСвязи Из ПоляСвязи Цикл
		Если Колонки.Найти(ПолеСвязи) = Неопределено Тогда
			Колонки.Добавить(ПолеСвязи, КолонкиЗапроса[ПолеСвязи].ТипЗначения);
		КонецЕсли;
	КонецЦикла;
КонецПроцедуры

Функция ДобавитьВременныеТаблицы(РасчетныеПартии, Таблицы)
	Движение = РасчетныеПартии.Выбрать();
	НомерСтроки = -1;
	Пока Движение.Следующий() Цикл
		НомерСтроки = НомерСтроки + 1;
		НоваяСтрока = Таблицы[Движение.ТипЗаписи].Добавить();
		ЗаполнитьЗначенияСвойств(НоваяСтрока, Движение);
		НоваяСтрока.К = НомерСтроки;
	КонецЦикла;
	
	ШаблонЗапроса = "
	|ВЫБРАТЬ
	|	*
	|ПОМЕСТИТЬ
	|	&ИмяТаблицы
	|ИЗ
	|	&Таблица КАК &ИмяТаблицы
	|";
	МВТ = Новый МенеджерВременныхТаблиц;
	ПустыеТаблицы = Новый Массив;
	Для Каждого Таблица Из Таблицы Цикл
		Если Таблица.Значение.Количество() > 0 Тогда
			ТекстЗапроса = СтрЗаменить(ШаблонЗапроса, "&ИмяТаблицы", Таблица.Ключ);
			Запрос = Новый Запрос(ТекстЗапроса);
			Запрос.МенеджерВременныхТаблиц = МВТ;
			Запрос.УстановитьПараметр("Таблица", Таблица.Значение);
			Запрос.Выполнить();
			Таблица.Значение.Очистить();
		Иначе
			ПустыеТаблицы.Добавить(Таблица.Ключ);
		КонецЕсли;
	КонецЦикла;
	Для Каждого Имя Из ПустыеТаблицы Цикл
		Таблицы.Удалить(Имя);
	КонецЦикла;
	Возврат МВТ;
КонецФункции

Процедура ЗаполнитьЦепочки(ОписаниеЦепочек, Таблицы, МВТ)
	ШаблонЗапроса = "
	|ВЫБРАТЬ
	|	Приемники.К КАК Приемник,
	|	Источники.К КАК Источник
	|ПОМЕСТИТЬ
	|	&Результат
	|ИЗ
	|	&ИмяПриемника КАК Приемники
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ &ИмяИсточника КАК Источники
	|		ПО &Условия
	|ГДЕ
	|	Приемники.К <> Источники.К
	|;
	|";
	ТекстЗапроса = "";
	Результаты = Новый Массив;
	Для Каждого Описание Из ОписаниеЦепочек Цикл
		ПоляПриемника = Описание.Значение.ПоляСвязи;
		Если Не Таблицы.Свойство(Описание.Ключ) ИЛИ ПоляПриемника.Количество() = 0 Тогда
			Продолжить;
		КонецЕсли;
		Для Каждого ОписаниеИсточника Из Описание.Значение.ТипыИсточников Цикл
			ПоляИсточника = ОписаниеИсточника.Значение;
			Если Не Таблицы.Свойство(ОписаниеИсточника.Ключ) ИЛИ ПоляИсточника.Количество() = 0 Тогда
				Продолжить;
			КонецЕсли;
			НомерПоля = -1;
			Для Каждого ПолеПриемника Из ПоляПриемника Цикл
				НомерПоля = НомерПоля + 1;
				Если НомерПоля = 0 Тогда
					Условия = "Приемники." + ПолеПриемника + " = " + "Источники." + ПоляИсточника[НомерПоля];
				Иначе
					Условия = Условия + Символы.ПС + " И " + "Приемники." + ПолеПриемника + " = " + "Источники." + ПоляИсточника[НомерПоля];
				КонецЕсли;
			КонецЦикла;
			ТекстЗапроса = СтрЗаменить(ШаблонЗапроса, "&ИмяПриемника", Описание.Ключ);
			ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "&ИмяИсточника", ОписаниеИсточника.Ключ);
			ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "&Результат", Описание.Ключ + ОписаниеИсточника.Ключ);
			ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "&Условия", Условия);
			Результаты.Добавить(Описание.Ключ + ОписаниеИсточника.Ключ);
			Запрос = Новый Запрос(ТекстЗапроса);
			Запрос.МенеджерВременныхТаблиц = МВТ;
			Запрос.Выполнить();
		КонецЦикла;
	КонецЦикла;
	
	Если Таблицы.Количество() > 0 Тогда
		ТекстЗапроса = "";
		Для Каждого Таблица Из Таблицы Цикл
			ШаблонЗапроса = "
			|УНИЧТОЖИТЬ &ИмяТаблицы
			|;
			|";
			ТекстЗапроса = ТекстЗапроса + СтрЗаменить(ШаблонЗапроса, "&ИмяТаблицы", Таблица.Ключ);
		КонецЦикла;
		Запрос = Новый Запрос(ТекстЗапроса);
		Запрос.МенеджерВременныхТаблиц = МВТ;
		Запрос.Выполнить();
	КонецЕсли;
	
	ТекстЗапроса = "
	|ВЫБРАТЬ ПЕРВЫЕ 0
	|	-1 КАК Приемник,
	|	-1 КАК Источник
	|ПОМЕСТИТЬ
	|	Цепочки
	|";
	ШаблонЗапроса = "
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|ВЫБРАТЬ
	|	ДД.Приемник,
	|	ДД.Источник
	|ИЗ
	|	&ИмяТаблицы КАК ДД
	|";
	Для Каждого Результат Из Результаты Цикл
		ТекстЗапроса = ТекстЗапроса + СтрЗаменить(ШаблонЗапроса, "&ИмяТаблицы", Результат);
	КонецЦикла;
	ТекстЗапроса = ТекстЗапроса + ";";
	Для Каждого Результат Из Результаты Цикл
		ТекстЗапроса = ТекстЗапроса + "УНИЧТОЖИТЬ " + Результат + ";";
	КонецЦикла;
	Запрос = Новый Запрос(ТекстЗапроса);
	Запрос.МенеджерВременныхТаблиц = МВТ;
	Запрос.Выполнить();
	
	Запрос.Текст =
	"ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	ДД.Приемник КАК Ключ,
	|	ДД.Источник КАК Источник,
	|	0 			КАК Порядок
	|ПОМЕСТИТЬ Источники
	|ИЗ
	|	Цепочки КАК ДД
	|ИНДЕКСИРОВАТЬ ПО
	|	Ключ
	|;
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	ДД.Источник КАК Ключ,
	|	ДД.Приемник КАК Приемник,
	|	0 			КАК Порядок
	|ПОМЕСТИТЬ Приемники
	|ИЗ
	|	Цепочки КАК ДД
	|ИНДЕКСИРОВАТЬ ПО
	|	Ключ
	|;
	|УНИЧТОЖИТЬ Цепочки
	|";
	
	Запрос.Выполнить();
	
КонецПроцедуры
//-- НЕ УТ

Функция ЦепочкиДвиженийПоИндексу(МВТ, НачальныйИндекс, КонечныйИндекс, ЦепочкиДвижений, СтрокиЦепочек)
	
	Колонки = СтрокиЦепочек.Колонки;
	Если Колонки.Количество() = 0 Тогда
		Колонки.Добавить("Источники", 	   Новый ОписаниеТипов("Массив"));
		Колонки.Добавить("Приемники", 	   Новый ОписаниеТипов("Массив"));
		Колонки.Добавить("ПройденныйПуть", Новый ОписаниеТипов("Соответствие"));
	КонецЕсли;
	
	Запрос = Новый Запрос;
	Запрос.МенеджерВременныхТаблиц = МВТ;
	Запрос.УстановитьПараметр("НачальныйИндекс", НачальныйИндекс);
	Запрос.УстановитьПараметр("КонечныйИндекс",  КонечныйИндекс);
	
	ТаблицыСвязейУзлов = Новый Структура;
	ТаблицыСвязейУзлов.Вставить("Источники", "Источник");
	ТаблицыСвязейУзлов.Вставить("Приемники", "Приемник");
	
	ШаблонЗапроса =
	"ВЫБРАТЬ
	|	ДД.Ключ КАК Ключ,
	|	ДД.%2 КАК %2
	|ИЗ
	|	%1 КАК ДД
	|ГДЕ
	|	ДД.Ключ >= &НачальныйИндекс
	|	И ДД.Ключ <= &КонечныйИндекс
	|	И ДД.Ключ <> ДД.%2
	|	
	|УПОРЯДОЧИТЬ ПО
	|	Ключ,
	|	ДД.Порядок,
	|	%2";
	
	Для Каждого ОписаниеТаблицы Из ТаблицыСвязейУзлов Цикл
		
		Запрос.Текст = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
			ШаблонЗапроса,
			ОписаниеТаблицы.Ключ,
			ОписаниеТаблицы.Значение);
		
		ТекущийКлюч = -1;
		Строка = Неопределено;
		
		Выборка = Запрос.Выполнить().Выбрать();
		
		Пока Выборка.Следующий() Цикл
			
			Ключ = Выборка.Ключ;
			
			Если ТекущийКлюч <> Ключ Тогда
				
				Если ТекущийКлюч <> -1 Тогда
					ЦепочкиДвижений.Вставить(ТекущийКлюч, Строка);
				КонецЕсли;
				
				ТекущийКлюч = Ключ;
				
				Строка = ЦепочкиДвижений[ТекущийКлюч];
				Если Строка = Неопределено Тогда
					Строка = СтрокиЦепочек.Добавить();
				КонецЕсли;
				
			КонецЕсли;
			
			Строка[ОписаниеТаблицы.Ключ].Добавить(Выборка[ОписаниеТаблицы.Значение]);
			
		КонецЦикла;
		
		Если ТекущийКлюч <> -1 Тогда
			ЦепочкиДвижений.Вставить(ТекущийКлюч, Строка);
		КонецЕсли;
		
	КонецЦикла;
	
	Возврат Выборка.Количество(); // размер выборки из источников и приемников одинаковый
	
КонецФункции

////////////////////////////////////////////////////////////////////////////////
// Расчет партий по цепочкам движений и выборки из результата запроса

Функция ВыборкаДанныеПоИндексу(МВТ, НачальныйИндекс, КонечныйИндекс)
	Запрос = Новый Запрос("
	|ВЫБРАТЬ
	|	*
	|ИЗ
	|	Данные КАК ДД
	|ГДЕ
	|	ДД.К >= &НачальныйИндекс
	|	И ДД.К <= &КонечныйИндекс
	|УПОРЯДОЧИТЬ ПО
	|	ДД.К ВОЗР
	|");
	Запрос.МенеджерВременныхТаблиц = МВТ;
	Запрос.УстановитьПараметр("НачальныйИндекс", НачальныйИндекс);
	Запрос.УстановитьПараметр("КонечныйИндекс", КонечныйИндекс);
	Выборка = Запрос.Выполнить().Выбрать();
	Возврат Выборка;
КонецФункции

Процедура РассчитатьПартииПоЦепочкам(ОписаниеДвижений, ДанныеДляРасчета, РасчетныеПартии, Регистраторы, Тест)
	
	Приходы = Новый Соответствие; // буфер копий партий для покрытия расходов
	Расходы = Новый Соответствие; // буфер не рассчитанных партий для расчета на следующих итерациях
	СтрокиПриходов = РасчетныеПартии.СкопироватьКолонки();
	СтрокиРасходов = РасчетныеПартии.СкопироватьКолонки();
	ПройденныйПуть = Новый Соответствие; // используется для прерывания циклов
	ИндексыРасходов = Новый Массив;
	ЦепочкиДвижений = Новый Соответствие;
	СтрокиЦепочек = Новый ТаблицаЗначений;
	
	ЗаполнятьАналитикуПартий = ОписаниеДвижений.Свойство("ЗаполнятьАналитикуПартий");
	
	Данные = Новый Структура;
	Данные.Вставить("РасчетныеПартии", РасчетныеПартии);
	Данные.Вставить("ЦепочкиДвижений", ЦепочкиДвижений);
	Данные.Вставить("СтрокиЦепочек", СтрокиЦепочек);
	Данные.Вставить("Приходы", Приходы);
	Данные.Вставить("Расходы", Расходы);
	Данные.Вставить("СтрокиПриходов", СтрокиПриходов);
	Данные.Вставить("СтрокиРасходов", СтрокиРасходов);
	Данные.Вставить("ИндексыРасходов", ИндексыРасходов);
	Данные.Вставить("ПройденныйПуть", ПройденныйПуть);
	
	КоличествоЗаписей = КоличествоЗаписей(ДанныеДляРасчета);
	КоличествоСвязей  = КоличествоСвязейМеждуЗаписями(ДанныеДляРасчета);

	Комментарий = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
		НСтр("ru = 'К расчету: строк - %1, связей - %2';
			|en = 'For calculation: lines - %1, links - %2'", ОбщегоНазначения.КодОсновногоЯзыка()),
		СокрЛП(КоличествоЗаписей),
		СокрЛП(КоличествоСвязей));
	ИмяСобытия = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
		НСтр("ru = 'Партионный учет.%1';
			|en = 'Batch accounting.%1'", ОбщегоНазначения.КодОсновногоЯзыка()),
		ОписаниеДвижений.Контекст);
	ЗаписьЖурналаРегистрации(ИмяСобытия, УровеньЖурналаРегистрации.Информация,,, Комментарий);
	
	ИндексСтроки = -1;
	КонечнаяЦепочка = -1;
	КоличествоДуг = 0;
	
	Пока ИндексСтроки <= КоличествоЗаписей Цикл
		
		ИндексСтроки = ИндексСтроки + 1;
		Если ИндексСтроки > КонечнаяЦепочка Тогда
			НачальнаяЦепочка = ИндексСтроки;
			КонечнаяЦепочка = КонечнаяЦепочка + 10000;
			Выборка = ВыборкаДанныеПоИндексу(ДанныеДляРасчета, НачальнаяЦепочка, КонечнаяЦепочка);
			КоличествоДуг = ЦепочкиДвиженийПоИндексу(ДанныеДляРасчета, НачальнаяЦепочка, КонечнаяЦепочка, ЦепочкиДвижений, СтрокиЦепочек);
		КонецЕсли;
		
		Если Не Выборка.Следующий() Тогда
			Прервать;
		КонецЕсли;
		
		ЦепочкаДвижений = ЦепочкиДвижений[ИндексСтроки];
		Если ЦепочкаДвижений = Неопределено Тогда
			РасчетнаяПартия = РасчетныеПартии.Добавить();
			ЗаполнитьЗначенияСвойств(РасчетнаяПартия, Выборка);
			Если ЗаполнятьАналитикуПартий И Выборка.ТипЗаписи = "Партия" И Выборка.РасчетЗавершен Тогда
				РасчетнаяПартия.АналитикаУчетаПартий =
					АналитикаУчетаПартий(Выборка.АналитикаУчетаПартий, Выборка.НалогообложениеПартии, Выборка.НалогообложениеНДС);
			КонецЕсли;
		ИначеЕсли Выборка.РасчетЗавершен Тогда
			РасчетнаяПартия = РасчетныеПартии.Добавить();
			ЗаполнитьЗначенияСвойств(РасчетнаяПартия, Выборка);
			Если ЗаполнятьАналитикуПартий И Выборка.ТипЗаписи = "Партия" Тогда
				РасчетнаяПартия.АналитикаУчетаПартий =
					АналитикаУчетаПартий(Выборка.АналитикаУчетаПартий, Выборка.НалогообложениеПартии, Выборка.НалогообложениеНДС);
				Если ЗначениеЗаполнено(Выборка.НалогообложениеПартии) И ЗначениеЗаполнено(Выборка.НалогообложениеНДС) Тогда
					РасчетнаяПартия.НалогообложениеПартии = Выборка.НалогообложениеНДС;
				КонецЕсли;
			КонецЕсли;
			Если ЦепочкаДвижений.Приемники.Количество() > 0 Тогда
				Приход = СтрокиПриходов.Добавить();
				ЗаполнитьЗначенияСвойств(Приход, РасчетнаяПартия);
				ИнвертироватьПоказатели(Приход, ОписаниеДвижений.Показатели, ("Сторно" = Приход.ТипЗаписи ИЛИ "ПартияСторно" = Приход.ТипЗаписи ИЛИ "ОстатокСторно" = Приход.ТипЗаписи));
				Приходы.Вставить(ИндексСтроки, Новый Массив);
				Приходы[ИндексСтроки].Добавить(Приход);
			КонецЕсли;
			ЦепочкиДвижений.Удалить(ИндексСтроки);
			СтрокиЦепочек.Удалить(ЦепочкаДвижений);
		Иначе
			Расход = СтрокиРасходов.Добавить();
			ЗаполнитьЗначенияСвойств(Расход, Выборка);
			Расходы.Вставить(ИндексСтроки, Расход);
			ИндексыРасходов.Добавить(ИндексСтроки);
		КонецЕсли;
		
		// Запишем порцию движений в регистр.
		Если Не Тест И РасчетныеПартии.Количество() > 100000 Тогда
			Если ОписаниеДвижений.Свойство("ПоляГруппировки") Тогда
				РасчетныеПартии.Свернуть(ОписаниеДвижений.ПоляГруппировки, ОписаниеДвижений.ПоляСуммирования);
			КонецЕсли;
			УдалитьНезаписываемыеСтроки(ОписаниеДвижений.Контекст, РасчетныеПартии);
			ЗаписатьРасчетныеПартии(РегистрыНакопления[ОписаниеДвижений.ИмяРегистра], РасчетныеПартии, Регистраторы);
			РасчетныеПартии.Очистить();
		КонецЕсли;
		
		Если ИндексСтроки > 0 И ИндексСтроки % 10000 = 0 Тогда
			Данные.Вставить("ИндексСтроки", ИндексСтроки);
			Если Приходы.Количество() > 0 Тогда // есть записи по которым расчет завершен
				Пока ИндексыРасходов.Количество() > 0 Цикл
					ИндексРасхода = ИндексыРасходов.Получить(0);
					ИндексыРасходов.Удалить(0);
					Если Расходы[ИндексРасхода] = Неопределено Тогда
						Продолжить; // строка к обсчету НЕ зарегистрирована
					КонецЕсли;
					БазисРасхода = Расходы[ИндексРасхода][ОписаниеДвижений.БазисРасхода];
					ПройденныйПуть.Очистить();
					РассчитатьПартиюПоЦепочкеИзВыборки(ОписаниеДвижений, Данные, ИндексРасхода, Регистраторы, Тест);
					
					Если Расходы[ИндексРасхода] <> Неопределено
					 И Расходы[ИндексРасхода][ОписаниеДвижений.БазисРасхода] > 0
					 И Расходы[ИндексРасхода][ОписаниеДвижений.БазисРасхода] <> БазисРасхода Тогда
						ИндексыРасходов.Добавить(ИндексРасхода);
					КонецЕсли;
					
					// Запишем порцию движений в регистр.
					Если Не Тест И РасчетныеПартии.Количество() > 100000 Тогда
						Если ОписаниеДвижений.Свойство("ПоляГруппировки") Тогда
							РасчетныеПартии.Свернуть(ОписаниеДвижений.ПоляГруппировки, ОписаниеДвижений.ПоляСуммирования);
						КонецЕсли;
						УдалитьНезаписываемыеСтроки(ОписаниеДвижений.Контекст, РасчетныеПартии);
						ЗаписатьРасчетныеПартии(РегистрыНакопления[ОписаниеДвижений.ИмяРегистра], РасчетныеПартии, Регистраторы);
						РасчетныеПартии.Очистить();
					КонецЕсли;
				КонецЦикла;
				
				Для Каждого Элемент Из Расходы Цикл
					ИндексРасхода = Элемент.Ключ;
					ИндексыРасходов.Добавить(ИндексРасхода);
				КонецЦикла;
				Список = Новый СписокЗначений;
				Список.ЗагрузитьЗначения(ИндексыРасходов);
				Список.СортироватьПоЗначению();
				ИндексыРасходов = Список.ВыгрузитьЗначения();
			КонецЕсли;
			
			Комментарий = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
				НСтр("ru = 'Рассчитано: %1 стр., %2 связей';
					|en = 'Calculated: %1 line, %2 links'", ОбщегоНазначения.КодОсновногоЯзыка()),
				ИндексСтроки,
				КоличествоДуг);
			ЗаписьЖурналаРегистрации(
				НСтр("ru = 'Партионный учет.';
					|en = 'Batch accounting.'",	ОбщегоНазначения.КодОсновногоЯзыка()) + ОписаниеДвижений.Контекст,
				УровеньЖурналаРегистрации.Информация,,, Комментарий);
		КонецЕсли;
	КонецЦикла;
	
	Если ИндексСтроки > КонечнаяЦепочка Тогда
		НачальнаяЦепочка = ИндексСтроки;
		КонечнаяЦепочка = КонечнаяЦепочка + 10000;
		КоличествоДуг = ЦепочкиДвиженийПоИндексу(ДанныеДляРасчета, НачальнаяЦепочка, КонечнаяЦепочка, ЦепочкиДвижений, СтрокиЦепочек);
	КонецЕсли;
	
	Данные.Вставить("ИндексСтроки", ИндексСтроки);
	Пока ИндексыРасходов.Количество() > 0 Цикл
		ИндексРасхода = ИндексыРасходов.Получить(0);
		ИндексыРасходов.Удалить(0);
		Если Расходы[ИндексРасхода] = Неопределено Тогда
			Продолжить; // строка к обсчету НЕ зарегистрирована
		КонецЕсли;
		БазисРасхода = Расходы[ИндексРасхода][ОписаниеДвижений.БазисРасхода];
		ПройденныйПуть.Очистить();
		РассчитатьПартиюПоЦепочкеИзВыборки(ОписаниеДвижений, Данные, ИндексРасхода, Регистраторы, Тест);
		
		Если Расходы[ИндексРасхода] <> Неопределено
		 И Расходы[ИндексРасхода][ОписаниеДвижений.БазисРасхода] > 0
		 И Расходы[ИндексРасхода][ОписаниеДвижений.БазисРасхода] <> БазисРасхода Тогда
			ИндексыРасходов.Добавить(ИндексРасхода);
		КонецЕсли;
		
		// Запишем порцию движений в регистр.
		Если Не Тест И РасчетныеПартии.Количество() > 100000 Тогда
			Если ОписаниеДвижений.Свойство("ПоляГруппировки") Тогда
				РасчетныеПартии.Свернуть(ОписаниеДвижений.ПоляГруппировки, ОписаниеДвижений.ПоляСуммирования);
			КонецЕсли;
			УдалитьНезаписываемыеСтроки(ОписаниеДвижений.Контекст, РасчетныеПартии);
			ЗаписатьРасчетныеПартии(РегистрыНакопления[ОписаниеДвижений.ИмяРегистра], РасчетныеПартии, Регистраторы);
			РасчетныеПартии.Очистить();
		КонецЕсли;
	КонецЦикла;

	Для Каждого Строка Из Расходы Цикл
		РасчетнаяПартия = РасчетныеПартии.Добавить();
		ЗаполнитьЗначенияСвойств(РасчетнаяПартия, Строка.Значение);
		Если Не Тест И РасчетныеПартии.Количество() > 100000 Тогда
			Если ОписаниеДвижений.Свойство("ПоляГруппировки") Тогда
				РасчетныеПартии.Свернуть(ОписаниеДвижений.ПоляГруппировки, ОписаниеДвижений.ПоляСуммирования);
			КонецЕсли;
			УдалитьНезаписываемыеСтроки(ОписаниеДвижений.Контекст, РасчетныеПартии);
			ЗаписатьРасчетныеПартии(РегистрыНакопления[ОписаниеДвижений.ИмяРегистра], РасчетныеПартии, Регистраторы);
			РасчетныеПартии.Очистить();
		КонецЕсли;
	КонецЦикла;
	
	Если ОписаниеДвижений.Свойство("ПоляГруппировки") Тогда
		РасчетныеПартии.Свернуть(ОписаниеДвижений.ПоляГруппировки, ОписаниеДвижений.ПоляСуммирования);
	КонецЕсли;
	
	Если КоличествоЗаписей % 10000 <> 0 Тогда
		Комментарий = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
			НСтр("ru = 'Рассчитано: %1 стр., %2 связей';
				|en = 'Calculated: %1 line, %2 links'", ОбщегоНазначения.КодОсновногоЯзыка()),
			ИндексСтроки,
			КоличествоДуг);
		ЗаписьЖурналаРегистрации(
			НСтр("ru = 'Партионный учет.';
				|en = 'Batch accounting.'",	ОбщегоНазначения.КодОсновногоЯзыка()) + ОписаниеДвижений.Контекст,
			УровеньЖурналаРегистрации.Информация,,, Комментарий);
	КонецЕсли;
	
	Выборка = Неопределено;
	Приходы.Очистить();
	Расходы.Очистить();
	СтрокиПриходов.Очистить();
	СтрокиРасходов.Очистить();
	Если Не Тест Тогда
		ЦепочкиДвижений.Очистить();
		СтрокиЦепочек.Очистить();
	КонецЕсли;
	
КонецПроцедуры

//++ НЕ УТ

Процедура РассчитатьПартииПоЦепочкамИзВыборки(ОписаниеДвижений, РезультатЗапроса, РасчетныеПартии, СохраненныеЦепочки, Регистраторы, Тест)
	
	Приходы = Новый Соответствие; // буфер копий партий для покрытия расходов
	Расходы = Новый Соответствие; // буфер не рассчитанных партий для расчета на следующих итерациях
	СтрокиПриходов = РасчетныеПартии.СкопироватьКолонки();
	СтрокиРасходов = РасчетныеПартии.СкопироватьКолонки();
	ПройденныйПуть = Новый Соответствие; // используется для прерывания циклов
	ИндексыРасходов = Новый Массив;
	ЦепочкиДвижений = Новый Соответствие;
	СтрокиЦепочек = Новый ТаблицаЗначений;
	
	ЗаполнятьАналитикуПартий = ОписаниеДвижений.Свойство("ЗаполнятьАналитикуПартий");
	
	Данные = Новый Структура;
	Данные.Вставить("РасчетныеПартии", РасчетныеПартии);
	Данные.Вставить("ЦепочкиДвижений", ЦепочкиДвижений);
	Данные.Вставить("СтрокиЦепочек", СтрокиЦепочек);
	Данные.Вставить("Приходы", Приходы);
	Данные.Вставить("Расходы", Расходы);
	Данные.Вставить("СтрокиПриходов", СтрокиПриходов);
	Данные.Вставить("СтрокиРасходов", СтрокиРасходов);
	Данные.Вставить("ИндексыРасходов", ИндексыРасходов);
	Данные.Вставить("ПройденныйПуть", ПройденныйПуть);
	
	Выборка = РезультатЗапроса.Выбрать();
	КоличествоЗаписей = Выборка.Количество();
	КоличествоСвязей  = КоличествоСвязейМеждуЗаписями(СохраненныеЦепочки);
	
	Комментарий = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
		НСтр("ru = 'К расчету: строк - %1, связей - %2';
			|en = 'For calculation: lines - %1, links - %2'", ОбщегоНазначения.КодОсновногоЯзыка()),
		СокрЛП(КоличествоЗаписей),
		СокрЛП(КоличествоСвязей));
	ЗаписьЖурналаРегистрации(
		НСтр("ru = 'Партионный учет.';
			|en = 'Batch accounting.'",	ОбщегоНазначения.КодОсновногоЯзыка()) + ОписаниеДвижений.Контекст,
		УровеньЖурналаРегистрации.Информация,,, Комментарий);
		
	ИндексСтроки = -1;
	КонечнаяЦепочка = -1;
	КоличествоДуг = 0;
	
	Пока Выборка.Следующий() Цикл
		
		ИндексСтроки = ИндексСтроки + 1;
		Если ИндексСтроки > КонечнаяЦепочка Тогда
			НачальнаяЦепочка = ИндексСтроки;
			КонечнаяЦепочка = КонечнаяЦепочка + 10000;
			КоличествоДуг = ЦепочкиДвиженийПоИндексу(СохраненныеЦепочки, НачальнаяЦепочка, КонечнаяЦепочка, ЦепочкиДвижений, СтрокиЦепочек);
		КонецЕсли;
		
		ЦепочкаДвижений = ЦепочкиДвижений[ИндексСтроки];
		Если ЦепочкаДвижений = Неопределено Тогда
			РасчетнаяПартия = РасчетныеПартии.Добавить();
			ЗаполнитьЗначенияСвойств(РасчетнаяПартия, Выборка);
			Если ЗаполнятьАналитикуПартий И Выборка.ТипЗаписи = "Партия" И Выборка.РасчетЗавершен Тогда
				РасчетнаяПартия.АналитикаУчетаПартий =
					АналитикаУчетаПартий(Выборка.АналитикаУчетаПартий, Выборка.НалогообложениеПартии, Выборка.НалогообложениеНДС);
			КонецЕсли;
		ИначеЕсли Выборка.РасчетЗавершен Тогда
			РасчетнаяПартия = РасчетныеПартии.Добавить();
			ЗаполнитьЗначенияСвойств(РасчетнаяПартия, Выборка);
			Если ЗаполнятьАналитикуПартий И Выборка.ТипЗаписи = "Партия" Тогда
				РасчетнаяПартия.АналитикаУчетаПартий =
					АналитикаУчетаПартий(Выборка.АналитикаУчетаПартий, Выборка.НалогообложениеПартии, Выборка.НалогообложениеНДС);
				Если ЗначениеЗаполнено(Выборка.НалогообложениеПартии) И ЗначениеЗаполнено(Выборка.НалогообложениеНДС) Тогда
					РасчетнаяПартия.НалогообложениеПартии = Выборка.НалогообложениеНДС;
				КонецЕсли;
			КонецЕсли;
			Если ЦепочкаДвижений.Приемники.Количество() > 0 Тогда
				Приход = СтрокиПриходов.Добавить();
				ЗаполнитьЗначенияСвойств(Приход, РасчетнаяПартия);
				ИнвертироватьПоказатели(Приход, ОписаниеДвижений.Показатели, ("Сторно" = Приход.ТипЗаписи ИЛИ "ПартияСторно" = Приход.ТипЗаписи ИЛИ "ОстатокСторно" = Приход.ТипЗаписи));
				Приходы.Вставить(ИндексСтроки, Новый Массив);
				Приходы[ИндексСтроки].Добавить(Приход);
			КонецЕсли;
			ЦепочкиДвижений.Удалить(ИндексСтроки);
			СтрокиЦепочек.Удалить(ЦепочкаДвижений);
		Иначе
			Расход = СтрокиРасходов.Добавить();
			ЗаполнитьЗначенияСвойств(Расход, Выборка);
			Расходы.Вставить(ИндексСтроки, Расход);
			ИндексыРасходов.Добавить(ИндексСтроки);
		КонецЕсли;
		
		// Запишем порцию движений в регистр.
		Если Не Тест И РасчетныеПартии.Количество() > 100000 Тогда
			УдалитьНезаписываемыеСтроки(ОписаниеДвижений.Контекст, РасчетныеПартии);
			ЗаписатьРасчетныеПартии(РегистрыНакопления[ОписаниеДвижений.ИмяРегистра], РасчетныеПартии, Регистраторы);
			РасчетныеПартии.Очистить();
		КонецЕсли;
		
		Если ИндексСтроки > 0 И ИндексСтроки % 10000 = 0 Тогда
			Данные.Вставить("ИндексСтроки", ИндексСтроки);
			Если Приходы.Количество() > 0 Тогда // есть записи по которым расчет завершен
				Пока ИндексыРасходов.Количество() > 0 Цикл
					ИндексРасхода = ИндексыРасходов.Получить(0);
					ИндексыРасходов.Удалить(0);
					Если Расходы[ИндексРасхода] = Неопределено Тогда
						Продолжить; // строка к обсчету НЕ зарегистрирована
					КонецЕсли;
					ПройденныйПуть.Очистить();
					РассчитатьПартиюПоЦепочкеИзВыборки(ОписаниеДвижений, Данные, ИндексРасхода, Регистраторы, Тест);
					
					// Запишем порцию движений в регистр.
					Если Не Тест И РасчетныеПартии.Количество() > 100000 Тогда
						УдалитьНезаписываемыеСтроки(ОписаниеДвижений.Контекст, РасчетныеПартии);
						ЗаписатьРасчетныеПартии(РегистрыНакопления[ОписаниеДвижений.ИмяРегистра], РасчетныеПартии, Регистраторы);
						РасчетныеПартии.Очистить();
					КонецЕсли;
				КонецЦикла;
				
				Для Каждого Элемент Из Расходы Цикл
					ИндексРасхода = Элемент.Ключ;
					ИндексыРасходов.Добавить(ИндексРасхода);
				КонецЦикла;
				Список = Новый СписокЗначений;
				Список.ЗагрузитьЗначения(ИндексыРасходов);
				Список.СортироватьПоЗначению();
				ИндексыРасходов = Список.ВыгрузитьЗначения();
			КонецЕсли;
			
			Комментарий = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
				НСтр("ru = 'Рассчитано: %1 стр., %2 связей';
					|en = 'Calculated: %1 line, %2 links'", ОбщегоНазначения.КодОсновногоЯзыка()),
				ИндексСтроки,
				КоличествоДуг);
			ЗаписьЖурналаРегистрации(
				НСтр("ru = 'Партионный учет.';
					|en = 'Batch accounting.'",	ОбщегоНазначения.КодОсновногоЯзыка()) + ОписаниеДвижений.Контекст,
				УровеньЖурналаРегистрации.Информация,,, Комментарий);
		КонецЕсли;
		
	КонецЦикла;
	
	Если ИндексСтроки > КонечнаяЦепочка Тогда
		НачальнаяЦепочка = ИндексСтроки;
		КонечнаяЦепочка = КонечнаяЦепочка + 10000;
		КоличествоДуг = ЦепочкиДвиженийПоИндексу(СохраненныеЦепочки, НачальнаяЦепочка, КонечнаяЦепочка, ЦепочкиДвижений, СтрокиЦепочек);
	КонецЕсли;
	
	Данные.Вставить("ИндексСтроки", ИндексСтроки);
	Пока ИндексыРасходов.Количество() > 0 Цикл
		ИндексРасхода = ИндексыРасходов.Получить(0);
		ИндексыРасходов.Удалить(0);
		Если Расходы[ИндексРасхода] = Неопределено Тогда
			Продолжить; // строка к обсчету НЕ зарегистрирована
		КонецЕсли;
		ПройденныйПуть.Очистить();
		РассчитатьПартиюПоЦепочкеИзВыборки(ОписаниеДвижений, Данные, ИндексРасхода, Регистраторы, Тест);
		
		// Запишем порцию движений в регистр.
		Если Не Тест И РасчетныеПартии.Количество() > 100000 Тогда
			УдалитьНезаписываемыеСтроки(ОписаниеДвижений.Контекст, РасчетныеПартии);
			ЗаписатьРасчетныеПартии(РегистрыНакопления[ОписаниеДвижений.ИмяРегистра], РасчетныеПартии, Регистраторы);
			РасчетныеПартии.Очистить();
		КонецЕсли;
	КонецЦикла;

	Для Каждого Строка Из Расходы Цикл
		РасчетнаяПартия = РасчетныеПартии.Добавить();
		ЗаполнитьЗначенияСвойств(РасчетнаяПартия, Строка.Значение);
		Если Не Тест И РасчетныеПартии.Количество() > 100000 Тогда
			УдалитьНезаписываемыеСтроки(ОписаниеДвижений.Контекст, РасчетныеПартии);
			ЗаписатьРасчетныеПартии(РегистрыНакопления[ОписаниеДвижений.ИмяРегистра], РасчетныеПартии, Регистраторы);
			РасчетныеПартии.Очистить();
		КонецЕсли;
	КонецЦикла;
	
	Если КоличествоЗаписей % 10000 <> 0 Тогда
		Комментарий = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
			НСтр("ru = 'Рассчитано: %1 стр., %2 связей';
				|en = 'Calculated: %1 line, %2 links'", ОбщегоНазначения.КодОсновногоЯзыка()),
			ИндексСтроки,
			КоличествоДуг);
		ЗаписьЖурналаРегистрации(
			НСтр("ru = 'Партионный учет.';
				|en = 'Batch accounting.'",	ОбщегоНазначения.КодОсновногоЯзыка()) + ОписаниеДвижений.Контекст,
			УровеньЖурналаРегистрации.Информация,,, Комментарий);
	КонецЕсли;
	
	Приходы.Очистить();
	Расходы.Очистить();
	СтрокиПриходов.Очистить();
	СтрокиРасходов.Очистить();
	Если Не Тест Тогда
		ЦепочкиДвижений.Очистить();
		СтрокиЦепочек.Очистить();
	КонецЕсли;
	
КонецПроцедуры
//-- НЕ УТ

Функция РассчитатьПартиюПоЦепочкеИзВыборки(ОписаниеДвижений, Данные, ИндексРасхода, Регистраторы, Тест)
	
	РасчетныеПартии = Данные.РасчетныеПартии;
	ПройденныйПуть = Данные.ПройденныйПуть;
	ЦепочкиДвижений = Данные.ЦепочкиДвижений;
	СтрокиЦепочек = Данные.СтрокиЦепочек;
	ЦепочкаРасхода = ЦепочкиДвижений[ИндексРасхода];
	
	Если ЦепочкаРасхода = Неопределено Тогда
		Возврат "НеТребуется";
	КонецЕсли;
	
	Источники = ЦепочкаРасхода.Источники;
	ЕстьЗацикливание = Ложь;
	Если ИндексРасхода = ПройденныйПуть[ИндексРасхода] Или (Источники.Количество() = 0) Тогда
		ЕстьЗацикливание = Истина;
	КонецЕсли;
	
	ИндексСтроки = Данные.ИндексСтроки;
	Для Каждого ИндексПрихода Из Источники Цикл
		Если ИндексПрихода > ИндексСтроки Тогда
			Возврат "НетДанных"; // еще нет всех строк для распределения
		КонецЕсли;
	КонецЦикла;
	
	ПройденныйПуть.Вставить(ИндексРасхода, ИндексРасхода);
	
	Приходы = Данные.Приходы;
	Расходы = Данные.Расходы;
	СтрокиПриходов = Данные.СтрокиПриходов;
	НовыеПриходы = Неопределено;
	СтрокиРасходов = Данные.СтрокиРасходов;
	
	Расход = Расходы[ИндексРасхода];
	ЭтоСторно = ("Сторно" = Расход.ТипЗаписи ИЛИ "ВозвратСторно" = Расход.ТипЗаписи ИЛИ "СторноПрошлое" = Расход.ТипЗаписи );
	
	БазисПрихода = 0;
	Если ОписаниеДвижений.Свойство("ПоляГруппировки")
	 ИЛИ ЭтоСторно Тогда
		Для Каждого ИндексИсточника Из Источники Цикл
			Если НЕ ЕстьЗацикливание
			 И Данные.Приходы[ИндексИсточника] = Неопределено
			 И Данные.Расходы[ИндексИсточника] <> Неопределено Тогда // данный источник еще не рассчитан
				Результат = РассчитатьПартиюПоЦепочкеИзВыборки(ОписаниеДвижений, Данные, ИндексИсточника, Регистраторы, Тест);
				Если Результат = "НетДанных" Тогда
					Возврат Результат;
				ИначеЕсли Результат = "Зацикливание" Тогда
					БазисПрихода = БазисПрихода + Расходы[ИндексИсточника][ОписаниеДвижений.БазисПрихода];
				КонецЕсли;
				Если Данные.Расходы[ИндексРасхода] = Неопределено Тогда
					Возврат "НеТребуется";
				КонецЕсли;
			ИначеЕсли ЕстьЗацикливание И Данные.Расходы[ИндексИсточника] <> Неопределено Тогда
				БазисПрихода = БазисПрихода + Расходы[ИндексИсточника][ОписаниеДвижений.БазисПрихода];
			КонецЕсли;
		КонецЦикла;
		Если ЭтоСторно Тогда
			СортироватьИсточники(Источники, ОписаниеДвижений.ПолеПорядка, Приходы);
		КонецЕсли;
	КонецЕсли;
	
	Если ЗначениеЗаполнено(ОписаниеДвижений.ПоляСортировки) Тогда
		ЗначенияПолей = Новый Структура(ОписаниеДвижений.ПоляСортировки);
		ЗаполнитьЗначенияСвойств(ЗначенияПолей, Расход);
		ЗаполненыПоляСортировки = Ложь;
		Для Каждого ПолеСортировки Из ЗначенияПолей Цикл
			Если ЗначениеЗаполнено(ПолеСортировки.Значение) Тогда
				ЗаполненыПоляСортировки = Истина;
				Прервать;
			КонецЕсли;
		КонецЦикла;
		ТребуетсяСортировка = Истина;
		Если ЗначениеЗаполнено(ОписаниеДвижений.СортировкаПоУсловию) Тогда
			ТребуетсяСортировка = ТребуетсяСортировка(ОписаниеДвижений.Контекст, Расход); 
		КонецЕсли;
		Если ЗаполненыПоляСортировки И ТребуетсяСортировка Тогда
			СортироватьИсточникиПоЗначениямПолей(Источники, ЗначенияПолей, Приходы);
		КонецЕсли;
	КонецЕсли;
	
	Если ЭтоСторно И ОписаниеДвижений.Контекст = "ПартииПроизводственныхЗатрат" Тогда
		// Сортировка для списания сторно записей в первую очередь.
		СортироватьИсточники(Источники, "Приоритет", Приходы);
	КонецЕсли;
	
	Счетчик = 0;
	ВГраница = Источники.ВГраница();
	РазрывЦикла = Ложь;
	
	УменьшатьБазисРасхода = ОписаниеДвижений.Свойство("УменьшатьБазис");
	
	ИнвертироватьПоказатели(Расход, ОписаниеДвижений.Показатели, ЭтоСторно);
	Пока Счетчик <= ВГраница Цикл
		Если ОписаниеДвижений.Контекст = "ПартииПроизводственныхЗатрат" Тогда
			ИндексИсточника = Источники[Счетчик];
		Иначе
			ИндексИсточника = Источники[?(ЭтоСторно, ВГраница - Счетчик, Счетчик)];
		КонецЕсли;
		Счетчик = Счетчик + 1;
		
		Если ОписаниеДвижений.Контекст = "ПартииТоваровОрганизаций"
		 И Расход.СохранятьРегл
		 И ИндексИсточника = ПройденныйПуть[ИндексИсточника] Тогда
			РазрывЦикла = Истина;
			Продолжить; // данный источник еще рассчитан не до конца
		КонецЕсли;
		
		МассивПриходов = Приходы[ИндексИсточника];
		Если Неопределено = МассивПриходов Тогда
			Если Неопределено = Расходы[ИндексИсточника] Тогда
				Продолжить;
			КонецЕсли;
			Источник = Расходы[ИндексИсточника];
			Если НЕ ЕстьЗацикливание И НЕ Источник.РасчетЗавершен Тогда
				РассчитатьПартиюПоЦепочкеИзВыборки(ОписаниеДвижений, Данные, ИндексИсточника, Регистраторы, Тест);
				ВГраница = Источники.ВГраница();
				Если Данные.Расходы[ИндексРасхода] = Неопределено Тогда
					Возврат "НеТребуется";
				КонецЕсли;
				МассивПриходов = Приходы[ИндексИсточника];
				Если Неопределено = МассивПриходов Тогда
					Продолжить;
				КонецЕсли;
			Иначе
				МассивПриходов = Приходы[ИндексИсточника];
				Если Неопределено = МассивПриходов Тогда
					Продолжить;
				КонецЕсли;
			КонецЕсли;
		КонецЕсли;
		
		Если ЭтоСторно Тогда
			СортироватьПриходыПоЛИФО(ОписаниеДвижений.ПолеПорядка, МассивПриходов);
		КонецЕсли;
		
		УменьшениеБазисаРасхода = 0;
		
		ПриходыКУдалению = Новый Массив;
		Для Каждого Приход Из МассивПриходов Цикл
			
			Если УменьшатьБазисРасхода
			 И УменьшениеБазисаРасхода = 0
			 И Расход.ТипЗаписи = "Сторно"
			 И Приход.ТипЗаписи <> "Прошлое" Тогда
				УменьшениеБазисаРасхода = Мин(Расход[ОписаниеДвижений.БазисРасхода], Приход[ОписаниеДвижений.БазисРасхода]);
			КонецЕсли;
			
			РасчетнаяПартия = РасчетныеПартии.Добавить();
			ЗаполнитьРасчетнуюПартию(ОписаниеДвижений.Контекст, РасчетнаяПартия, Расход, Приход);
			ИнвертироватьПоказатели(РасчетнаяПартия, ОписаниеДвижений.Показатели, ЭтоСторно);
			
			Если Приход[ОписаниеДвижений.БазисПрихода] <= 0 Тогда
				ПриходыКУдалению.Добавить(Приход);
			КонецЕсли;
			
			Если РасчетнаяПартия.РасчетЗавершен Тогда
				Если ЦепочкаРасхода.Приемники.Количество() > 0 Тогда
					Если ОписаниеДвижений.Свойство("ПоляГруппировки") Тогда
						Если НовыеПриходы = Неопределено Тогда
							НовыеПриходы = СтрокиПриходов.СкопироватьКолонки();
						КонецЕсли;
						НовыйПриход = НовыеПриходы.Добавить();
						ЗаполнитьЗначенияСвойств(НовыйПриход, РасчетнаяПартия);
						ИнвертироватьПоказатели(НовыйПриход, ОписаниеДвижений.Показатели,
							("Сторно" = НовыйПриход.ТипЗаписи ИЛИ "ВозвратСторно" = НовыйПриход.ТипЗаписи ИЛИ "СторноПрошлое" = НовыйПриход.ТипЗаписи));
					Иначе
						НовыйПриход = СтрокиПриходов.Добавить();
						ЗаполнитьЗначенияСвойств(НовыйПриход, РасчетнаяПартия);
						ИнвертироватьПоказатели(НовыйПриход, ОписаниеДвижений.Показатели,
							("Сторно" = НовыйПриход.ТипЗаписи ИЛИ "ВозвратСторно" = НовыйПриход.ТипЗаписи ИЛИ "СторноПрошлое" = НовыйПриход.ТипЗаписи));
						Если Приходы[ИндексРасхода] = Неопределено Тогда
							Приходы.Вставить(ИндексРасхода, Новый Массив);
						КонецЕсли;
						Приходы[ИндексРасхода].Добавить(НовыйПриход);
					КонецЕсли;
				КонецЕсли;
			Иначе
				РасчетныеПартии.Удалить(РасчетнаяПартия);
			КонецЕсли;
						
			// Запишем порцию движений в регистр.
			Если Не Тест И РасчетныеПартии.Количество() > 100000 Тогда
				Если ОписаниеДвижений.Свойство("ПоляГруппировки") Тогда
					РасчетныеПартии.Свернуть(ОписаниеДвижений.ПоляГруппировки, ОписаниеДвижений.ПоляСуммирования);
				КонецЕсли;
				УдалитьНезаписываемыеСтроки(ОписаниеДвижений.Контекст, РасчетныеПартии);
				ЗаписатьРасчетныеПартии(РегистрыНакопления[ОписаниеДвижений.ИмяРегистра], РасчетныеПартии, Регистраторы);
				РасчетныеПартии.Очистить();
			КонецЕсли;
			Если Расход[ОписаниеДвижений.БазисРасхода] <= 0 Тогда
				Прервать;
			КонецЕсли;
		КонецЦикла;
		
		Если УменьшатьБазисРасхода
		 И УменьшениеБазисаРасхода <> 0 Тогда
			Расход[ОписаниеДвижений.БазисРасхода] = Расход[ОписаниеДвижений.БазисРасхода] - УменьшениеБазисаРасхода;
		КонецЕсли;
		
		Для Каждого Приход Из ПриходыКУдалению Цикл
			Индекс = МассивПриходов.Найти(Приход);
			Если Индекс <> Неопределено Тогда
				МассивПриходов.Удалить(Индекс);
			КонецЕсли;
			СтрокиПриходов.Удалить(Приход);
		КонецЦикла;
		Если МассивПриходов.Количество() = 0 Тогда
			Приходы.Удалить(ИндексИсточника);
			Если Расходы[ИндексИсточника] = Неопределено Тогда
				ЦепочкаПрихода = ЦепочкиДвижений[ИндексИсточника];
				Если ЦепочкаПрихода <> Неопределено Тогда
					ЦепочкиДвижений.Удалить(ИндексИсточника);
					СтрокиЦепочек.Удалить(ЦепочкаПрихода);
				КонецЕсли;
			КонецЕсли;
		ИначеЕсли ПриходыКУдалению.Количество() > 0 Тогда
			Приходы.Вставить(ИндексИсточника, МассивПриходов);
		КонецЕсли;
		Если Расход[ОписаниеДвижений.БазисРасхода] <= 0 Тогда
			Прервать;
		КонецЕсли;
	КонецЦикла;
	БазисРасхода = 0;
	Если ОписаниеДвижений.Свойство("ПоляГруппировки")
	 И НовыеПриходы <> Неопределено
	 И НовыеПриходы.Количество() > 0 Тогда
		НовыеПриходы.Свернуть(ОписаниеДвижений.ПоляГруппировки, ОписаниеДвижений.ПоляСуммирования);
		Если Приходы[ИндексРасхода] = Неопределено Тогда
			Приходы.Вставить(ИндексРасхода, Новый Массив);
		КонецЕсли;
		Для Каждого Строка Из НовыеПриходы Цикл
			НовыйПриход = СтрокиПриходов.Добавить();
			ЗаполнитьЗначенияСвойств(НовыйПриход, Строка);
			Если НовыйПриход[ОписаниеДвижений.БазисРасхода] = 0 Тогда
				НовыйПриход[ОписаниеДвижений.БазисРасхода] = Расход[ОписаниеДвижений.БазисРасхода];
			КонецЕсли;
			Приходы[ИндексРасхода].Добавить(НовыйПриход);
			Если БазисРасхода < НовыйПриход[ОписаниеДвижений.БазисРасхода] Тогда
				БазисРасхода = НовыйПриход[ОписаниеДвижений.БазисРасхода];
			КонецЕсли;
		КонецЦикла;
		НовыеПриходы = Неопределено;
	КонецЕсли;
	Если ОписаниеДвижений.Свойство("ПоляГруппировки") Тогда
		Если Расход.ТипЗаписи = "Перемещение" И БазисПрихода <> 0 Тогда
			Расход[ОписаниеДвижений.БазисРасхода] = БазисПрихода;
		ИначеЕсли БазисРасхода > 0 И Расход[ОписаниеДвижений.БазисРасхода] - БазисРасхода > 0 Тогда
			Расход[ОписаниеДвижений.БазисРасхода] = Расход[ОписаниеДвижений.БазисРасхода] - БазисРасхода;	
		Иначе
			Расход[ОписаниеДвижений.БазисРасхода] = 0;
		КонецЕсли;
	КонецЕсли;
	
	Если Расход[ОписаниеДвижений.БазисРасхода] > 0 Тогда
		ИнвертироватьПоказатели(Расход, ОписаниеДвижений.Показатели,
			("Сторно" = Расход.ТипЗаписи ИЛИ "ВозвратСторно" = Расход.ТипЗаписи ИЛИ "СторноПрошлое" = Расход.ТипЗаписи));
		Если ОписаниеДвижений.Контекст = "ПартииТоваровОрганизаций"
		 И РазрывЦикла
		 И Расход.СохранятьРегл Тогда
		 	Расход.РасчетЗавершен = Истина;
		 	НоваяПартия = РасчетныеПартии.Добавить();
			ЗаполнитьЗначенияСвойств(НоваяПартия, Расход);
			Если ЦепочкаРасхода <> Неопределено
			 И ЦепочкаРасхода.Приемники.Количество() > 0 Тогда
				Приход = СтрокиПриходов.Добавить();
				ЗаполнитьЗначенияСвойств(Приход, НоваяПартия);
				ИнвертироватьПоказатели(Приход, ОписаниеДвижений.Показатели, ("Сторно" = Приход.ТипЗаписи));
				Если Приходы[ИндексРасхода] = Неопределено Тогда
					Приходы.Вставить(ИндексРасхода, Новый Массив);
				КонецЕсли;
				Приходы[ИндексРасхода].Добавить(Приход);
			КонецЕсли;
			Расходы.Удалить(ИндексРасхода);
			СтрокиРасходов.Удалить(Расход);
		КонецЕсли;
	Иначе
		Расходы.Удалить(ИндексРасхода);
		ЦепочкиДвижений.Удалить(ИндексРасхода);
		СтрокиРасходов.Удалить(Расход);
		СтрокиЦепочек.Удалить(ЦепочкаРасхода);
	КонецЕсли;
	
	Возврат "Выполнено";
	
КонецФункции

#КонецОбласти


#Область ОчисткаДвиженийРегистров

Процедура ОчиститьРегистрНаСервере(Регистраторы, ИмяРегистра, РегистраторыССохраняемымиДвижениями = Неопределено)
	
	Если ТестированиеБезЗаписи() Тогда
		Возврат;
	КонецЕсли;
	
	НачалоЗамера = ТекущаяУниверсальнаяДатаВМиллисекундах();
	
	Для Каждого Элемент Из Регистраторы Цикл 
		
		Если РегистраторыССохраняемымиДвижениями <> Неопределено
		 И РегистраторыССохраняемымиДвижениями.Получить(Элемент.Ключ) <> Неопределено Тогда
			// При восстановлении сохраненных движений надо удалять устаревшие движения
			РегистраторыССохраняемымиДвижениями.Вставить(Элемент.Ключ, Истина);
			Продолжить;
		КонецЕсли;

		Движения = РегистрыНакопления[ИмяРегистра].СоздатьНаборЗаписей();
		Движения.Отбор.Регистратор.Установить(Элемент.Ключ);
		Движения.Записать();
		
	КонецЦикла;
	
	Замер = ТекущаяУниверсальнаяДатаВМиллисекундах() - НачалоЗамера;
	Комментарий = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
		НСтр("ru = 'Очистка устаревших движений: %1 док., длительность: %2 сек.';
			|en = 'Clear obsolete records: %1 doc., duration: %2 sec.'"),
		СокрЛП(Регистраторы.Количество()),
		СокрЛП(Замер/1000));
	ЗаписьЖурналаРегистрации(
		НСтр("ru = 'Партионный учет.ОчиститьРегистрНаСервере';
			|en = 'Batch accounting.ОчиститьРегистрНаСервере'", ОбщегоНазначения.КодОсновногоЯзыка()),
		УровеньЖурналаРегистрации.Информация,,, Комментарий);
	
КонецПроцедуры

#КонецОбласти

// Вспомогательные универсальные методы
#Область СлужебныеПроцедурыИФункции

Функция ПоляЗаписейРавны(Запись1, Запись2, ПереченьКлючей)
	Если Неопределено = Запись1 Или Неопределено = Запись2 Тогда
		Возврат (Запись1 = Запись2);
	КонецЕсли;
	
	Для Каждого Поле Из Новый Структура(ПереченьКлючей) Цикл
		Если Запись1[Поле.Ключ] <> Запись2[Поле.Ключ] Тогда
			Возврат Ложь;
		КонецЕсли;
	КонецЦикла;
	
	Возврат Истина;
КонецФункции

Функция КопияЗаписиСтруктурой(Запись, ПереченьПолей)
	КопияСтрокиСтруктурой = Новый Структура(ПереченьПолей);
	ЗаполнитьЗначенияСвойств(КопияСтрокиСтруктурой, Запись);
	Возврат КопияСтрокиСтруктурой;
КонецФункции

Процедура ИнвертироватьПоказатели(Запись, ПереченьПоказателей, Инвертировать)
	Если Не Инвертировать Тогда
		Возврат;
	КонецЕсли;
	Для Каждого Поле Из Новый Структура(ПереченьПоказателей) Цикл
		Запись[Поле.Ключ] = -Запись[Поле.Ключ];
	КонецЦикла;
КонецПроцедуры

Функция СкопироватьКолонки(КолонкиИсточника, КолонкиПриемника)
	ПоляИсточника = "";
	Для Каждого Колонка Из КолонкиИсточника Цикл
		КолонкиПриемника.Добавить(Колонка.Имя, Колонка.ТипЗначения);
		ПоляИсточника = ПоляИсточника + ?(ЗначениеЗаполнено(ПоляИсточника), ", ", "") + Колонка.Имя;
	КонецЦикла;
	Возврат ПоляИсточника;
КонецФункции

Функция ПереченьПолей(КоллекцияКолонок, Исключения = "")
	ИсключаемыеПоля = Новый Структура(Исключения);
	ПереченьПолей = "";
	Для Каждого Колонка Из КоллекцияКолонок Цикл
		Если НЕ ИсключаемыеПоля.Свойство(Колонка.Имя) Тогда
			ПереченьПолей = ПереченьПолей + ?(ЗначениеЗаполнено(ПереченьПолей), ", ", "") + Колонка.Имя;
		КонецЕсли;
	КонецЦикла;
	Возврат ПереченьПолей;
КонецФункции

Функция ПустаяСсылка(Ссылка, КэшСсылок)
	Результат = КэшСсылок[ТипЗнч(Ссылка)];
	Если Результат = Неопределено Тогда
		МенеджерОбъекта = ОбщегоНазначения.МенеджерОбъектаПоСсылке(Ссылка);
		Если МенеджерОбъекта = Неопределено Тогда
			Возврат Неопределено;
		КонецЕсли;
		Результат = МенеджерОбъекта.ПустаяСсылка();
		КэшСсылок.Вставить(ТипЗнч(Ссылка), Результат);
	КонецЕсли;
	Возврат Результат;
КонецФункции

Функция УзелИндекса(Индекс, КлючиИндекса)
	УзелИндекса = Индекс;
	Счетчик = 0;
	Пока Счетчик <= КлючиИндекса.ВГраница() И КлючиИндекса[Счетчик] <> Неопределено Цикл
		УзелИндекса = УзелИндекса[КлючиИндекса[Счетчик]];
		Если УзелИндекса = Неопределено Тогда
			Возврат Неопределено;
		КонецЕсли;
		Счетчик = Счетчик + 1;
	КонецЦикла;
	Возврат УзелИндекса;
КонецФункции

Функция ДобавитьУзелИндекса(Индекс, КлючиИндекса, Значение)
	ВГраница = КлючиИндекса.ВГраница();
	Если ВГраница < 0 Или КлючиИндекса[0] = Неопределено Тогда
		Возврат Неопределено;
	КонецЕсли;
	УзелИндекса = Индекс;
	Счетчик = 0;
	Пока Счетчик < ВГраница Цикл
		ПодузелИндекса = УзелИндекса[КлючиИндекса[Счетчик]];
		Если ПодузелИндекса = Неопределено Тогда
			ПодузелИндекса = Новый Соответствие;
			УзелИндекса.Вставить(КлючиИндекса[Счетчик], ПодузелИндекса);
		КонецЕсли;
		УзелИндекса = ПодузелИндекса;
		Счетчик = Счетчик + 1;
		Если КлючиИндекса[Счетчик] = Неопределено Тогда
			Возврат Неопределено;
		КонецЕсли;
	КонецЦикла;
	УзелИндекса.Вставить(КлючиИндекса[Счетчик], Значение);
	Возврат Значение;
КонецФункции

Функция АналитикаУчетаПартий(СтараяАналитика, НалогообложениеПартии, НалогообложениеНДС)
	
	Если ЗначениеЗаполнено(СтараяАналитика) И ТипЗнч(СтараяАналитика) = Тип("СправочникСсылка.КлючиАналитикиУчетаПартий")
	 И ЗначениеЗаполнено(НалогообложениеПартии) И ЗначениеЗаполнено(НалогообложениеНДС)
	 И НалогообложениеПартии <> НалогообложениеНДС Тогда
	 
		РеквизитыНовойАналитики = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(
			СтараяАналитика,
			"Поставщик, Контрагент, СтавкаНДС, ВидЦенности");
		
		РеквизитыНовойАналитики.Вставить("НалогообложениеНДС", НалогообложениеНДС); // новое налогообложение
		РеквизитыНовойАналитики.Вставить("Дата", Дата(1, 1, 1)); // для того, чтобы режим ПУ точно определился как "не равен ПУ 2.2"
		
		НоваяАналитика = Справочники.КлючиАналитикиУчетаПартий.ПолучитьКлючАналитики(РеквизитыНовойАналитики);
		
	Иначе
		
		НоваяАналитика = СтараяАналитика;
		
	КонецЕсли;
	
	Возврат НоваяАналитика;
	
КонецФункции

#КонецОбласти

#КонецОбласти
