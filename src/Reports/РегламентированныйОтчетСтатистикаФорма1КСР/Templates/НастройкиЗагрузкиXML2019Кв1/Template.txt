// Область "Настройки" описывает параметры инициализации механизма загрузки
// регламентированных отчетов из файлов выгрузки. Формат области настроек - JSON.
//
// Описание параметров:
// * Установкой параметра "РазрешитьЗагрузку" в "true" или "false" регулируем видимость
//    кнопки "Загрузить" и возможность загрузки из файла в форме отчета.
// * Параметр "ФорматыСхемВыгрузки" описывает соответствие имен макетов схем выгрузки
//   поддерживаемым форматам загрузки. Если у формы единственная схема выгрузки или
//   нужно всегда использовать схему по умолчанию - указываем значение "null".
// * Параметр "ОбластиОбработчиков" содержит список имен используемых обработчиков
//    загружаемых данных. Имена соответствуют областям макета, в которых можно размещать
//    произвольные алгоритмы на языке "1С:Предприятие" для обработки доступных объектов.
//
// Примечание:
// Сопоставление имен узлов из файла XML и имен показателей отчета выполняется по данным схемы выгрузки,
// поэтому обработчики используются для получения значений показателей, не описанных в схеме выгрузки.
//
#Область Настройки
{
	"РазрешитьЗагрузку"   : true,
	
	"ФорматыСхемВыгрузки" : null,
	"ОбластиОбработчиков" : {
		"ПередЗагрузкой"  : "ПредОбработкаСхемыЗагрузки",
		"ПослеЗагрузки"   : "ПостОбработкаДокументаОтчета",
	}
}
#КонецОбласти

#Область ПредОбработкаСхемыЗагрузки
	
	НайденныеСтроки = П.ДеревоДляЗагрузки.Строки.НайтиСтроки(Новый Структура("Ключ", "П003000100005"), Истина);
	УдаляемыйУзел = НайденныеСтроки[0].Родитель;
	УдаляемыйУзел.Родитель.Строки.Удалить(УдаляемыйУзел);
	
	НайденныеСтроки = П.ДеревоДляЗагрузки.Строки.НайтиСтроки(Новый Структура("Ключ", "П003000100002"), Истина);
	Для Каждого СтрокаДерева Из НайденныеСтроки Цикл
		СтрокаДерева.ЗначениеПоУмолчанию = "";
	КонецЦикла;
	
	ПрототипДобавляемогоУзла = НайденныеСтроки[0].Родитель;
	ПрототипДобавляемогоУзла.Многострочность = Ложь;
	ПрототипДобавляемогоУзла.Обязательность  = "НП";
	
	ПрототипДобавляемогоУзла = НайденныеСтроки[0].Родитель;
	Для НомУзла = 2 По 999 Цикл
		НовыйУзелИзПрототипа = СкопированныйУзел(ПрототипДобавляемогоУзла.Родитель, ПрототипДобавляемогоУзла);
	КонецЦикла;
	
#КонецОбласти

#Область ПостОбработкаДокументаОтчета
	
	ДанныеРаздела = Неопределено;
	
	П.ДанныеОтчета.ПоказателиОтчета.Свойство("ПолеТабличногоДокументаФормаОтчета", ДанныеРаздела);
	
	Если ДанныеРаздела <> Неопределено Тогда
		
		Для ПозПоказателя = 101 По 127 Цикл
			КодПоказателя = "П01" + Формат(ПозПоказателя, "ЧГ=");
			ЗнчПоказателя = "";
			Если ДанныеРаздела.Свойство(КодПоказателя, ЗнчПоказателя) И ЗнчПоказателя <> "1" Тогда
				ДанныеРаздела[КодПоказателя] = "";
			КонецЕсли;
		КонецЦикла;
		
		НомерЗагруженнойСтроки = 0; ИндСтроки = 0;
		НайденныеСтроки1 = П.ДеревоДляЗагрузки.Строки.НайтиСтроки(Новый Структура("Ключ", "П003000100002"), Истина);
		КоличествоСтрок = НайденныеСтроки1.Количество();
		КоличествоСлева = КоличествоСтрок - Цел(КоличествоСтрок / 2);
		Для Каждого СтрокаДерева Из НайденныеСтроки1 Цикл
			
			Знач1 = ""; Знач2 = ""; Знач3 = 0;
			
			РодительСтрокиДерева = СтрокаДерева.Родитель;
			НайденныеСтроки2 = РодительСтрокиДерева.Строки.НайтиСтроки(Новый Структура("Ключ", "П003000100003"));
			
			Знач2 = СокрЛП(СтрокаДерева.Значение);
			Если Знач2 = "0" Тогда
				Знач2 = "";
			КонецЕсли;
			
			Если ЗначениеЗаполнено(НайденныеСтроки2) Тогда
				Знач3 = Число(" " + НайденныеСтроки2[0].Значение);
			КонецЕсли;
			
			Если НЕ ЗначениеЗаполнено(Знач2) И Знач3 = 0 Тогда
				Продолжить;
			КонецЕсли;
			
			НомерЗагруженнойСтроки = НомерЗагруженнойСтроки + 1;
			
			ИндСтроки = ИндСтроки + 1;
			Суффикс = "_" + Формат(ИндСтроки, "ЧГ=");
			
			Если НомерЗагруженнойСтроки <= КоличествоСлева Тогда
				ДанныеРаздела.Вставить("П003000100001" + Суффикс, Знач1);
				ДанныеРаздела.Вставить("П003000100002" + Суффикс, Знач2);
				ДанныеРаздела.Вставить("П003000100003" + Суффикс, Знач3);
				Если НомерЗагруженнойСтроки = КоличествоСлева Тогда
					ИндСтроки = 0;
				КонецЕсли;
			Иначе
				ДанныеРаздела.Вставить("П003000100004" + Суффикс, Знач1);
				ДанныеРаздела.Вставить("П003000100005" + Суффикс, Знач2);
				ДанныеРаздела.Вставить("П003000100006" + Суффикс, Знач3);
			КонецЕсли;
			
		КонецЦикла;
		
	КонецЕсли;
	
#КонецОбласти