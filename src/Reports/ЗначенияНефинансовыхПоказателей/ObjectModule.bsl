#Если Сервер Или ТолстыйКлиентОбычноеПриложение Или ВнешнееСоединение Тогда

#Область СлужебныйПрограммныйИнтерфейс

// Настройки общей формы отчета подсистемы "Варианты отчетов".
//
// Параметры:
//   Форма - ФормаКлиентскогоПриложения - Форма отчета.
//   КлючВарианта - Строка - Имя предопределенного варианта отчета или уникальный идентификатор пользовательского.
//   Настройки - См. ОтчетыКлиентСервер.ПолучитьНастройкиОтчетаПоУмолчанию
//
Процедура ОпределитьНастройкиФормы(Форма, КлючВарианта, Настройки) Экспорт
	Настройки.События.ПриСозданииНаСервере = Истина;
	Настройки.События.ПередЗагрузкойВариантаНаСервере = Истина;
	Настройки.События.ПриЗагрузкеВариантаНаСервере = Истина;
КонецПроцедуры

// Вызывается в обработчике одноименного события формы отчета после выполнения кода формы.
//
// Параметры:
//   ЭтаФорма - ФормаКлиентскогоПриложения - Форма отчета.
//   Отказ - Булево - Передается из параметров обработчика "как есть".
//   СтандартнаяОбработка - Булево - Передается из параметров обработчика "как есть".
//
// См. также:
//   "ФормаКлиентскогоПриложения.ПриСозданииНаСервере" в синтакс-помощнике.
//
Процедура ПриСозданииНаСервере(ЭтаФорма, Отказ, СтандартнаяОбработка) Экспорт
	
	Параметры = ЭтаФорма.Параметры;
	
	Если Параметры.Свойство("ПараметрКоманды") И ЗначениеЗаполнено(Параметры.ПараметрКоманды) Тогда
		
		РеквизитыПоказателя = ОбщегоНазначенияУТВызовСервера.ЗначенияРеквизитовОбъекта(
				Параметры.ПараметрКоманды, "ЭтоГруппа, Периодичность, УстанавливатьЗначениеНаКаждыйПериод, ПоПериодам");
		
		Если РеквизитыПоказателя.ЭтоГруппа Тогда
			Отказ = Истина;
			Возврат;
		КонецЕсли;
		
		Если РеквизитыПоказателя.УстанавливатьЗначениеНаКаждыйПериод ИЛИ РеквизитыПоказателя.ПоПериодам Тогда
			Периодичность = РеквизитыПоказателя.Периодичность;
		Иначе
			Периодичность = ПредопределенноеЗначение("Перечисление.Периодичность.Месяц");
		КонецЕсли;
		
		ЭтаФорма.ФормаПараметры.Отбор.Вставить("НефинансовыйПоказатель", Параметры.ПараметрКоманды);
		ЭтаФорма.ФормаПараметры.Отбор.Вставить("Периодичность", Периодичность);
	КонецЕсли;
	
КонецПроцедуры

// Вызывается в одноименном обработчике формы отчета после выполнения кода формы.
//
// Подробнее - см. ОтчетыПереопределяемый.ПередЗагрузкойВариантаНаСервере
//
Процедура ПередЗагрузкойВариантаНаСервере(ЭтаФорма, НовыеНастройкиКД) Экспорт
	
	
	Отчет = ЭтаФорма.Отчет;
	КомпоновщикНастроекФормы = Отчет.КомпоновщикНастроек;
	Если Не КомпоновщикНастроекФормы.Настройки.ДополнительныеСвойства.Свойство("КлючТекущегоВарианта") Тогда
		КомпоновщикНастроекФормы.Настройки.ДополнительныеСвойства.Вставить("КлючТекущегоВарианта", ЭтаФорма.КлючТекущегоВарианта);
	КонецЕсли;
	НовыеНастройкиКД = КомпоновщикНастроекФормы.Настройки;
	

КонецПроцедуры

// Вызывается в одноименном обработчике формы отчета после выполнения кода формы.
//
Процедура ПриЗагрузкеВариантаНаСервере(ЭтаФорма, НовыеНастройкиКД) Экспорт
	
	КомпоновщикНастроекФормы = ЭтаФорма.Отчет.КомпоновщикНастроек; // КомпоновщикНастроекКомпоновкиДанных - 
	
	Если ЭтаФорма.КлючТекущегоВарианта = "Расшифровка" Тогда
		
		ФиксированныеНастройки = КомпоновщикНастроекФормы.ФиксированныеНастройки;
		
		ИсточникДобавления = ФиксированныеНастройки.Структура;
		МестоДобавления = КомпоновщикНастроекФормы.Настройки.Структура;
		МестоДобавления.Очистить();
		
		Пока ИсточникДобавления.Количество() Цикл
			Группировка = ИсточникДобавления[0];
			НоваяГруппировка = ФинансоваяОтчетностьСервер.НоваяГруппировка(МестоДобавления, Группировка.Имя,, Ложь);
			Для каждого ПолеГруппировки Из Группировка.ПоляГруппировки.Элементы Цикл
				ФинансоваяОтчетностьСервер.НовоеПолеГруппировки(
					НоваяГруппировка,
					Строка(ПолеГруппировки.Поле));
			КонецЦикла;
			МестоДобавления = НоваяГруппировка.Структура;
			ИсточникДобавления = Группировка.Структура;
		КонецЦикла;
		
		Если ФиксированныеНастройки.Выбор.Элементы.Количество() > 0 Тогда
			КомпоновкаДанныхКлиентСервер.СкопироватьЭлементы(КомпоновщикНастроекФормы.Настройки.Выбор,
					ФиксированныеНастройки.Выбор,
					Истина);
		КонецЕсли;
		КомпоновщикНастроекФормы.Настройки.ДополнительныеСвойства.Вставить("КлючТекущегоВарианта", "Расшифровка");
		КомпоновщикНастроекФормы.Настройки.ПараметрыДанных.УстановитьЗначениеПараметра("РежимРасшифровки", Истина);
		
	Иначе
		
		КомпоновщикНастроекФормы.Настройки.ПараметрыДанных.УстановитьЗначениеПараметра("РежимРасшифровки", ЭтаФорма.РежимРасшифровки);
		
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиСобытий

Процедура ПриКомпоновкеРезультата(ДокументРезультат, ДанныеРасшифровки, СтандартнаяОбработка)
	
	Если Не ПроверитьЗаполнение() Тогда
		Возврат;
	КонецЕсли;
	
	СтандартнаяОбработка = Ложь;
	
	НастройкиОтчета = КомпоновщикНастроек.ПолучитьНастройки(); // НастройкиКомпоновкиДанных -
	
	БюджетированиеСервер.ДополнитьСКДАналитикойПоВиду(СхемаКомпоновкиДанных, "НефинансовыйПоказатель");
	
	БюджетированиеСервер.ДополнитьСКДВыражениямиПредставленияАналитики(СхемаКомпоновкиДанных,
			"НаборыДанных.ЗначенияНефинансовыхПоказателей.Поля",
			"НефинансовыйПоказатель");
	
	Параметры = ПараметрыПолученияЗначенийНефинансовыхПоказателей(НастройкиОтчета);
	ЗначенияНефинансовыхПоказателей = БюджетированиеСервер.ЗначенияНефинансовыхПоказателей(НастройкиОтчета, Параметры);
	ЗначенияНефинансовыхПоказателей.Сортировать("ПериодУстановки, ЗначениеПоказателя УБЫВ");
	
	НастроитьДополнениеПериода(НастройкиОтчета);
	ДобавитьРесурсыПоСценариям(ЗначенияНефинансовыхПоказателей, НастройкиОтчета);
	
	ВнешниеНаборы = Новый Структура;
	ВнешниеНаборы.Вставить("ЗначенияНефинансовыхПоказателей", ЗначенияНефинансовыхПоказателей);
	
	КомпоновщикМакета = Новый КомпоновщикМакетаКомпоновкиДанных;
	МакетКомпоновки = КомпоновщикМакета.Выполнить(СхемаКомпоновкиДанных, НастройкиОтчета, ДанныеРасшифровки);
	
	ПроцессорКомпоновкиДанных = Новый ПроцессорКомпоновкиДанных;
	ПроцессорКомпоновкиДанных.Инициализировать(МакетКомпоновки, ВнешниеНаборы, ДанныеРасшифровки, Истина);
	
	ПроцессорВыводаВТабличныйДокумент = Новый ПроцессорВыводаРезультатаКомпоновкиДанныхВТабличныйДокумент;
	ПроцессорВыводаВТабличныйДокумент.УстановитьДокумент(ДокументРезультат);
	ПроцессорВыводаВТабличныйДокумент.Вывести(ПроцессорКомпоновкиДанных);
	
	ОтчетПустой = ОтчетыСервер.ОтчетПустой(ЭтотОбъект, ПроцессорКомпоновкиДанных);
	КомпоновщикНастроек.ПользовательскиеНастройки.ДополнительныеСвойства.Вставить("ОтчетПустой", ОтчетПустой);
	
КонецПроцедуры

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

Функция ПараметрыПолученияЗначенийНефинансовыхПоказателей(НастройкиОтчета)
	
	Параметры = БюджетированиеСервер.ШаблонПараметровПолученияЗначенийНефинансовыхПоказателей();
	
	Параметры.Период = КомпоновкаДанныхКлиентСервер.ПолучитьПараметр(НастройкиОтчета, "Период").Значение; 
	Параметры.Периодичность = КомпоновкаДанныхКлиентСервер.ПолучитьПараметр(НастройкиОтчета, "Периодичность").Значение;
	Параметры.ПоОрганизациям = Истина;
	Параметры.ПоПодразделениям = Истина;
	Параметры.Вставить("ВалютаОтчета", Параметры.ВалютаУпр);
	
	Возврат Параметры; 
	
КонецФункции

Процедура НастроитьДополнениеПериода(НастройкиОтчета) 
	
	Периодичность = КомпоновкаДанныхКлиентСервер.ПолучитьПараметр(НастройкиОтчета, "Периодичность").Значение;
	
	Если Не ЗначениеЗаполнено(Периодичность) Тогда
		Возврат;
	КонецЕсли;
	
	СтрокаПериодичность = ОбщегоНазначения.ИмяЗначенияПеречисления(Периодичность);
	ТипДополнения = ТипДополненияПериодаКомпоновкиДанных[СтрокаПериодичность];
	
	Период = КомпоновкаДанныхКлиентСервер.ПолучитьПараметр(НастройкиОтчета, "Период").Значение; // СтандартныйПериод -
	ПолеПериод = Новый ПолеКомпоновкиДанных("Период");
	
	Для каждого ЭлементСтруктуры Из НастройкиОтчета.Структура Цикл
		Группировки = КомпоновкаДанныхКлиентСервер.ПолучитьГруппировки(ЭлементСтруктуры);
		Для каждого Группировка Из Группировки Цикл
			ГруппировкаКомпоновки = Группировка.Значение; // ГруппировкаКомпоновкиДанных, ГруппировкаТаблицыКомпоновкиДанных -
			ЭлементыГруппировки = ГруппировкаКомпоновки.ПоляГруппировки.Элементы;
			Если ЭлементыГруппировки.Количество() = 1 И ЭлементыГруппировки[0].Поле = ПолеПериод Тогда
				ГруппировкаПериод = ЭлементыГруппировки[0];
				ГруппировкаПериод.ТипДополнения = ТипДополнения;
				ГруппировкаПериод.НачалоПериода = Период.ДатаНачала;
				ГруппировкаПериод.КонецПериода = Период.ДатаОкончания;
			КонецЕсли;
		КонецЦикла;
	КонецЦикла;
	
КонецПроцедуры

Процедура ДобавитьРесурсыПоСценариям(ЗначенияНефинансовыхПоказателей, НастройкиОтчета)
	
	МаксимальноеКоличествоАналитик = БюджетированиеКлиентСервер.МаксимальноеКоличествоАналитик();
	
	Группировки = Новый Массив;
	Группировки.Добавить("НефинансовыйПоказатель");
	Группировки.Добавить("Организация");
	Группировки.Добавить("Подразделение");
	Для НомерАналитики = 1 По МаксимальноеКоличествоАналитик Цикл
		Группировки.Добавить("Аналитика" + НомерАналитики);
	КонецЦикла;
	Группировки.Добавить("Сценарий");
	Группировки.Добавить("Регистратор");
	
	РежимРасшифровки = Ложь;
	ПараметрРежимРасшифровки = Новый ПараметрКомпоновкиДанных("РежимРасшифровки");
	ПараметрРежимРасшифровки = НастройкиОтчета.ПараметрыДанных.НайтиЗначениеПараметра(ПараметрРежимРасшифровки);
	Если НЕ ПараметрРежимРасшифровки = Неопределено Тогда
		РежимРасшифровки = ПараметрРежимРасшифровки.Значение;
	КонецЕсли;
	
	Если РежимРасшифровки Тогда
		Группировки.Добавить("Период");
		
		ГруппировкиСтруктурыНастроек = Новый Массив;
		ЗаполнитьГруппировкиСтруктурыНастроек(ГруппировкиСтруктурыНастроек,
				НастройкиОтчета.Структура);
		
		КоличествоГруппировок = Группировки.Количество();
		Для НомерСчетчика = 1 По КоличествоГруппировок Цикл
			ИндексМассива = КоличествоГруппировок - НомерСчетчика;
			ИмяГруппировки = Группировки[ИндексМассива];
			Если ГруппировкиСтруктурыНастроек.Найти(ИмяГруппировки) = Неопределено Тогда
				Группировки.Удалить(ИндексМассива);
			КонецЕсли;
		КонецЦикла;
	КонецЕсли;
	
	ТаблицаСценариев = ЗначенияНефинансовыхПоказателей.Скопировать();
	ТаблицаСценариев.Свернуть("Сценарий");
	ТаблицаСценариев.Сортировать("Сценарий");
	
	Для каждого СтрокаСценарий Из ТаблицаСценариев Цикл
		
		Сценарий = СтрокаСценарий.Сценарий;
		Если Не ЗначениеЗаполнено(Сценарий) Тогда
			Заголовок = НСтр("ru = '<По всем сценариям>';
							|en = '<By all scenarios>'");
			ИдентификаторСценария = "ПустойСценарий";
		Иначе
			Заголовок = Строка(Сценарий);
			ИдентификаторСценария = "Сценарий_" + СтрЗаменить(Строка(Сценарий.УникальныйИдентификатор()), "-", "");
		КонецЕсли;
		
		Выражение = "ВЫБОР КОГДА Сценарий = &ИдентификаторСценария ТОГДА ЗначениеПоказателя ИНАЧЕ 0 КОНЕЦ";
		Выражение = СтрЗаменить(Выражение, "ИдентификаторСценария", ИдентификаторСценария);
		
		Параметр = СхемаКомпоновкиДанных.Параметры.Добавить();
		Параметр.Использование = ИспользованиеПараметраКомпоновкиДанных.Всегда;
		Параметр.Имя = ИдентификаторСценария;
		Параметр.Значение = Сценарий;
		Параметр.ОграничениеИспользования = Истина;
		
		НовоеВычисляемоеПоле = ФинансоваяОтчетностьСервер.НовоеВычисляемоеПоле(
			СхемаКомпоновкиДанных, ИдентификаторСценария, Выражение, Заголовок);
		НовоеВычисляемоеПоле.ТипЗначения = Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(3,0));
		
		Для каждого Группировка Из Группировки Цикл
			
			НовыйРесурс = СхемаКомпоновкиДанных.ПоляИтога.Добавить();
			НовыйРесурс.ПутьКДанным = Строка(ИдентификаторСценария);
			
			Выражение =
			"Отчеты.ЗначенияНефинансовыхПоказателей.Подключаемый_ЗначениеПоказателяДляГруппировки(
			|	ВычислитьВыражениеСГруппировкойТаблицаЗначений(%1,,,%2),
			|	ЕдиницаИзмерения,
			|	НефинансовыйПоказатель,
			|	НефинансовыйПоказатель.ВидПоказателя,
			|	НефинансовыйПоказатель.ПоПериодам,
			|	НефинансовыйПоказатель.ПоОрганизациям,
			|	НефинансовыйПоказатель.ПоПодразделениям,
			|	НефинансовыйПоказатель.КоличествоИспользуемыхАналитик,
			|	НефинансовыйПоказатель.УстанавливатьЗначениеНаКаждыйПериод,
			|	Период,
			|	&Периодичность,
			|	ВЫБОР
			|		КОГДА НефинансовыйПоказатель.ПоПериодам
			|			ТОГДА НефинансовыйПоказатель.ПериодичностьПодпериодов
			|		ИНАЧЕ НефинансовыйПоказатель.Периодичность
			|	КОНЕЦ,
			|	%3,
			|	&РежимРасшифровки,
			|	&Кэш)";
			
			ВыражениеГруппировки1 = СтрШаблон("
			|		НомерПодпериода КАК НомерПодпериода,
			|		ПериодУстановки КАК ПериодУстановки,
			|		Валюта КАК Валюта,
			|		СУММА(%1) КАК Значение", ИдентификаторСценария);
			
			ВыражениеГруппировки2 = СтрШаблон("СУММА(%1) <> 0", ИдентификаторСценария);
			
			Выражение = СтрШаблон(Выражение,
				"""" + ВыражениеГруппировки1 + """",
				"""" + ВыражениеГруппировки2 + """",
				"""" + Группировка + """");
			
			НовыйРесурс.Выражение = Выражение;
			НовыйРесурс.Группировки.Добавить(Группировка);
		КонецЦикла;
		
		ФинансоваяОтчетностьСервер.НовоеПолеВыбора(НастройкиОтчета, ИдентификаторСценария, Заголовок);
		
		ЭлементУсловногоОформления = НастройкиОтчета.УсловноеОформление.Элементы.Добавить();
		ЭлементУсловногоОформления.ИспользоватьВЗаголовкеПолей = ИспользованиеУсловногоОформленияКомпоновкиДанных.НеИспользовать;
		ЭлементУсловногоОформления.ИспользоватьВЗаголовке = ИспользованиеУсловногоОформленияКомпоновкиДанных.НеИспользовать;
		
		ЭлементПоля = ЭлементУсловногоОформления.Поля.Элементы.Добавить();
		ЭлементПоля.Использование = Истина;
		ЭлементПоля.Поле = Новый ПолеКомпоновкиДанных(ИдентификаторСценария);
		
		ЭлементУсловногоОформления.Оформление.УстановитьЗначениеПараметра("ГоризонтальноеПоложение", ГоризонтальноеПоложение.Право);
		ЭлементУсловногоОформления.Оформление.УстановитьЗначениеПараметра("МинимальнаяШирина", 20);
		ЭлементУсловногоОформления.Оформление.УстановитьЗначениеПараметра("МаксимальнаяШирина", 20);
		
	КонецЦикла;
	
	Параметр = СхемаКомпоновкиДанных.Параметры.Добавить();
	Параметр.Использование = ИспользованиеПараметраКомпоновкиДанных.Всегда;
	Параметр.ОграничениеИспользования = Истина;
	Параметр.ВключатьВДоступныеПоля = Ложь;
	Параметр.Имя = "Кэш";
	Параметр.Значение = Новый Соответствие;

КонецПроцедуры

Процедура ЗаполнитьГруппировкиСтруктурыНастроек(ГруппировкиСтруктурыНастроек, ЭлементСтруктурыНастроек)
	
	Для каждого ЭлементСтруктуры Из ЭлементСтруктурыНастроек Цикл
		Если ЭлементСтруктуры.Использование Тогда
			Для каждого ПолеГруппировки Из ЭлементСтруктуры.ПоляГруппировки.Элементы Цикл
				Если ПолеГруппировки.Использование Тогда
					ИмяГруппировки = Строка(ПолеГруппировки.Поле);
					Если ГруппировкиСтруктурыНастроек.Найти(ИмяГруппировки) = Неопределено Тогда
						ГруппировкиСтруктурыНастроек.Добавить(ИмяГруппировки);
					КонецЕсли;
				КонецЕсли;
			КонецЦикла;
			
			ЗаполнитьГруппировкиСтруктурыНастроек(ГруппировкиСтруктурыНастроек, ЭлементСтруктуры.Структура);
		КонецЕсли;
	КонецЦикла;
	
КонецПроцедуры

#КонецОбласти

#КонецЕсли
