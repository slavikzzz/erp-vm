// Область "Настройки" описывает параметры инициализации механизма загрузки
// регламентированных отчетов из файлов выгрузки. Формат области настроек - JSON.
//
// Описание параметров:
// * Установкой параметра "РазрешитьЗагрузку" в "true" или "false" регулируем видимость
//    кнопки "Загрузить" и возможность загрузки из файла в форме отчета.
// * Параметр "ФорматыСхемВыгрузки" описывает соответствие имен макетов схем выгрузки
//   поддерживаемым форматам загрузки. Если у формы единственная схема выгрузки или
//   нужно всегда использовать схему по умолчанию - указываем значение "null".
// * Параметр "ОбластиОбработчиков" содержит список имен используемых обработчиков
//    загружаемых данных. Имена соответствуют областям макета, в которых можно размещать
//    произвольные алгоритмы на языке "1С:Предприятие" для обработки доступных объектов.
//
// Примечание:
// Сопоставление имен узлов из файла XML и имен показателей отчета выполняется по данным схемы выгрузки,
// поэтому обработчики используются для получения значений показателей, не описанных в схеме выгрузки.
//
#Область Настройки
{
	"РазрешитьЗагрузку"   : true,
	
	"ФорматыСхемВыгрузки" : null,
	"ОбластиОбработчиков" : {
		"ПередЗагрузкой"  : "ПредОбработкаСхемыЗагрузки",
		"ПослеЗагрузки"   : "ПостОбработкаДокументаОтчета",
	}
}
#КонецОбласти

#Область ПредОбработкаСхемыЗагрузки
	
	ЗаменыКлючей = Новый Соответствие;
	
	ЗаменыКлючей.Вставить("СТР0291", "П003000100002");
	ЗаменыКлючей.Вставить("СТР0292", "П003000100004");
	
	КТот = 2;
	Для К = 5 По 8 Цикл
		КТот = КТот + 1;
		КТотСтр = Формат(КТот, "ЧЦ=2; ЧВН=; ЧГ=0");
		КСтр = Формат(К, "ЧЦ=2; ЧВН=; ЧГ=0");
		ЗаменыКлючей.Вставить("СТР02" + КТотСтр, "П0030001000" + КСтр);
	КонецЦикла;
	Для К = 3 По 10 Цикл
		КТот = КТот + 1;
		КТотСтр = Формат(КТот, "ЧЦ=2; ЧВН=; ЧГ=0");
		КСтр = Формат(К, "ЧЦ=2; ЧВН=; ЧГ=0");
		ЗаменыКлючей.Вставить("СТР02" + КТотСтр, "П0030002000" + КСтр);
	КонецЦикла;
	Для К = 3 По 9 Цикл
		КТот = КТот + 1;
		КТотСтр = Формат(КТот, "ЧЦ=2; ЧВН=; ЧГ=0");
		КСтр = Формат(К, "ЧЦ=2; ЧВН=; ЧГ=0");
		ЗаменыКлючей.Вставить("СТР02" + КТотСтр, "П0030003000" + КСтр);
	КонецЦикла;
	Для К = 3 По 10 Цикл
		КТот = КТот + 1;
		КТотСтр = Формат(КТот, "ЧЦ=2; ЧВН=; ЧГ=0");
		КСтр = Формат(К, "ЧЦ=2; ЧВН=; ЧГ=0");
		ЗаменыКлючей.Вставить("СТР02" + КТотСтр, "П0030004000" + КСтр);
	КонецЦикла;
	
	НайденныеСтроки = П.ДеревоДляЗагрузки.Строки.НайтиСтроки(Новый Структура("Код", "s1"), Истина);
	Для Каждого СтрокаДерева Из НайденныеСтроки Цикл
		СтрокаДерева.ЗначениеПоУмолчанию = "";
		Если СтрокаДерева.Ключ = "СТР0191" Тогда
			СтрокаДерева.Родитель.Многострочность = Ложь;
			СтрокаДерева.Родитель.Обязательность = "НП";
		КонецЕсли;
	КонецЦикла;
	
	НайденныеСтроки = П.ДеревоДляЗагрузки.Строки.НайтиСтроки(Новый Структура("Код", "s2"), Истина);
	Для Каждого СтрокаДерева Из НайденныеСтроки Цикл
		СтрокаДерева.ЗначениеПоУмолчанию = "";
		Если СтрокаДерева.Ключ = "СТР0292" Тогда
			СтрокаДерева.Родитель.Обязательность = "НП";
		КонецЕсли;
	КонецЦикла;
	
	НайденныеСтроки = П.ДеревоДляЗагрузки.Строки.НайтиСтроки(Новый Структура("Раздел", "ПолеТабличногоДокументаФормаОтчета"), Истина);
	Для Каждого СтрокаДерева Из НайденныеСтроки Цикл
		Если СтрНачинаетсяС(СтрокаДерева.Ключ, "СТР") Тогда
			НовыйКлюч = ЗаменыКлючей[СтрокаДерева.Ключ];
			Если ЗначениеЗаполнено(НовыйКлюч) Тогда
				СтрокаДерева.Ключ = НовыйКлюч;
			КонецЕсли;
		КонецЕсли;
	КонецЦикла;
	
#КонецОбласти

#Область ПостОбработкаДокументаОтчета
	
	Секции = УзлыПоXPath(П.ДеревоДляЗагрузки, "/report/sections")[0]; // содержательная часть
	
	Секция1 = УзлыПоXPath(Секции, "section[@code='1']")[0];
	СтрокиСекции1 = УзлыПоXPath(Секция1,"row");
	
	КоличествоСтрокМнЧ    =  0;
	ИндПоследнейСтрокиМнЧ = -1;
	
	СтрокиДляПостОбработки = Новый Массив;
	
	Для Каждого СтрокаСекции1 Из СтрокиСекции1 Цикл
		
		ЗначениеS1 = Неопределено;
		ЗначениеS2 = Неопределено;
		
		Для Каждого КолонкаСекции1 Из СтрокаСекции1.Строки Цикл
			Если КолонкаСекции1.Код = "s1" Тогда
				ЗначениеS1 = СтрЗаменить(СтрЗаменить(КолонкаСекции1.Значение, " ", ""), Символы.НПП, "");
				Прервать;
			КонецЕсли;
		КонецЦикла;
		
		Для Каждого КолонкаСекции1 Из СтрокаСекции1.Строки Цикл
			Если КолонкаСекции1.Код = "s2" Тогда
				ЗначениеS2 = СокрЛП(КолонкаСекции1.Значение);
				Прервать;
			КонецЕсли;
		КонецЦикла;
		
		Если НЕ ЗначениеЗаполнено(ЗначениеS1) Тогда
			Продолжить;
		КонецЕсли;
		
		СтрокаСекции1.Обязательность = "Н";
		
		ОснЧастьПоказателя = "П000001" + ЗначениеS1;
		
		ЗначениеS1Число = Число(" " + ЗначениеS1);
		
		МногострочнаяЧасть = Ложь;
		Если ((ЗначениеS1Число >= 1170 И ЗначениеS1Число <= 1583) ИЛИ ЗначениеS1Число = 1630) И ЗначениеS2 = "168" Тогда
			Если ЗначениеS1Число = 1630 Тогда
				СтрокиДляПостОбработки.Добавить(СтрокаСекции1);
			Иначе
				МногострочнаяЧасть = Истина;
				СтрокаСекции1.Многострочность = Истина;
				КоличествоСтрокМнЧ = КоличествоСтрокМнЧ + 1;
				ИндПоследнейСтрокиМнЧ = СтрокаСекции1.Родитель.Строки.Индекс(СтрокаСекции1);
			КонецЕсли;
		КонецЕсли;
		
		ПредЗначениеS1Число = ЗначениеS1Число;
		
		Для Каждого КолонкаСекции1 Из СтрокаСекции1.Строки Цикл
			
			Если КолонкаСекции1.Код = "s1" Тогда
				Если МногострочнаяЧасть Тогда
					КолонкаСекции1.Ключ = "П000001116012";
				Иначе
					КолонкаСекции1.Ключ = "";
				КонецЕсли;
				КолонкаСекции1.Формат = "Т";
			ИначеЕсли КолонкаСекции1.Код = "s2" Тогда
				КолонкаСекции1.Ключ = "";
			ИначеЕсли КолонкаСекции1.Код = "col" Тогда
				Если СтрНачинаетсяС(КолонкаСекции1.Ключ, "СТР") Тогда
					СуффиксПоказателя = Прав(КолонкаСекции1.Ключ, 2);
					Если МногострочнаяЧасть Тогда
						Если СуффиксПоказателя = "05" Тогда
							КолонкаСекции1.Ключ = "";
						Иначе
							КолонкаСекции1.Ключ = "П0000011160" + СуффиксПоказателя;
						КонецЕсли;
					Иначе
						КолонкаСекции1.Ключ = ОснЧастьПоказателя + СуффиксПоказателя;
					КонецЕсли;
				КонецЕсли;
			КонецЕсли;
			
		КонецЦикла;
		
	КонецЦикла;
	
	НоваяСтрокаМнЧ = Неопределено;
	Для Каждого СтрокаДляПостОбработки Из СтрокиДляПостОбработки Цикл
		ИндСтроки = СтрокаДляПостОбработки.Родитель.Строки.Индекс(СтрокаДляПостОбработки);
		Если КоличествоСтрокМнЧ > 0 Тогда
			Если (КоличествоСтрокМнЧ <= 5)
			   И (ИндСтроки <= ИндПоследнейСтрокиМнЧ + 1)
			   И (ИндСтроки >= ИндПоследнейСтрокиМнЧ - КоличествоСтрокМнЧ) Тогда
				СтрокаДляПостОбработки.Многострочность = Истина;
				НоваяСтрокаМнЧ = СтрокаДляПостОбработки;
				Прервать;
			КонецЕсли;
		ИначеЕсли ИндСтроки = СтрокаДляПостОбработки.Родитель.Строки.Количество() - 1 Тогда
			СтрокаДляПостОбработки.Многострочность = Истина;
			НоваяСтрокаМнЧ = СтрокаДляПостОбработки;
			Прервать;
		КонецЕсли;
	КонецЦикла;
	
	Если НоваяСтрокаМнЧ <> Неопределено Тогда
		
		Для Каждого КолонкаСтроки Из НоваяСтрокаМнЧ.Строки Цикл
			
			Если КолонкаСтроки.Код = "s1" Тогда
				КолонкаСтроки.Ключ = "П000001116012";
				КолонкаСтроки.Формат = "Т";
			ИначеЕсли КолонкаСтроки.Код = "s2" Тогда
				КолонкаСтроки.Ключ = "";
			ИначеЕсли КолонкаСтроки.Код = "col" Тогда
				Если СтрНачинаетсяС(КолонкаСтроки.Ключ, "П") Тогда
					СуффиксПоказателя = Прав(КолонкаСтроки.Ключ, 2);
					Если СуффиксПоказателя = "05" Тогда
						КолонкаСтроки.Ключ = "";
					Иначе
						КолонкаСтроки.Ключ = "П0000011160" + СуффиксПоказателя;
					КонецЕсли;
				КонецЕсли;
			КонецЕсли;
			
		КонецЦикла;
		
	КонецЕсли;
	
	ЗаполнитьДаннымиСохраненныйДокументИзДереваДляЗагрузки(Секция1, П.ДанныеОтчета, П.ПараметрыОтчета);
	
	Секция2 = УзлыПоXPath(Секции, "section[@code='2']")[0];
	СтрокиСекции2 = УзлыПоXPath(Секция2,"row");
	
	Для Каждого СтрокаСекции2 Из СтрокиСекции2 Цикл
		
		ЗначениеS1 = Неопределено; УзелCol = Неопределено;
		
		Для Каждого КолонкаСекции2 Из СтрокаСекции2.Строки Цикл
			Если КолонкаСекции2.Код = "s1" Тогда
				ЗначениеS1 = КолонкаСекции2.Значение;
			ИначеЕсли КолонкаСекции2.Код = "col" Тогда
				УзелCol = КолонкаСекции2;
				Прервать;
			КонецЕсли;
		КонецЦикла;
		
		СтрокаСекции2.Обязательность = "Н";
		
		Если ЗначениеS1 = Неопределено Тогда
			Продолжить;
		КонецЕсли;
		
		Если ЗначениеS1 = "9500" Тогда
			СтрокаСекции2.Многострочность = Ложь;
			Продолжить;
		КонецЕсли;
		
		Если УзелCol = Неопределено Тогда
			Продолжить;
		КонецЕсли;
		
		НовыйУзел = СкопированныйУзел(СтрокаСекции2, УзелCol);
		НовыйУзел.Ключ     = "П003000200002";
		НовыйУзел.Значение = ЗначениеS1;
		НовыйУзел.Формат   = "T";
		
		НовыйУзел = СкопированныйУзел(СтрокаСекции2, УзелCol);
		НовыйУзел.Ключ     = "П003000300002";
		НовыйУзел.Значение = ЗначениеS1;
		НовыйУзел.Формат   = "T";
		
		НовыйУзел = СкопированныйУзел(СтрокаСекции2, УзелCol);
		НовыйУзел.Ключ     = "П003000400002";
		НовыйУзел.Значение = ЗначениеS1;
		НовыйУзел.Формат   = "T";
		
	КонецЦикла;
	
	ЗаполнитьДаннымиСохраненныйДокументИзДереваДляЗагрузки(Секция2, П.ДанныеОтчета, П.ПараметрыОтчета);
	
#КонецОбласти