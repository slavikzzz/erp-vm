
#Область ОбработчикиСобытийФормы

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	Если Параметры.Свойство("АвтоТест") Тогда // Возврат при получении формы для анализа.
		Возврат;
	КонецЕсли;

	ЗаполнитьСписокРаспоряжений();
	
	СтандартныеПодсистемыСервер.УстановитьУсловноеОформлениеПоляДата(ЭтотОбъект, "СписокРаспоряжений.Дата", Элементы.СписокРаспоряженийДата.Имя);
	
	СобытияФорм.ПриСозданииНаСервере(ЭтаФорма, Отказ, СтандартнаяОбработка);
	
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиСобытийЭлементовТаблицыФормыСписокРаспоряжений

&НаКлиенте
Процедура СписокРаспоряженийВыбор(Элемент, ВыбраннаяСтрока, Поле, СтандартнаяОбработка)
	
	Если Элементы.СписокРаспоряжений.ТекущиеДанные <> Неопределено Тогда
		ОповеститьОВыборе(Элементы.СписокРаспоряжений.ТекущиеДанные.Ссылка);
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиКомандФормы

&НаКлиенте
Процедура Выбрать(Команда)
	
	Если Элементы.СписокРаспоряжений.ТекущиеДанные <> Неопределено Тогда
		ОповеститьОВыборе(Элементы.СписокРаспоряжений.ТекущиеДанные.Ссылка);
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура Подключаемый_ВыполнитьПереопределяемуюКоманду(Команда)
	
	СобытияФормКлиент.ВыполнитьПереопределяемуюКоманду(ЭтаФорма, Команда);
	
КонецПроцедуры

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

&НаСервере
Процедура ЗаполнитьСписокРаспоряжений()

	ТекстЗапроса = 
	"ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	Заказы.Ссылка КАК Ссылка,
	|	Заказы.Дата КАК Дата,
	|	Заказы.Номер КАК Номер,
	|	Заказы.Партнер КАК Партнер,
	|	Заказы.Контрагент КАК Контрагент,
	|	Заказы.Договор КАК Договор,
	|	Заказы.Организация КАК Организация,
	|	Заказы.Валюта КАК Валюта,
	|	Заказы.Статус КАК Статус,
	|	Заказы.СуммаДокумента КАК СуммаДокумента
	|ИЗ
	|	(ВЫБРАТЬ
	|		ТаблицаЗаказы.ЗаказКлиента КАК ЗаказКлиента,
	|		СУММА(ТаблицаЗаказы.КОформлению) КАК КОформлению
	|	ИЗ
	|		(ВЫБРАТЬ
	|			ЗаказыОстатки.ЗаказКлиента КАК ЗаказКлиента,
	|			ЗаказыОстатки.КОформлениюОстаток КАК КОформлению
	|		ИЗ
	|			РегистрНакопления.ЗаказыКлиентов.Остатки(
	|					,
	|					ЗаказКлиента ССЫЛКА Документ.ЗаказПереработчику
	|						И ВЫРАЗИТЬ(ЗаказКлиента КАК Документ.ЗаказПереработчику).Организация = &Организация
	|						И ВЫРАЗИТЬ(ЗаказКлиента КАК Документ.ЗаказПереработчику).Валюта = &Валюта
	|						И ВЫРАЗИТЬ(ЗаказКлиента КАК Документ.ЗаказПереработчику).Контрагент = &Контрагент
	|						И ВЫРАЗИТЬ(ЗаказКлиента КАК Документ.ЗаказПереработчику).Договор = &Договор
	|						И ВЫРАЗИТЬ(ЗаказКлиента КАК Документ.ЗаказПереработчику).Партнер = &Партнер
	|						И ВЫРАЗИТЬ(ЗаказКлиента КАК Документ.ЗаказПереработчику).Сделка = &Сделка
	|						И ВЫРАЗИТЬ(ЗаказКлиента КАК Документ.ЗаказПереработчику).ВернутьМногооборотнуюТару = &ВернутьМногооборотнуюТару
	|						И (Склад = &Склад
	|							ИЛИ Склад В ИЕРАРХИИ (&Склад)
	|							ИЛИ Склад = ЗНАЧЕНИЕ(Справочник.Склады.ПустаяСсылка))) КАК ЗаказыОстатки
	|		
	|		ОБЪЕДИНИТЬ ВСЕ
	|		
	|		ВЫБРАТЬ
	|			ЗаказыДвижения.ЗаказКлиента,
	|			ВЫБОР
	|				КОГДА ЗаказыДвижения.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|					ТОГДА -ЗаказыДвижения.КОформлению
	|				ИНАЧЕ ЗаказыДвижения.КОформлению
	|			КОНЕЦ
	|		ИЗ
	|			РегистрНакопления.ЗаказыКлиентов КАК ЗаказыДвижения
	|		ГДЕ
	|			ЗаказыДвижения.Регистратор = &Регистратор
	|			И ЗаказыДвижения.Активность
	|			И ВЫРАЗИТЬ(ЗаказыДвижения.ЗаказКлиента КАК Документ.ЗаказПереработчику).Организация = &Организация
	|			И ВЫРАЗИТЬ(ЗаказыДвижения.ЗаказКлиента КАК Документ.ЗаказПереработчику).Валюта = &Валюта
	|			И ВЫРАЗИТЬ(ЗаказыДвижения.ЗаказКлиента КАК Документ.ЗаказПереработчику).Контрагент = &Контрагент
	|			И ВЫРАЗИТЬ(ЗаказыДвижения.ЗаказКлиента КАК Документ.ЗаказПереработчику).Договор = &Договор
	|			И ВЫРАЗИТЬ(ЗаказыДвижения.ЗаказКлиента КАК Документ.ЗаказПереработчику).Партнер = &Партнер
	|			И ВЫРАЗИТЬ(ЗаказыДвижения.ЗаказКлиента КАК Документ.ЗаказПереработчику).Сделка = &Сделка
	|			И ВЫРАЗИТЬ(ЗаказыДвижения.ЗаказКлиента КАК Документ.ЗаказПереработчику).ВернутьМногооборотнуюТару = &ВернутьМногооборотнуюТару
	|			И (ЗаказыДвижения.Склад = &Склад
	|					ИЛИ ЗаказыДвижения.Склад В ИЕРАРХИИ (&Склад)
	|					ИЛИ ЗаказыДвижения.Склад = ЗНАЧЕНИЕ(Справочник.Склады.ПустаяСсылка))) КАК ТаблицаЗаказы
	|	
	|	СГРУППИРОВАТЬ ПО
	|		ТаблицаЗаказы.ЗаказКлиента) КАК ТаблицаЗаказы
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.ЗаказПереработчику КАК Заказы
	|		ПО (Заказы.Ссылка = ТаблицаЗаказы.ЗаказКлиента)
	|ГДЕ
	|	ТаблицаЗаказы.КОформлению > 0
	|
	|УПОРЯДОЧИТЬ ПО
	|	Дата,
	|	Номер";
	
	Запрос = Новый Запрос(ТекстЗапроса);
	
	МассивОтборов = Новый Массив;
	МассивОтборов.Добавить("Организация");
	МассивОтборов.Добавить("Валюта");
	МассивОтборов.Добавить("Контрагент");
	МассивОтборов.Добавить("Договор");
	МассивОтборов.Добавить("Партнер");
	МассивОтборов.Добавить("Сделка");
	МассивОтборов.Добавить("ВернутьМногооборотнуюТару");
	МассивОтборов.Добавить("НаправлениеДеятельности");

	Для каждого ИмяОтбора Из МассивОтборов Цикл
		ЗначениеОтбора = Неопределено;
		Если Параметры.Отбор.Свойство(ИмяОтбора, ЗначениеОтбора) Тогда
			Запрос.УстановитьПараметр(ИмяОтбора, ЗначениеОтбора);
			Параметры.Отбор.Удалить(ИмяОтбора);
		КонецЕсли;
	КонецЦикла;
	
	Запрос.УстановитьПараметр("Регистратор", Параметры.Регистратор);
	Запрос.УстановитьПараметр("Склад", Параметры.Склад);
		
	
	СписокРаспоряжений.Загрузить(Запрос.Выполнить().Выгрузить());

КонецПроцедуры

#КонецОбласти

 
