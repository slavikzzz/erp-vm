#Область ОбработчикиСобытийФормы

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	ЗапрещенныеРасширения = РаботаСФайламиСлужебный.СписокЗапрещенныхРасширений();
	НастроитьФорму();
	УстановитьУсловноеОформление();
	
	Если Параметры.Ключ.Пустая() Тогда
		
		ЗначениеКопированияЭлектронныйДокумент = Неопределено;
		Если ЗначениеЗаполнено(Параметры.ЗначениеКопирования) Тогда
			Если Не Объект.Внешний Тогда
				ВызватьИсключение НСтр("ru = 'Допустимо копировать только документы, добавленные вручную';
										|en = 'You can copy only documents added manually'");
			КонецЕсли;
			ЗначениеКопированияЭлектронныйДокумент = Объект.ЭлектронныйДокумент;
			Объект.ЭлектронныйДокумент = Неопределено;
			Объект.ИдентификаторДокумента = "";
			Объект.ИдентификаторЗаявкиКабинетСотрудника = "";
			Объект.ОснованиеДокумента = Неопределено;
		КонецЕсли;
		
		ЗапрашиваемыеЗначения = Новый Структура;
		ЗапрашиваемыеЗначения.Вставить("Организация", "Объект.Организация");
		ЗапрашиваемыеЗначения.Вставить("Ответственный", "Объект.Ответственный");
		ЗарплатаКадры.ЗаполнитьПервоначальныеЗначенияВФорме(ЭтотОбъект, ЗапрашиваемыеЗначения);
		
		Если Не ЗначениеЗаполнено(Объект.СодержимоеДокумента) Тогда
			Объект.СодержимоеДокумента = КадровыйЭДО.МаксимальноДоступноеСодержимоеДокументовПользователя();
		КонецЕсли;
		
		Объект.Внешний = Истина;
		Если ЗначениеЗаполнено(ЗначениеКопированияЭлектронныйДокумент)
			И Объект.ПроизвольнаяТаблица Тогда
			
			ЗаполнитьДокумент(ЗначениеКопированияЭлектронныйДокумент);
			Объект.НаименованиеДокумента = СтрШаблон("%1 (%2)", СокрЛП(Объект.НаименованиеДокумента), НСтр("ru = 'копия';
																											|en = 'copy'"));
		КонецЕсли;
		
		ПриПолученииДанныхНаСервере();
		ТребуетсяПодписьОрганизации = ЭлектроннаяПодпись.ИспользоватьЭлектронныеПодписи();
		
	Иначе
		ПеревестиВРежимПросмотраОсновныхДанных();
	КонецЕсли;
	
	ПараметрВыбораСодержимого = Новый ПараметрВыбора("Отбор.Ссылка",
		КадровыйЭДО.ДоступныеСодержанияДокументовПользователя(Пользователи.ТекущийПользователь()));
	
	ОбщегоНазначенияКлиентСервер.УстановитьСвойствоЭлементаФормы(
		Элементы,
		"СодержимоеДокумента",
		"ПараметрыВыбора",
		Новый ФиксированныйМассив(
			ОбщегоНазначенияКлиентСервер.ЗначениеВМассиве(ПараметрВыбораСодержимого)));
	
	// СтандартныеПодсистемы.ПодключаемыеКоманды
	ПодключаемыеКоманды.ПриСозданииНаСервере(ЭтотОбъект);
	// Конец СтандартныеПодсистемы.ПодключаемыеКоманды
	
	// СтандартныеПодсистемы.Свойства
	ДополнительныеПараметры = Новый Структура;
	ДополнительныеПараметры.Вставить("ИмяЭлементаДляРазмещения", "ГруппаДополнительныеРеквизиты");
	УправлениеСвойствами.ПриСозданииНаСервере(ЭтотОбъект, ДополнительныеПараметры);
	// Конец СтандартныеПодсистемы.Свойства
	
	// ПроцессыОбработкиДокументов
	Если ОбщегоНазначения.ПодсистемаСуществует("ЗарплатаКадрыПриложения.ПроцессыОбработкиДокументовЗарплата") Тогда
		МодульПроцессыОбработкиДокументовЗарплата = ОбщегоНазначения.ОбщийМодуль("ПроцессыОбработкиДокументовЗарплата");
		МодульПроцессыОбработкиДокументовЗарплата.ПриСозданииНаСервере(ЭтотОбъект, Объект);
	КонецЕсли;
	// Конец ПроцессыОбработкиДокументов
	
	ОбщегоНазначенияКлиентСервер.УстановитьСвойствоЭлементаФормы(
		Элементы,
		"КодДокументаКадровогоМероприятия",
		"ПодсказкаВвода",
		КадровыйЭДОПовтИсп.СвойстваКодаКадровогоДокумента().Код);
	
	ОбщегоНазначенияКлиентСервер.УстановитьСвойствоЭлементаФормы(
		Элементы,
		"ФормаСкопировать",
		"Видимость",
		Объект.Внешний);
	
КонецПроцедуры

&НаКлиенте
Процедура ПриОткрытии(Отказ)
	
	// СтандартныеПодсистемы.Свойства
	УправлениеСвойствамиКлиент.ПослеЗагрузкиДополнительныхРеквизитов(ЭтотОбъект);
	// Конец СтандартныеПодсистемы.Свойства
	
	// СтандартныеПодсистемы.ПодключаемыеКоманды
	ПодключаемыеКомандыКлиент.НачатьОбновлениеКоманд(ЭтотОбъект);
	// Конец СтандартныеПодсистемы.ПодключаемыеКоманды
	
КонецПроцедуры

&НаКлиенте
Процедура ОбработкаОповещения(ИмяСобытия, Параметр, Источник)
	
	// СтандартныеПодсистемы.Свойства 
	Если УправлениеСвойствамиКлиент.ОбрабатыватьОповещения(ЭтотОбъект, ИмяСобытия, Параметр) Тогда
		ОбновитьЭлементыДополнительныхРеквизитов();
		УправлениеСвойствамиКлиент.ПослеЗагрузкиДополнительныхРеквизитов(ЭтотОбъект);
	КонецЕсли;
	// Конец СтандартныеПодсистемы.Свойства
	
	Если ИмяСобытия = "ОбновленыДанныеДокументовКЭДО"
		И (Источник = Объект.Ссылка
			Или Источник = Неопределено) Тогда
		
		Если Не РежимПросмотра Тогда
			ТолькоПросмотр = Ложь;
		КонецЕсли;
		Прочитать();
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Процедура ПриЧтенииНаСервере(ТекущийОбъект)
	
	// СтандартныеПодсистемы.Свойства
	УправлениеСвойствами.ПриЧтенииНаСервере(ЭтотОбъект, ТекущийОбъект);
	// Конец СтандартныеПодсистемы.Свойства
	
	// СтандартныеПодсистемы.ПодключаемыеКоманды
	ПодключаемыеКомандыКлиентСервер.ОбновитьКоманды(ЭтотОбъект, Объект);
	// Конец СтандартныеПодсистемы.ПодключаемыеКоманды
	
	// СтандартныеПодсистемы.УправлениеДоступом
	УправлениеДоступом.ПриЧтенииНаСервере(ЭтотОбъект, ТекущийОбъект);
	// Конец СтандартныеПодсистемы.УправлениеДоступом
	
	// СтандартныеПодсистемы.КонтрольВеденияУчета
	КонтрольВеденияУчетаБЗК.ПриЧтенииНаСервере(ЭтотОбъект, ТекущийОбъект);
	// Конец СтандартныеПодсистемы.КонтрольВеденияУчета
	
	ПриПолученииДанныхНаСервере();
	
	// ПроцессыОбработкиДокументов
	Если ОбщегоНазначения.ПодсистемаСуществует("ЗарплатаКадрыПриложения.ПроцессыОбработкиДокументовЗарплата") Тогда
		МодульПроцессыОбработкиДокументовЗарплата = ОбщегоНазначения.ОбщийМодуль("ПроцессыОбработкиДокументовЗарплата");
		МодульПроцессыОбработкиДокументовЗарплата.ПриЧтенииНаСервере(ЭтотОбъект, ТекущийОбъект);
	КонецЕсли;
	// Конец ПроцессыОбработкиДокументов
	
КонецПроцедуры

&НаСервере
Процедура ПередЗаписьюНаСервере(Отказ, ТекущийОбъект, ПараметрыЗаписи)
	
	// СтандартныеПодсистемы.Свойства
	УправлениеСвойствами.ПередЗаписьюНаСервере(ЭтотОбъект, ТекущийОбъект);
	// Конец СтандартныеПодсистемы.Свойства
	
	Если Не ЗначениеЗаполнено(ТекущийОбъект.Ссылка) Тогда
		
		ТекущийОбъектСсылка = Документы.ДокументКадровогоЭДО.ПолучитьСсылку();
		ТекущийОбъект.ОснованиеДокумента = ТекущийОбъектСсылка;
		ТекущийОбъект.ДополнительныеСвойства.Вставить("СсылкаНового", ТекущийОбъектСсылка);
		ТекущийОбъект.Расширение = Расширение;
		
	Иначе
		ТекущийОбъектСсылка = ТекущийОбъект.Ссылка;
	КонецЕсли;
	
	Если Не ЗначениеЗаполнено(ТекущийОбъект.ЭлектронныйДокумент) Тогда
		Если Объект.Внешний
			И ТабличныйДокументЗадан(ЭтотОбъект) Тогда
			
			ДанныеПечатнойФормы = КадровыйЭДОВызовСервера.ДобавитьПечатнуюФорму(
				Документ,
				ТекущийОбъектСсылка,
				"ДокументКадровогоЭДО",
				ТекущийОбъект.НаименованиеДокумента,
				ТекущийОбъект.Организация,
				ТекущийОбъект.ВнешниеПодписанты.ВыгрузитьКолонку("ФизическоеЛицо"));
			ДокументМодифицирован = Ложь;
			
			ТекущийОбъект.ЭлектронныйДокумент = ДанныеПечатнойФормы.ФайлОбъекта;
			
		ИначеЕсли Не ЗначениеЗаполнено(ТекущийОбъект.Ссылка) Тогда
			
			ПараметрыФайла = РаботаСФайлами.ПараметрыДобавленияФайла();
			ПараметрыФайла.ВладелецФайлов     = ТекущийОбъектСсылка;
			ПараметрыФайла.ИмяБезРасширения   = СтрЗаменить(ИмяФайлаСРасширением, "." + Расширение, "");
			ПараметрыФайла.РасширениеБезТочки = Расширение;
			
			УстановитьПривилегированныйРежим(Истина);
			ТекущийОбъект.ЭлектронныйДокумент = РаботаСФайлами.ДобавитьФайл(
				ПараметрыФайла, ДанныеЭлектронногоДокумента.СсылкаНаДвоичныеДанные);
			УстановитьПривилегированныйРежим(Ложь);
			
		КонецЕсли;
	Иначе
		Если Объект.Внешний
			И ТабличныйДокументЗадан(ЭтотОбъект)
			И ДокументМодифицирован Тогда
			
			КоллекцияПодписей = ЗаполнитьКоллекцииПодписей();
			Если Не ЗначениеЗаполнено(КоллекцияПодписей.ПодписиИБ)
				И Не ЗначениеЗаполнено(КоллекцияПодписей.ПодписиСервиса) Тогда
				
				НачатьТранзакцию();
				Попытка
					Блокировка = Новый БлокировкаДанных();
					ЭлементБлокировки = Блокировка.Добавить(
						ТекущийОбъект.ЭлектронныйДокумент.Метаданные().ПолноеИмя());
					ЭлементБлокировки.УстановитьЗначение("Ссылка", ТекущийОбъект.ЭлектронныйДокумент);
					Блокировка.Заблокировать();
					
					ФайлОбъект = ТекущийОбъект.ЭлектронныйДокумент.ПолучитьОбъект();
					ФайлОбъект.Заблокировать();
					ФайлОбъект.УстановитьПометкуУдаления(Истина);
					
					ЗафиксироватьТранзакцию();
				Исключение
					ОтменитьТранзакцию();
					ВызватьИсключение НСтр("ru = 'Не удалось обновить электронный документ';
											|en = 'Cannot update the electronic document'")
				КонецПопытки;
				
				РегистрыСведений.ЗапланированныеДействияСФайламиДокументовКЭДО.УдалитьФайлыИзОбработки(
					ОбщегоНазначенияКлиентСервер.ЗначениеВМассиве(ТекущийОбъект.ЭлектронныйДокумент));
				
				ДанныеПечатнойФормы = КадровыйЭДОВызовСервера.ДобавитьПечатнуюФорму(
					Документ,
					ТекущийОбъект.Ссылка,
					"ДокументКадровогоЭДО",
					ТекущийОбъект.НаименованиеДокумента,
					ТекущийОбъект.Организация,
					ТекущийОбъект.ВнешниеПодписанты.ВыгрузитьКолонку("ФизическоеЛицо"));
				ДокументМодифицирован = Ложь;
				
				ТекущийОбъект.ЭлектронныйДокумент = ДанныеПечатнойФормы.ФайлОбъекта;
			КонецЕсли;
		КонецЕсли;
	КонецЕсли;
	
	// ПроцессыОбработкиДокументов
	Если ОбщегоНазначения.ПодсистемаСуществует("ЗарплатаКадрыПриложения.ПроцессыОбработкиДокументовЗарплата") Тогда
		МодульПроцессыОбработкиДокументовЗарплата = ОбщегоНазначения.ОбщийМодуль("ПроцессыОбработкиДокументовЗарплата");
		МодульПроцессыОбработкиДокументовЗарплата.ПередЗаписьюНаСервере(ЭтотОбъект, ТекущийОбъект, ПараметрыЗаписи, Отказ);
	КонецЕсли;
	// Конец ПроцессыОбработкиДокументов
	
КонецПроцедуры

&НаСервере
Процедура ПослеЗаписиНаСервере(ТекущийОбъект, ПараметрыЗаписи)
	
	// СтандартныеПодсистемы.УправлениеДоступом
	УправлениеДоступом.ПослеЗаписиНаСервере(ЭтотОбъект, ТекущийОбъект, ПараметрыЗаписи);
	// Конец СтандартныеПодсистемы.УправлениеДоступом
	
	// СтандартныеПодсистемы.КонтрольВеденияУчета
	КонтрольВеденияУчетаБЗК.ПослеЗаписиНаСервере(ЭтотОбъект, ТекущийОбъект, ПараметрыЗаписи);
	// Конец СтандартныеПодсистемы.КонтрольВеденияУчета
	
	ПриПолученииДанныхНаСервере();
	ПеревестиВРежимПросмотраОсновныхДанных();
	
	// ПроцессыОбработкиДокументов
	Если ОбщегоНазначения.ПодсистемаСуществует("ЗарплатаКадрыПриложения.ПроцессыОбработкиДокументовЗарплата") Тогда
		МодульПроцессыОбработкиДокументовЗарплата = ОбщегоНазначения.ОбщийМодуль("ПроцессыОбработкиДокументовЗарплата");
		МодульПроцессыОбработкиДокументовЗарплата.ПослеЗаписиНаСервере(ЭтотОбъект, ТекущийОбъект, ПараметрыЗаписи);
	КонецЕсли;
	// Конец ПроцессыОбработкиДокументов
	
КонецПроцедуры

&НаКлиенте
Процедура ПередЗакрытием(Отказ, ЗавершениеРаботы, ТекстПредупреждения, СтандартнаяОбработка)
	
	// ПроцессыОбработкиДокументов
	Если ОбщегоНазначенияКлиент.ПодсистемаСуществует("ЗарплатаКадрыПриложения.ПроцессыОбработкиДокументовЗарплата") Тогда
		МодульПроцессыОбработкиДокументовЗарплата = ОбщегоНазначенияКлиент.ОбщийМодуль("ПроцессыОбработкиДокументовЗарплатаКлиент");
		МодульПроцессыОбработкиДокументовЗарплата.ПередЗакрытием(ЭтотОбъект, Объект, Отказ, ЗавершениеРаботы, ТекстПредупреждения, СтандартнаяОбработка)
	КонецЕсли;
	// Конец ПроцессыОбработкиДокументов
	
КонецПроцедуры

&НаСервере
Процедура ОбработкаПроверкиЗаполненияНаСервере(Отказ, ПроверяемыеРеквизиты)
	
	// СтандартныеПодсистемы.Свойства
	УправлениеСвойствами.ОбработкаПроверкиЗаполнения(ЭтотОбъект, Отказ, ПроверяемыеРеквизиты);
	// Конец СтандартныеПодсистемы.Свойства
	
	Если Не ЗначениеЗаполнено(Объект.ВнешниеПодписанты) Тогда
		
		ОбщегоНазначения.СообщитьПользователю(
			НСтр("ru = 'Не выбраны ознакомляемые с документом сотрудники.';
				|en = 'Employees to read the document are not specified.'"),
			Объект.Ссылка, "Ознакомляемые", "", Отказ);
		
	КонецЕсли;
	
	Если Не ДанныеФайлаЗаполнены(ЭтотОбъект) И Не ТабличныйДокументЗадан(ЭтотОбъект) Тогда
		Если Объект.ПроизвольнаяТаблица Тогда
			ОбщегоНазначения.СообщитьПользователю(
				НСтр("ru = 'Не подготовлен электронный документ.';
					|en = 'Electronic document is not prepared.'"),
				Объект.Ссылка, "НаименованиеДокумента", "Объект", Отказ);
		Иначе
			ОбщегоНазначения.СообщитьПользователю(
				НСтр("ru = 'Не выбраны файл электронного документа.';
					|en = 'Electronic document file is not selected.'"),
				Объект.Ссылка, "ИмяФайлаСРасширением", "", Отказ);
		КонецЕсли;
	КонецЕсли;
	
	ТекущийОбъект = РеквизитФормыВЗначение("Объект");
	ТекущийОбъект.ДополнительныеСвойства.Вставить("НеПроверятьЭлектронныйДокумент", Истина);
	ОбщегоНазначенияКлиентСервер.УдалитьЗначениеИзМассива(ПроверяемыеРеквизиты, "Объект");
	Если Не ТекущийОбъект.ПроверитьЗаполнение() Тогда
		Отказ = Истина;
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиСобытийЭлементовШапкиФормы

&НаКлиенте
Процедура ОрганизацияПриИзменении(Элемент)
	
	УстановитьОтображениеЭлементовПоОрганизации(ЭтотОбъект);
	
КонецПроцедуры

&НаКлиенте
Процедура ИмяФайлаСРасширениемНажатие(Элемент, СтандартнаяОбработка)
	
	СтандартнаяОбработка = Ложь;
	Если Не ЗначениеЗаполнено(Объект.ЭлектронныйДокумент) Тогда
		ВыбратьФайлСДиска();
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ОснованиеДокументаНажатие(Элемент, СтандартнаяОбработка)
	
	БизнесПроцессыЗаявокСотрудниковКлиент.ПоказатьОснованиеДокументаКадровогоЭДО(
		Объект.ОснованиеДокумента, СтандартнаяОбработка);
	
КонецПроцедуры

&НаКлиенте
Процедура ВыборОдногоОзнакомляемогоПриИзменении(Элемент)
	
	Если Объект.ВнешниеПодписанты.Количество() > 1 Тогда
		
		ТекстВопроса = НСтр("ru = 'Список сотрудников будет очищен.
			|Продолжить?';
			|en = 'Список сотрудников будет очищен.
			|Продолжить?'");
		
		Оповещение = Новый ОписаниеОповещения("ВыборОдногоОзнакомляемогоПриИзмененииЗавершение", ЭтотОбъект);
		ПоказатьВопрос(Оповещение, ТекстВопроса, РежимДиалогаВопрос.ДаНетОтмена);
		
	Иначе
		ВыборОдногоОзнакомляемогоПриИзмененииЗавершение(КодВозвратаДиалога.Да);
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ВыборОдногоОзнакомляемогоПриИзмененииЗавершение(Ответ, ДополнительныеПараметры = Неопределено) Экспорт
	
	Если Ответ = КодВозвратаДиалога.Да Тогда
		ВыборОдногоОзнакомляемогоПриИзмененииНаСервере();
	Иначе
		ВыборОзнакомляемых = 1;
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ОзнакомляемоеФизическоеЛицоПриИзменении(Элемент)
	
	ОзнакомляемоеФизическоеЛицоПриИзмененииНаСервере();
	
КонецПроцедуры

&НаКлиенте
Процедура ВыборНесколькихОзнакомляемыхПриИзменении(Элемент)
	
	УстановитьОтображениеОзнакомляемых(ЭтотОбъект);
	
КонецПроцедуры

&НаКлиенте
Процедура ЭлектронныеПодписиСотрудниковОбработкаВыбора(Элемент, ВыбранноеЗначение, СтандартнаяОбработка)
	
	Если ЗначениеЗаполнено(ВыбранноеЗначение) Тогда
		ОбработатьВыборСотрудников(ВыбранноеЗначение);
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ЭлектронныеПодписиСотрудниковПередУдалением(Элемент, Отказ)
	Отказ = Истина;
	СтрокиКУдалению = Новый Массив;
	СтрокиПодписантовКУдалению = Новый Массив;
	Для Каждого УдаляемаяСтрока Из Элементы.ЭлектронныеПодписиСотрудников.ВыделенныеСтроки Цикл
		СтрокаПодписи = ЭлектронныеПодписи.НайтиПоИдентификатору(УдаляемаяСтрока);
		Если СтрокаПодписи <> Неопределено Тогда
			СтрокиПодписанта = Объект.ВнешниеПодписанты.НайтиСтроки(Новый Структура("ФизическоеЛицо", СтрокаПодписи.ФизическоеЛицо));
			Для Каждого СтрокаПодписанта Из СтрокиПодписанта Цикл
				СтрокиПодписантовКУдалению.Добавить(СтрокаПодписанта);
			КонецЦикла;
			Если ЗначениеЗаполнено(СтрокаПодписи.ДатаПодписи) Тогда
				СтрокаПодписи.ПодписьСотрудника = Ложь;
			Иначе
				СтрокиКУдалению.Добавить(СтрокаПодписи);
			КонецЕсли;
			Модифицированность = Истина;
		КонецЕсли;
	КонецЦикла;
	Для Каждого УдаляемаяСтрока Из СтрокиПодписантовКУдалению Цикл
		Если ФизическоеЛицо = УдаляемаяСтрока.ФизическоеЛицо Тогда
			ФизическоеЛицо = Неопределено;
		КонецЕсли;
		Объект.ВнешниеПодписанты.Удалить(УдаляемаяСтрока);
	КонецЦикла;
	Для Каждого УдаляемаяСтрока Из СтрокиКУдалению Цикл
		ЭлектронныеПодписи.Удалить(УдаляемаяСтрока);
	КонецЦикла;
КонецПроцедуры

&НаКлиенте
Процедура Подключаемый_ОбработкаНавигационнойСсылки(Элемент, НавигационнаяСсылкаФорматированнойСтроки, СтандартнаяОбработка)
	
	СтандартнаяОбработка = Ложь;
	КадровыйЭДОВызовСервера.УдалитьФайлыИзОбработкиПользователя(
		ОбщегоНазначенияКлиентСервер.ЗначениеВМассиве(Объект.ЭлектронныйДокумент),
		ПредопределенноеЗначение("Перечисление.ДействияСФайламиДокументовКЭДО.Ознакомиться"));
	ОбновитьКомментарии();
	
КонецПроцедуры

&НаКлиенте
Процедура КодДокументаКадровогоМероприятияПриИзменении(Элемент)
	
	УстановитьОтображениеПодсказкиКодаДокумента();
	
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиКомандФормы

// СтандартныеПодсистемы.Свойства
&НаКлиенте
Процедура Подключаемый_СвойстваВыполнитьКоманду(ЭлементИлиКоманда, НавигационнаяСсылка = Неопределено, СтандартнаяОбработка = Неопределено)
	УправлениеСвойствамиКлиент.ВыполнитьКоманду(ЭтотОбъект, ЭлементИлиКоманда, СтандартнаяОбработка);
КонецПроцедуры
// Конец СтандартныеПодсистемы.Свойства

&НаКлиенте
Процедура Отправить(Команда)
	
	Если ЗначениеЗаполнено(Объект.ЭлектронныйДокумент) Тогда
		ОтправитьПечатныеФормыПоПочте();
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ПроверитьПодписи(Команда)
	
	Если Не ЗначениеЗаполнено(Объект.ЭлектронныйДокумент) Тогда
		Возврат
	КонецЕсли;
	
	Если Модифицированность Тогда
		Записать();
	КонецЕсли;
	
	КоллекцияПодписей = ЗаполнитьКоллекцииПодписей();
	
	ДанныеДляПроверкиПодписей = Новый Структура;
	ДанныеДляПроверкиПодписей.Вставить("ДокументКЭДО", Объект.Ссылка);
	ДанныеДляПроверкиПодписей.Вставить("ЭлектронныйДокумент", Объект.ЭлектронныйДокумент);
	ДанныеДляПроверкиПодписей.Вставить("СсылкаНаДвоичныеДанныеФайла", ДанныеЭлектронногоДокумента.СсылкаНаДвоичныеДанные);
	
	ПодписиДляПроверки = Новый Массив;
	Для каждого Идентификатор Из КоллекцияПодписей.ПодписиИБ Цикл
		ПодписиДляПроверки.Добавить(ЭлектронныеПодписи.НайтиПоИдентификатору(Идентификатор));
	КонецЦикла;
	ДанныеДляПроверкиПодписей.Вставить("ПодписиИБ", ПодписиДляПроверки);
	
	ПодписиДляПроверки = Новый Массив;
	Для каждого Идентификатор Из КоллекцияПодписей.ПодписиСервиса Цикл
		ПодписьСервиса = ЭлектронныеПодписи.НайтиПоИдентификатору(Идентификатор);
		ПодписиДляПроверки.Добавить(ПодписьСервиса);
	КонецЦикла;
	ДанныеДляПроверкиПодписей.Вставить("ПодписиСервиса", ПодписиДляПроверки);
	
	КадровыйЭДОКлиент.НачатьПроверкуПодписей(ОбщегоНазначенияКлиентСервер.ЗначениеВМассиве(ДанныеДляПроверкиПодписей), 0);
	
	РежимПросмотра = ТолькоПросмотр;
	Если Не РежимПросмотра Тогда
		ТолькоПросмотр = Истина;
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ПередатьВ1СКабинетСотрудника(Команда)
	
	Действия = Новый Массив;
	Если ПолучитьФункциональнуюОпциюФормы("ИспользуетсяКадровыйЭДОКабинетСотрудника") Тогда
		Действия.Добавить(ПредопределенноеЗначение("Перечисление.ДействияСФайламиДокументовКЭДО.ПередатьВКабинетСотрудников"));
	КонецЕсли;
	Если ПолучитьФункциональнуюОпциюФормы("ИспользоватьИнтеграциюСРаботаВРоссии") Тогда
		Действия.Добавить(ПредопределенноеЗначение("Перечисление.ДействияСФайламиДокументовКЭДО.ПередатьНаРаботаВРоссии"));
		
		Если Действия.Количество() = 1 И Не ОрганизацияИспользуетПРР(Объект.Организация) Тогда
			ПоказатьПредупреждение(, ИнтеграцияСРаботаВРоссииКлиент.ТекстПредупрежденияОрганизацияНеИспользуетПРР());
			Возврат;
		КонецЕсли;
	КонецЕсли;
	ДополнительныеПараметры = Новый Структура("Действия", Действия);
	
	Если Модифицированность Тогда
		
		ТекстВопроса = НСтр("ru = 'Перед подписанием и передачей документа, его необходимо записать.
			|Продолжить?';
			|en = 'Перед подписанием и передачей документа, его необходимо записать.
			|Продолжить?'");
		
		Оповещение = Новый ОписаниеОповещения("ПодписатьИПередатьДокумент", ЭтотОбъект, ДополнительныеПараметры);
		ПоказатьВопрос(Оповещение, ТекстВопроса, РежимДиалогаВопрос.ДаНетОтмена);
		
	Иначе
		ПодписатьИПередатьДокумент(КодВозвратаДиалога.Да, ДополнительныеПараметры);
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ПодписатьИПередатьДокумент(Ответ, ДополнительныеПараметры = Неопределено) Экспорт
	
	Если Ответ = КодВозвратаДиалога.Да Тогда
		
		Если Модифицированность Тогда
			
			Если Не ПроверитьЗаполнение() Тогда
				Возврат;
			КонецЕсли;
			Записать();
			
		КонецЕсли;
		
		Если ТребуетсяПодписьОрганизации Тогда
			
			ОповещениеЗавершения = Новый ОписаниеОповещения("ПослеПодписанияФайла", ЭтотОбъект, ДополнительныеПараметры);
			
			ПодписываемыеФайлы = ОбщегоНазначенияКлиентСервер.ЗначениеВМассиве(Объект.ЭлектронныйДокумент);
			КадровыйЭДОКлиент.ПодписатьФайлы(
				КадровыйЭДОВызовСервера.ДанныеФайловНаПодпись(ПодписываемыеФайлы, УникальныйИдентификатор),
				ОповещениеЗавершения,
				ЭтотОбъект,
				ПредопределенноеЗначение("Перечисление.ДействияСФайламиДокументовКЭДО.ПередатьВКабинетСотрудников"));
			
		Иначе
			ПослеПодписанияФайла(Истина, ДополнительныеПараметры);
		КонецЕсли;
		 
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ПослеПодписанияФайла(ПомещенныеФайлы, ДополнительныеПараметры) Экспорт
	
	Если ПомещенныеФайлы <> Неопределено Тогда
		
		Действия = ДополнительныеПараметры.Действия;
		
		Для Каждого Действие Из Действия Цикл
			ПослеПодписанияФайлаНаСервере(Действие);
		КонецЦикла;
		
		Если ТребуетсяПодписьОрганизации Тогда
			КадровыйЭДОКлиент.ПоказатьСостояниеОтправленныхНаПодпись(ДополнительныеПараметры);
			КадровыйЭДОКлиент.ОповеститьОНеобходимостиОбновленияФорм(Объект.Ссылка);
		КонецЕсли;
		УстановитьОтображениеЭлементовФормы(ЭтотОбъект, ЭлектроннаяПодписьКлиент.ИспользоватьЭлектронныеПодписи());
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Процедура ПослеПодписанияФайлаНаСервере(Действие)
	
	Если ТребуетсяПодписьОрганизации Тогда
		КадровыйЭДОВызовСервера.УдалитьФайлыИзОбработкиПользователя(
			ОбщегоНазначенияКлиентСервер.ЗначениеВМассиве(Объект.ЭлектронныйДокумент));
	КонецЕсли;
	
	КадровыйЭДОВызовСервера.ЗапланироватьДействияСПечатнымиФормами(
		ОбщегоНазначенияКлиентСервер.ЗначениеВМассиве(Объект.ЭлектронныйДокумент), Действие);
	
	ПрочитатьЭлектронныеПодписи();
	Если ТребуетсяПодписьОрганизации Тогда
		ОбновитьЗначениеТребуетсяПодписьОрганизации();
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ВыбратьСотрудников(Команда)
	
	КадровыйУчетКлиент.ВыбратьСотрудниковРаботающихНаДатуПоПараметрамОткрытияФормыСписка(
		Элементы.ЭлектронныеПодписиСотрудников, Объект.Организация, , Объект.Дата, Истина, АдресСпискаПодобранных());
	
КонецПроцедуры

&НаКлиенте
Процедура Задания(Команда)
	
	Отборы = Новый Структура("ПрисоединенныйФайл", Объект.ЭлектронныйДокумент);
	ПараметрыОткрытия = Новый Структура("Отбор", Отборы);
	ПараметрыОткрытия.Вставить("Организация", Объект.Организация);
	
	ОткрытьФорму("РегистрСведений.ЗапланированныеДействияСФайламиДокументовКЭДО.ФормаСписка",
		ПараметрыОткрытия, ЭтотОбъект, Истина, , , , РежимОткрытияОкнаФормы.БлокироватьОкноВладельца);
	
КонецПроцедуры

&НаКлиенте
Процедура ОткрытьРедакторТабличногоДокумента(Команда)
	
	Если Не Объект.ПроизвольнаяТаблица Тогда
		Объект.ПроизвольнаяТаблица = Истина;
		УстановитьОтображениеЭлементовФормы(ЭтотОбъект, ЭлектроннаяПодписьКлиент.ИспользоватьЭлектронныеПодписи());
		ТекущийЭлемент = Элементы.НаименованиеДокумента;
	Иначе
		ОчиститьСообщения();
		Если ПустаяСтрока(Объект.НаименованиеДокумента) Тогда
			ОбщегоНазначенияКлиент.СообщитьПользователю(
				НСтр("ru = 'Не заполнено наименование документа';
					|en = 'Document name is not filled.'"), , "НаименованиеДокумента", "Объект");
		Иначе
			ПараметрыОткрытия = Новый Структура;
			ПараметрыОткрытия.Вставить("ТолькоПросмотр", ТолькоПросмотр);
			ПараметрыОткрытия.Вставить("Документ", Документ);
			ПараметрыОткрытия.Вставить("Организация", Объект.Организация);
			ПараметрыОткрытия.Вставить("НаименованиеДокумента", Объект.НаименованиеДокумента);
			Если Не ЗначениеЗаполнено(Объект.Дата) Тогда
				ПараметрыОткрытия.Вставить("Дата", ОбщегоНазначенияКлиент.ДатаСеанса());
			Иначе
				ПараметрыОткрытия.Вставить("Дата", Объект.Дата);
			КонецЕсли;
			
			Оповещение = Новый ОписаниеОповещения("ОткрытьРедакторТабличногоДокументаЗавершение", ЭтотОбъект);
			
			ОткрытьФорму("Документ.ДокументКадровогоЭДО.Форма.РедакторТабличногоДокумента",
				ПараметрыОткрытия, ЭтотОбъект, Истина, , , Оповещение, РежимОткрытияОкнаФормы.БлокироватьОкноВладельца);
		КонецЕсли;
	КонецЕсли;
	
	УстановитьПодсказкуГруппеВыбораФайлов(ЭтотОбъект);
	
КонецПроцедуры

&НаКлиенте
Процедура ОткрытьРедакторТабличногоДокументаЗавершение(Результат, ДополнительныеПараметры) Экспорт
	
	Если Результат <> Неопределено Тогда
		Документ = Результат;
		Модифицированность = Истина;
		ДокументМодифицирован = Истина;
		Объект.ФорматДокументаСоответствуетТребованиям = Истина;
		УстановитьОтображениеЭлементовФормы(ЭтотОбъект, ЭлектроннаяПодписьКлиент.ИспользоватьЭлектронныеПодписи());
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура РазблокироватьДокумент(Команда)
	
	Оповещение = Новый ОписаниеОповещения("ОбработкаОтветаПриРазблокировкеДокумента", ЭтотОбъект);
	ПоказатьВопрос(Оповещение, НСтр("ru = 'При разблокировке документа, будут удалены все установленные подписи.
		|
		|Продолжить?';
		|en = 'If you unlock the document, all installed signatures will be deleted.
		|
		|Continue?'"), РежимДиалогаВопрос.ДаНетОтмена);
	
КонецПроцедуры

&НаКлиенте
Процедура ОбработкаОтветаПриРазблокировкеДокумента(Результат, ДополнительныеПараметры) Экспорт
	
	Если Результат = КодВозвратаДиалога.Да Тогда
		РазблокироватьДокументНаСервере();
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

// СтандартныеПодсистемы.Свойства 

&НаКлиенте
Процедура ОбновитьЗависимостиДополнительныхРеквизитов()
	УправлениеСвойствамиКлиент.ОбновитьЗависимостиДополнительныхРеквизитов(ЭтотОбъект);
КонецПроцедуры

&НаКлиенте
Процедура Подключаемый_ПриИзмененииДополнительногоРеквизита(Элемент)
	УправлениеСвойствамиКлиент.ОбновитьЗависимостиДополнительныхРеквизитов(ЭтотОбъект);
КонецПроцедуры

&НаСервере
Процедура ОбновитьЭлементыДополнительныхРеквизитов()

	УправлениеСвойствами.ОбновитьЭлементыДополнительныхРеквизитов(ЭтотОбъект);

КонецПроцедуры

// Конец СтандартныеПодсистемы.Свойства

#Область ОбработчикиСобытийПроцессыОбработкиДокументов

&НаКлиенте
Процедура Подключаемый_ВыполнитьЗадачуПоОбработкеДокумента(Команда)
	// ПроцессыОбработкиДокументов
	Если ОбщегоНазначенияКлиент.ПодсистемаСуществует("ЗарплатаКадрыПриложения.ПроцессыОбработкиДокументовЗарплата") Тогда
		МодульПроцессыОбработкиДокументовЗарплата = ОбщегоНазначенияКлиент.ОбщийМодуль("ПроцессыОбработкиДокументовЗарплатаКлиент");
		МодульПроцессыОбработкиДокументовЗарплата.ВыполнитьЗадачу(ЭтотОбъект, Команда, Объект)
	КонецЕсли;		
	// Конец ПроцессыОбработкиДокументов
КонецПроцедуры

&НаКлиенте
Процедура Подключаемый_ВыполнитьЗадачуПоОбработкеДокументаОповещение(Контекст, ДополнительныеПараметры) Экспорт
	ВыполнитьЗадачуПоОбработкеДокументаНаСервере(Контекст);
	ВыполнитьОбработкуОповещения(ДополнительныеПараметры, Контекст);
КонецПроцедуры

&НаСервере
Процедура ВыполнитьЗадачуПоОбработкеДокументаНаСервере(Контекст)
	// ПроцессыОбработкиДокументов
	Если ОбщегоНазначения.ПодсистемаСуществует("ЗарплатаКадрыПриложения.ПроцессыОбработкиДокументовЗарплата") Тогда	
		МодульПроцессыОбработкиДокументовЗарплата = ОбщегоНазначения.ОбщийМодуль("ПроцессыОбработкиДокументовЗарплата");
		МодульПроцессыОбработкиДокументовЗарплата.ВыполнитьЗадачу(ЭтотОбъект, Контекст, Объект);
	КонецЕсли;		
	// Конец ПроцессыОбработкиДокументов
КонецПроцедуры

&НаКлиенте
Процедура Подключаемый_КомментарийНаправившегоОткрытие(Элемент, СтандартнаяОбработка)
	// ПроцессыОбработкиДокументов
	Если ОбщегоНазначенияКлиент.ПодсистемаСуществует("ЗарплатаКадрыПриложения.ПроцессыОбработкиДокументовЗарплата") Тогда	
		МодульПроцессыОбработкиДокументовЗарплата = ОбщегоНазначенияКлиент.ОбщийМодуль("ПроцессыОбработкиДокументовЗарплатаКлиент");
		МодульПроцессыОбработкиДокументовЗарплата.КомментарийНаправившегоОткрытие(ЭтотОбъект, Элемент, СтандартнаяОбработка);
	КонецЕсли;		
	// Конец ПроцессыОбработкиДокументов
КонецПроцедуры

&НаКлиенте
Процедура Подключаемый_КомментарийСледующемуНачалоВыбора(Элемент, ДанныеВыбора, СтандартнаяОбработка)
	// ПроцессыОбработкиДокументов
	Если ОбщегоНазначенияКлиент.ПодсистемаСуществует("ЗарплатаКадрыПриложения.ПроцессыОбработкиДокументовЗарплата") Тогда	
		МодульПроцессыОбработкиДокументовЗарплата = ОбщегоНазначенияКлиент.ОбщийМодуль("ПроцессыОбработкиДокументовЗарплатаКлиент");
		МодульПроцессыОбработкиДокументовЗарплата.КомментарийСледующемуНачалоВыбора(ЭтотОбъект, Элемент, ДанныеВыбора, СтандартнаяОбработка);
	КонецЕсли;		
	// Конец ПроцессыОбработкиДокументов
КонецПроцедуры

#КонецОбласти

// СтандартныеПодсистемы.ПодключаемыеКоманды

&НаКлиенте
Процедура Подключаемый_ВыполнитьКоманду(Команда)
	ПодключаемыеКомандыКлиент.ВыполнитьКоманду(ЭтотОбъект, Команда, Объект);
КонецПроцедуры

&НаСервере
Процедура Подключаемый_ВыполнитьКомандуНаСервере(Контекст, Результат) Экспорт
	ПодключаемыеКоманды.ВыполнитьКоманду(ЭтотОбъект, Контекст, Объект, Результат);
КонецПроцедуры

&НаКлиенте
Процедура Подключаемый_ОбновитьКоманды()
	ОбновитьПодключаемыеКоманды(ЭтотОбъект);
КонецПроцедуры

// Конец СтандартныеПодсистемы.ПодключаемыеКоманды

// СтандартныеПодсистемы.КонтрольВеденияУчета

&НаКлиенте
Процедура Подключаемый_ОткрытьОтчетПоПроблемам(ЭлементИлиКоманда, НавигационнаяСсылка, СтандартнаяОбработка)
	
	КонтрольВеденияУчетаКлиентБЗК.ОткрытьОтчетПоПроблемамОбъекта(ЭтотОбъект, Объект.Ссылка, СтандартнаяОбработка);
	
КонецПроцедуры

// Конец СтандартныеПодсистемы.КонтрольВеденияУчета

&НаКлиенте
Процедура ВыбратьФайлСДиска()
	
	Объект.ПроизвольнаяТаблица = Ложь;
	УстановитьОтображениеЭлементовФормы(ЭтотОбъект, ЭлектроннаяПодписьКлиент.ИспользоватьЭлектронныеПодписи());
	
	ПараметрыЗагрузкиФайла = ФайловаяСистемаКлиент.ПараметрыЗагрузкиФайла();
	ПараметрыЗагрузкиФайла.ИдентификаторФормы = УникальныйИдентификатор;
	
	ПараметрыЗагрузкиФайла.Диалог.МножественныйВыбор = Ложь;
	ПараметрыЗагрузкиФайла.Диалог.Заголовок = НСтр("ru = 'Выберите документ';
													|en = 'Select document'");
	
	ФайлыФильтра = Новый Массив;
	ФайлыФильтра.Добавить(СтрШаблон(
		НСтр("ru = 'PDF файлы (%1)|%1';
			|en = 'PDF files (%1)|%1'"),
		КадровыйЭДОКлиентСервер.РасширениеPDFДокумента()));
	
	ПараметрыЗагрузкиФайла.Диалог.Фильтр = СтрСоединить(ФайлыФильтра, "|");
	
	Оповещение = Новый ОписаниеОповещения("ОбработатьВыборФайлаСДиска", ЭтотОбъект);
	ФайловаяСистемаКлиент.ЗагрузитьФайлы(Оповещение, ПараметрыЗагрузкиФайла);
	
КонецПроцедуры

&НаКлиенте
Процедура ОбработатьВыборФайлаСДиска(ВыбранныеФайлы, ДополнительныеПараметры) Экспорт
	
	Если ЗначениеЗаполнено(ВыбранныеФайлы) Тогда
		ПрочитатьДанныеФайлаСДиска(ВыбранныеФайлы[0]);
		УстановитьОтображениеЭлементовФормы(ЭтотОбъект, ЭлектроннаяПодписьКлиент.ИспользоватьЭлектронныеПодписи());
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Процедура ПриПолученииДанныхНаСервере()
	
	ДоступноПравоУправлятьЗаданиями = Пользователи.ЭтоПолноправныйПользователь();
	
	Если Параметры.Ключ.Пустая() Тогда
		Заголовок = НСтр("ru = 'Карточка электронного документа (создание)';
						|en = 'Electronic document card (create)'");
	Иначе
		
		Заголовок = СтрШаблон(
			НСтр("ru = 'Карточка электронного документа. %1';
				|en = 'Electronic document card. %1'"),
			Объект.КатегорияДокумента);
		
	КонецЕсли;
	
	Если Объект.ВнешниеПодписанты.Количество() = 1 Тогда
		ФизическоеЛицо = Объект.ВнешниеПодписанты[0].ФизическоеЛицо;
	КонецЕсли;
	
	ПрочитатьДанныеФайла();
	ПрочитатьЭлектронныеПодписи();
	ПрочитатьСтатусыПРР();
	
	Если ЭлектронныеПодписи.Выгрузить(Новый Структура("ПодписьСотрудника", Истина)).Количество() > 1 Тогда
		ВыборОзнакомляемых = 1;
	Иначе
		ВыборОзнакомляемых = 0;
	КонецЕсли;
	
	УстановитьОтображениеЭлементовФормы(ЭтотОбъект, ЭлектроннаяПодпись.ИспользоватьЭлектронныеПодписи());
	
	ОбновитьКомментарии();
	
	Если Объект.Ссылка.Пустая() Тогда
		ОбщегоНазначенияКлиентСервер.УстановитьСвойствоЭлементаФормы(
			Элементы,
			"ИмяФайлаСРасширением",
			"Шрифт",
			ШрифтыСтиля.ОбычныйШрифтТекста);
	Иначе
		ОбщегоНазначенияКлиентСервер.УстановитьСвойствоЭлементаФормы(
			Элементы,
			"ИмяФайлаСРасширением",
			"Шрифт",
			ШрифтыСтиля.ВажнаяНадписьШрифт);
	КонецЕсли;
	
	УстановитьОтображениеПодсказкиКодаДокумента();
	
	ОбщегоНазначенияКлиентСервер.УстановитьСвойствоЭлементаФормы(
		Элементы,
		"КодДокументаКадровогоМероприятия",
		"Видимость",
		Объект.ФорматДокументаСоответствуетТребованиям);
	
	Если Объект.ПроизвольнаяТаблица И Не Объект.Ссылка.Пустая() Тогда
		ЗаполнитьДокумент(Объект.ЭлектронныйДокумент);
	КонецЕсли;
	
	ОбщегоНазначенияКлиентСервер.УстановитьСвойствоЭлементаФормы(
		Элементы,
		"ВариантПодписанияСотрудника",
		"Видимость",
		Объект.Внешний);
	
	ОбщегоНазначенияКлиентСервер.УстановитьСвойствоЭлементаФормы(
		Элементы,
		"ВариантПодписания",
		"Видимость",
		Объект.Внешний);
	
	ОбщегоНазначенияКлиентСервер.УстановитьСвойствоЭлементаФормы(
		Элементы,
		"ВариантПодписанияСписка",
		"Видимость",
		Объект.Внешний);
		
	УстановитьПодсказкуГруппеВыбораФайлов(ЭтотОбъект);
	
КонецПроцедуры

&НаКлиентеНаСервереБезКонтекста
Процедура УстановитьПодсказкуГруппеВыбораФайлов(УправляемаяФорма)
	ПодсказкаДокумента = "";
	Если УправляемаяФорма.Объект.Внешний и Не УправляемаяФорма.Объект.ПроизвольнаяТаблица Тогда
		ПодсказкаДокумента = НСтр("ru = 'Для отображения штампов подписей, необходимо обеспечить достаточное место в конце документа';
									|en = 'Для отображения штампов подписей, необходимо обеспечить достаточное место в конце документа'");
	КонецЕсли;
	ЗарплатаКадрыКлиентСервер.УстановитьРасширеннуюПодсказкуЭлементуФормы(
		УправляемаяФорма, "ФайлТабличныйДокументГруппа", ПодсказкаДокумента);
КонецПроцедуры


&НаСервере
Функция ЗаполнитьДокумент(ЭлектронныйДокумент)
	УстановитьПривилегированныйРежим(Истина);
	ДанныеПечатнойФормы = РегистрыСведений.ПодписанныеПечатныеФормы.ДанныеФайлаПечатнойФормы(ЭлектронныйДокумент);
	УстановитьПривилегированныйРежим(Ложь);
	Если ДанныеПечатнойФормы <> Неопределено Тогда
		Документ = ДанныеПечатнойФормы.Оригинал.Получить();
	КонецЕсли;
КонецФункции

&НаСервере
Процедура ПрочитатьЭлектронныеПодписи(РезультатыПроверки = Неопределено, ОбновитьТребуетсяПодписьОрганизации = Ложь)
	
	Если РезультатыПроверки = Неопределено
		И ЭлектронныеПодписи.Количество() > 0 Тогда
		
		Для Каждого ДанныеПодписи Из ЭлектронныеПодписи Цикл
			Если Не ДанныеПодписи.ПодписьВерна Тогда
				РезультатПроверки = Новый Структура("Статус,ПодписьВерна,ОписаниеОшибки,ДатаПроверкиПодписи");
				ЗаполнитьЗначенияСвойств(РезультатПроверки, ДанныеПодписи);
				Если РезультатыПроверки = Неопределено Тогда
					РезультатыПроверки = Новый Соответствие;
				КонецЕсли;
				РезультатыПроверки.Вставить(ДанныеПодписи.Отпечаток, РезультатПроверки);
			КонецЕсли;
		КонецЦикла;
	КонецЕсли;
	
	ЭлектронныеПодписи.Очистить();
	
	ИдентификаторыКоманд = Новый Соответствие;
	ИдентификаторыКоманд.Вставить("БЗК_ДокументСВерсиейДляПечати", Ложь);
	
	ЕстьПодписиДокумента = Ложь;
	
	Если Объект.Ссылка.Пустая() Тогда
		Возврат;
	КонецЕсли;
	
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("ДокументКЭДО", Объект.Ссылка);
	Запрос.УстановитьПараметр(
		"ФизическиеЛица", Объект.ВнешниеПодписанты.Выгрузить().ВыгрузитьКолонку("ФизическоеЛицо"));
	
	Запрос.Текст =
		"ВЫБРАТЬ
		|	ФизическиеЛица.Ссылка КАК ФизическоеЛицо,
		|	ЕСТЬNULL(ПодписиДокументовКЭДО.Отпечаток, """") КАК Отпечаток,
		|	ПодписиДокументовКЭДО.ДатаПодписи КАК ДатаПодписи,
		|	ФизическиеЛица.ФИО КАК КомуВыданСертификат,
		|	ПодписиДокументовКЭДО.РезультатСогласования КАК РезультатСогласования
		|ИЗ
		|	Справочник.ФизическиеЛица КАК ФизическиеЛица
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ПодписиДокументовКЭДО КАК ПодписиДокументовКЭДО
		|		ПО ФизическиеЛица.Ссылка = ПодписиДокументовКЭДО.ФизическоеЛицо
		|			И (ПодписиДокументовКЭДО.Объект = &ДокументКЭДО)
		|ГДЕ
		|	ФизическиеЛица.Ссылка В(&ФизическиеЛица)";
	
	УстановитьПривилегированныйРежим(Истина);
	ПодписиФизическихЛицДокумента = Запрос.Выполнить().Выгрузить();
	УстановитьПривилегированныйРежим(Ложь);
	
	Если ЗначениеЗаполнено(Объект.Ссылка) Тогда
		
		Запрос.УстановитьПараметр("ПодписанныйОбъект", Объект.ЭлектронныйДокумент);
		Запрос.Текст =
			"ВЫБРАТЬ
			|	ЭлектронныеПодписи.ПодписанныйОбъект КАК ПодписанныйОбъект,
			|	ЭлектронныеПодписи.ПорядковыйНомер КАК ПорядковыйНомер,
			|	ЭлектронныеПодписи.ДатаПроверкиПодписи КАК ДатаПроверкиПодписи,
			|	ЭлектронныеПодписи.ИмяФайлаПодписи КАК ИмяФайлаПодписи,
			|	ЭлектронныеПодписи.Комментарий КАК Комментарий,
			|	ЭлектронныеПодписи.КомуВыданСертификат КАК КомуВыданСертификат,
			|	ЭлектронныеПодписи.Подпись КАК Подпись,
			|	ЭлектронныеПодписи.ПодписьВерна КАК ПодписьВерна,
			|	ЭлектронныеПодписи.ДатаПодписи КАК ДатаПодписи,
			|	ЭлектронныеПодписи.УстановившийПодпись КАК УстановившийПодпись,
			|	ЭлектронныеПодписи.Отпечаток КАК Отпечаток,
			|	ЭлектронныеПодписи.ТипПодписи КАК ТипПодписи,
			|	ЭлектронныеПодписи.СрокДействияПоследнейМеткиВремени КАК СрокДействияПоследнейМеткиВремени,
			|	ЭлектронныеПодписи.ТребуетсяПроверка КАК ТребуетсяПроверка
			|ИЗ
			|	РегистрСведений.ЭлектронныеПодписи КАК ЭлектронныеПодписи
			|ГДЕ
			|	ЭлектронныеПодписи.ПодписанныйОбъект = &ПодписанныйОбъект";
		
		УстановитьПривилегированныйРежим(Истина);
		Выборка = Запрос.Выполнить().Выбрать();
		УстановитьПривилегированныйРежим(Ложь);
		
		ЕстьПодписиДокумента = Выборка.Количество() > 0;
		Пока Выборка.Следующий() Цикл
			
			СтрокаПодписи = ЭлектронныеПодписи.Добавить();
			ЗаполнитьЗначенияСвойств(СтрокаПодписи, Выборка);
			СтрокаПодписи.АдресПодписи = ПоместитьВоВременноеХранилище(Выборка.Подпись.Получить(), УникальныйИдентификатор);
			РаботаСФайламиСлужебныйКлиентСервер.ЗаполнитьСтатусПодписи(СтрокаПодписи, ТекущаяДатаСеанса());
			Если ЗначениеЗаполнено(СтрокаПодписи.Отпечаток) Тогда
				СотрудникПодписи = ПодписиФизическихЛицДокумента.Найти(СтрокаПодписи.Отпечаток, "Отпечаток");
				Если СотрудникПодписи <> Неопределено Тогда
					СтрокаПодписи.ФизическоеЛицо = СотрудникПодписи.ФизическоеЛицо;
					СтрокаПодписи.ПодписьСотрудника = Истина;
					СтрокаПодписи.РезультатСогласования = СотрудникПодписи.РезультатСогласования;
					ПодписиФизическихЛицДокумента.Удалить(СотрудникПодписи);
				КонецЕсли;
			КонецЕсли;
			Если РезультатыПроверки <> Неопределено Тогда
				
				РезультатПроверки = РезультатыПроверки.Получить(СтрокаПодписи.Отпечаток);
				Если РезультатПроверки <> Неопределено Тогда
					СтрокаПодписи.Статус = РезультатПроверки.Статус;
					СтрокаПодписи.ПодписьВерна = РезультатПроверки.ПодписьВерна;
					СтрокаПодписи.ОписаниеОшибки = РезультатПроверки.ОписаниеОшибки;
					СтрокаПодписи.ДатаПроверкиПодписи = РезультатПроверки.ДатаПроверкиПодписи;
				КонецЕсли;
			КонецЕсли;
		КонецЦикла;
	КонецЕсли;
	
	ЕстьЭлектронныеПодписиДокумента = ЕстьПодписиДокумента;
	Для Каждого СотрудникПодписи Из ПодписиФизическихЛицДокумента Цикл
		СтрокаПодписи = ЭлектронныеПодписи.Добавить();
		СтрокаПодписи.ФизическоеЛицо = СотрудникПодписи.ФизическоеЛицо;
		СтрокаПодписи.КомуВыданСертификат = СотрудникПодписи.КомуВыданСертификат;
		СтрокаПодписи.ДатаПодписи = СотрудникПодписи.ДатаПодписи;
		СтрокаПодписи.РезультатСогласования = СотрудникПодписи.РезультатСогласования;
		Если ЗначениеЗаполнено(СотрудникПодписи.ДатаПодписи) Тогда
			СтрокаПодписи.Статус = НСтр("ru = 'Требуется собственноручная подпись';
										|en = 'Sign manually'");
			ЕстьПодписиДокумента = Истина;
		КонецЕсли;
		СтрокаПодписи.ПодписьСотрудника = Истина;
	КонецЦикла;
	
	ОбновитьПорядокПодписей();
	
	Если ЕстьЭлектронныеПодписиДокумента Тогда
		УстановитьПривилегированныйРежим(Истина);
		МенеджерЗаписи = РегистрыСведений.СостоянияДокументовКЭДО.СоздатьМенеджерЗаписи();
		МенеджерЗаписи.Объект = Объект.Ссылка;
		МенеджерЗаписи.Прочитать();
		УстановитьПривилегированныйРежим(Ложь);
		Если МенеджерЗаписи.Выбран() Тогда
			ИдентификаторыКоманд["БЗК_ДокументСВерсиейДляПечати"] = МенеджерЗаписи.ЕстьВерсияДляПечати;
		Иначе
			ИдентификаторыКоманд["БЗК_ДокументСВерсиейДляПечати"] = Ложь;
		КонецЕсли;
	Иначе
		ИдентификаторыКоманд["БЗК_ДокументСВерсиейДляПечати"] = Ложь;
	КонецЕсли;
	
	Элементы.ЭлектронныеПодписиСотрудников.ОтборСтрок = Новый ФиксированнаяСтруктура(Новый Структура("ПодписьСотрудника", Истина));
	Элементы.ЭлектронныеПодписи.ОтборСтрок = Новый ФиксированнаяСтруктура(Новый Структура("ПодписьСотрудника", Ложь));
	
	УстановитьПодсказкуСотруднику(ЭтотОбъект);
	Если ОбновитьТребуетсяПодписьОрганизации
		И ТребуетсяПодписьОрганизации Тогда
		
		ОбновитьЗначениеТребуетсяПодписьОрганизации();
	КонецЕсли;
	
	ИдентификаторыФайловСЭЦП = Новый ФиксированноеСоответствие(ИдентификаторыКоманд);
	ОбновитьПодключаемыеКоманды(ЭтотОбъект);
	
КонецПроцедуры

&НаКлиенте
Процедура ПрочитатьДанныеФайлаСДиска(ВыбранныйФайл)
	
	Если РазмерФайла(ВыбранныйФайл.Хранение) = 0 Тогда
		
		ТекстПредупреждения = НСтр("ru = 'Допустимо выбирать файлы, размер которых больше 0.';
									|en = 'You can select files larger than 0.'");
		ПоказатьПредупреждение(, ТекстПредупреждения);
		
	Иначе
		
		Модифицированность = Истина;
		
		Файл = Новый Файл(ВыбранныйФайл.ИмяФайла);
		ИмяФайлаСРасширением = Файл.Имя;
		Расширение = СтрЗаменить(Файл.Расширение, ".", "");
		
		ДанныеПрисоединенногоФайла = Новый Структура;
		ДанныеПрисоединенногоФайла.Вставить("Зашифрован", Ложь);
		ДанныеПрисоединенногоФайла.Вставить("СсылкаНаДвоичныеДанные", ВыбранныйФайл.Хранение);
		
		ПрименитьДанныеПрисоединенногоФайла(ЭтотОбъект, ДанныеПрисоединенногоФайла);
		
	КонецЕсли;
	
КонецПроцедуры

&НаСервереБезКонтекста
Функция РазмерФайла(АдресВХранилище)
	Возврат ПолучитьИзВременногоХранилища(АдресВХранилище).Размер();
КонецФункции

&НаСервере
Процедура ПрочитатьДанныеФайла()
	
	Если Не ЗначениеЗаполнено(Объект.ЭлектронныйДокумент) Тогда
		ИмяФайлаСРасширением = НСтр("ru = 'Выбрать файл электронного документа на диске';
									|en = 'Select an electronic document file on the hard drive'");
		Возврат;
	КонецЕсли;
	
	ПараметрыДанныхФайла = РаботаСФайламиКлиентСервер.ПараметрыДанныхФайла();
	ПараметрыДанныхФайла.ИдентификаторФормы = УникальныйИдентификатор;
	
	Попытка
		ДанныеФайла = РаботаСФайлами.ДанныеФайла(Объект.ЭлектронныйДокумент, ПараметрыДанныхФайла);
	Исключение
		Ошибка = ИнформацияОбОшибке();
		ЗарплатаКадрыКлиентСервер.УстановитьРасширеннуюПодсказкуЭлементуФормы(
			ЭтотОбъект,
			"ИмяФайлаСРасширением",
			КраткоеПредставлениеОшибки(Ошибка));
		ПараметрыДанныхФайла.ПолучатьСсылкуНаДвоичныеДанные = Ложь;
		ДанныеФайла = РаботаСФайлами.ДанныеФайла(Объект.ЭлектронныйДокумент, ПараметрыДанныхФайла);
	КонецПопытки;
	
	ИмяФайлаСРасширением = ДанныеФайла.ИмяФайла;
	Расширение = ДанныеФайла.Расширение;
	Если ЗначениеЗаполнено(Расширение)
		И Не СтрЗаканчиваетсяНа(ИмяФайлаСРасширением, Расширение) Тогда
		
		ИмяФайлаСРасширением = СтрШаблон("%1.%2", ИмяФайлаСРасширением, Расширение);
	КонецЕсли;
	
	ДанныеПрисоединенногоФайла = Новый Структура;
	ДанныеПрисоединенногоФайла.Вставить("Зашифрован", ДанныеФайла.Зашифрован);
	ДанныеПрисоединенногоФайла.Вставить("СсылкаНаДвоичныеДанные", ДанныеФайла.СсылкаНаДвоичныеДанныеФайла);
	
	ПрименитьДанныеПрисоединенногоФайла(ЭтотОбъект, ДанныеПрисоединенногоФайла);
	
КонецПроцедуры

#Область ПРР

&НаСервере
Процедура ПрочитатьСтатусыПРР()
	
	УстановитьПривилегированныйРежим(Истина);
	ИдентификаторДокумента = РегистрыСведений.ИдентификаторыДокументовНаРаботаВРоссии.ИдентификаторДокумента(Объект.ЭлектронныйДокумент);
	
	Если ИдентификаторДокумента = Неопределено Тогда
		ИдентификаторПРР = "";
	Иначе
		ИдентификаторПРР = ИдентификаторДокумента;
	КонецЕсли;
	
КонецПроцедуры

&НаСервереБезКонтекста
Функция ОрганизацияИспользуетПРР(Организация)
	
	Возврат ИнтеграцияСРаботаВРоссии.ОрганизацияИспользуетПРР(Организация);
	
КонецФункции

#КонецОбласти

&НаКлиентеНаСервереБезКонтекста
Процедура ПрименитьДанныеПрисоединенногоФайла(УправляемаяФорма, ДанныеПрисоединенногоФайла)
	
	УправляемаяФорма.ДанныеЭлектронногоДокумента = Новый ФиксированнаяСтруктура(ДанныеПрисоединенногоФайла);
	
КонецПроцедуры

&НаСервере
Процедура НастроитьФорму()
	
	Если ИнтеграцияСРаботаВРоссии.ДоступнаПередачаДокументовНаРаботаВРоссии() Тогда
		Если ПолучитьФункциональнуюОпцию("ИспользуетсяКадровыйЭДОКабинетСотрудника") Тогда
			СвойстваКоманды = КадровыйЭДО.СвойстваКомандыПередачиНаПорталРаботаВРоссииИВКабинетСотрудника();
		Иначе
			СвойстваКоманды = ИнтеграцияСРаботаВРоссии.СвойстваКомандыПередачиНаПорталРаботаВРоссии();
		КонецЕсли;
	Иначе
		СвойстваКоманды = ИнтеграцияКабинетСотрудника.СвойстваКомандыПередачиВКабинетСотрудника();
	КонецЕсли;

	ОбщегоНазначенияКлиентСервер.УстановитьСвойствоЭлементаФормы(
		Элементы,
		"ФормаПередатьВ1СКабинетСотрудника",
		"Заголовок",
		СвойстваКоманды.Заголовок);
	
	ЗарплатаКадрыКлиентСервер.УстановитьРасширеннуюПодсказкуЭлементуФормы(
		ЭтотОбъект,
		"ФормаПередатьВ1СКабинетСотрудника",
		СвойстваКоманды.Подсказка);
	
	ОбщегоНазначенияКлиентСервер.УстановитьСвойствоЭлементаФормы(
		Элементы,
		"ФормаПередатьВ1СКабинетСотрудника",
		"Картинка",
		СвойстваКоманды.Картинка);
	
КонецПроцедуры

&НаСервере
Процедура УстановитьУсловноеОформление()
	
	ЭлементОформления = УсловноеОформление.Элементы.Добавить();
	ЭлементОформления.Использование = Истина;
	
	ЭлементОтбора = ЭлементОформления.Отбор.Элементы.Добавить(Тип("ЭлементОтбораКомпоновкиДанных"));
	ЭлементОтбора.Использование		= Истина;
	ЭлементОтбора.ЛевоеЗначение		= Новый ПолеКомпоновкиДанных("ЭлектронныеПодписи.ДатаПроверкиПодписи");
	ЭлементОтбора.ВидСравнения		= ВидСравненияКомпоновкиДанных.Заполнено;
	ЭлементОтбора.ПравоеЗначение	= Истина;
	
	ЭлементОтбора = ЭлементОформления.Отбор.Элементы.Добавить(Тип("ЭлементОтбораКомпоновкиДанных"));
	ЭлементОтбора.Использование		= Истина;
	ЭлементОтбора.ЛевоеЗначение		= Новый ПолеКомпоновкиДанных("ЭлектронныеПодписи.ПодписьВерна");
	ЭлементОтбора.ВидСравнения		= ВидСравненияКомпоновкиДанных.Равно;
	ЭлементОтбора.ПравоеЗначение	= Ложь;
	
	ЭлементОформления.Оформление.УстановитьЗначениеПараметра("ЦветТекста", ЦветаСтиля.ПоясняющийОшибкуТекст);
	
	ОформляемоеПоле = ЭлементОформления.Поля.Элементы.Добавить();
	ОформляемоеПоле.Поле = Новый ПолеКомпоновкиДанных("ЭлектронныеПодписи");
	ОформляемоеПоле.Использование = Истина;
	
	ЭлементОформления = УсловноеОформление.Элементы.Добавить();
	ЭлементОформления.Использование = Истина;
	
	ЭлементОтбора = ЭлементОформления.Отбор.Элементы.Добавить(Тип("ЭлементОтбораКомпоновкиДанных"));
	ЭлементОтбора.Использование		= Истина;
	ЭлементОтбора.ЛевоеЗначение		= Новый ПолеКомпоновкиДанных("ЭлектронныеПодписи.ПодписьСотрудника");
	ЭлементОтбора.ВидСравнения		= ВидСравненияКомпоновкиДанных.Равно;
	ЭлементОтбора.ПравоеЗначение	= Истина;
	
	ЭлементОтбора = ЭлементОформления.Отбор.Элементы.Добавить(Тип("ЭлементОтбораКомпоновкиДанных"));
	ЭлементОтбора.Использование		= Истина;
	ЭлементОтбора.ЛевоеЗначение		= Новый ПолеКомпоновкиДанных("ЭлектронныеПодписи.КомуВыданСертификат");
	ЭлементОтбора.ВидСравнения		= ВидСравненияКомпоновкиДанных.НеЗаполнено;
	
	ЭлементОформления.Оформление.УстановитьЗначениеПараметра("Текст", Новый ПолеКомпоновкиДанных("ЭлектронныеПодписи.ФизическоеЛицо"));
	
	ОформляемоеПоле = ЭлементОформления.Поля.Элементы.Добавить();
	ОформляемоеПоле.Поле = Новый ПолеКомпоновкиДанных("ЭлектронныеПодписиСотрудниковКомуВыданСертификат");
	ОформляемоеПоле.Использование = Истина;
	
КонецПроцедуры

&НаКлиенте
Процедура ОтправитьПечатныеФормыПоПочте()
	ОписаниеОповещения = Новый ОписаниеОповещения("ОтправитьПечатныеФормыПоПочтеНастройкаУчетнойЗаписиПредложена", ЭтотОбъект);
	Если ОбщегоНазначенияКлиент.ПодсистемаСуществует("СтандартныеПодсистемы.РаботаСПочтовымиСообщениями") Тогда
		МодульРаботаСПочтовымиСообщениямиКлиент = ОбщегоНазначенияКлиент.ОбщийМодуль("РаботаСПочтовымиСообщениямиКлиент");
		МодульРаботаСПочтовымиСообщениямиКлиент.ПроверитьНаличиеУчетнойЗаписиДляОтправкиПочты(ОписаниеОповещения);
	КонецЕсли;
КонецПроцедуры

&НаКлиенте
Процедура ОтправитьПечатныеФормыПоПочтеНастройкаУчетнойЗаписиПредложена(УчетнаяЗаписьНастроена, ДополнительныеПараметры) Экспорт
	
	Если УчетнаяЗаписьНастроена <> Истина Тогда
		Возврат;
	КонецЕсли;
	
	СписокВложений = Новый Массив;
	
	ОписанияФайлов = КадровыйЭДОВызовСервера.ФайлыПечатныхФормДляСохраненияНаДиск(
		ОбщегоНазначенияКлиентСервер.ЗначениеВМассиве(Объект.ЭлектронныйДокумент));
	
	Для Каждого ОписанияФайла Из ОписанияФайлов Цикл
		ОписаниеФайла = Новый Структура;
		ОписаниеФайла.Вставить("Представление", ОписанияФайла.Имя);
		ОписаниеФайла.Вставить("АдресВоВременномХранилище", ОписанияФайла.Хранение);
		СписокВложений.Добавить(ОписаниеФайла);
	КонецЦикла;
	
	ПараметрыОтправки = Новый Структура;
	ПараметрыОтправки.Вставить("Получатель");
	ПараметрыОтправки.Вставить("Тема", Строка(Объект.ЭлектронныйДокумент));
	ПараметрыОтправки.Вставить("Текст", ПараметрыОтправки.Тема);
	ПараметрыОтправки.Вставить("Вложения", СписокВложений);
	ПараметрыОтправки.Вставить("УдалятьФайлыПослеОтправки", Истина);
	
	МодульРаботаСПочтовымиСообщениямиКлиент = ОбщегоНазначенияКлиент.ОбщийМодуль("РаботаСПочтовымиСообщениямиКлиент");
	МодульРаботаСПочтовымиСообщениямиКлиент.СоздатьНовоеПисьмо(ПараметрыОтправки);
	
КонецПроцедуры

&НаСервере
Функция АдресСпискаПодобранных()
	
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("ФизическиеЛица",
		Объект.ВнешниеПодписанты.Выгрузить().ВыгрузитьКолонку("ФизическоеЛицо"));
	
	Запрос.Текст =
		"ВЫБРАТЬ
		|	Сотрудники.Ссылка КАК Ссылка
		|ИЗ
		|	Справочник.Сотрудники КАК Сотрудники
		|ГДЕ
		|	Сотрудники.ФизическоеЛицо В(&ФизическиеЛица)";
	
	УстановитьПривилегированныйРежим(Истина);
	ВыбранныеСотрудники = Запрос.Выполнить().Выгрузить().ВыгрузитьКолонку("Ссылка");
	УстановитьПривилегированныйРежим(Ложь);
	
	Возврат ПоместитьВоВременноеХранилище(ВыбранныеСотрудники, УникальныйИдентификатор);
	
КонецФункции

&НаСервере
Процедура ОбработатьВыборСотрудников(ВыбранныеСотрудники)
	
	ОбновитьПредставление = Ложь;
	ОбновитьПорядокПодписей = Ложь;
	Для Каждого Сотрудник Из ВыбранныеСотрудники Цикл
		
		ФизическоеЛицо = КадровыйУчетПовтИсп.ФизическоеЛицоСотрудника(Сотрудник);
		СтруктураПоиска = Новый Структура("ФизическоеЛицо", ФизическоеЛицо);
		Если Объект.ВнешниеПодписанты.НайтиСтроки(СтруктураПоиска).Количество() = 0 Тогда
			ОбновитьПредставление = Истина;
			НовыйПодписант = Объект.ВнешниеПодписанты.Добавить();
			НовыйПодписант.ФизическоеЛицо = ФизическоеЛицо;
			Если ДобавитьПодпись(ФизическоеЛицо) Тогда
				ОбновитьПорядокПодписей = Истина;
			КонецЕсли;
		КонецЕсли;
		
	КонецЦикла;
	
	Если ОбновитьПорядокПодписей Тогда
		ОбновитьПорядокПодписей();
	КонецЕсли;
	
	Если ОбновитьПредставление Тогда
		Модифицированность = Истина;
	КонецЕсли;
	
КонецПроцедуры

&НаКлиентеНаСервереБезКонтекста
Функция ДанныеФайлаЗаполнены(УправляемаяФорма)
	Возврат ЗначениеЗаполнено(УправляемаяФорма.Объект.ЭлектронныйДокумент)
		Или (УправляемаяФорма.ДанныеЭлектронногоДокумента <> Неопределено
			И ЗначениеЗаполнено(УправляемаяФорма.ДанныеЭлектронногоДокумента.СсылкаНаДвоичныеДанные))
КонецФункции

// Работа с подписями

&НаСервере
Функция ЗаполнитьКоллекцииПодписей()

	ПодписиСервиса = Новый Массив;
	ПодписиИБ = Новый Массив;
	
	Для каждого СтрокаПодписи Из ЭлектронныеПодписи Цикл
		Если ЗначениеЗаполнено(СтрокаПодписи.ДатаПодписи) Тогда
			Если ЗначениеЗаполнено(СтрокаПодписи.АдресПодписи) Тогда
				Если КабинетСотрудника.ЭтоПодписанСервиса(СтрокаПодписи.Комментарий) Тогда
					ПодписиСервиса.Добавить(СтрокаПодписи.ПолучитьИдентификатор());
				Иначе
					ПодписиИБ.Добавить(СтрокаПодписи.ПолучитьИдентификатор());
				КонецЕсли;
			Иначе
				СтрокаПодписи.Статус = НСтр("ru = 'Требуется собственноручная подпись';
											|en = 'Sign manually'");
			КонецЕсли;
		КонецЕсли;
	КонецЦикла;
	
	КоллекцияПодписей = Новый Структура();
	КоллекцияПодписей.Вставить("ПодписиСервиса", ПодписиСервиса);
	КоллекцияПодписей.Вставить("ПодписиИБ", ПодписиИБ);
	
	Возврат КоллекцияПодписей;

КонецФункции

// Управление отображением элементов формы

&НаКлиентеНаСервереБезКонтекста
Процедура УстановитьОтображениеЭлементовФормы(УправляемаяФорма, ИспользоватьЭлектронныеПодписи)
	
	Объект = УправляемаяФорма.Объект;
	Элементы = УправляемаяФорма.Элементы;
	
	Если Объект.КатегорияДокумента = ПредопределенноеЗначение("Перечисление.КатегорииДокументовКадровогоЭДО.РасчетныйЛисток") Тогда
		
		ОбщегоНазначенияКлиентСервер.УстановитьСвойствоЭлементаФормы(
			Элементы,
			"ФизическоеЛицо",
			"Заголовок",
			НСтр("ru = 'Ознакомить';
				|en = 'Inform'"));
			
	КонецЕсли;
	
	УстановитьПодсказкуСотруднику(УправляемаяФорма);
	
	ОбщегоНазначенияКлиентСервер.УстановитьСвойствоЭлементаФормы(
		Элементы,
		"ФормаПередатьВ1СКабинетСотрудника",
		"Видимость",
		Объект.Внешний);
	
	ОбщегоНазначенияКлиентСервер.УстановитьСвойствоЭлементаФормы(
		Элементы,
		"ФормаПередатьВ1СКабинетСотрудника",
		"Доступность",
		ДанныеФайлаЗаполнены(УправляемаяФорма)
			Или ТабличныйДокументЗадан(УправляемаяФорма));
	
	// Ознакомляемые печатных форм
	ОбщегоНазначенияКлиентСервер.УстановитьСвойствоЭлементаФормы(
		Элементы,
		"СотрудникПодписаниеГруппа",
		"Видимость",
		ЗначениеЗаполнено(УправляемаяФорма.ФизическоеЛицо)
			И Не Объект.НаСписокСотрудников 
			И Не Объект.Внешний);
	
	ОбщегоНазначенияКлиентСервер.УстановитьСвойствоЭлементаФормы(
		Элементы,
		"ЭлектронныеПодписиСотрудниковГруппа",
		"Видимость",
		Не ЗначениеЗаполнено(УправляемаяФорма.ФизическоеЛицо)
			Или Объект.НаСписокСотрудников
			Или Объект.Внешний);
	
	ОбщегоНазначенияКлиентСервер.УстановитьСвойствоЭлементаФормы(
		Элементы,
		"ВариантПодписанияСпискаГруппа",
		"Видимость",
		(Не ЗначениеЗаполнено(УправляемаяФорма.ФизическоеЛицо)
			Или Объект.НаСписокСотрудников)
			И Не Объект.Внешний);
	
	
	// Ознакомляемые внешних документов
	ОбщегоНазначенияКлиентСервер.УстановитьСвойствоЭлементаФормы(
		Элементы,
		"ОзнакомляемыеВнешнегоДокументаГруппа",
		"Видимость",
		Объект.Внешний);
	
	УстановитьОтображениеЭлементовПоОрганизации(УправляемаяФорма);
	УстановитьОтображениеОзнакомляемых(УправляемаяФорма);
	УстановитьОтображениеЭлектронногоДокумента(УправляемаяФорма);
	
	// Основание
	ОбщегоНазначенияКлиентСервер.УстановитьСвойствоЭлементаФормы(
		Элементы,
		"ОснованиеДокумента",
		"Видимость",
		ЗначениеЗаполнено(Объект.Ссылка)
			И Объект.Ссылка <> Объект.ОснованиеДокумента);
	
	ОбщегоНазначенияКлиентСервер.УстановитьСвойствоЭлементаФормы(
		Элементы,
		"ИмяФайлаСРасширением",
		"Видимость",
		ЗначениеЗаполнено(УправляемаяФорма.ИмяФайлаСРасширением)
			Или ЗначениеЗаполнено(Объект.ЭлектронныйДокумент)
			Или УправляемаяФорма.ЕстьПодписиДокумента);
	
	ОбщегоНазначенияКлиентСервер.УстановитьСвойствоЭлементаФормы(
		Элементы,
		"ФормаОтправить",
		"Видимость",
		ЗначениеЗаполнено(Объект.ЭлектронныйДокумент)
			И КадровыйЭДОКлиентСервер.ЭтоРасширениеPDFДокумента(УправляемаяФорма.Расширение));
	
	ОбщегоНазначенияКлиентСервер.УстановитьСвойствоЭлементаФормы(
		Элементы,
		"ЭлектронныеПодписи",
		"Доступность",
		ЗначениеЗаполнено(Объект.ЭлектронныйДокумент));
	
	ОбщегоНазначенияКлиентСервер.УстановитьСвойствоЭлементаФормы(
		Элементы,
		"ТребуетсяПодписьОрганизации",
		"Видимость",
		ИспользоватьЭлектронныеПодписи);
	
	ОбщегоНазначенияКлиентСервер.УстановитьСвойствоЭлементаФормы(
		Элементы,
		"ФормаЗадания",
		"Видимость",
		УправляемаяФорма.ДоступноПравоУправлятьЗаданиями
			И ЗначениеЗаполнено(Объект.Ссылка));
	
	ОбщегоНазначенияКлиентСервер.УстановитьСвойствоЭлементаФормы(
		Элементы,
		"ИмяФайлаСРасширением",
		"ГиперСсылка",
		Объект.Ссылка.Пустая());
	
	ОбщегоНазначенияКлиентСервер.УстановитьСвойствоЭлементаФормы(
		Элементы,
		"ДокументКЭДОИнформацияГруппа",
		"Видимость",
		Объект.Внешний И Не Объект.ПроизвольнаяТаблица);
	
	ОбщегоНазначенияКлиентСервер.УстановитьСвойствоЭлементаФормы(
		Элементы,
		"ДокументКЭДОИнформацияГруппа",
		"Доступность",
		ДанныеФайлаЗаполнены(УправляемаяФорма));
	
	ОбщегоНазначенияКлиентСервер.УстановитьСвойствоЭлементаФормы(
		Элементы,
		"ПредупреждениеДекорация",
		"Видимость",
		КадровыйЭДОКлиентСервер.ЭтоРасширениеPDFДокумента(УправляемаяФорма.Расширение));
	
	ОбщегоНазначенияКлиентСервер.УстановитьСвойствоЭлементаФормы(
		Элементы,
		"ОшибкаДекорация",
		"Видимость",
		Не КадровыйЭДОКлиентСервер.ЭтоРасширениеPDFДокумента(УправляемаяФорма.Расширение));
	
	ОбщегоНазначенияКлиентСервер.УстановитьСвойствоЭлементаФормы(
		Элементы,
		"ФорматДокументаСоответствуетТребованиям",
		"Видимость",
		КадровыйЭДОКлиентСервер.ЭтоРасширениеPDFДокумента(УправляемаяФорма.Расширение));
		
		
	ОбщегоНазначенияКлиентСервер.УстановитьСвойствоЭлементаФормы(
		Элементы,
		"ОткрытьРедакторТабличногоДокумента",
		"Видимость",
		(Объект.ПроизвольнаяТаблица
			Или Объект.Ссылка.Пустая() И Не ДанныеФайлаЗаполнены(УправляемаяФорма))
			И Не УправляемаяФорма.ЕстьПодписиДокумента);
	
	ОбщегоНазначенияКлиентСервер.УстановитьСвойствоЭлементаФормы(
		Элементы,
		"НаименованиеДокумента",
		"Видимость",
		Объект.ПроизвольнаяТаблица
			И Не УправляемаяФорма.ЕстьПодписиДокумента);
	
	ОбщегоНазначенияКлиентСервер.УстановитьСвойствоЭлементаФормы(
		Элементы,
		"ИмяФайлаСРасширением",
		"Видимость",
		Не Объект.ПроизвольнаяТаблица
			Или Объект.Ссылка.Пустая() И ДанныеФайлаЗаполнены(УправляемаяФорма)
			Или УправляемаяФорма.ЕстьПодписиДокумента);
	
	ЗаголовокОткрытьРедакторТабличногоДокумента = НСтр("ru = 'Подготовить электронный документ в редакторе';
														|en = 'Prepare an electronic document in the editor'");
	Если УправляемаяФорма.ТолькоПросмотр Тогда
		ЗаголовокОткрытьРедакторТабличногоДокумента = НСтр("ru = 'Открыть';
															|en = 'Open'");
	ИначеЕсли Объект.ПроизвольнаяТаблица Тогда
		ЗаголовокОткрытьРедакторТабличногоДокумента = НСтр("ru = 'Изменить';
															|en = 'Change'");
	КонецЕсли;
	ОбщегоНазначенияКлиентСервер.УстановитьСвойствоЭлементаФормы(
		УправляемаяФорма.Элементы,
		"ОткрытьРедакторТабличногоДокумента",
		"Заголовок",
		ЗаголовокОткрытьРедакторТабличногоДокумента);
	
	ОбщегоНазначенияКлиентСервер.УстановитьСвойствоЭлементаФормы(
		УправляемаяФорма.Элементы,
		"ФормаРазблокироватьДокумент",
		"Видимость",
		Объект.ПроизвольнаяТаблица
			И УправляемаяФорма.ЕстьПодписиДокумента);
	
КонецПроцедуры

&НаКлиентеНаСервереБезКонтекста
Процедура УстановитьОтображениеОзнакомляемых(УправляемаяФорма)
	
	ОбщегоНазначенияКлиентСервер.УстановитьСвойствоЭлементаФормы(
		УправляемаяФорма.Элементы,
		"ОзнакомляемоеФизическоеЛицо",
		"Доступность",
		УправляемаяФорма.ВыборОзнакомляемых = 0);
	
	ОбщегоНазначенияКлиентСервер.УстановитьСвойствоЭлементаФормы(
		УправляемаяФорма.Элементы,
		"ВыбратьСотрудников",
		"Доступность",
		УправляемаяФорма.ВыборОзнакомляемых = 1);
	
КонецПроцедуры

&НаКлиентеНаСервереБезКонтекста
Процедура УстановитьОтображениеЭлектронногоДокумента(УправляемаяФорма)
	
	ТекстПодсказки = "";
	Если СтрНайти(КадровыйЭДОКлиентСервер.РасширенияФайловЭлектронныхДокументов(), "." + НРег(УправляемаяФорма.Расширение)) = 0 Тогда
		ТекстПодсказки = НСтр("ru = 'Просмотр документа может быть недоступен на устройствах сотрудников. Рекомендуем
			|- либо конвертировать документ в pdf-формат, который может быть просмотрен почти на любом устройстве
			|- либо отсканировать документ';
			|en = 'Document view might be unavailable on employee devices. Do one of the following:
			|- convert the document to PDF format that is available almost on every device
			|- scan the document'");
	КонецЕсли;
	
	ЗарплатаКадрыКлиентСервер.УстановитьРасширеннуюПодсказкуЭлементуФормы(
		УправляемаяФорма,
		"ИмяФайлаСРасширением",
		ТекстПодсказки);
	
	ДоступностьЭлементов =
		УправляемаяФорма.ДанныеЭлектронногоДокумента <> Неопределено
			И УправляемаяФорма.ДанныеЭлектронногоДокумента.СсылкаНаДвоичныеДанные <> Неопределено
		Или ТабличныйДокументЗадан(УправляемаяФорма);
	
	ОбщегоНазначенияКлиентСервер.УстановитьСвойствоЭлементаФормы(
		УправляемаяФорма.Элементы,
		"ФормаОтправить",
		"Доступность",
		ДоступностьЭлементов);
	
	ОбщегоНазначенияКлиентСервер.УстановитьСвойствоЭлементаФормы(
		УправляемаяФорма.Элементы,
		"ЭлектронныеПодписиГруппа",
		"Доступность",
		ДоступностьЭлементов);
	
КонецПроцедуры

&НаКлиентеНаСервереБезКонтекста
Процедура УстановитьПодсказкуСотруднику(УправляемаяФорма)
	
	ПодсказкаСотрудника = "";
	Если ЗначениеЗаполнено(УправляемаяФорма.ФизическоеЛицо) Тогда
		
		ПодписиСотрудника = УправляемаяФорма.ЭлектронныеПодписи.НайтиСтроки(
			Новый Структура("ФизическоеЛицо,ПодписьСотрудника", УправляемаяФорма.ФизическоеЛицо, Истина));
		
		Если ПодписиСотрудника.Количество() > 0 Тогда
			
			Для Каждого ПодписьСотрудника Из ПодписиСотрудника Цикл
				
				Если ЗначениеЗаполнено(ПодписьСотрудника.ДатаПодписи) Тогда
					
					Если ПодписьСотрудника.РезультатСогласования = ПредопределенноеЗначение("Перечисление.РезультатыСогласованияБЗК.Согласовано") Тогда
						РезультатСогласования = НСтр("ru = 'Подписан';
													|en = 'Signed'")
					Иначе
						РезультатСогласования = Строка(ПодписьСотрудника.РезультатСогласования);
					КонецЕсли;
					ПодсказкаСотрудника = СтрШаблон(
						"%1: %2",
						РезультатСогласования,
						Формат(ПодписьСотрудника.ДатаПодписи, "ДЛФ=DT"));
					Если ЗначениеЗаполнено(ПодписьСотрудника.Статус) Тогда
						
						ЧастиИнформацииОПроверке = Новый Массив;
						ЧастиИнформацииОПроверке.Добавить(ПодписьСотрудника.Статус);
						
						Если ЗначениеЗаполнено(ПодписьСотрудника.ОписаниеОшибки) Тогда
							ЧастиИнформацииОПроверке.Добавить(ПодписьСотрудника.ОписаниеОшибки);
						КонецЕсли;
						
						Если ЗначениеЗаполнено(ПодписьСотрудника.ДатаПроверкиПодписи) Тогда
							ЧастиИнформацииОПроверке.Добавить(Формат(ПодписьСотрудника.ДатаПроверкиПодписи, "ДЛФ=DT"));
						КонецЕсли;
						
						ПодсказкаСотрудника = СтрШаблон(
							"%1 (%2)",
							ПодсказкаСотрудника,
							СтрСоединить(ЧастиИнформацииОПроверке, ", "));
					КонецЕсли;
					
					Прервать;
				КонецЕсли;
			КонецЦикла;
		КонецЕсли;
	КонецЕсли;
	
	ЗарплатаКадрыКлиентСервер.УстановитьРасширеннуюПодсказкуЭлементуФормы(
		УправляемаяФорма, "ФизическоеЛицо", ПодсказкаСотрудника);
	ЗарплатаКадрыКлиентСервер.УстановитьРасширеннуюПодсказкуЭлементуФормы(
		УправляемаяФорма, "ОзнакомляемоеФизическоеЛицо", ПодсказкаСотрудника);
	
КонецПроцедуры

&НаКлиентеНаСервереБезКонтекста
Процедура УстановитьОтображениеЭлементовПоОрганизации(УправляемаяФорма)
	
	ОбщегоНазначенияКлиентСервер.УстановитьСвойствоЭлементаФормы(
		УправляемаяФорма.Элементы,
		"ОзнакомляемыеВнешнегоДокументаГруппа",
		"Доступность",
		ЗначениеЗаполнено(УправляемаяФорма.Объект.Организация));
	
	ОбщегоНазначенияКлиентСервер.УстановитьСвойствоЭлементаФормы(
		УправляемаяФорма.Элементы,
		"ФайлТабличныйДокументГруппа",
		"Доступность",
		ЗначениеЗаполнено(УправляемаяФорма.Объект.Организация));
	
КонецПроцедуры

&НаСервере
Процедура ОзнакомляемоеФизическоеЛицоПриИзмененииНаСервере()
	
	Если ЗначениеЗаполнено(ФизическоеЛицо) Тогда
		
		ПрежнееФизическоеЛицо = Неопределено;
		Если Объект.ВнешниеПодписанты.Количество() = 0 Тогда
			СтрокаПодписанта = Объект.ВнешниеПодписанты.Добавить();
		Иначе
			СтрокаПодписанта = Объект.ВнешниеПодписанты[0];
			ПрежнееФизическоеЛицо = СтрокаПодписанта.ФизическоеЛицо;
		КонецЕсли;
		
		СтрокаПодписанта.ФизическоеЛицо = ФизическоеЛицо;
		
		Если ЗначениеЗаполнено(ПрежнееФизическоеЛицо) Тогда
			УдалитьПодпись(ПрежнееФизическоеЛицо);
		КонецЕсли;
		
		Если ДобавитьПодпись(ФизическоеЛицо) Тогда
			ОбновитьПорядокПодписей();
		КонецЕсли;
		
	Иначе
		Если Объект.ВнешниеПодписанты.Количество() > 0 Тогда
			УдалитьПодпись(Объект.ВнешниеПодписанты[0].ФизическоеЛицо);
			Объект.ВнешниеПодписанты.Удалить(0);
		КонецЕсли;
	КонецЕсли;
	
	Модифицированность = Истина;
	
КонецПроцедуры

&НаСервере
Функция ДобавитьПодпись(ФизическоеЛицо)
	
	Добавлена = Ложь;
	СтрокиПодписи = ЭлектронныеПодписи.НайтиСтроки(Новый Структура("ФизическоеЛицо", ФизическоеЛицо));
	Если СтрокиПодписи.Количество() = 0 Тогда
		СтрокаПодписи = ЭлектронныеПодписи.Добавить();
		СтрокаПодписи.ФизическоеЛицо = ФизическоеЛицо;
		СтрокаПодписи.ПодписьСотрудника = Истина;
		Добавлена = Истина;
	КонецЕсли;
	
	Возврат Добавлена;
	
КонецФункции

&НаСервере
Процедура УдалитьПодпись(ФизическоеЛицо)
	
	Если ЗначениеЗаполнено(ФизическоеЛицо) Тогда
		СтрокиПодписи = ЭлектронныеПодписи.НайтиСтроки(
			Новый Структура("ФизическоеЛицо", ФизическоеЛицо));
		
		Если СтрокиПодписи.Количество() > 0 Тогда
			Если Не ЗначениеЗаполнено(СтрокиПодписи[0].ДатаПодписи) Тогда
				ЭлектронныеПодписи.Удалить(СтрокиПодписи[0]);
			Иначе
				СтрокиПодписи[0].ПодписьСотрудника = Ложь;
			КонецЕсли;
		КонецЕсли;
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Процедура ОбновитьПорядокПодписей()
	
	ЭлектронныеПодписи.Сортировать("ФизическоеЛицо");
	
КонецПроцедуры

&НаСервере
Процедура ВыборОдногоОзнакомляемогоПриИзмененииНаСервере()
	
	Если ВыборОзнакомляемых = 0 Тогда
		Если Объект.ВнешниеПодписанты.Количество() > 0 Тогда
			
			ОставляемоеФизическоеЛицо = Неопределено;
			Если Элементы.ЭлектронныеПодписиСотрудников.ТекущаяСтрока <> Неопределено Тогда
				ТекущиеДанные = ЭлектронныеПодписи.НайтиПоИдентификатору(
					Элементы.ЭлектронныеПодписиСотрудников.ТекущаяСтрока);
				ОставляемоеФизическоеЛицо = ТекущиеДанные.ФизическоеЛицо;
			КонецЕсли;
			
			Если ОставляемоеФизическоеЛицо = Неопределено Тогда
				ОставляемоеФизическоеЛицо = Объект.ВнешниеПодписанты[0].ФизическоеЛицо
			КонецЕсли;
			
			УдаляемыеСтроки = Новый Массив;
			Для Каждого СтрокаОзнакомляемого Из Объект.ВнешниеПодписанты Цикл
				Если СтрокаОзнакомляемого.ФизическоеЛицо <> ОставляемоеФизическоеЛицо Тогда
					УдаляемыеСтроки.Добавить(СтрокаОзнакомляемого);
					УдалитьПодпись(СтрокаОзнакомляемого.ФизическоеЛицо);
				Иначе
					ФизическоеЛицо = ОставляемоеФизическоеЛицо
				КонецЕсли;
			КонецЦикла;
			
			Для Каждого СтрокаОзнакомляемого Из УдаляемыеСтроки Цикл
				Объект.ВнешниеПодписанты.Удалить(СтрокаОзнакомляемого);
			КонецЦикла;
		КонецЕсли;
	КонецЕсли;
	УстановитьОтображениеОзнакомляемых(ЭтотОбъект);
	
КонецПроцедуры

&НаСервере
Процедура ПеревестиВРежимПросмотраОсновныхДанных()
	
	ОбщегоНазначенияКлиентСервер.УстановитьСвойствоЭлементаФормы(
		Элементы,
		"Основное",
		"ТолькоПросмотр",
		Истина);
	
	ОбщегоНазначенияКлиентСервер.УстановитьСвойствоЭлементаФормы(
		Элементы,
		"ОсновныеДанныеГруппа",
		"ТолькоПросмотр",
		Не Объект.Внешний);
	
КонецПроцедуры

&НаСервере
Процедура ОбновитьЗначениеТребуетсяПодписьОрганизации()
	
	Если ЭлектроннаяПодпись.ИспользоватьЭлектронныеПодписи() Тогда
		Если Объект.Внешний Тогда
			// Проверка наличия подписи орагнизации
			ТребуетсяПодписьОрганизации = ЭлектронныеПодписи.Выгрузить(
				Новый Структура("ПодписьСотрудника", Ложь)).Количество() = 0;
			Если ТребуетсяПодписьОрганизации Тогда
				// Проверка существования запланированного подписания
				НаправленияНаПодпись =
					РегистрыСведений.ЗапланированныеДействияСФайламиДокументовКЭДО.НаправленияНаПодпись(
						Объект.ЭлектронныйДокумент);
				Если Не ЗначениеЗаполнено(НаправленияНаПодпись) Тогда
					ТребуетсяПодписьОрганизации = Истина;
				КонецЕсли;
			КонецЕсли;
		КонецЕсли;
	Иначе
		ТребуетсяПодписьОрганизации = Ложь;
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Процедура ОбновитьКомментарии()
	
	УстановитьПривилегированныйРежим(Истина);
	Комментарии = РегистрыСведений.КомментарииФайловДокументовКЭДО.КомментарииФайла(Объект.ЭлектронныйДокумент);
	УстановитьПривилегированныйРежим(Ложь);
	
	Пока Элементы.КомментарииГруппа.ПодчиненныеЭлементы.Количество() > 0 Цикл
		Элементы.Удалить(Элементы.КомментарииГруппа.ПодчиненныеЭлементы[0]);
	КонецЦикла;
	
	НомерКомментария = 0;
	Ознакомиться = Ложь;
	Для Каждого КомментарийДокумента Из Комментарии Цикл
		Декорация = Элементы.Добавить("КомментарийДокумента" + НомерКомментария, Тип("ДекорацияФормы"), Элементы.КомментарииГруппа);
		Декорация.Вид = ВидДекорацииФормы.Надпись;
		Декорация.АвтоМаксимальнаяШирина = Ложь;
		Декорация.Заголовок = Новый ФорматированнаяСтрока(
			Новый ФорматированнаяСтрока(
				СтрШаблон("%1 (%2)", КомментарийДокумента.Исполнитель, Формат(КомментарийДокумента.ДатаКомментария, "ДЛФ=DT")),
				Новый Шрифт(Декорация.Шрифт, , , Истина)),
			Символы.ПС,
			КомментарийДокумента.Комментарий);
		Если КомментарийДокумента.Ознакомиться Тогда
			Ознакомиться = Истина;
		КонецЕсли;
		НомерКомментария = НомерКомментария + 1;
	КонецЦикла;
	Если Ознакомиться Тогда
		Декорация = Элементы.Добавить("КомментарийДокументаОзнакомиться", Тип("ДекорацияФормы"), Элементы.КомментарииГруппа);
		Декорация.Вид = ВидДекорацииФормы.Надпись;
		Декорация.Заголовок = Новый ФорматированнаяСтрока(НСтр("ru = 'Ознакомлено';
																|en = 'I have read and understood'"), , , , Декорация.Имя);
		Декорация.УстановитьДействие("ОбработкаНавигационнойСсылки", "Подключаемый_ОбработкаНавигационнойСсылки");
	КонецЕсли;
	
	ОбщегоНазначенияКлиентСервер.УстановитьСвойствоЭлементаФормы(
		Элементы,
		"КомментарииОтветственныхЛицГруппа",
		"Видимость",
		ЗначениеЗаполнено(Комментарии));
	
КонецПроцедуры

// КадровыйЭДО

&НаКлиентеНаСервереБезКонтекста
Процедура ОбновитьПодключаемыеКоманды(УправляемаяФорма)
	КадровыйЭДОКлиентСервер.ОбновитьКоманды(УправляемаяФорма, УправляемаяФорма.Объект, Истина);
КонецПроцедуры

// Конец КадровыйЭДО

&НаСервере
Процедура УстановитьОтображениеПодсказкиКодаДокумента()
	
	КодДокументаКадровогоМероприятия = Объект.КодДокументаКадровогоМероприятия;
	ОбщегоНазначенияКлиентСервер.УстановитьСвойствоЭлементаФормы(
		Элементы,
		"КодДокументаКадровогоМероприятия",
		"Подсказка",
		КадровыйЭДОПовтИсп.СвойстваКодаКадровогоДокумента(
			КодДокументаКадровогоМероприятия).НаименованиеПолное);
	
КонецПроцедуры

&НаКлиентеНаСервереБезКонтекста
Функция ТабличныйДокументЗадан(УправляемаяФорма)
	Возврат УправляемаяФорма.Документ.ВысотаТаблицы > 0;
КонецФункции

&НаСервере
Процедура РазблокироватьДокументНаСервере()
	
	УстановитьПривилегированныйРежим(Истина);
	
	НачатьТранзакцию();
	Попытка
		
		Блокировка = Новый БлокировкаДанных;
		ЭлементБлокировки = Блокировка.Добавить(Метаданные.Справочники.ДокументКадровогоЭДОПрисоединенныеФайлы.ПолноеИмя());
		ЭлементБлокировки.УстановитьЗначение("Ссылка", Объект.ЭлектронныйДокумент);
		Блокировка.Заблокировать();
		
		НаборЗаписей = РегистрыСведений.ЭлектронныеПодписи.СоздатьНаборЗаписей();
		НаборЗаписей.Отбор.ПодписанныйОбъект.Установить(Объект.ЭлектронныйДокумент);
		НаборЗаписей.Записать();
		
		НаборЗаписей = РегистрыСведений.ПодписиДокументовКЭДО.СоздатьНаборЗаписей();
		НаборЗаписей.Отбор.Объект.Установить(Объект.Ссылка);
		НаборЗаписей.Записать();
		
		ФайлОбъект = Объект.ЭлектронныйДокумент.ПолучитьОбъект();
		ФайлОбъект.ПодписанЭП = Ложь;
		ФайлОбъект.Записать();
		
		ЗафиксироватьТранзакцию();
		
	Исключение
		ОтменитьТранзакцию();
		Ошибка = ИнформацияОбОшибке();
		ОбщегоНазначения.СообщитьПользователю(
			НСтр("ru = 'Не удалось разблокировать документ: ';
				|en = 'Cannot unlock the document:'") + КраткоеПредставлениеОшибки(Ошибка));
	КонецПопытки;
	
	КадровыйЭДОВызовСервера.ДокументГотовДляАрхивирования(Объект.Ссылка);
	
	УстановитьПривилегированныйРежим(Ложь);
	
	ПрочитатьЭлектронныеПодписи();
	УстановитьОтображениеЭлементовФормы(ЭтотОбъект, ЭлектроннаяПодпись.ИспользоватьЭлектронныеПодписи());
	
КонецПроцедуры

#КонецОбласти