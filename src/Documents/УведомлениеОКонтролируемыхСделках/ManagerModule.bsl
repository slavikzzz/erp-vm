#Если Сервер Или ТолстыйКлиентОбычноеПриложение Или ВнешнееСоединение Тогда

#Область ПрограммныйИнтерфейс

// Определяет список команд создания на основании.
//
// Параметры:
//  КомандыСозданияНаОсновании - см. СозданиеНаОснованииПереопределяемый.ПередДобавлениемКомандСозданияНаОсновании.КомандыСозданияНаОсновании
//  Параметры - см. СозданиеНаОснованииПереопределяемый.ПередДобавлениемКомандСозданияНаОсновании.Параметры
//
Процедура ДобавитьКомандыСозданияНаОсновании(КомандыСозданияНаОсновании, Параметры) Экспорт
	
КонецПроцедуры

// Определяет список команд отчетов.
//
// Параметры:
//   КомандыОтчетов - См. ВариантыОтчетовПереопределяемый.ПередДобавлениемКомандОтчетов.КомандыОтчетов
//   Параметры - См. ВариантыОтчетовПереопределяемый.ПередДобавлениемКомандОтчетов.Параметры
//
Процедура ДобавитьКомандыОтчетов(КомандыОтчетов, Параметры) Экспорт
	
КонецПроцедуры

// Проверяет, есть ли контролируемые сделки созданные по этому уведомлению.
//	Параметры:
//		Уведомление - ДокументСсылка.УведомлениеОКонтролируемыхСделках - ссылка на документ уведомления,
// 			для которого проверяется наличие созданных контролируемых сделок.
//	Возвращаемое значение:
//		Булево - истина, если ранее уже были созданы контролируемые сделки.
//
Функция ДанныеАвтоматическогоЗаполненияПодготовлены(Уведомление) Экспорт
	
	Запрос = Новый Запрос();
	Запрос.Параметры.Вставить("Уведомление", Уведомление);
	Запрос.Текст = 
	"ВЫБРАТЬ РАЗРЕШЕННЫЕ ПЕРВЫЕ 1
	|	КонтролируемыеСделкиОрганизаций.Регистратор
	|ИЗ
	|	РегистрНакопления.КонтролируемыеСделкиОрганизаций КАК КонтролируемыеСделкиОрганизаций
	|ГДЕ
	|	КонтролируемыеСделкиОрганизаций.Регистратор = &Уведомление";
	РезультатЗапроса = Запрос.Выполнить();
	Возврат НЕ РезультатЗапроса.Пустой();
	
КонецФункции

// Проверяет, есть ли контролируемые сделки созданные по этому уведомлению.
// В отличие от "ДанныеАвтоматическогоЗаполненияПодготовлены" проверяются только не помеченные на удаление.
//	Параметры:
//		Уведомление - ДокументСсылка.УведомлениеОКонтролируемыхСделках - ссылка на документ уведомления,
// 			для которого проверяется наличие созданных контролируемых сделок.
//	Возвращаемое значение:
//		Булево - истина, если ранее уже были созданы контролируемые сделки.
//
Функция УведомлениеЗаполнено(Уведомление) Экспорт
	
	Запрос = Новый Запрос();
	Запрос.Параметры.Вставить("Уведомление", Уведомление);
	Запрос.Текст = 
	"ВЫБРАТЬ РАЗРЕШЕННЫЕ ПЕРВЫЕ 1
	|	КонтролируемаяСделка.УведомлениеОКонтролируемойСделке
	|ИЗ
	|	Документ.КонтролируемаяСделка КАК КонтролируемаяСделка
	|ГДЕ
	|	КонтролируемаяСделка.УведомлениеОКонтролируемойСделке = &Уведомление
	|	И НЕ КонтролируемаяСделка.ПометкаУдаления";
	
	РезультатЗапроса = Запрос.Выполнить();
	Возврат НЕ РезультатЗапроса.Пустой();
	
КонецФункции

// На основании данных документов оперативного контура подготавливает таблицу для записи в регистр накопления "КонтролируемыеСделкиОрганизаций".
//	Параметры:
//		Уведомление - ДокументСсылка.УведомлениеОКонтролируемыхСделках - ссылка на документ уведомления,
// 			для которого подготавливаются данные.
//
Процедура ПодготовитьДанныеАвтоматическогоЗаполнения(Уведомление) Экспорт
	
	УстановитьПривилегированныйРежим(Истина);
	
	МенеджерВременныхТаблиц = КонтролируемыеСделки.ПолучитьВременныеТаблицыДляЗаполненияСделок(Уведомление);
	
	ТаблицаСделок = ТаблицаСделок();
	
	ТаблицаСделок.Очистить();
	
	СтруктураПараметров = СтруктураПараметровЗапросаКДокументамИсточникам(Уведомление);
	
	// Документы продажи:
	ДобавитьСделкиРеализацииТоваровУслуг(СтруктураПараметров, МенеджерВременныхТаблиц, ТаблицаСделок);
	ДобавитьСделкиРеализацииУслугПрочихАктивов(СтруктураПараметров, МенеджерВременныхТаблиц, ТаблицаСделок);
	ДобавитьСделкиАктаВыполненныхРабот(СтруктураПараметров, МенеджерВременныхТаблиц, ТаблицаСделок);
	ДобавитьСделкиВозвратаТоваровОтПокупателя(СтруктураПараметров, МенеджерВременныхТаблиц, ТаблицаСделок);
	Если ПолучитьФункциональнуюОпцию("ИспользоватьКорректировкиРеализаций") Тогда
		ДобавитьСделкиКорректировкиРеализации(СтруктураПараметров, МенеджерВременныхТаблиц, ТаблицаСделок);
	КонецЕсли;
	
	// Документы покупки:
	ДобавитьСделкиПриобретенияТоваровУслуг(СтруктураПараметров, МенеджерВременныхТаблиц, ТаблицаСделок);
	ДобавитьСделкиПоступленияУслугПрочихАктивов(СтруктураПараметров, МенеджерВременныхТаблиц, ТаблицаСделок);
	ДобавитьСделкиВозвратаТоваровПоставщику(СтруктураПараметров, МенеджерВременныхТаблиц, ТаблицаСделок);
	Если ПолучитьФункциональнуюОпцию("ИспользоватьКорректировкиПриобретений") Тогда
		ДобавитьСделкиКорректировкиПоступления(СтруктураПараметров, МенеджерВременныхТаблиц, ТаблицаСделок);
	КонецЕсли;
	
	// Комиссия:
	Если ПолучитьФункциональнуюОпцию("ИспользоватьКомиссиюПриЗакупках") Тогда
		ДобавитьСделкиОтчетаКомитентуОПродажах(СтруктураПараметров, МенеджерВременныхТаблиц, ТаблицаСделок);
		ДобавитьСделкиОтчетаКомитентуОСписании(СтруктураПараметров, МенеджерВременныхТаблиц, ТаблицаСделок);
	КонецЕсли;
	Если ПолучитьФункциональнуюОпцию("ИспользоватьОказаниеАгентскихУслугПриЗакупке") Тогда
		ДобавитьСделкиОтчетаКомитентуОЗакупках(СтруктураПараметров, МенеджерВременныхТаблиц, ТаблицаСделок);
	КонецЕсли;
	Если ПолучитьФункциональнуюОпцию("ИспользоватьКомиссиюПриПродажах") Тогда
		ДобавитьСделкиОтчетаКомиссионераОПродажах(СтруктураПараметров, МенеджерВременныхТаблиц, ТаблицаСделок);
		ДобавитьСделкиОтчетаКомиссионераОПродажахЗависимымЛицам(СтруктураПараметров, МенеджерВременныхТаблиц, ТаблицаСделок);
		ДобавитьСделкиОтчетаКомиссионераОСписании(СтруктураПараметров, МенеджерВременныхТаблиц, ТаблицаСделок);
	КонецЕсли;
	
	// Интеркомпани:
	Если ПолучитьФункциональнуюОпцию("ИспользоватьПередачиТоваровМеждуОрганизациями") Тогда
		ДобавитьСделкиПередачиТоваровМеждуОрганизациями_ОрганизацияОтправитель(СтруктураПараметров, МенеджерВременныхТаблиц, ТаблицаСделок);
		ДобавитьСделкиПередачиТоваровМеждуОрганизациями_ОрганизацияПолучатель(СтруктураПараметров, МенеджерВременныхТаблиц, ТаблицаСделок);
		ДобавитьСделкиОтчетПоКомиссииМеждуОрганизациями(СтруктураПараметров, МенеджерВременныхТаблиц, ТаблицаСделок);
		ДобавитьСделкиВозвратаТоваровМеждуОрганизациями(СтруктураПараметров, МенеджерВременныхТаблиц, ТаблицаСделок);
	КонецЕсли;
	
	//++ НЕ УТ

	// Переработчик:
	
	//++ Устарело_Переработка24
	Если ПолучитьФункциональнуюОпцию("ИспользоватьПроизводствоНаСтороне") Тогда
		ДобавитьСделкиОтчетаПереработчика(СтруктураПараметров, МенеджерВременныхТаблиц, ТаблицаСделок);
	КонецЕсли;
	//-- Устарело_Переработка24
	Если ПолучитьФункциональнуюОпцию("ИспользоватьПроизводствоНаСтороне2_5") Тогда
		ДобавитьСделкиОтчетаПереработчика2_5(СтруктураПараметров, МенеджерВременныхТаблиц, ТаблицаСделок);
	КонецЕсли;
	
	//++ НЕ УТКА

	// Давалец:
	//++ Устарело_Переработка24
	Если ПолучитьФункциональнуюОпцию("ИспользоватьПроизводствоИзДавальческогоСырья") Тогда
		ДобавитьСделкиОтчетаДавальцу(СтруктураПараметров, МенеджерВременныхТаблиц, ТаблицаСделок);
	КонецЕсли;
	//-- Устарело_Переработка24
	Если ПолучитьФункциональнуюОпцию("ИспользоватьПроизводствоИзДавальческогоСырья2_5") Тогда
		ДобавитьСделкиОтчетаДавальцу2_5(СтруктураПараметров, МенеджерВременныхТаблиц, ТаблицаСделок);
	КонецЕсли;
	//-- НЕ УТКА
	
	// Лизинг:
	Если ВнеоборотныеАктивы.ИспользуетсяУправлениеВНА() Тогда
		ДобавитьСделкиПоступленияУслугПоАренде(СтруктураПараметров, МенеджерВременныхТаблиц, ТаблицаСделок);
	КонецЕсли;
	//-- НЕ УТ
	
	// Возвратная тара:
	Если ПолучитьФункциональнуюОпцию("ИспользоватьМногооборотнуюТару") Тогда
		ДобавитьСделкиВыкупаВозвратнойТарыКлиентом(СтруктураПараметров, МенеджерВременныхТаблиц, ТаблицаСделок);
		ДобавитьСделкиВыкупаВозвратнойТарыУПоставщика(СтруктураПараметров, МенеджерВременныхТаблиц, ТаблицаСделок);
	КонецЕсли;
	
	// Другое:
	Если ПолучитьФункциональнуюОпцию("ИспользоватьДоговорыКредитовИДепозитов") Тогда
		ДобавитьСделкиНачисленияКредитовИДепозитов(СтруктураПараметров, МенеджерВременныхТаблиц, ТаблицаСделок);
	КонецЕсли;
		
	ТаблицаСделок.Колонки.Добавить("Уведомление", Новый ОписаниеТипов("ДокументСсылка.УведомлениеОКонтролируемыхСделках"));
	ТаблицаСделок.ЗаполнитьЗначения(Уведомление, "Уведомление");
	ТаблицаСделок.ЗаполнитьЗначения(СтруктураПараметров.Организация, "Организация");
	
	// Запишем таблицу сделок в регистр Контролируемые сделки организаций.
	КонтролируемыеСделкиНаборЗаписей = РегистрыНакопления.КонтролируемыеСделкиОрганизаций.СоздатьНаборЗаписей();
	КонтролируемыеСделкиНаборЗаписей.Отбор.Регистратор.Значение = Уведомление;

	КонтролируемыеСделкиНаборЗаписей.Загрузить(ТаблицаСделок);
	
	НачатьТранзакцию();
	Попытка
		КонтролируемыеСделкиНаборЗаписей.Записать();
		ОбъектУведомление = Уведомление.ПолучитьОбъект();
		ОбъектУведомление.ДатаФормированияСпискаСделок = ТекущаяДатаСеанса();
		ОбъектУведомление.Записать();
		ЗафиксироватьТранзакцию();
	Исключение
		ОтменитьТранзакцию();
		ЗаписьВЖурналРегистрации = НСтр("ru = 'Выполнение операции записи уведомления по контролируемым сделкам';
										|en = 'Saving a controlled transaction notification'", ОбщегоНазначения.КодОсновногоЯзыка()); // строка записывается в ИБ
		ЗаписьЖурналаРегистрации(ЗаписьВЖурналРегистрации, УровеньЖурналаРегистрации.Ошибка,,, ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()));
		ВызватьИсключение;
	КонецПопытки;
	
	МенеджерВременныхТаблиц.Закрыть();
	
КонецПроцедуры

// Запускает в фоне процедуру формирования уведомления по контролируемым сделкам.
//
// Параметры:
//  Параметры - Структура - параметры фонового задания:
//  * Уведомление        - ДокументСсылка.УведомлениеОКонтролируемыхСделках - уведомление для заполнения данными.
//  * СообщатьОПрогрессе - Число - наименование ключа варианта отчета.
//  АдресХранилища       - УникальныйИдентификатор, Строка - адрес хранилища результатов фонового задания. В самой процедуре не используется.
//                         Передается для совместимости вывозова функции ДлительныеОперации.ВыполнитьВФоне.
Процедура СформироватьКонтролируемыеСделкиУведомленияВФоне(Параметры, АдресХранилища) Экспорт
	
	СформироватьКонтролируемыеСделки(Параметры.Уведомление, Параметры.СообщатьОПрогрессе);
	
КонецПроцедуры

// На основании ранее подготовленных данных в регистре накопления "КонтролируемыеСделкиОрганизаций"
// создает документы "КонтролируемыеСделки".
//
// Параметры:
//  Уведомление - ДокументСсылка.УведомлениеОКонтролируемыхСделках - ссылка на документ уведомления,
//                для которого создаются данные по контролируемым сделкам.
//
Процедура СформироватьКонтролируемыеСделкиУведомления(Уведомление) Экспорт
	
	СформироватьКонтролируемыеСделки(Уведомление, Ложь);
	
КонецПроцедуры

// На основании служебных данных по контролируемым сделкам, определяет какие сделки относятся в разряд контролируемых и
// какие нет, возвращает эти данные в виде временных таблиц.
//	Параметры:
//		Уведомление - ДокументСсылка.УведомлениеОКонтролируемыхСделках - ссылка на документ уведомления,
// 		для которого подготавливаются врменные таблицы.
//	Возвращаемое значение:
//		МенеджерВременныхТаблиц - содержит в себе следующие таблицы:
//			УчастникиКонтролируемыхСделок - организации или контрагенты, сделки с которыми подлежат контролю;
//			КонтролируемыеСделки - данные из регистра накопления "КонтролируемыеСделкиОрганизаций", со сведениями о признаках по которым каждая конкретная сделка контролиурется;
//			КонтрагентыПоМинимальнойСумме - Сделки с контрагентами, которые контролируются так как сумма оборотов по ним превышает мимнимально контролируемую;
//			КонтрагентыКонтролируемыеПоОбщейСумме - Сделки с невзаимозависимыми контрагентами, которые контролируются так как сумма оборотов по ним превышает общую сумму;
//			КонтрагентыКонтролируемыеПоНДПИ - Сделки с контрагентами, контролируемые по НДПИ;
//			КонтрагентыКонтролируемыеПоСпецРежиму - Сделки с контрагентами, контролируемые по спецрежиму (сделка облагается ЕНВД или сделка с плательщиком ЕСХН);
//			КонтрагентыКонтролируемыеПоПрибыли - Сделки с контрагентами, контролируемые по налогу на прибыль;
//			КонтрагентыКонтролируемыеПоОЭЗ - Сделки с контрагентами, контролируемые в виду того, что контрагент зарегистрирован в особой экономической зоне;
//			КонтрагентыКонтролируемыеПоРегистрацииНеВРФ - Сделки с контрагентами, контролируемые в виду того, что контрагент зарегистрирован в стране с льготным налогообложением
//				или сделка совершается по товарам мировой биржевой торговли.
//
Функция ПолучитьВременныеТаблицыДляЗаполненияУведомления(Уведомление) Экспорт
	
	ПараметрыУведомления = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(Уведомление, "Организация, ОтчетныйГод, ВерсияУведомления");
	
	Запрос = Новый Запрос();
	Запрос.МенеджерВременныхТаблиц = КонтролируемыеСделки.ПолучитьВременныеТаблицыДляЗаполненияСделок(Уведомление);
	Запрос.Параметры.Вставить("Уведомление", Уведомление);
	Запрос.Параметры.Вставить("Организация", ПараметрыУведомления.Организация);
	Запрос.Параметры.Вставить("ОтчетныйГод", ПараметрыУведомления.ОтчетныйГод);
	Запрос.Параметры.Вставить("УчитыватьСпецрежимДляПосредников", 
		ПараметрыУведомления.ОтчетныйГод >= КонтролируемыеСделки.ДатаНачалаУчетаСпецрежимовДляНевзаимозависимыхПосредников());
	Запрос.Параметры.Вставить("УчитыватьЕНВД", ПараметрыУведомления.ОтчетныйГод < КонтролируемыеСделкиКлиентСервер.ДатаОтказаОтЕНВД());
	Запрос.Параметры.Вставить("УчитыватьИнвестиционныйВычет", 
		КонтролируемыеСделки.УчитываютсяСделкиСИнвестиционнымНалоговымВычетом(ПараметрыУведомления.ОтчетныйГод));
	
	ГраницыКонтролируемостиСделок = КонтролируемыеСделки.ГраницыКонтролируемостиСделок(ПараметрыУведомления.ОтчетныйГод, ПараметрыУведомления.ВерсияУведомления);
	ДобавитьВПараметрыЗапроса(Запрос, ГраницыКонтролируемостиСделок);
	
	ГраницыДляКонтроля = КонтролируемыеСделки.ГраницыДляКонтроля(ПараметрыУведомления.ВерсияУведомления);
	ДобавитьВПараметрыЗапроса(Запрос, ГраницыДляКонтроля);
	
	Запрос.Текст = 
	"ВЫБРАТЬ РАЗЛИЧНЫЕ РАЗРЕШЕННЫЕ
	|	КонтролируемыеКонтрагенты.Контрагент КАК Контрагент,
	|	КонтролируемыеКонтрагенты.ГоловнойКонтрагент КАК ГоловнойКонтрагент,
	|	Контрагенты.СтранаРегистрации КАК СтранаРегистрации,
	|	ИностранныеКонтрагенты.Контрагент ЕСТЬ NULL КАК КонтрагентЗарегистрированВРФ,
	|	ЕСТЬNULL(ИностранныеКонтрагенты.СделкаВОбластиВнешнейТорговли, ЛОЖЬ) КАК СделкаВОбластиВнешнейТорговли,
	|	ЕСТЬNULL(ИностранныеКонтрагенты.ЗарегистрированВСтранеСЛьготнымНалогообложением, ЛОЖЬ) КАК ЗарегистрированВСтранеСЛьготнымНалогообложением
	|ПОМЕСТИТЬ УчастникиКонтролируемыхСделок
	|ИЗ
	|	КонтролируемыеКонтрагенты КАК КонтролируемыеКонтрагенты
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Контрагенты КАК Контрагенты
	|		ПО КонтролируемыеКонтрагенты.Контрагент = Контрагенты.Ссылка
	|		ЛЕВОЕ СОЕДИНЕНИЕ ИностранныеКонтрагенты КАК ИностранныеКонтрагенты
	|		ПО (ИностранныеКонтрагенты.Контрагент = КонтролируемыеКонтрагенты.Контрагент)
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	КонтролируемыеКонтрагенты.Контрагент,
	|	КонтролируемыеКонтрагенты.ГоловнойКонтрагент,
	|	Организации.СтранаРегистрации,
	|	НЕ Организации.ОтделениеИностраннойОрганизации,
	|	ЕСТЬNULL(ИностранныеОрганизации.СделкаВОбластиВнешнейТорговли, ЛОЖЬ) КАК СделкаВОбластиВнешнейТорговли,
	|	ЕСТЬNULL(ИностранныеОрганизации.ЗарегистрированаВСтранеСЛьготнымНалогообложением, ЛОЖЬ)
	|ИЗ
	|	КонтролируемыеКонтрагенты КАК КонтролируемыеКонтрагенты
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Организации КАК Организации
	|		ПО КонтролируемыеКонтрагенты.Контрагент = Организации.Ссылка
	|		ЛЕВОЕ СОЕДИНЕНИЕ ИностранныеОрганизации КАК ИностранныеОрганизации
	|		ПО (ИностранныеОрганизации.Организация = КонтролируемыеКонтрагенты.Контрагент)
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Контрагент
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	УведомлениеОКонтролируемыхСделках.Организация КАК Организация,
	|	УведомлениеОКонтролируемыхСделках.Ссылка КАК Уведомление,
	|	КонтролируемыеСделкиОрганизаций.Период КАК ПериодСделки,
	|	УведомлениеОКонтролируемыхСделках.ОтчетныйГод КАК ОтчетныйГод,
	|	КонтролируемыеСделкиОрганизаций.Контрагент КАК Контрагент,
	|	УчастникиКонтролируемыхСделок.ГоловнойКонтрагент КАК ГоловнойКонтрагент,
	|	КонтролируемыеСделкиОрганизаций.Договор КАК Договор,
	|	КонтролируемыеСделкиОрганизаций.Комиссионер КАК Комиссионер,
	|	КонтролируемыеСделкиОрганизаций.РасчетныйДокумент КАК РасчетныйДокумент,
	|	КонтролируемыеСделкиОрганизаций.ПредметСделки КАК ПредметСделки,
	|	КонтролируемыеСделкиОрганизаций.СуммаБезНДСВРублях КАК СуммаБезНДСВРублях,
	|	КонтролируемыеСделкиОрганизаций.СуммаБезНДСВВалютеРасчетов КАК СуммаБезНДСВВалютеРасчетов,
	|	УчастникиКонтролируемыхСделок.КонтрагентЗарегистрированВРФ КАК КонтрагентЗарегистрированВРФ,
	|	ВЫБОР
	|		КОГДА ЕСТЬNULL(СведенияОбОрганизацииДляКонтролируемыхСделокПоПериодам.ЯвляетсяПлательщикомНалогаНаПрибыль, ЛОЖЬ) <> ЕСТЬNULL(ДанныеПоУчастникамПоПериодам.ЯвляетсяПлательщикомНалогаНаПрибыль, ЛОЖЬ)
	|				И УчастникиКонтролируемыхСделок.КонтрагентЗарегистрированВРФ
	|				И ЕСТЬNULL(ВзаимозависимыеЛицаПоПериодам.ВзаимозависимыеЛица, ЛОЖЬ)
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ КАК СделкаКонтролируетсяПоНалогуНаПрибыль,
	|	ВЫБОР
	|		КОГДА ЕСТЬNULL(СведенияОбОрганизацииДляКонтролируемыхСделокПоПериодам.ЯвляетсяПлательщикомНалогаНаПрибыль, ЛОЖЬ) = ЕСТЬNULL(ДанныеПоУчастникамПоПериодам.ЯвляетсяПлательщикомНалогаНаПрибыль, ЛОЖЬ)
	|				И УчастникиКонтролируемыхСделок.КонтрагентЗарегистрированВРФ
	|				И ЕСТЬNULL(ВзаимозависимыеЛицаПоПериодам.ВзаимозависимыеЛица, ЛОЖЬ)
	|				И (ЕСТЬNULL(ДоговорыУчастниковКонтролируемыхСделок.СтороныПрименяютРазныеСтавкиПоНалогуНаПрибыль, ЛОЖЬ)
	|					ИЛИ ЕСТЬNULL(СведенияОбОрганизацииДляКонтролируемыхСделокПоПериодам.ЗарегистрированВОЭЗ, ЛОЖЬ) <> ЕСТЬNULL(ДанныеПоУчастникамПоПериодам.ЗарегистрированВОЭЗ, ЛОЖЬ)
	|					ИЛИ ЕСТЬNULL(СведенияОбОрганизацииДляКонтролируемыхСделокПоПериодам.ПрименяетЛьготыУчастникаРегиональногоИнвестиционногоПроекта, ЛОЖЬ)
	|					ИЛИ ЕСТЬNULL(ДанныеПоУчастникамПоПериодам.ПрименяетЛьготыУчастникаРегиональногоИнвестиционногоПроекта, ЛОЖЬ))
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ КАК СделкаКонтролируетсяПоРазнымСтавкамНалогаНаПрибыль,
	|	ВЫБОР
	|		КОГДА НЕ ТоварыМировойБиржевойТорговли.ПредметСделки ЕСТЬ NULL
	|				И УчастникиКонтролируемыхСделок.СделкаВОбластиВнешнейТорговли = ИСТИНА
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ КАК СделкаВнешнейТорговлиТоваромМировойБиржевойТорговли,
	|	УчастникиКонтролируемыхСделок.ЗарегистрированВСтранеСЛьготнымНалогообложением КАК ЗарегистрированВСтранеСЛьготнымНалогообложением,
	|	ВЫБОР
	|		КОГДА (ЕСТЬNULL(СведенияОбОрганизацииДляКонтролируемыхСделокПоПериодам.ЯвляетсяПлательщикомНДПИ, ЛОЖЬ)
	|					И КонтролируемыеСделкиОрганизаций.ТипКонтролируемойСделки = ЗНАЧЕНИЕ(Перечисление.ТипыКонтролируемыхСделок.ПолученДоход)
	|					И ЕСТЬNULL(ВзаимозависимыеЛицаПоПериодам.ВзаимозависимыеЛица, ЛОЖЬ)
	|				ИЛИ ЕСТЬNULL(ДанныеПоУчастникамПоПериодам.ЯвляетсяПлательщикомНДПИ, ЛОЖЬ)
	|					И КонтролируемыеСделкиОрганизаций.ТипКонтролируемойСделки = ЗНАЧЕНИЕ(Перечисление.ТипыКонтролируемыхСделок.ОсуществленРасход))
	|				И УчастникиКонтролируемыхСделок.КонтрагентЗарегистрированВРФ
	|				И ЕСТЬNULL(ВзаимозависимыеЛицаПоПериодам.ВзаимозависимыеЛица, ЛОЖЬ)
	|				И ЕСТЬNULL(КонтролируемыеСделкиОрганизаций.ПредметСделки.ОблагаетсяНДПИПоПроцентнойСтавке, ЛОЖЬ)
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ КАК СделкаКонтролируетсяПоНДПИ,
	|	ВЫБОР
	|		КОГДА ЕСТЬNULL(СведенияОбОрганизацииДляКонтролируемыхСделокПоПериодам.ЗарегистрированВОЭЗ, ЛОЖЬ) <> ЕСТЬNULL(ДанныеПоУчастникамПоПериодам.ЗарегистрированВОЭЗ, ЛОЖЬ)
	|				И УчастникиКонтролируемыхСделок.КонтрагентЗарегистрированВРФ
	|				И ЕСТЬNULL(ВзаимозависимыеЛицаПоПериодам.ВзаимозависимыеЛица, ЛОЖЬ)
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ КАК СделкаКонтролируетсяПоРегистрацииВОЭЗ,
	|	ВЫБОР
	|		КОГДА &УчитыватьЕНВД
	|				И (ЕСТЬNULL(КонтролируемыеСделкиОрганизаций.ОперацияОблагаетсяЕНВД, ЛОЖЬ)
	|						И КонтролируемыеСделкиОрганизаций.ТипКонтролируемойСделки = ЗНАЧЕНИЕ(Перечисление.ТипыКонтролируемыхСделок.ПолученДоход)
	|						И ЕСТЬNULL(ВзаимозависимыеЛицаПоПериодам.ВзаимозависимыеЛица, ЛОЖЬ)
	|					ИЛИ ЕСТЬNULL(ДанныеПоУчастникамПоПериодам.ЯвляетсяПлательщикомЕНВД, ЛОЖЬ)
	|						И КонтролируемыеСделкиОрганизаций.ТипКонтролируемойСделки = ЗНАЧЕНИЕ(Перечисление.ТипыКонтролируемыхСделок.ОсуществленРасход)
	|						И ЕСТЬNULL(КонтролируемыеСделкиОрганизаций.ОперацияОблагаетсяЕНВД, ЛОЖЬ)
	|						И ЕСТЬNULL(ВзаимозависимыеЛицаПоПериодам.ВзаимозависимыеЛица, ЛОЖЬ))
	|			ТОГДА ВЫБОР
	|					КОГДА ВзаимозависимыеЛицаПоПериодам.НевзаимозависимыйПосредник
	|							И НЕ &УчитыватьСпецрежимДляПосредников
	|						ТОГДА ЛОЖЬ
	|					ИНАЧЕ ИСТИНА
	|				КОНЕЦ
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ КАК СделкаОблагаетсяЕНВД,
	|	ВЫБОР
	|		КОГДА ЕСТЬNULL(ДанныеПоУчастникамПоПериодам.ЯвляетсяПлательщикомЕСХН, ЛОЖЬ)
	|				И ЕСТЬNULL(ВзаимозависимыеЛицаПоПериодам.ВзаимозависимыеЛица, ЛОЖЬ)
	|			ТОГДА ВЫБОР
	|					КОГДА ВзаимозависимыеЛицаПоПериодам.НевзаимозависимыйПосредник
	|							И НЕ &УчитыватьСпецрежимДляПосредников
	|						ТОГДА ЛОЖЬ
	|					ИНАЧЕ ИСТИНА
	|				КОНЕЦ
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ КАК СделкаСПлательщикомЕСХН,
	|	ВЫБОР
	|		КОГДА ЕСТЬNULL(ДоговорыУчастниковКонтролируемыхСделок.СделкаОтноситсяКДеятельностиНовогоМорскогоМесторождения, ЛОЖЬ)
	|				И УчастникиКонтролируемыхСделок.КонтрагентЗарегистрированВРФ
	|				И ЕСТЬNULL(ВзаимозависимыеЛицаПоПериодам.ВзаимозависимыеЛица, ЛОЖЬ)
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ КАК СделкаМорскогоМесторождения,
	|	ВЫБОР
	|		КОГДА (ЕСТЬNULL(СведенияОбОрганизацииДляКонтролируемыхСделокПоПериодам.ПрименяетЛьготыУчастникаРегиональногоИнвестиционногоПроекта, ЛОЖЬ)
	|				ИЛИ ЕСТЬNULL(ДанныеПоУчастникамПоПериодам.ПрименяетЛьготыУчастникаРегиональногоИнвестиционногоПроекта, ЛОЖЬ))
	|				И УчастникиКонтролируемыхСделок.КонтрагентЗарегистрированВРФ
	|				И ЕСТЬNULL(ВзаимозависимыеЛицаПоПериодам.ВзаимозависимыеЛица, ЛОЖЬ)
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ КАК СделкаКонтролируетсяПоИнвестиционнымПроектам,
	|	ВЫБОР
	|		КОГДА (ЕСТЬNULL(СведенияОбОрганизацииДляКонтролируемыхСделокПоПериодам.ОсвобожденОтУплатыНДС, ЛОЖЬ)
	|				ИЛИ ЕСТЬNULL(ДанныеПоУчастникамПоПериодам.ОсвобожденОтУплатыНДС, ЛОЖЬ))
	|				И УчастникиКонтролируемыхСделок.КонтрагентЗарегистрированВРФ
	|				И ЕСТЬNULL(ВзаимозависимыеЛицаПоПериодам.ВзаимозависимыеЛица, ЛОЖЬ)
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ КАК СделкаКонтролируетсяПоОсвобождениюНДС,
	|	ВЫБОР
	|		КОГДА ЕСТЬNULL(ДанныеПоУчастникамПоПериодам.ПрименяетИнвестиционныйВычетПоНалогуНаПрибыль, ЛОЖЬ)
	|				И УчастникиКонтролируемыхСделок.КонтрагентЗарегистрированВРФ
	|				И ЕСТЬNULL(ВзаимозависимыеЛицаПоПериодам.ВзаимозависимыеЛица, ЛОЖЬ)
	|				И &УчитыватьИнвестиционныйВычет
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ КАК СделкаКонтролируетсяПоИнвестиционномуВычету,
	|	ВЫБОР
	|		КОГДА ЕСТЬNULL(ДоговорыУчастниковКонтролируемыхСделок.СделкаОтноситсяКДеятельностиОблагаемойНалогомНаДопДоход, ЛОЖЬ)
	|				И УчастникиКонтролируемыхСделок.КонтрагентЗарегистрированВРФ
	|				И ЕСТЬNULL(ВзаимозависимыеЛицаПоПериодам.ВзаимозависимыеЛица, ЛОЖЬ)
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ КАК СделкаКонтролируетсяПоДополнительномуДоходуОтСырья,
	|	ЕСТЬNULL(ДоговорыУчастниковКонтролируемыхСделок.СделкаНеЯвляетсяКонтролируемойПоП4, ЛОЖЬ) КАК СделкаНеЯвляетсяКонтролируемойПоП4,
	|	ЕСТЬNULL(ВзаимозависимыеЛицаПоПериодам.ТипВзаимозависимости, ЗНАЧЕНИЕ(Перечисление.ТипыВзаимозависимости.НеВзаимозависимы)) КАК ТипВзаимозависимости,
	|	КонтролируемыеСделкиОрганизаций.ТипПредметаСделки КАК ТипПредметаСделки,
	|	КонтролируемыеСделкиОрганизаций.ЕдиницаИзмерения КАК ЕдиницаИзмерения,
	|	КонтролируемыеСделкиОрганизаций.СтранаПроисхожденияПредметаСделки КАК СтранаПроисхожденияПредметаСделки,
	|	КонтролируемыеСделкиОрганизаций.ТипКонтролируемойСделки КАК ТипКонтролируемойСделки,
	|	КонтролируемыеСделкиОрганизаций.Грузоотправитель КАК Грузоотправитель,
	|	КонтролируемыеСделкиОрганизаций.Грузополучатель КАК Грузополучатель,
	|	КонтролируемыеСделкиОрганизаций.НаименованиеПредметаСделки КАК НаименованиеПредметаСделки,
	|	КонтролируемыеСделкиОрганизаций.Валюта КАК Валюта,
	|	КонтролируемыеСделкиОрганизаций.Количество КАК Количество,
	|	КонтролируемыеСделкиОрганизаций.ПроцентнаяСтавка КАК ПроцентнаяСтавка,
	|	КонтролируемыеСделкиОрганизаций.ДатаПроцентнойСтавки КАК ДатаПроцентнойСтавки,
	|	ВЫБОР
	|		КОГДА ЕСТЬNULL(ВзаимозависимыеЛицаПоПериодам.ТипВзаимозависимости, ЗНАЧЕНИЕ(Перечисление.ТипыВзаимозависимости.НеВзаимозависимы)) = ЗНАЧЕНИЕ(Перечисление.ТипыВзаимозависимости.НеВзаимозависимы)
	|				ИЛИ ЕСТЬNULL(ВзаимозависимыеЛицаПоПериодам.ТипВзаимозависимости, ЗНАЧЕНИЕ(Перечисление.ТипыВзаимозависимости.НеВзаимозависимы)) = ЗНАЧЕНИЕ(Перечисление.ТипыВзаимозависимости.НеВзаимозависимыйПосредник)
	|			ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА
	|	КОНЕЦ КАК СтороныВзаимозависимыПоКодексу,
	|	ВЫБОР
	|		КОГДА ЕСТЬNULL(ВзаимозависимыеЛицаПоПериодам.ТипВзаимозависимости, ЗНАЧЕНИЕ(Перечисление.ТипыВзаимозависимости.НеВзаимозависимы)) = ЗНАЧЕНИЕ(Перечисление.ТипыВзаимозависимости.НеВзаимозависимыйПосредник)
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ КАК СделкаСНезависимымПосредником
	|ПОМЕСТИТЬ КонтролируемыеСделки
	|ИЗ
	|	РегистрНакопления.КонтролируемыеСделкиОрганизаций КАК КонтролируемыеСделкиОрганизаций
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.УведомлениеОКонтролируемыхСделках КАК УведомлениеОКонтролируемыхСделках
	|		ПО КонтролируемыеСделкиОрганизаций.Уведомление = УведомлениеОКонтролируемыхСделках.Ссылка
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ УчастникиКонтролируемыхСделок КАК УчастникиКонтролируемыхСделок
	|		ПО КонтролируемыеСделкиОрганизаций.Контрагент = УчастникиКонтролируемыхСделок.Контрагент
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВзаимозависимыеЛицаПоПериодам КАК ВзаимозависимыеЛицаПоПериодам
	|		ПО КонтролируемыеСделкиОрганизаций.Организация = ВзаимозависимыеЛицаПоПериодам.Организация
	|			И КонтролируемыеСделкиОрганизаций.Контрагент = ВзаимозависимыеЛицаПоПериодам.Контрагент
	|			И КонтролируемыеСделкиОрганизаций.Период >= ВзаимозависимыеЛицаПоПериодам.НачалоПериода
	|			И КонтролируемыеСделкиОрганизаций.Период <= ВзаимозависимыеЛицаПоПериодам.ОкончаниеПериода
	|		ЛЕВОЕ СОЕДИНЕНИЕ СведенияОбОрганизацииДляКонтролируемыхСделокПоПериодам КАК СведенияОбОрганизацииДляКонтролируемыхСделокПоПериодам
	|		ПО КонтролируемыеСделкиОрганизаций.Организация = СведенияОбОрганизацииДляКонтролируемыхСделокПоПериодам.Организация
	|			И КонтролируемыеСделкиОрганизаций.Период >= СведенияОбОрганизацииДляКонтролируемыхСделокПоПериодам.НачалоПериода
	|			И КонтролируемыеСделкиОрганизаций.Период <= СведенияОбОрганизацииДляКонтролируемыхСделокПоПериодам.ОкончаниеПериода
	|		ЛЕВОЕ СОЕДИНЕНИЕ ТоварыМировойБиржевойТорговли КАК ТоварыМировойБиржевойТорговли
	|		ПО КонтролируемыеСделкиОрганизаций.ПредметСделки = ТоварыМировойБиржевойТорговли.ПредметСделки
	|			И ТоварыМировойБиржевойТорговли.ДатаНачалаДействия <= КонтролируемыеСделкиОрганизаций.Период
	|			И ТоварыМировойБиржевойТорговли.ДатаОкончанияДействия >= КонтролируемыеСделкиОрганизаций.Период
	|		ЛЕВОЕ СОЕДИНЕНИЕ ДанныеПоУчастникамКонтролируемыхСделокПоПериодам КАК ДанныеПоУчастникамПоПериодам
	|		ПО КонтролируемыеСделкиОрганизаций.Контрагент = ДанныеПоУчастникамПоПериодам.Контрагент
	|			И КонтролируемыеСделкиОрганизаций.Период >= ДанныеПоУчастникамПоПериодам.НачалоПериода
	|			И КонтролируемыеСделкиОрганизаций.Период <= ДанныеПоУчастникамПоПериодам.ОкончаниеПериода
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ДоговорыУчастниковКонтролируемыхСделок КАК ДоговорыУчастниковКонтролируемыхСделок
	|		ПО КонтролируемыеСделкиОрганизаций.Организация = ДоговорыУчастниковКонтролируемыхСделок.Организация
	|			И КонтролируемыеСделкиОрганизаций.Контрагент = ДоговорыУчастниковКонтролируемыхСделок.Контрагент
	|			И КонтролируемыеСделкиОрганизаций.Договор = ДоговорыУчастниковКонтролируемыхСделок.ДоговорКонтрагента
	|ГДЕ
	|	УведомлениеОКонтролируемыхСделках.Ссылка = &Уведомление
	|	И КонтролируемыеСделкиОрганизаций.Уведомление = &Уведомление
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Контрагент,
	|	Договор,
	|	ПредметСделки
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	КонтролируемыеСделки.ГоловнойКонтрагент КАК ГоловнойКонтрагент,
	|	СУММА(КонтролируемыеСделки.СуммаБезНДСВРублях) КАК СуммаБезНДСВРублях
	|ПОМЕСТИТЬ КонтрагентыПоМинимальнойСумме
	|ИЗ
	|	КонтролируемыеСделки КАК КонтролируемыеСделки
	|
	|СГРУППИРОВАТЬ ПО
	|	КонтролируемыеСделки.ГоловнойКонтрагент
	|
	|ИМЕЮЩИЕ
	|	СУММА(КонтролируемыеСделки.СуммаБезНДСВРублях) > &МинимальнаяГраницаДляВключенияСделокВУведомление
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	КонтролируемыеСделки.ГоловнойКонтрагент КАК ГоловнойКонтрагент,
	|	СУММА(КонтролируемыеСделки.СуммаБезНДСВРублях) КАК СуммаБезНДСВРублях
	|ПОМЕСТИТЬ КонтрагентыКонтролируемыеПоОбщейСумме
	|ИЗ
	|	КонтролируемыеСделки КАК КонтролируемыеСделки
	|ГДЕ
	|	&КонтролироватьЗависимыхЛицРФПоОбщейСумме
	|	И КонтролируемыеСделки.КонтрагентЗарегистрированВРФ
	|	И КонтролируемыеСделки.ТипВзаимозависимости <> ЗНАЧЕНИЕ(Перечисление.ТипыВзаимозависимости.НеВзаимозависимы)
	|	И НЕ КонтролируемыеСделки.СделкаНеЯвляетсяКонтролируемойПоП4
	|
	|СГРУППИРОВАТЬ ПО
	|	КонтролируемыеСделки.ГоловнойКонтрагент
	|
	|ИМЕЮЩИЕ
	|	СУММА(КонтролируемыеСделки.СуммаБезНДСВРублях) >= &ГраницаОбщейСуммыСделок
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	КонтролируемыеСделки.ГоловнойКонтрагент КАК ГоловнойКонтрагент,
	|	СУММА(КонтролируемыеСделки.СуммаБезНДСВРублях) КАК СуммаБезНДСВРублях
	|ПОМЕСТИТЬ КонтрагентыРФКонтролируемыеПоУсловию
	|ИЗ
	|	КонтролируемыеСделки КАК КонтролируемыеСделки
	|ГДЕ
	|	&КонтролироватьЗависимыхЛицРФПоУсловиям
	|	И КонтролируемыеСделки.КонтрагентЗарегистрированВРФ
	|	И КонтролируемыеСделки.ТипВзаимозависимости <> ЗНАЧЕНИЕ(Перечисление.ТипыВзаимозависимости.НеВзаимозависимы)
	|	И (КонтролируемыеСделки.СделкаКонтролируетсяПоРазнымСтавкамНалогаНаПрибыль
	|			ИЛИ КонтролируемыеСделки.СделкаКонтролируетсяПоНДПИ
	|			ИЛИ КонтролируемыеСделки.СделкаОблагаетсяЕНВД
	|			ИЛИ КонтролируемыеСделки.СделкаСПлательщикомЕСХН
	|			ИЛИ КонтролируемыеСделки.СделкаКонтролируетсяПоНалогуНаПрибыль
	|			ИЛИ КонтролируемыеСделки.СделкаМорскогоМесторождения
	|			ИЛИ КонтролируемыеСделки.СделкаКонтролируетсяПоОсвобождениюНДС
	|			ИЛИ КонтролируемыеСделки.СделкаКонтролируетсяПоИнвестиционномуВычету
	|			ИЛИ КонтролируемыеСделки.СделкаКонтролируетсяПоДополнительномуДоходуОтСырья)
	|	И НЕ КонтролируемыеСделки.СделкаНеЯвляетсяКонтролируемойПоП4
	|
	|СГРУППИРОВАТЬ ПО
	|	КонтролируемыеСделки.ГоловнойКонтрагент
	|
	|ИМЕЮЩИЕ
	|	СУММА(КонтролируемыеСделки.СуммаБезНДСВРублях) >= &ГраницаОбщейСуммыСделок
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	КонтролируемыеСделки.ГоловнойКонтрагент КАК ГоловнойКонтрагент,
	|	СУММА(КонтролируемыеСделки.СуммаБезНДСВРублях) КАК СуммаБезНДСВРублях
	|ПОМЕСТИТЬ КонтрагентыКонтролируемыеПоНДПИ
	|ИЗ
	|	КонтролируемыеСделки КАК КонтролируемыеСделки
	|ГДЕ
	|	&КонтролироватьЗависимыхЛицРФНДПИ
	|	И КонтролируемыеСделки.КонтрагентЗарегистрированВРФ
	|	И КонтролируемыеСделки.ТипВзаимозависимости <> ЗНАЧЕНИЕ(Перечисление.ТипыВзаимозависимости.НеВзаимозависимы)
	|	И КонтролируемыеСделки.СделкаКонтролируетсяПоНДПИ
	|	И НЕ КонтролируемыеСделки.СделкаНеЯвляетсяКонтролируемойПоП4
	|
	|СГРУППИРОВАТЬ ПО
	|	КонтролируемыеСделки.ГоловнойКонтрагент
	|
	|ИМЕЮЩИЕ
	|	СУММА(КонтролируемыеСделки.СуммаБезНДСВРублях) >= &ГраницаСуммыСделокНДПИ
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	КонтролируемыеСделки.ГоловнойКонтрагент КАК ГоловнойКонтрагент,
	|	СУММА(КонтролируемыеСделки.СуммаБезНДСВРублях) КАК СуммаБезНДСВРублях
	|ПОМЕСТИТЬ КонтрагентыКонтролируемыеПоСпецРежиму
	|ИЗ
	|	КонтролируемыеСделки КАК КонтролируемыеСделки
	|ГДЕ
	|	&КонтролироватьЗависимыхЛицРФСпецРежим
	|	И КонтролируемыеСделки.КонтрагентЗарегистрированВРФ
	|	И КонтролируемыеСделки.ТипВзаимозависимости <> ЗНАЧЕНИЕ(Перечисление.ТипыВзаимозависимости.НеВзаимозависимы)
	|	И (КонтролируемыеСделки.СделкаОблагаетсяЕНВД
	|			ИЛИ КонтролируемыеСделки.СделкаСПлательщикомЕСХН)
	|	И НЕ КонтролируемыеСделки.СделкаНеЯвляетсяКонтролируемойПоП4
	|
	|СГРУППИРОВАТЬ ПО
	|	КонтролируемыеСделки.ГоловнойКонтрагент
	|
	|ИМЕЮЩИЕ
	|	СУММА(КонтролируемыеСделки.СуммаБезНДСВРублях) >= &ГраницаСуммыСделокСпецРежим
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	КонтролируемыеСделки.ГоловнойКонтрагент КАК ГоловнойКонтрагент,
	|	СУММА(КонтролируемыеСделки.СуммаБезНДСВРублях) КАК СуммаБезНДСВРублях
	|ПОМЕСТИТЬ КонтрагентыКонтролируемыеПоПрибыли
	|ИЗ
	|	КонтролируемыеСделки КАК КонтролируемыеСделки
	|ГДЕ
	|	&КонтролироватьЗависимыхЛицРФПрибыль
	|	И КонтролируемыеСделки.КонтрагентЗарегистрированВРФ
	|	И КонтролируемыеСделки.ТипВзаимозависимости <> ЗНАЧЕНИЕ(Перечисление.ТипыВзаимозависимости.НеВзаимозависимы)
	|	И КонтролируемыеСделки.СделкаКонтролируетсяПоНалогуНаПрибыль
	|	И НЕ КонтролируемыеСделки.СделкаНеЯвляетсяКонтролируемойПоП4
	|
	|СГРУППИРОВАТЬ ПО
	|	КонтролируемыеСделки.ГоловнойКонтрагент
	|
	|ИМЕЮЩИЕ
	|	СУММА(КонтролируемыеСделки.СуммаБезНДСВРублях) >= &ГраницаСуммыСделокПрибыль
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	КонтролируемыеСделки.ГоловнойКонтрагент КАК ГоловнойКонтрагент,
	|	СУММА(КонтролируемыеСделки.СуммаБезНДСВРублях) КАК СуммаБезНДСВРублях
	|ПОМЕСТИТЬ КонтрагентыКонтролируемыеПоОЭЗ
	|ИЗ
	|	КонтролируемыеСделки КАК КонтролируемыеСделки
	|ГДЕ
	|	&КонтролироватьЗависимыхЛицРФРегистрацияОЭЗ
	|	И КонтролируемыеСделки.КонтрагентЗарегистрированВРФ
	|	И КонтролируемыеСделки.ТипВзаимозависимости <> ЗНАЧЕНИЕ(Перечисление.ТипыВзаимозависимости.НеВзаимозависимы)
	|	И КонтролируемыеСделки.СделкаКонтролируетсяПоРегистрацииВОЭЗ
	|	И НЕ КонтролируемыеСделки.СделкаНеЯвляетсяКонтролируемойПоП4
	|
	|СГРУППИРОВАТЬ ПО
	|	КонтролируемыеСделки.ГоловнойКонтрагент
	|
	|ИМЕЮЩИЕ
	|	СУММА(КонтролируемыеСделки.СуммаБезНДСВРублях) >= &ГраницаСуммыСделокОЭЗ
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	КонтролируемыеСделки.ГоловнойКонтрагент КАК ГоловнойКонтрагент,
	|	СУММА(КонтролируемыеСделки.СуммаБезНДСВРублях) КАК СуммаБезНДСВРублях
	|ПОМЕСТИТЬ КонтрагентыКонтролируемыеПоМорскомуМесторождению
	|ИЗ
	|	КонтролируемыеСделки КАК КонтролируемыеСделки
	|ГДЕ
	|	&КонтролироватьЗависимыхЛицРФНовоеМорскоеМесторождение
	|	И КонтролируемыеСделки.КонтрагентЗарегистрированВРФ
	|	И КонтролируемыеСделки.ТипВзаимозависимости <> ЗНАЧЕНИЕ(Перечисление.ТипыВзаимозависимости.НеВзаимозависимы)
	|	И КонтролируемыеСделки.СделкаМорскогоМесторождения
	|	И НЕ КонтролируемыеСделки.СделкаНеЯвляетсяКонтролируемойПоП4
	|
	|СГРУППИРОВАТЬ ПО
	|	КонтролируемыеСделки.ГоловнойКонтрагент
	|
	|ИМЕЮЩИЕ
	|	СУММА(КонтролируемыеСделки.СуммаБезНДСВРублях) >= &ГраницаНовоеМорскоеМесторождение
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	КонтролируемыеСделки.ГоловнойКонтрагент КАК ГоловнойКонтрагент,
	|	СУММА(КонтролируемыеСделки.СуммаБезНДСВРублях) КАК СуммаБезНДСВРублях
	|ПОМЕСТИТЬ КонтрагентыКонтролируемыеПоИнвестиционнымПроектам
	|ИЗ
	|	КонтролируемыеСделки КАК КонтролируемыеСделки
	|ГДЕ
	|	&КонтролироватьЗависимыхЛицРФРегиональныйИнвестПроект
	|	И КонтролируемыеСделки.КонтрагентЗарегистрированВРФ
	|	И КонтролируемыеСделки.ТипВзаимозависимости <> ЗНАЧЕНИЕ(Перечисление.ТипыВзаимозависимости.НеВзаимозависимы)
	|	И КонтролируемыеСделки.СделкаКонтролируетсяПоИнвестиционнымПроектам
	|	И НЕ КонтролируемыеСделки.СделкаНеЯвляетсяКонтролируемойПоП4
	|
	|СГРУППИРОВАТЬ ПО
	|	КонтролируемыеСделки.ГоловнойКонтрагент
	|
	|ИМЕЮЩИЕ
	|	СУММА(КонтролируемыеСделки.СуммаБезНДСВРублях) >= &ГраницаРегиональныйИнвестиционныйПроект
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	КонтролируемыеСделки.ГоловнойКонтрагент КАК ГоловнойКонтрагент,
	|	СУММА(КонтролируемыеСделки.СуммаБезНДСВРублях) КАК СуммаБезНДСВРублях
	|ПОМЕСТИТЬ КонтрагентыКонтролируемыеПоОсвобождениюНДС
	|ИЗ
	|	КонтролируемыеСделки КАК КонтролируемыеСделки
	|ГДЕ
	|	&КонтролироватьЗависимыхЛицРФОсвобождениеНДС
	|	И КонтролируемыеСделки.КонтрагентЗарегистрированВРФ
	|	И КонтролируемыеСделки.ТипВзаимозависимости <> ЗНАЧЕНИЕ(Перечисление.ТипыВзаимозависимости.НеВзаимозависимы)
	|	И КонтролируемыеСделки.СделкаКонтролируетсяПоОсвобождениюНДС
	|	И НЕ КонтролируемыеСделки.СделкаНеЯвляетсяКонтролируемойПоП4
	|
	|СГРУППИРОВАТЬ ПО
	|	КонтролируемыеСделки.ГоловнойКонтрагент
	|
	|ИМЕЮЩИЕ
	|	СУММА(КонтролируемыеСделки.СуммаБезНДСВРублях) >= &ГраницаОсвобождениеНДС
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	КонтролируемыеСделки.ГоловнойКонтрагент КАК ГоловнойКонтрагент,
	|	СУММА(КонтролируемыеСделки.СуммаБезНДСВРублях) КАК СуммаБезНДСВРублях
	|ПОМЕСТИТЬ КонтрагентыКонтролируемыеПоИнвестиционномуВычету
	|ИЗ
	|	КонтролируемыеСделки КАК КонтролируемыеСделки
	|ГДЕ
	|	&КонтролироватьЗависимыхЛицРФИнвестиционныйВычет
	|	И КонтролируемыеСделки.КонтрагентЗарегистрированВРФ
	|	И КонтролируемыеСделки.ТипВзаимозависимости <> ЗНАЧЕНИЕ(Перечисление.ТипыВзаимозависимости.НеВзаимозависимы)
	|	И КонтролируемыеСделки.СделкаКонтролируетсяПоИнвестиционномуВычету
	|	И НЕ КонтролируемыеСделки.СделкаНеЯвляетсяКонтролируемойПоП4
	|
	|СГРУППИРОВАТЬ ПО
	|	КонтролируемыеСделки.ГоловнойКонтрагент
	|
	|ИМЕЮЩИЕ
	|	СУММА(КонтролируемыеСделки.СуммаБезНДСВРублях) >= &ГраницаИнвестиционныйВычет
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	КонтролируемыеСделки.ГоловнойКонтрагент КАК ГоловнойКонтрагент,
	|	СУММА(КонтролируемыеСделки.СуммаБезНДСВРублях) КАК СуммаБезНДСВРублях
	|ПОМЕСТИТЬ КонтрагентыКонтролируемыеПоРегистрацииНеВРФ
	|ИЗ
	|	КонтролируемыеСделки КАК КонтролируемыеСделки
	|ГДЕ
	|	КонтролируемыеСделки.ТипВзаимозависимости = ЗНАЧЕНИЕ(Перечисление.ТипыВзаимозависимости.НеВзаимозависимы)
	|	И (КонтролируемыеСделки.ЗарегистрированВСтранеСЛьготнымНалогообложением
	|			ИЛИ КонтролируемыеСделки.СделкаВнешнейТорговлиТоваромМировойБиржевойТорговли)
	|	И НЕ КонтролируемыеСделки.СделкаНеЯвляетсяКонтролируемойПоП4
	|
	|СГРУППИРОВАТЬ ПО
	|	КонтролируемыеСделки.ГоловнойКонтрагент
	|
	|ИМЕЮЩИЕ
	|	СУММА(КонтролируемыеСделки.СуммаБезНДСВРублях) >= &ГраницаСуммыСделокИностранныхНезависимыхЛиц
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	КонтролируемыеСделки.ГоловнойКонтрагент КАК ГоловнойКонтрагент,
	|	СУММА(КонтролируемыеСделки.СуммаБезНДСВРублях) КАК СуммаБезНДСВРублях
	|ПОМЕСТИТЬ КонтрагентыКонтролируемыеКакПрочиеЗависимыеЛица
	|ИЗ
	|	КонтролируемыеСделки КАК КонтролируемыеСделки
	|ГДЕ
	|	(КонтролируемыеСделки.ТипВзаимозависимости = ЗНАЧЕНИЕ(Перечисление.ТипыВзаимозависимости.НеВзаимозависимыйПосредник)
	|			ИЛИ КонтролируемыеСделки.СтороныВзаимозависимыПоКодексу
	|				И НЕ КонтролируемыеСделки.КонтрагентЗарегистрированВРФ)
	|	И НЕ КонтролируемыеСделки.СделкаНеЯвляетсяКонтролируемойПоП4
	|
	|СГРУППИРОВАТЬ ПО
	|	КонтролируемыеСделки.ГоловнойКонтрагент
	|
	|ИМЕЮЩИЕ
	|	СУММА(КонтролируемыеСделки.СуммаБезНДСВРублях) >= &ГраницаПрочиеВзаимозависимыеЛица";
	
	Запрос.Выполнить();
	
	Возврат Запрос.МенеджерВременныхТаблиц;
	
КонецФункции

// Возвращает текст запроса с данными по записанным контролируемым сделкам.
//	Возвращаемое значение:
//		Строка - текст запроса.
//
Функция ПолучитьТекстЗапросаПоКонтролируемымСделкам_2012() Экспорт
	
	ТекстЗапроса =
	"ВЫБРАТЬ РАЗРЕШЕННЫЕ РАЗЛИЧНЫЕ
	|	КонтролируемаяСделка.Организация КАК Ссылка
	|ПОМЕСТИТЬ ФильтрОрганизацийИКонтрагентов
	|ИЗ
	|	Документ.КонтролируемаяСделка КАК КонтролируемаяСделка
	|ГДЕ
	|	КонтролируемаяСделка.УведомлениеОКонтролируемойСделке = &УведомлениеОКонтролируемойСделке
	|	И НЕ КонтролируемаяСделка.ПометкаУдаления
	|
	|ОБЪЕДИНИТЬ
	|
	|ВЫБРАТЬ
	|	КонтролируемаяСделка.Контрагент
	|ИЗ
	|	Документ.КонтролируемаяСделка КАК КонтролируемаяСделка
	|ГДЕ
	|	КонтролируемаяСделка.УведомлениеОКонтролируемойСделке = &УведомлениеОКонтролируемойСделке
	|	И НЕ КонтролируемаяСделка.Контрагент В (ЗНАЧЕНИЕ(Справочник.Организации.ПустаяСсылка), ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка))
	|	И НЕ КонтролируемаяСделка.ПометкаУдаления
	|
	|ОБЪЕДИНИТЬ
	|
	|ВЫБРАТЬ
	|	КонтролируемаяСделка.Комиссионер
	|ИЗ
	|	Документ.КонтролируемаяСделка КАК КонтролируемаяСделка
	|ГДЕ
	|	КонтролируемаяСделка.УведомлениеОКонтролируемойСделке = &УведомлениеОКонтролируемойСделке
	|	И НЕ КонтролируемаяСделка.Комиссионер В (ЗНАЧЕНИЕ(Справочник.Организации.ПустаяСсылка), ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка))
	|	И НЕ КонтролируемаяСделка.ПометкаУдаления
	|
	|ОБЪЕДИНИТЬ
	|
	|ВЫБРАТЬ
	|	Листы1В.Контрагент
	|ИЗ
	|	Документ.КонтролируемаяСделка.Листы1В КАК Листы1В
	|ГДЕ
	|	Листы1В.Ссылка.УведомлениеОКонтролируемойСделке = &УведомлениеОКонтролируемойСделке
	|	И НЕ Листы1В.Контрагент В (ЗНАЧЕНИЕ(Справочник.Организации.ПустаяСсылка), ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка))
	|	И НЕ Листы1В.Ссылка.ПометкаУдаления
	|
	|ОБЪЕДИНИТЬ
	|
	|ВЫБРАТЬ
	|	Листы1Г.Контрагент
	|ИЗ
	|	Документ.КонтролируемаяСделка.Листы1Г КАК Листы1Г
	|ГДЕ
	|	Листы1Г.Ссылка.УведомлениеОКонтролируемойСделке = &УведомлениеОКонтролируемойСделке
	|	И НЕ Листы1Г.Контрагент В (ЗНАЧЕНИЕ(Справочник.Организации.ПустаяСсылка), ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка))
	|	И НЕ Листы1Г.Ссылка.ПометкаУдаления
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Ссылка
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	Контрагенты.Ссылка КАК Ссылка,
	|	Контрагенты.ОбособленноеПодразделение КАК ОбособленноеПодразделение,
	|	ВЫБОР
	|		КОГДА Контрагенты.ГоловнойКонтрагент = ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	|			ТОГДА Контрагенты.Ссылка
	|		ИНАЧЕ Контрагенты.ГоловнойКонтрагент
	|	КОНЕЦ КАК ГоловнойКонтрагент,
	|	Контрагенты.СтранаРегистрации КАК СтранаРегистрации,
	|	Контрагенты.СтранаРегистрации.Код КАК КодСтраныРегистрации,
	|	Контрагенты.ЮридическоеФизическоеЛицо КАК ЮридическоеФизическоеЛицо,
	|	Контрагенты.ИНН КАК ИНН,
	|	Контрагенты.КПП КАК КПП,
	|	Контрагенты.НаименованиеМеждународное КАК НаименованиеМеждународное,
	|	Контрагенты.НаименованиеПолное КАК НаименованиеПолное,
	|	Контрагенты.РегистрационныйНомер КАК РегистрационныйНомер,
	|	Контрагенты.НалоговыйНомер КАК НалоговыйНомер
	|ПОМЕСТИТЬ КонтрагентыИОрганизации_Предварительная
	|ИЗ
	|	Справочник.Контрагенты КАК Контрагенты
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ФильтрОрганизацийИКонтрагентов КАК Фильтр
	|		ПО (Фильтр.Ссылка = Контрагенты.Ссылка)
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	Организации.Ссылка,
	|	Организации.ОбособленноеПодразделение,
	|	Организации.ГоловнаяОрганизация,
	|	Организации.СтранаРегистрации,
	|	Организации.СтранаРегистрации.Код,
	|	Организации.ЮридическоеФизическоеЛицо,
	|	Организации.ИНН,
	|	Организации.КПП,
	|	Организации.НаименованиеИнострОрганизации,
	|	Организации.НаименованиеПолное,
	|	Организации.ОГРН,
	|	""""
	|ИЗ
	|	Справочник.Организации КАК Организации
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ФильтрОрганизацийИКонтрагентов КАК Фильтр
	|		ПО (Фильтр.Ссылка = Организации.Ссылка)
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Ссылка
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ОрганизацииКонтактнаяИнформация.Ссылка КАК Ссылка,
	|	МАКСИМУМ(ОрганизацииКонтактнаяИнформация.ДействуетС) КАК ДействуетС
	|ПОМЕСТИТЬ ДатыАктуальностиАдресов
	|ИЗ
	|	Справочник.Организации.КонтактнаяИнформация КАК ОрганизацииКонтактнаяИнформация
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ КонтрагентыИОрганизации_Предварительная КАК КонтрагентыИОрганизации
	|		ПО ОрганизацииКонтактнаяИнформация.Ссылка = КонтрагентыИОрганизации.Ссылка
	|ГДЕ
	|	ОрганизацииКонтактнаяИнформация.ДействуетС <= &ДатаАктуальностиСведений
	|	И ОрганизацииКонтактнаяИнформация.Тип = ЗНАЧЕНИЕ(Перечисление.ТипыКонтактнойИнформации.Адрес)
	|	И ОрганизацииКонтактнаяИнформация.Вид = ЗНАЧЕНИЕ(Справочник.ВидыКонтактнойИнформации.ЮрАдресОрганизации)
	|
	|СГРУППИРОВАТЬ ПО
	|	ОрганизацииКонтактнаяИнформация.Ссылка
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	КонтрагентыКонтактнаяИнформация.Ссылка,
	|	МАКСИМУМ(КонтрагентыКонтактнаяИнформация.ДействуетС)
	|ИЗ
	|	Справочник.Контрагенты.КонтактнаяИнформация КАК КонтрагентыКонтактнаяИнформация
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ КонтрагентыИОрганизации_Предварительная КАК КонтрагентыИОрганизации
	|		ПО КонтрагентыКонтактнаяИнформация.Ссылка = КонтрагентыИОрганизации.Ссылка
	|ГДЕ
	|	КонтрагентыКонтактнаяИнформация.ДействуетС <= &ДатаАктуальностиСведений
	|	И КонтрагентыКонтактнаяИнформация.Тип = ЗНАЧЕНИЕ(Перечисление.ТипыКонтактнойИнформации.Адрес)
	|	И КонтрагентыКонтактнаяИнформация.Вид = ЗНАЧЕНИЕ(Справочник.ВидыКонтактнойИнформации.ЮрАдресКонтрагента)
	|
	|СГРУППИРОВАТЬ ПО
	|	КонтрагентыКонтактнаяИнформация.Ссылка
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ОрганизацииКонтактнаяИнформация.Ссылка КАК Ссылка,
	|	ОрганизацииКонтактнаяИнформация.Представление КАК ЮридическийАдрес,
	|	ОрганизацииКонтактнаяИнформация.Значение КАК ЮридическийАдресЗначение
	|ПОМЕСТИТЬ ЮридическиеАдреса
	|ИЗ
	|	ДатыАктуальностиАдресов КАК ДатыАктуальностиАдресов
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Организации.КонтактнаяИнформация КАК ОрганизацииКонтактнаяИнформация
	|		ПО ДатыАктуальностиАдресов.Ссылка = ОрганизацииКонтактнаяИнформация.Ссылка
	|			И ДатыАктуальностиАдресов.ДействуетС = ОрганизацииКонтактнаяИнформация.ДействуетС
	|ГДЕ
	|	ОрганизацииКонтактнаяИнформация.Тип = ЗНАЧЕНИЕ(Перечисление.ТипыКонтактнойИнформации.Адрес)
	|	И ОрганизацииКонтактнаяИнформация.Вид = ЗНАЧЕНИЕ(Справочник.ВидыКонтактнойИнформации.ЮрАдресОрганизации)
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	КонтрагентыКонтактнаяИнформация.Ссылка,
	|	КонтрагентыКонтактнаяИнформация.Представление,
	|	КонтрагентыКонтактнаяИнформация.Значение
	|ИЗ
	|	ДатыАктуальностиАдресов КАК ДатыАктуальностиАдресов
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Контрагенты.КонтактнаяИнформация КАК КонтрагентыКонтактнаяИнформация
	|		ПО ДатыАктуальностиАдресов.Ссылка = КонтрагентыКонтактнаяИнформация.Ссылка
	|			И ДатыАктуальностиАдресов.ДействуетС = КонтрагентыКонтактнаяИнформация.ДействуетС
	|ГДЕ
	|	КонтрагентыКонтактнаяИнформация.Тип = ЗНАЧЕНИЕ(Перечисление.ТипыКонтактнойИнформации.Адрес)
	|	И КонтрагентыКонтактнаяИнформация.Вид = ЗНАЧЕНИЕ(Справочник.ВидыКонтактнойИнформации.ЮрАдресКонтрагента)
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ОрганизацииИсторияНаименований.Ссылка КАК Ссылка,
	|	МАКСИМУМ(ОрганизацииИсторияНаименований.Период) КАК Период
	|ПОМЕСТИТЬ ДатыАктуальностиНаименованийОрганизаций
	|ИЗ
	|	Справочник.Организации.ИсторияНаименований КАК ОрганизацииИсторияНаименований
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ КонтрагентыИОрганизации_Предварительная КАК КонтрагентыИОрганизации
	|		ПО ОрганизацииИсторияНаименований.Ссылка = КонтрагентыИОрганизации.Ссылка
	|ГДЕ
	|	ОрганизацииИсторияНаименований.Период <= &ДатаАктуальностиСведений
	|
	|СГРУППИРОВАТЬ ПО
	|	ОрганизацииИсторияНаименований.Ссылка
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ОрганизацииИсторияНаименований.Ссылка КАК Ссылка,
	|	ОрганизацииИсторияНаименований.НаименованиеПолное КАК НаименованиеПолное,
	|	ОрганизацииИсторияНаименований.НаименованиеМеждународное КАК НаименованиеМеждународное
	|ПОМЕСТИТЬ НаименованияПоИстории
	|ИЗ
	|	ДатыАктуальностиНаименованийОрганизаций КАК ДатыАктуальностиНаименованийОрганизаций
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Организации.ИсторияНаименований КАК ОрганизацииИсторияНаименований
	|		ПО ДатыАктуальностиНаименованийОрганизаций.Ссылка = ОрганизацииИсторияНаименований.Ссылка
	|			И ДатыАктуальностиНаименованийОрганизаций.Период = ОрганизацииИсторияНаименований.Период
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	Контрагенты.Ссылка,
	|	Контрагенты.НаименованиеПолное,
	|	Контрагенты.НаименованиеМеждународное
	|ИЗ
	|	КонтрагентыИОрганизации_Предварительная КАК КонтрагентыИОрганизации
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Контрагенты КАК Контрагенты
	|		ПО КонтрагентыИОрганизации.Ссылка = Контрагенты.Ссылка
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	РегистрацииВНалоговомОргане.Организация КАК Ссылка,
	|	МАКСИМУМ(РегистрацииВНалоговомОргане.Период) КАК Период
	|ПОМЕСТИТЬ ДатыАктуальностиКПП
	|ИЗ
	|	РегистрСведений.РегистрацииВНалоговомОргане КАК РегистрацииВНалоговомОргане
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ КонтрагентыИОрганизации_Предварительная КАК КонтрагентыИОрганизации
	|		ПО РегистрацииВНалоговомОргане.Организация = КонтрагентыИОрганизации.Ссылка
	|ГДЕ
	|	РегистрацииВНалоговомОргане.Подразделение = ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка)
	|	И РегистрацииВНалоговомОргане.Период <= &ДатаАктуальностиСведений
	|
	|СГРУППИРОВАТЬ ПО
	|	РегистрацииВНалоговомОргане.Организация
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	КонтрагентыИсторияКПП.Ссылка,
	|	МАКСИМУМ(КонтрагентыИсторияКПП.Период)
	|ИЗ
	|	Справочник.Контрагенты.ИсторияКПП КАК КонтрагентыИсторияКПП
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ КонтрагентыИОрганизации_Предварительная КАК КонтрагентыИОрганизации
	|		ПО КонтрагентыИсторияКПП.Ссылка = КонтрагентыИОрганизации.Ссылка
	|ГДЕ
	|	КонтрагентыИсторияКПП.Период <= &ДатаАктуальностиСведений
	|
	|СГРУППИРОВАТЬ ПО
	|	КонтрагентыИсторияКПП.Ссылка
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ДатыАктуальностиКПП.Ссылка КАК Ссылка,
	|	РегистрацииВНалоговомОргане.РегистрацияВНалоговомОргане.КПП КАК КПП
	|ПОМЕСТИТЬ КППСУчетомИстории
	|ИЗ
	|	РегистрСведений.РегистрацииВНалоговомОргане КАК РегистрацииВНалоговомОргане
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ДатыАктуальностиКПП КАК ДатыАктуальностиКПП
	|		ПО РегистрацииВНалоговомОргане.Организация = ДатыАктуальностиКПП.Ссылка
	|			И РегистрацииВНалоговомОргане.Период = ДатыАктуальностиКПП.Период
	|ГДЕ
	|	ДатыАктуальностиКПП.Ссылка ССЫЛКА Справочник.Организации
	|	И РегистрацииВНалоговомОргане.Подразделение = ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка)
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ДатыАктуальностиКПП.Ссылка,
	|	КонтрагентыИсторияКПП.КПП
	|ИЗ
	|	ДатыАктуальностиКПП КАК ДатыАктуальностиКПП
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Контрагенты.ИсторияКПП КАК КонтрагентыИсторияКПП
	|		ПО ДатыАктуальностиКПП.Ссылка = КонтрагентыИсторияКПП.Ссылка
	|			И ДатыАктуальностиКПП.Период = КонтрагентыИсторияКПП.Период
	|ГДЕ
	|	ДатыАктуальностиКПП.Ссылка ССЫЛКА Справочник.Контрагенты
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	Контрагенты.Ссылка КАК Ссылка,
	|	Контрагенты.ОбособленноеПодразделение КАК ОбособленноеПодразделение,
	|	Контрагенты.ГоловнойКонтрагент КАК ГоловнойКонтрагент,
	|	Контрагенты.СтранаРегистрации КАК СтранаРегистрации,
	|	Контрагенты.СтранаРегистрации.Код КАК КодСтраныРегистрации,
	|	Контрагенты.ЮридическоеФизическоеЛицо КАК ЮридическоеФизическоеЛицо,
	|	Контрагенты.ИНН КАК ИНН,
	|	ЕСТЬNULL(КППСУчетомИстории.КПП, Контрагенты.КПП) КАК КПП,
	|	ЕСТЬNULL(НаименованияПоИстории.НаименованиеМеждународное, Контрагенты.НаименованиеМеждународное) КАК НаименованиеМеждународное,
	|	ЕСТЬNULL(НаименованияПоИстории.НаименованиеПолное, Контрагенты.НаименованиеПолное) КАК НаименованиеПолное,
	|	Контрагенты.РегистрационныйНомер КАК РегистрационныйНомер,
	|	Контрагенты.НалоговыйНомер КАК НалоговыйНомер,
	|	ВЫРАЗИТЬ(ЕСТЬNULL(ЮридическиеАдреса.ЮридическийАдрес, """") КАК СТРОКА(1000)) КАК ЮридическийАдрес,
	|	ВЫРАЗИТЬ(ЕСТЬNULL(ЮридическиеАдреса.ЮридическийАдресЗначение, """") КАК СТРОКА(1000)) КАК ЮридическийАдресЗначение
	|ПОМЕСТИТЬ КонтрагентыИОрганизации
	|ИЗ
	|	КонтрагентыИОрганизации_Предварительная КАК Контрагенты
	|		ЛЕВОЕ СОЕДИНЕНИЕ НаименованияПоИстории КАК НаименованияПоИстории
	|		ПО Контрагенты.Ссылка = НаименованияПоИстории.Ссылка
	|		ЛЕВОЕ СОЕДИНЕНИЕ ЮридическиеАдреса КАК ЮридическиеАдреса
	|		ПО Контрагенты.Ссылка = ЮридическиеАдреса.Ссылка
	|		ЛЕВОЕ СОЕДИНЕНИЕ КППСУчетомИстории КАК КППСУчетомИстории
	|		ПО Контрагенты.Ссылка = КППСУчетомИстории.Ссылка
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Ссылка
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ДатыАктуальностиНаименованийОрганизаций
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ДатыАктуальностиАдресов
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ КонтрагентыИОрганизации_Предварительная
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ НаименованияПоИстории
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ЮридическиеАдреса
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ДатыАктуальностиКПП
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	КонтролируемаяСделка.Номер КАК НомерЛиста1А,
	|	КонтролируемаяСделка.УведомлениеОКонтролируемойСделке КАК УведомлениеОКонтролируемойСделке,
	|	КонтролируемаяСделка.Ссылка КАК Сделка,
	|	КонтролируемаяСделка.ТипСделки КАК ТипСделки,
	|	ВЫБОР
	|		КОГДА КонтролируемаяСделка.ТипВзаимозависимости = ЗНАЧЕНИЕ(Перечисление.ТипыВзаимозависимости.ВзаимозависимыПоКодексу)
	|			ТОГДА ""1""
	|		КОГДА КонтролируемаяСделка.ТипВзаимозависимости = ЗНАЧЕНИЕ(Перечисление.ТипыВзаимозависимости.СамостоятельноеПризнаниеВзаимозависимости)
	|			ТОГДА ""2""
	|		КОГДА КонтролируемаяСделка.ТипВзаимозависимости = ЗНАЧЕНИЕ(Перечисление.ТипыВзаимозависимости.ВзаимозависимостьПоРешениюСуда)
	|			ТОГДА ""3""
	|		ИНАЧЕ ""0""
	|	КОНЕЦ КАК Строка100Взаимозависимость,
	|	ВЫБОР
	|		КОГДА КонтролируемаяСделка.Строка121СтороныВзаимозависимыПоКодексу
	|			ТОГДА ""1""
	|		ИНАЧЕ ""0""
	|	КОНЕЦ КАК Строка121СтороныВзаимозависимыПоКодексу,
	|	ВЫБОР
	|		КОГДА КонтролируемаяСделка.Строка122СделкаВОбластиВнешнейТорговли
	|			ТОГДА ""1""
	|		ИНАЧЕ ""0""
	|	КОНЕЦ КАК Строка122СделкаВОбластиВнешнейТорговли,
	|	ВЫБОР
	|		КОГДА КонтролируемаяСделка.Строка123СделкаСКонтрагентомСЛьготнымНалогообложением
	|			ТОГДА ""1""
	|		ИНАЧЕ ""0""
	|	КОНЕЦ КАК Строка123СделкаСКонтрагентомСЛьготнымНалогообложением,
	|	ВЫБОР
	|		КОГДА КонтролируемаяСделка.Строка124СделкаСНезависимымПосредником
	|			ТОГДА ""1""
	|		ИНАЧЕ ""0""
	|	КОНЕЦ КАК Строка124СделкаСНезависимымПосредником,
	|	ВЫБОР
	|		КОГДА КонтролируемаяСделка.ОснованиеКонтролируемости131
	|			ТОГДА ""1""
	|		ИНАЧЕ ""0""
	|	КОНЕЦ КАК ОснованиеКонтролируемости131,
	|	ВЫБОР
	|		КОГДА КонтролируемаяСделка.ОснованиеКонтролируемости132
	|			ТОГДА ""1""
	|		ИНАЧЕ ""0""
	|	КОНЕЦ КАК ОснованиеКонтролируемости132,
	|	ВЫБОР
	|		КОГДА КонтролируемаяСделка.ОснованиеКонтролируемости133
	|			ТОГДА ""1""
	|		ИНАЧЕ ""0""
	|	КОНЕЦ КАК ОснованиеКонтролируемости133,
	|	ВЫБОР
	|		КОГДА КонтролируемаяСделка.ОснованиеКонтролируемости134
	|				ИЛИ КонтролируемаяСделка.ОснованиеКонтролируемости136
	|				ИЛИ КонтролируемаяСделка.ОснованиеКонтролируемости137
	|			ТОГДА ""1""
	|		ИНАЧЕ ""0""
	|	КОНЕЦ КАК ОснованиеКонтролируемости134,
	|	ВЫБОР
	|		КОГДА КонтролируемаяСделка.ОснованиеКонтролируемости135
	|				ИЛИ КонтролируемаяСделка.ОснованиеКонтролируемости138
	|			ТОГДА ""1""
	|		ИНАЧЕ ""0""
	|	КОНЕЦ КАК ОснованиеКонтролируемости135,
	|	КонтролируемаяСделка.КодНаименованияСделки КАК Строка210КодНаименованияСделки,
	|	КонтролируемаяСделка.КодСтороныСделки КАК Строка211КодСтороныСделки,
	|	КонтролируемаяСделка.СпособОпределенияЦеныСделки КАК СпособОпределенияЦеныСделки,
	|	ВЫБОР
	|		КОГДА КонтролируемаяСделка.СпособОпределенияЦеныСделки.ЦенаЯвляетсяРегулируемой
	|			ТОГДА ""1""
	|		ИНАЧЕ ""0""
	|	КОНЕЦ КАК Строка220ПризнакОпределенияЦеныСделки,
	|	ЕСТЬNULL(КонтролируемаяСделка.СпособОпределенияЦеныСделки.КомментарийКПризнакуОпределенияЦеныСделки, """") КАК Строка220_1Комментарий,
	|	ВЫБОР
	|		КОГДА ЕСТЬNULL(КонтролируемаяСделка.СпособОпределенияЦеныСделки.КодОпределенияЦеныСделки, """") = """"
	|			ТОГДА ""0""
	|		ИНАЧЕ КонтролируемаяСделка.СпособОпределенияЦеныСделки.КодОпределенияЦеныСделки
	|	КОНЕЦ КАК Строка230КодОпределенияЦены,
	|	ЕСТЬNULL(КонтролируемаяСделка.СпособОпределенияЦеныСделки.КомментарийККодуОпределенияЦеныСделки, """") КАК Строка230_1Комментарий,
	|	ЕСТЬNULL(КонтролируемаяСделка.СпособОпределенияЦеныСделки.КодМетодаЦенообразования, """") КАК Строка240КодМетодовЦенообразования,
	|	ЕСТЬNULL(КонтролируемаяСделка.СпособОпределенияЦеныСделки.КомментарийКМетодуЦенообразования, """") КАК Строка240_1Комментарий,
	|	ВЫБОР
	|		КОГДА ЕСТЬNULL(КонтролируемаяСделка.СпособОпределенияЦеныСделки.ИсточникИнформации251, ЛОЖЬ)
	|			ТОГДА ""1""
	|		ИНАЧЕ ""0""
	|	КОНЕЦ КАК Строка251,
	|	ВЫБОР
	|		КОГДА ЕСТЬNULL(КонтролируемаяСделка.СпособОпределенияЦеныСделки.ИсточникИнформации252, ЛОЖЬ)
	|			ТОГДА ""1""
	|		ИНАЧЕ ""0""
	|	КОНЕЦ КАК Строка252,
	|	ВЫБОР
	|		КОГДА ЕСТЬNULL(КонтролируемаяСделка.СпособОпределенияЦеныСделки.ИсточникИнформации253, ЛОЖЬ)
	|			ТОГДА ""1""
	|		ИНАЧЕ ""0""
	|	КОНЕЦ КАК Строка253,
	|	ВЫБОР
	|		КОГДА ЕСТЬNULL(КонтролируемаяСделка.СпособОпределенияЦеныСделки.ИсточникИнформации254, ЛОЖЬ)
	|			ТОГДА ""1""
	|		ИНАЧЕ ""0""
	|	КОНЕЦ КАК Строка254,
	|	ВЫБОР
	|		КОГДА ЕСТЬNULL(КонтролируемаяСделка.СпособОпределенияЦеныСделки.ИсточникИнформации255, ЛОЖЬ)
	|			ТОГДА ""1""
	|		ИНАЧЕ ""0""
	|	КОНЕЦ КАК Строка255,
	|	ВЫБОР
	|		КОГДА ЕСТЬNULL(КонтролируемаяСделка.СпособОпределенияЦеныСделки.ИсточникИнформации256, ЛОЖЬ)
	|			ТОГДА ""1""
	|		ИНАЧЕ ""0""
	|	КОНЕЦ КАК Строка256,
	|	ВЫБОР
	|		КОГДА ЕСТЬNULL(КонтролируемаяСделка.СпособОпределенияЦеныСделки.ИсточникИнформации257, ЛОЖЬ)
	|			ТОГДА ""1""
	|		ИНАЧЕ ""0""
	|	КОНЕЦ КАК Строка257,
	|	ВЫБОР
	|		КОГДА ЕСТЬNULL(КонтролируемаяСделка.СпособОпределенияЦеныСделки.ИсточникИнформации258, ЛОЖЬ)
	|			ТОГДА ""1""
	|		ИНАЧЕ ""0""
	|	КОНЕЦ КАК Строка258,
	|	ВЫБОР
	|		КОГДА ЕСТЬNULL(КонтролируемаяСделка.СпособОпределенияЦеныСделки.ИсточникИнформации259, ЛОЖЬ)
	|			ТОГДА ""1""
	|		ИНАЧЕ ""0""
	|	КОНЕЦ КАК Строка259,
	|	2 КАК Строка260КоличествоУчастниковСделки,
	|	КонтролируемаяСделка.КомментарийКПункту7 КАК Строка260_1Комментарий,
	|	ВЫРАЗИТЬ(КонтролируемаяСделка.СуммаДоходов КАК ЧИСЛО(15, 0)) КАК Строка300СуммаДоходов,
	|	ВЫРАЗИТЬ(КонтролируемаяСделка.СуммаДоходовРегулируемых КАК ЧИСЛО(15, 0)) КАК Строка301СуммаРегулируемыхДоходов,
	|	ВЫРАЗИТЬ(КонтролируемаяСделка.СуммаРасходов КАК ЧИСЛО(15, 0)) КАК Строка310СуммаРасходов,
	|	ВЫРАЗИТЬ(КонтролируемаяСделка.СуммаРасходовРегулируемых КАК ЧИСЛО(15, 0)) КАК Строка311СуммаРегулируемыхРасходов,
	|	ВЫБОР
	|		КОГДА Контрагенты.ОбособленноеПодразделение
	|				И Контрагенты.ГоловнойКонтрагент.СтранаРегистрации <> ЗНАЧЕНИЕ(Справочник.СтраныМира.Россия)
	|			ТОГДА Контрагенты.Ссылка
	|		ИНАЧЕ Контрагенты.ГоловнойКонтрагент
	|	КОНЕЦ КАК Контрагент,
	|	Контрагенты.СтранаРегистрации <> ЗНАЧЕНИЕ(Справочник.СтраныМира.Россия) КАК ВнешнеторговаяСделка,
	|	Контрагенты.ЮридическоеФизическоеЛицо КАК ТипКонтрагента,
	|	КонтролируемаяСделка.Договор КАК Договор,
	|	КонтролируемаяСделка.ТипПредметаСделки КАК ТипПредметаСделки,
	|	КонтролируемаяСделка.НаименованиеПредметаСделки КАК НаименованиеПредметаСделки,
	|	ЕСТЬNULL(КонтролируемаяСделка.КодТНВЭД.Код, """") КАК КодТНВЭД,
	|	ЕСТЬNULL(КонтролируемаяСделка.КодОКП.Код, """") КАК КодОКП,
	|	ЕСТЬNULL(КонтролируемаяСделка.КодОКВЭД.Код, """") КАК КодОКВЭД,
	|	ЕСТЬNULL(КонтролируемаяСделка.КодОКПД2.Код, """") КАК КодОКПД2,
	|	КонтролируемаяСделка.КодОКВЭД2 КАК КодОКВЭД2,
	|	КонтролируемаяСделка.НомерДоговора КАК НомерДоговора,
	|	КонтролируемаяСделка.ДатаДоговора КАК ДатаДоговора,
	|	ВЫБОР
	|		КОГДА КонтролируемаяСделка.ТипПредметаСделки = ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.Товар)
	|				И КонтролируемаяСделка.СтранаПроисхожденияПредметаСделки = ЗНАЧЕНИЕ(Справочник.СтраныМира.ПустаяСсылка)
	|			ТОГДА ЗНАЧЕНИЕ(Справочник.СтраныМира.Россия)
	|		ИНАЧЕ КонтролируемаяСделка.СтранаПроисхожденияПредметаСделки
	|	КОНЕЦ КАК СтранаПроисхожденияПредметаСделки,
	|	ЛОЖЬ КАК СделкаСовершенаЧерезКомиссионера,
	|	""0"" КАК СделкаСовАгент,
	|	ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка) КАК Комиссионер,
	|	ЗНАЧЕНИЕ(Перечисление.ЮридическоеФизическоеЛицо.ПустаяСсылка) КАК ТипКомиссионера,
	|	ЛОЖЬ КАК УказыватьСведенияЦепочкиСозданияСтоимости
	|ПОМЕСТИТЬ Листы1А
	|ИЗ
	|	Документ.КонтролируемаяСделка КАК КонтролируемаяСделка
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ КонтрагентыИОрганизации КАК Контрагенты
	|		ПО КонтролируемаяСделка.Контрагент = Контрагенты.Ссылка
	|ГДЕ
	|	КонтролируемаяСделка.УведомлениеОКонтролируемойСделке = &УведомлениеОКонтролируемойСделке
	|	И НЕ КонтролируемаяСделка.ПометкаУдаления
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Сделка
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	КонтролируемаяСделкаСделки.Ссылка КАК Сделка,
	|	Листы1А.НомерЛиста1А КАК НомерЛиста1А,
	|	КонтролируемаяСделкаСделки.НомерСтроки КАК НомерСтроки,
	|	Листы1А.ТипПредметаСделки КАК ТипПредметаСделки,
	|	ВЫБОР
	|		КОГДА Листы1А.ТипПредметаСделки = ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.Товар)
	|			ТОГДА 1
	|		КОГДА Листы1А.ТипПредметаСделки = ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.РаботаУслуга)
	|			ТОГДА 2
	|		КОГДА Листы1А.ТипПредметаСделки = ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.ИнойОбъектГражданскихПрав)
	|				ИЛИ Листы1А.ТипПредметаСделки = ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.ДолговоеОбязательство)
	|			ТОГДА 3
	|	КОНЕЦ КАК Строка020ТипПредмета,
	|	Листы1А.ТипСделки КАК ТипСделки,
	|	Листы1А.НаименованиеПредметаСделки КАК Строка030НаименованиеПредмета,
	|	Листы1А.КодТНВЭД КАК Строка040КодПоТНВЭД,
	|	Листы1А.КодОКП КАК Строка043КодПоОКП,
	|	Листы1А.КодОКВЭД КАК Строка045КодОКВЭД,
	|	Листы1А.КодОКПД2 КАК Строка043КодПоОКПД2,
	|	Листы1А.КодОКВЭД2 КАК Строка045КодОКВЭД2,
	|	Листы1А.Контрагент КАК Контрагент,
	|	Листы1А.Договор КАК Договор,
	|	Листы1А.НомерДоговора КАК Строка060НомерДоговора,
	|	Листы1А.ДатаДоговора КАК Строка065ДатаДоговора,
	|	"""" КАК УникальныйНомерВалютногоКонтроля,
	|	ЕСТЬNULL(Листы1А.СтранаПроисхожденияПредметаСделки.Код, """") КАК Строка070КодСтраныПроисхождения,
	|	ЕСТЬNULL(КонтролируемаяСделкаСделки.СтранаОтправкиТовара.Код, """") КАК Строка080КодСтраныОтправки,
	|	КонтролируемаяСделкаСделки.КодРегионаОтправкиТовара КАК Строка080КодРегионаОтправки,
	|	КонтролируемаяСделкаСделки.ГородОтправкиТовара КАК Строка080ГородОтправки,
	|	КонтролируемаяСделкаСделки.НаселенныйПунктОтправкиТовара КАК Строка080НаселенныйПунктОтправки,
	|	ЕСТЬNULL(КонтролируемаяСделкаСделки.СтранаСовершенияСделки.Код, """") КАК Строка090КодСтраныСовершенияСделки,
	|	КонтролируемаяСделкаСделки.КодРегионаСовершенияСделки КАК Строка090КодРегионаСовершенияСделки,
	|	КонтролируемаяСделкаСделки.ГородСовершенияСделки КАК Строка090ГородСовершенияСделки,
	|	КонтролируемаяСделкаСделки.НаселенныйПунктСовершенияСделки КАК Строка090НаселенныйПунктСовершенияСделки,
	|	"""" КАК ОКТМОСовершенияСделки,
	|	КонтролируемаяСделкаСделки.КодУсловийПоставки КАК Строка100КодУсловийПоставки,
	|	ЕСТЬNULL(КонтролируемаяСделкаСделки.ЕдиницаИзмерения.Код, """") КАК Строка110КодЕдиницыИзмерения,
	|	ВЫБОР
	|		КОГДА КонтролируемаяСделкаСделки.Количество > 0
	|				И КонтролируемаяСделкаСделки.Количество < 1
	|			ТОГДА 1
	|		ИНАЧЕ ВЫРАЗИТЬ(КонтролируемаяСделкаСделки.Количество КАК ЧИСЛО(15, 0))
	|	КОНЕЦ КАК Строка120Количество,
	|	ВЫРАЗИТЬ(КонтролируемаяСделкаСделки.Цена КАК ЧИСЛО(15, 0)) КАК Строка130Цена,
	|	0 КАК СуммаБазыДляРасчетаРоялти,
	|	ВЫРАЗИТЬ(КонтролируемаяСделкаСделки.Стоимость КАК ЧИСЛО(15, 0)) КАК Строка140Стоимость,
	|	КонтролируемаяСделкаСделки.ДатаСовершенияСделки КАК Строка150ДатаСовершения,
	|	Листы1А.ТипКонтрагента КАК ТипКонтрагента,
	|	Листы1А.ВнешнеторговаяСделка КАК ВнешнеторговаяСделка,
	|	Листы1А.СделкаСовершенаЧерезКомиссионера КАК СделкаСовершенаЧерезКомиссионера,
	|	Листы1А.Комиссионер КАК Комиссионер,
	|	Листы1А.ТипКомиссионера КАК ТипКомиссионера,
	|	КонтролируемаяСделкаСделки.ИдентификаторЛиста1Б КАК ИдентификаторЛиста1Б,
	|	Листы1А.УказыватьСведенияЦепочкиСозданияСтоимости КАК УказыватьСведенияЦепочкиСозданияСтоимости
	|ПОМЕСТИТЬ Листы1Б
	|ИЗ
	|	Листы1А КАК Листы1А
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.КонтролируемаяСделка.Сделки КАК КонтролируемаяСделкаСделки
	|		ПО Листы1А.Сделка = КонтролируемаяСделкаСделки.Ссылка
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Сделка
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	КонтролируемаяСделкаЛисты1В.Ссылка КАК Сделка,
	|	Листы1А.НомерЛиста1А КАК НомерЛиста1А,
	|	КонтролируемаяСделкаЛисты1В.НомерСтроки КАК НомерСтроки,
	|	ЕСТЬNULL(КонтролируемаяСделкаЛисты1Б.НомерСтроки, 0) КАК НомерСтроки1Б,
	|	КонтролируемаяСделкаЛисты1В.ИдентификаторЛиста1Б КАК ИдентификаторЛиста1Б,
	|	КонтролируемаяСделкаЛисты1В.ИдентификаторЛиста1В КАК ИдентификаторЛиста1В,
	|	КонтролируемаяСделкаЛисты1В.ТипЛиста КАК ТипЛиста,
	|	ВЫБОР
	|		КОГДА КонтролируемаяСделкаЛисты1В.ТипЛиста = ЗНАЧЕНИЕ(Перечисление.ТипыСделокВЦепочкеКонтролируемыхСделок.ПоследующаяРеализация)
	|			ТОГДА ""1""
	|		ИНАЧЕ ""2""
	|	КОНЕЦ КАК КодТипаСделки,
	|	КонтролируемаяСделкаЛисты1В.ДатаСовершенияСделки КАК ДатаСовершенияСделки,
	|	КонтролируемаяСделкаЛисты1В.КомментарийКЛисту1Б КАК КомментарийКЛисту1Б,
	|	КонтролируемаяСделкаЛисты1В.ПризнакУчастникаСделки КАК ПризнакУчастникаСделки,
	|	КонтролируемаяСделкаЛисты1В.ИдентификаторПредыдущегоЛиста1В КАК ИдентификаторПредыдущегоЛиста1В,
	|	КонтролируемаяСделкаЛисты1В.ИспользованиеПроисхождениеТовара КАК ИспользованиеПроисхождениеТовара,
	|	ВЫБОР
	|		КОГДА КонтролируемаяСделкаЛисты1В.ИспользованиеПроисхождениеТовара = ЗНАЧЕНИЕ(Перечисление.ТипыИспользованияПроисхожденияТовараКонтролируемыхСделок.Иное)
	|			ТОГДА КонтролируемаяСделкаЛисты1В.НаименованиеИспользованияПроисхожденияТовара
	|		ИНАЧЕ """"
	|	КОНЕЦ КАК НаименованиеИспользованияПроисхожденияТовара,
	|	КонтролируемаяСделкаЛисты1В.Контрагент КАК Контрагент,
	|	ВЫБОР
	|		КОГДА КонтролируемаяСделкаЛисты1В.УчастникиВзаимозависимы
	|			ТОГДА ""1""
	|		ИНАЧЕ ""0""
	|	КОНЕЦ КАК УчастникиВзаимозависимы,
	|	КонтролируемаяСделкаЛисты1В.НомерДоговора КАК НомерДоговора,
	|	КонтролируемаяСделкаЛисты1В.ДатаДоговора КАК ДатаДоговора,
	|	КонтролируемаяСделкаЛисты1В.КодУсловийПоставки КАК КодУсловийПоставки,
	|	КонтролируемаяСделкаЛисты1В.ОКТМОСовершенияСделки КАК ОКТМОСовершенияСделки,
	|	КонтролируемаяСделкаЛисты1В.СтранаСовершенияСделки КАК СтранаСовершенияСделки,
	|	ЕСТЬNULL(КонтролируемаяСделкаЛисты1В.СтранаСовершенияСделки.Код, """") КАК КодСтраныСовершенияСделки,
	|	КонтролируемаяСделкаЛисты1В.ЕдиницаИзмерения КАК ЕдиницаИзмерения,
	|	ЕСТЬNULL(КонтролируемаяСделкаЛисты1В.ЕдиницаИзмерения.Код, """") КАК КодЕдиницыИзмерения,
	|	КонтролируемаяСделкаЛисты1В.Количество КАК Количество,
	|	КонтролируемаяСделкаЛисты1В.Цена КАК Цена,
	|	КонтролируемаяСделкаЛисты1В.Валюта КАК Валюта,
	|	ЕСТЬNULL(КонтролируемаяСделкаЛисты1В.Валюта.Код, """") КАК КодВалюты,
	|	ВЫРАЗИТЬ(КонтролируемаяСделкаЛисты1В.Стоимость КАК ЧИСЛО(15, 0)) КАК Стоимость
	|ПОМЕСТИТЬ Листы1В
	|ИЗ
	|	Листы1А КАК Листы1А
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.КонтролируемаяСделка.Листы1В КАК КонтролируемаяСделкаЛисты1В
	|		ПО Листы1А.Сделка = КонтролируемаяСделкаЛисты1В.Ссылка
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.КонтролируемаяСделка.Сделки КАК КонтролируемаяСделкаЛисты1Б
	|		ПО Листы1А.Сделка = КонтролируемаяСделкаЛисты1Б.Ссылка
	|			И (КонтролируемаяСделкаЛисты1Б.ИдентификаторЛиста1Б = КонтролируемаяСделкаЛисты1В.ИдентификаторЛиста1Б)
	|			И (КонтролируемаяСделкаЛисты1В.ИдентификаторЛиста1Б <> &ПустойИдентификатор)
	|ГДЕ
	|	Листы1А.УказыватьСведенияЦепочкиСозданияСтоимости
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Сделка
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Листы1Б.Сделка КАК Сделка,
	|	Листы1Б.НомерСтроки КАК НомерСтроки,
	|	КонтролируемаяСделкаСвязьЛистов1Би1В.ИдентификаторЛиста1Б КАК ИдентификаторЛиста1Б,
	|	КонтролируемаяСделкаСвязьЛистов1Би1В.ИдентификаторЛиста1В КАК ИдентификаторЛиста1В
	|ПОМЕСТИТЬ СвязиЛистов1Би1В
	|ИЗ
	|	Листы1Б КАК Листы1Б
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.КонтролируемаяСделка.СвязьЛистов1Би1В КАК КонтролируемаяСделкаСвязьЛистов1Би1В
	|		ПО Листы1Б.Сделка = КонтролируемаяСделкаСвязьЛистов1Би1В.Ссылка
	|			И Листы1Б.ИдентификаторЛиста1Б = КонтролируемаяСделкаСвязьЛистов1Би1В.ИдентификаторЛиста1Б
	|ГДЕ
	|	Листы1Б.УказыватьСведенияЦепочкиСозданияСтоимости
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	КонтролируемаяСделкаЛисты1Г.Ссылка КАК Сделка,
	|	Листы1А.НомерЛиста1А КАК НомерЛиста1А,
	|	КонтролируемаяСделкаЛисты1Г.НомерСтроки КАК НомерСтроки,
	|	КонтролируемаяСделкаЛисты1Г.ИдентификаторЛиста1Б КАК ИдентификаторЛиста1Б,
	|	КонтролируемаяСделкаЛисты1Г.НаименованиеУслуги КАК НаименованиеУслуги,
	|	ВЫБОР
	|		КОГДА КонтролируемаяСделкаЛисты1Г.УчастникиВзаимозависимы
	|			ТОГДА ""1""
	|		ИНАЧЕ ""0""
	|	КОНЕЦ КАК УчастникиВзаимозависимы,
	|	КонтролируемаяСделкаЛисты1Г.Контрагент КАК Контрагент,
	|	ВЫБОР
	|		КОГДА Контрагенты.ЮридическоеФизическоеЛицо = ЗНАЧЕНИЕ(Перечисление.ЮридическоеФизическоеЛицо.ФизическоеЛицо)
	|			ТОГДА 1
	|		ИНАЧЕ 2
	|	КОНЕЦ КАК ТипОрганизации,
	|	ВЫБОР
	|		КОГДА ГоловныеКонтрагенты.КодСтраныРегистрации ЕСТЬ NULL
	|			ТОГДА """"
	|		ИНАЧЕ ГоловныеКонтрагенты.КодСтраныРегистрации
	|	КОНЕЦ КАК КодСтраныРегистрации,
	|	ВЫБОР
	|		КОГДА Контрагенты.НаименованиеМеждународное <> """"
	|			ТОГДА Контрагенты.НаименованиеМеждународное
	|		КОГДА Контрагенты.НаименованиеПолное <> """"
	|			ТОГДА Контрагенты.НаименованиеПолное
	|		ИНАЧЕ ВЫРАЗИТЬ(ГоловныеКонтрагенты.НаименованиеПолное КАК СТРОКА(1000))
	|	КОНЕЦ КАК НаименованиеКонтрагента,
	|	ВЫБОР
	|		КОГДА ГоловныеКонтрагенты.СтранаРегистрации = ЗНАЧЕНИЕ(Справочник.СтраныМира.Россия)
	|			ТОГДА ГоловныеКонтрагенты.ИНН
	|		ИНАЧЕ ГоловныеКонтрагенты.РегистрационныйНомер
	|	КОНЕЦ КАК РегистрационныйНомер,
	|	КонтролируемаяСделкаЛисты1Г.Валюта КАК Валюта,
	|	ЕСТЬNULL(КонтролируемаяСделкаЛисты1Г.Валюта.Код, """") КАК КодВалюты,
	|	КонтролируемаяСделкаЛисты1Г.Стоимость КАК Стоимость
	|ПОМЕСТИТЬ Листы1Г
	|ИЗ
	|	Листы1А КАК Листы1А
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.КонтролируемаяСделка.Листы1Г КАК КонтролируемаяСделкаЛисты1Г
	|		ПО Листы1А.Сделка = КонтролируемаяСделкаЛисты1Г.Ссылка
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ КонтрагентыИОрганизации КАК Контрагенты
	|		ПО (КонтролируемаяСделкаЛисты1Г.Контрагент = Контрагенты.Ссылка)
	|		ЛЕВОЕ СОЕДИНЕНИЕ КонтрагентыИОрганизации КАК ГоловныеКонтрагенты
	|		ПО (ГоловныеКонтрагенты.Ссылка = Контрагенты.ГоловнойКонтрагент)
	|ГДЕ
	|	Листы1А.УказыватьСведенияЦепочкиСозданияСтоимости
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Сделка
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	Контрагенты.Ссылка КАК Ссылка,
	|	ГоловныеКонтрагенты.Ссылка КАК ГоловнойКонтрагент,
	|	Контрагенты.ЮридическоеФизическоеЛицо КАК ЮридическоеФизическоеЛицо,
	|	Контрагенты.НаименованиеМеждународное КАК НаименованиеВЛатинскойТранскрипции,
	|	Контрагенты.ИНН КАК ИНН,
	|	Контрагенты.КПП КАК КПП,
	|	ГоловныеКонтрагенты.КПП КАК ГоловнойКонтрагентКПП,
	|	ВЫРАЗИТЬ(ГоловныеКонтрагенты.НаименованиеПолное КАК СТРОКА(1000)) КАК НаименованиеПолное,
	|	ГоловныеКонтрагенты.РегистрационныйНомер КАК РегистрационныйНомер,
	|	ГоловныеКонтрагенты.НалоговыйНомер КАК НалоговыйНомер,
	|	ВЫБОР
	|		КОГДА ГоловныеКонтрагенты.СтранаРегистрации = ЗНАЧЕНИЕ(Справочник.СтраныМира.ПустаяСсылка)
	|			ТОГДА ЗНАЧЕНИЕ(Справочник.СтраныМира.Россия)
	|		ИНАЧЕ ГоловныеКонтрагенты.СтранаРегистрации
	|	КОНЕЦ КАК СтранаРегистрации,
	|	Контрагенты.ЮридическийАдрес КАК ЮридическийАдрес,
	|	Контрагенты.ЮридическийАдресЗначение КАК ЮридическийАдресЗначение
	|ПОМЕСТИТЬ КонтагентыКонтролируемыхСделок
	|ИЗ
	|	Листы1А КАК Листы1А
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ КонтрагентыИОрганизации КАК Контрагенты
	|		ПО Листы1А.Контрагент = Контрагенты.Ссылка
	|		ЛЕВОЕ СОЕДИНЕНИЕ КонтрагентыИОрганизации КАК ГоловныеКонтрагенты
	|		ПО (ГоловныеКонтрагенты.Ссылка = Контрагенты.ГоловнойКонтрагент)
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Ссылка,
	|	ЮридическоеФизическоеЛицо
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Контрагенты.Ссылка КАК Контрагент,
	|	ВЫБОР
	|		КОГДА Контрагенты.СтранаРегистрации = ЗНАЧЕНИЕ(Справочник.СтраныМира.Россия)
	|			ТОГДА 1
	|		ИНАЧЕ 2
	|	КОНЕЦ КАК Строка020ТипОрганизации,
	|	ВЫБОР
	|		КОГДА Контрагенты.СтранаРегистрации.Код ЕСТЬ NULL
	|			ТОГДА """"
	|		ИНАЧЕ Контрагенты.СтранаРегистрации.Код
	|	КОНЕЦ КАК Строка030КакКодСтраныРегистрации,
	|	Контрагенты.НаименованиеПолное КАК Строка040Наименование,
	|	Контрагенты.НаименованиеВЛатинскойТранскрипции КАК Строка040НаименованиеЛат,
	|	Контрагенты.ИНН КАК Строка050ИНН,
	|	ВЫБОР
	|		КОГДА Контрагенты.СтранаРегистрации = ЗНАЧЕНИЕ(Справочник.СтраныМира.Россия)
	|			ТОГДА Контрагенты.ГоловнойКонтрагентКПП
	|		ИНАЧЕ Контрагенты.КПП
	|	КОНЕЦ КАК Строка060КПП,
	|	ВЫБОР
	|		КОГДА Контрагенты.СтранаРегистрации = ЗНАЧЕНИЕ(Справочник.СтраныМира.Россия)
	|			ТОГДА """"
	|		ИНАЧЕ Контрагенты.РегистрационныйНомер
	|	КОНЕЦ КАК Строка070РегНомерВСтрокеРегистрации,
	|	ВЫБОР
	|		КОГДА Контрагенты.СтранаРегистрации = ЗНАЧЕНИЕ(Справочник.СтраныМира.Россия)
	|			ТОГДА """"
	|		ИНАЧЕ ВЫБОР
	|				КОГДА УчастникиКонтролируемыхСделок.ТипВыводимогоНомера = 1
	|					ТОГДА Контрагенты.НалоговыйНомер
	|				КОГДА УчастникиКонтролируемыхСделок.ТипВыводимогоНомера = 2
	|					ТОГДА Контрагенты.РегистрационныйНомер
	|				ИНАЧЕ ВЫБОР
	|						КОГДА Контрагенты.НалоговыйНомер <> """"
	|							ТОГДА ГоловныеКонтрагенты.НалоговыйНомер
	|						ИНАЧЕ Контрагенты.РегистрационныйНомер
	|					КОНЕЦ
	|			КОНЕЦ
	|	КОНЕЦ КАК НалоговыйРегистрационныйНомер,
	|	ВЫБОР
	|		КОГДА ГоловныеКонтрагенты.СтранаРегистрации = ЗНАЧЕНИЕ(Справочник.СтраныМира.Россия)
	|			ТОГДА """"
	|		ИНАЧЕ УчастникиКонтролируемыхСделок.НаименованиеИдентификатораРегистрационногоНомера
	|	КОНЕЦ КАК НаименованиеИдентификатораРегистрационногоНомера,
	|	ВЫБОР
	|		КОГДА ГоловныеКонтрагенты.СтранаРегистрации = ЗНАЧЕНИЕ(Справочник.СтраныМира.Россия)
	|			ТОГДА """"
	|		ИНАЧЕ ГоловныеКонтрагенты.НалоговыйНомер
	|	КОНЕЦ КАК Строка080КодНалогВСтранеРегистрации,
	|	ЕСТЬNULL(Контрагенты.ЮридическийАдрес, """") КАК Строка090АдресИностраннойОрганизации,
	|	ВЫБОР
	|		КОГДА ГоловныеКонтрагенты.СтранаРегистрации = ЗНАЧЕНИЕ(Справочник.СтраныМира.Россия)
	|			ТОГДА """"
	|		ИНАЧЕ ЕСТЬNULL(Контрагенты.ЮридическийАдресЗначение, """")
	|	КОНЕЦ КАК АдресИностраннойОрганизацииЗначение
	|ПОМЕСТИТЬ Раздел2
	|ИЗ
	|	КонтагентыКонтролируемыхСделок КАК Контрагенты
	|		ЛЕВОЕ СОЕДИНЕНИЕ КонтрагентыИОрганизации КАК ГоловныеКонтрагенты
	|		ПО (ГоловныеКонтрагенты.Ссылка = Контрагенты.ГоловнойКонтрагент)
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ДанныеПоКонтрагентамКонтролируемыхСделок КАК УчастникиКонтролируемыхСделок
	|		ПО Контрагенты.ГоловнойКонтрагент = УчастникиКонтролируемыхСделок.Контрагент
	|ГДЕ
	|	Контрагенты.ЮридическоеФизическоеЛицо = ЗНАЧЕНИЕ(Перечисление.ЮридическоеФизическоеЛицо.ЮридическоеЛицо)
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ДокументыФизическихЛицСрезПоследних.Физлицо КАК Физлицо,
	|	ДокументыФизическихЛицСрезПоследних.Период КАК Период,
	|	МАКСИМУМ(ДокументыФизическихЛицСрезПоследних.ВидДокумента) КАК ВидДокумента
	|ПОМЕСТИТЬ ВидыДокументовФизическихЛиц
	|ИЗ
	|	РегистрСведений.ДокументыФизическихЛиц.СрезПоследних(
	|			&ДатаАктуальностиСведений,
	|			Физлицо В
	|				(ВЫБРАТЬ
	|					УчастникиСделок.ФизическоеЛицо
	|				ИЗ
	|					РегистрСведений.ДанныеПоКонтрагентамКонтролируемыхСделок КАК УчастникиСделок)) КАК ДокументыФизическихЛицСрезПоследних
	|
	|СГРУППИРОВАТЬ ПО
	|	ДокументыФизическихЛицСрезПоследних.Физлицо,
	|	ДокументыФизическихЛицСрезПоследних.Период
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Физлицо,
	|	Период,
	|	ВидДокумента
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ГражданствоФизическихЛицСрезПоследних.ФизическоеЛицо КАК ФизическоеЛицо,
	|	ГражданствоФизическихЛицСрезПоследних.Страна КАК Страна
	|ПОМЕСТИТЬ ГражданствоФизическихЛиц
	|ИЗ
	|	РегистрСведений.ГражданствоФизическихЛиц.СрезПоследних(
	|			&ДатаАктуальностиСведений,
	|			ФизическоеЛицо В
	|				(ВЫБРАТЬ
	|					УчастникиСделок.ФизическоеЛицо
	|				ИЗ
	|					РегистрСведений.ДанныеПоКонтрагентамКонтролируемыхСделок КАК УчастникиСделок)) КАК ГражданствоФизическихЛицСрезПоследних
	|
	|СГРУППИРОВАТЬ ПО
	|	ГражданствоФизическихЛицСрезПоследних.ФизическоеЛицо,
	|	ГражданствоФизическихЛицСрезПоследних.Страна
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	ФизическоеЛицо
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Контрагенты.Ссылка КАК Контрагент,
	|	ЕСТЬNULL(УчастникиКонтролируемыхСделок.КодВидаДеятельностиФизическогоЛица, """") КАК Строка020КодВидаДеятельности,
	|	Контрагенты.ИНН КАК Строка030ИНН,
	|	ЕСТЬNULL(УчастникиКонтролируемыхСделок.ФизическоеЛицо, ЗНАЧЕНИЕ(Справочник.ФизическиеЛица.ПустаяСсылка)) КАК ФизическоеЛицо,
	|	ЕСТЬNULL(УчастникиКонтролируемыхСделок.ФизическоеЛицо.ДатаРождения, ДАТАВРЕМЯ(1, 1, 1, 0, 0, 0)) КАК ДатаРождения,
	|	ЕСТЬNULL(УчастникиКонтролируемыхСделок.ФизическоеЛицо.МестоРождения, """") КАК МестоРождения,
	|	ГражданствоФизическихЛиц.Страна КАК ГражданствоФизЛицСтрана,
	|	КонтактнаяИнформацияФизлица.Вид КАК ВидКонтактнойИнформации,
	|	КонтактнаяИнформацияФизлица.ЗначенияПолей КАК КонтактнаяИнформацияЗначенияПолей,
	|	КонтактнаяИнформацияФизлица.Значение КАК КонтактнаяИнформацияЗначениеJSON,
	|	КонтактнаяИнформацияФизлица.Страна КАК КонтактнаяИнформацияСтрана,
	|	КонтактнаяИнформацияФизлица.Представление КАК КонтактнаяИнформацияПредставление,
	|	КонтактнаяИнформацияЗаРФ.Страна КАК КонтактнаяИнформацияЗаРФСтрана,
	|	КонтактнаяИнформацияЗаРФ.Представление КАК КонтактнаяИнформацияЗаРФПредставление,
	|	ДокументыФизическихЛиц.ВидДокумента КАК ВидДокумента,
	|	ДокументыФизическихЛиц.Серия КАК ДокументСерия,
	|	ДокументыФизическихЛиц.Номер КАК ДокументНомер,
	|	ДокументыФизическихЛиц.КемВыдан КАК ДокументКемВыдан,
	|	ДокументыФизическихЛиц.ДатаВыдачи КАК ДокументДатаВыдачи,
	|	ФИОФизЛиц.Фамилия КАК Фамилия,
	|	ФИОФизЛиц.Имя КАК Имя,
	|	ФИОФизЛиц.Отчество КАК Отчество
	|ПОМЕСТИТЬ Раздел3
	|ИЗ
	|	КонтагентыКонтролируемыхСделок КАК Контрагенты
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ДанныеПоКонтрагентамКонтролируемыхСделок КАК УчастникиКонтролируемыхСделок
	|		ПО Контрагенты.Ссылка = УчастникиКонтролируемыхСделок.Контрагент
	|		ЛЕВОЕ СОЕДИНЕНИЕ ГражданствоФизическихЛиц КАК ГражданствоФизическихЛиц
	|		ПО (УчастникиКонтролируемыхСделок.ФизическоеЛицо = ГражданствоФизическихЛиц.ФизическоеЛицо)
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ФизическиеЛица.КонтактнаяИнформация КАК КонтактнаяИнформацияФизлица
	|		ПО (УчастникиКонтролируемыхСделок.ФизическоеЛицо = КонтактнаяИнформацияФизлица.Ссылка)
	|			И (КонтактнаяИнформацияФизлица.Тип = ЗНАЧЕНИЕ(Перечисление.ТипыКонтактнойИнформации.Адрес))
	|			И (КонтактнаяИнформацияФизлица.Вид = ЗНАЧЕНИЕ(Справочник.ВидыКонтактнойИнформации.АдресПоПропискеФизическиеЛица))
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ФизическиеЛица.КонтактнаяИнформация КАК КонтактнаяИнформацияЗаРФ
	|		ПО (УчастникиКонтролируемыхСделок.ФизическоеЛицо = КонтактнаяИнформацияЗаРФ.Ссылка)
	|			И (КонтактнаяИнформацияЗаРФ.Тип = ЗНАЧЕНИЕ(Перечисление.ТипыКонтактнойИнформации.Адрес))
	|			И (КонтактнаяИнформацияЗаРФ.Вид = ЗНАЧЕНИЕ(Справочник.ВидыКонтактнойИнформации.АдресЗаПределамиРФФизическиеЛица))
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВидыДокументовФизическихЛиц КАК ВидыДокументовФизическихЛиц
	|		ПО (УчастникиКонтролируемыхСделок.ФизическоеЛицо = ВидыДокументовФизическихЛиц.Физлицо)
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ДокументыФизическихЛиц КАК ДокументыФизическихЛиц
	|		ПО (ДокументыФизическихЛиц.Физлицо = ВидыДокументовФизическихЛиц.Физлицо)
	|			И (ДокументыФизическихЛиц.Период = ВидыДокументовФизическихЛиц.Период)
	|			И (ДокументыФизическихЛиц.ВидДокумента = ВидыДокументовФизическихЛиц.ВидДокумента)
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ФИОФизическихЛиц.СрезПоследних(&ДатаАктуальностиСведений, ) КАК ФИОФизЛиц
	|		ПО (УчастникиКонтролируемыхСделок.ФизическоеЛицо = ФИОФизЛиц.ФизическоеЛицо)
	|ГДЕ
	|	Контрагенты.Ссылка В
	|			(ВЫБРАТЬ РАЗЛИЧНЫЕ
	|				Листы1А.Контрагент
	|			ИЗ
	|				Листы1А КАК Листы1А)
	|	И Контрагенты.ЮридическоеФизическоеЛицо = ЗНАЧЕНИЕ(Перечисление.ЮридическоеФизическоеЛицо.ФизическоеЛицо)
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Контрагенты.Ссылка КАК Контрагент,
	|	ВЫБОР
	|		КОГДА Контрагенты.ЮридическоеФизическоеЛицо = ЗНАЧЕНИЕ(Перечисление.ЮридическоеФизическоеЛицо.ФизическоеЛицо)
	|			ТОГДА 1
	|		ИНАЧЕ 2
	|	КОНЕЦ КАК ТипОрганизации,
	|	ВЫБОР
	|		КОГДА ГоловныеКонтрагенты.СтранаРегистрации.Код ЕСТЬ NULL
	|			ТОГДА """"
	|		ИНАЧЕ ГоловныеКонтрагенты.СтранаРегистрации.Код
	|	КОНЕЦ КАК КодСтраныРегистрации,
	|	ВЫБОР
	|		КОГДА ГоловныеКонтрагенты.НаименованиеМеждународное <> """"
	|			ТОГДА ГоловныеКонтрагенты.НаименованиеМеждународное
	|		КОГДА ГоловныеКонтрагенты.НаименованиеПолное <> """"
	|			ТОГДА ГоловныеКонтрагенты.НаименованиеПолное
	|	КОНЕЦ КАК НаименованиеКонтрагента,
	|	ВЫБОР
	|		КОГДА ГоловныеКонтрагенты.СтранаРегистрации = ЗНАЧЕНИЕ(Справочник.СтраныМира.Россия)
	|			ТОГДА ГоловныеКонтрагенты.ИНН
	|		ИНАЧЕ ВЫБОР
	|				КОГДА УчастникиКонтролируемыхСделок.ТипВыводимогоНомера = 1
	|					ТОГДА ГоловныеКонтрагенты.НалоговыйНомер
	|				КОГДА УчастникиКонтролируемыхСделок.ТипВыводимогоНомера = 2
	|					ТОГДА ГоловныеКонтрагенты.РегистрационныйНомер
	|				ИНАЧЕ ВЫБОР
	|						КОГДА ГоловныеКонтрагенты.НалоговыйНомер <> """"
	|							ТОГДА ГоловныеКонтрагенты.НалоговыйНомер
	|						ИНАЧЕ ГоловныеКонтрагенты.РегистрационныйНомер
	|					КОНЕЦ
	|			КОНЕЦ
	|	КОНЕЦ КАК РегистрационныйНомер
	|ПОМЕСТИТЬ Раздел4
	|ИЗ
	|	Листы1В КАК Листы1В
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Контрагенты КАК Контрагенты
	|		ПО Листы1В.Контрагент = Контрагенты.Ссылка
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.Контрагенты КАК ГоловныеКонтрагенты
	|		ПО (ГоловныеКонтрагенты.Ссылка = Контрагенты.ГоловнойКонтрагент)
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ДанныеПоКонтрагентамКонтролируемыхСделок КАК УчастникиКонтролируемыхСделок
	|		ПО (ГоловныеКонтрагенты.Ссылка = УчастникиКонтролируемыхСделок.Контрагент)";
	
	Возврат(ТекстЗапроса);
	
КонецФункции

// Возвращает текст запроса с данными по записанным контролируемым сделкам.
//	Возвращаемое значение:
//		Строка - текст запроса.
//
Функция ПолучитьТекстЗапросаПоКонтролируемымСделкам_2018() Экспорт
	
	ТекстЗапроса =
	"ВЫБРАТЬ РАЗРЕШЕННЫЕ РАЗЛИЧНЫЕ
	|	КонтролируемаяСделка.Организация КАК Ссылка
	|ПОМЕСТИТЬ ФильтрОрганизацийИКонтрагентов
	|ИЗ
	|	Документ.КонтролируемаяСделка КАК КонтролируемаяСделка
	|ГДЕ
	|	КонтролируемаяСделка.УведомлениеОКонтролируемойСделке = &УведомлениеОКонтролируемойСделке
	|	И НЕ КонтролируемаяСделка.ПометкаУдаления
	|
	|ОБЪЕДИНИТЬ
	|
	|ВЫБРАТЬ
	|	КонтролируемаяСделка.Контрагент
	|ИЗ
	|	Документ.КонтролируемаяСделка КАК КонтролируемаяСделка
	|ГДЕ
	|	КонтролируемаяСделка.УведомлениеОКонтролируемойСделке = &УведомлениеОКонтролируемойСделке
	|	И НЕ КонтролируемаяСделка.Контрагент В (ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка), ЗНАЧЕНИЕ(Справочник.Организации.ПустаяСсылка))
	|	И НЕ КонтролируемаяСделка.ПометкаУдаления
	|
	|ОБЪЕДИНИТЬ
	|
	|ВЫБРАТЬ
	|	КонтролируемаяСделка.Комиссионер
	|ИЗ
	|	Документ.КонтролируемаяСделка КАК КонтролируемаяСделка
	|ГДЕ
	|	КонтролируемаяСделка.УведомлениеОКонтролируемойСделке = &УведомлениеОКонтролируемойСделке
	|	И НЕ КонтролируемаяСделка.Комиссионер В (ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка), ЗНАЧЕНИЕ(Справочник.Организации.ПустаяСсылка))
	|	И НЕ КонтролируемаяСделка.ПометкаУдаления
	|
	|ОБЪЕДИНИТЬ
	|
	|ВЫБРАТЬ
	|	Листы1В.Контрагент
	|ИЗ
	|	Документ.КонтролируемаяСделка.Листы1В КАК Листы1В
	|ГДЕ
	|	Листы1В.Ссылка.УведомлениеОКонтролируемойСделке = &УведомлениеОКонтролируемойСделке
	|	И НЕ Листы1В.Контрагент В (ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка), ЗНАЧЕНИЕ(Справочник.Организации.ПустаяСсылка))
	|	И НЕ Листы1В.Ссылка.ПометкаУдаления
	|
	|ОБЪЕДИНИТЬ
	|
	|ВЫБРАТЬ
	|	Листы1Г.Контрагент
	|ИЗ
	|	Документ.КонтролируемаяСделка.Листы1Г КАК Листы1Г
	|ГДЕ
	|	Листы1Г.Ссылка.УведомлениеОКонтролируемойСделке = &УведомлениеОКонтролируемойСделке
	|	И НЕ Листы1Г.Контрагент В (ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка), ЗНАЧЕНИЕ(Справочник.Организации.ПустаяСсылка))
	|	И НЕ Листы1Г.Ссылка.ПометкаУдаления
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Ссылка
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	Контрагенты.Ссылка КАК Ссылка,
	|	Контрагенты.ОбособленноеПодразделение КАК ОбособленноеПодразделение,
	|	ВЫБОР
	|		КОГДА Контрагенты.ГоловнойКонтрагент = ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	|			ТОГДА Контрагенты.Ссылка
	|		ИНАЧЕ Контрагенты.ГоловнойКонтрагент
	|	КОНЕЦ КАК ГоловнойКонтрагент,
	|	Контрагенты.СтранаРегистрации КАК СтранаРегистрации,
	|	Контрагенты.СтранаРегистрации.Код КАК КодСтраныРегистрации,
	|	Контрагенты.ЮридическоеФизическоеЛицо КАК ЮридическоеФизическоеЛицо,
	|	Контрагенты.ИНН КАК ИНН,
	|	Контрагенты.КПП КАК КПП,
	|	Контрагенты.НаименованиеМеждународное КАК НаименованиеМеждународное,
	|	Контрагенты.НаименованиеПолное КАК НаименованиеПолное,
	|	Контрагенты.РегистрационныйНомер КАК РегистрационныйНомер,
	|	Контрагенты.НалоговыйНомер КАК НалоговыйНомер
	|ПОМЕСТИТЬ КонтрагентыИОрганизации_Предварительная
	|ИЗ
	|	Справочник.Контрагенты КАК Контрагенты
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ФильтрОрганизацийИКонтрагентов КАК Фильтр
	|		ПО (Фильтр.Ссылка = Контрагенты.Ссылка)
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	Организации.Ссылка,
	|	Организации.ОбособленноеПодразделение,
	|	Организации.ГоловнаяОрганизация,
	|	Организации.СтранаРегистрации,
	|	Организации.СтранаРегистрации.Код,
	|	Организации.ЮридическоеФизическоеЛицо,
	|	Организации.ИНН,
	|	Организации.КПП,
	|	Организации.НаименованиеИнострОрганизации,
	|	Организации.НаименованиеПолное,
	|	Организации.ОГРН,
	|	""""
	|ИЗ
	|	Справочник.Организации КАК Организации
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ФильтрОрганизацийИКонтрагентов КАК Фильтр
	|		ПО (Фильтр.Ссылка = Организации.Ссылка)
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Ссылка
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ОрганизацииКонтактнаяИнформация.Ссылка КАК Ссылка,
	|	МАКСИМУМ(ОрганизацииКонтактнаяИнформация.ДействуетС) КАК ДействуетС
	|ПОМЕСТИТЬ ДатыАктуальностиАдресов
	|ИЗ
	|	Справочник.Организации.КонтактнаяИнформация КАК ОрганизацииКонтактнаяИнформация
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ КонтрагентыИОрганизации_Предварительная КАК КонтрагентыИОрганизации
	|		ПО ОрганизацииКонтактнаяИнформация.Ссылка = КонтрагентыИОрганизации.Ссылка
	|ГДЕ
	|	ОрганизацииКонтактнаяИнформация.ДействуетС <= &ДатаАктуальностиСведений
	|	И ОрганизацииКонтактнаяИнформация.Тип = ЗНАЧЕНИЕ(Перечисление.ТипыКонтактнойИнформации.Адрес)
	|	И ОрганизацииКонтактнаяИнформация.Вид = ЗНАЧЕНИЕ(Справочник.ВидыКонтактнойИнформации.ЮрАдресОрганизации)
	|
	|СГРУППИРОВАТЬ ПО
	|	ОрганизацииКонтактнаяИнформация.Ссылка
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	КонтрагентыКонтактнаяИнформация.Ссылка,
	|	МАКСИМУМ(КонтрагентыКонтактнаяИнформация.ДействуетС)
	|ИЗ
	|	Справочник.Контрагенты.КонтактнаяИнформация КАК КонтрагентыКонтактнаяИнформация
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ КонтрагентыИОрганизации_Предварительная КАК КонтрагентыИОрганизации
	|		ПО КонтрагентыКонтактнаяИнформация.Ссылка = КонтрагентыИОрганизации.Ссылка
	|ГДЕ
	|	КонтрагентыКонтактнаяИнформация.ДействуетС <= &ДатаАктуальностиСведений
	|	И КонтрагентыКонтактнаяИнформация.Тип = ЗНАЧЕНИЕ(Перечисление.ТипыКонтактнойИнформации.Адрес)
	|	И КонтрагентыКонтактнаяИнформация.Вид = ЗНАЧЕНИЕ(Справочник.ВидыКонтактнойИнформации.ЮрАдресКонтрагента)
	|
	|СГРУППИРОВАТЬ ПО
	|	КонтрагентыКонтактнаяИнформация.Ссылка
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ОрганизацииКонтактнаяИнформация.Ссылка КАК Ссылка,
	|	ОрганизацииКонтактнаяИнформация.Представление КАК ЮридическийАдрес,
	|	ОрганизацииКонтактнаяИнформация.Значение КАК ЮридическийАдресЗначение
	|ПОМЕСТИТЬ ЮридическиеАдреса
	|ИЗ
	|	ДатыАктуальностиАдресов КАК ДатыАктуальностиАдресов
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Организации.КонтактнаяИнформация КАК ОрганизацииКонтактнаяИнформация
	|		ПО ДатыАктуальностиАдресов.Ссылка = ОрганизацииКонтактнаяИнформация.Ссылка
	|			И ДатыАктуальностиАдресов.ДействуетС = ОрганизацииКонтактнаяИнформация.ДействуетС
	|ГДЕ
	|	ОрганизацииКонтактнаяИнформация.Тип = ЗНАЧЕНИЕ(Перечисление.ТипыКонтактнойИнформации.Адрес)
	|	И ОрганизацииКонтактнаяИнформация.Вид = ЗНАЧЕНИЕ(Справочник.ВидыКонтактнойИнформации.ЮрАдресОрганизации)
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	КонтрагентыКонтактнаяИнформация.Ссылка,
	|	КонтрагентыКонтактнаяИнформация.Представление,
	|	КонтрагентыКонтактнаяИнформация.Значение
	|ИЗ
	|	ДатыАктуальностиАдресов КАК ДатыАктуальностиАдресов
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Контрагенты.КонтактнаяИнформация КАК КонтрагентыКонтактнаяИнформация
	|		ПО ДатыАктуальностиАдресов.Ссылка = КонтрагентыКонтактнаяИнформация.Ссылка
	|			И ДатыАктуальностиАдресов.ДействуетС = КонтрагентыКонтактнаяИнформация.ДействуетС
	|ГДЕ
	|	КонтрагентыКонтактнаяИнформация.Тип = ЗНАЧЕНИЕ(Перечисление.ТипыКонтактнойИнформации.Адрес)
	|	И КонтрагентыКонтактнаяИнформация.Вид = ЗНАЧЕНИЕ(Справочник.ВидыКонтактнойИнформации.ЮрАдресКонтрагента)
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ОрганизацииИсторияНаименований.Ссылка КАК Ссылка,
	|	МАКСИМУМ(ОрганизацииИсторияНаименований.Период) КАК Период
	|ПОМЕСТИТЬ ДатыАктуальностиНаименованийОрганизаций
	|ИЗ
	|	Справочник.Организации.ИсторияНаименований КАК ОрганизацииИсторияНаименований
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ КонтрагентыИОрганизации_Предварительная КАК КонтрагентыИОрганизации
	|		ПО ОрганизацииИсторияНаименований.Ссылка = КонтрагентыИОрганизации.Ссылка
	|ГДЕ
	|	ОрганизацииИсторияНаименований.Период <= &ДатаАктуальностиСведений
	|
	|СГРУППИРОВАТЬ ПО
	|	ОрганизацииИсторияНаименований.Ссылка
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ОрганизацииИсторияНаименований.Ссылка КАК Ссылка,
	|	ОрганизацииИсторияНаименований.НаименованиеПолное КАК НаименованиеПолное,
	|	ОрганизацииИсторияНаименований.НаименованиеМеждународное КАК НаименованиеМеждународное
	|ПОМЕСТИТЬ НаименованияПоИстории
	|ИЗ
	|	ДатыАктуальностиНаименованийОрганизаций КАК ДатыАктуальностиНаименованийОрганизаций
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Организации.ИсторияНаименований КАК ОрганизацииИсторияНаименований
	|		ПО ДатыАктуальностиНаименованийОрганизаций.Ссылка = ОрганизацииИсторияНаименований.Ссылка
	|			И ДатыАктуальностиНаименованийОрганизаций.Период = ОрганизацииИсторияНаименований.Период
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	Контрагенты.Ссылка,
	|	Контрагенты.НаименованиеПолное,
	|	Контрагенты.НаименованиеМеждународное
	|ИЗ
	|	КонтрагентыИОрганизации_Предварительная КАК КонтрагентыИОрганизации
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Контрагенты КАК Контрагенты
	|		ПО КонтрагентыИОрганизации.Ссылка = Контрагенты.Ссылка
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	РегистрацииВНалоговомОргане.Организация КАК Ссылка,
	|	МАКСИМУМ(РегистрацииВНалоговомОргане.Период) КАК Период
	|ПОМЕСТИТЬ ДатыАктуальностиКПП
	|ИЗ
	|	РегистрСведений.РегистрацииВНалоговомОргане КАК РегистрацииВНалоговомОргане
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ КонтрагентыИОрганизации_Предварительная КАК КонтрагентыИОрганизации
	|		ПО РегистрацииВНалоговомОргане.Организация = КонтрагентыИОрганизации.Ссылка
	|ГДЕ
	|	РегистрацииВНалоговомОргане.Подразделение = ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка)
	|	И РегистрацииВНалоговомОргане.Период <= &ДатаАктуальностиСведений
	|
	|СГРУППИРОВАТЬ ПО
	|	РегистрацииВНалоговомОргане.Организация
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	КонтрагентыИсторияКПП.Ссылка,
	|	МАКСИМУМ(КонтрагентыИсторияКПП.Период)
	|ИЗ
	|	Справочник.Контрагенты.ИсторияКПП КАК КонтрагентыИсторияКПП
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ КонтрагентыИОрганизации_Предварительная КАК КонтрагентыИОрганизации
	|		ПО КонтрагентыИсторияКПП.Ссылка = КонтрагентыИОрганизации.Ссылка
	|ГДЕ
	|	КонтрагентыИсторияКПП.Период <= &ДатаАктуальностиСведений
	|
	|СГРУППИРОВАТЬ ПО
	|	КонтрагентыИсторияКПП.Ссылка
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ДатыАктуальностиКПП.Ссылка КАК Ссылка,
	|	РегистрацииВНалоговомОргане.РегистрацияВНалоговомОргане.КПП КАК КПП
	|ПОМЕСТИТЬ КППСУчетомИстории
	|ИЗ
	|	РегистрСведений.РегистрацииВНалоговомОргане КАК РегистрацииВНалоговомОргане
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ДатыАктуальностиКПП КАК ДатыАктуальностиКПП
	|		ПО РегистрацииВНалоговомОргане.Организация = ДатыАктуальностиКПП.Ссылка
	|			И РегистрацииВНалоговомОргане.Период = ДатыАктуальностиКПП.Период
	|ГДЕ
	|	ДатыАктуальностиКПП.Ссылка ССЫЛКА Справочник.Организации
	|	И РегистрацииВНалоговомОргане.Подразделение = ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка)
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ДатыАктуальностиКПП.Ссылка,
	|	КонтрагентыИсторияКПП.КПП
	|ИЗ
	|	ДатыАктуальностиКПП КАК ДатыАктуальностиКПП
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Контрагенты.ИсторияКПП КАК КонтрагентыИсторияКПП
	|		ПО ДатыАктуальностиКПП.Ссылка = КонтрагентыИсторияКПП.Ссылка
	|			И ДатыАктуальностиКПП.Период = КонтрагентыИсторияКПП.Период
	|ГДЕ
	|	ДатыАктуальностиКПП.Ссылка ССЫЛКА Справочник.Контрагенты
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	Контрагенты.Ссылка КАК Ссылка,
	|	Контрагенты.ОбособленноеПодразделение КАК ОбособленноеПодразделение,
	|	Контрагенты.ГоловнойКонтрагент КАК ГоловнойКонтрагент,
	|	Контрагенты.СтранаРегистрации КАК СтранаРегистрации,
	|	Контрагенты.СтранаРегистрации.Код КАК КодСтраныРегистрации,
	|	Контрагенты.ЮридическоеФизическоеЛицо КАК ЮридическоеФизическоеЛицо,
	|	Контрагенты.ИНН КАК ИНН,
	|	ЕСТЬNULL(КППСУчетомИстории.КПП, Контрагенты.КПП) КАК КПП,
	|	ЕСТЬNULL(НаименованияПоИстории.НаименованиеМеждународное, Контрагенты.НаименованиеМеждународное) КАК НаименованиеМеждународное,
	|	ЕСТЬNULL(НаименованияПоИстории.НаименованиеПолное, Контрагенты.НаименованиеПолное) КАК НаименованиеПолное,
	|	Контрагенты.РегистрационныйНомер КАК РегистрационныйНомер,
	|	Контрагенты.НалоговыйНомер КАК НалоговыйНомер,
	|	ВЫРАЗИТЬ(ЕСТЬNULL(ЮридическиеАдреса.ЮридическийАдрес, """") КАК СТРОКА(1000)) КАК ЮридическийАдрес,
	|	ВЫРАЗИТЬ(ЕСТЬNULL(ЮридическиеАдреса.ЮридическийАдресЗначение, """") КАК СТРОКА(1000)) КАК ЮридическийАдресЗначение
	|ПОМЕСТИТЬ КонтрагентыИОрганизации
	|ИЗ
	|	КонтрагентыИОрганизации_Предварительная КАК Контрагенты
	|		ЛЕВОЕ СОЕДИНЕНИЕ НаименованияПоИстории КАК НаименованияПоИстории
	|		ПО Контрагенты.Ссылка = НаименованияПоИстории.Ссылка
	|		ЛЕВОЕ СОЕДИНЕНИЕ ЮридическиеАдреса КАК ЮридическиеАдреса
	|		ПО Контрагенты.Ссылка = ЮридическиеАдреса.Ссылка
	|		ЛЕВОЕ СОЕДИНЕНИЕ КППСУчетомИстории КАК КППСУчетомИстории
	|		ПО Контрагенты.Ссылка = КППСУчетомИстории.Ссылка
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Ссылка
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ДатыАктуальностиНаименованийОрганизаций
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ДатыАктуальностиАдресов
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ КонтрагентыИОрганизации_Предварительная
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ НаименованияПоИстории
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ЮридическиеАдреса
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ДатыАктуальностиКПП
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	КонтролируемаяСделка.Номер КАК НомерЛиста1А,
	|	КонтролируемаяСделка.УведомлениеОКонтролируемойСделке КАК УведомлениеОКонтролируемойСделке,
	|	КонтролируемаяСделка.Ссылка КАК Сделка,
	|	КонтролируемаяСделка.ТипСделки КАК ТипСделки,
	|	ВЫБОР
	|		КОГДА КонтролируемаяСделка.ТипВзаимозависимости = ЗНАЧЕНИЕ(Перечисление.ТипыВзаимозависимости.ВзаимозависимыПоКодексу)
	|			ТОГДА ""1""
	|		КОГДА КонтролируемаяСделка.ТипВзаимозависимости = ЗНАЧЕНИЕ(Перечисление.ТипыВзаимозависимости.СамостоятельноеПризнаниеВзаимозависимости)
	|			ТОГДА ""2""
	|		КОГДА КонтролируемаяСделка.ТипВзаимозависимости = ЗНАЧЕНИЕ(Перечисление.ТипыВзаимозависимости.ВзаимозависимостьПоРешениюСуда)
	|			ТОГДА ""3""
	|		ИНАЧЕ ""0""
	|	КОНЕЦ КАК Строка100Взаимозависимость,
	|	ВЫБОР
	|		КОГДА КонтролируемаяСделка.Строка121СтороныВзаимозависимыПоКодексу
	|			ТОГДА ""1""
	|		ИНАЧЕ ""0""
	|	КОНЕЦ КАК Строка121СтороныВзаимозависимыПоКодексу,
	|	ВЫБОР
	|		КОГДА КонтролируемаяСделка.Строка122СделкаВОбластиВнешнейТорговли
	|			ТОГДА ""1""
	|		ИНАЧЕ ""0""
	|	КОНЕЦ КАК Строка122СделкаВОбластиВнешнейТорговли,
	|	ВЫБОР
	|		КОГДА КонтролируемаяСделка.Строка123СделкаСКонтрагентомСЛьготнымНалогообложением
	|			ТОГДА ""1""
	|		ИНАЧЕ ""0""
	|	КОНЕЦ КАК Строка123СделкаСКонтрагентомСЛьготнымНалогообложением,
	|	ВЫБОР
	|		КОГДА КонтролируемаяСделка.Строка124СделкаСНезависимымПосредником
	|			ТОГДА ""1""
	|		ИНАЧЕ ""0""
	|	КОНЕЦ КАК Строка124СделкаСНезависимымПосредником,
	|	ВЫБОР
	|		КОГДА КонтролируемаяСделка.ОснованиеКонтролируемости131
	|			ТОГДА ""1""
	|		ИНАЧЕ ""0""
	|	КОНЕЦ КАК ОснованиеКонтролируемости131,
	|	ВЫБОР
	|		КОГДА КонтролируемаяСделка.ОснованиеКонтролируемости132
	|			ТОГДА ""1""
	|		ИНАЧЕ ""0""
	|	КОНЕЦ КАК ОснованиеКонтролируемости132,
	|	ВЫБОР
	|		КОГДА КонтролируемаяСделка.ОснованиеКонтролируемости133
	|			ТОГДА ""1""
	|		ИНАЧЕ ""0""
	|	КОНЕЦ КАК ОснованиеКонтролируемости133,
	|	ВЫБОР
	|		КОГДА КонтролируемаяСделка.ОснованиеКонтролируемости134
	|			ТОГДА ""1""
	|		ИНАЧЕ ""0""
	|	КОНЕЦ КАК ОснованиеКонтролируемости134,
	|	ВЫБОР
	|		КОГДА КонтролируемаяСделка.ОснованиеКонтролируемости135
	|			ТОГДА ""1""
	|		ИНАЧЕ ""0""
	|	КОНЕЦ КАК ОснованиеКонтролируемости135,
	|	ВЫБОР
	|		КОГДА КонтролируемаяСделка.ОснованиеКонтролируемости136
	|			ТОГДА ""1""
	|		ИНАЧЕ ""0""
	|	КОНЕЦ КАК ОснованиеКонтролируемости136,
	|	ВЫБОР
	|		КОГДА КонтролируемаяСделка.ОснованиеКонтролируемости137
	|			ТОГДА ""1""
	|		ИНАЧЕ ""0""
	|	КОНЕЦ КАК ОснованиеКонтролируемости137,
	|	ВЫБОР
	|		КОГДА КонтролируемаяСделка.ОснованиеКонтролируемости138
	|			ТОГДА ""1""
	|		ИНАЧЕ ""0""
	|	КОНЕЦ КАК ОснованиеКонтролируемости138,
	|	ВЫБОР
	|		КОГДА КонтролируемаяСделка.ОснованиеКонтролируемости139
	|			ТОГДА ""1""
	|		ИНАЧЕ ""0""
	|	КОНЕЦ КАК ОснованиеКонтролируемости139,
	|	ВЫБОР
	|		КОГДА КонтролируемаяСделка.ОснованиеКонтролируемости140
	|			ТОГДА ""1""
	|		ИНАЧЕ ""0""
	|	КОНЕЦ КАК ОснованиеКонтролируемости140,
	|	КонтролируемаяСделка.КодНаименованияСделки КАК Строка210КодНаименованияСделки,
	|	КонтролируемаяСделка.КодСтороныСделки КАК Строка211КодСтороныСделки,
	|	ЕСТЬNULL(КонтролируемаяСделка.Валюта.Код, """") КАК КодВалюты,
	|	КонтролируемаяСделка.СпособОпределенияЦеныСделки КАК СпособОпределенияЦеныСделки,
	|	ВЫБОР
	|		КОГДА КонтролируемаяСделка.СпособОпределенияЦеныСделки.ЦенаЯвляетсяРегулируемой
	|			ТОГДА ""1""
	|		ИНАЧЕ ""0""
	|	КОНЕЦ КАК Строка220ПризнакОпределенияЦеныСделки,
	|	ЕСТЬNULL(КонтролируемаяСделка.СпособОпределенияЦеныСделки.КомментарийКПризнакуОпределенияЦеныСделки, """") КАК Строка220_1Комментарий,
	|	ВЫБОР
	|		КОГДА ЕСТЬNULL(КонтролируемаяСделка.СпособОпределенияЦеныСделки.КодОпределенияЦеныСделки, """") = """"
	|			ТОГДА ""0""
	|		ИНАЧЕ КонтролируемаяСделка.СпособОпределенияЦеныСделки.КодОпределенияЦеныСделки
	|	КОНЕЦ КАК Строка230КодОпределенияЦены,
	|	ЕСТЬNULL(КонтролируемаяСделка.СпособОпределенияЦеныСделки.КомментарийККодуОпределенияЦеныСделки, """") КАК Строка230_1Комментарий,
	|	ЕСТЬNULL(КонтролируемаяСделка.СпособОпределенияЦеныСделки.КодМетодаЦенообразования, """") КАК Строка240КодМетодовЦенообразования,
	|	ЕСТЬNULL(КонтролируемаяСделка.СпособОпределенияЦеныСделки.КомментарийКМетодуЦенообразования, """") КАК Строка240_1Комментарий,
	|	ВЫБОР
	|		КОГДА ЕСТЬNULL(КонтролируемаяСделка.СпособОпределенияЦеныСделки.ИсточникИнформации251, ЛОЖЬ)
	|			ТОГДА ""1""
	|		ИНАЧЕ ""0""
	|	КОНЕЦ КАК Строка251,
	|	ВЫБОР
	|		КОГДА ЕСТЬNULL(КонтролируемаяСделка.СпособОпределенияЦеныСделки.ИсточникИнформации252, ЛОЖЬ)
	|			ТОГДА ""1""
	|		ИНАЧЕ ""0""
	|	КОНЕЦ КАК Строка252,
	|	ВЫБОР
	|		КОГДА ЕСТЬNULL(КонтролируемаяСделка.СпособОпределенияЦеныСделки.ИсточникИнформации253, ЛОЖЬ)
	|			ТОГДА ""1""
	|		ИНАЧЕ ""0""
	|	КОНЕЦ КАК Строка253,
	|	ВЫБОР
	|		КОГДА ЕСТЬNULL(КонтролируемаяСделка.СпособОпределенияЦеныСделки.ИсточникИнформации254, ЛОЖЬ)
	|			ТОГДА ""1""
	|		ИНАЧЕ ""0""
	|	КОНЕЦ КАК Строка254,
	|	ВЫБОР
	|		КОГДА ЕСТЬNULL(КонтролируемаяСделка.СпособОпределенияЦеныСделки.ИсточникИнформации255, ЛОЖЬ)
	|			ТОГДА ""1""
	|		ИНАЧЕ ""0""
	|	КОНЕЦ КАК Строка255,
	|	ВЫБОР
	|		КОГДА ЕСТЬNULL(КонтролируемаяСделка.СпособОпределенияЦеныСделки.ИсточникИнформации256, ЛОЖЬ)
	|			ТОГДА ""1""
	|		ИНАЧЕ ""0""
	|	КОНЕЦ КАК Строка256,
	|	ВЫБОР
	|		КОГДА ЕСТЬNULL(КонтролируемаяСделка.СпособОпределенияЦеныСделки.ИсточникИнформации257, ЛОЖЬ)
	|			ТОГДА ""1""
	|		ИНАЧЕ ""0""
	|	КОНЕЦ КАК Строка257,
	|	ВЫБОР
	|		КОГДА ЕСТЬNULL(КонтролируемаяСделка.СпособОпределенияЦеныСделки.ИсточникИнформации258, ЛОЖЬ)
	|			ТОГДА ""1""
	|		ИНАЧЕ ""0""
	|	КОНЕЦ КАК Строка258,
	|	ВЫБОР
	|		КОГДА ЕСТЬNULL(КонтролируемаяСделка.СпособОпределенияЦеныСделки.ИсточникИнформации259, ЛОЖЬ)
	|			ТОГДА ""1""
	|		ИНАЧЕ ""0""
	|	КОНЕЦ КАК Строка259,
	|	2 КАК Строка260КоличествоУчастниковСделки,
	|	КонтролируемаяСделка.КомментарийКПункту7 КАК Строка260_1Комментарий,
	|	ВЫРАЗИТЬ(КонтролируемаяСделка.СуммаДоходов КАК ЧИСЛО(15, 0)) КАК Строка300СуммаДоходов,
	|	ВЫРАЗИТЬ(КонтролируемаяСделка.СуммаДоходовРегулируемых КАК ЧИСЛО(15, 0)) КАК Строка301СуммаРегулируемыхДоходов,
	|	ВЫРАЗИТЬ(КонтролируемаяСделка.СуммаРасходов КАК ЧИСЛО(15, 0)) КАК Строка310СуммаРасходов,
	|	ВЫРАЗИТЬ(КонтролируемаяСделка.СуммаРасходовРегулируемых КАК ЧИСЛО(15, 0)) КАК Строка311СуммаРегулируемыхРасходов,
	|	ВЫБОР
	|		КОГДА Контрагенты.ОбособленноеПодразделение
	|				И Контрагенты.ГоловнойКонтрагент.СтранаРегистрации <> ЗНАЧЕНИЕ(Справочник.СтраныМира.Россия)
	|			ТОГДА Контрагенты.Ссылка
	|		ИНАЧЕ Контрагенты.ГоловнойКонтрагент
	|	КОНЕЦ КАК Контрагент,
	|	Контрагенты.СтранаРегистрации <> ЗНАЧЕНИЕ(Справочник.СтраныМира.Россия) КАК ВнешнеторговаяСделка,
	|	Контрагенты.ЮридическоеФизическоеЛицо КАК ТипКонтрагента,
	|	КонтролируемаяСделка.Договор КАК Договор,
	|	КонтролируемаяСделка.ТипПредметаСделки КАК ТипПредметаСделки,
	|	КонтролируемаяСделка.НаименованиеПредметаСделки КАК НаименованиеПредметаСделки,
	|	ЕСТЬNULL(КонтролируемаяСделка.КодТНВЭД.Код, """") КАК КодТНВЭД,
	|	ЕСТЬNULL(КонтролируемаяСделка.КодОКПД2.Код, """") КАК КодОКПД2,
	|	КонтролируемаяСделка.КодОКВЭД2 КАК КодОКВЭД2,
	|	КонтролируемаяСделка.НомерДоговора КАК НомерДоговора,
	|	КонтролируемаяСделка.ДатаДоговора КАК ДатаДоговора,
	|	ВЫБОР
	|		КОГДА КонтролируемаяСделка.ТипПредметаСделки = ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.Товар)
	|				И КонтролируемаяСделка.СтранаПроисхожденияПредметаСделки = ЗНАЧЕНИЕ(Справочник.СтраныМира.ПустаяСсылка)
	|			ТОГДА ЗНАЧЕНИЕ(Справочник.СтраныМира.Россия)
	|		ИНАЧЕ КонтролируемаяСделка.СтранаПроисхожденияПредметаСделки
	|	КОНЕЦ КАК СтранаПроисхожденияПредметаСделки,
	|	КонтролируемаяСделка.СделкаСовершенаЧерезКомиссионера КАК СделкаСовершенаЧерезКомиссионера,
	|	ВЫБОР
	|		КОГДА КонтролируемаяСделка.СделкаСовершенаЧерезКомиссионера
	|			ТОГДА ""1""
	|		ИНАЧЕ ""0""
	|	КОНЕЦ КАК СделкаСовАгент,
	|	ВЫБОР
	|		КОГДА Комиссионеры.ОбособленноеПодразделение
	|				И Комиссионеры.ГоловнойКонтрагент.СтранаРегистрации <> ЗНАЧЕНИЕ(Справочник.СтраныМира.Россия)
	|			ТОГДА Комиссионеры.Ссылка
	|		ИНАЧЕ Комиссионеры.ГоловнойКонтрагент
	|	КОНЕЦ КАК Комиссионер,
	|	Комиссионеры.ЮридическоеФизическоеЛицо КАК ТипКомиссионера,
	|	КонтролируемаяСделка.УказыватьСведенияЦепочкиСозданияСтоимости КАК УказыватьСведенияЦепочкиСозданияСтоимости
	|ПОМЕСТИТЬ Листы1А
	|ИЗ
	|	Документ.КонтролируемаяСделка КАК КонтролируемаяСделка
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ КонтрагентыИОрганизации КАК Контрагенты
	|		ПО КонтролируемаяСделка.Контрагент = Контрагенты.Ссылка
	|		ЛЕВОЕ СОЕДИНЕНИЕ КонтрагентыИОрганизации КАК Комиссионеры
	|		ПО КонтролируемаяСделка.Комиссионер = Комиссионеры.Ссылка
	|ГДЕ
	|	КонтролируемаяСделка.УведомлениеОКонтролируемойСделке = &УведомлениеОКонтролируемойСделке
	|	И НЕ КонтролируемаяСделка.ПометкаУдаления
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Сделка
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	КонтролируемаяСделкаСделки.Ссылка КАК Сделка,
	|	Листы1А.НомерЛиста1А КАК НомерЛиста1А,
	|	КонтролируемаяСделкаСделки.НомерСтроки КАК НомерСтроки,
	|	Листы1А.ТипПредметаСделки КАК ТипПредметаСделки,
	|	ВЫБОР
	|		КОГДА Листы1А.ТипПредметаСделки = ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.Товар)
	|			ТОГДА 1
	|		КОГДА Листы1А.ТипПредметаСделки = ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.РаботаУслуга)
	|			ТОГДА 2
	|		КОГДА Листы1А.ТипПредметаСделки = ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.ИнойОбъектГражданскихПрав)
	|				ИЛИ Листы1А.ТипПредметаСделки = ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.ДолговоеОбязательство)
	|			ТОГДА 3
	|	КОНЕЦ КАК Строка020ТипПредмета,
	|	Листы1А.ТипСделки КАК ТипСделки,
	|	Листы1А.НаименованиеПредметаСделки КАК Строка030НаименованиеПредмета,
	|	Листы1А.КодТНВЭД КАК Строка040КодПоТНВЭД,
	|	Листы1А.КодОКПД2 КАК Строка043КодПоОКПД2,
	|	Листы1А.КодОКВЭД2 КАК Строка045КодОКВЭД2,
	|	Листы1А.Контрагент КАК Контрагент,
	|	Листы1А.Договор КАК Договор,
	|	Листы1А.НомерДоговора КАК Строка060НомерДоговора,
	|	Листы1А.ДатаДоговора КАК Строка065ДатаДоговора,
	|	ЕСТЬNULL(Листы1А.Договор.УникальныйНомерВалютногоКонтроля, """") КАК УникальныйНомерВалютногоКонтроля,
	|	ЕСТЬNULL(Листы1А.СтранаПроисхожденияПредметаСделки.Код, """") КАК Строка070КодСтраныПроисхождения,
	|	ЕСТЬNULL(КонтролируемаяСделкаСделки.СтранаОтправкиТовара.Код, """") КАК Строка080КодСтраныОтправки,
	|	КонтролируемаяСделкаСделки.КодРегионаОтправкиТовара КАК Строка080КодРегионаОтправки,
	|	КонтролируемаяСделкаСделки.ГородОтправкиТовара КАК Строка080ГородОтправки,
	|	КонтролируемаяСделкаСделки.НаселенныйПунктОтправкиТовара КАК Строка080НаселенныйПунктОтправки,
	|	ЕСТЬNULL(КонтролируемаяСделкаСделки.СтранаСовершенияСделки.Код, """") КАК Строка090КодСтраныСовершенияСделки,
	|	КонтролируемаяСделкаСделки.КодРегионаСовершенияСделки КАК Строка090КодРегионаСовершенияСделки,
	|	КонтролируемаяСделкаСделки.ГородСовершенияСделки КАК Строка090ГородСовершенияСделки,
	|	КонтролируемаяСделкаСделки.НаселенныйПунктСовершенияСделки КАК Строка090НаселенныйПунктСовершенияСделки,
	|	КонтролируемаяСделкаСделки.ОКТМОСовершенияСделки КАК ОКТМОСовершенияСделки,
	|	ВЫБОР
	|		КОГДА Листы1А.ТипПредметаСделки = ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.Товар)
	|			ТОГДА КонтролируемаяСделкаСделки.КодУсловийПоставки
	|		ИНАЧЕ """"
	|	КОНЕЦ КАК Строка100КодУсловийПоставки,
	|	ЕСТЬNULL(КонтролируемаяСделкаСделки.ЕдиницаИзмерения.Код, """") КАК Строка110КодЕдиницыИзмерения,
	|	ВЫРАЗИТЬ(КонтролируемаяСделкаСделки.Количество КАК ЧИСЛО(15, 5)) КАК Строка120Количество,
	|	ВЫРАЗИТЬ(ВЫБОР
	|			КОГДА Листы1А.ТипПредметаСделки = ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.ДолговоеОбязательство)
	|				ТОГДА 0
	|			ИНАЧЕ КонтролируемаяСделкаСделки.Цена
	|		КОНЕЦ КАК ЧИСЛО(18, 4)) КАК Строка130Цена,
	|	Листы1А.КодВалюты КАК Строка140КодВалюты,
	|	ВЫРАЗИТЬ(ВЫБОР
	|			КОГДА Листы1А.ТипПредметаСделки = ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.ДолговоеОбязательство)
	|				ТОГДА КонтролируемаяСделкаСделки.ПроцентнаяСтавка
	|			ИНАЧЕ 0
	|		КОНЕЦ КАК ЧИСЛО(7, 4)) КАК Строка150ПроцентнаяСтавка,
	|	ВЫРАЗИТЬ(ВЫБОР
	|			КОГДА Листы1А.ТипПредметаСделки = ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.ИнойОбъектГражданскихПрав)
	|				ТОГДА КонтролируемаяСделкаСделки.СуммаБазыДляРасчетаРоялти
	|			ИНАЧЕ 0
	|		КОНЕЦ КАК ЧИСЛО(15, 0)) КАК СуммаБазыДляРасчетаРоялти,
	|	ВЫРАЗИТЬ(ВЫБОР
	|			КОГДА Листы1А.ТипПредметаСделки = ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.ДолговоеОбязательство)
	|				ТОГДА 0
	|			ИНАЧЕ КонтролируемаяСделкаСделки.Стоимость
	|		КОНЕЦ КАК ЧИСЛО(15, 0)) КАК Строка160Стоимость,
	|	КонтролируемаяСделкаСделки.ДатаСовершенияСделки КАК Строка150ДатаСовершения,
	|	Листы1А.ТипКонтрагента КАК ТипКонтрагента,
	|	Листы1А.ВнешнеторговаяСделка КАК ВнешнеторговаяСделка,
	|	Листы1А.СделкаСовершенаЧерезКомиссионера КАК СделкаСовершенаЧерезКомиссионера,
	|	Листы1А.Комиссионер КАК Комиссионер,
	|	Листы1А.ТипКомиссионера КАК ТипКомиссионера,
	|	КонтролируемаяСделкаСделки.ИдентификаторЛиста1Б КАК ИдентификаторЛиста1Б,
	|	Листы1А.УказыватьСведенияЦепочкиСозданияСтоимости КАК УказыватьСведенияЦепочкиСозданияСтоимости
	|ПОМЕСТИТЬ Листы1Б
	|ИЗ
	|	Листы1А КАК Листы1А
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.КонтролируемаяСделка.Сделки КАК КонтролируемаяСделкаСделки
	|		ПО Листы1А.Сделка = КонтролируемаяСделкаСделки.Ссылка
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Сделка
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	КонтролируемаяСделкаЛисты1В.Ссылка КАК Сделка,
	|	Листы1А.НомерЛиста1А КАК НомерЛиста1А,
	|	КонтролируемаяСделкаЛисты1В.НомерСтроки КАК НомерСтроки,
	|	ЕСТЬNULL(КонтролируемаяСделкаЛисты1Б.НомерСтроки, 0) КАК НомерСтроки1Б,
	|	КонтролируемаяСделкаЛисты1В.ИдентификаторЛиста1Б КАК ИдентификаторЛиста1Б,
	|	КонтролируемаяСделкаЛисты1В.ИдентификаторЛиста1В КАК ИдентификаторЛиста1В,
	|	КонтролируемаяСделкаЛисты1В.ТипЛиста КАК ТипЛиста,
	|	ВЫБОР
	|		КОГДА КонтролируемаяСделкаЛисты1В.ТипЛиста = ЗНАЧЕНИЕ(Перечисление.ТипыСделокВЦепочкеКонтролируемыхСделок.ПоследующаяРеализация)
	|			ТОГДА ""1""
	|		ИНАЧЕ ""2""
	|	КОНЕЦ КАК КодТипаСделки,
	|	КонтролируемаяСделкаЛисты1В.ДатаСовершенияСделки КАК ДатаСовершенияСделки,
	|	КонтролируемаяСделкаЛисты1В.КомментарийКЛисту1Б КАК КомментарийКЛисту1Б,
	|	КонтролируемаяСделкаЛисты1В.ПризнакУчастникаСделки КАК ПризнакУчастникаСделки,
	|	КонтролируемаяСделкаЛисты1В.ИдентификаторПредыдущегоЛиста1В КАК ИдентификаторПредыдущегоЛиста1В,
	|	КонтролируемаяСделкаЛисты1В.ИспользованиеПроисхождениеТовара КАК ИспользованиеПроисхождениеТовара,
	|	ВЫБОР
	|		КОГДА КонтролируемаяСделкаЛисты1В.ИспользованиеПроисхождениеТовара = ЗНАЧЕНИЕ(Перечисление.ТипыИспользованияПроисхожденияТовараКонтролируемыхСделок.Иное)
	|			ТОГДА КонтролируемаяСделкаЛисты1В.НаименованиеИспользованияПроисхожденияТовара
	|		ИНАЧЕ """"
	|	КОНЕЦ КАК НаименованиеИспользованияПроисхожденияТовара,
	|	КонтролируемаяСделкаЛисты1В.Контрагент КАК Контрагент,
	|	ВЫБОР
	|		КОГДА КонтролируемаяСделкаЛисты1В.УчастникиВзаимозависимы
	|			ТОГДА ""1""
	|		ИНАЧЕ ""0""
	|	КОНЕЦ КАК УчастникиВзаимозависимы,
	|	КонтролируемаяСделкаЛисты1В.НомерДоговора КАК НомерДоговора,
	|	КонтролируемаяСделкаЛисты1В.ДатаДоговора КАК ДатаДоговора,
	|	КонтролируемаяСделкаЛисты1В.КодУсловийПоставки КАК КодУсловийПоставки,
	|	КонтролируемаяСделкаЛисты1В.ОКТМОСовершенияСделки КАК ОКТМОСовершенияСделки,
	|	КонтролируемаяСделкаЛисты1В.СтранаСовершенияСделки КАК СтранаСовершенияСделки,
	|	ЕСТЬNULL(КонтролируемаяСделкаЛисты1В.СтранаСовершенияСделки.Код, """") КАК КодСтраныСовершенияСделки,
	|	КонтролируемаяСделкаЛисты1В.ЕдиницаИзмерения КАК ЕдиницаИзмерения,
	|	ЕСТЬNULL(КонтролируемаяСделкаЛисты1В.ЕдиницаИзмерения.Код, """") КАК КодЕдиницыИзмерения,
	|	КонтролируемаяСделкаЛисты1В.Количество КАК Количество,
	|	КонтролируемаяСделкаЛисты1В.Цена КАК Цена,
	|	КонтролируемаяСделкаЛисты1В.Валюта КАК Валюта,
	|	ЕСТЬNULL(КонтролируемаяСделкаЛисты1В.Валюта.Код, """") КАК КодВалюты,
	|	ВЫРАЗИТЬ(КонтролируемаяСделкаЛисты1В.Стоимость КАК ЧИСЛО(15, 0)) КАК Стоимость
	|ПОМЕСТИТЬ Листы1В
	|ИЗ
	|	Листы1А КАК Листы1А
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.КонтролируемаяСделка.Листы1В КАК КонтролируемаяСделкаЛисты1В
	|		ПО Листы1А.Сделка = КонтролируемаяСделкаЛисты1В.Ссылка
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.КонтролируемаяСделка.Сделки КАК КонтролируемаяСделкаЛисты1Б
	|		ПО Листы1А.Сделка = КонтролируемаяСделкаЛисты1Б.Ссылка
	|			И (КонтролируемаяСделкаЛисты1Б.ИдентификаторЛиста1Б = КонтролируемаяСделкаЛисты1В.ИдентификаторЛиста1Б)
	|			И (КонтролируемаяСделкаЛисты1В.ИдентификаторЛиста1Б <> &ПустойИдентификатор)
	|ГДЕ
	|	Листы1А.УказыватьСведенияЦепочкиСозданияСтоимости
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Сделка
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Листы1Б.Сделка КАК Сделка,
	|	Листы1Б.НомерСтроки КАК НомерСтроки,
	|	КонтролируемаяСделкаСвязьЛистов1Би1В.ИдентификаторЛиста1Б КАК ИдентификаторЛиста1Б,
	|	КонтролируемаяСделкаСвязьЛистов1Би1В.ИдентификаторЛиста1В КАК ИдентификаторЛиста1В
	|ПОМЕСТИТЬ СвязиЛистов1Би1В
	|ИЗ
	|	Листы1Б КАК Листы1Б
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.КонтролируемаяСделка.СвязьЛистов1Би1В КАК КонтролируемаяСделкаСвязьЛистов1Би1В
	|		ПО Листы1Б.Сделка = КонтролируемаяСделкаСвязьЛистов1Би1В.Ссылка
	|			И Листы1Б.ИдентификаторЛиста1Б = КонтролируемаяСделкаСвязьЛистов1Би1В.ИдентификаторЛиста1Б
	|ГДЕ
	|	Листы1Б.УказыватьСведенияЦепочкиСозданияСтоимости
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	КонтролируемаяСделкаЛисты1Г.Ссылка КАК Сделка,
	|	Листы1А.НомерЛиста1А КАК НомерЛиста1А,
	|	КонтролируемаяСделкаЛисты1Г.НомерСтроки КАК НомерСтроки,
	|	ЕСТЬNULL(КонтролируемаяСделкаЛисты1Б.НомерСтроки, 0) КАК НомерСтроки1Б,
	|	КонтролируемаяСделкаЛисты1Г.ИдентификаторЛиста1Б КАК ИдентификаторЛиста1Б,
	|	КонтролируемаяСделкаЛисты1Г.НаименованиеУслуги КАК НаименованиеУслуги,
	|	ВЫБОР
	|		КОГДА КонтролируемаяСделкаЛисты1Г.УчастникиВзаимозависимы
	|			ТОГДА ""1""
	|		ИНАЧЕ ""0""
	|	КОНЕЦ КАК УчастникиВзаимозависимы,
	|	КонтролируемаяСделкаЛисты1Г.Контрагент КАК Контрагент,
	|	ВЫБОР
	|		КОГДА Контрагенты.ЮридическоеФизическоеЛицо = ЗНАЧЕНИЕ(Перечисление.ЮридическоеФизическоеЛицо.ФизическоеЛицо)
	|			ТОГДА 1
	|		ИНАЧЕ 2
	|	КОНЕЦ КАК ТипОрганизации,
	|	ВЫБОР
	|		КОГДА ГоловныеКонтрагенты.СтранаРегистрации.Код ЕСТЬ NULL
	|			ТОГДА """"
	|		ИНАЧЕ ГоловныеКонтрагенты.СтранаРегистрации.Код
	|	КОНЕЦ КАК КодСтраныРегистрации,
	|	ВЫБОР
	|		КОГДА ГоловныеКонтрагенты.НаименованиеМеждународное <> """"
	|			ТОГДА ГоловныеКонтрагенты.НаименованиеМеждународное
	|		КОГДА ГоловныеКонтрагенты.НаименованиеПолное <> """"
	|			ТОГДА ГоловныеКонтрагенты.НаименованиеПолное
	|	КОНЕЦ КАК НаименованиеКонтрагента,
	|	ВЫБОР
	|		КОГДА ГоловныеКонтрагенты.СтранаРегистрации = ЗНАЧЕНИЕ(Справочник.СтраныМира.Россия)
	|			ТОГДА ГоловныеКонтрагенты.ИНН
	|		ИНАЧЕ ГоловныеКонтрагенты.РегистрационныйНомер
	|	КОНЕЦ КАК РегистрационныйНомер,
	|	КонтролируемаяСделкаЛисты1Г.Валюта КАК Валюта,
	|	ЕСТЬNULL(КонтролируемаяСделкаЛисты1Г.Валюта.Код, """") КАК КодВалюты,
	|	КонтролируемаяСделкаЛисты1Г.Стоимость КАК Стоимость
	|ПОМЕСТИТЬ Листы1Г
	|ИЗ
	|	Листы1А КАК Листы1А
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.КонтролируемаяСделка.Листы1Г КАК КонтролируемаяСделкаЛисты1Г
	|		ПО Листы1А.Сделка = КонтролируемаяСделкаЛисты1Г.Ссылка
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.КонтролируемаяСделка.Сделки КАК КонтролируемаяСделкаЛисты1Б
	|		ПО Листы1А.Сделка = КонтролируемаяСделкаЛисты1Б.Ссылка
	|			И (КонтролируемаяСделкаЛисты1Б.ИдентификаторЛиста1Б = КонтролируемаяСделкаЛисты1Г.ИдентификаторЛиста1Б)
	|			И (КонтролируемаяСделкаЛисты1Г.ИдентификаторЛиста1Б <> &ПустойИдентификатор)
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ КонтрагентыИОрганизации КАК Контрагенты
	|		ПО (КонтролируемаяСделкаЛисты1Г.Контрагент = Контрагенты.Ссылка)
	|		ЛЕВОЕ СОЕДИНЕНИЕ КонтрагентыИОрганизации КАК ГоловныеКонтрагенты
	|		ПО (ГоловныеКонтрагенты.Ссылка = Контрагенты.ГоловнойКонтрагент)
	|ГДЕ
	|	Листы1А.УказыватьСведенияЦепочкиСозданияСтоимости
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Сделка
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	Листы1А.Контрагент КАК Контрагент
	|ПОМЕСТИТЬ КонтрагентыЛистов1А_Список
	|ИЗ
	|	Листы1А КАК Листы1А
	|ГДЕ
	|	Листы1А.Контрагент <> ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	|
	|ОБЪЕДИНИТЬ
	|
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	Листы1А.Комиссионер
	|ИЗ
	|	Листы1А КАК Листы1А
	|ГДЕ
	|	Листы1А.Комиссионер <> ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	|
	|ОБЪЕДИНИТЬ
	|
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	Контрагенты.ГоловнойКонтрагент
	|ИЗ
	|	Листы1А КАК Листы1А
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ КонтрагентыИОрганизации КАК Контрагенты
	|		ПО Листы1А.Контрагент = Контрагенты.Ссылка
	|ГДЕ
	|	Листы1А.Контрагент <> ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	|	И Контрагенты.ГоловнойКонтрагент <> ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	|	И Контрагенты.ГоловнойКонтрагент <> Листы1А.Контрагент
	|
	|ОБЪЕДИНИТЬ
	|
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	Контрагенты.ГоловнойКонтрагент
	|ИЗ
	|	Листы1А КАК Листы1А
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ КонтрагентыИОрганизации КАК Контрагенты
	|		ПО Листы1А.Комиссионер = Контрагенты.Ссылка
	|ГДЕ
	|	Листы1А.Комиссионер <> ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	|	И Контрагенты.ГоловнойКонтрагент <> ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	|	И Контрагенты.ГоловнойКонтрагент <> Листы1А.Комиссионер
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	КонтрагентыЛистов1А_Список.Контрагент КАК Контрагент,
	|	КонтрагентыИОрганизации.ЮридическоеФизическоеЛицо КАК ЮридическоеФизическоеЛицо
	|ПОМЕСТИТЬ КонтрагентыЛистов1А
	|ИЗ
	|	КонтрагентыЛистов1А_Список КАК КонтрагентыЛистов1А_Список
	|		ЛЕВОЕ СОЕДИНЕНИЕ КонтрагентыИОрганизации КАК КонтрагентыИОрганизации
	|		ПО КонтрагентыЛистов1А_Список.Контрагент = КонтрагентыИОрганизации.Ссылка
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Контрагенты.Ссылка КАК Контрагент,
	|	ВЫБОР
	|		КОГДА ГоловныеКонтрагенты.СтранаРегистрации = ЗНАЧЕНИЕ(Справочник.СтраныМира.Россия)
	|			ТОГДА 1
	|		ИНАЧЕ 2
	|	КОНЕЦ КАК Строка020ТипОрганизации,
	|	ВЫБОР
	|		КОГДА ГоловныеКонтрагенты.СтранаРегистрации.Код ЕСТЬ NULL
	|			ТОГДА """"
	|		ИНАЧЕ ГоловныеКонтрагенты.СтранаРегистрации.Код
	|	КОНЕЦ КАК Строка030КакКодСтраныРегистрации,
	|	ГоловныеКонтрагенты.НаименованиеПолное КАК Строка040Наименование,
	|	ГоловныеКонтрагенты.НаименованиеМеждународное КАК Строка040НаименованиеЛат,
	|	ВЫБОР
	|		КОГДА ГоловныеКонтрагенты.СтранаРегистрации = ЗНАЧЕНИЕ(Справочник.СтраныМира.Россия)
	|			ТОГДА Контрагенты.ИНН
	|		ИНАЧЕ """"
	|	КОНЕЦ КАК Строка050ИНН,
	|	ВЫБОР
	|		КОГДА ГоловныеКонтрагенты.СтранаРегистрации = ЗНАЧЕНИЕ(Справочник.СтраныМира.Россия)
	|			ТОГДА ГоловныеКонтрагенты.КПП
	|		КОГДА Контрагенты.СтранаРегистрации = ЗНАЧЕНИЕ(Справочник.СтраныМира.Россия)
	|			ТОГДА Контрагенты.КПП
	|		ИНАЧЕ """"
	|	КОНЕЦ КАК Строка060КПП,
	|	ВЫБОР
	|		КОГДА ГоловныеКонтрагенты.СтранаРегистрации = ЗНАЧЕНИЕ(Справочник.СтраныМира.Россия)
	|			ТОГДА """"
	|		ИНАЧЕ ГоловныеКонтрагенты.РегистрационныйНомер
	|	КОНЕЦ КАК Строка070РегНомерВСтрокеРегистрации,
	|	ВЫБОР
	|		КОГДА ГоловныеКонтрагенты.СтранаРегистрации = ЗНАЧЕНИЕ(Справочник.СтраныМира.Россия)
	|			ТОГДА """"
	|		ИНАЧЕ ВЫБОР
	|				КОГДА УчастникиКонтролируемыхСделок.ТипВыводимогоНомера = 1
	|					ТОГДА ГоловныеКонтрагенты.НалоговыйНомер
	|				КОГДА УчастникиКонтролируемыхСделок.ТипВыводимогоНомера = 2
	|					ТОГДА ГоловныеКонтрагенты.РегистрационныйНомер
	|				ИНАЧЕ ВЫБОР
	|						КОГДА ГоловныеКонтрагенты.НалоговыйНомер <> """"
	|							ТОГДА ГоловныеКонтрагенты.НалоговыйНомер
	|						ИНАЧЕ ГоловныеКонтрагенты.РегистрационныйНомер
	|					КОНЕЦ
	|			КОНЕЦ
	|	КОНЕЦ КАК НалоговыйРегистрационныйНомер,
	|	ВЫБОР
	|		КОГДА ГоловныеКонтрагенты.СтранаРегистрации = ЗНАЧЕНИЕ(Справочник.СтраныМира.Россия)
	|			ТОГДА """"
	|		ИНАЧЕ УчастникиКонтролируемыхСделок.НаименованиеИдентификатораРегистрационногоНомера
	|	КОНЕЦ КАК НаименованиеИдентификатораРегистрационногоНомера,
	|	ВЫБОР
	|		КОГДА ГоловныеКонтрагенты.СтранаРегистрации = ЗНАЧЕНИЕ(Справочник.СтраныМира.Россия)
	|			ТОГДА """"
	|		ИНАЧЕ ГоловныеКонтрагенты.НалоговыйНомер
	|	КОНЕЦ КАК Строка080КодНалогВСтранеРегистрации,
	|	ВЫБОР
	|		КОГДА ГоловныеКонтрагенты.СтранаРегистрации = ЗНАЧЕНИЕ(Справочник.СтраныМира.Россия)
	|			ТОГДА """"
	|		ИНАЧЕ ГоловныеКонтрагенты.ЮридическийАдрес
	|	КОНЕЦ КАК Строка090АдресИностраннойОрганизации,
	|	ВЫБОР
	|		КОГДА ГоловныеКонтрагенты.СтранаРегистрации = ЗНАЧЕНИЕ(Справочник.СтраныМира.Россия)
	|			ТОГДА """"
	|		ИНАЧЕ ГоловныеКонтрагенты.ЮридическийАдресЗначение
	|	КОНЕЦ КАК АдресИностраннойОрганизацииЗначение
	|ПОМЕСТИТЬ Раздел2
	|ИЗ
	|	КонтрагентыЛистов1А КАК КонтрагентыЛистов1А
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ КонтрагентыИОрганизации КАК Контрагенты
	|		ПО КонтрагентыЛистов1А.Контрагент = Контрагенты.Ссылка
	|			И (Контрагенты.ЮридическоеФизическоеЛицо = ЗНАЧЕНИЕ(Перечисление.ЮридическоеФизическоеЛицо.ЮридическоеЛицо))
	|		ЛЕВОЕ СОЕДИНЕНИЕ КонтрагентыИОрганизации КАК ГоловныеКонтрагенты
	|		ПО (ГоловныеКонтрагенты.Ссылка = Контрагенты.ГоловнойКонтрагент)
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ДанныеПоКонтрагентамКонтролируемыхСделок КАК УчастникиКонтролируемыхСделок
	|		ПО (ГоловныеКонтрагенты.Ссылка = УчастникиКонтролируемыхСделок.Контрагент)
	|ГДЕ
	|	Контрагенты.ЮридическоеФизическоеЛицо = ЗНАЧЕНИЕ(Перечисление.ЮридическоеФизическоеЛицо.ЮридическоеЛицо)
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ДокументыФизическихЛицСрезПоследних.Физлицо КАК Физлицо,
	|	ДокументыФизическихЛицСрезПоследних.Период КАК Период,
	|	МАКСИМУМ(ДокументыФизическихЛицСрезПоследних.ВидДокумента) КАК ВидДокумента
	|ПОМЕСТИТЬ ВидыДокументовФизическихЛиц
	|ИЗ
	|	РегистрСведений.ДокументыФизическихЛиц.СрезПоследних(
	|			&ДатаАктуальностиСведений,
	|			Физлицо В
	|				(ВЫБРАТЬ
	|					УчастникиСделок.ФизическоеЛицо
	|				ИЗ
	|					РегистрСведений.ДанныеПоКонтрагентамКонтролируемыхСделок КАК УчастникиСделок)) КАК ДокументыФизическихЛицСрезПоследних
	|
	|СГРУППИРОВАТЬ ПО
	|	ДокументыФизическихЛицСрезПоследних.Физлицо,
	|	ДокументыФизическихЛицСрезПоследних.Период
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Физлицо,
	|	Период,
	|	ВидДокумента
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ГражданствоФизическихЛицСрезПоследних.ФизическоеЛицо КАК ФизическоеЛицо,
	|	ГражданствоФизическихЛицСрезПоследних.Страна КАК Страна
	|ПОМЕСТИТЬ ГражданствоФизическихЛиц
	|ИЗ
	|	РегистрСведений.ГражданствоФизическихЛиц.СрезПоследних(
	|			&ДатаАктуальностиСведений,
	|			ФизическоеЛицо В
	|				(ВЫБРАТЬ
	|					УчастникиСделок.ФизическоеЛицо
	|				ИЗ
	|					РегистрСведений.ДанныеПоКонтрагентамКонтролируемыхСделок КАК УчастникиСделок)) КАК ГражданствоФизическихЛицСрезПоследних
	|
	|СГРУППИРОВАТЬ ПО
	|	ГражданствоФизическихЛицСрезПоследних.ФизическоеЛицо,
	|	ГражданствоФизическихЛицСрезПоследних.Страна
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	ФизическоеЛицо
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	КонтрагентыЛистов1А.Контрагент КАК Контрагент,
	|	ЕСТЬNULL(УчастникиКонтролируемыхСделок.КодВидаДеятельностиФизическогоЛица, """") КАК Строка020КодВидаДеятельности,
	|	КонтрагентыИОрганизации.ИНН КАК Строка030ИНН,
	|	ЕСТЬNULL(УчастникиКонтролируемыхСделок.ФизическоеЛицо, ЗНАЧЕНИЕ(Справочник.ФизическиеЛица.ПустаяСсылка)) КАК ФизическоеЛицо,
	|	ЕСТЬNULL(УчастникиКонтролируемыхСделок.ФизическоеЛицо.ДатаРождения, ДАТАВРЕМЯ(1, 1, 1, 0, 0, 0)) КАК ДатаРождения,
	|	ЕСТЬNULL(УчастникиКонтролируемыхСделок.ФизическоеЛицо.МестоРождения, """") КАК МестоРождения,
	|	ГражданствоФизическихЛиц.Страна КАК ГражданствоФизЛицСтрана,
	|	КонтактнаяИнформацияФизлица.Вид КАК ВидКонтактнойИнформации,
	|	КонтактнаяИнформацияФизлица.ЗначенияПолей КАК КонтактнаяИнформацияЗначенияПолей,
	|	КонтактнаяИнформацияФизлица.Значение КАК КонтактнаяИнформацияЗначениеJSON,
	|	КонтактнаяИнформацияФизлица.Страна КАК КонтактнаяИнформацияСтрана,
	|	КонтактнаяИнформацияФизлица.Представление КАК КонтактнаяИнформацияПредставление,
	|	КонтактнаяИнформацияЗаРФ.Страна КАК КонтактнаяИнформацияЗаРФСтрана,
	|	КонтактнаяИнформацияЗаРФ.Представление КАК КонтактнаяИнформацияЗаРФПредставление,
	|	ДокументыФизическихЛиц.ВидДокумента КАК ВидДокумента,
	|	ДокументыФизическихЛиц.Серия КАК ДокументСерия,
	|	ДокументыФизическихЛиц.Номер КАК ДокументНомер,
	|	ДокументыФизическихЛиц.КемВыдан КАК ДокументКемВыдан,
	|	ДокументыФизическихЛиц.ДатаВыдачи КАК ДокументДатаВыдачи,
	|	ФИОФизЛиц.Фамилия КАК Фамилия,
	|	ФИОФизЛиц.Имя КАК Имя,
	|	ФИОФизЛиц.Отчество КАК Отчество
	|ПОМЕСТИТЬ Раздел3
	|ИЗ
	|	КонтрагентыЛистов1А КАК КонтрагентыЛистов1А
	|		ЛЕВОЕ СОЕДИНЕНИЕ КонтрагентыИОрганизации КАК КонтрагентыИОрганизации
	|		ПО КонтрагентыЛистов1А.Контрагент = КонтрагентыИОрганизации.Ссылка
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ДанныеПоКонтрагентамКонтролируемыхСделок КАК УчастникиКонтролируемыхСделок
	|		ПО КонтрагентыЛистов1А.Контрагент = УчастникиКонтролируемыхСделок.Контрагент
	|		ЛЕВОЕ СОЕДИНЕНИЕ ГражданствоФизическихЛиц КАК ГражданствоФизическихЛиц
	|		ПО (УчастникиКонтролируемыхСделок.ФизическоеЛицо = ГражданствоФизическихЛиц.ФизическоеЛицо)
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ФизическиеЛица.КонтактнаяИнформация КАК КонтактнаяИнформацияФизлица
	|		ПО (УчастникиКонтролируемыхСделок.ФизическоеЛицо = КонтактнаяИнформацияФизлица.Ссылка)
	|			И (КонтактнаяИнформацияФизлица.Тип = ЗНАЧЕНИЕ(Перечисление.ТипыКонтактнойИнформации.Адрес))
	|			И (КонтактнаяИнформацияФизлица.Вид = ЗНАЧЕНИЕ(Справочник.ВидыКонтактнойИнформации.АдресПоПропискеФизическиеЛица))
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ФизическиеЛица.КонтактнаяИнформация КАК КонтактнаяИнформацияЗаРФ
	|		ПО (УчастникиКонтролируемыхСделок.ФизическоеЛицо = КонтактнаяИнформацияЗаРФ.Ссылка)
	|			И (КонтактнаяИнформацияЗаРФ.Тип = ЗНАЧЕНИЕ(Перечисление.ТипыКонтактнойИнформации.Адрес))
	|			И (КонтактнаяИнформацияЗаРФ.Вид = ЗНАЧЕНИЕ(Справочник.ВидыКонтактнойИнформации.АдресЗаПределамиРФФизическиеЛица))
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВидыДокументовФизическихЛиц КАК ВидыДокументовФизическихЛиц
	|		ПО (УчастникиКонтролируемыхСделок.ФизическоеЛицо = ВидыДокументовФизическихЛиц.Физлицо)
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ДокументыФизическихЛиц КАК ДокументыФизическихЛиц
	|		ПО (ДокументыФизическихЛиц.Физлицо = ВидыДокументовФизическихЛиц.Физлицо)
	|			И (ДокументыФизическихЛиц.Период = ВидыДокументовФизическихЛиц.Период)
	|			И (ДокументыФизическихЛиц.ВидДокумента = ВидыДокументовФизическихЛиц.ВидДокумента)
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ФИОФизическихЛиц.СрезПоследних(&ДатаАктуальностиСведений, ) КАК ФИОФизЛиц
	|		ПО (УчастникиКонтролируемыхСделок.ФизическоеЛицо = ФИОФизЛиц.ФизическоеЛицо)
	|ГДЕ
	|	КонтрагентыЛистов1А.ЮридическоеФизическоеЛицо = ЗНАЧЕНИЕ(Перечисление.ЮридическоеФизическоеЛицо.ФизическоеЛицо)
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Контрагенты.Ссылка КАК Контрагент,
	|	ВЫБОР
	|		КОГДА Контрагенты.ЮридическоеФизическоеЛицо = ЗНАЧЕНИЕ(Перечисление.ЮридическоеФизическоеЛицо.ФизическоеЛицо)
	|			ТОГДА 1
	|		ИНАЧЕ 2
	|	КОНЕЦ КАК ТипОрганизации,
	|	ВЫБОР
	|		КОГДА ГоловныеКонтрагенты.СтранаРегистрации.Код ЕСТЬ NULL
	|			ТОГДА """"
	|		ИНАЧЕ ГоловныеКонтрагенты.СтранаРегистрации.Код
	|	КОНЕЦ КАК КодСтраныРегистрации,
	|	ВЫБОР
	|		КОГДА ГоловныеКонтрагенты.НаименованиеМеждународное <> """"
	|			ТОГДА ГоловныеКонтрагенты.НаименованиеМеждународное
	|		КОГДА ГоловныеКонтрагенты.НаименованиеПолное <> """"
	|			ТОГДА ГоловныеКонтрагенты.НаименованиеПолное
	|	КОНЕЦ КАК НаименованиеКонтрагента,
	|	ВЫБОР
	|		КОГДА ГоловныеКонтрагенты.СтранаРегистрации = ЗНАЧЕНИЕ(Справочник.СтраныМира.Россия)
	|			ТОГДА ГоловныеКонтрагенты.ИНН
	|		ИНАЧЕ ВЫБОР
	|				КОГДА УчастникиКонтролируемыхСделок.ТипВыводимогоНомера = 1
	|					ТОГДА ГоловныеКонтрагенты.НалоговыйНомер
	|				КОГДА УчастникиКонтролируемыхСделок.ТипВыводимогоНомера = 2
	|					ТОГДА ГоловныеКонтрагенты.РегистрационныйНомер
	|				ИНАЧЕ ВЫБОР
	|						КОГДА ГоловныеКонтрагенты.НалоговыйНомер <> """"
	|							ТОГДА ГоловныеКонтрагенты.НалоговыйНомер
	|						ИНАЧЕ ГоловныеКонтрагенты.РегистрационныйНомер
	|					КОНЕЦ
	|			КОНЕЦ
	|	КОНЕЦ КАК РегистрационныйНомер
	|ПОМЕСТИТЬ Раздел4
	|ИЗ
	|	Листы1В КАК Листы1В
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ КонтрагентыИОрганизации КАК Контрагенты
	|		ПО Листы1В.Контрагент = Контрагенты.Ссылка
	|		ЛЕВОЕ СОЕДИНЕНИЕ КонтрагентыИОрганизации КАК ГоловныеКонтрагенты
	|		ПО (ГоловныеКонтрагенты.Ссылка = Контрагенты.ГоловнойКонтрагент)
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ДанныеПоКонтрагентамКонтролируемыхСделок КАК УчастникиКонтролируемыхСделок
	|		ПО (ГоловныеКонтрагенты.Ссылка = УчастникиКонтролируемыхСделок.Контрагент)";
	
	Возврат(ТекстЗапроса);
	
КонецФункции

// Возвращает текст настроек, с данными о методе выставления листа 1Б (для каждой сделки или для нескольких) и коде
// места представления.
// 
// Параметры:
// Уведомление - ДокументСсылка.УведомлениеОКонтролируемыхСделках - ссылка на документ уведомления,
//                                                                  для которого подготавливаются данные.
//	Возвращаемое значение:
//  Строка - текст.
//
Функция ПолучитьТекстНастроекФормированияУведомления(Уведомление) Экспорт
	
	Если ЗначениеЗаполнено(Уведомление) Тогда
		НастройкиФормирования = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(Уведомление, "ГруппироватьСделкиСОдинаковойЦеной, КодМестаПредставления");
	Иначе
		НастройкиФормирования = Новый Структура("ГруппироватьСделкиСОдинаковойЦеной, КодМестаПредставления", Ложь, "");
	КонецЕсли;
	
	Если НастройкиФормирования.ГруппироватьСделкиСОдинаковойЦеной Тогда
		ТекстНастроек = НСтр("ru = 'Один лист 1Б для нескольких сделок; Код места представления %1';
							|en = 'One sheet 1B for several transactions; %1 submission location code '");
	Иначе
		ТекстНастроек = НСтр("ru = 'Один лист 1Б для каждой сделки; Код места представления %1';
							|en = 'One sheet 1B for each transaction; %1 submission location code '");
	КонецЕсли;
	
	Если ЗначениеЗаполнено(НастройкиФормирования.КодМестаПредставления) Тогда
		ТекстНастроек = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(ТекстНастроек, НастройкиФормирования.КодМестаПредставления);
	Иначе
		ТекстНастроек = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(ТекстНастроек, НСтр("ru = 'не заполнен';
																									|en = 'not filled in'"));
	КонецЕсли;
	
	Возврат ТекстНастроек;
	
КонецФункции

#Область ДляВызоваИзДругихПодсистем

// СтандартныеПодсистемы.УправлениеДоступом

// Параметры:
//   Ограничение - см. УправлениеДоступомПереопределяемый.ПриЗаполненииОграниченияДоступа.Ограничение.
//
Процедура ПриЗаполненииОграниченияДоступа(Ограничение) Экспорт

	Ограничение.Текст =
	"РазрешитьЧтениеИзменение
	|ГДЕ
	|	ЗначениеРазрешено(Организация)";

КонецПроцедуры

// Конец СтандартныеПодсистемы.УправлениеДоступом

#КонецОбласти

#Область ВерсияУведомления

// Версия уведомления.
// 
// Параметры:
//  Уведомление - ДокументСсылка.УведомлениеОКонтролируемыхСделках - Уведомление
// 
// Возвращаемое значение:
//  Число - Версия уведомления
Функция ВерсияУведомления(Уведомление) Экспорт
	
	ВерсияУведомления = КонтролируемыеСделкиКлиентСервер.ВерсияУведомления_2012();
	
	Если ЗначениеЗаполнено(Уведомление) Тогда
		
		Возврат ОбщегоНазначения.ЗначениеРеквизитаОбъекта(Уведомление, "ВерсияУведомления");
		
	КонецЕсли;
	
	Возврат ВерсияУведомления;
	
КонецФункции

// Версия уведомления по отчетному году.
// 
// Параметры:
//  ОтчетныйГод - Дата - Отчетный год
// 
// Возвращаемое значение:
//  Число - Версия уведомления по отчетному году
Функция ВерсияУведомленияПоОтчетномуГоду(ОтчетныйГод) Экспорт
	
	Если ОтчетныйГод >= Дата(2024, 1, 1) Тогда
		Возврат КонтролируемыеСделкиКлиентСервер.ВерсияУведомления_2024();
	ИначеЕсли ОтчетныйГод >= Дата(2021, 1, 1) Тогда
		Возврат КонтролируемыеСделкиКлиентСервер.ВерсияУведомления_2021();
	ИначеЕсли ОтчетныйГод >= Дата(2019, 1, 1) Тогда
		Возврат КонтролируемыеСделкиКлиентСервер.ВерсияУведомления_2019();
	ИначеЕсли ОтчетныйГод >= Дата(2018, 1, 1) Тогда
		Возврат КонтролируемыеСделкиКлиентСервер.ВерсияУведомления_2018();
	ИначеЕсли ОтчетныйГод >= Дата(2017, 1, 1) Тогда
		Возврат КонтролируемыеСделкиКлиентСервер.ВерсияУведомления_2017();
	Иначе
		Возврат КонтролируемыеСделкиКлиентСервер.ВерсияУведомления_2012();
	КонецЕсли;
	
КонецФункции

#КонецОбласти

#Область ПечатьИВыгрузка_2018

// Сведения о гражданстве2018.
// 
// Параметры:
//  СтранаГражданства - СправочникСсылка.СтраныМира - Страна гражданства
// 
// Возвращаемое значение:
//  Структура - Сведения о гражданстве2018:
// * Гражд - Строка - 
// * ОКСМ - Строка - 
Функция СведенияОГражданстве2018(СтранаГражданства) Экспорт
	
	СведенияОГражданстве = Новый Структура();
	СведенияОГражданстве.Вставить("Гражд", "3"); // Без гражданства
	СведенияОГражданстве.Вставить("ОКСМ", "");
	
	Если ЗначениеЗаполнено(СтранаГражданства) Тогда
		СведенияОГражданстве.Гражд = ?(СтранаГражданства = Справочники.СтраныМира.Россия, "1", "2");
		СведенияОГражданстве.ОКСМ = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(СтранаГражданства, "Код");
	КонецЕсли;
	
	Возврат СведенияОГражданстве;
	
КонецФункции

#КонецОбласти
// Конец СтандартныеПодсистемы.ВерсионированиеОбъектов

#КонецОбласти

#КонецЕсли

#Область ОбработчикиСобытий

// Устанавливает представление уведомления о контролируемых сделках.
//
// Параметры:
//  Данные - Структура - параметры структуры:
//  * НомерКорректировки - Число - номер корректировки уведомления.
//  * ОтчетныйГод        - Число - наименование ключа варианта отчета.
//  Представление        - Строка - представление уведомления о контролируемых сделках.
//  СтандартнаяОбработка - Булево - Истина, если используется стандратное поведение обработки.
//
Процедура ОбработкаПолученияПредставления(Данные, Представление, СтандартнаяОбработка)
	
	СтандартнаяОбработка = Ложь;
	
	Представление = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
		НСтр("ru = 'Уведомление о контролируемых сделках за %1 г.';
			|en = 'Notification of controlled transactions for %1'"),
		Формат(Данные.ОтчетныйГод, "ДФ=yyyy"));
		
	Если Данные.НомерКорректировки > 0 Тогда
		
		Представление = Представление + СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
			НСтр("ru = ', корректировка %1';
				|en = ', adjustment %1'"),
			Формат(Данные.НомерКорректировки, "ЧГ="));
			
	КонецЕсли;
	
КонецПроцедуры

// Обработка получения полей представления.
// Параметры:
//  Поля                 - Массив из Строка - массив наименований полей.
//  СтандартнаяОбработка - Булево - Истина, если используется стандартная обработка.
Процедура ОбработкаПолученияПолейПредставления(Поля, СтандартнаяОбработка)
	
	СтандартнаяОбработка = Ложь;
	
	Поля.Добавить("ОтчетныйГод");
	Поля.Добавить("НомерКорректировки");
	
КонецПроцедуры

#КонецОбласти

#Если Сервер Или ТолстыйКлиентОбычноеПриложение Или ВнешнееСоединение Тогда

#Область СлужебныеПроцедурыИФункции

// Добавляет команду создания документа "Уведомление о контролируемых сделках".
//
// Параметры:
//  КомандыСозданияНаОсновании - см. СозданиеНаОснованииПереопределяемый.ПередДобавлениемКомандСозданияНаОсновании.КомандыСозданияНаОсновании
//
// Возвращаемое значение:
//  Неопределено - Добавить команду создать на основании
Функция ДобавитьКомандуСоздатьНаОсновании(КомандыСозданияНаОсновании) Экспорт
	Если ПравоДоступа("Добавление", Метаданные.Документы.УведомлениеОКонтролируемыхСделках) Тогда
		КомандаСоздатьНаОсновании = КомандыСозданияНаОсновании.Добавить();
		КомандаСоздатьНаОсновании.Менеджер = Метаданные.Документы.УведомлениеОКонтролируемыхСделках.ПолноеИмя();
		КомандаСоздатьНаОсновании.Представление = ОбщегоНазначенияУТ.ПредставлениеОбъекта(Метаданные.Документы.УведомлениеОКонтролируемыхСделках);
		КомандаСоздатьНаОсновании.РежимЗаписи = "Проводить";
		КомандаСоздатьНаОсновании.ФункциональныеОпции = "ИспользоватьУведомленияОКонтролируемыхСделках";

		Возврат КомандаСоздатьНаОсновании;
	КонецЕсли;

	Возврат Неопределено;
КонецФункции

#Область АвтоматическоеЗаполнение

// Формирует данных о контролируемых сделках для уведомления.
//
// Параметры:
//  Уведомление        - ДокументСсылка.УведомлениеОКонтролируемыхСделках - уведомление о контролируемых сделках.
//  СообщатьОПрогрессе - Булево - Истина, если сообщать информацию о прогрессе
//                                формирования данных по контролируемым сделкам.
//
Процедура СформироватьКонтролируемыеСделки(Уведомление, СообщатьОПрогрессе)
	
	ПараметрыУведомления = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(Уведомление, "Организация, ОтчетныйГод, ВерсияУведомления");
	
	Если СообщатьОПрогрессе Тогда
		СообщитьОПодготовкеДанных();
	КонецЕсли;
	
	ТаблицаЛистов1А = ПометитьНаУдалениеКонтролируемыеСделкиУведомления(Уведомление);
	
	Запрос = Новый Запрос();
	Запрос.МенеджерВременныхТаблиц = ПолучитьВременныеТаблицыДляЗаполненияУведомления(Уведомление);
	Запрос.Параметры.Вставить("ВалютаРегламентированногоУчета",
		ОбщегоНазначенияБПВызовСервераПовтИсп.ПолучитьВалютуРегламентированногоУчета());
	
	Если ПараметрыУведомления.ВерсияУведомления >= КонтролируемыеСделкиКлиентСервер.ВерсияУведомления_2019() Тогда
		Запрос.Текст = ТекстЗапросаФормированиеКонтролируемыхСделок2019();
	Иначе
		Запрос.Текст = ТекстЗапросаФормированиеКонтролируемыхСделок2012();
	КонецЕсли;
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	МетаданныеРегистра = Метаданные.РегистрыНакопления.КонтролируемыеСделкиОрганизаций;
	
	ТаблицаСделокЛиста1А = Документы.КонтролируемаяСделка.ПустаяСсылка().Сделки.Выгрузить();
	ТаблицаСделокЛиста1А.Колонки.Добавить("СтоимостьДляРасчетаЦены", МетаданныеРегистра.Ресурсы.СуммаНДСВВалютеРасчетов.Тип);
	ТаблицаСделокЛиста1А.Колонки.Добавить("РасчетныйДокумент", МетаданныеРегистра.Измерения.РасчетныйДокумент.Тип);
	ТекущийНомерЛиста1А = 1;
	
	ПараметрыЗаполнения = ПараметрыЗаполненияУведомления(Уведомление);
	
	ПараметрыСообщенияОПрогрессе = ПараметрыСообщенияОПрогрессе(Выборка);
	
	КлючСделки = КлючСделки();
	
	ДокументСделки = Неопределено;
	Пока Выборка.Следующий() Цикл
		
		Если СообщатьОПрогрессе Тогда
			ОповеститьОПрогрессе(ПараметрыСообщенияОПрогрессе);
		КонецЕсли;
		
		Если ДокументСделки = Неопределено ИЛИ
			НЕ КлючСделкиСовпадает(Выборка, КлючСделки) Тогда
			
			ЗаполнитьЗначенияСвойств(КлючСделки, Выборка);
			
			Если ДокументСделки <> Неопределено Тогда
				ЗаполнитьТаблицуСделокЛиста1А(ДокументСделки, ТаблицаСделокЛиста1А, ПараметрыЗаполнения);
				ДокументСделки.Записать();
				ТаблицаСделокЛиста1А.Очистить();
				ДокументСделки = Неопределено;
				ТекущийНомерЛиста1А = ТекущийНомерЛиста1А + 1;
			КонецЕсли;
			
			Отбор = Новый Структура("Контрагент, Договор, ПредметСделки, Используется",
				КлючСделки.Контрагент, КлючСделки.Договор, КлючСделки.ПредметСделки, Ложь);
			ДокументыСделок = ТаблицаЛистов1А.НайтиСтроки(Отбор);
			Если ДокументыСделок.Количество()>0 Тогда
				Для Каждого СтрокаДокументовСделок Из ДокументыСделок Цикл
					Если КлючСделкиСовпадает(СтрокаДокументовСделок, КлючСделки) Тогда
						ДокументСделки = СтрокаДокументовСделок.Сделка.ПолучитьОбъект();
						ДокументСделки.ПометкаУдаления = Ложь;
						СтрокаДокументовСделок.Используется = Истина;
					КонецЕсли;
				КонецЦикла;
			КонецЕсли;
			
			Если ДокументСделки = Неопределено Тогда
				ДокументСделки = Документы.КонтролируемаяСделка.СоздатьДокумент();
				ДокументСделки.Дата = ТекущаяДатаСеанса();
			КонецЕсли;
			
			ДокументСделки.Номер = ТекущийНомерЛиста1А;
			ЗаполнитьЗначенияСвойств(ДокументСделки, Выборка, , ПараметрыЗаполнения.ИсключенияДляЗаполненияЛиста1А);
			
			СписокКодовСтороныСделки = ПараметрыЗаполнения.СписокКодовСторонСделки.Получить(Выборка.КодНаименованияСделки);
			Если СписокКодовСтороныСделки.Количество() = 1 Тогда
				ДокументСделки.КодСтороныСделки = СписокКодовСтороныСделки[0].Значение;
			ИначеЕсли СписокКодовСтороныСделки.Количество() > 1 Тогда
				ДокументСделки.КодСтороныСделки = ?(Выборка.ТипСделки = Перечисления.ТипыКонтролируемыхСделок.ПолученДоход, СписокКодовСтороныСделки[0].Значение, СписокКодовСтороныСделки[1].Значение);
			КонецЕсли;
			ДокументСделки.УказыватьСведенияЦепочкиСозданияСтоимости = ДокументСделки.Строка121СтороныВзаимозависимыПоКодексу
				И ДокументСделки.Строка122СделкаВОбластиВнешнейТорговли;
			ДокументСделки.КомментарийКПункту7 = "";
			ДокументСделки.РедактироватьСуммыСделок = Ложь;
			ДокументСделки.СуммаДоходов = 0;
			ДокументСделки.СуммаДоходовРегулируемых = 0;
			ДокументСделки.СуммаРасходов = 0;
			ДокументСделки.СуммаРасходовРегулируемых = 0;
			
			ДокументСделки.Сделки.Очистить();
			
		КонецЕсли;
		
		НоваяСделка = ТаблицаСделокЛиста1А.Добавить();
		ИсключенияЗаполненияЛиста1Б = ИсключенияЗаполненияЛиста1Б(ПараметрыЗаполнения.Версия, Выборка.ТипПредметаСделки);
		ЗаполнитьЗначенияСвойств(НоваяСделка, Выборка, , ИсключенияЗаполненияЛиста1Б);
		ЗаполнитьДатуСделкиДолговыхОбязательств(НоваяСделка, ПараметрыЗаполнения.Версия, Выборка.ТипПредметаСделки, Выборка.ДатаПроцентнойСтавки);
		НоваяСделка.СтоимостьДляРасчетаЦены = Выборка[ПараметрыЗаполнения.ПолеОпределенияСтоимостиДляРасчетаЦены];
		ЗаполнитьАдресаСделки(НоваяСделка, Выборка.Грузоотправитель, Выборка.Грузополучатель, ПараметрыЗаполнения);
	КонецЦикла;
	
	Если ДокументСделки <> Неопределено Тогда
		ЗаполнитьТаблицуСделокЛиста1А(ДокументСделки, ТаблицаСделокЛиста1А, ПараметрыЗаполнения);
		ДокументСделки.Записать();
		ДокументСделки = Неопределено;
	КонецЕсли;
	
	ОбъектУведомление = Уведомление.ПолучитьОбъект();
	ОбъектУведомление.ДатаЗаполненияУведомления = ТекущаяДатаСеанса();
	ОбъектУведомление.Записать();
	
КонецПроцедуры

// Возвращает структуру данных, заполненных на основании уведомления.
// 
// Возвращаемое значение:
//  Структура - структура полей ключа сделки:
//  * Версия                                - Число - код версии уведомления о контролируемых сделках.
//  * ИсключенияДляЗаполненияЛиста1А        - Строка - наименования реквизитов, через запятую,
//                                                     которые не нужно заполнять в листе 1А.
//  * КешАдресныхДанных                     - Соответствие из КлючИЗначение - соответствие адресных данных в кеш.
//  * КлючевыеПоля                          - Структура - параметры ключевый полей уведомления:
//   * ГородОтправкиТовара                           - Неопределено - заготовка для ввода информации.
//   * ГородСовершенияСделки                         - Неопределено - заготовка для ввода информации.
//   * ЕдиницаИзмерения                              - Неопределено - заготовка для ввода информации.
//   * КодРегионаОтправкиТовара                      - Неопределено - заготовка для ввода информации.
//   * КодРегионаСовершенияСделки                    - Неопределено - заготовка для ввода информации.
//   * КодУсловийПоставки                            - Неопределено - заготовка для ввода информации.
//   * НаселенныйПунктОтправкиТовара                 - Неопределено - заготовка для ввода информации.
//   * НаселенныйПунктСовершенияСделки               - Неопределено - заготовка для ввода информации.
//   * ОКТМОСовершенияСделки                         - Неопределено - заготовка для ввода информации.
//   * ПроцентнаяСтавка                              - Неопределено - заготовка для ввода информации.
//   * СтранаОтправкиТовара                          - Неопределено - заготовка для ввода информации.
//   * СтранаСовершенияСделки                        - Неопределено - заготовка для ввода информации.
//   * СуммаБазыДляРасчетаРоялти                     - Неопределено - заготовка для ввода информации.
//   * Цена                                          - Неопределено - заготовка для ввода информации.
//  * КлючевыеПоляЦепочкиСозданияСтоимости - Структура - ключевые поля цепочки создания стоимости:
//    * Валюта                                       - Неопределено - заготовка для ввода информации.
//    * ДатаДоговора                                 - Неопределено - заготовка для ввода информации.
//    * ДатаСовершенияСделки                         - Неопределено - заготовка для ввода информации.
//    * ЕдиницаИзмерения                             - Неопределено - заготовка для ввода информации.
//    * ИспользованиеПроисхождениеТовара             - Неопределено - заготовка для ввода информации.
//    * КодУсловийПоставки                           - Неопределено - заготовка для ввода информации.
//    * Контрагент                                   - Неопределено - заготовка для ввода информации.
//    * НаименованиеИспользованияПроисхожденияТовара - Неопределено - заготовка для ввода информации.
//    * НомерДоговора                                - Неопределено - заготовка для ввода информации.
//    * ОКТМОСовершенияСделки                        - Неопределено - заготовка для ввода информации.
//    * ПризнакУчастникаСделки                       - Неопределено - заготовка для ввода информации.
//    * СтранаСовершенияСделки                       - Неопределено - заготовка для ввода информации.
//    * УчастникиВзаимозависимы                      - Неопределено - заготовка для ввода информации.
//    * Цена                                         - Неопределено - заготовка для ввода информации.
//  * ПолеОпределенияСтоимостиДляРасчетаЦены         - Строка - наименование поля для определения 
//                                                     стоимости для расчета цены.
//  * СопутствующиеУслуги                            - ТаблицаЗначений - описание сопуствующих услуг сделки.
//  * СписокКодовСторонСделки                        - Соответствие из КлючИЗначение - соответвие списка кодов и
//                                                     наименования строн сделки, Значение имеет
//                                                     тип СписокЗначений из Строка.
//  * СтрокаСверткиТаблицыСделок                     - Строка - наименования колонок перечисленных через запятую. 
//  * Уведомление                                    - ДокументСсылка.УведомлениеОКонтролируемыхСделках - уведомление.
//  * ЦепочкиСозданияСтоимости                       - ТаблицаЗначений - описание цепочек создания стоимости.
//
Функция ПараметрыЗаполненияУведомления(Уведомление)
	
	Параметры = Новый Структура;
	Параметры.Вставить("Уведомление", Уведомление);
	Параметры.Вставить("Версия", Документы.УведомлениеОКонтролируемыхСделках.ВерсияУведомления(Уведомление));
	Параметры.Вставить("КлючевыеПоля", Новый Структура());
	Параметры.Вставить("СтрокаСверткиТаблицыСделок", "");
	Параметры.Вставить("ПолеОпределенияСтоимостиДляРасчетаЦены", ПолеОпределенияСтоимостиДляРасчетаЦены(Параметры.Версия));
	Параметры.Вставить("ИсключенияДляЗаполненияЛиста1А", ИсключенияЗаполненияЛиста1А(Параметры.Версия));
	Параметры.Вставить("СписокКодовСторонСделки", КонтролируемыеСделки.ПолучитьСоответствиеКодовСтороныСделки());
	Параметры.Вставить("КешАдресныхДанных", Новый Соответствие);
	Параметры.Вставить("СопутствующиеУслуги", СопутствующиеУслугиКонтролируемыхСделок(Уведомление));
	Параметры.Вставить("ЦепочкиСозданияСтоимости", ЦепочкиСозданияСтоимости(Уведомление));
	Параметры.Вставить("КлючевыеПоляЦепочкиСозданияСтоимости", КлючевыеПоляЦепочкиСозданияСтоимости());
	
	ЗаполнитьКлючевыеПоляИСтрокуСвертки(Параметры);
	
	Возврат Параметры;
	
КонецФункции

// Функция возвращает структуру ключа сделки.
// 
// Возвращаемое значение:
//  Структура - структура полей ключа сделки:
//  * Валюта                       - Неопределено - заготовка для ввода информации.
//  * Договор                      - Неопределено - заготовка для ввода информации.
//  * КодНаименованияСделки        - Неопределено - заготовка для ввода информации.
//  * Комиссионер                  - Неопределено - заготовка для ввода информации.
//  * Контрагент                   - Неопределено - заготовка для ввода информации.
//  * НаименованиеПредметаСделки   - Неопределено - заготовка для ввода информации.
//  * ОснованиеКонтролируемости131 - Неопределено - заготовка для ввода информации.
//  * ОснованиеКонтролируемости132 - Неопределено - заготовка для ввода информации.
//  * ОснованиеКонтролируемости133 - Неопределено - заготовка для ввода информации.
//  * ОснованиеКонтролируемости134 - Неопределено - заготовка для ввода информации.
//  * ОснованиеКонтролируемости135 - Неопределено - заготовка для ввода информации.
//  * ОснованиеКонтролируемости136 - Неопределено - заготовка для ввода информации.
//  * ОснованиеКонтролируемости137 - Неопределено - заготовка для ввода информации.
//  * ОснованиеКонтролируемости138 - Неопределено - заготовка для ввода информации.
//  * ПредметСделки                - Неопределено - заготовка для ввода информации.
//
Функция КлючСделки()
	
	Возврат Новый Структура("Контрагент, Договор, СделкаСовершенаЧерезКомиссионера, Комиссионер,
		|ПредметСделки, Строка121СтороныВзаимозависимыПоКодексу, Строка122СделкаВОбластиВнешнейТорговли,
		|Строка123СделкаСКонтрагентомСЛьготнымНалогообложением, Строка124СделкаСНезависимымПосредником,
		|ОснованиеКонтролируемости131, ОснованиеКонтролируемости132,
		|ОснованиеКонтролируемости133, ОснованиеКонтролируемости134,
		|ОснованиеКонтролируемости135, ОснованиеКонтролируемости136, ОснованиеКонтролируемости137,
		|ОснованиеКонтролируемости138, ТипВзаимозависимости, ТипПредметаСделки, НаименованиеПредметаСделки,
		|КодНаименованияСделки, ТипСделки, Валюта");
	
КонецФункции

// Заполняет в параметрах ключевые поля и строку свертки для таблицы сделок.
// 
// Параметры:
//  Параметры - Структура - состав параметров:
//  * Версия                                - Число - код версии уведомления о контролируемых сделках.
//  * ИсключенияДляЗаполненияЛиста1А        - Строка - наименования реквизитов, через запятую,
//                                                     которые не нужно заполнять в листе 1А.
//  * КешАдресныхДанных                     - Соответствие из КлючИЗначение - соответствие адресных данных в кеш.
//  * КлючевыеПоля                          - Структура - параметры ключевый полей уведомления:
//   * ГородОтправкиТовара                           - Неопределено - заготовка для ввода информации.
//   * ГородСовершенияСделки                         - Неопределено - заготовка для ввода информации.
//   * ЕдиницаИзмерения                              - Неопределено - заготовка для ввода информации.
//   * КодРегионаОтправкиТовара                      - Неопределено - заготовка для ввода информации.
//   * КодРегионаСовершенияСделки                    - Неопределено - заготовка для ввода информации.
//   * КодУсловийПоставки                            - Неопределено - заготовка для ввода информации.
//   * НаселенныйПунктОтправкиТовара                 - Неопределено - заготовка для ввода информации.
//   * НаселенныйПунктСовершенияСделки               - Неопределено - заготовка для ввода информации.
//   * ОКТМОСовершенияСделки                         - Неопределено - заготовка для ввода информации.
//   * ПроцентнаяСтавка                              - Неопределено - заготовка для ввода информации.
//   * СтранаОтправкиТовара                          - Неопределено - заготовка для ввода информации.
//   * СтранаСовершенияСделки                        - Неопределено - заготовка для ввода информации.
//   * СуммаБазыДляРасчетаРоялти                     - Неопределено - заготовка для ввода информации.
//   * Цена                                          - Неопределено - заготовка для ввода информации.
//  * КлючевыеПоляЦепочкиСозданияСтоимости - Структура - ключевые поля цепочки создания стоимости:
//    * Валюта                                       - Неопределено - заготовка для ввода информации.
//    * ДатаДоговора                                 - Неопределено - заготовка для ввода информации.
//    * ДатаСовершенияСделки                         - Неопределено - заготовка для ввода информации.
//    * ЕдиницаИзмерения                             - Неопределено - заготовка для ввода информации.
//    * ИспользованиеПроисхождениеТовара             - Неопределено - заготовка для ввода информации.
//    * КодУсловийПоставки                           - Неопределено - заготовка для ввода информации.
//    * Контрагент                                   - Неопределено - заготовка для ввода информации.
//    * НаименованиеИспользованияПроисхожденияТовара - Неопределено - заготовка для ввода информации.
//    * НомерДоговора                                - Неопределено - заготовка для ввода информации.
//    * ОКТМОСовершенияСделки                        - Неопределено - заготовка для ввода информации.
//    * ПризнакУчастникаСделки                       - Неопределено - заготовка для ввода информации.
//    * СтранаСовершенияСделки                       - Неопределено - заготовка для ввода информации.
//    * УчастникиВзаимозависимы                      - Неопределено - заготовка для ввода информации.
//    * Цена                                         - Неопределено - заготовка для ввода информации.
//  * ПолеОпределенияСтоимостиДляРасчетаЦены         - Строка - наименование поля для определения 
//                                                     стоимости для расчета цены.
//  * СопутствующиеУслуги                            - ТаблицаЗначений - описание сопуствующих услуг сделки.
//  * СписокКодовСторонСделки                        - Соответствие из КлючИЗначение - соответвие списка кодов и
//                                                     наименования строн сделки, Значение имеет
//                                                     тип СписокЗначений из Строка.
//  * СтрокаСверткиТаблицыСделок                     - Строка - наименования колонок перечисленных через запятую. 
//  * Уведомление                                    - ДокументСсылка.УведомлениеОКонтролируемыхСделках - уведомление.
//  * ЦепочкиСозданияСтоимости                       - ТаблицаЗначений - описание цепочек создания стоимости.
//
Процедура ЗаполнитьКлючевыеПоляИСтрокуСвертки(Параметры)
	
	СтруктураКлючевыхПолей = Новый Структура();
	СтруктураКлючевыхПолей.Вставить("РасчетныйДокумент");
	СтрокаСверткиТаблицыСделок = "";
	Для Каждого РеквизитСделки Из Метаданные.Документы.КонтролируемаяСделка.ТабличныеЧасти.Сделки.Реквизиты Цикл
		Если РеквизитСделки.Имя <> "Количество" И РеквизитСделки.Имя <> "Стоимость"
			И РеквизитСделки.Имя <> "ИдентификаторЛиста1Б" Тогда
			СтруктураКлючевыхПолей.Вставить(РеквизитСделки.Имя);
			СтрокаСверткиТаблицыСделок = СтрокаСверткиТаблицыСделок 
				+ ?(СтрокаСверткиТаблицыСделок = "","",", ") + РеквизитСделки.Имя;
		КонецЕсли;
	КонецЦикла;
	
	Если ОбщегоНазначения.ЗначениеРеквизитаОбъекта(Параметры.Уведомление, "ГруппироватьСделкиСОдинаковойЦеной") Тогда
		СтруктураКлючевыхПолей.Удалить("ДатаСовершенияСделки");
		СтруктураКлючевыхПолей.Удалить("РасчетныйДокумент");
		Если Параметры.Версия < КонтролируемыеСделкиКлиентСервер.ВерсияУведомления_2018() Тогда
			СтруктураКлючевыхПолей.Удалить("ПроцентнаяСтавка");
		КонецЕсли;
	КонецЕсли;
	
	Параметры.КлючевыеПоля = СтруктураКлючевыхПолей;
	Параметры.СтрокаСверткиТаблицыСделок = СтрокаСверткиТаблицыСделок;
	
КонецПроцедуры

// Возвращает структуру для определения ключевый полей цепочки создания стоимости.
//
// Возвращаемое значение:
//  - Структура - состав параметров:
//  * Валюта                                       - Неопределено - заготовка для ввода информации.
//  * ДатаДоговора                                 - Неопределено - заготовка для ввода информации.
//  * ДатаСовершенияСделки                         - Неопределено - заготовка для ввода информации.
//  * ЕдиницаИзмерения                             - Неопределено - заготовка для ввода информации.
//  * ИспользованиеПроисхождениеТовара             - Неопределено - заготовка для ввода информации.
//  * КодУсловийПоставки                           - Неопределено - заготовка для ввода информации.
//  * Контрагент                                   - Неопределено - заготовка для ввода информации.
//  * НаименованиеИспользованияПроисхожденияТовара - Неопределено - заготовка для ввода информации.
//  * НомерДоговора                                - Неопределено - заготовка для ввода информации.
//  * ОКТМОСовершенияСделки                        - Неопределено - заготовка для ввода информации.
//  * ПризнакУчастникаСделки                       - Неопределено - заготовка для ввода информации.
//  * СтранаСовершенияСделки                       - Неопределено - заготовка для ввода информации.
//  * УчастникиВзаимозависимы                      - Неопределено - заготовка для ввода информации.
//  * Цена                                         - Неопределено - заготовка для ввода информации.
//
Функция КлючевыеПоляЦепочкиСозданияСтоимости()
	
	СтруктураКлючевыхПолей = Новый Структура();
	
	Для Каждого РеквизитСделки Из Метаданные.Документы.ЦепочкаСозданияСтоимостиКонтролируемойСделки.ТабличныеЧасти.Сделки.Реквизиты Цикл
		Если РеквизитСделки.Имя <> "Количество" И РеквизитСделки.Имя <> "Стоимость" Тогда
			СтруктураКлючевыхПолей.Вставить(РеквизитСделки.Имя);
		КонецЕсли;
	КонецЦикла;
	
	Возврат СтруктураКлючевыхПолей;
	
КонецФункции

// Возвращает наименование поля для определения стоимости для расчета цены в зависимости от версии уведомления.
//
// Параметры:
//  ВерсияУведомления - Число - код версии уведомления о контролируемых сделках.
//
// Возвращаемое значение:
//  Строка - наименование поля для определения стоимости для расчета цены.
Функция ПолеОпределенияСтоимостиДляРасчетаЦены(ВерсияУведомления)
	
	Если ВерсияУведомления < КонтролируемыеСделкиКлиентСервер.ВерсияУведомления_2018() Тогда
		Возврат "Стоимость";
	Иначе
		Возврат "СтоимостьВВалюте";
	КонецЕсли;
	
КонецФункции

// Возвращает структуру параметров о процесса заполнения уведомления.
// 
// Параметры:
//  Выборка - ВыборкаДанных - выборка данных из результата запроса, содержащая информацию
//                            о процессе заполнения уведомления.
// Возвращаемое значение:
//  Структура - данные о процессе формирования уведомления:
//  * ОбработаноСтрок          - Число - количество обработанных строк уведомления.
//  * ВсегоСтрок               - Число - всего строк уведомления
//  * ПрогрессОКоторомСообщили - Число - числовое значение процента выдолненного прогресса формирования уведомления.
//
Функция ПараметрыСообщенияОПрогрессе(Выборка)
	
	Параметры = Новый Структура;
	Параметры.Вставить("ВсегоСтрок", Выборка.Количество());
	Параметры.Вставить("ОбработаноСтрок", 0);
	Параметры.Вставить("ПрогрессОКоторомСообщили", -1);
	Возврат Параметры;
	
КонецФункции

// Формирует сообщение пользователю о процессе заполнения уведомления согласно параметрам.
// 
// Параметры:
//  Параметры - Структура - данные о процессе формирования уведомления:
//  * ОбработаноСтрок          - Число - количество обработанных строк уведомления.
//  * ВсегоСтрок               - Число - всего строк уведомления
//  * ПрогрессОКоторомСообщили - Число - числовое значение процента выдолненного прогресса формирования уведомления.
//
Процедура ОповеститьОПрогрессе(Параметры)
	
	Параметры.ОбработаноСтрок = Параметры.ОбработаноСтрок + 1;
	ТекущийПрогресс = Цел(Параметры.ОбработаноСтрок / Параметры.ВсегоСтрок * 100);
	Если ТекущийПрогресс <> Параметры.ПрогрессОКоторомСообщили Тогда
		Параметры.ПрогрессОКоторомСообщили = ТекущийПрогресс;
		ТекстОповещенияОПрогрессе = СтрШаблон(НСтр("ru = 'Обработано: %1 из %2';
													|en = 'Processed: %1 of %2.'"), Параметры.ОбработаноСтрок, Параметры.ВсегоСтрок);
		ДлительныеОперации.СообщитьПрогресс(ТекущийПрогресс, ТекстОповещенияОПрогрессе);
	КонецЕсли;
	
КонецПроцедуры

// Формирует сообщение пользователю о процессе заполнения уведомления.
//
Процедура СообщитьОПодготовкеДанных()
	
	ТекстОповещенияОПрогрессе = НСтр("ru = 'Подготовка к заполнению уведомления';
									|en = 'Preparing to fill in the notification'");
	ДлительныеОперации.СообщитьПрогресс(0, ТекстОповещенияОПрогрессе);
	
КонецПроцедуры

// Устанавливает в запросе параметры запоса согласно переданной структуре.
// 
// Параметры:
//  Запрос              - Запрос - запрос, в котором необходимо установить параметры.
//  СтруктураПараметров - Структура - описание параметров запроса.
//
Процедура ДобавитьВПараметрыЗапроса(Запрос, СтруктураПараметров)
	
	Для Каждого Параметр Из СтруктураПараметров Цикл
		Запрос.УстановитьПараметр(Параметр.Ключ, Параметр.Значение);
	КонецЦикла;
	
КонецПроцедуры

// Возвращает текст запроса формирования контролируемых сделок формата уведдомления 2012 года
// Возвращаемое значение:
//  Строка -  текст запроса формирования контролируемых сделок формата уведдомления 2012 года
//
Функция ТекстЗапросаФормированиеКонтролируемыхСделок2012()
	
	ТекстЗапроса =
	"ВЫБРАТЬ
	|	КонтролируемыеСделки.Организация КАК Организация,
	|	КонтролируемыеСделки.Уведомление КАК УведомлениеОКонтролируемойСделке,
	|	КонтролируемыеСделки.ПериодСделки КАК ДатаСовершенияСделки,
	|	КонтролируемыеСделки.ТипВзаимозависимости КАК ТипВзаимозависимости,
	|	КонтролируемыеСделки.Контрагент КАК Контрагент,
	|	КонтролируемыеСделки.ГоловнойКонтрагент КАК ГоловнойКонтрагент,
	|	КонтролируемыеСделки.Договор КАК Договор,
	|	КонтролируемыеСделки.Валюта <> &ВалютаРегламентированногоУчета КАК РасчетыВУсловныхЕдиницах,
	|	КонтролируемыеСделки.Комиссионер <> ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка) КАК СделкаСовершенаЧерезКомиссионера,
	|	КонтролируемыеСделки.Комиссионер КАК Комиссионер,
	|	КонтролируемыеСделки.ПредметСделки КАК ПредметСделки,
	|	КонтролируемыеСделки.НаименованиеПредметаСделки КАК НаименованиеПредметаСделки,
	|	КонтролируемыеСделки.СтороныВзаимозависимыПоКодексу КАК Строка121СтороныВзаимозависимыПоКодексу,
	|	КонтролируемыеСделки.СделкаВнешнейТорговлиТоваромМировойБиржевойТорговли КАК Строка122СделкаВОбластиВнешнейТорговли,
	|	КонтролируемыеСделки.ЗарегистрированВСтранеСЛьготнымНалогообложением КАК Строка123СделкаСКонтрагентомСЛьготнымНалогообложением,
	|	КонтролируемыеСделки.СделкаСНезависимымПосредником КАК Строка124СделкаСНезависимымПосредником,
	|	КонтролируемыеСделки.СуммаБезНДСВРублях КАК Стоимость,
	|	ВЫБОР
	|		КОГДА КонтролируемыеСделки.Валюта = &ВалютаРегламентированногоУчета
	|			ТОГДА КонтролируемыеСделки.СуммаБезНДСВРублях
	|		ИНАЧЕ КонтролируемыеСделки.СуммаБезНДСВВалютеРасчетов
	|	КОНЕЦ КАК СтоимостьВВалюте,
	|	КонтролируемыеСделки.КонтрагентЗарегистрированВРФ КАК КонтрагентЗарегистрированВРФ,
	|	НЕ КонтрагентыКонтролируемыеПоОбщейСумме.ГоловнойКонтрагент ЕСТЬ NULL
	|		И НЕ КонтрагентыКонтролируемыеПоОбщейСумме.ГоловнойКонтрагент ЕСТЬ NULL КАК ОснованиеКонтролируемости131,
	|	НЕ КонтрагентыКонтролируемыеПоНДПИ.ГоловнойКонтрагент ЕСТЬ NULL
	|		И КонтролируемыеСделки.СделкаКонтролируетсяПоНДПИ КАК ОснованиеКонтролируемости132,
	|	НЕ КонтрагентыКонтролируемыеПоСпецРежиму.ГоловнойКонтрагент ЕСТЬ NULL
	|		И (КонтролируемыеСделки.СделкаОблагаетсяЕНВД
	|			ИЛИ КонтролируемыеСделки.СделкаСПлательщикомЕСХН) КАК ОснованиеКонтролируемости133,
	|	НЕ КонтрагентыКонтролируемыеПоПрибыли.ГоловнойКонтрагент ЕСТЬ NULL
	|		И КонтролируемыеСделки.СделкаКонтролируетсяПоНалогуНаПрибыль КАК ОснованиеКонтролируемости134,
	|	НЕ КонтрагентыКонтролируемыеПоОЭЗ.ГоловнойКонтрагент ЕСТЬ NULL
	|		И КонтролируемыеСделки.СделкаКонтролируетсяПоРегистрацииВОЭЗ КАК ОснованиеКонтролируемости135,
	|	НЕ КонтрагентыКонтролируемыеПоМорскомуМесторождению.ГоловнойКонтрагент ЕСТЬ NULL
	|		И КонтролируемыеСделки.СделкаМорскогоМесторождения КАК ОснованиеКонтролируемости136,
	|	НЕ КонтрагентыКонтролируемыеПоИнвестиционнымПроектам.ГоловнойКонтрагент ЕСТЬ NULL
	|		И КонтролируемыеСделки.СделкаКонтролируетсяПоИнвестиционнымПроектам КАК ОснованиеКонтролируемости137,
	|	НЕ КонтрагентыКонтролируемыеПоОсвобождениюНДС.ГоловнойКонтрагент ЕСТЬ NULL
	|		И КонтролируемыеСделки.СделкаКонтролируетсяПоОсвобождениюНДС КАК ОснованиеКонтролируемости138,
	|	НЕ КонтрагентыКонтролируемыеПоИнвестиционномуВычету.ГоловнойКонтрагент ЕСТЬ NULL
	|		И КонтролируемыеСделки.СделкаКонтролируетсяПоИнвестиционномуВычету КАК ОснованиеКонтролируемости139,
	|	НЕ КонтрагентыКонтролируемыеПоРегистрацииНеВРФ.ГоловнойКонтрагент ЕСТЬ NULL
	|		И КонтролируемыеСделки.СделкаКонтролируетсяПоДополнительномуДоходуОтСырья КАК ОснованиеКонтролируемости140,
	|	ВЫБОР
	|		КОГДА ЕСТЬNULL(ДоговорыУчастниковКонтролируемыхСделок.КодНаименованияСделки, """") = """"
	|			ТОГДА ВЫБОР
	|					КОГДА КонтролируемыеСделки.ТипПредметаСделки = ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.РаботаУслуга)
	|						ТОГДА ""019""
	|					ИНАЧЕ ""015""
	|				КОНЕЦ
	|		ИНАЧЕ ЕСТЬNULL(ДоговорыУчастниковКонтролируемыхСделок.КодНаименованияСделки, """")
	|	КОНЕЦ КАК КодНаименованияСделки,
	|	ЕСТЬNULL(ДоговорыУчастниковКонтролируемыхСделок.СпособОпределенияЦеныСделки, ЗНАЧЕНИЕ(Справочник.СпособыОпределенияЦенКонтролируемыхСделок.ПустаяСсылка)) КАК СпособОпределенияЦеныСделки,
	|	ВЫБОР
	|		КОГДА КонтролируемыеСделки.ТипПредметаСделки = ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.Товар)
	|			ТОГДА ЕСТЬNULL(ДоговорыУчастниковКонтролируемыхСделок.КодУсловийПоставки, """")
	|		ИНАЧЕ """"
	|	КОНЕЦ КАК КодУсловийПоставки,
	|	КонтролируемыеСделки.ТипПредметаСделки КАК ТипПредметаСделки,
	|	КонтролируемыеСделки.ЕдиницаИзмерения КАК ЕдиницаИзмерения,
	|	КонтролируемыеСделки.ТипКонтролируемойСделки КАК ТипСделки,
	|	КонтролируемыеСделки.Грузоотправитель КАК Грузоотправитель,
	|	КонтролируемыеСделки.Грузополучатель КАК Грузополучатель,
	|	КонтролируемыеСделки.Валюта КАК Валюта,
	|	КонтролируемыеСделки.РасчетныйДокумент КАК РасчетныйДокумент,
	|	ВЫБОР
	|		КОГДА КонтролируемыеСделки.ТипПредметаСделки = ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.Товар)
	|			ТОГДА СУММА(КонтролируемыеСделки.Количество)
	|		ИНАЧЕ СРЕДНЕЕ(КонтролируемыеСделки.Количество)
	|	КОНЕЦ КАК Количество,
	|	СРЕДНЕЕ(КонтролируемыеСделки.ПроцентнаяСтавка) КАК ПроцентнаяСтавка,
	|	МАКСИМУМ(КонтролируемыеСделки.ДатаПроцентнойСтавки) КАК ДатаПроцентнойСтавки,
	|	ВЫБОР
	|		КОГДА КонтролируемыеСделки.ТипПредметаСделки = ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.Товар)
	|			ТОГДА ЕСТЬNULL(КонтролируемыеСделки.ПредметСделки.КодТНВЭД, ЗНАЧЕНИЕ(Справочник.КлассификаторТНВЭД.ПустаяСсылка))
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.КлассификаторТНВЭД.ПустаяСсылка)
	|	КОНЕЦ КАК КодТНВЭД,
	|	ВЫБОР
	|		КОГДА КонтролируемыеСделки.ТипПредметаСделки = ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.Товар)
	|			ТОГДА ЕСТЬNULL(КонтролируемыеСделки.ПредметСделки.КодОКП, ЗНАЧЕНИЕ(Справочник.ОбщероссийскийКлассификаторПродукции.ПустаяСсылка))
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.ОбщероссийскийКлассификаторПродукции.ПустаяСсылка)
	|	КОНЕЦ КАК КодОКП,
	|	ВЫБОР
	|		КОГДА КонтролируемыеСделки.ТипПредметаСделки <> ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.Товар)
	|			ТОГДА ЕСТЬNULL(КонтролируемыеСделки.ПредметСделки.КодОКВЭД, ЗНАЧЕНИЕ(Справочник.КлассификаторВидовЭкономическойДеятельности.ПустаяСсылка))
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.КлассификаторВидовЭкономическойДеятельности.ПустаяСсылка)
	|	КОНЕЦ КАК КодОКВЭД,
	|	ВЫБОР
	|		КОГДА КонтролируемыеСделки.ТипПредметаСделки = ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.Товар)
	|			ТОГДА ЕСТЬNULL(КонтролируемыеСделки.ПредметСделки.КодОКПД2, ЗНАЧЕНИЕ(Справочник.КлассификаторОКПД2.ПустаяСсылка))
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.КлассификаторОКПД2.ПустаяСсылка)
	|	КОНЕЦ КАК КодОКПД2,
	|	ВЫБОР
	|		КОГДА КонтролируемыеСделки.ТипПредметаСделки <> ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.Товар)
	|			ТОГДА ЕСТЬNULL(КонтролируемыеСделки.ПредметСделки.КодОКВЭД2, ЗНАЧЕНИЕ(Справочник.КлассификаторОКВЭД2.ПустаяСсылка))
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.КлассификаторОКВЭД2.ПустаяСсылка)
	|	КОНЕЦ КАК КодОКВЭД2,
	|	КонтролируемыеСделки.СтранаПроисхожденияПредметаСделки КАК СтранаПроисхожденияПредметаСделки,
	|	ЕСТЬNULL(КонтролируемыеСделки.Договор.Дата, ДАТАВРЕМЯ(1, 1, 1)) КАК ДатаДоговора,
	|	ЕСТЬNULL(КонтролируемыеСделки.Договор.Номер, """") КАК НомерДоговора
	|ИЗ
	|	КонтролируемыеСделки КАК КонтролируемыеСделки
	|		ЛЕВОЕ СОЕДИНЕНИЕ КонтрагентыКонтролируемыеПоОбщейСумме КАК КонтрагентыКонтролируемыеПоОбщейСумме
	|		ПО КонтролируемыеСделки.ГоловнойКонтрагент = КонтрагентыКонтролируемыеПоОбщейСумме.ГоловнойКонтрагент
	|		ЛЕВОЕ СОЕДИНЕНИЕ КонтрагентыКонтролируемыеПоНДПИ КАК КонтрагентыКонтролируемыеПоНДПИ
	|		ПО КонтролируемыеСделки.ГоловнойКонтрагент = КонтрагентыКонтролируемыеПоНДПИ.ГоловнойКонтрагент
	|			И (КонтролируемыеСделки.СделкаКонтролируетсяПоНДПИ)
	|		ЛЕВОЕ СОЕДИНЕНИЕ КонтрагентыКонтролируемыеПоСпецРежиму КАК КонтрагентыКонтролируемыеПоСпецРежиму
	|		ПО КонтролируемыеСделки.ГоловнойКонтрагент = КонтрагентыКонтролируемыеПоСпецРежиму.ГоловнойКонтрагент
	|			И (КонтролируемыеСделки.СделкаОблагаетсяЕНВД
	|				ИЛИ КонтролируемыеСделки.СделкаСПлательщикомЕСХН)
	|		ЛЕВОЕ СОЕДИНЕНИЕ КонтрагентыКонтролируемыеПоПрибыли КАК КонтрагентыКонтролируемыеПоПрибыли
	|		ПО КонтролируемыеСделки.ГоловнойКонтрагент = КонтрагентыКонтролируемыеПоПрибыли.ГоловнойКонтрагент
	|			И (КонтролируемыеСделки.СделкаКонтролируетсяПоНалогуНаПрибыль)
	|		ЛЕВОЕ СОЕДИНЕНИЕ КонтрагентыКонтролируемыеПоОЭЗ КАК КонтрагентыКонтролируемыеПоОЭЗ
	|		ПО КонтролируемыеСделки.ГоловнойКонтрагент = КонтрагентыКонтролируемыеПоОЭЗ.ГоловнойКонтрагент
	|			И (КонтролируемыеСделки.СделкаКонтролируетсяПоРегистрацииВОЭЗ)
	|		ЛЕВОЕ СОЕДИНЕНИЕ КонтрагентыКонтролируемыеПоМорскомуМесторождению КАК КонтрагентыКонтролируемыеПоМорскомуМесторождению
	|		ПО КонтролируемыеСделки.ГоловнойКонтрагент = КонтрагентыКонтролируемыеПоМорскомуМесторождению.ГоловнойКонтрагент
	|			И (КонтролируемыеСделки.СделкаМорскогоМесторождения)
	|		ЛЕВОЕ СОЕДИНЕНИЕ КонтрагентыКонтролируемыеПоИнвестиционнымПроектам КАК КонтрагентыКонтролируемыеПоИнвестиционнымПроектам
	|		ПО КонтролируемыеСделки.ГоловнойКонтрагент = КонтрагентыКонтролируемыеПоИнвестиционнымПроектам.ГоловнойКонтрагент
	|			И (КонтролируемыеСделки.СделкаКонтролируетсяПоИнвестиционнымПроектам)
	|		ЛЕВОЕ СОЕДИНЕНИЕ КонтрагентыКонтролируемыеПоОсвобождениюНДС КАК КонтрагентыКонтролируемыеПоОсвобождениюНДС
	|		ПО КонтролируемыеСделки.ГоловнойКонтрагент = КонтрагентыКонтролируемыеПоОсвобождениюНДС.ГоловнойКонтрагент
	|			И (КонтролируемыеСделки.СделкаКонтролируетсяПоОсвобождениюНДС)
	|		ЛЕВОЕ СОЕДИНЕНИЕ КонтрагентыКонтролируемыеПоИнвестиционномуВычету КАК КонтрагентыКонтролируемыеПоИнвестиционномуВычету
	|		ПО КонтролируемыеСделки.ГоловнойКонтрагент = КонтрагентыКонтролируемыеПоИнвестиционномуВычету.ГоловнойКонтрагент
	|			И (КонтролируемыеСделки.СделкаКонтролируетсяПоИнвестиционномуВычету)
	|		ЛЕВОЕ СОЕДИНЕНИЕ КонтрагентыКонтролируемыеПоРегистрацииНеВРФ КАК КонтрагентыКонтролируемыеПоРегистрацииНеВРФ
	|		ПО КонтролируемыеСделки.ГоловнойКонтрагент = КонтрагентыКонтролируемыеПоРегистрацииНеВРФ.ГоловнойКонтрагент
	|			И (КонтролируемыеСделки.ЗарегистрированВСтранеСЛьготнымНалогообложением
	|				ИЛИ КонтролируемыеСделки.СделкаВнешнейТорговлиТоваромМировойБиржевойТорговли)
	|		ЛЕВОЕ СОЕДИНЕНИЕ КонтрагентыКонтролируемыеКакПрочиеЗависимыеЛица КАК КонтрагентыКонтролируемыеКакПрочиеЗависимыеЛица
	|		ПО КонтролируемыеСделки.ГоловнойКонтрагент = КонтрагентыКонтролируемыеКакПрочиеЗависимыеЛица.ГоловнойКонтрагент
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ДоговорыУчастниковКонтролируемыхСделок КАК ДоговорыУчастниковКонтролируемыхСделок
	|		ПО КонтролируемыеСделки.Организация = ДоговорыУчастниковКонтролируемыхСделок.Организация
	|			И КонтролируемыеСделки.Контрагент = ДоговорыУчастниковКонтролируемыхСделок.Контрагент
	|			И КонтролируемыеСделки.Договор = ДоговорыУчастниковКонтролируемыхСделок.ДоговорКонтрагента
	|ГДЕ
	|	КонтролируемыеСделки.ГоловнойКонтрагент В
	|			(ВЫБРАТЬ
	|				КонтрагентыПоМинимальнойСумме.ГоловнойКонтрагент
	|			ИЗ
	|				КонтрагентыПоМинимальнойСумме КАК КонтрагентыПоМинимальнойСумме)
	|	И (НЕ КонтрагентыКонтролируемыеКакПрочиеЗависимыеЛица.ГоловнойКонтрагент ЕСТЬ NULL
	|			ИЛИ НЕ КонтрагентыКонтролируемыеПоОбщейСумме.ГоловнойКонтрагент ЕСТЬ NULL
	|			ИЛИ НЕ КонтрагентыКонтролируемыеПоНДПИ.ГоловнойКонтрагент ЕСТЬ NULL
	|			ИЛИ НЕ КонтрагентыКонтролируемыеПоСпецРежиму.ГоловнойКонтрагент ЕСТЬ NULL
	|			ИЛИ НЕ КонтрагентыКонтролируемыеПоПрибыли.ГоловнойКонтрагент ЕСТЬ NULL
	|			ИЛИ НЕ КонтрагентыКонтролируемыеПоОЭЗ.ГоловнойКонтрагент ЕСТЬ NULL
	|			ИЛИ НЕ КонтрагентыКонтролируемыеПоМорскомуМесторождению.ГоловнойКонтрагент ЕСТЬ NULL
	|			ИЛИ НЕ КонтрагентыКонтролируемыеПоИнвестиционнымПроектам.ГоловнойКонтрагент ЕСТЬ NULL
	|			ИЛИ НЕ КонтрагентыКонтролируемыеПоОсвобождениюНДС.ГоловнойКонтрагент ЕСТЬ NULL
	|			ИЛИ НЕ КонтрагентыКонтролируемыеПоИнвестиционномуВычету.ГоловнойКонтрагент ЕСТЬ NULL
	|			ИЛИ НЕ КонтрагентыКонтролируемыеПоРегистрацииНеВРФ.ГоловнойКонтрагент ЕСТЬ NULL)
	|	И НЕ КонтролируемыеСделки.СделкаНеЯвляетсяКонтролируемойПоП4
	|
	|СГРУППИРОВАТЬ ПО
	|	КонтролируемыеСделки.Организация,
	|	КонтролируемыеСделки.Уведомление,
	|	КонтролируемыеСделки.ПериодСделки,
	|	КонтролируемыеСделки.ТипВзаимозависимости,
	|	КонтролируемыеСделки.Контрагент,
	|	КонтролируемыеСделки.ГоловнойКонтрагент,
	|	КонтролируемыеСделки.Договор,
	|	КонтролируемыеСделки.Валюта <> &ВалютаРегламентированногоУчета,
	|	КонтролируемыеСделки.Комиссионер <> ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка),
	|	КонтролируемыеСделки.Комиссионер,
	|	КонтролируемыеСделки.ПредметСделки,
	|	КонтролируемыеСделки.НаименованиеПредметаСделки,
	|	КонтролируемыеСделки.СтороныВзаимозависимыПоКодексу,
	|	КонтролируемыеСделки.СделкаВнешнейТорговлиТоваромМировойБиржевойТорговли,
	|	КонтролируемыеСделки.ЗарегистрированВСтранеСЛьготнымНалогообложением,
	|	КонтролируемыеСделки.СделкаСНезависимымПосредником,
	|	КонтролируемыеСделки.СуммаБезНДСВРублях,
	|	ВЫБОР
	|		КОГДА КонтролируемыеСделки.Валюта = &ВалютаРегламентированногоУчета
	|			ТОГДА КонтролируемыеСделки.СуммаБезНДСВРублях
	|		ИНАЧЕ КонтролируемыеСделки.СуммаБезНДСВВалютеРасчетов
	|	КОНЕЦ,
	|	КонтролируемыеСделки.КонтрагентЗарегистрированВРФ,
	|	НЕ КонтрагентыКонтролируемыеПоОбщейСумме.ГоловнойКонтрагент ЕСТЬ NULL
	|		И НЕ КонтрагентыКонтролируемыеПоОбщейСумме.ГоловнойКонтрагент ЕСТЬ NULL,
	|	НЕ КонтрагентыКонтролируемыеПоНДПИ.ГоловнойКонтрагент ЕСТЬ NULL
	|		И КонтролируемыеСделки.СделкаКонтролируетсяПоНДПИ,
	|	НЕ КонтрагентыКонтролируемыеПоСпецРежиму.ГоловнойКонтрагент ЕСТЬ NULL
	|		И (КонтролируемыеСделки.СделкаОблагаетсяЕНВД
	|			ИЛИ КонтролируемыеСделки.СделкаСПлательщикомЕСХН),
	|	НЕ КонтрагентыКонтролируемыеПоПрибыли.ГоловнойКонтрагент ЕСТЬ NULL
	|		И КонтролируемыеСделки.СделкаКонтролируетсяПоНалогуНаПрибыль,
	|	НЕ КонтрагентыКонтролируемыеПоОЭЗ.ГоловнойКонтрагент ЕСТЬ NULL
	|		И КонтролируемыеСделки.СделкаКонтролируетсяПоРегистрацииВОЭЗ,
	|	НЕ КонтрагентыКонтролируемыеПоМорскомуМесторождению.ГоловнойКонтрагент ЕСТЬ NULL
	|		И КонтролируемыеСделки.СделкаМорскогоМесторождения,
	|	НЕ КонтрагентыКонтролируемыеПоИнвестиционнымПроектам.ГоловнойКонтрагент ЕСТЬ NULL
	|		И КонтролируемыеСделки.СделкаКонтролируетсяПоИнвестиционнымПроектам,
	|	НЕ КонтрагентыКонтролируемыеПоОсвобождениюНДС.ГоловнойКонтрагент ЕСТЬ NULL
	|		И КонтролируемыеСделки.СделкаКонтролируетсяПоОсвобождениюНДС,
	|	НЕ КонтрагентыКонтролируемыеПоИнвестиционномуВычету.ГоловнойКонтрагент ЕСТЬ NULL
	|		И КонтролируемыеСделки.СделкаКонтролируетсяПоИнвестиционномуВычету,
	|	НЕ КонтрагентыКонтролируемыеПоРегистрацииНеВРФ.ГоловнойКонтрагент ЕСТЬ NULL
	|		И КонтролируемыеСделки.СделкаКонтролируетсяПоДополнительномуДоходуОтСырья,
	|	ВЫБОР
	|		КОГДА ЕСТЬNULL(ДоговорыУчастниковКонтролируемыхСделок.КодНаименованияСделки, """") = """"
	|			ТОГДА ВЫБОР
	|					КОГДА КонтролируемыеСделки.ТипПредметаСделки = ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.РаботаУслуга)
	|						ТОГДА ""019""
	|					ИНАЧЕ ""015""
	|				КОНЕЦ
	|		ИНАЧЕ ЕСТЬNULL(ДоговорыУчастниковКонтролируемыхСделок.КодНаименованияСделки, """")
	|	КОНЕЦ,
	|	ЕСТЬNULL(ДоговорыУчастниковКонтролируемыхСделок.СпособОпределенияЦеныСделки, ЗНАЧЕНИЕ(Справочник.СпособыОпределенияЦенКонтролируемыхСделок.ПустаяСсылка)),
	|	ВЫБОР
	|		КОГДА КонтролируемыеСделки.ТипПредметаСделки = ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.Товар)
	|			ТОГДА ЕСТЬNULL(ДоговорыУчастниковКонтролируемыхСделок.КодУсловийПоставки, """")
	|		ИНАЧЕ """"
	|	КОНЕЦ,
	|	КонтролируемыеСделки.ТипПредметаСделки,
	|	КонтролируемыеСделки.ЕдиницаИзмерения,
	|	КонтролируемыеСделки.ТипКонтролируемойСделки,
	|	КонтролируемыеСделки.Грузоотправитель,
	|	КонтролируемыеСделки.Грузополучатель,
	|	КонтролируемыеСделки.Валюта,
	|	КонтролируемыеСделки.РасчетныйДокумент,
	|	ВЫБОР
	|		КОГДА КонтролируемыеСделки.ТипПредметаСделки = ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.Товар)
	|			ТОГДА ЕСТЬNULL(КонтролируемыеСделки.ПредметСделки.КодТНВЭД, ЗНАЧЕНИЕ(Справочник.КлассификаторТНВЭД.ПустаяСсылка))
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.КлассификаторТНВЭД.ПустаяСсылка)
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА КонтролируемыеСделки.ТипПредметаСделки = ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.Товар)
	|			ТОГДА ЕСТЬNULL(КонтролируемыеСделки.ПредметСделки.КодОКП, ЗНАЧЕНИЕ(Справочник.ОбщероссийскийКлассификаторПродукции.ПустаяСсылка))
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.ОбщероссийскийКлассификаторПродукции.ПустаяСсылка)
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА КонтролируемыеСделки.ТипПредметаСделки <> ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.Товар)
	|			ТОГДА ЕСТЬNULL(КонтролируемыеСделки.ПредметСделки.КодОКВЭД, ЗНАЧЕНИЕ(Справочник.КлассификаторВидовЭкономическойДеятельности.ПустаяСсылка))
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.КлассификаторВидовЭкономическойДеятельности.ПустаяСсылка)
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА КонтролируемыеСделки.ТипПредметаСделки = ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.Товар)
	|			ТОГДА ЕСТЬNULL(КонтролируемыеСделки.ПредметСделки.КодОКПД2, ЗНАЧЕНИЕ(Справочник.КлассификаторОКПД2.ПустаяСсылка))
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.КлассификаторОКПД2.ПустаяСсылка)
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА КонтролируемыеСделки.ТипПредметаСделки <> ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.Товар)
	|			ТОГДА ЕСТЬNULL(КонтролируемыеСделки.ПредметСделки.КодОКВЭД2, ЗНАЧЕНИЕ(Справочник.КлассификаторОКВЭД2.ПустаяСсылка))
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.КлассификаторОКВЭД2.ПустаяСсылка)
	|	КОНЕЦ,
	|	КонтролируемыеСделки.СтранаПроисхожденияПредметаСделки,
	|	ЕСТЬNULL(КонтролируемыеСделки.Договор.Дата, ДАТАВРЕМЯ(1, 1, 1)),
	|	ЕСТЬNULL(КонтролируемыеСделки.Договор.Номер, """")
	|
	|УПОРЯДОЧИТЬ ПО
	|	Организация,
	|	ГоловнойКонтрагент,
	|	Контрагент,
	|	Договор,
	|	ПредметСделки,
	|	Строка121СтороныВзаимозависимыПоКодексу,
	|	Строка122СделкаВОбластиВнешнейТорговли,
	|	Строка123СделкаСКонтрагентомСЛьготнымНалогообложением,
	|	Строка124СделкаСНезависимымПосредником,
	|	ОснованиеКонтролируемости131,
	|	ОснованиеКонтролируемости132,
	|	ОснованиеКонтролируемости133,
	|	ОснованиеКонтролируемости134,
	|	ОснованиеКонтролируемости135,
	|	ОснованиеКонтролируемости136,
	|	ОснованиеКонтролируемости137,
	|	ОснованиеКонтролируемости138,
	|	ОснованиеКонтролируемости139,
	|	ОснованиеКонтролируемости140,
	|	КодНаименованияСделки,
	|	ТипВзаимозависимости,
	|	ТипПредметаСделки,
	|	НаименованиеПредметаСделки,
	|	ТипСделки";
	
	Возврат ТекстЗапроса;
	
КонецФункции

// Возвращает текст запроса формирования контролируемых сделок формата уведдомления 2019 года
// Возвращаемое значение:
//  Строка -  текст запроса формирования контролируемых сделок формата уведдомления 2019 года
//
Функция ТекстЗапросаФормированиеКонтролируемыхСделок2019()
	
	ТекстЗапроса =
	"ВЫБРАТЬ
	|	КонтролируемыеСделки.Организация КАК Организация,
	|	КонтролируемыеСделки.Уведомление КАК УведомлениеОКонтролируемойСделке,
	|	КонтролируемыеСделки.ПериодСделки КАК ДатаСовершенияСделки,
	|	КонтролируемыеСделки.ТипВзаимозависимости КАК ТипВзаимозависимости,
	|	КонтролируемыеСделки.Контрагент КАК Контрагент,
	|	КонтролируемыеСделки.ГоловнойКонтрагент КАК ГоловнойКонтрагент,
	|	КонтролируемыеСделки.Договор КАК Договор,
	|	КонтролируемыеСделки.Валюта <> &ВалютаРегламентированногоУчета КАК РасчетыВУсловныхЕдиницах,
	|	КонтролируемыеСделки.Комиссионер <> ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка) КАК СделкаСовершенаЧерезКомиссионера,
	|	КонтролируемыеСделки.Комиссионер КАК Комиссионер,
	|	КонтролируемыеСделки.ПредметСделки КАК ПредметСделки,
	|	КонтролируемыеСделки.НаименованиеПредметаСделки КАК НаименованиеПредметаСделки,
	|	КонтролируемыеСделки.СтороныВзаимозависимыПоКодексу КАК Строка121СтороныВзаимозависимыПоКодексу,
	|	КонтролируемыеСделки.СделкаВнешнейТорговлиТоваромМировойБиржевойТорговли КАК Строка122СделкаВОбластиВнешнейТорговли,
	|	КонтролируемыеСделки.ЗарегистрированВСтранеСЛьготнымНалогообложением КАК Строка123СделкаСКонтрагентомСЛьготнымНалогообложением,
	|	КонтролируемыеСделки.СделкаСНезависимымПосредником КАК Строка124СделкаСНезависимымПосредником,
	|	СУММА(КонтролируемыеСделки.СуммаБезНДСВРублях) КАК Стоимость,
	|	СУММА(ВЫБОР
	|		КОГДА КонтролируемыеСделки.Валюта = &ВалютаРегламентированногоУчета
	|			ТОГДА КонтролируемыеСделки.СуммаБезНДСВРублях
	|		ИНАЧЕ КонтролируемыеСделки.СуммаБезНДСВВалютеРасчетов
	|	КОНЕЦ) КАК СтоимостьВВалюте,
	|	КонтролируемыеСделки.КонтрагентЗарегистрированВРФ КАК КонтрагентЗарегистрированВРФ,
	|	НЕ КонтрагентыРФКонтролируемыеПоУсловию.ГоловнойКонтрагент ЕСТЬ NULL
	|		И КонтролируемыеСделки.СделкаКонтролируетсяПоРазнымСтавкамНалогаНаПрибыль КАК ОснованиеКонтролируемости131,
	|	НЕ КонтрагентыРФКонтролируемыеПоУсловию.ГоловнойКонтрагент ЕСТЬ NULL
	|		И КонтролируемыеСделки.СделкаКонтролируетсяПоНДПИ КАК ОснованиеКонтролируемости132,
	|	НЕ КонтрагентыРФКонтролируемыеПоУсловию.ГоловнойКонтрагент ЕСТЬ NULL
	|		И (КонтролируемыеСделки.СделкаОблагаетсяЕНВД
	|			ИЛИ КонтролируемыеСделки.СделкаСПлательщикомЕСХН) КАК ОснованиеКонтролируемости133,
	|	НЕ КонтрагентыРФКонтролируемыеПоУсловию.ГоловнойКонтрагент ЕСТЬ NULL
	|		И КонтролируемыеСделки.СделкаКонтролируетсяПоНалогуНаПрибыль КАК ОснованиеКонтролируемости134,
	|	НЕ КонтрагентыРФКонтролируемыеПоУсловию.ГоловнойКонтрагент ЕСТЬ NULL
	|		И КонтролируемыеСделки.СделкаМорскогоМесторождения КАК ОснованиеКонтролируемости135,
	|	НЕ КонтрагентыРФКонтролируемыеПоУсловию.ГоловнойКонтрагент ЕСТЬ NULL
	|		И КонтролируемыеСделки.СделкаКонтролируетсяПоОсвобождениюНДС КАК ОснованиеКонтролируемости136,
	|	НЕ КонтрагентыРФКонтролируемыеПоУсловию.ГоловнойКонтрагент ЕСТЬ NULL
	|		И КонтролируемыеСделки.СделкаКонтролируетсяПоИнвестиционномуВычету КАК ОснованиеКонтролируемости137,
	|	НЕ КонтрагентыРФКонтролируемыеПоУсловию.ГоловнойКонтрагент ЕСТЬ NULL
	|		И КонтролируемыеСделки.СделкаКонтролируетсяПоДополнительномуДоходуОтСырья КАК ОснованиеКонтролируемости138,
	|	ЛОЖЬ КАК ОснованиеКонтролируемости139,
	|	ЛОЖЬ КАК ОснованиеКонтролируемости140,
	|	ВЫБОР
	|		КОГДА ЕСТЬNULL(ДоговорыУчастниковКонтролируемыхСделок.КодНаименованияСделки, """") = """"
	|			ТОГДА ВЫБОР
	|					КОГДА КонтролируемыеСделки.ТипПредметаСделки = ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.РаботаУслуга)
	|						ТОГДА ""019""
	|					ИНАЧЕ ""015""
	|				КОНЕЦ
	|		ИНАЧЕ ЕСТЬNULL(ДоговорыУчастниковКонтролируемыхСделок.КодНаименованияСделки, """")
	|	КОНЕЦ КАК КодНаименованияСделки,
	|	ЕСТЬNULL(ДоговорыУчастниковКонтролируемыхСделок.СпособОпределенияЦеныСделки, ЗНАЧЕНИЕ(Справочник.СпособыОпределенияЦенКонтролируемыхСделок.ПустаяСсылка)) КАК СпособОпределенияЦеныСделки,
	|	ВЫБОР
	|		КОГДА КонтролируемыеСделки.ТипПредметаСделки = ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.Товар)
	|			ТОГДА ЕСТЬNULL(ДоговорыУчастниковКонтролируемыхСделок.КодУсловийПоставки, """")
	|		ИНАЧЕ """"
	|	КОНЕЦ КАК КодУсловийПоставки,
	|	КонтролируемыеСделки.ТипПредметаСделки КАК ТипПредметаСделки,
	|	КонтролируемыеСделки.ЕдиницаИзмерения КАК ЕдиницаИзмерения,
	|	КонтролируемыеСделки.ТипКонтролируемойСделки КАК ТипСделки,
	|	КонтролируемыеСделки.Грузоотправитель КАК Грузоотправитель,
	|	КонтролируемыеСделки.Грузополучатель КАК Грузополучатель,
	|	КонтролируемыеСделки.Валюта КАК Валюта,
	|	КонтролируемыеСделки.РасчетныйДокумент КАК РасчетныйДокумент,
	|	СУММА(КонтролируемыеСделки.Количество) КАК Количество,
	|	СРЕДНЕЕ(КонтролируемыеСделки.ПроцентнаяСтавка) КАК ПроцентнаяСтавка,
	|	МАКСИМУМ(КонтролируемыеСделки.ДатаПроцентнойСтавки) КАК ДатаПроцентнойСтавки,
	|	ВЫБОР
	|		КОГДА КонтролируемыеСделки.ТипПредметаСделки = ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.Товар)
	|			ТОГДА ЕСТЬNULL(КонтролируемыеСделки.ПредметСделки.КодТНВЭД, ЗНАЧЕНИЕ(Справочник.КлассификаторТНВЭД.ПустаяСсылка))
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.КлассификаторТНВЭД.ПустаяСсылка)
	|	КОНЕЦ КАК КодТНВЭД,
	|	ВЫБОР
	|		КОГДА КонтролируемыеСделки.ТипПредметаСделки = ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.Товар)
	|			ТОГДА ЕСТЬNULL(КонтролируемыеСделки.ПредметСделки.КодОКП, ЗНАЧЕНИЕ(Справочник.ОбщероссийскийКлассификаторПродукции.ПустаяСсылка))
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.ОбщероссийскийКлассификаторПродукции.ПустаяСсылка)
	|	КОНЕЦ КАК КодОКП,
	|	ВЫБОР
	|		КОГДА КонтролируемыеСделки.ТипПредметаСделки <> ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.Товар)
	|			ТОГДА ЕСТЬNULL(КонтролируемыеСделки.ПредметСделки.КодОКВЭД, ЗНАЧЕНИЕ(Справочник.КлассификаторВидовЭкономическойДеятельности.ПустаяСсылка))
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.КлассификаторВидовЭкономическойДеятельности.ПустаяСсылка)
	|	КОНЕЦ КАК КодОКВЭД,
	|	ВЫБОР
	|		КОГДА КонтролируемыеСделки.ТипПредметаСделки = ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.Товар)
	|			ТОГДА ЕСТЬNULL(КонтролируемыеСделки.ПредметСделки.КодОКПД2, ЗНАЧЕНИЕ(Справочник.КлассификаторОКПД2.ПустаяСсылка))
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.КлассификаторОКПД2.ПустаяСсылка)
	|	КОНЕЦ КАК КодОКПД2,
	|	ВЫБОР
	|		КОГДА КонтролируемыеСделки.ТипПредметаСделки <> ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.Товар)
	|			ТОГДА ЕСТЬNULL(КонтролируемыеСделки.ПредметСделки.КодОКВЭД2, ЗНАЧЕНИЕ(Справочник.КлассификаторОКВЭД2.ПустаяСсылка))
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.КлассификаторОКВЭД2.ПустаяСсылка)
	|	КОНЕЦ КАК КодОКВЭД2,
	|	КонтролируемыеСделки.СтранаПроисхожденияПредметаСделки КАК СтранаПроисхожденияПредметаСделки,
	|	ЕСТЬNULL(КонтролируемыеСделки.Договор.Дата, ДАТАВРЕМЯ(1, 1, 1)) КАК ДатаДоговора,
	|	ЕСТЬNULL(КонтролируемыеСделки.Договор.Номер, """") КАК НомерДоговора
	|ИЗ
	|	КонтролируемыеСделки КАК КонтролируемыеСделки
	|		ЛЕВОЕ СОЕДИНЕНИЕ КонтрагентыРФКонтролируемыеПоУсловию КАК КонтрагентыРФКонтролируемыеПоУсловию
	|		ПО КонтролируемыеСделки.ГоловнойКонтрагент = КонтрагентыРФКонтролируемыеПоУсловию.ГоловнойКонтрагент
	|			И (КонтролируемыеСделки.СделкаКонтролируетсяПоРазнымСтавкамНалогаНаПрибыль
	|				ИЛИ КонтролируемыеСделки.СделкаКонтролируетсяПоНДПИ
	|				ИЛИ КонтролируемыеСделки.СделкаОблагаетсяЕНВД
	|				ИЛИ КонтролируемыеСделки.СделкаСПлательщикомЕСХН
	|				ИЛИ КонтролируемыеСделки.СделкаКонтролируетсяПоНалогуНаПрибыль
	|				ИЛИ КонтролируемыеСделки.СделкаМорскогоМесторождения
	|				ИЛИ КонтролируемыеСделки.СделкаКонтролируетсяПоОсвобождениюНДС
	|				ИЛИ КонтролируемыеСделки.СделкаКонтролируетсяПоИнвестиционномуВычету
	|				ИЛИ КонтролируемыеСделки.СделкаКонтролируетсяПоДополнительномуДоходуОтСырья)
	|		ЛЕВОЕ СОЕДИНЕНИЕ КонтрагентыКонтролируемыеПоРегистрацииНеВРФ КАК КонтрагентыКонтролируемыеПоРегистрацииНеВРФ
	|		ПО КонтролируемыеСделки.ГоловнойКонтрагент = КонтрагентыКонтролируемыеПоРегистрацииНеВРФ.ГоловнойКонтрагент
	|			И (КонтролируемыеСделки.ЗарегистрированВСтранеСЛьготнымНалогообложением
	|				ИЛИ КонтролируемыеСделки.СделкаВнешнейТорговлиТоваромМировойБиржевойТорговли)
	|		ЛЕВОЕ СОЕДИНЕНИЕ КонтрагентыКонтролируемыеКакПрочиеЗависимыеЛица КАК КонтрагентыКонтролируемыеКакПрочиеЗависимыеЛица
	|		ПО КонтролируемыеСделки.ГоловнойКонтрагент = КонтрагентыКонтролируемыеКакПрочиеЗависимыеЛица.ГоловнойКонтрагент
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ДоговорыУчастниковКонтролируемыхСделок КАК ДоговорыУчастниковКонтролируемыхСделок
	|		ПО КонтролируемыеСделки.Организация = ДоговорыУчастниковКонтролируемыхСделок.Организация
	|			И КонтролируемыеСделки.Контрагент = ДоговорыУчастниковКонтролируемыхСделок.Контрагент
	|			И КонтролируемыеСделки.Договор = ДоговорыУчастниковКонтролируемыхСделок.ДоговорКонтрагента
	|ГДЕ
	|	КонтролируемыеСделки.ГоловнойКонтрагент В
	|			(ВЫБРАТЬ
	|				КонтрагентыПоМинимальнойСумме.ГоловнойКонтрагент
	|			ИЗ
	|				КонтрагентыПоМинимальнойСумме КАК КонтрагентыПоМинимальнойСумме)
	|	И (НЕ КонтрагентыРФКонтролируемыеПоУсловию.ГоловнойКонтрагент ЕСТЬ NULL
	|			ИЛИ НЕ КонтрагентыКонтролируемыеКакПрочиеЗависимыеЛица.ГоловнойКонтрагент ЕСТЬ NULL
	|			ИЛИ НЕ КонтрагентыКонтролируемыеПоРегистрацииНеВРФ.ГоловнойКонтрагент ЕСТЬ NULL)
	|	И НЕ КонтролируемыеСделки.СделкаНеЯвляетсяКонтролируемойПоП4
	|
	|СГРУППИРОВАТЬ ПО
	|	КонтролируемыеСделки.Организация,
	|	КонтролируемыеСделки.Уведомление,
	|	КонтролируемыеСделки.ПериодСделки,
	|	КонтролируемыеСделки.ТипВзаимозависимости,
	|	КонтролируемыеСделки.Контрагент,
	|	КонтролируемыеСделки.ГоловнойКонтрагент,
	|	КонтролируемыеСделки.Договор,
	|	КонтролируемыеСделки.Валюта <> &ВалютаРегламентированногоУчета,
	|	КонтролируемыеСделки.Комиссионер <> ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка),
	|	КонтролируемыеСделки.Комиссионер,
	|	КонтролируемыеСделки.ПредметСделки,
	|	КонтролируемыеСделки.НаименованиеПредметаСделки,
	|	КонтролируемыеСделки.СтороныВзаимозависимыПоКодексу,
	|	КонтролируемыеСделки.СделкаВнешнейТорговлиТоваромМировойБиржевойТорговли,
	|	КонтролируемыеСделки.ЗарегистрированВСтранеСЛьготнымНалогообложением,
	|	КонтролируемыеСделки.СделкаСНезависимымПосредником,
	|	КонтролируемыеСделки.КонтрагентЗарегистрированВРФ,
	|	НЕ КонтрагентыРФКонтролируемыеПоУсловию.ГоловнойКонтрагент ЕСТЬ NULL
	|		И КонтролируемыеСделки.СделкаКонтролируетсяПоРазнымСтавкамНалогаНаПрибыль,
	|	НЕ КонтрагентыРФКонтролируемыеПоУсловию.ГоловнойКонтрагент ЕСТЬ NULL
	|		И КонтролируемыеСделки.СделкаКонтролируетсяПоНДПИ,
	|	НЕ КонтрагентыРФКонтролируемыеПоУсловию.ГоловнойКонтрагент ЕСТЬ NULL
	|		И (КонтролируемыеСделки.СделкаОблагаетсяЕНВД
	|			ИЛИ КонтролируемыеСделки.СделкаСПлательщикомЕСХН),
	|	НЕ КонтрагентыРФКонтролируемыеПоУсловию.ГоловнойКонтрагент ЕСТЬ NULL
	|		И КонтролируемыеСделки.СделкаКонтролируетсяПоНалогуНаПрибыль,
	|	НЕ КонтрагентыРФКонтролируемыеПоУсловию.ГоловнойКонтрагент ЕСТЬ NULL
	|		И КонтролируемыеСделки.СделкаМорскогоМесторождения,
	|	НЕ КонтрагентыРФКонтролируемыеПоУсловию.ГоловнойКонтрагент ЕСТЬ NULL
	|		И КонтролируемыеСделки.СделкаКонтролируетсяПоОсвобождениюНДС,
	|	НЕ КонтрагентыРФКонтролируемыеПоУсловию.ГоловнойКонтрагент ЕСТЬ NULL
	|		И КонтролируемыеСделки.СделкаКонтролируетсяПоИнвестиционномуВычету,
	|	НЕ КонтрагентыРФКонтролируемыеПоУсловию.ГоловнойКонтрагент ЕСТЬ NULL
	|		И КонтролируемыеСделки.СделкаКонтролируетсяПоДополнительномуДоходуОтСырья,
	|	ВЫБОР
	|		КОГДА ЕСТЬNULL(ДоговорыУчастниковКонтролируемыхСделок.КодНаименованияСделки, """") = """"
	|			ТОГДА ВЫБОР
	|					КОГДА КонтролируемыеСделки.ТипПредметаСделки = ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.РаботаУслуга)
	|						ТОГДА ""019""
	|					ИНАЧЕ ""015""
	|				КОНЕЦ
	|		ИНАЧЕ ЕСТЬNULL(ДоговорыУчастниковКонтролируемыхСделок.КодНаименованияСделки, """")
	|	КОНЕЦ,
	|	ЕСТЬNULL(ДоговорыУчастниковКонтролируемыхСделок.СпособОпределенияЦеныСделки, ЗНАЧЕНИЕ(Справочник.СпособыОпределенияЦенКонтролируемыхСделок.ПустаяСсылка)),
	|	ВЫБОР
	|		КОГДА КонтролируемыеСделки.ТипПредметаСделки = ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.Товар)
	|			ТОГДА ЕСТЬNULL(ДоговорыУчастниковКонтролируемыхСделок.КодУсловийПоставки, """")
	|		ИНАЧЕ """"
	|	КОНЕЦ,
	|	КонтролируемыеСделки.ТипПредметаСделки,
	|	КонтролируемыеСделки.ЕдиницаИзмерения,
	|	КонтролируемыеСделки.ТипКонтролируемойСделки,
	|	КонтролируемыеСделки.Грузоотправитель,
	|	КонтролируемыеСделки.Грузополучатель,
	|	КонтролируемыеСделки.Валюта,
	|	КонтролируемыеСделки.РасчетныйДокумент,
	|	ВЫБОР
	|		КОГДА КонтролируемыеСделки.ТипПредметаСделки = ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.Товар)
	|			ТОГДА ЕСТЬNULL(КонтролируемыеСделки.ПредметСделки.КодТНВЭД, ЗНАЧЕНИЕ(Справочник.КлассификаторТНВЭД.ПустаяСсылка))
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.КлассификаторТНВЭД.ПустаяСсылка)
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА КонтролируемыеСделки.ТипПредметаСделки = ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.Товар)
	|			ТОГДА ЕСТЬNULL(КонтролируемыеСделки.ПредметСделки.КодОКП, ЗНАЧЕНИЕ(Справочник.ОбщероссийскийКлассификаторПродукции.ПустаяСсылка))
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.ОбщероссийскийКлассификаторПродукции.ПустаяСсылка)
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА КонтролируемыеСделки.ТипПредметаСделки <> ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.Товар)
	|			ТОГДА ЕСТЬNULL(КонтролируемыеСделки.ПредметСделки.КодОКВЭД, ЗНАЧЕНИЕ(Справочник.КлассификаторВидовЭкономическойДеятельности.ПустаяСсылка))
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.КлассификаторВидовЭкономическойДеятельности.ПустаяСсылка)
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА КонтролируемыеСделки.ТипПредметаСделки = ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.Товар)
	|			ТОГДА ЕСТЬNULL(КонтролируемыеСделки.ПредметСделки.КодОКПД2, ЗНАЧЕНИЕ(Справочник.КлассификаторОКПД2.ПустаяСсылка))
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.КлассификаторОКПД2.ПустаяСсылка)
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА КонтролируемыеСделки.ТипПредметаСделки <> ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.Товар)
	|			ТОГДА ЕСТЬNULL(КонтролируемыеСделки.ПредметСделки.КодОКВЭД2, ЗНАЧЕНИЕ(Справочник.КлассификаторОКВЭД2.ПустаяСсылка))
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.КлассификаторОКВЭД2.ПустаяСсылка)
	|	КОНЕЦ,
	|	КонтролируемыеСделки.СтранаПроисхожденияПредметаСделки,
	|	ЕСТЬNULL(КонтролируемыеСделки.Договор.Дата, ДАТАВРЕМЯ(1, 1, 1)),
	|	ЕСТЬNULL(КонтролируемыеСделки.Договор.Номер, """")
	|
	|УПОРЯДОЧИТЬ ПО
	|	Организация,
	|	ГоловнойКонтрагент,
	|	Контрагент,
	|	Договор,
	|	ПредметСделки,
	|	Строка121СтороныВзаимозависимыПоКодексу,
	|	Строка122СделкаВОбластиВнешнейТорговли,
	|	Строка123СделкаСКонтрагентомСЛьготнымНалогообложением,
	|	Строка124СделкаСНезависимымПосредником,
	|	ОснованиеКонтролируемости131,
	|	ОснованиеКонтролируемости132,
	|	ОснованиеКонтролируемости133,
	|	ОснованиеКонтролируемости134,
	|	ОснованиеКонтролируемости135,
	|	ОснованиеКонтролируемости136,
	|	ОснованиеКонтролируемости137,
	|	ОснованиеКонтролируемости138,
	|	ОснованиеКонтролируемости139,
	|	ОснованиеКонтролируемости140,
	|	КодНаименованияСделки,
	|	ТипВзаимозависимости,
	|	ТипПредметаСделки,
	|	НаименованиеПредметаСделки,
	|	ТипСделки";
	
	Возврат ТекстЗапроса;
	
КонецФункции

// Возвращает таблицу значений сопуствующий услуг контролируемой сделки.
//
// Параметры:
//  Уведомление - ДокументСсылка.УведомлениеОКонтролируемыхСделках - уведомление.
// 
// Возвращаемое значение:
//  ТаблицаЗначений - сопуствующие услуги контролируемой сделки.
//
Функция СопутствующиеУслугиКонтролируемыхСделок(Уведомление)
	
	Запрос = Новый Запрос();
	Запрос.УстановитьПараметр("УведомлениеОКонтролируемойСделке", Уведомление);
	Запрос.Текст =
	"ВЫБРАТЬ
	|	СопутствующиеУслугиКонтролируемойСделки.Контрагент КАК КонтрагентСделки,
	|	СопутствующиеУслугиКонтролируемойСделки.ДоговорКонтрагента КАК ДоговорКонтрагентаСделки,
	|	СопутствующиеУслугиКонтролируемойСделки.ПредметСделки КАК ПредметСделки,
	|	СопутствующиеУслугиКонтролируемойСделки.РасчетныйДокумент КАК РасчетныйДокументСделки,
	|	СопутствующиеУслугиКонтролируемойСделкиСопутствующиеУслуги.НомерСтроки КАК НомерСтроки,
	|	СопутствующиеУслугиКонтролируемойСделкиСопутствующиеУслуги.НаименованиеУслуги КАК НаименованиеУслуги,
	|	СопутствующиеУслугиКонтролируемойСделкиСопутствующиеУслуги.Контрагент КАК Контрагент,
	|	СопутствующиеУслугиКонтролируемойСделкиСопутствующиеУслуги.УчастникиВзаимозависимы КАК УчастникиВзаимозависимы,
	|	СопутствующиеУслугиКонтролируемойСделкиСопутствующиеУслуги.Валюта КАК Валюта,
	|	СопутствующиеУслугиКонтролируемойСделкиСопутствующиеУслуги.Стоимость КАК Стоимость
	|ИЗ
	|	Документ.СопутствующиеУслугиКонтролируемойСделки КАК СопутствующиеУслугиКонтролируемойСделки
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.СопутствующиеУслугиКонтролируемойСделки.СопутствующиеУслуги КАК СопутствующиеУслугиКонтролируемойСделкиСопутствующиеУслуги
	|		ПО СопутствующиеУслугиКонтролируемойСделки.Ссылка = СопутствующиеУслугиКонтролируемойСделкиСопутствующиеУслуги.Ссылка
	|ГДЕ
	|	СопутствующиеУслугиКонтролируемойСделки.УведомлениеОКонтролируемойСделке = &УведомлениеОКонтролируемойСделке
	|	И СопутствующиеУслугиКонтролируемойСделки.Проведен
	|
	|УПОРЯДОЧИТЬ ПО
	|	Контрагент,
	|	ДоговорКонтрагента,
	|	ПредметСделки,
	|	СопутствующиеУслугиКонтролируемойСделки.Ссылка,
	|	СопутствующиеУслугиКонтролируемойСделкиСопутствующиеУслуги.НомерСтроки";
	
	СопутствующиеУслугиКонтролируемыхСделок = Запрос.Выполнить().Выгрузить();
	СопутствующиеУслугиКонтролируемыхСделок.Индексы.Добавить("КонтрагентСделки,ДоговорКонтрагентаСделки,ПредметСделки");
	
	Возврат СопутствующиеУслугиКонтролируемыхСделок;
	
КонецФункции

// Возвращает таблицу значений цепочек создания стоимости контролируемой сделки.
//
// Параметры:
//  Уведомление - ДокументСсылка.УведомлениеОКонтролируемыхСделках - уведомление.
// 
// Возвращаемое значение:
//  ТаблицаЗначений - цепочки создания стоимости контролируемой сделки.
//
Функция ЦепочкиСозданияСтоимости(Уведомление)
	
	Запрос = Новый Запрос();
	Запрос.УстановитьПараметр("УведомлениеОКонтролируемойСделке", Уведомление);
	Запрос.Текст =
	"ВЫБРАТЬ
	|	ЦепочкаСозданияСтоимостиКонтролируемойСделки.Контрагент КАК КонтрагентСделки,
	|	ЦепочкаСозданияСтоимостиКонтролируемойСделки.ДоговорКонтрагента КАК ДоговорКонтрагентаСделки,
	|	ЦепочкаСозданияСтоимостиКонтролируемойСделки.ПредметСделки КАК ПредметСделки,
	|	ЦепочкаСозданияСтоимостиКонтролируемойСделки.РасчетныйДокумент КАК РасчетныйДокументСделки,
	|	ЦепочкаСозданияСтоимостиКонтролируемойСделки.ТипСделки КАК ТипЛиста,
	|	ЦепочкаСозданияСтоимостиКонтролируемойСделки.Ссылка КАК Цепочка,
	|	СопутствующиеУслугиКонтролируемойСделкиСделки.НомерСтроки КАК УровеньЦепочки,
	|	СопутствующиеУслугиКонтролируемойСделкиСделки.ИспользованиеПроисхождениеТовара КАК ИспользованиеПроисхождениеТовара,
	|	СопутствующиеУслугиКонтролируемойСделкиСделки.НаименованиеИспользованияПроисхожденияТовара КАК НаименованиеИспользованияПроисхожденияТовара,
	|	СопутствующиеУслугиКонтролируемойСделкиСделки.ПризнакУчастникаСделки КАК ПризнакУчастникаСделки,
	|	СопутствующиеУслугиКонтролируемойСделкиСделки.ДатаСовершенияСделки КАК ДатаСовершенияСделки,
	|	СопутствующиеУслугиКонтролируемойСделкиСделки.Контрагент КАК Контрагент,
	|	СопутствующиеУслугиКонтролируемойСделкиСделки.УчастникиВзаимозависимы КАК УчастникиВзаимозависимы,
	|	СопутствующиеУслугиКонтролируемойСделкиСделки.НомерДоговора КАК НомерДоговора,
	|	СопутствующиеУслугиКонтролируемойСделкиСделки.ДатаДоговора КАК ДатаДоговора,
	|	СопутствующиеУслугиКонтролируемойСделкиСделки.КодУсловийПоставки КАК КодУсловийПоставки,
	|	СопутствующиеУслугиКонтролируемойСделкиСделки.СтранаСовершенияСделки КАК СтранаСовершенияСделки,
	|	СопутствующиеУслугиКонтролируемойСделкиСделки.ОКТМОСовершенияСделки КАК ОКТМОСовершенияСделки,
	|	СопутствующиеУслугиКонтролируемойСделкиСделки.Количество КАК Количество,
	|	СопутствующиеУслугиКонтролируемойСделкиСделки.ЕдиницаИзмерения КАК ЕдиницаИзмерения,
	|	СопутствующиеУслугиКонтролируемойСделкиСделки.Цена КАК Цена,
	|	СопутствующиеУслугиКонтролируемойСделкиСделки.Валюта КАК Валюта,
	|	СопутствующиеУслугиКонтролируемойСделкиСделки.Стоимость КАК Стоимость,
	|	ЕСТЬNULL(ДанныеПервичныхДокументов.ДатаРегистратора, ЦепочкаСозданияСтоимостиКонтролируемойСделки.Дата) КАК ДатаРасчетногоДокументаСделки
	|ИЗ
	|	Документ.ЦепочкаСозданияСтоимостиКонтролируемойСделки КАК ЦепочкаСозданияСтоимостиКонтролируемойСделки
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ЦепочкаСозданияСтоимостиКонтролируемойСделки.Сделки КАК СопутствующиеУслугиКонтролируемойСделкиСделки
	|		ПО ЦепочкаСозданияСтоимостиКонтролируемойСделки.Ссылка = СопутствующиеУслугиКонтролируемойСделкиСделки.Ссылка
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ДанныеПервичныхДокументов КАК ДанныеПервичныхДокументов
	|		ПО ЦепочкаСозданияСтоимостиКонтролируемойСделки.РасчетныйДокумент = ДанныеПервичныхДокументов.Документ
	|			И ЦепочкаСозданияСтоимостиКонтролируемойСделки.Организация = ДанныеПервичныхДокументов.Организация
	|ГДЕ
	|	ЦепочкаСозданияСтоимостиКонтролируемойСделки.УведомлениеОКонтролируемойСделке = &УведомлениеОКонтролируемойСделке
	|	И ЦепочкаСозданияСтоимостиКонтролируемойСделки.Проведен
	|
	|УПОРЯДОЧИТЬ ПО
	|	Контрагент,
	|	ЦепочкаСозданияСтоимостиКонтролируемойСделки.ДоговорКонтрагента,
	|	ПредметСделки,
	|	ЦепочкаСозданияСтоимостиКонтролируемойСделки.ТипСделки,
	|	ЦепочкаСозданияСтоимостиКонтролируемойСделки.Ссылка,
	|	СопутствующиеУслугиКонтролируемойСделкиСделки.НомерСтроки";
	
	ЦепочкиСозданияСтоимости = Запрос.Выполнить().Выгрузить();
	ЦепочкиСозданияСтоимости.Индексы.Добавить("КонтрагентСделки,ДоговорКонтрагентаСделки,ПредметСделки");
	
	Возврат ЦепочкиСозданияСтоимости;
	
КонецФункции

// Возвращает строку исключений заполнения листа 1А согласно версии уведомления.
// 
// Параметры:
//  ВерсияУведомления - Число - код версии уведомления о контролируемых сделках.
// Возвращаемое значение:
//  Строка            - строка исключений, разделенных запятыми, для заполнения листа 1А согласно версии уведомления.
//
Функция ИсключенияЗаполненияЛиста1А(ВерсияУведомления)
	
	ИсключенияДляЗаполненияЛиста1А = Новый Массив;
	
	Если ВерсияУведомления < КонтролируемыеСделкиКлиентСервер.ВерсияУведомления_2018() Тогда
		// Все показатели Листа 1А и 1Б уведомления о контролируемых сделках выводятся в рублях.
		// Поэтому из сделки валюта не переносится - она устанавливается при записи документа - всегда в валюту регламентированного учета.
		ИсключенияДляЗаполненияЛиста1А.Добавить("Валюта");
	КонецЕсли;
	
	Если ВерсияУведомления = КонтролируемыеСделкиКлиентСервер.ВерсияУведомления_2012() Тогда
		ИсключенияДляЗаполненияЛиста1А.Добавить("КодОКПД2");
		ИсключенияДляЗаполненияЛиста1А.Добавить("КодОКВЭД2");
	Иначе
		ИсключенияДляЗаполненияЛиста1А.Добавить("КодОКП");
		ИсключенияДляЗаполненияЛиста1А.Добавить("КодОКВЭД");
	КонецЕсли;
	
	Возврат СтрСоединить(ИсключенияДляЗаполненияЛиста1А, ",");
	
КонецФункции

// Возвращает строку исключений заполнения листа 1Б согласно версии уведомления.
// 
// Параметры:
//  ВерсияУведомления - Число - код версии уведомления о контролируемых сделках.
//  ТипПредметаСделки - ПеречислениеСсылка.ТипыПредметовКонтролируемыхСделок - тип предмета контролируемой сделки.
// Возвращаемое значение:
//  Строка            - строка исключений, разделенных запятыми, для заполнения листа 1А согласно версии уведомления.
//
Функция ИсключенияЗаполненияЛиста1Б(ВерсияУведомления, ТипПредметаСделки)
	
	ИсключенияДляЗаполненияЛиста1Б = Новый Массив;
	
	Если ВерсияУведомления < КонтролируемыеСделкиКлиентСервер.ВерсияУведомления_2018()
		Или ТипПредметаСделки <> Перечисления.ТипыПредметовКонтролируемыхСделок.ДолговоеОбязательство Тогда
		ИсключенияДляЗаполненияЛиста1Б.Добавить("ПроцентнаяСтавка");
	КонецЕсли;
	
	Возврат СтрСоединить(ИсключенияДляЗаполненияЛиста1Б, ",");
	
КонецФункции

// Заполняет дату совершения сделки в строке таблицы значений.
// 
// Параметры:
//  Сделка               - СтрокаТаблицыЗначений - описание параметров контролируемой сделки.
//  ВерсияУведомления    - Число - код версии уведомления о контролируемых сделках.
//  ТипПредметаСделки    - ПеречислениеСсылка.ТипыПредметовКонтролируемыхСделок - тип предмета контролируемой сделки.
//  ДатаПроцентнойСтавки - Дата - дата процентной ставки.
//
Процедура ЗаполнитьДатуСделкиДолговыхОбязательств(Сделка, ВерсияУведомления, ТипПредметаСделки, ДатаПроцентнойСтавки)
	
	Если ВерсияУведомления >= КонтролируемыеСделкиКлиентСервер.ВерсияУведомления_2018()
		И ТипПредметаСделки = Перечисления.ТипыПредметовКонтролируемыхСделок.ДолговоеОбязательство Тогда
		Сделка.ДатаСовершенияСделки = ДатаПроцентнойСтавки;
	КонецЕсли;
	
КонецПроцедуры

// Заполняет таблицу значений сделок листа 1А.
// Параметры:
//  Лист1А        - ДокументОбъект.КонтролируемаяСделка - контролирумая сделка листа 1А.
//  ТаблицаСделок - ТаблицаЗначений - таблица значений параметров сделок.
//  ПараметрыЗаполнения - Структура - параметры заполнения уведомления:
//  * Версия                                - Число - код версии уведомления о контролируемых сделках.
//  * ИсключенияДляЗаполненияЛиста1А        - Строка - наименования реквизитов, через запятую,
//                                                     которые не нужно заполнять в листе 1А.
//  * КешАдресныхДанных                     - Соответствие из КлючИЗначение - соответствие адресных данных в кеш.
//  * КлючевыеПоля                          - Структура - параметры ключевый полей уведомления:
//   * ГородОтправкиТовара                           - Неопределено - заготовка для ввода информации.
//   * ГородСовершенияСделки                         - Неопределено - заготовка для ввода информации.
//   * ЕдиницаИзмерения                              - Неопределено - заготовка для ввода информации.
//   * КодРегионаОтправкиТовара                      - Неопределено - заготовка для ввода информации.
//   * КодРегионаСовершенияСделки                    - Неопределено - заготовка для ввода информации.
//   * КодУсловийПоставки                            - Неопределено - заготовка для ввода информации.
//   * НаселенныйПунктОтправкиТовара                 - Неопределено - заготовка для ввода информации.
//   * НаселенныйПунктСовершенияСделки               - Неопределено - заготовка для ввода информации.
//   * ОКТМОСовершенияСделки                         - Неопределено - заготовка для ввода информации.
//   * ПроцентнаяСтавка                              - Неопределено - заготовка для ввода информации.
//   * СтранаОтправкиТовара                          - Неопределено - заготовка для ввода информации.
//   * СтранаСовершенияСделки                        - Неопределено - заготовка для ввода информации.
//   * СуммаБазыДляРасчетаРоялти                     - Неопределено - заготовка для ввода информации.
//   * Цена                                          - Неопределено - заготовка для ввода информации.
//  * КлючевыеПоляЦепочкиСозданияСтоимости - Структура - ключевые поля цепочки создания стоимости:
//    * Валюта                                       - Неопределено - заготовка для ввода информации.
//    * ДатаДоговора                                 - Неопределено - заготовка для ввода информации.
//    * ДатаСовершенияСделки                         - Неопределено - заготовка для ввода информации.
//    * ЕдиницаИзмерения                             - Неопределено - заготовка для ввода информации.
//    * ИспользованиеПроисхождениеТовара             - Неопределено - заготовка для ввода информации.
//    * КодУсловийПоставки                           - Неопределено - заготовка для ввода информации.
//    * Контрагент                                   - Неопределено - заготовка для ввода информации.
//    * НаименованиеИспользованияПроисхожденияТовара - Неопределено - заготовка для ввода информации.
//    * НомерДоговора                                - Неопределено - заготовка для ввода информации.
//    * ОКТМОСовершенияСделки                        - Неопределено - заготовка для ввода информации.
//    * ПризнакУчастникаСделки                       - Неопределено - заготовка для ввода информации.
//    * СтранаСовершенияСделки                       - Неопределено - заготовка для ввода информации.
//    * УчастникиВзаимозависимы                      - Неопределено - заготовка для ввода информации.
//    * Цена                                         - Неопределено - заготовка для ввода информации.
//  * ПолеОпределенияСтоимостиДляРасчетаЦены         - Строка - наименование поля для определения 
//                                                     стоимости для расчета цены.
//  * СопутствующиеУслуги                            - ТаблицаЗначений - описание сопуствующих услуг сделки.
//  * СписокКодовСторонСделки                        - Соответствие из КлючИЗначение - соответвие списка кодов и
//                                                     наименования строн сделки, Значение имеет
//                                                     тип из СписокЗначений из Строка.
//  * СтрокаСверткиТаблицыСделок                     - Строка - наименования колонок перечисленных через запятую. 
//  * Уведомление                                    - ДокументСсылка.УведомлениеОКонтролируемыхСделках - уведомление.
//  * ЦепочкиСозданияСтоимости                       - ТаблицаЗначений - описание цепочек создания стоимости.
//
Процедура ЗаполнитьТаблицуСделокЛиста1А(Лист1А, ТаблицаСделок, ПараметрыЗаполнения)
	
	СписокПолейСделки = ПараметрыЗаполнения.СтрокаСверткиТаблицыСделок;
	ТаблицаСделок.Свернуть(СписокПолейСделки + ", РасчетныйДокумент", "Количество, Стоимость, СтоимостьДляРасчетаЦены");
	Если Лист1А.ТипПредметаСделки <> Перечисления.ТипыПредметовКонтролируемыхСделок.ДолговоеОбязательство Тогда
		Для Каждого Сделка Из ТаблицаСделок Цикл
			Сделка.Цена = ?(Сделка.Количество = 0, Сделка.СтоимостьДляРасчетаЦены, 
							Окр(Сделка.СтоимостьДляРасчетаЦены/Сделка.Количество, 2));
		КонецЦикла;
	КонецЕсли;
	
	ТаблицаСделок.Сортировать("ДатаСовершенияСделки");
	
	Листы1Б = ТаблицаСделок.СкопироватьКолонки();
	Листы1Б.Колонки.Добавить("ИдентификаторЛиста1Б", Новый ОписаниеТипов("УникальныйИдентификатор"));
	
	ИдентификаторыЛистовРасчетныхДокументов = Новый Соответствие;
	
	СделкаДокумента = Неопределено;
	Для Каждого Сделка Из ТаблицаСделок Цикл
		Если (Сделка.Количество <> 0) ИЛИ (Сделка.Стоимость <> 0) ИЛИ (Сделка.ПроцентнаяСтавка <> 0) Тогда
			
			Если СделкаДокумента = Неопределено 
				ИЛИ Лист1А.ТипПредметаСделки <> Перечисления.ТипыПредметовКонтролируемыхСделок.Товар
				ИЛИ НЕ СделкиСовпадают(СделкаДокумента, Сделка, ПараметрыЗаполнения.КлючевыеПоля) Тогда
				СделкаДокумента = Листы1Б.Добавить();
				СделкаДокумента.ИдентификаторЛиста1Б = Новый УникальныйИдентификатор();
				ЗаполнитьЗначенияСвойств(СделкаДокумента, Сделка, , "Количество, Стоимость");
			КонецЕсли;
			ИдентификаторыЛистовРасчетныхДокументов.Вставить(Сделка.РасчетныйДокумент,
				СделкаДокумента.ИдентификаторЛиста1Б);
			СделкаДокумента.Количество = СделкаДокумента.Количество + Сделка.Количество;
			СделкаДокумента.Стоимость = СделкаДокумента.Стоимость + Сделка.Стоимость;
			СделкаДокумента.ДатаСовершенияСделки = Сделка.ДатаСовершенияСделки;
		КонецЕсли;
	КонецЦикла;
	
	Лист1А.Сделки.Загрузить(Листы1Б);
	Лист1А.СвязьЛистов1Би1В.Очистить();
	
	Лист1А.Листы1В.Очистить();
	Лист1А.Листы1Г.Очистить();
	
	Если Лист1А.УказыватьСведенияЦепочкиСозданияСтоимости
		И Лист1А.ТипПредметаСделки = Перечисления.ТипыПредметовКонтролируемыхСделок.Товар Тогда
		
		ЗаполнитьЛисты1В(Лист1А, ИдентификаторыЛистовРасчетныхДокументов, ПараметрыЗаполнения);
		
		ЗаполнитьЛисты1Г(Лист1А, ИдентификаторыЛистовРасчетныхДокументов, ПараметрыЗаполнения);
		
	КонецЕсли;
	
КонецПроцедуры

// Заполняет информацию по листам 1В уведомления по контролируемым сделкам.
// 
// Параметры:
//  Лист1А                                  - ДокументОбъект.КонтролируемаяСделка - контролирумая сделка листа 1А.
//  ИдентификаторыЛистовРасчетныхДокументов - Соответствие из КлючИЗначение - соответствие с ключом типа ДокументСсылка
//                                                                           и значением типа УникальныйИдентификатор.
//  ПараметрыЗаполнения - Структура - параметры заполнения уведомления:
//  * Версия                                - Число - код версии уведомления о контролируемых сделках.
//  * ИсключенияДляЗаполненияЛиста1А        - Строка - наименования реквизитов, через запятую,
//                                                     которые не нужно заполнять в листе 1А.
//  * КешАдресныхДанных                     - Соответствие из КлючИЗначение - соответствие адресных данных в кеш.
//  * КлючевыеПоля                          - Структура - параметры ключевый полей уведомления:
//   * ГородОтправкиТовара                           - Неопределено - заготовка для ввода информации.
//   * ГородСовершенияСделки                         - Неопределено - заготовка для ввода информации.
//   * ЕдиницаИзмерения                              - Неопределено - заготовка для ввода информации.
//   * КодРегионаОтправкиТовара                      - Неопределено - заготовка для ввода информации.
//   * КодРегионаСовершенияСделки                    - Неопределено - заготовка для ввода информации.
//   * КодУсловийПоставки                            - Неопределено - заготовка для ввода информации.
//   * НаселенныйПунктОтправкиТовара                 - Неопределено - заготовка для ввода информации.
//   * НаселенныйПунктСовершенияСделки               - Неопределено - заготовка для ввода информации.
//   * ОКТМОСовершенияСделки                         - Неопределено - заготовка для ввода информации.
//   * ПроцентнаяСтавка                              - Неопределено - заготовка для ввода информации.
//   * СтранаОтправкиТовара                          - Неопределено - заготовка для ввода информации.
//   * СтранаСовершенияСделки                        - Неопределено - заготовка для ввода информации.
//   * СуммаБазыДляРасчетаРоялти                     - Неопределено - заготовка для ввода информации.
//   * Цена                                          - Неопределено - заготовка для ввода информации.
//  * КлючевыеПоляЦепочкиСозданияСтоимости - Структура - ключевые поля цепочки создания стоимости:
//    * Валюта                                       - Неопределено - заготовка для ввода информации.
//    * ДатаДоговора                                 - Неопределено - заготовка для ввода информации.
//    * ДатаСовершенияСделки                         - Неопределено - заготовка для ввода информации.
//    * ЕдиницаИзмерения                             - Неопределено - заготовка для ввода информации.
//    * ИспользованиеПроисхождениеТовара             - Неопределено - заготовка для ввода информации.
//    * КодУсловийПоставки                           - Неопределено - заготовка для ввода информации.
//    * Контрагент                                   - Неопределено - заготовка для ввода информации.
//    * НаименованиеИспользованияПроисхожденияТовара - Неопределено - заготовка для ввода информации.
//    * НомерДоговора                                - Неопределено - заготовка для ввода информации.
//    * ОКТМОСовершенияСделки                        - Неопределено - заготовка для ввода информации.
//    * ПризнакУчастникаСделки                       - Неопределено - заготовка для ввода информации.
//    * СтранаСовершенияСделки                       - Неопределено - заготовка для ввода информации.
//    * УчастникиВзаимозависимы                      - Неопределено - заготовка для ввода информации.
//    * Цена                                         - Неопределено - заготовка для ввода информации.
//  * ПолеОпределенияСтоимостиДляРасчетаЦены         - Строка - наименование поля для определения 
//                                                     стоимости для расчета цены.
//  * СопутствующиеУслуги                            - ТаблицаЗначений - описание сопуствующих услуг сделки.
//  * СписокКодовСторонСделки                        - Соответствие из КлючИЗначение - соответвие списка кодов и
//                                                     наименования строн сделки, Значение имеет
//                                                     тип из СписокЗначений из Строка.
//  * СтрокаСверткиТаблицыСделок                     - Строка - наименования колонок перечисленных через запятую. 
//  * Уведомление                                    - ДокументСсылка.УведомлениеОКонтролируемыхСделках - уведомление.
//  * ЦепочкиСозданияСтоимости                       - ТаблицаЗначений - описание цепочек создания стоимости.
//
Процедура ЗаполнитьЛисты1В(Лист1А, ИдентификаторыЛистовРасчетныхДокументов, ПараметрыЗаполнения)
	
	ОтборПоСделке = Новый Структура();
	ОтборПоСделке.Вставить("КонтрагентСделки", Лист1А.Контрагент);
	ОтборПоСделке.Вставить("ДоговорКонтрагентаСделки", Лист1А.Договор);
	ОтборПоСделке.Вставить("ПредметСделки", Лист1А.ПредметСделки);
	
	// Т.к. НайтиСтроки не гарантирует сохранение порядка строк исходной таблицы, поэтому
	// заполним отдельную таблицу для сортировки и отсортируем ее правильно.
	
	ТаблицаЦепочекЛиста1А = ПараметрыЗаполнения.ЦепочкиСозданияСтоимости.СкопироватьКолонки(
		"КонтрагентСделки,ДоговорКонтрагентаСделки,ПредметСделки,РасчетныйДокументСделки,ДатаРасчетногоДокументаСделки,ТипЛиста,Цепочка,УровеньЦепочки");
	ТаблицаЦепочекЛиста1А.Колонки.Добавить("СортировкаТипаЛиста", ОбщегоНазначения.ОписаниеТипаЧисло(1, 0));
	ТаблицаЦепочекЛиста1А.Колонки.Добавить("СтрокаЦепочки");
	
	СтрокиЦепочки = ПараметрыЗаполнения.ЦепочкиСозданияСтоимости.НайтиСтроки(ОтборПоСделке);
	Для Каждого СтрокаЦепочки Из СтрокиЦепочки Цикл
		СтрокаЦепочки1А = ТаблицаЦепочекЛиста1А.Добавить();
		ЗаполнитьЗначенияСвойств(СтрокаЦепочки1А, СтрокаЦепочки);
		СтрокаЦепочки1А.СтрокаЦепочки = СтрокаЦепочки;
		СтрокаЦепочки1А.СортировкаТипаЛиста = ?(СтрокаЦепочки1А.ТипЛиста = Перечисления.ТипыСделокВЦепочкеКонтролируемыхСделок.ПредшествующаяПокупка, 0, 1);
	КонецЦикла;
	
	ПустойИдентификатор = ОбщегоНазначенияКлиентСервер.ПустойУникальныйИдентификатор();
	ИдентификаторПредыдущегоЛиста1В = ПустойИдентификатор;
	
	ТаблицаЦепочекЛиста1А.Сортировать("СортировкаТипаЛиста,ДатаРасчетногоДокументаСделки,Цепочка,УровеньЦепочки",
		Новый СравнениеЗначений());
	Для Каждого СтрокаЦепочкиЛиста1А Из ТаблицаЦепочекЛиста1А Цикл
		
		ИдентификаторЛиста1Б = ИдентификаторыЛистовРасчетныхДокументов.Получить(СтрокаЦепочкиЛиста1А.РасчетныйДокументСделки);
		Если ИдентификаторЛиста1Б = Неопределено Тогда
			// Этого расчетного документа нет среди листов 1Б.
			// Поэтому эти строки пропускаем.
			Продолжить;
		КонецЕсли;
		
		Если СтрокаЦепочкиЛиста1А.УровеньЦепочки = 1 Тогда
			ИдентификаторПредыдущегоЛиста1В = ПустойИдентификатор;
		КонецЕсли;
		
		СтрокаЦепочки = СтрокаЦепочкиЛиста1А.СтрокаЦепочки;
		
		ДанныеЛиста1В = НайтиСоздатьЛист1В(Лист1А, ИдентификаторЛиста1Б, ИдентификаторПредыдущегоЛиста1В, СтрокаЦепочки, ПараметрыЗаполнения);
		ДанныеЛиста1В.Количество = ДанныеЛиста1В.Количество + СтрокаЦепочки.Количество;
		ДанныеЛиста1В.Стоимость = ДанныеЛиста1В.Стоимость + СтрокаЦепочки.Стоимость;
		
		ИдентификаторПредыдущегоЛиста1В = ДанныеЛиста1В.ИдентификаторЛиста1В;
		
	КонецЦикла;
	
	Для Каждого СтрокаЦепочки Из СтрокиЦепочки Цикл
		ПараметрыЗаполнения.ЦепочкиСозданияСтоимости.Удалить(СтрокаЦепочки);
	КонецЦикла;
	
КонецПроцедуры

// Находит существующий или создает новый лист 1В.
// 
// Параметры:
//  Лист1А                                  - ДокументОбъект.КонтролируемаяСделка - контролирумая сделка листа 1А.
//  ИдентификаторЛиста1Б                    - УникальныйИдентификатор - уникальный иденифкатор листа 1Б.
//  ИдентификаторПредыдущегоЛиста1В         - УникальныйИдентификатор - уникальный иденифкатор листа 1В.
//  СтрокаЦепочки                           - СтрокаТаблицыЗначений - строка цепочки создания стоимости сделки.
//  ИдентификаторыЛистовРасчетныхДокументов - Соответствие из КлючИЗначение - соответствие с ключом типа ДокументСсылка
//                                                                           и значением типа УникальныйИдентификатор.
//  ПараметрыЗаполнения - Структура - параметры заполнения уведомления:
//  * Версия                                - Число - код версии уведомления о контролируемых сделках.
//  * ИсключенияДляЗаполненияЛиста1А        - Строка - наименования реквизитов, через запятую,
//                                                     которые не нужно заполнять в листе 1А.
//  * КешАдресныхДанных                     - Соответствие из КлючИЗначение - соответствие адресных данных в кеш.
//  * КлючевыеПоля                          - Структура - параметры ключевый полей уведомления:
//   * ГородОтправкиТовара                           - Неопределено - заготовка для ввода информации.
//   * ГородСовершенияСделки                         - Неопределено - заготовка для ввода информации.
//   * ЕдиницаИзмерения                              - Неопределено - заготовка для ввода информации.
//   * КодРегионаОтправкиТовара                      - Неопределено - заготовка для ввода информации.
//   * КодРегионаСовершенияСделки                    - Неопределено - заготовка для ввода информации.
//   * КодУсловийПоставки                            - Неопределено - заготовка для ввода информации.
//   * НаселенныйПунктОтправкиТовара                 - Неопределено - заготовка для ввода информации.
//   * НаселенныйПунктСовершенияСделки               - Неопределено - заготовка для ввода информации.
//   * ОКТМОСовершенияСделки                         - Неопределено - заготовка для ввода информации.
//   * ПроцентнаяСтавка                              - Неопределено - заготовка для ввода информации.
//   * СтранаОтправкиТовара                          - Неопределено - заготовка для ввода информации.
//   * СтранаСовершенияСделки                        - Неопределено - заготовка для ввода информации.
//   * СуммаБазыДляРасчетаРоялти                     - Неопределено - заготовка для ввода информации.
//   * Цена                                          - Неопределено - заготовка для ввода информации.
//  * КлючевыеПоляЦепочкиСозданияСтоимости - Структура - ключевые поля цепочки создания стоимости:
//    * Валюта                                       - Неопределено - заготовка для ввода информации.
//    * ДатаДоговора                                 - Неопределено - заготовка для ввода информации.
//    * ДатаСовершенияСделки                         - Неопределено - заготовка для ввода информации.
//    * ЕдиницаИзмерения                             - Неопределено - заготовка для ввода информации.
//    * ИспользованиеПроисхождениеТовара             - Неопределено - заготовка для ввода информации.
//    * КодУсловийПоставки                           - Неопределено - заготовка для ввода информации.
//    * Контрагент                                   - Неопределено - заготовка для ввода информации.
//    * НаименованиеИспользованияПроисхожденияТовара - Неопределено - заготовка для ввода информации.
//    * НомерДоговора                                - Неопределено - заготовка для ввода информации.
//    * ОКТМОСовершенияСделки                        - Неопределено - заготовка для ввода информации.
//    * ПризнакУчастникаСделки                       - Неопределено - заготовка для ввода информации.
//    * СтранаСовершенияСделки                       - Неопределено - заготовка для ввода информации.
//    * УчастникиВзаимозависимы                      - Неопределено - заготовка для ввода информации.
//    * Цена                                         - Неопределено - заготовка для ввода информации.
//  * ПолеОпределенияСтоимостиДляРасчетаЦены         - Строка - наименование поля для определения 
//                                                     стоимости для расчета цены.
//  * СопутствующиеУслуги                            - ТаблицаЗначений - описание сопуствующих услуг сделки.
//  * СписокКодовСторонСделки                        - Соответствие из КлючИЗначение - соответвие списка кодов и
//                                                     наименования строн сделки, Значение имеет
//                                                     тип из СписокЗначений из Строка.
//  * СтрокаСверткиТаблицыСделок                     - Строка - наименования колонок перечисленных через запятую. 
//  * Уведомление                                    - ДокументСсылка.УведомлениеОКонтролируемыхСделках - уведомление.
//  * ЦепочкиСозданияСтоимости                       - ТаблицаЗначений - описание цепочек создания стоимости.
// 
// Возвращаемое значение:
//  ДокументТабличнаяЧастьСтрока.КонтролируемаяСделка.Листы1В - строка Листа1В.
//
Функция НайтиСоздатьЛист1В(Лист1А, ИдентификаторЛиста1Б, ИдентификаторПредыдущегоЛиста1В, СтрокаЦепочки, ПараметрыЗаполнения)
	
	Для Каждого СтрокаЛиста1В Из Лист1А.Листы1В Цикл
		Если СделкиСовпадают(СтрокаЛиста1В, СтрокаЦепочки, ПараметрыЗаполнения.КлючевыеПоляЦепочкиСозданияСтоимости)
			И СтрокаЛиста1В.ИдентификаторЛиста1Б = ИдентификаторЛиста1Б
			И СтрокаЛиста1В.ИдентификаторПредыдущегоЛиста1В = ИдентификаторПредыдущегоЛиста1В Тогда
			Возврат СтрокаЛиста1В;
		КонецЕсли;
	КонецЦикла;
	
	СтрокаЛиста1В = Лист1А.Листы1В.Добавить();
	СтрокаЛиста1В.ИдентификаторЛиста1В = Новый УникальныйИдентификатор;
	СтрокаЛиста1В.ИдентификаторЛиста1Б = ИдентификаторЛиста1Б;
	СтрокаЛиста1В.ИдентификаторПредыдущегоЛиста1В = ИдентификаторПредыдущегоЛиста1В;
	ЗаполнитьЗначенияСвойств(СтрокаЛиста1В, СтрокаЦепочки, ,"Количество,Стоимость");
	Возврат СтрокаЛиста1В;
	
КонецФункции

// Заполняет информацию по листам 1В уведомления по контролируемым сделкам.
// 
// Параметры:
//  Лист1А                                  - ДокументОбъект.КонтролируемаяСделка - контролирумая сделка листа 1А.
//  ИдентификаторыЛистовРасчетныхДокументов - Соответствие из КлючИЗначение - соответствие с ключом типа ДокументСсылка
//                                                                           и значением типа УникальныйИдентификатор.
//  ПараметрыЗаполнения - Структура - параметры заполнения уведомления:
//  * Версия                                - Число - код версии уведомления о контролируемых сделках.
//  * ИсключенияДляЗаполненияЛиста1А        - Строка - наименования реквизитов, через запятую,
//                                                     которые не нужно заполнять в листе 1А.
//  * КешАдресныхДанных                     - Соответствие из КлючИЗначение - соответствие адресных данных в кеш.
//  * КлючевыеПоля                          - Структура - параметры ключевый полей уведомления:
//   * ГородОтправкиТовара                           - Неопределено - заготовка для ввода информации.
//   * ГородСовершенияСделки                         - Неопределено - заготовка для ввода информации.
//   * ЕдиницаИзмерения                              - Неопределено - заготовка для ввода информации.
//   * КодРегионаОтправкиТовара                      - Неопределено - заготовка для ввода информации.
//   * КодРегионаСовершенияСделки                    - Неопределено - заготовка для ввода информации.
//   * КодУсловийПоставки                            - Неопределено - заготовка для ввода информации.
//   * НаселенныйПунктОтправкиТовара                 - Неопределено - заготовка для ввода информации.
//   * НаселенныйПунктСовершенияСделки               - Неопределено - заготовка для ввода информации.
//   * ОКТМОСовершенияСделки                         - Неопределено - заготовка для ввода информации.
//   * ПроцентнаяСтавка                              - Неопределено - заготовка для ввода информации.
//   * СтранаОтправкиТовара                          - Неопределено - заготовка для ввода информации.
//   * СтранаСовершенияСделки                        - Неопределено - заготовка для ввода информации.
//   * СуммаБазыДляРасчетаРоялти                     - Неопределено - заготовка для ввода информации.
//   * Цена                                          - Неопределено - заготовка для ввода информации.
//  * КлючевыеПоляЦепочкиСозданияСтоимости - Структура - ключевые поля цепочки создания стоимости:
//    * Валюта                                       - Неопределено - заготовка для ввода информации.
//    * ДатаДоговора                                 - Неопределено - заготовка для ввода информации.
//    * ДатаСовершенияСделки                         - Неопределено - заготовка для ввода информации.
//    * ЕдиницаИзмерения                             - Неопределено - заготовка для ввода информации.
//    * ИспользованиеПроисхождениеТовара             - Неопределено - заготовка для ввода информации.
//    * КодУсловийПоставки                           - Неопределено - заготовка для ввода информации.
//    * Контрагент                                   - Неопределено - заготовка для ввода информации.
//    * НаименованиеИспользованияПроисхожденияТовара - Неопределено - заготовка для ввода информации.
//    * НомерДоговора                                - Неопределено - заготовка для ввода информации.
//    * ОКТМОСовершенияСделки                        - Неопределено - заготовка для ввода информации.
//    * ПризнакУчастникаСделки                       - Неопределено - заготовка для ввода информации.
//    * СтранаСовершенияСделки                       - Неопределено - заготовка для ввода информации.
//    * УчастникиВзаимозависимы                      - Неопределено - заготовка для ввода информации.
//    * Цена                                         - Неопределено - заготовка для ввода информации.
//  * ПолеОпределенияСтоимостиДляРасчетаЦены         - Строка - наименование поля для определения 
//                                                     стоимости для расчета цены.
//  * СопутствующиеУслуги                            - ТаблицаЗначений - описание сопуствующих услуг сделки.
//  * СписокКодовСторонСделки                        - Соответствие из КлючИЗначение - соответвие списка кодов и
//                                                     наименования строн сделки, Значение имеет
//                                                     тип из СписокЗначений из Строка.
//  * СтрокаСверткиТаблицыСделок                     - Строка - наименования колонок перечисленных через запятую. 
//  * Уведомление                                    - ДокументСсылка.УведомлениеОКонтролируемыхСделках - уведомление.
//  * ЦепочкиСозданияСтоимости                       - ТаблицаЗначений - описание цепочек создания стоимости.
//
Процедура ЗаполнитьЛисты1Г(Лист1А, ИдентификаторыЛистовРасчетныхДокументов, ПараметрыЗаполнения)
	
	ОтборПоСделке = Новый Структура();
	ОтборПоСделке.Вставить("КонтрагентСделки", Лист1А.Контрагент);
	ОтборПоСделке.Вставить("ДоговорКонтрагентаСделки", Лист1А.Договор);
	ОтборПоСделке.Вставить("ПредметСделки", Лист1А.ПредметСделки);
	
	СтрокиСопутствующихУслуг = ПараметрыЗаполнения.СопутствующиеУслуги.НайтиСтроки(ОтборПоСделке);
	Для Каждого СтрокаСопутствующейУслуги Из СтрокиСопутствующихУслуг Цикл
		
		ИдентификаторЛиста1БРасчетногоДокумента = ИдентификаторыЛистовРасчетныхДокументов.Получить(СтрокаСопутствующейУслуги.РасчетныйДокументСделки);
		Если ИдентификаторЛиста1БРасчетногоДокумента = Неопределено Тогда
			Продолжить;
		КонецЕсли;
		
		ДанныеЛиста1Г = Лист1А.Листы1Г.Добавить();
		ДанныеЛиста1Г.ИдентификаторЛиста1Б = ИдентификаторЛиста1БРасчетногоДокумента;
		ЗаполнитьЗначенияСвойств(ДанныеЛиста1Г, СтрокаСопутствующейУслуги,
			"НаименованиеУслуги,УчастникиВзаимозависимы,Контрагент,Валюта,Стоимость");
		
		ПараметрыЗаполнения.СопутствующиеУслуги.Удалить(СтрокаСопутствующейУслуги);
		
	КонецЦикла;
	
КонецПроцедуры

// Заполняет дату совершения сделки в строке таблицы значений.
// 
// Параметры:
//  Сделка1                - СтрокаТаблицыЗначений - описание параметров контролируемой сделки.
//  Сделка2                - СтрокаТаблицыЗначений - описание параметров контролируемой сделки.
//  СтруктураКлючевыхПолей - Структура - описание ключевых полей сделки.
// Возвращаемое значение:
//  Булево     - заполненный согласно номеру лист уведомления.
//
Функция СделкиСовпадают(Сделка1, Сделка2, СтруктураКлючевыхПолей)
	
	Для Каждого Поле Из СтруктураКлючевыхПолей Цикл
		Если Сделка1[Поле.Ключ] <> Сделка2[Поле.Ключ] Тогда
			Возврат Ложь;
		КонецЕсли;
	КонецЦикла;
	Возврат Истина;
	
КонецФункции

// Устанавливает пометку удаления для сделок, включнных в уведомление.
//
// Параметры:
//  Уведомление - ДокументСсылка.УведомлениеОКонтролируемыхСделках - уведомление о контролируемых сделках.
//
Функция ПометитьНаУдалениеКонтролируемыеСделкиУведомления(Уведомление)
	
	ТаблицаСделок = Новый ТаблицаЗначений();
	ТаблицаСделок.Колонки.Добавить("Сделка", Новый ОписаниеТипов("ДокументСсылка.КонтролируемаяСделка"));
	ТаблицаСделок.Колонки.Добавить("Используется", Новый ОписаниеТипов("Булево"));
	
	РеквизитыСделки = Метаданные.Документы.КонтролируемаяСделка.Реквизиты;
	Для Каждого Реквизит Из РеквизитыСделки Цикл
		ТаблицаСделок.Колонки.Добавить(Реквизит.Имя, Новый ОписаниеТипов(Реквизит.Тип));
	КонецЦикла;
	
	ДокументыСделок = Документы.КонтролируемаяСделка.Выбрать( , , Новый Структура("УведомлениеОКонтролируемойСделке", Уведомление));
	Пока ДокументыСделок.Следующий() Цикл
		ДокументСделка = ДокументыСделок.ПолучитьОбъект();
		СтрокаСделок = ТаблицаСделок.Добавить();
		ЗаполнитьЗначенияСвойств(СтрокаСделок, ДокументСделка);
		СтрокаСделок.Сделка = ДокументСделка.Ссылка;
		ДокументСделка.УстановитьПометкуУдаления(Истина);
	КонецЦикла;
	
	ТаблицаСделок.Индексы.Добавить("Контрагент, Договор, ПредметСделки, Используется");
	
	Возврат ТаблицаСделок;
	
КонецФункции

// Проверяет совпадает ли ключ сделки.
//
// Параметры:
//  Сделка - СтрокаТаблицыЗначений - данные о сделке.
//  КлючСделки - Структура - данные ключа сделки.
//
// Возвращаемое значение:
//  Булево - Истина, если ключ сделки совпадает.
//
Функция КлючСделкиСовпадает(Сделка, КлючСделки) 
	
	Для Каждого Ключ Из КлючСделки Цикл
		Если Сделка[Ключ.Ключ] <> Ключ.Значение Тогда
			Возврат Ложь;
		КонецЕсли;
	КонецЦикла;
	
	Возврат Истина;
	
КонецФункции

// Таблица сделок.
// 
// Возвращаемое значение:
//  ТаблицаЗначений - Таблица сделок
Функция ТаблицаСделок()
	
	ОписаниеТиповРасчетныхДокументов = 
		Метаданные.РегистрыНакопления.КонтролируемыеСделкиОрганизаций.Измерения.РасчетныйДокумент.Тип;
	ОписаниеТиповПредметовСделки = 
		Метаданные.РегистрыНакопления.КонтролируемыеСделкиОрганизаций.Измерения.ПредметСделки.Тип;
	ОписаниеТиповДоговора = 
		Метаданные.РегистрыНакопления.КонтролируемыеСделкиОрганизаций.Измерения.Договор.Тип;
	ОписаниеТиповСоглашения = 
		Метаданные.РегистрыНакопления.КонтролируемыеСделкиОрганизаций.Измерения.Соглашение.Тип;
	ОписаниеГрузоотправителя = 
		Метаданные.РегистрыНакопления.КонтролируемыеСделкиОрганизаций.Реквизиты.Грузоотправитель.Тип;
	ОписаниеГрузополучателя  = 
		Метаданные.РегистрыНакопления.КонтролируемыеСделкиОрганизаций.Реквизиты.Грузополучатель.Тип;
	ОписаниеКонтрагента =
		Метаданные.РегистрыНакопления.КонтролируемыеСделкиОрганизаций.Измерения.Контрагент.Тип;
	
	ТаблицаСделок = Новый ТаблицаЗначений();
	ТаблицаСделок.Колонки.Добавить("Период", Новый ОписаниеТипов("Дата", , , Новый КвалификаторыДаты(ЧастиДаты.ДатаВремя)));
	ТаблицаСделок.Колонки.Добавить("Организация", Новый ОписаниеТипов("СправочникСсылка.Организации"));
	ТаблицаСделок.Колонки.Добавить("Контрагент", ОписаниеКонтрагента);
	ТаблицаСделок.Колонки.Добавить("Договор", ОписаниеТиповДоговора);
	ТаблицаСделок.Колонки.Добавить("Соглашение", ОписаниеТиповСоглашения);
	ТаблицаСделок.Колонки.Добавить("Комиссионер", ОписаниеКонтрагента);
	ТаблицаСделок.Колонки.Добавить("РасчетныйДокумент", ОписаниеТиповРасчетныхДокументов);
	ТаблицаСделок.Колонки.Добавить("ПредметСделки", ОписаниеТиповПредметовСделки);
	ТаблицаСделок.Колонки.Добавить("ТипПредметаСделки", Новый ОписаниеТипов("ПеречислениеСсылка.ТипыПредметовКонтролируемыхСделок"));
	ТаблицаСделок.Колонки.Добавить("НаименованиеПредметаСделки", Новый ОписаниеТипов("Строка", , Новый КвалификаторыСтроки(512)));
	ТаблицаСделок.Колонки.Добавить("ЕдиницаИзмерения", Новый ОписаниеТипов("СправочникСсылка.УпаковкиЕдиницыИзмерения"));
	ТаблицаСделок.Колонки.Добавить("СтранаПроисхожденияПредметаСделки", Новый ОписаниеТипов("СправочникСсылка.СтраныМира"));
	ТаблицаСделок.Колонки.Добавить("ХозяйственнаяОперация", Новый ОписаниеТипов("ПеречислениеСсылка.ХозяйственныеОперацииКонтролируемыхСделок"));
	ТаблицаСделок.Колонки.Добавить("Валюта", Новый ОписаниеТипов("СправочникСсылка.Валюты"));
	ТаблицаСделок.Колонки.Добавить("Количество", Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(15,3)));
	ТаблицаСделок.Колонки.Добавить("СтавкаНДС", Новый ОписаниеТипов("СправочникСсылка.СтавкиНДС"));
	ТаблицаСделок.Колонки.Добавить("ЦенаВРублях", ОбщегоНазначенияУТ.ОписаниеТипаДенежногоПоля());
	ТаблицаСделок.Колонки.Добавить("СуммаБезНДСВРублях", ОбщегоНазначенияУТ.ОписаниеТипаДенежногоПоля());
	ТаблицаСделок.Колонки.Добавить("СуммаНДСВРублях", ОбщегоНазначенияУТ.ОписаниеТипаДенежногоПоля());
	ТаблицаСделок.Колонки.Добавить("СуммаБезНДСВВалютеРасчетов", ОбщегоНазначенияУТ.ОписаниеТипаДенежногоПоля());
	ТаблицаСделок.Колонки.Добавить("СуммаНДСВВалютеРасчетов", ОбщегоНазначенияУТ.ОписаниеТипаДенежногоПоля());
	ТаблицаСделок.Колонки.Добавить("ВсегоВВалютеРасчетов", ОбщегоНазначенияУТ.ОписаниеТипаДенежногоПоля());
	ТаблицаСделок.Колонки.Добавить("ТипКонтролируемойСделки", Новый ОписаниеТипов("ПеречислениеСсылка.ТипыКонтролируемыхСделок"));
	ТаблицаСделок.Колонки.Добавить("ТоварМировойБиржевойТорговли", Новый ОписаниеТипов("Булево"));
	ТаблицаСделок.Колонки.Добавить("ОперацияОблагаетсяЕНВД", Новый ОписаниеТипов("Булево"));
	ТаблицаСделок.Колонки.Добавить("ПроцентнаяСтавка", Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(7,4)));
	ТаблицаСделок.Колонки.Добавить("ДатаПроцентнойСтавки", Новый ОписаниеТипов("Дата", , , Новый КвалификаторыДаты(ЧастиДаты.Дата)));
	
	ТаблицаСделок.Колонки.Добавить("Грузоотправитель", ОписаниеГрузоотправителя);
	ТаблицаСделок.Колонки.Добавить("Грузополучатель", ОписаниеГрузополучателя);
	
	Возврат ТаблицаСделок;
	
КонецФункции

// Зполняет данные адреса сделки.
//
//
// Параметры:
//  СведенияОСделке    - СтрокаТаблицыЗначений - парамерты сведений о сделке.
//  Грузоотправитель   - СправочникСсылка.Контрагенты, СправочникСсылка.Организации - грузоотправитель.
//  Грузополучатель    - СправочникСсылка.Контрагенты, СправочникСсылка.Организации - грузополучатель.
//  ПараметрыЗаполнения - Структура - параметры заполнения уведомления:
//  * Версия                                 - Число - код версии уведомления о контролируемых сделках.
//  * ИсключенияДляЗаполненияЛиста1А         - Строка - наименования реквизитов, через запятую,
//                                             которые не нужно заполнять в листе 1А.
//  * КешАдресныхДанных                      - Соответствие из КлючИЗначение- соответствие адресных данных в кеш.
//  * КлючевыеПоля                           - Структура - структура ключевый полей уведомления.
//  * КлючевыеПоляЦепочкиСозданияСтоимости   - Структура - структура ключевый полей цепочки создания стоимости.
//  * ПолеОпределенияСтоимостиДляРасчетаЦены - Строка - наименование поля определения расчета цены.
//  * СопутствующиеУслуги                    - ТаблицаЗначений - описание сопутствующих услуг сделки.
//  * СписокКодовСторонСделки                - Соответствие из КлючИЗначение - соответвие списка кодов и
//                                             наименования строн сделки, Значение имеет тип СписокЗначений из Строка.
//  * СтрокаСверткиТаблицыСделок             - Строка - строка из наименований колонок перечисленных через запятую. 
//  * Уведомление                            - ДокументСсылка.УведомлениеОКонтролируемыхСделках - уведомление.
//  * ЦепочкиСозданияСтоимости               - ТаблицаЗначений - описание цепочек создания стоимости.
//
Процедура ЗаполнитьАдресаСделки(СведенияОСделке, Грузоотправитель, Грузополучатель, ПараметрыЗаполнения)
	
	Если ПараметрыЗаполнения.Версия < КонтролируемыеСделкиКлиентСервер.ВерсияУведомления_2024() Тогда
		
		ПараметрыАдресаГрузоотправителя = ПолучитьПараметрыАдресаСделки(Грузоотправитель, СведенияОСделке.ДатаСовершенияСделки);
		Если ПараметрыАдресаГрузоотправителя <> Неопределено Тогда
			СведенияОСделке.СтранаОтправкиТовара = ПараметрыАдресаГрузоотправителя.Страна;
			СведенияОСделке.КодРегионаОтправкиТовара = ПараметрыАдресаГрузоотправителя.КодРегиона;
			Если ПараметрыЗаполнения.Версия < КонтролируемыеСделкиКлиентСервер.ВерсияУведомления_2018() Тогда
				СведенияОСделке.ГородОтправкиТовара = ПараметрыАдресаГрузоотправителя.Город;
				СведенияОСделке.НаселенныйПунктОтправкиТовара = ПараметрыАдресаГрузоотправителя.НаселенныйПункт;
			Иначе
				ЧастиНаселенногоПункта = Новый Массив;
				Если ЗначениеЗаполнено(ПараметрыАдресаГрузоотправителя.Город) Тогда
					ЧастиНаселенногоПункта.Добавить(ПараметрыАдресаГрузоотправителя.Город);
				КонецЕсли;
				Если ЗначениеЗаполнено(ПараметрыАдресаГрузоотправителя.НаселенныйПункт) Тогда
					ЧастиНаселенногоПункта.Добавить(ПараметрыАдресаГрузоотправителя.НаселенныйПункт);
				КонецЕсли;
				СведенияОСделке.НаселенныйПунктОтправкиТовара = СтрСоединить(ЧастиНаселенногоПункта, ", ");
			КонецЕсли;
		КонецЕсли;
		
		ПараметрыАдресаГрузополучателя = ПолучитьПараметрыАдресаСделки(Грузополучатель, СведенияОСделке.ДатаСовершенияСделки);
		Если ПараметрыАдресаГрузополучателя <> Неопределено Тогда
			
			СведенияОСделке.СтранаСовершенияСделки = ПараметрыАдресаГрузополучателя.Страна;
			СведенияОСделке.КодРегионаСовершенияСделки = ПараметрыАдресаГрузополучателя.КодРегиона;
			Если ПараметрыЗаполнения.Версия < КонтролируемыеСделкиКлиентСервер.ВерсияУведомления_2018() Тогда
				СведенияОСделке.ГородСовершенияСделки = ПараметрыАдресаГрузополучателя.Город;
				СведенияОСделке.НаселенныйПунктСовершенияСделки = ПараметрыАдресаГрузополучателя.НаселенныйПункт;
			Иначе
				ЧастиНаселенногоПункта = Новый Массив;
				Если ЗначениеЗаполнено(ПараметрыАдресаГрузополучателя.Город) Тогда
					ЧастиНаселенногоПункта.Добавить(ПараметрыАдресаГрузополучателя.Город);
				КонецЕсли;
				Если ЗначениеЗаполнено(ПараметрыАдресаГрузополучателя.НаселенныйПункт) Тогда
					ЧастиНаселенногоПункта.Добавить(ПараметрыАдресаГрузополучателя.НаселенныйПункт);
				КонецЕсли;
				СведенияОСделке.НаселенныйПунктСовершенияСделки = СтрСоединить(ЧастиНаселенногоПункта, ", ");
			КонецЕсли;
		КонецЕсли;
		
	Иначе
		
		ПараметрыАдресаГрузополучателя = ПараметрыАдресаСделки2024(Грузополучатель,
			ПараметрыЗаполнения.КешАдресныхДанных, СведенияОСделке.ДатаСовершенияСделки);
		Если ПараметрыАдресаГрузополучателя <> Неопределено Тогда
			СведенияОСделке.ОКТМОСовершенияСделки = ПараметрыАдресаГрузополучателя.ОКТМО;
			СведенияОСделке.НаселенныйПунктСовершенияСделки = ПараметрыАдресаГрузополучателя.НаселенныйПункт;
		КонецЕсли;
		
	КонецЕсли;
	
КонецПроцедуры

// Возвращает виды контактной информации объекта.
//
// Параметры:
//  Объект               - СправочникСсылка.Организации, СправочникСсылка.Контрагенты - контрагент, для которого
//                         необходимо определить контактную информацию.
// Возвращаемое значение:
//  СправочникСсылка.ВидыКонтактнойИнформации - вид контактной информации.
//  Неопределено                              - если вид контактной информации невозможно определить.
Функция ВидАдресаКонтактнойИнформации(Объект)
	
	Если ТипЗнч(Объект) = Тип("СправочникСсылка.Организации") Тогда
		Возврат Справочники.ВидыКонтактнойИнформации.ФактАдресОрганизации;
	ИначеЕсли ТипЗнч(Объект) = Тип("СправочникСсылка.Контрагенты") Тогда
		Возврат Справочники.ВидыКонтактнойИнформации.ФактАдресКонтрагента;
	Иначе
		Возврат Неопределено;
	КонецЕсли;
	
КонецФункции

// Возвращает параметры адреса сделки на запрашиваемую дату.
//
// Параметры:
//  Объект               - СправочникСсылка.Организации, СправочникСсылка.Контрагенты - контрагент, для которого 
//                                                                                      необходимо определить адрес.
//  ДатаСовершенияСделки - Дата - дата, на которору необходимо определить адрес контрагента.
// Возвращаемое значение:
//  Структура    - параметры адреса сделки на запрашиваемую дату.
//  Неопределено - если адрес сделки невозможно определить.
Функция ПолучитьПараметрыАдресаСделки(Объект, ДатаСовершенияСделки)
	
	Если НЕ ЗначениеЗаполнено(Объект) Тогда
		Возврат Неопределено;
	КонецЕсли;
	
	Если ТипЗнч(Объект) = Тип("СправочникСсылка.Организации") Тогда
		Если ОбщегоНазначения.ЗначениеРеквизитаОбъекта(Объект, "ЮридическоеФизическоеЛицо") = Перечисления.ЮридическоеФизическоеЛицо.ЮридическоеЛицо Тогда
			СсылкаНаОбъект = Объект;
			ВидКонтактнойИнформации = Справочники.ВидыКонтактнойИнформации.ФактАдресОрганизации;
			ИмяСправочника = "Организации";
		Иначе
			СсылкаНаОбъект = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(Объект, "ИндивидуальныйПредприниматель");
			ВидКонтактнойИнформации = Справочники.ВидыКонтактнойИнформации.АдресМестаПроживанияФизическиеЛица;
			ИмяСправочника = "ФизическиеЛица";
		КонецЕсли;
	ИначеЕсли ТипЗнч(Объект) = Тип("СправочникСсылка.Контрагенты") Тогда
		СсылкаНаОбъект = Объект;
		ВидКонтактнойИнформации = Справочники.ВидыКонтактнойИнформации.ФактАдресКонтрагента;
		ИмяСправочника = "Контрагенты";
	Иначе
		Возврат Неопределено;
	КонецЕсли;
	
	ТекстЗапроса =
		"ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	МАКСИМУМ(КонтактнаяИнформация.ДействуетС) КАК ДействуетС,
		|	КонтактнаяИнформация.Ссылка КАК Ссылка
		|ПОМЕСТИТЬ ФильтрПоДате
		|ИЗ
		|	Справочник.Контрагенты.КонтактнаяИнформация КАК КонтактнаяИнформация
		|ГДЕ
		|	КонтактнаяИнформация.Ссылка = &Ссылка
		|	И КонтактнаяИнформация.Вид = &Вид
		|	И КонтактнаяИнформация.ДействуетС <= &ДатаСовершенияСделки
		|
		|СГРУППИРОВАТЬ ПО
		|	КонтактнаяИнформация.Ссылка
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	КонтактнаяИнформация.ЗначенияПолей КАК ЗначенияПолей
		|ИЗ
		|	Справочник.Контрагенты.КонтактнаяИнформация КАК КонтактнаяИнформация
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ФильтрПоДате КАК ФильтрПоДате
		|		ПО КонтактнаяИнформация.Ссылка = ФильтрПоДате.Ссылка
		|			И КонтактнаяИнформация.ДействуетС = ФильтрПоДате.ДействуетС
		|ГДЕ
		|	КонтактнаяИнформация.Ссылка = &Ссылка
		|	И КонтактнаяИнформация.Вид = &Вид
		|	";
	
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "Справочник.Контрагенты", СтрШаблон("Справочник.%1",ИмяСправочника));
	
	Запрос = Новый Запрос;
	Запрос.Текст = ТекстЗапроса;
	Запрос.УстановитьПараметр("Ссылка", СсылкаНаОбъект);
	Запрос.УстановитьПараметр("ДатаСовершенияСделки", ДатаСовершенияСделки);
	Запрос.УстановитьПараметр("Вид",    ВидКонтактнойИнформации);
	Выборка = Запрос.Выполнить().Выбрать();
	Если Выборка.Следующий() Тогда
		
		АдресСтруктурой = РаботаСАдресами.СведенияОбАдресе(Выборка.ЗначенияПолей);
		
		Если НЕ АдресСтруктурой.Свойство("Страна") Тогда
			Возврат Неопределено;
		КонецЕсли;
		
		СтранаМира = Справочники.СтраныМира.НайтиПоНаименованию(АдресСтруктурой.Страна);
		
		ДанныеАдреса = Новый Структура;
		ДанныеАдреса.Вставить("Страна", СтранаМира);
		ДанныеАдреса.Вставить("КодРегиона", "");
		ДанныеАдреса.Вставить("Город", "");
		ДанныеАдреса.Вставить("НаселенныйПункт", "");
		
		Если СтранаМира = Справочники.СтраныМира.Россия Тогда
			Если АдресСтруктурой.Свойство("КодРегиона") И ЗначениеЗаполнено(АдресСтруктурой.КодРегиона) Тогда
				ДанныеАдреса.КодРегиона = АдресСтруктурой.КодРегиона;
			ИначеЕсли АдресСтруктурой.Свойство("Регион") И ЗначениеЗаполнено(АдресСтруктурой.Регион) Тогда
				ДанныеАдреса.КодРегиона = РегламентированнаяОтчетностьВызовСервера.КодРегионаПоНазванию(АдресСтруктурой.Регион);
			КонецЕсли;
			АдресСтруктурой.Свойство("Город", ДанныеАдреса.Город);
			АдресСтруктурой.Свойство("НаселенныйПункт", ДанныеАдреса.НаселенныйПункт);
		КонецЕсли;
		
		Возврат ДанныеАдреса;
	КонецЕсли;
	
	Возврат Неопределено;
	
КонецФункции

// Возвращает структуру параметров адреса сделки уведолмения за 2024 год
// Параметры:
//  Объект - СправочникСсылка.Организации, СправочникСсылка.Контрагенты - записываемый документ
//  КешАдресныхДанных - Соответствие из КлючИЗначение - соответствие адресых данных из кеш.
//  ДатаСовершенияСделки - Дата - дата совершения контролируемой сделки.
// Возвращаемое значение:
//  Структура - параметры адреса сделки.
//
Функция ПараметрыАдресаСделки2024(Объект, КешАдресныхДанных, ДатаСовершенияСделки)
	
	Если НЕ ЗначениеЗаполнено(Объект) Тогда
		Возврат Неопределено;
	КонецЕсли;
	
	ДанныеАдресаИзКеша = КешАдресныхДанных.Получить(Объект);
	Если ЗначениеЗаполнено(ДанныеАдресаИзКеша) Тогда
		Возврат ДанныеАдресаИзКеша;
	КонецЕсли;
	
	ВидКонтактнойИнформации = ВидАдресаКонтактнойИнформации(Объект);
	Если ВидКонтактнойИнформации = Неопределено Тогда
		Возврат Неопределено;
	КонецЕсли;
	
	// Фактический адрес на дату совершения сделки.
	ТаблицаАдреса = УправлениеКонтактнойИнформацией.КонтактнаяИнформацияОбъекта(Объект, ВидКонтактнойИнформации, ДатаСовершенияСделки, Ложь);
	
	Если Не ЗначениеЗаполнено(ТаблицаАдреса) Тогда
		Возврат Неопределено;
	КонецЕсли;
	
	ДополнительныеПараметры = Новый Структура;
	ДополнительныеПараметры.Вставить("КодыАдреса", Истина);
	АдресJSON = ТаблицаАдреса[0].Значение;
	
	СведенияОбАдресе = РаботаСАдресами.СведенияОбАдресе(АдресJSON, ДополнительныеПараметры);
	
	ДанныеАдреса = Новый Структура();
	ДанныеАдреса.Вставить("Страна", Справочники.СтраныМира.ПустаяСсылка());
	ДанныеАдреса.Вставить("ОКТМО", "");
	ДанныеАдреса.Вставить("НаселенныйПункт", "");
	
	Если ЗначениеЗаполнено(СведенияОбАдресе.Страна) Тогда
		СтранаМира = Справочники.СтраныМира.НайтиПоНаименованию(СведенияОбАдресе.Страна);
	КонецЕсли;
	
	ДанныеАдреса.Страна = СтранаМира;
	
	Если СтранаМира = Справочники.СтраныМира.Россия Тогда
		Если СведенияОбАдресе.ДополнительныеКоды.Свойство("ОКТМО")
			И ЗначениеЗаполнено(СведенияОбАдресе.ДополнительныеКоды.ОКТМО) Тогда
			ДанныеАдреса.ОКТМО = СведенияОбАдресе.ДополнительныеКоды.ОКТМО;
		Иначе
			// Получаем коды из классификатора.
			КодыАдреса = АдресныйКлассификатор.КодыАдреса(АдресJSON);
			ДанныеАдреса.ОКТМО = КодыАдреса.ОКТМО;
		КонецЕсли;
	КонецЕсли;
	
	Если СведенияОбАдресе.ТипАдреса <> "ВСвободнойФорме" Тогда
		
		ТипАдресаРФ = СведенияОбАдресе.ТипАдреса = "Муниципальный"
			ИЛИ СведенияОбАдресе.ТипАдреса = "Административно-территориальный";
		
		ЧастиАдреса = Новый Массив;
		
		Если ЗначениеЗаполнено(СведенияОбАдресе.Регион) Тогда
			Если ТипАдресаРФ Тогда
				ЧастиАдреса.Добавить(РаботаСАдресами.РегионАдресаКонтактнойИнформации(АдресJSON));
			Иначе
				ЧастиАдреса.Добавить(СведенияОбАдресе.Регион);
			КонецЕсли;
		КонецЕсли;
		
		Если ЗначениеЗаполнено(СведенияОбАдресе.Район) Тогда
			Если ЗначениеЗаполнено(СведенияОбАдресе.РайонТипКраткий) Тогда
				ЧастиАдреса.Добавить(КонтролируемыеСделки.СоединитьНаименованиеИТипАдресногоОбъекта(
					СведенияОбАдресе.Район, СведенияОбАдресе.РайонТипКраткий));
			Иначе
				ЧастиАдреса.Добавить(СведенияОбАдресе.Район);
			КонецЕсли;
		КонецЕсли;
		
		Если ЗначениеЗаполнено(СведенияОбАдресе.Город) Тогда
			Если ЗначениеЗаполнено(СведенияОбАдресе.ГородТипКраткий) Тогда
				ЧастиАдреса.Добавить(КонтролируемыеСделки.СоединитьНаименованиеИТипАдресногоОбъекта(
					СведенияОбАдресе.Город, СведенияОбАдресе.ГородТипКраткий));
			Иначе
				ЧастиАдреса.Добавить(СведенияОбАдресе.Город);
			КонецЕсли;
		КонецЕсли;
		
		Если ЗначениеЗаполнено(СведенияОбАдресе.НаселенныйПункт) Тогда
			Если ЗначениеЗаполнено(СведенияОбАдресе.НаселенныйПунктТипКраткий) Тогда
				ЧастиАдреса.Добавить(КонтролируемыеСделки.СоединитьНаименованиеИТипАдресногоОбъекта(
					СведенияОбАдресе.СведенияОбАдресе.НаселенныйПункт, СведенияОбАдресе.НаселенныйПунктТипКраткий));
			Иначе
				ЧастиАдреса.Добавить(СведенияОбАдресе.НаселенныйПункт);
			КонецЕсли;
		КонецЕсли;
		
		Если ЗначениеЗаполнено(ЧастиАдреса) Тогда
			ДанныеАдреса.НаселенныйПункт = СтрСоединить(ЧастиАдреса, ", ");
		КонецЕсли;
		
	КонецЕсли;
	
	КешАдресныхДанных.Вставить(Объект, ДанныеАдреса);
	
	Возврат ДанныеАдреса;
	
КонецФункции 

#КонецОбласти

#Область ДобавлениеСделок

// Подготавливает основные параметры запроса к документам - источникам, на основании которых будет формироваться таблица
// контролируемых сделок.
// Параметры:
//  Уведомление                       - ДокументСсылка.УведомлениеОКонтролируемыхСделках - уведомление.
// Возвращаемое значение:
//  Структура - параметры запроса к документам источникам: 
//  * СписокПодчиненныхОрганизаций    - СписокЗначений из СправочникСсылка.Организации - список обособленных 
//                                      подразделений организации, сдающей уведомление о контролируемых сделках.
//  * Организация                     - СправочникСсылка.Организации - организация, сдающая уведомление
//                                      о контролируемых сделках.
//  * НачалоПериода                  - Дата - дата начала отчетного периода.
//  * ОкончаниеПериода               - Дата - дата конца отчетного периода.
//  * ВалютаРегламентированногоУчета - СправочникСсылка.Валюты, Неопределено - валюта регламетированного учета.
//
Функция СтруктураПараметровЗапросаКДокументамИсточникам(Уведомление)
	
	ПараметрыУведомления = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(Уведомление, "Организация, ОтчетныйГод");
	СтруктураОрганизации = БухгалтерскийУчетПереопределяемый.СтруктураОрганизации(ПараметрыУведомления.Организация);
	
	СтруктураВозврата = Новый Структура;
	
	СтруктураВозврата.Вставить("СписокПодчиненныхОрганизаций", СтруктураОрганизации.Организация);
	СтруктураВозврата.Вставить("Организация", ПараметрыУведомления.Организация);
	СтруктураВозврата.Вставить("НачалоПериода", НачалоГода(ПараметрыУведомления.ОтчетныйГод));
	СтруктураВозврата.Вставить("ОкончаниеПериода", КонецГода(ПараметрыУведомления.ОтчетныйГод));
	СтруктураВозврата.Вставить("ВалютаРегламентированногоУчета",
				ЗначениеНастроекПовтИсп.ВалютаРегламентированногоУчетаОрганизации(ПараметрыУведомления.Организация));
	
	Возврат СтруктураВозврата;
	
КонецФункции

// Создает запрос и заполняет его переданными параметрами для последующего запроса к документам - источникам, на
// основании которых будет формироваться таблица контролируемых сделок.
// Параметры:
//  СтруктураПараметров - Структура - параметры запроса к документам источникам: 
//  * СписокПодчиненныхОрганизаций    - СписокЗначений из СправочникСсылка.Организации - список обособленных 
//                                      подразделений организации, сдающей уведомление о контролируемых сделках.
//  * Организация                     - СправочникСсылка.Организации - организация, сдающая уведомление
//                                      о контролируемых сделках.
//  * НачалоПериода                  - Дата - дата начала отчетного периода.
//  * ОкончаниеПериода               - Дата - дата конца отчетного периода.
//  * ВалютаРегламентированногоУчета - СправочникСсылка.Валюты, Неопределено - валюта регламетированного учета.
//  * ЕдиницаИзмеренияШтука          - СправочникСсылка.УпаковкиЕдиницыИзмерения - единица измерения.
// Возвращаемое значение:
//  Запрос - запрос с установлеными парамтрами.
//
Функция ПодготовитьЗапросКДокументамИсточникам(СтруктураПараметров)
	
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("СтруктураОрганизации", СтруктураПараметров.СписокПодчиненныхОрганизаций);
	Запрос.УстановитьПараметр("Организация", СтруктураПараметров.Организация);
	Запрос.УстановитьПараметр("НачалоПериода", СтруктураПараметров.НачалоПериода);
	Запрос.УстановитьПараметр("ОкончаниеПериода", СтруктураПараметров.ОкончаниеПериода);
	Запрос.УстановитьПараметр("ВалютаРегламентированногоУчета", СтруктураПараметров.ВалютаРегламентированногоУчета);
	Запрос.УстановитьПараметр("ЕдиницаИзмеренияШтука", Справочники.УпаковкиЕдиницыИзмерения.НайтиПоКоду("796"));
	
	Возврат Запрос;
	
КонецФункции

// Возвращает выборку из временной таблицы сделок.
// Параметры:
//  МенеджерВременныхТаблиц - МенеджерВременныхТаблиц - таблица сделок для получения выборки. 
// Возвращаемое значение:
//   ВыборкаИзРезультатаЗапроса - выборка из таблицы сделок.
//
Функция ПолучитьВыборкуТаблицыСделокСПреобразованиемСуммКРублевым(МенеджерВременныхТаблиц)
	
	Запрос = Новый Запрос;
	Запрос.МенеджерВременныхТаблиц = МенеджерВременныхТаблиц;
	Запрос.УстановитьПараметр("ДатаОтказаОтЕНВД", КонтролируемыеСделкиКлиентСервер.ДатаОтказаОтЕНВД());
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	ТаблицаСделок.РасчетныйДокумент,
	|	ТаблицаСделок.Период,
	|	ТаблицаСделок.Организация,
	|	ТаблицаСделок.Контрагент,
	|	ТаблицаСделок.Комиссионер,
	|	ТаблицаСделок.ПредметСделки,
	|	ТаблицаСделок.ТипПредметаСделки,
	|	ТаблицаСделок.НаименованиеПредметаСделки,
	|	ТаблицаСделок.СтранаПроисхожденияПредметаСделки,
	|	ТаблицаСделок.ХозяйственнаяОперация,
	|	ТаблицаСделок.Валюта,
	|	ТаблицаСделок.ЕдиницаИзмерения,
	|	СУММА(ТаблицаСделок.МножительСуммовыхДанных * ТаблицаСделок.Количество) КАК Количество,
	|	ТаблицаСделок.СтавкаНДС,
	|	СУММА(ТаблицаСделок.МножительСуммовыхДанных * ЕСТЬNULL(СуммыДокументовВВалютахУчета.СуммаБезНДСРегл, ТаблицаСделок.СуммаБезНДС)) КАК СуммаБезНДСВРублях,
	|	СУММА(ТаблицаСделок.МножительСуммовыхДанных * ЕСТЬNULL(СуммыДокументовВВалютахУчета.СуммаНДСРегл, ТаблицаСделок.СуммаНДС)) КАК СуммаНДСВРублях,
	|	ТаблицаСделок.ТипКонтролируемойСделки,
	|	ТаблицаСделок.ТоварМировойБиржевойТорговли,
	|	ТаблицаСделок.ОперацияОблагаетсяЕНВД И ТаблицаСделок.Период < &ДатаОтказаОтЕНВД КАК ОперацияОблагаетсяЕНВД,
	|	ВЫБОР
	|		КОГДА ТаблицаСделок.ТипПредметаСделки = ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.Товар)
	|			И ТаблицаСделок.Грузоотправитель <> ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	|		ТОГДА ТаблицаСделок.Грузоотправитель
	|		КОГДА ТаблицаСделок.ТипПредметаСделки = ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.Товар)
	|			И ТаблицаСделок.Грузоотправитель = ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	|			И ТаблицаСделок.ТипКонтролируемойСделки = ЗНАЧЕНИЕ(Перечисление.ТипыКонтролируемыхСделок.ПолученДоход)
	|		ТОГДА ТаблицаСделок.Организация
	|		КОГДА ТаблицаСделок.ТипПредметаСделки = ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.Товар)
	|			И ТаблицаСделок.Грузоотправитель = ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	|			И ТаблицаСделок.ТипКонтролируемойСделки = ЗНАЧЕНИЕ(Перечисление.ТипыКонтролируемыхСделок.ОсуществленРасход)
	|		ТОГДА ТаблицаСделок.Контрагент
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	|	КОНЕЦ КАК Грузоотправитель,
	|	ВЫБОР
	|		КОГДА ТаблицаСделок.Грузополучатель <> ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	|		ТОГДА ТаблицаСделок.Грузополучатель
	|		КОГДА ТаблицаСделок.Грузополучатель = ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	|			И ТаблицаСделок.ТипКонтролируемойСделки = ЗНАЧЕНИЕ(Перечисление.ТипыКонтролируемыхСделок.ПолученДоход)
	|		ТОГДА ТаблицаСделок.Контрагент
	|		КОГДА ТаблицаСделок.Грузополучатель = ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	|			И ТаблицаСделок.ТипКонтролируемойСделки = ЗНАЧЕНИЕ(Перечисление.ТипыКонтролируемыхСделок.ОсуществленРасход)
	|		ТОГДА ТаблицаСделок.Организация
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	|	КОНЕЦ КАК Грузополучатель,
	|	СУММА(ТаблицаСделок.МножительСуммовыхДанных * ТаблицаСделок.СуммаБезНДС) КАК СуммаБезНДСВВалютеРасчетов,
	|	СУММА(ТаблицаСделок.МножительСуммовыхДанных * ТаблицаСделок.СуммаНДС) КАК СуммаНДСВВалютеРасчетов,
	|	СРЕДНЕЕ(ВЫБОР
	|			КОГДА ТаблицаСделок.Количество = 0
	|				ТОГДА ЕСТЬNULL(СуммыДокументовВВалютахУчета.СуммаБезНДСРегл, ТаблицаСделок.СуммаБезНДС)
	|			ИНАЧЕ ЕСТЬNULL(СуммыДокументовВВалютахУчета.СуммаБезНДСРегл, ТаблицаСделок.СуммаБезНДС) / ТаблицаСделок.Количество
	|		КОНЕЦ) КАК ЦенаВРублях,
	|	ТаблицаСделок.Договор,
	|	ТаблицаСделок.Соглашение
	|ИЗ
	|	ТаблицаСделок КАК ТаблицаСделок
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.СуммыДокументовВВалютахУчета КАК СуммыДокументовВВалютахУчета
	|		ПО ТаблицаСделок.ИдентификаторСтроки = СуммыДокументовВВалютахУчета.ИдентификаторСтроки
	|			И ТаблицаСделок.РегистраторРегистраСумм = СуммыДокументовВВалютахУчета.Регистратор
	|ГДЕ
	|	(ЕСТЬNULL(СуммыДокументовВВалютахУчета.СуммаБезНДСРегл, ТаблицаСделок.СуммаБезНДС) <> 0
	|			ИЛИ ЕСТЬNULL(СуммыДокументовВВалютахУчета.СуммаНДСРегл, ТаблицаСделок.СуммаНДС) <> 0
	|			ИЛИ ТаблицаСделок.Количество <> 0)
	|
	|СГРУППИРОВАТЬ ПО
	|	ТаблицаСделок.Контрагент,
	|	ТаблицаСделок.Комиссионер,
	|	ТаблицаСделок.РасчетныйДокумент,
	|	ТаблицаСделок.Период,
	|	ТаблицаСделок.ТипПредметаСделки,
	|	ТаблицаСделок.НаименованиеПредметаСделки,
	|	ТаблицаСделок.ОперацияОблагаетсяЕНВД И ТаблицаСделок.Период < &ДатаОтказаОтЕНВД,
	|	ТаблицаСделок.СтавкаНДС,
	|	ТаблицаСделок.Валюта,
	|	ТаблицаСделок.ХозяйственнаяОперация,
	|	ТаблицаСделок.ПредметСделки,
	|	ТаблицаСделок.ТипКонтролируемойСделки,
	|	ТаблицаСделок.ТоварМировойБиржевойТорговли,
	|	ТаблицаСделок.ЕдиницаИзмерения,
	|	ВЫБОР
	|		КОГДА ТаблицаСделок.Грузополучатель <> ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	|		ТОГДА ТаблицаСделок.Грузополучатель
	|		КОГДА ТаблицаСделок.Грузополучатель = ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	|			И ТаблицаСделок.ТипКонтролируемойСделки = ЗНАЧЕНИЕ(Перечисление.ТипыКонтролируемыхСделок.ПолученДоход)
	|		ТОГДА ТаблицаСделок.Контрагент
	|		КОГДА ТаблицаСделок.Грузополучатель = ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	|			И ТаблицаСделок.ТипКонтролируемойСделки = ЗНАЧЕНИЕ(Перечисление.ТипыКонтролируемыхСделок.ОсуществленРасход)
	|		ТОГДА ТаблицаСделок.Организация
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	|	КОНЕЦ,
	|	ТаблицаСделок.СтранаПроисхожденияПредметаСделки,
	|	ТаблицаСделок.Организация,
	|	ВЫБОР
	|		КОГДА ТаблицаСделок.ТипПредметаСделки = ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.Товар)
	|			И ТаблицаСделок.Грузоотправитель <> ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	|		ТОГДА ТаблицаСделок.Грузоотправитель
	|		КОГДА ТаблицаСделок.ТипПредметаСделки = ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.Товар)
	|			И ТаблицаСделок.Грузоотправитель = ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	|			И ТаблицаСделок.ТипКонтролируемойСделки = ЗНАЧЕНИЕ(Перечисление.ТипыКонтролируемыхСделок.ПолученДоход)
	|		ТОГДА ТаблицаСделок.Организация
	|		КОГДА ТаблицаСделок.ТипПредметаСделки = ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.Товар)
	|			И ТаблицаСделок.Грузоотправитель = ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	|			И ТаблицаСделок.ТипКонтролируемойСделки = ЗНАЧЕНИЕ(Перечисление.ТипыКонтролируемыхСделок.ОсуществленРасход)
	|		ТОГДА ТаблицаСделок.Контрагент
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	|	КОНЕЦ,
	|	ТаблицаСделок.Договор,
	|	ТаблицаСделок.Соглашение";
	
	Возврат Запрос.Выполнить().Выбрать();
	
КонецФункции

#Область ДобавлениеСделокПродажи

// Добавляет в список контролируемых сделок реализации товаров и услуг.
//
// Параметры:
//  СтруктураПараметров - Структура - параметры контролируемых сделок:
//  * ВалютаРегламентированногоУчета - СправочникСсылка.Валюты - валюта регламетированного учета.
//  * НачалоПериода                  - Дата - начало периода формирования списка контролируемых сделок.
//  * ОкончаниеПериода               - Дата - окончание периода формирования списка контролируемых сделок.
//  * Организация                    - СправочникСсылка.Организации - код места представления.
//  * СписокПодчиненныхОрганизаций   - СписокЗначений из СправочникСсылка.Организации - список подчиненных организаций.
//  МенеджерВременныхТаблиц          - МенеджерВременныхТаблиц - временные таблицы запроса по контролируемым сделкам.
//  ТаблицаСделок                    - ТаблицаЗначений - таблица значений с данными о контролируемых сделках.
//
Процедура ДобавитьСделкиРеализацииТоваровУслуг(СтруктураПараметров, МенеджерВременныхТаблиц, ТаблицаСделок)
	
	Запрос = ПодготовитьЗапросКДокументамИсточникам(СтруктураПараметров);
	Запрос.УстановитьПараметр("ИспользованиеСоглашений", ПолучитьФункциональнуюОпцию("ИспользоватьСоглашенияСКлиентами"));
	Запрос.УстановитьПараметр("ИспользованиеДоговоров", ПолучитьФункциональнуюОпцию("ИспользоватьДоговорыСКлиентами"));
	Запрос.МенеджерВременныхТаблиц = МенеджерВременныхТаблиц;
	Запрос.Текст =
	"ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	РеализацияТоваровУслуг.Организация КАК Организация,
	|	РеализацияТоваровУслуг.Ссылка КАК РасчетныйДокумент,
	|	ВЫБОР
	|		КОГДА РеализацияТоваровУслуг.ХозяйственнаяОперация В (
	|			ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РеализацияБезПереходаПраваСобственности),
	|			ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РеализацияЧерезКомиссионераБезПереходаПраваСобственности))
	|		ТОГДА РеализацияТоваровУслуг.ДатаПереходаПраваСобственности
	|		ИНАЧЕ РеализацияТоваровУслуг.Дата
	|	КОНЕЦ КАК Период,
	|	ВЫБОР
	|		КОГДА РеализацияТоваровУслуг.ХозяйственнаяОперация В (
	|			ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РеализацияЧерезКомиссионера),
	|			ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РеализацияЧерезКомиссионераБезПереходаПраваСобственности))
	|		ТОГДА РеализацияТоваровУслуг.КлиентКонтрагент
	|		ИНАЧЕ РеализацияТоваровУслуг.Контрагент
	|	КОНЕЦ КАК Контрагент,
	|	ВЫБОР
	|		КОГДА РеализацияТоваровУслуг.ХозяйственнаяОперация В (
	|			ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РеализацияЧерезКомиссионера),
	|			ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РеализацияЧерезКомиссионераБезПереходаПраваСобственности))
	|		ТОГДА РеализацияТоваровУслуг.Контрагент
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	|	КОНЕЦ КАК Комиссионер,
	|	ВЫБОР
	|		КОГДА РеализацияТоваровУслуг.Грузополучатель = ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	|			ТОГДА РеализацияТоваровУслуг.Контрагент
	|		ИНАЧЕ РеализацияТоваровУслуг.Грузополучатель
	|	КОНЕЦ КАК Грузополучатель,
	|	ВЫБОР
	|		КОГДА РеализацияТоваровУслуг.Грузоотправитель = ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	|			ТОГДА РеализацияТоваровУслуг.Организация
	|		ИНАЧЕ РеализацияТоваровУслуг.Грузоотправитель
	|	КОНЕЦ КАК Грузоотправитель,
	|	ВЫБОР
	|		КОГДА &ИспользованиеДоговоров И РеализацияТоваровУслуг.ХозяйственнаяОперация В (
	|			ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РеализацияЧерезКомиссионера),
	|			ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РеализацияЧерезКомиссионераБезПереходаПраваСобственности))
	|		ТОГДА РеализацияТоваровУслуг.КлиентДоговор
	|		КОГДА &ИспользованиеДоговоров
	|		ТОГДА РеализацияТоваровУслуг.Договор
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК ДоговорКонтрагента,
	|	ВЫБОР
	|		КОГДА &ИспользованиеСоглашений
	|		ТОГДА РеализацияТоваровУслуг.Соглашение
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК Соглашение,
	|	РеализацияТоваровУслуг.Валюта,
	|	РеализацияТоваровУслуг.ХозяйственнаяОперация,
	|	РеализацияТоваровУслуг.НалогообложениеНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаОблагаетсяЕНВД) КАК ОперацияОблагаетсяЕНВД,
	|	РеализацияТоваровУслуг.ВернутьМногооборотнуюТару
	|ПОМЕСТИТЬ ДокументыРеализацияТоваровУслугДляАнализа
	|ИЗ
	|	Документ.РеализацияТоваровУслуг КАК РеализацияТоваровУслуг
	|ГДЕ
	|	РеализацияТоваровУслуг.Организация В(&СтруктураОрганизации)
	|	И РеализацияТоваровУслуг.Проведен
	|	И ВЫБОР
	|		КОГДА РеализацияТоваровУслуг.ХозяйственнаяОперация В (
	|			ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РеализацияЧерезКомиссионера),
	|			ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РеализацияЧерезКомиссионераБезПереходаПраваСобственности))
	|		ТОГДА РеализацияТоваровУслуг.КлиентКонтрагент
	|		ИНАЧЕ РеализацияТоваровУслуг.Контрагент
	|	КОНЕЦ В
	|			(ВЫБРАТЬ
	|				КонтролируемыеКонтрагенты.Контрагент
	|			ИЗ
	|				КонтролируемыеКонтрагенты КАК КонтролируемыеКонтрагенты)
	|	И ВЫБОР
	|		КОГДА РеализацияТоваровУслуг.Договор = ЗНАЧЕНИЕ(Справочник.ДоговорыКонтрагентов.ПустаяСсылка)
	|		ТОГДА ИСТИНА
	|		КОГДА РеализацияТоваровУслуг.ХозяйственнаяОперация В (
	|			ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РеализацияЧерезКомиссионера),
	|			ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РеализацияЧерезКомиссионераБезПереходаПраваСобственности))
	|		ТОГДА РеализацияТоваровУслуг.Договор.ТипДоговора = ЗНАЧЕНИЕ(Перечисление.ТипыДоговоров.СКомиссионером)
	|		ИНАЧЕ РеализацияТоваровУслуг.Договор.ТипДоговора = ЗНАЧЕНИЕ(Перечисление.ТипыДоговоров.СПокупателем)
	|	КОНЕЦ
	|	И ВЫБОР
	|		КОГДА РеализацияТоваровУслуг.ХозяйственнаяОперация В (
	|			ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РеализацияБезПереходаПраваСобственности),
	|			ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РеализацияЧерезКомиссионераБезПереходаПраваСобственности))
	|		ТОГДА РеализацияТоваровУслуг.Статус = ЗНАЧЕНИЕ(Перечисление.СтатусыРеализацийТоваровУслуг.Отгружено)
	|		ИНАЧЕ ИСТИНА
	|	КОНЕЦ;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	РеализацияТоваровУслуг.Организация,
	|	РеализацияТоваровУслуг.РасчетныйДокумент,
	|	РеализацияТоваровУслуг.Период,
	|	РеализацияТоваровУслуг.Контрагент,
	|	РеализацияТоваровУслуг.Комиссионер,
	|	РеализацияТоваровУслуг.Грузополучатель,
	|	РеализацияТоваровУслуг.Грузоотправитель,
	|	РеализацияТоваровУслуг.ДоговорКонтрагента,
	|	РеализацияТоваровУслуг.Соглашение,
	|	РеализацияТоваровУслуг.Валюта,
	|	РеализацияТоваровУслуг.ОперацияОблагаетсяЕНВД,
	|	РеализацияТоваровУслуг.ВернутьМногооборотнуюТару,
	|	НЕ ВзаимозависимыеЛицаПоПериодам.Контрагент ЕСТЬ NULL КАК ВзаимозависимыеЛица,
	|	НЕ ИностранныеКонтрагенты.Контрагент ЕСТЬ NULL КАК ИностранныйКонтрагент,
	|	ЕСТЬNULL(ИностранныеКонтрагенты.ЗарегистрированВСтранеСЛьготнымНалогообложением, ЛОЖЬ) КАК ЗарегистрированВСтранеСЛьготнымНалогообложением
	|ПОМЕСТИТЬ ДокументыКонтролируемыхСделок
	|ИЗ
	|	ДокументыРеализацияТоваровУслугДляАнализа КАК РеализацияТоваровУслуг
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВзаимозависимыеЛицаПоПериодам КАК ВзаимозависимыеЛицаПоПериодам
	|		ПО (ВзаимозависимыеЛицаПоПериодам.Организация = &Организация)
	|			И (ВзаимозависимыеЛицаПоПериодам.Контрагент = РеализацияТоваровУслуг.Контрагент)
	|			И РеализацияТоваровУслуг.Период >= ВзаимозависимыеЛицаПоПериодам.НачалоПериода
	|			И РеализацияТоваровУслуг.Период <= ВзаимозависимыеЛицаПоПериодам.ОкончаниеПериода
	|		ЛЕВОЕ СОЕДИНЕНИЕ ИностранныеКонтрагенты КАК ИностранныеКонтрагенты
	|		ПО (ИностранныеКонтрагенты.Контрагент = РеализацияТоваровУслуг.Контрагент)
	|      ЛЕВОЕ СОЕДИНЕНИЕ Документ.Сторно как ДокументыСторно 
	|      ПО РеализацияТоваровУслуг.РасчетныйДокумент = ДокументыСторно.СторнируемыйДокумент
	|      И ДокументыСторно.Проведен
	|ГДЕ
	|	РеализацияТоваровУслуг.Период >= &НачалоПериода
	|	И РеализацияТоваровУслуг.Период <= &ОкончаниеПериода
	|	И (НЕ ВзаимозависимыеЛицаПоПериодам.Контрагент ЕСТЬ NULL
	|		ИЛИ НЕ ИностранныеКонтрагенты.Контрагент ЕСТЬ NULL)
	|   И ДокументыСторно.СторнируемыйДокумент ЕСТЬ NULL
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	РасчетныйДокумент
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	ДокументыКонтролируемыхСделок.РасчетныйДокумент,
	|	ДокументыКонтролируемыхСделок.Период,
	|	ДокументыКонтролируемыхСделок.Организация,
	|	ДокументыКонтролируемыхСделок.Контрагент,
	|	ДокументыКонтролируемыхСделок.Комиссионер,
	|	ДокументыКонтролируемыхСделок.Грузополучатель,
	|	ДокументыКонтролируемыхСделок.Грузоотправитель,
	|	ДокументыКонтролируемыхСделок.ДоговорКонтрагента,
	|	ДокументыКонтролируемыхСделок.Соглашение,
	|	ДокументыКонтролируемыхСделок.Валюта,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыКонтролируемыхСделок.ПолученДоход) КАК ТипКонтролируемойСделки,
	|	УслугиРеализации.Номенклатура КАК ПредметСделки,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.РаботаУслуга) КАК ТипПредметаСделки,
	|	СУММА(УслугиРеализации.Количество) КАК Количество,
	|	СУММА(УслугиРеализации.Количество) КАК КоличествоВУчете,
	|	УслугиРеализации.Номенклатура.ЕдиницаИзмерения КАК ЕдиницаИзмеренияПоКлассификатору,
	|	СУММА(УслугиРеализации.СуммаСНДС - УслугиРеализации.СуммаНДС) КАК СуммаБезНДС,
	|	УслугиРеализации.СтавкаНДС,
	|	СУММА(УслугиРеализации.СуммаНДС) КАК СуммаНДС,
	|	ВЫБОР
	|		КОГДА УслугиРеализации.Ссылка.НалогообложениеНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаОблагаетсяЕНВД)
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ КАК ОперацияОблагаетсяЕНВД,
	|	ЛОЖЬ КАК ТоварМировойБиржевойТорговли,
	|	ВЫБОР
	|		КОГДА ЕСТЬNULL(УслугиРеализации.Характеристика.Принципал, УслугиРеализации.Номенклатура.Принципал) = НЕОПРЕДЕЛЕНО
	|				ИЛИ ЕСТЬNULL(УслугиРеализации.Характеристика.Принципал, УслугиРеализации.Номенклатура.Принципал) = УслугиРеализации.Ссылка.Организация
	|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперацииКонтролируемыхСделок.РеализацияСобственныхУслуг)
	|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперацииКонтролируемыхСделок.РеализацияКомиссионныхУслуг)
	|	КОНЕЦ КАК ХозяйственнаяОперация,
	|	ВЫБОР
	|		КОГДА ЕСТЬNULL(УслугиРеализации.Характеристика.Принципал, УслугиРеализации.Номенклатура.Принципал) = НЕОПРЕДЕЛЕНО
	|				ИЛИ ЕСТЬNULL(УслугиРеализации.Характеристика.Принципал, УслугиРеализации.Номенклатура.Принципал) = УслугиРеализации.Ссылка.Организация
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ КАК ВключатьСоставСделок,
	|	ВЫБОР
	|		КОГДА ЕСТЬNULL(УслугиРеализации.Характеристика.Принципал, УслугиРеализации.Номенклатура.Принципал) = НЕОПРЕДЕЛЕНО
	|				ИЛИ ЕСТЬNULL(УслугиРеализации.Характеристика.Принципал, УслугиРеализации.Номенклатура.Принципал) = УслугиРеализации.Ссылка.Организация
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ КАК УчитыватьНДСПриРаспределении,
	|	ЗНАЧЕНИЕ(Справочник.СтраныМира.Пустаяссылка) КАК СтранаПроисхождения,
	|	ДокументыКонтролируемыхСделок.ИностранныйКонтрагент,
	|	ДокументыКонтролируемыхСделок.ЗарегистрированВСтранеСЛьготнымНалогообложением,
	|	ДокументыКонтролируемыхСделок.ВзаимозависимыеЛица,
	|	УслугиРеализации.ИдентификаторСтроки
	|ПОМЕСТИТЬ ТоварыКонтролируемыхСделок
	|ИЗ
	|	Документ.РеализацияТоваровУслуг.Товары КАК УслугиРеализации
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ДокументыКонтролируемыхСделок КАК ДокументыКонтролируемыхСделок
	|		ПО УслугиРеализации.Ссылка = ДокументыКонтролируемыхСделок.РасчетныйДокумент
	|ГДЕ
	|	НЕ УслугиРеализации.Номенклатура.ТипНоменклатуры В (ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.Товар), ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.МногооборотнаяТара))
	|
	|СГРУППИРОВАТЬ ПО
	|	ДокументыКонтролируемыхСделок.РасчетныйДокумент,
	|	ДокументыКонтролируемыхСделок.Период,
	|	ДокументыКонтролируемыхСделок.Организация,
	|	ДокументыКонтролируемыхСделок.Контрагент,
	|	ДокументыКонтролируемыхСделок.Комиссионер,
	|	ДокументыКонтролируемыхСделок.Грузополучатель,
	|	ДокументыКонтролируемыхСделок.Грузоотправитель,
	|	ДокументыКонтролируемыхСделок.ДоговорКонтрагента,
	|	ДокументыКонтролируемыхСделок.Соглашение,
	|	ДокументыКонтролируемыхСделок.Валюта,
	|	УслугиРеализации.Номенклатура,
	|	УслугиРеализации.Номенклатура.ЕдиницаИзмерения,
	|	УслугиРеализации.СтавкаНДС,
	|	ДокументыКонтролируемыхСделок.ИностранныйКонтрагент,
	|	ДокументыКонтролируемыхСделок.ЗарегистрированВСтранеСЛьготнымНалогообложением,
	|	ДокументыКонтролируемыхСделок.ВзаимозависимыеЛица,
	|	ВЫБОР
	|		КОГДА УслугиРеализации.Ссылка.НалогообложениеНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаОблагаетсяЕНВД)
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА ЕСТЬNULL(УслугиРеализации.Характеристика.Принципал, УслугиРеализации.Номенклатура.Принципал) = НЕОПРЕДЕЛЕНО
	|				ИЛИ ЕСТЬNULL(УслугиРеализации.Характеристика.Принципал, УслугиРеализации.Номенклатура.Принципал) = УслугиРеализации.Ссылка.Организация
	|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперацииКонтролируемыхСделок.РеализацияСобственныхУслуг)
	|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперацииКонтролируемыхСделок.РеализацияКомиссионныхУслуг)
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА ЕСТЬNULL(УслугиРеализации.Характеристика.Принципал, УслугиРеализации.Номенклатура.Принципал) = НЕОПРЕДЕЛЕНО
	|				ИЛИ ЕСТЬNULL(УслугиРеализации.Характеристика.Принципал, УслугиРеализации.Номенклатура.Принципал) = УслугиРеализации.Ссылка.Организация
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ,
	|	УслугиРеализации.ИдентификаторСтроки
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ДокументыКонтролируемыхСделок.РасчетныйДокумент,
	|	ДокументыКонтролируемыхСделок.Период,
	|	ДокументыКонтролируемыхСделок.Организация,
	|	ДокументыКонтролируемыхСделок.Контрагент,
	|	ДокументыКонтролируемыхСделок.Комиссионер,
	|	ДокументыКонтролируемыхСделок.Грузополучатель,
	|	ДокументыКонтролируемыхСделок.Грузоотправитель,
	|	ДокументыКонтролируемыхСделок.ДоговорКонтрагента,
	|	ДокументыКонтролируемыхСделок.Соглашение,
	|	ДокументыКонтролируемыхСделок.Валюта,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыКонтролируемыхСделок.ПолученДоход),
	|	Аналитика.Номенклатура,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.Товар),
	|	СУММА(ТоварыРеализации.Количество),
	|	СУММА(ТоварыРеализации.Количество),
	|	Аналитика.Номенклатура.ЕдиницаИзмерения,
	|	СУММА(ТоварыРеализации.СуммаСНДС - ТоварыРеализации.СуммаНДС),
	|	ТоварыРеализации.СтавкаНДС,
	|	СУММА(ТоварыРеализации.СуммаНДС),
	|	ВЫБОР
	|		КОГДА ТоварыРеализации.Ссылка.НалогообложениеНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаОблагаетсяЕНВД)
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА ТоварыМировойБиржевойТорговли.ПредметСделки ЕСТЬ NULL 
	|			ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА ТоварыРеализации.ВидЗапасов.ТипЗапасов В (ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.ПустаяСсылка), ЗНАЧЕНИЕ(Перечисление.Типызапасов.Товар))
	|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперацииКонтролируемыхСделок.РеализацияСобственныхТоваров)
	|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперацииКонтролируемыхСделок.РеализацияКомиссионныхТоваров)
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА ТоварыРеализации.ВидЗапасов.ТипЗапасов В (ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.ПустаяСсылка), ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.Товар))
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА ТоварыРеализации.ВидЗапасов.ТипЗапасов В (ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.ПустаяСсылка), ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.Товар))
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ,
	|	ЕСТЬNULL(ТоварыРеализации.НомерГТД.СтранаПроисхождения, ЗНАЧЕНИЕ(Справочник.СтраныМира.Россия)),
	|	ДокументыКонтролируемыхСделок.ИностранныйКонтрагент,
	|	ДокументыКонтролируемыхСделок.ЗарегистрированВСтранеСЛьготнымНалогообложением,
	|	ДокументыКонтролируемыхСделок.ВзаимозависимыеЛица,
	|	ТоварыРеализации.ИдентификаторСтроки
	|ИЗ
	|	Документ.РеализацияТоваровУслуг.ВидыЗапасов КАК ТоварыРеализации
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ДокументыКонтролируемыхСделок КАК ДокументыКонтролируемыхСделок
	|		ПО ТоварыРеализации.Ссылка = ДокументыКонтролируемыхСделок.РасчетныйДокумент
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК Аналитика
	|		ПО ТоварыРеализации.АналитикаУчетаНоменклатуры = Аналитика.Ссылка
	|		ЛЕВОЕ СОЕДИНЕНИЕ ТоварыМировойБиржевойТорговли КАК ТоварыМировойБиржевойТорговли
	|		ПО Аналитика.Номенклатура = ТоварыМировойБиржевойТорговли.ПредметСделки
	|			И ТоварыМировойБиржевойТорговли.ДатаНачалаДействия <= ДокументыКонтролируемыхСделок.Период
	|			И ТоварыМировойБиржевойТорговли.ДатаОкончанияДействия >= ДокументыКонтролируемыхСделок.Период
	|ГДЕ
	|	ВЫБОР
	|		КОГДА ДокументыКонтролируемыхСделок.ВернутьМногооборотнуюТару
	|		ТОГДА Аналитика.Номенклатура.ТипНоменклатуры <> ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.МногооборотнаяТара)
	|		ИНАЧЕ ИСТИНА
	|	КОНЕЦ
	|
	|СГРУППИРОВАТЬ ПО
	|	ДокументыКонтролируемыхСделок.РасчетныйДокумент,
	|	ДокументыКонтролируемыхСделок.Период,
	|	ДокументыКонтролируемыхСделок.Организация,
	|	ДокументыКонтролируемыхСделок.Контрагент,
	|	ДокументыКонтролируемыхСделок.Комиссионер,
	|	ДокументыКонтролируемыхСделок.Грузополучатель,
	|	ДокументыКонтролируемыхСделок.Грузоотправитель,
	|	ДокументыКонтролируемыхСделок.ДоговорКонтрагента,
	|	ДокументыКонтролируемыхСделок.Соглашение,
	|	ДокументыКонтролируемыхСделок.Валюта,
	|	Аналитика.Номенклатура,
	|	Аналитика.Номенклатура.ЕдиницаИзмерения,
	|	ТоварыРеализации.СтавкаНДС,
	|	ВЫБОР
	|		КОГДА ТоварыРеализации.Ссылка.НалогообложениеНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаОблагаетсяЕНВД)
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА ТоварыМировойБиржевойТорговли.ПредметСделки ЕСТЬ NULL 
	|			ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА
	|	КОНЕЦ,
	|	ЕСТЬNULL(ТоварыРеализации.НомерГТД.СтранаПроисхождения, ЗНАЧЕНИЕ(Справочник.СтраныМира.Россия)),
	|	ТоварыРеализации.ИдентификаторСтроки,
	|	ВЫБОР
	|		КОГДА ТоварыРеализации.ВидЗапасов.ТипЗапасов В (ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.ПустаяСсылка), ЗНАЧЕНИЕ(Перечисление.Типызапасов.Товар))
	|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперацииКонтролируемыхСделок.РеализацияСобственныхТоваров)
	|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперацииКонтролируемыхСделок.РеализацияКомиссионныхТоваров)
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА ТоварыРеализации.ВидЗапасов.ТипЗапасов В (ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.ПустаяСсылка), ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.Товар))
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ,
	|	ДокументыКонтролируемыхСделок.ВзаимозависимыеЛица,
	|	ДокументыКонтролируемыхСделок.ИностранныйКонтрагент,
	|	ДокументыКонтролируемыхСделок.ЗарегистрированВСтранеСЛьготнымНалогообложением
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ТоварыКонтролируемыхСделок.РасчетныйДокумент КАК РасчетныйДокумент,
	|	ТоварыКонтролируемыхСделок.Период КАК Период,
	|	ТоварыКонтролируемыхСделок.Организация КАК Организация,
	|	ТоварыКонтролируемыхСделок.Контрагент КАК Контрагент,
	|	ТоварыКонтролируемыхСделок.Комиссионер КАК Комиссионер,
	|	ТоварыКонтролируемыхСделок.ПредметСделки,
	|	ТоварыКонтролируемыхСделок.ТипПредметаСделки,
	|	ТоварыКонтролируемыхСделок.ПредметСделки.НаименованиеПолное КАК НаименованиеПредметаСделки,
	|	ТоварыКонтролируемыхСделок.СтранаПроисхождения КАК СтранаПроисхожденияПредметаСделки,
	|	ТоварыКонтролируемыхСделок.ХозяйственнаяОперация,
	|	ТоварыКонтролируемыхСделок.Валюта,
	|	ТоварыКонтролируемыхСделок.ЕдиницаИзмеренияПоКлассификатору КАК ЕдиницаИзмерения,
	|	ТоварыКонтролируемыхСделок.Количество,
	|	ТоварыКонтролируемыхСделок.СтавкаНДС,
	|	ТоварыКонтролируемыхСделок.СуммаБезНДС,
	|	ТоварыКонтролируемыхСделок.СуммаНДС,
	|	ТоварыКонтролируемыхСделок.ТипКонтролируемойСделки,
	|	ТоварыКонтролируемыхСделок.ТоварМировойБиржевойТорговли,
	|	ТоварыКонтролируемыхСделок.ОперацияОблагаетсяЕНВД,
	|	ВЫБОР
	|		КОГДА ТоварыКонтролируемыхСделок.ТипПредметаСделки = ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.Товар)
	|		ТОГДА ТоварыКонтролируемыхСделок.Грузоотправитель
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	|	КОНЕЦ КАК Грузоотправитель,
	|	ВЫБОР
	|		КОГДА ТоварыКонтролируемыхСделок.ТипПредметаСделки = ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.Товар)
	|		ТОГДА ТоварыКонтролируемыхСделок.Грузополучатель
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	|	КОНЕЦ КАК Грузополучатель,
	|	ТоварыКонтролируемыхСделок.ДоговорКонтрагента КАК Договор,
	|	ТоварыКонтролируемыхСделок.Соглашение КАК Соглашение,
	|	ТоварыКонтролируемыхСделок.ИдентификаторСтроки КАК ИдентификаторСтроки,
	|	ТоварыКонтролируемыхСделок.РасчетныйДокумент КАК РегистраторРегистраСумм,
	|	1 КАК МножительСуммовыхДанных
	|ПОМЕСТИТЬ ТаблицаСделок
	|ИЗ
	|	ТоварыКонтролируемыхСделок КАК ТоварыКонтролируемыхСделок
	|ГДЕ
	|	(ТоварыКонтролируемыхСделок.ТоварМировойБиржевойТорговли
	|				И ТоварыКонтролируемыхСделок.ИностранныйКонтрагент
	|			ИЛИ ТоварыКонтролируемыхСделок.ВзаимозависимыеЛица
	|			ИЛИ ТоварыКонтролируемыхСделок.ЗарегистрированВСтранеСЛьготнымНалогообложением)
	|	И ТоварыКонтролируемыхСделок.ВключатьСоставСделок
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	РегистраторРегистраСумм,
	|	ИдентификаторСтроки";
	
	Запрос.Выполнить();
	
	ВыборкаСделокРеализации = ПолучитьВыборкуТаблицыСделокСПреобразованиемСуммКРублевым(Запрос.МенеджерВременныхТаблиц);
	
	Пока ВыборкаСделокРеализации.Следующий() Цикл
		СтрокаСделки = ТаблицаСделок.Добавить();
		ЗаполнитьЗначенияСвойств(СтрокаСделки, ВыборкаСделокРеализации);
	КонецЦикла;
	
	ЗапросУдаленияВременныхТаблиц = Новый Запрос();
	ЗапросУдаленияВременныхТаблиц.МенеджерВременныхТаблиц = Запрос.МенеджерВременныхТаблиц;
	ЗапросУдаленияВременныхТаблиц.Текст = 
	"УНИЧТОЖИТЬ ДокументыКонтролируемыхСделок
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ТоварыКонтролируемыхСделок
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ТаблицаСделок";
	
	ЗапросУдаленияВременныхТаблиц.Выполнить();
	
КонецПроцедуры

// Добавляет в список контролируемых сделок реализации услуг и прочих активов.
//
// Параметры:
//  СтруктураПараметров - Структура - параметры контролируемых сделок:
//  * ВалютаРегламентированногоУчета - СправочникСсылка.Валюты - валюта регламетированного учета.
//  * НачалоПериода                  - Дата - начало периода формирования списка контролируемых сделок.
//  * ОкончаниеПериода               - Дата - окончание периода формирования списка контролируемых сделок.
//  * Организация                    - СправочникСсылка.Организации - код места представления.
//  * СписокПодчиненныхОрганизаций   - СписокЗначений из СправочникСсылка.Организации - список подчиненных организаций.
//  МенеджерВременныхТаблиц          - МенеджерВременныхТаблиц - временные таблицы запроса по контролируемым сделкам.
//  ТаблицаСделок                    - ТаблицаЗначений - таблица значений с данными о контролируемых сделках.
//
Процедура ДобавитьСделкиРеализацииУслугПрочихАктивов(СтруктураПараметров, МенеджерВременныхТаблиц, ТаблицаСделок)
	
	Запрос = ПодготовитьЗапросКДокументамИсточникам(СтруктураПараметров);
	Запрос.УстановитьПараметр("ИспользованиеСоглашений", ПолучитьФункциональнуюОпцию("ИспользоватьСоглашенияСКлиентами"));
	Запрос.УстановитьПараметр("ИспользованиеДоговоров", ПолучитьФункциональнуюОпцию("ИспользоватьДоговорыСКлиентами"));
	Запрос.МенеджерВременныхТаблиц = МенеджерВременныхТаблиц;
	Запрос.Текст =
	"ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	РеализацияУслугПрочихАктивов.Организация КАК Организация,
	|	РеализацияУслугПрочихАктивов.Ссылка КАК РасчетныйДокумент,
	|	РеализацияУслугПрочихАктивов.Дата КАК Период,
	|	РеализацияУслугПрочихАктивов.Контрагент КАК Контрагент,
	|	ВЫБОР
	|		КОГДА РеализацияУслугПрочихАктивов.Грузополучатель = ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	|			ТОГДА РеализацияУслугПрочихАктивов.Контрагент
	|		ИНАЧЕ РеализацияУслугПрочихАктивов.Грузополучатель
	|	КОНЕЦ КАК Грузополучатель,
	|	ВЫБОР
	|		КОГДА РеализацияУслугПрочихАктивов.Грузоотправитель = ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	|			ТОГДА РеализацияУслугПрочихАктивов.Организация
	|		ИНАЧЕ РеализацияУслугПрочихАктивов.Грузоотправитель
	|	КОНЕЦ КАК Грузоотправитель,
	|	РеализацияУслугПрочихАктивов.Договор КАК ДоговорКонтрагента,
	|	РеализацияУслугПрочихАктивов.Валюта,
	|	РеализацияУслугПрочихАктивов.ЦенаВключаетНДС,
	|	ВЫБОР
	|		КОГДА ВзаимозависимыеЛицаПоПериодам.Контрагент ЕСТЬ NULL 
	|			ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА
	|	КОНЕЦ КАК ВзаимозависимыеЛица,
	|	ВЫБОР
	|		КОГДА ИностранныеКонтрагенты.Контрагент ЕСТЬ NULL 
	|			ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА
	|	КОНЕЦ КАК ИностранныйКонтрагент,
	|	ЕСТЬNULL(ИностранныеКонтрагенты.ЗарегистрированВСтранеСЛьготнымНалогообложением, ЛОЖЬ) КАК ЗарегистрированВСтранеСЛьготнымНалогообложением,
	|	РеализацияУслугПрочихАктивов.Договор.ТипДоговора КАК ТипДоговора,
	|	РеализацияУслугПрочихАктивов.Договор.ВалютаВзаиморасчетов КАК ВалютаВзаиморасчетов
	|ПОМЕСТИТЬ ДокументыКонтролируемыхСделок
	|ИЗ
	|	Документ.РеализацияУслугПрочихАктивов КАК РеализацияУслугПрочихАктивов
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВзаимозависимыеЛицаПоПериодам КАК ВзаимозависимыеЛицаПоПериодам
	|		ПО (ВзаимозависимыеЛицаПоПериодам.Организация = &Организация)
	|			И (ВзаимозависимыеЛицаПоПериодам.Контрагент = РеализацияУслугПрочихАктивов.Контрагент)
	|			И РеализацияУслугПрочихАктивов.Дата >= ВзаимозависимыеЛицаПоПериодам.НачалоПериода
	|			И РеализацияУслугПрочихАктивов.Дата <= ВзаимозависимыеЛицаПоПериодам.ОкончаниеПериода
	|		ЛЕВОЕ СОЕДИНЕНИЕ ИностранныеКонтрагенты КАК ИностранныеКонтрагенты
	|		ПО (ИностранныеКонтрагенты.Контрагент = РеализацияУслугПрочихАктивов.Контрагент)
	|    ЛЕВОЕ СОЕДИНЕНИЕ Документ.Сторно как ДокументыСторно 
	|    ПО РеализацияУслугПрочихАктивов.Ссылка = ДокументыСторно.СторнируемыйДокумент
	|    И ДокументыСторно.Проведен
	|ГДЕ
	|	РеализацияУслугПрочихАктивов.Организация В(&СтруктураОрганизации)
	|	И РеализацияУслугПрочихАктивов.Дата >= &НачалоПериода
	|	И РеализацияУслугПрочихАктивов.Дата <= &ОкончаниеПериода
	|	И РеализацияУслугПрочихАктивов.Проведен = ИСТИНА
	|	И РеализацияУслугПрочихАктивов.Контрагент В
	|			(ВЫБРАТЬ
	|				КонтролируемыеКонтрагенты.Контрагент
	|			ИЗ
	|				КонтролируемыеКонтрагенты КАК КонтролируемыеКонтрагенты)
	|	И (НЕ ВзаимозависимыеЛицаПоПериодам.Контрагент ЕСТЬ NULL 
	|			ИЛИ НЕ ИностранныеКонтрагенты.Контрагент ЕСТЬ NULL )
	|	И РеализацияУслугПрочихАктивов.ХозяйственнаяОперация <> ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РеализацияБезПереходаПраваСобственности)
	|	И ВЫБОР
	|			КОГДА РеализацияУслугПрочихАктивов.Договор = ЗНАЧЕНИЕ(Справочник.ДоговорыКонтрагентов.ПустаяСсылка)
	|				ТОГДА ИСТИНА
	|			ИНАЧЕ РеализацияУслугПрочихАктивов.Договор.ТипДоговора = ЗНАЧЕНИЕ(Перечисление.ТипыДоговоров.СПокупателем)
	|		КОНЕЦ
	| И ДокументыСторно.СторнируемыйДокумент ЕСТЬ NULL 
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	РасчетныйДокумент
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	УслугиПрочиеАктивы.Ссылка КАК РасчетныйДокумент,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыКонтролируемыхСделок.ПолученДоход) КАК ТипКонтролируемойСделки,
	|
	|	ВЫБОР 
	|		КОГДА ШапкаДокумента.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РеализацияКлиенту) ТОГДА
	|			""""
	|		КОГДА ШапкаДокумента.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РеализацияВнеоборотныхАктивов) ТОГДА
	|			ВЫБОР
	|				КОГДА ТИПЗНАЧЕНИЯ(УслугиПрочиеАктивы.АналитикаДоходов) В (ТИП(Справочник.ОбъектыЭксплуатации),
	|																			ТИП(Справочник.НематериальныеАктивы)) ТОГДА
	|						УслугиПрочиеАктивы.АналитикаДоходов
	|				ИНАЧЕ
	|					""""
	|				КОНЕЦ
	|		КОГДА ШапкаДокумента.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РеализацияУслугПоАренде) ТОГДА
	|			""""
	|		КОНЕЦ
	|			 КАК ПредметСделки,
	|
	|	ВЫБОР 
	|		КОГДА ШапкаДокумента.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РеализацияКлиенту) ТОГДА
	|			УслугиПрочиеАктивы.Содержание
	|		КОГДА ШапкаДокумента.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РеализацияВнеоборотныхАктивов) ТОГДА
	|			ВЫБОР
	|				КОГДА ТИПЗНАЧЕНИЯ(УслугиПрочиеАктивы.АналитикаДоходов) В (ТИП(Справочник.ОбъектыЭксплуатации),
	|																			ТИП(Справочник.НематериальныеАктивы)) ТОГДА
	|						УслугиПрочиеАктивы.АналитикаДоходов
	|				ИНАЧЕ
	|					УслугиПрочиеАктивы.Содержание
	|				КОНЕЦ
	|		КОГДА ШапкаДокумента.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РеализацияУслугПоАренде) ТОГДА
	|			УслугиПрочиеАктивы.Содержание
	|		КОНЕЦ
	|			 КАК НаименованиеПредметаСделки,
	|
	|	ВЫБОР 
	|		КОГДА ШапкаДокумента.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РеализацияКлиенту) ТОГДА
	|			ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.РаботаУслуга)
	|		КОГДА ШапкаДокумента.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РеализацияВнеоборотныхАктивов) ТОГДА
	|			
	|			ВЫБОР
	|				КОГДА ТИПЗНАЧЕНИЯ(УслугиПрочиеАктивы.АналитикаДоходов) В (ТИП(Справочник.ОбъектыЭксплуатации),
	|																			ТИП(Справочник.НематериальныеАктивы)) ТОГДА
	|						ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.ИнойОбъектГражданскихПрав)
	|				ИНАЧЕ
	|					ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.РаботаУслуга)
	|				КОНЕЦ
	|		КОГДА ШапкаДокумента.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РеализацияУслугПоАренде) ТОГДА
	|			ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.РаботаУслуга)
	|		КОНЕЦ  КАК ТипПредметаСделки,
	|
	|	СУММА(УслугиПрочиеАктивы.Количество) КАК Количество,
	|	УслугиПрочиеАктивы.ЕдиницаИзмерения КАК ЕдиницаИзмеренияПоКлассификатору,
	|	УслугиПрочиеАктивы.СтавкаНДС,
	|	СУММА(УслугиПрочиеАктивы.СуммаСНДС - УслугиПрочиеАктивы.СуммаНДС) КАК СуммаБезНДС,
	|	СУММА(УслугиПрочиеАктивы.СуммаНДС) КАК СуммаНДС,
	|	ВЫБОР
	|		КОГДА УслугиПрочиеАктивы.Ссылка.НалогообложениеНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаОблагаетсяЕНВД)
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ КАК ОперацияОблагаетсяЕНВД,
	|	ЛОЖЬ КАК ТоварМировойБиржевойТорговли,
	|	ЗНАЧЕНИЕ(Справочник.СтраныМира.Пустаяссылка) КАК СтранаПроисхождения,
	|	ДокументыКонтролируемыхСделок.ИностранныйКонтрагент,
	|	ДокументыКонтролируемыхСделок.ЗарегистрированВСтранеСЛьготнымНалогообложением,
	|	ДокументыКонтролируемыхСделок.ВзаимозависимыеЛица,
	|	УслугиПрочиеАктивы.ИдентификаторСтроки,
	|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперацииКонтролируемыхСделок.ПрочаяОперация) КАК ХозяйственнаяОперация,
	|	ИСТИНА КАК ВключатьСоставСделок
	|ПОМЕСТИТЬ ТоварыКонтролируемыхСделок
	|ИЗ
	|	Документ.РеализацияУслугПрочихАктивов.Доходы КАК УслугиПрочиеАктивы
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ДокументыКонтролируемыхСделок КАК ДокументыКонтролируемыхСделок
	|		ПО УслугиПрочиеАктивы.Ссылка = ДокументыКонтролируемыхСделок.РасчетныйДокумент
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.РеализацияУслугПрочихАктивов КАК ШапкаДокумента
	|		ПО УслугиПрочиеАктивы.Ссылка = ШапкаДокумента.Ссылка
	|
	|СГРУППИРОВАТЬ ПО
	|	УслугиПрочиеАктивы.Ссылка,
	|	УслугиПрочиеАктивы.СтавкаНДС,
	|	ДокументыКонтролируемыхСделок.ИностранныйКонтрагент,
	|	ДокументыКонтролируемыхСделок.ЗарегистрированВСтранеСЛьготнымНалогообложением,
	|	ДокументыКонтролируемыхСделок.ВзаимозависимыеЛица,
	|	УслугиПрочиеАктивы.ИдентификаторСтроки,
	|	
	|	ВЫБОР 
	|		КОГДА ШапкаДокумента.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РеализацияКлиенту) ТОГДА
	|			""""
	|		КОГДА ШапкаДокумента.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РеализацияВнеоборотныхАктивов) ТОГДА
	|			ВЫБОР
	|				КОГДА ТИПЗНАЧЕНИЯ(УслугиПрочиеАктивы.АналитикаДоходов) В (ТИП(Справочник.ОбъектыЭксплуатации),
	|																			ТИП(Справочник.НематериальныеАктивы)) ТОГДА
	|						УслугиПрочиеАктивы.АналитикаДоходов
	|				ИНАЧЕ
	|					""""
	|				КОНЕЦ
	|		КОГДА ШапкаДокумента.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РеализацияУслугПоАренде) ТОГДА
	|			""""
	|		КОНЕЦ, //Предмет сделки
	|		
	|	ВЫБОР 
	|		КОГДА ШапкаДокумента.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РеализацияКлиенту) ТОГДА
	|			УслугиПрочиеАктивы.Содержание
	|		КОГДА ШапкаДокумента.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РеализацияВнеоборотныхАктивов) ТОГДА
	|			ВЫБОР
	|				КОГДА ТИПЗНАЧЕНИЯ(УслугиПрочиеАктивы.АналитикаДоходов) В (ТИП(Справочник.ОбъектыЭксплуатации),
	|																			ТИП(Справочник.НематериальныеАктивы)) ТОГДА
	|						УслугиПрочиеАктивы.АналитикаДоходов
	|				ИНАЧЕ
	|					УслугиПрочиеАктивы.Содержание
	|				КОНЕЦ
	|		КОГДА ШапкаДокумента.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РеализацияУслугПоАренде) ТОГДА
	|			УслугиПрочиеАктивы.Содержание
	|		КОНЕЦ, // Наименование предмета сделки
	|		
	|	ВЫБОР 
	|		КОГДА ШапкаДокумента.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РеализацияКлиенту) ТОГДА
	|			ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.РаботаУслуга)
	|		КОГДА ШапкаДокумента.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РеализацияВнеоборотныхАктивов) ТОГДА
	|			
	|			ВЫБОР
	|				КОГДА ТИПЗНАЧЕНИЯ(УслугиПрочиеАктивы.АналитикаДоходов) В (ТИП(Справочник.ОбъектыЭксплуатации),
	|																			ТИП(Справочник.НематериальныеАктивы)) ТОГДА
	|						ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.ИнойОбъектГражданскихПрав)
	|				ИНАЧЕ
	|					ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.РаботаУслуга)
	|				КОНЕЦ
	|		КОГДА ШапкаДокумента.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РеализацияУслугПоАренде) ТОГДА
	|			ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.РаботаУслуга)
	|		КОНЕЦ, // Тип предмета сделки
	|		
	|	УслугиПрочиеАктивы.ЕдиницаИзмерения,
	|	ВЫБОР
	|		КОГДА УслугиПрочиеАктивы.Ссылка.НалогообложениеНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаОблагаетсяЕНВД)
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ТоварыКонтролируемыхСделок.РасчетныйДокумент КАК РасчетныйДокумент,
	|	ТоварыКонтролируемыхСделок.РасчетныйДокумент.Дата КАК Период,
	|	ТоварыКонтролируемыхСделок.РасчетныйДокумент.Организация КАК Организация,
	|	ТоварыКонтролируемыхСделок.РасчетныйДокумент.Контрагент КАК Контрагент,
	|	ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка) КАК Комиссионер,
	|	ТоварыКонтролируемыхСделок.ПредметСделки,
	|	ТоварыКонтролируемыхСделок.ТипПредметаСделки,
	|	ТоварыКонтролируемыхСделок.НаименованиеПредметаСделки КАК НаименованиеПредметаСделки,
	|	ТоварыКонтролируемыхСделок.СтранаПроисхождения КАК СтранаПроисхожденияПредметаСделки,
	|	ТоварыКонтролируемыхСделок.ХозяйственнаяОперация,
	|	ТоварыКонтролируемыхСделок.РасчетныйДокумент.Валюта КАК Валюта,
	|
	|	ВЫБОР
	|		КОГДА ТоварыКонтролируемыхСделок.ЕдиницаИзмеренияПоКлассификатору = ЗНАЧЕНИЕ(Справочник.УпаковкиЕдиницыИзмерения.ПустаяСсылка) ТОГДА
	|			&ЕдиницаИзмеренияШтука
	|		ИНАЧЕ
	|			ТоварыКонтролируемыхСделок.ЕдиницаИзмеренияПоКлассификатору
	|		КОНЕЦ  КАК ЕдиницаИзмерения,
	|
	|	ВЫБОР
	|		КОГДА ТоварыКонтролируемыхСделок.Количество = 0 ТОГДА
	|			1
	|		ИНАЧЕ
	|			ТоварыКонтролируемыхСделок.Количество
	|		КОНЕЦ КАК Количество,
	|
	|	ТоварыКонтролируемыхСделок.СтавкаНДС,
	|	ТоварыКонтролируемыхСделок.СуммаБезНДС,
	|	ТоварыКонтролируемыхСделок.СуммаНДС,
	|	ТоварыКонтролируемыхСделок.ТипКонтролируемойСделки,
	|	ТоварыКонтролируемыхСделок.ТоварМировойБиржевойТорговли,
	|	ТоварыКонтролируемыхСделок.ОперацияОблагаетсяЕНВД,
	|	ВЫБОР
	|		КОГДА ТоварыКонтролируемыхСделок.ТипПредметаСделки = ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.Товар)
	|			ТОГДА ВЫБОР
	|					КОГДА ТоварыКонтролируемыхСделок.РасчетныйДокумент.Грузоотправитель = ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	|						ТОГДА ТоварыКонтролируемыхСделок.РасчетныйДокумент.Организация
	|					ИНАЧЕ ТоварыКонтролируемыхСделок.РасчетныйДокумент.Грузоотправитель
	|				КОНЕЦ
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	|	КОНЕЦ КАК Грузоотправитель,
	|	ВЫБОР
	|		КОГДА ТоварыКонтролируемыхСделок.ТипПредметаСделки = ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.Товар)
	|			ТОГДА ВЫБОР
	|					КОГДА ТоварыКонтролируемыхСделок.РасчетныйДокумент.Грузополучатель = ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	|						ТОГДА ТоварыКонтролируемыхСделок.РасчетныйДокумент.Контрагент
	|					ИНАЧЕ ТоварыКонтролируемыхСделок.РасчетныйДокумент.Грузополучатель
	|				КОНЕЦ
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	|	КОНЕЦ КАК Грузополучатель,
	|	ВЫБОР
	|		КОГДА &ИспользованиеДоговоров
	|			ТОГДА ТоварыКонтролируемыхСделок.РасчетныйДокумент.Договор
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК Договор,
	|	ВЫБОР
	|		КОГДА &ИспользованиеСоглашений
	|			ТОГДА ТоварыКонтролируемыхСделок.РасчетныйДокумент.Соглашение
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК Соглашение,
	|	ТоварыКонтролируемыхСделок.ИдентификаторСтроки КАК ИдентификаторСтроки,
	|	ТоварыКонтролируемыхСделок.РасчетныйДокумент КАК РегистраторРегистраСумм,
	|	1 КАК МножительСуммовыхДанных
	|ПОМЕСТИТЬ ТаблицаСделок
	|ИЗ
	|	ТоварыКонтролируемыхСделок КАК ТоварыКонтролируемыхСделок
	|ГДЕ
	|	(ТоварыКонтролируемыхСделок.ТоварМировойБиржевойТорговли
	|				И ТоварыКонтролируемыхСделок.ИностранныйКонтрагент
	|			ИЛИ ТоварыКонтролируемыхСделок.ВзаимозависимыеЛица
	|			ИЛИ ТоварыКонтролируемыхСделок.ЗарегистрированВСтранеСЛьготнымНалогообложением)
	|	И ТоварыКонтролируемыхСделок.ВключатьСоставСделок
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	РегистраторРегистраСумм,
	|	ИдентификаторСтроки";
	
	Запрос.Выполнить();
	
	ВыборкаСделокРеализации = ПолучитьВыборкуТаблицыСделокСПреобразованиемСуммКРублевым(Запрос.МенеджерВременныхТаблиц);
	
	Пока ВыборкаСделокРеализации.Следующий() Цикл
		СтрокаСделки = ТаблицаСделок.Добавить();
		ЗаполнитьЗначенияСвойств(СтрокаСделки, ВыборкаСделокРеализации);
	КонецЦикла;
	
	ЗапросУдаленияВременныхТаблиц = Новый Запрос();
	ЗапросУдаленияВременныхТаблиц.МенеджерВременныхТаблиц = Запрос.МенеджерВременныхТаблиц;
	ЗапросУдаленияВременныхТаблиц.Текст = 
	"УНИЧТОЖИТЬ ДокументыКонтролируемыхСделок
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ТоварыКонтролируемыхСделок
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ТаблицаСделок";
	
	ЗапросУдаленияВременныхТаблиц.Выполнить();
	
КонецПроцедуры

// Добавляет в список контролируемых сделок акты выполненных работ.
//
// Параметры:
//  СтруктураПараметров - Структура - параметры контролируемых сделок:
//  * ВалютаРегламентированногоУчета - СправочникСсылка.Валюты - валюта регламетированного учета.
//  * НачалоПериода                  - Дата - начало периода формирования списка контролируемых сделок.
//  * ОкончаниеПериода               - Дата - окончание периода формирования списка контролируемых сделок.
//  * Организация                    - СправочникСсылка.Организации - код места представления.
//  * СписокПодчиненныхОрганизаций   - СписокЗначений из СправочникСсылка.Организации - список подчиненных организаций.
//  МенеджерВременныхТаблиц          - МенеджерВременныхТаблиц - временные таблицы запроса по контролируемым сделкам.
//  ТаблицаСделок                    - ТаблицаЗначений - таблица значений с данными о контролируемых сделках.
//
Процедура ДобавитьСделкиАктаВыполненныхРабот(СтруктураПараметров, МенеджерВременныхТаблиц, ТаблицаСделок)
	
	Запрос = ПодготовитьЗапросКДокументамИсточникам(СтруктураПараметров);
	Запрос.УстановитьПараметр("ИспользованиеСоглашений", ПолучитьФункциональнуюОпцию("ИспользоватьСоглашенияСКлиентами"));
	Запрос.УстановитьПараметр("ИспользованиеДоговоров", ПолучитьФункциональнуюОпцию("ИспользоватьДоговорыСКлиентами"));
	Запрос.МенеджерВременныхТаблиц = МенеджерВременныхТаблиц;
	Запрос.Текст =
	"ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	АктВыполненныхРабот.Ссылка КАК РасчетныйДокумент,
	|	ВЫБОР
	|		КОГДА АктВыполненныхРабот.Контрагент ЕСТЬ NULL 
	|			ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА
	|	КОНЕЦ КАК ВзаимозависимыеЛица,
	|	ВЫБОР
	|		КОГДА ИностранныеКонтрагенты.Контрагент ЕСТЬ NULL 
	|			ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА
	|	КОНЕЦ КАК ИностранныйКонтрагент,
	|	ЕСТЬNULL(ИностранныеКонтрагенты.ЗарегистрированВСтранеСЛьготнымНалогообложением, ЛОЖЬ) КАК ЗарегистрированВСтранеСЛьготнымНалогообложением
	|ПОМЕСТИТЬ ДокументыКонтролируемыхСделок
	|ИЗ
	|	Документ.АктВыполненныхРабот КАК АктВыполненныхРабот
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВзаимозависимыеЛицаПоПериодам КАК ВзаимозависимыеЛицаПоПериодам
	|		ПО (ВзаимозависимыеЛицаПоПериодам.Организация = &Организация)
	|			И (ВзаимозависимыеЛицаПоПериодам.Контрагент = АктВыполненныхРабот.Контрагент)
	|			И АктВыполненныхРабот.Дата >= ВзаимозависимыеЛицаПоПериодам.НачалоПериода
	|			И АктВыполненныхРабот.Дата <= ВзаимозависимыеЛицаПоПериодам.ОкончаниеПериода
	|		ЛЕВОЕ СОЕДИНЕНИЕ ИностранныеКонтрагенты КАК ИностранныеКонтрагенты
	|		ПО (ИностранныеКонтрагенты.Контрагент = АктВыполненныхРабот.Контрагент)
	|      ЛЕВОЕ СОЕДИНЕНИЕ Документ.Сторно как ДокументыСторно 
	|      ПО АктВыполненныхРабот.Ссылка = ДокументыСторно.СторнируемыйДокумент
	|      И ДокументыСторно.Проведен
	|ГДЕ
	|	АктВыполненныхРабот.Организация В(&СтруктураОрганизации)
	|	И АктВыполненныхРабот.Дата >= &НачалоПериода
	|	И АктВыполненныхРабот.Дата <= &ОкончаниеПериода
	|	И АктВыполненныхРабот.Проведен
	|	И АктВыполненныхРабот.Контрагент В
	|			(ВЫБРАТЬ
	|				КонтролируемыеКонтрагенты.Контрагент
	|			ИЗ
	|				КонтролируемыеКонтрагенты КАК КонтролируемыеКонтрагенты)
	|	И (НЕ ВзаимозависимыеЛицаПоПериодам.Контрагент ЕСТЬ NULL 
	|			ИЛИ НЕ ИностранныеКонтрагенты.Контрагент ЕСТЬ NULL )
	|	И ВЫБОР
	|			КОГДА АктВыполненныхРабот.Договор = ЗНАЧЕНИЕ(Справочник.ДоговорыКонтрагентов.ПустаяСсылка)
	|				ТОГДА ИСТИНА
	|			ИНАЧЕ АктВыполненныхРабот.Договор.ТипДоговора = ЗНАЧЕНИЕ(Перечисление.ТипыДоговоров.СПокупателем)
	|		КОНЕЦ
	|   И ДокументыСторно.СторнируемыйДокумент ЕСТЬ NULL
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	РасчетныйДокумент
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	АктВыполненныхРаботУслуги.Ссылка КАК РасчетныйДокумент,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыКонтролируемыхСделок.ПолученДоход) КАК ТипКонтролируемойСделки,
	|	АктВыполненныхРаботУслуги.Номенклатура КАК ПредметСделки,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.РаботаУслуга) КАК ТипПредметаСделки,
	|	АктВыполненныхРаботУслуги.Содержание КАК НаименованиеПредметаСделки,
	|	СУММА(АктВыполненныхРаботУслуги.Количество) КАК Количество,
	|	АктВыполненныхРаботУслуги.Номенклатура.ЕдиницаИзмерения КАК ЕдиницаИзмеренияПоКлассификатору,
	|	АктВыполненныхРаботУслуги.СтавкаНДС,
	|	СУММА(АктВыполненныхРаботУслуги.СуммаСНДС - АктВыполненныхРаботУслуги.СуммаНДС) КАК СуммаБезНДС,
	|	СУММА(АктВыполненныхРаботУслуги.СуммаНДС) КАК СуммаНДС,
	|	ВЫБОР
	|		КОГДА АктВыполненныхРаботУслуги.Ссылка.НалогообложениеНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаОблагаетсяЕНВД)
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ КАК ОперацияОблагаетсяЕНВД,
	|	ЛОЖЬ КАК ТоварМировойБиржевойТорговли,
	|	ВЫБОР
	|		КОГДА ЕСТЬNULL(АктВыполненныхРаботУслуги.Характеристика.Принципал, АктВыполненныхРаботУслуги.Номенклатура.Принципал) = НЕОПРЕДЕЛЕНО
	|				ИЛИ ЕСТЬNULL(АктВыполненныхРаботУслуги.Характеристика.Принципал, АктВыполненныхРаботУслуги.Номенклатура.Принципал) = АктВыполненныхРаботУслуги.Ссылка.Организация
	|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперацииКонтролируемыхСделок.РеализацияСобственныхУслуг)
	|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперацииКонтролируемыхСделок.РеализацияКомиссионныхУслуг)
	|	КОНЕЦ КАК ХозяйственнаяОперация,
	|	ВЫБОР
	|		КОГДА ЕСТЬNULL(АктВыполненныхРаботУслуги.Характеристика.Принципал, АктВыполненныхРаботУслуги.Номенклатура.Принципал) = НЕОПРЕДЕЛЕНО
	|				ИЛИ ЕСТЬNULL(АктВыполненныхРаботУслуги.Характеристика.Принципал, АктВыполненныхРаботУслуги.Номенклатура.Принципал) = АктВыполненныхРаботУслуги.Ссылка.Организация
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ КАК ВключатьСоставСделок,
	|	ЗНАЧЕНИЕ(Справочник.СтраныМира.Пустаяссылка) КАК СтранаПроисхождения,
	|	ДокументыКонтролируемыхСделок.ИностранныйКонтрагент,
	|	ДокументыКонтролируемыхСделок.ЗарегистрированВСтранеСЛьготнымНалогообложением,
	|	ДокументыКонтролируемыхСделок.ВзаимозависимыеЛица,
	|	АктВыполненныхРаботУслуги.ИдентификаторСтроки
	|ПОМЕСТИТЬ ТоварыКонтролируемыхСделок
	|ИЗ
	|	Документ.АктВыполненныхРабот.Услуги КАК АктВыполненныхРаботУслуги
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ДокументыКонтролируемыхСделок КАК ДокументыКонтролируемыхСделок
	|		ПО АктВыполненныхРаботУслуги.Ссылка = ДокументыКонтролируемыхСделок.РасчетныйДокумент
	|
	|СГРУППИРОВАТЬ ПО
	|	АктВыполненныхРаботУслуги.Ссылка,
	|	АктВыполненныхРаботУслуги.СтавкаНДС,
	|	ДокументыКонтролируемыхСделок.ЗарегистрированВСтранеСЛьготнымНалогообложением,
	|	АктВыполненныхРаботУслуги.ИдентификаторСтроки,
	|	АктВыполненныхРаботУслуги.Содержание,
	|	АктВыполненныхРаботУслуги.Номенклатура,
	|	АктВыполненныхРаботУслуги.Номенклатура.ЕдиницаИзмерения,
	|	ДокументыКонтролируемыхСделок.ИностранныйКонтрагент,
	|	ДокументыКонтролируемыхСделок.ВзаимозависимыеЛица,
	|	ВЫБОР
	|		КОГДА АктВыполненныхРаботУслуги.Ссылка.НалогообложениеНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаОблагаетсяЕНВД)
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА ЕСТЬNULL(АктВыполненныхРаботУслуги.Характеристика.Принципал, АктВыполненныхРаботУслуги.Номенклатура.Принципал) = НЕОПРЕДЕЛЕНО
	|				ИЛИ ЕСТЬNULL(АктВыполненныхРаботУслуги.Характеристика.Принципал, АктВыполненныхРаботУслуги.Номенклатура.Принципал) = АктВыполненныхРаботУслуги.Ссылка.Организация
	|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперацииКонтролируемыхСделок.РеализацияСобственныхУслуг)
	|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперацииКонтролируемыхСделок.РеализацияКомиссионныхУслуг)
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА ЕСТЬNULL(АктВыполненныхРаботУслуги.Характеристика.Принципал, АктВыполненныхРаботУслуги.Номенклатура.Принципал) = НЕОПРЕДЕЛЕНО
	|				ИЛИ ЕСТЬNULL(АктВыполненныхРаботУслуги.Характеристика.Принципал, АктВыполненныхРаботУслуги.Номенклатура.Принципал) = АктВыполненныхРаботУслуги.Ссылка.Организация
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ТоварыКонтролируемыхСделок.РасчетныйДокумент КАК РасчетныйДокумент,
	|	ТоварыКонтролируемыхСделок.РасчетныйДокумент.Дата КАК Период,
	|	ТоварыКонтролируемыхСделок.РасчетныйДокумент.Организация КАК Организация,
	|	ТоварыКонтролируемыхСделок.РасчетныйДокумент.Контрагент КАК Контрагент,
	|	ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка) КАК Комиссионер,
	|	ТоварыКонтролируемыхСделок.ПредметСделки,
	|	ТоварыКонтролируемыхСделок.ТипПредметаСделки,
	|	ТоварыКонтролируемыхСделок.НаименованиеПредметаСделки КАК НаименованиеПредметаСделки,
	|	ТоварыКонтролируемыхСделок.СтранаПроисхождения КАК СтранаПроисхожденияПредметаСделки,
	|	ТоварыКонтролируемыхСделок.ХозяйственнаяОперация,
	|	ТоварыКонтролируемыхСделок.РасчетныйДокумент.Валюта КАК Валюта,
	|	ТоварыКонтролируемыхСделок.ЕдиницаИзмеренияПоКлассификатору КАК ЕдиницаИзмерения,
	|	ТоварыКонтролируемыхСделок.Количество,
	|	ТоварыКонтролируемыхСделок.СтавкаНДС,
	|	ТоварыКонтролируемыхСделок.СуммаБезНДС,
	|	ТоварыКонтролируемыхСделок.СуммаНДС,
	|	ТоварыКонтролируемыхСделок.ТипКонтролируемойСделки,
	|	ТоварыКонтролируемыхСделок.ТоварМировойБиржевойТорговли,
	|	ТоварыКонтролируемыхСделок.ОперацияОблагаетсяЕНВД,
	|	ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка) КАК Грузоотправитель,
	|	ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка) КАК Грузополучатель,
	|	ВЫБОР
	|		КОГДА &ИспользованиеДоговоров
	|			ТОГДА ТоварыКонтролируемыхСделок.РасчетныйДокумент.Договор
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК Договор,
	|	ВЫБОР
	|		КОГДА &ИспользованиеСоглашений
	|			ТОГДА ТоварыКонтролируемыхСделок.РасчетныйДокумент.Соглашение
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК Соглашение,
	|	ТоварыКонтролируемыхСделок.ИдентификаторСтроки КАК ИдентификаторСтроки,
	|	ТоварыКонтролируемыхСделок.РасчетныйДокумент КАК РегистраторРегистраСумм,
	|	1 КАК МножительСуммовыхДанных
	|ПОМЕСТИТЬ ТаблицаСделок
	|ИЗ
	|	ТоварыКонтролируемыхСделок КАК ТоварыКонтролируемыхСделок
	|ГДЕ
	|	(ТоварыКонтролируемыхСделок.ТоварМировойБиржевойТорговли
	|				И ТоварыКонтролируемыхСделок.ИностранныйКонтрагент
	|			ИЛИ ТоварыКонтролируемыхСделок.ВзаимозависимыеЛица
	|			ИЛИ ТоварыКонтролируемыхСделок.ЗарегистрированВСтранеСЛьготнымНалогообложением)
	|	И ТоварыКонтролируемыхСделок.ВключатьСоставСделок
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	РегистраторРегистраСумм,
	|	ИдентификаторСтроки";
	
	Запрос.Выполнить();
	
	ВыборкаСделокРеализации = ПолучитьВыборкуТаблицыСделокСПреобразованиемСуммКРублевым(Запрос.МенеджерВременныхТаблиц);
	
	Пока ВыборкаСделокРеализации.Следующий() Цикл
		СтрокаСделки = ТаблицаСделок.Добавить();
		ЗаполнитьЗначенияСвойств(СтрокаСделки, ВыборкаСделокРеализации);
	КонецЦикла;
	
	ЗапросУдаленияВременныхТаблиц = Новый Запрос();
	ЗапросУдаленияВременныхТаблиц.МенеджерВременныхТаблиц = Запрос.МенеджерВременныхТаблиц;
	ЗапросУдаленияВременныхТаблиц.Текст = 
	"УНИЧТОЖИТЬ ДокументыКонтролируемыхСделок
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ТоварыКонтролируемыхСделок
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ТаблицаСделок";
	
	ЗапросУдаленияВременныхТаблиц.Выполнить();
	
КонецПроцедуры

// Добавляет в список контролируемых сделок возвраты товаров от покупателей.
//
// Параметры:
//  СтруктураПараметров - Структура - параметры контролируемых сделок:
//  * ВалютаРегламентированногоУчета - СправочникСсылка.Валюты - валюта регламетированного учета.
//  * НачалоПериода                  - Дата - начало периода формирования списка контролируемых сделок.
//  * ОкончаниеПериода               - Дата - окончание периода формирования списка контролируемых сделок.
//  * Организация                    - СправочникСсылка.Организации - код места представления.
//  * СписокПодчиненныхОрганизаций   - СписокЗначений из СправочникСсылка.Организации - список подчиненных организаций.
//  МенеджерВременныхТаблиц          - МенеджерВременныхТаблиц - временные таблицы запроса по контролируемым сделкам.
//  ТаблицаСделок                    - ТаблицаЗначений - таблица значений с данными о контролируемых сделках.
//
Процедура ДобавитьСделкиВозвратаТоваровОтПокупателя(СтруктураПараметров, МенеджерВременныхТаблиц, ТаблицаСделок)
	
	Запрос = ПодготовитьЗапросКДокументамИсточникам(СтруктураПараметров);
	Запрос.УстановитьПараметр("ИспользованиеСоглашений", ПолучитьФункциональнуюОпцию("ИспользоватьСоглашенияСКлиентами"));
	Запрос.УстановитьПараметр("ИспользованиеДоговоров", ПолучитьФункциональнуюОпцию("ИспользоватьДоговорыСКлиентами"));
	Запрос.МенеджерВременныхТаблиц = МенеджерВременныхТаблиц;
	Запрос.Текст =
	"ВЫБРАТЬ РАЗЛИЧНЫЕ РАЗРЕШЕННЫЕ        
	|	ВозвратТоваровОтКлиента.Ссылка КАК ДокументВозврата,
	|	ВозвратТоваровОтКлиента.Организация,
	|	ЕстьNull(РеализацияТоваровУслуг.РасчетныйДокумент,ВозвратТоваровОтКлиента.Ссылка) как РасчетныйДокумент,  
	|	ЕстьNull(РеализацияТоваровУслуг.РасчетныйДокумент,Неопределено) как РасчетныйДокументДляСвязи,
	|	ЕстьNull(РеализацияТоваровУслуг.Период,ВозвратТоваровОтКлиента.Дата) как Период,
	|	ВозвратТоваровОтКлиента.Контрагент как Контрагент,
	|	РеализацияТоваровУслуг.Комиссионер,
	|	РеализацияТоваровУслуг.Грузополучатель как Грузополучатель,
	|	РеализацияТоваровУслуг.Грузоотправитель как Грузоотправитель,
	|	ВозвратТоваровОтКлиента.Договор КАК Договор,
	|	ВозвратТоваровОтКлиента.Соглашение,
	|	ВозвратТоваровОтКлиента.Валюта,
	|	ЕСТЬNULL(РеализацияТоваровУслуг.ОперацияОблагаетсяЕНВД,ВозвратТоваровОтКлиента.НалогообложениеНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаОблагаетсяЕНВД)) как ОперацияОблагаетсяЕНВД,
	|	ВозвратТоваровОтКлиента.НалогообложениеНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаОблагаетсяЕНВД) КАК ВозвратОблагаетсяЕНВД,
	|	НЕ ВзаимозависимыеЛицаПоПериодам.Контрагент ЕСТЬ NULL КАК ВзаимозависимыеЛица,
	|	НЕ ИностранныеКонтрагенты.Контрагент ЕСТЬ NULL КАК ИностранныйКонтрагент,
	|	ЕСТЬNULL(ИностранныеКонтрагенты.ЗарегистрированВСтранеСЛьготнымНалогообложением, ЛОЖЬ) КАК ЗарегистрированВСтранеСЛьготнымНалогообложением
	|ПОМЕСТИТЬ ДокументыКонтролируемыхСделок
	|ИЗ
	|	Документ.ВозвратТоваровОтКлиента КАК ВозвратТоваровОтКлиента
	|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.ВозвратТоваровОтКлиента.Товары КАК ВозвратТоваровОтКлиентаТовары
	|		ПО ВозвратТоваровОтКлиентаТовары.Ссылка = ВозвратТоваровОтКлиента.Ссылка
	|			И ВозвратТоваровОтКлиента.ДокументРеализации = НЕОПРЕДЕЛЕНО
	|	ЛЕВОЕ СОЕДИНЕНИЕ ДокументыРеализацияТоваровУслугДляАнализа КАК РеализацияТоваровУслуг  
	|		ПО ЕСТЬNULL(ВозвратТоваровОтКлиентаТовары.ДокументРеализации, ВозвратТоваровОтКлиента.ДокументРеализации) = РеализацияТоваровУслуг.РасчетныйДокумент
	|	ЛЕВОЕ СОЕДИНЕНИЕ ВзаимозависимыеЛицаПоПериодам КАК ВзаимозависимыеЛицаПоПериодам
	|		ПО (ВзаимозависимыеЛицаПоПериодам.Организация = &Организация)
	|			И ЕСТЬNULL(РеализацияТоваровУслуг.Контрагент,ВозвратТоваровОтКлиента.Контрагент) = ВзаимозависимыеЛицаПоПериодам.Контрагент
	|			И ЕСТЬNULL(РеализацияТоваровУслуг.Период,ВозвратТоваровОтКлиента.Дата) >= ВзаимозависимыеЛицаПоПериодам.НачалоПериода
	|			И ЕСТЬNULL(РеализацияТоваровУслуг.Период,ВозвратТоваровОтКлиента.Дата) <= ВзаимозависимыеЛицаПоПериодам.ОкончаниеПериода
	|	ЛЕВОЕ СОЕДИНЕНИЕ ИностранныеКонтрагенты КАК ИностранныеКонтрагенты
	|		ПО (ИностранныеКонтрагенты.Контрагент = ВозвратТоваровОтКлиента.Контрагент)
	|      ЛЕВОЕ СОЕДИНЕНИЕ Документ.Сторно как ДокументыСторно 
	|      ПО ВозвратТоваровОтКлиента.Ссылка = ДокументыСторно.СторнируемыйДокумент
	|      И ДокументыСторно.Проведен
	|ГДЕ
	|	ВозвратТоваровОтКлиента.Организация В (&СтруктураОрганизации)
	|	И ВозвратТоваровОтКлиента.Дата >= &НачалоПериода
	|	И ВозвратТоваровОтКлиента.Проведен
	|	И ВозвратТоваровОтКлиента.Контрагент В
	|			(ВЫБРАТЬ
	|				КонтролируемыеКонтрагенты.Контрагент
	|			ИЗ
	|				КонтролируемыеКонтрагенты КАК КонтролируемыеКонтрагенты)
	|	И ЕСТЬNULL(РеализацияТоваровУслуг.Период,ВозвратТоваровОтКлиента.Дата) >= &НачалоПериода
	|	И ЕСТЬNULL(РеализацияТоваровУслуг.Период,ВозвратТоваровОтКлиента.Дата) <= &ОкончаниеПериода
	|	И (НЕ ВзаимозависимыеЛицаПоПериодам.Контрагент ЕСТЬ NULL
	|		ИЛИ НЕ ИностранныеКонтрагенты.Контрагент ЕСТЬ NULL)
	|   И ДокументыСторно.СторнируемыйДокумент ЕСТЬ NULL
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	ДокументВозврата
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	ТоварыВозврата.Ссылка КАК Сделка,
	|	ДокументыКонтролируемыхСделок.РасчетныйДокумент КАК РасчетныйДокумент,
	|	ДокументыКонтролируемыхСделок.Период,
	|	ДокументыКонтролируемыхСделок.Организация,
	|	ДокументыКонтролируемыхСделок.Контрагент,
	|	ДокументыКонтролируемыхСделок.Комиссионер,
	|	ДокументыКонтролируемыхСделок.Валюта,
	|	ДокументыКонтролируемыхСделок.Грузополучатель,
	|	ДокументыКонтролируемыхСделок.Грузоотправитель,
	|	ДокументыКонтролируемыхСделок.Договор,
	|	ДокументыКонтролируемыхСделок.Соглашение,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыКонтролируемыхСделок.ПолученДоход) КАК ТипКонтролируемойСделки,
	|	Аналитика.Номенклатура КАК ПредметСделки,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.Товар) КАК ТипПредметаСделки,
	|	СУММА(ТоварыВозврата.Количество) КАК Количество,
	|	Аналитика.Номенклатура.ЕдиницаИзмерения КАК ЕдиницаИзмеренияПоКлассификатору,
	|	ТоварыВозврата.СтавкаНДС,
	|	СУММА(ТоварыВозврата.СуммаСНДС - ТоварыВозврата.СуммаНДС) КАК СуммаБезНДС,
	|	СУММА(ТоварыВозврата.СуммаНДС) КАК СуммаНДС,
	|	ДокументыКонтролируемыхСделок.ВозвратОблагаетсяЕНВД КАК ОперацияОблагаетсяЕНВД,
	|	ВЫБОР
	|		КОГДА ТоварыМировойБиржевойТорговли.ПредметСделки ЕСТЬ NULL 
	|			ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА
	|	КОНЕЦ КАК ТоварМировойБиржевойТорговли,
	|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперацииКонтролируемыхСделок.ВозвратТоваров) КАК ХозяйственнаяОперация,
	|	ВЫБОР
	|		КОГДА ТоварыВозврата.ВидЗапасов.ТипЗапасов В (ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.ПустаяСсылка), ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.Товар))
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ КАК ВключатьСоставСделок,
	|	ЕСТЬNULL(ТоварыВозврата.НомерГТД.СтранаПроисхождения, ЗНАЧЕНИЕ(Справочник.СтраныМира.Россия)) КАК СтранаПроисхождения,
	|	ДокументыКонтролируемыхСделок.ИностранныйКонтрагент,
	|	ДокументыКонтролируемыхСделок.ЗарегистрированВСтранеСЛьготнымНалогообложением,
	|	ДокументыКонтролируемыхСделок.ВзаимозависимыеЛица,
	|	ТоварыВозврата.ИдентификаторСтроки
	|ПОМЕСТИТЬ ТоварыКонтролируемыхСделок
	|ИЗ
	|	Документ.ВозвратТоваровОтКлиента.ВидыЗапасов КАК ТоварыВозврата
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК Аналитика
	|		ПО ТоварыВозврата.АналитикаУчетаНоменклатуры = Аналитика.Ссылка
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ДокументыКонтролируемыхСделок КАК ДокументыКонтролируемыхСделок
	|		ПО ТоварыВозврата.Ссылка = ДокументыКонтролируемыхСделок.ДокументВозврата
	|			И ТоварыВозврата.ДокументРеализации = ДокументыКонтролируемыхСделок.РасчетныйДокументДляСвязи 
	|		ЛЕВОЕ СОЕДИНЕНИЕ ТоварыМировойБиржевойТорговли КАК ТоварыМировойБиржевойТорговли
	|		ПО Аналитика.Номенклатура = ТоварыМировойБиржевойТорговли.ПредметСделки
	|			И ТоварыМировойБиржевойТорговли.ДатаНачалаДействия <= ДокументыКонтролируемыхСделок.Период
	|			И ТоварыМировойБиржевойТорговли.ДатаОкончанияДействия >= ДокументыКонтролируемыхСделок.Период
	|
	|СГРУППИРОВАТЬ ПО
	|	ТоварыВозврата.СтавкаНДС,
	|	ДокументыКонтролируемыхСделок.ЗарегистрированВСтранеСЛьготнымНалогообложением,
	|	ДокументыКонтролируемыхСделок.ИностранныйКонтрагент,
	|	ДокументыКонтролируемыхСделок.ВзаимозависимыеЛица,
	|	ДокументыКонтролируемыхСделок.РасчетныйДокумент,
	|	ДокументыКонтролируемыхСделок.Период,
	|	ДокументыКонтролируемыхСделок.Организация,
	|	ДокументыКонтролируемыхСделок.Контрагент,
	|	ДокументыКонтролируемыхСделок.Комиссионер,
	|	ДокументыКонтролируемыхСделок.Валюта,
	|	ДокументыКонтролируемыхСделок.Грузополучатель,
	|	ДокументыКонтролируемыхСделок.Грузоотправитель,
	|	ДокументыКонтролируемыхСделок.Договор,
	|	ДокументыКонтролируемыхСделок.Соглашение,
	|	ТоварыВозврата.Ссылка,
	|	Аналитика.Номенклатура,
	|	Аналитика.Номенклатура.ЕдиницаИзмерения,
	|	ТоварыВозврата.ИдентификаторСтроки,
	|	ДокументыКонтролируемыхСделок.ВозвратОблагаетсяЕНВД,
	|	ВЫБОР
	|		КОГДА ТоварыМировойБиржевойТорговли.ПредметСделки ЕСТЬ NULL 
	|			ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА ТоварыВозврата.ВидЗапасов.ТипЗапасов В (ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.ПустаяСсылка), ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.Товар))
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ,
	|	ЕСТЬNULL(ТоварыВозврата.НомерГТД.СтранаПроисхождения, ЗНАЧЕНИЕ(Справочник.СтраныМира.Россия))
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ТоварыКонтролируемыхСделок.РасчетныйДокумент КАК РасчетныйДокумент,
	|	ТоварыКонтролируемыхСделок.Период,
	|	ТоварыКонтролируемыхСделок.Организация,
	|	ТоварыКонтролируемыхСделок.Контрагент,
	|	ТоварыКонтролируемыхСделок.Комиссионер,
	|	ТоварыКонтролируемыхСделок.ПредметСделки,
	|	ТоварыКонтролируемыхСделок.ТипПредметаСделки,
	|	ТоварыКонтролируемыхСделок.ПредметСделки.НаименованиеПолное КАК НаименованиеПредметаСделки,
	|	ТоварыКонтролируемыхСделок.СтранаПроисхождения КАК СтранаПроисхожденияПредметаСделки,
	|	ТоварыКонтролируемыхСделок.ХозяйственнаяОперация,
	|	ТоварыКонтролируемыхСделок.Валюта,
	|	ТоварыКонтролируемыхСделок.ЕдиницаИзмеренияПоКлассификатору КАК ЕдиницаИзмерения,
	|	ТоварыКонтролируемыхСделок.Количество,
	|	ТоварыКонтролируемыхСделок.СтавкаНДС,
	|	ТоварыКонтролируемыхСделок.СуммаБезНДС,
	|	ТоварыКонтролируемыхСделок.СуммаНДС,
	|	ТоварыКонтролируемыхСделок.ТипКонтролируемойСделки,
	|	ТоварыКонтролируемыхСделок.ТоварМировойБиржевойТорговли,
	|	ТоварыКонтролируемыхСделок.ОперацияОблагаетсяЕНВД,
	|	ТоварыКонтролируемыхСделок.Грузополучатель,
	|	ТоварыКонтролируемыхСделок.Грузоотправитель,
	|	ТоварыКонтролируемыхСделок.Договор,
	|	ТоварыКонтролируемыхСделок.Соглашение,
	|	ТоварыКонтролируемыхСделок.Сделка КАК РегистраторРегистраСумм,
	|	ТоварыКонтролируемыхСделок.ИдентификаторСтроки КАК ИдентификаторСтроки,
	|	-1 КАК МножительСуммовыхДанных
	|ПОМЕСТИТЬ ТаблицаСделок
	|ИЗ
	|	ТоварыКонтролируемыхСделок КАК ТоварыКонтролируемыхСделок
	|ГДЕ
	|	(ТоварыКонтролируемыхСделок.ТоварМировойБиржевойТорговли
	|				И ТоварыКонтролируемыхСделок.ИностранныйКонтрагент
	|			ИЛИ ТоварыКонтролируемыхСделок.ВзаимозависимыеЛица
	|			ИЛИ ТоварыКонтролируемыхСделок.ЗарегистрированВСтранеСЛьготнымНалогообложением)
	|	И ТоварыКонтролируемыхСделок.ВключатьСоставСделок
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	РегистраторРегистраСумм,
	|	ИдентификаторСтроки";
	
	Запрос.Выполнить();
	
	ВыборкаСделокРеализации = ПолучитьВыборкуТаблицыСделокСПреобразованиемСуммКРублевым(Запрос.МенеджерВременныхТаблиц);
	
	Пока ВыборкаСделокРеализации.Следующий() Цикл
		СтрокаСделки = ТаблицаСделок.Добавить();
		ЗаполнитьЗначенияСвойств(СтрокаСделки, ВыборкаСделокРеализации);
	КонецЦикла;
	
	ЗапросУдаленияВременныхТаблиц = Новый Запрос();
	ЗапросУдаленияВременныхТаблиц.МенеджерВременныхТаблиц = Запрос.МенеджерВременныхТаблиц;
	ЗапросУдаленияВременныхТаблиц.Текст = 
	"УНИЧТОЖИТЬ ДокументыКонтролируемыхСделок
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ТоварыКонтролируемыхСделок
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ТаблицаСделок";
	
	ЗапросУдаленияВременныхТаблиц.Выполнить();
	
КонецПроцедуры

// Добавляет в список контролируемых сделок корректировки реализаций.
//
// Параметры:
//  СтруктураПараметров - Структура - параметры контролируемых сделок:
//  * ВалютаРегламентированногоУчета - СправочникСсылка.Валюты - валюта регламетированного учета.
//  * НачалоПериода                  - Дата - начало периода формирования списка контролируемых сделок.
//  * ОкончаниеПериода               - Дата - окончание периода формирования списка контролируемых сделок.
//  * Организация                    - СправочникСсылка.Организации - код места представления.
//  * СписокПодчиненныхОрганизаций   - СписокЗначений из СправочникСсылка.Организации - список подчиненных организаций.
//  МенеджерВременныхТаблиц          - МенеджерВременныхТаблиц - временные таблицы запроса по контролируемым сделкам.
//  ТаблицаСделок                    - ТаблицаЗначений - таблица значений с данными о контролируемых сделках.
//
Процедура ДобавитьСделкиКорректировкиРеализации(СтруктураПараметров, МенеджерВременныхТаблиц, ТаблицаСделок)
	
	Запрос = ПодготовитьЗапросКДокументамИсточникам(СтруктураПараметров);
	Запрос.УстановитьПараметр("ИспользованиеСоглашений", ПолучитьФункциональнуюОпцию("ИспользоватьСоглашенияСКлиентами"));
	Запрос.УстановитьПараметр("ИспользованиеДоговоров", ПолучитьФункциональнуюОпцию("ИспользоватьДоговорыСКлиентами"));
	Запрос.МенеджерВременныхТаблиц = МенеджерВременныхТаблиц;
	Запрос.Текст =
	"ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	КорректировкаРеализации.Ссылка КАК Корректировка,
	|	КорректировкаРеализации.ДокументОснование КАК Реализация,
	|	КорректировкаРеализации.НалогообложениеНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаОблагаетсяЕНВД) КАК КорректировкаОблагаетсяЕНВД
	|ПОМЕСТИТЬ ДокументыКорректировкиИРеализации
	|ИЗ
	|	Документ.КорректировкаРеализации КАК КорректировкаРеализации
	|ГДЕ
	|	КорректировкаРеализации.Организация В(&СтруктураОрганизации)
	|	И КорректировкаРеализации.Дата >= &НачалоПериода
	|	И КорректировкаРеализации.Проведен
	|	И КорректировкаРеализации.Контрагент В
	|			(ВЫБРАТЬ
	|				КонтролируемыеКонтрагенты.Контрагент
	|			ИЗ
	|				КонтролируемыеКонтрагенты КАК КонтролируемыеКонтрагенты)
	|	И ВЫБОР
	|		КОГДА КорректировкаРеализации.Договор = ЗНАЧЕНИЕ(Справочник.ДоговорыКонтрагентов.ПустаяСсылка)
	|		ТОГДА ИСТИНА
	|		КОГДА КорректировкаРеализации.Договор.КомиссионныеПродажи25
	|		ТОГДА КорректировкаРеализации.Договор.ТипДоговора = ЗНАЧЕНИЕ(Перечисление.ТипыДоговоров.СКомиссионером)
	|		ИНАЧЕ КорректировкаРеализации.Договор.ТипДоговора = ЗНАЧЕНИЕ(Перечисление.ТипыДоговоров.СПокупателем)
	|	КОНЕЦ
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Корректировка,
	|	Реализация
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	РеализацияТоваровУслуг.РасчетныйДокумент,
	|	РеализацияТоваровУслуг.Период,
	|	РеализацияТоваровУслуг.Организация,
	|	РеализацияТоваровУслуг.Контрагент,
	|	РеализацияТоваровУслуг.Комиссионер,
	|	РеализацияТоваровУслуг.Валюта,
	|	ДокументыКорректировкиИРеализации.КорректировкаОблагаетсяЕНВД,
	|	РеализацияТоваровУслуг.ОперацияОблагаетсяЕНВД,
	|	РеализацияТоваровУслуг.Грузополучатель,
	|	РеализацияТоваровУслуг.Грузоотправитель,
	|	РеализацияТоваровУслуг.ДоговорКонтрагента КАК Договор,
	|	РеализацияТоваровУслуг.Соглашение КАК Соглашение,
	|	ДокументыКорректировкиИРеализации.Корректировка КАК Корректировка,
	|	РеализацияТоваровУслуг.ВернутьМногооборотнуюТару
	|ПОМЕСТИТЬ ДанныеДокументовКорректировкиИРеализации
	|ИЗ
	|	ДокументыКорректировкиИРеализации КАК ДокументыКорректировкиИРеализации
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ДокументыРеализацияТоваровУслугДляАнализа КАК РеализацияТоваровУслуг
	|		ПО ДокументыКорректировкиИРеализации.Реализация = РеализацияТоваровУслуг.РасчетныйДокумент
	|			И (РеализацияТоваровУслуг.Период >= &НачалоПериода)
	|			И (РеализацияТоваровУслуг.Период <= &ОкончаниеПериода)
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	АктВыполненныхРабот.Ссылка,
	|	АктВыполненныхРабот.Дата,
	|	АктВыполненныхРабот.Организация,
	|	АктВыполненныхРабот.Контрагент,
	|	ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка),
	|	АктВыполненныхРабот.Валюта,
	|	ДокументыКорректировкиИРеализации.КорректировкаОблагаетсяЕНВД,
	|	ВЫБОР
	|		КОГДА АктВыполненныхРабот.НалогообложениеНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаОблагаетсяЕНВД)
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ,
	|	ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка),
	|	ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка),
	|	ВЫБОР
	|		КОГДА &ИспользованиеДоговоров
	|			ТОГДА АктВыполненныхРабот.Договор
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК Договор,
	|	ВЫБОР
	|		КОГДА &ИспользованиеСоглашений
	|			ТОГДА АктВыполненныхРабот.Соглашение
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК Соглашение,
	|	ДокументыКорректировкиИРеализации.Корректировка,
	|	ЛОЖЬ
	|ИЗ
	|	ДокументыКорректировкиИРеализации КАК ДокументыКорректировкиИРеализации
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.АктВыполненныхРабот КАК АктВыполненныхРабот
	|		ПО (АктВыполненныхРабот.Дата >= &НачалоПериода)
	|			И (АктВыполненныхРабот.Дата <= &ОкончаниеПериода)
	|			И (АктВыполненныхРабот.Контрагент В
	|				(ВЫБРАТЬ
	|					КонтролируемыеКонтрагенты.Контрагент
	|				ИЗ
	|					КонтролируемыеКонтрагенты КАК КонтролируемыеКонтрагенты))
	|			И (ВЫБОР
	|				КОГДА АктВыполненныхРабот.Договор = ЗНАЧЕНИЕ(Справочник.ДоговорыКонтрагентов.ПустаяСсылка)
	|					ТОГДА ИСТИНА
	|				ИНАЧЕ АктВыполненныхРабот.Договор.ТипДоговора = ЗНАЧЕНИЕ(Перечисление.ТипыДоговоров.СПокупателем)
	|			КОНЕЦ)
	|			И ДокументыКорректировкиИРеализации.Реализация = АктВыполненныхРабот.Ссылка
	|			И (АктВыполненныхРабот.Проведен)
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	РеализацияУслугПрочихАктивов.Ссылка,
	|	РеализацияУслугПрочихАктивов.Дата,
	|	РеализацияУслугПрочихАктивов.Организация,
	|	РеализацияУслугПрочихАктивов.Контрагент,
	|	ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка),
	|	РеализацияУслугПрочихАктивов.Валюта,
	|	ДокументыКорректировкиИРеализации.КорректировкаОблагаетсяЕНВД,
	|	ВЫБОР
	|		КОГДА РеализацияУслугПрочихАктивов.НалогообложениеНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаОблагаетсяЕНВД)
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА РеализацияУслугПрочихАктивов.Грузополучатель = ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	|			ТОГДА РеализацияУслугПрочихАктивов.Контрагент
	|		ИНАЧЕ РеализацияУслугПрочихАктивов.Грузополучатель
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА РеализацияУслугПрочихАктивов.Грузоотправитель = ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	|			ТОГДА РеализацияУслугПрочихАктивов.Организация
	|		ИНАЧЕ РеализацияУслугПрочихАктивов.Грузоотправитель
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА &ИспользованиеДоговоров
	|			ТОГДА РеализацияУслугПрочихАктивов.Договор
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК Договор,
	|	ВЫБОР
	|		КОГДА &ИспользованиеСоглашений
	|			ТОГДА РеализацияУслугПрочихАктивов.Соглашение
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК Соглашение,
	|	ДокументыКорректировкиИРеализации.Корректировка,
	|	ЛОЖЬ
	|ИЗ
	|	ДокументыКорректировкиИРеализации КАК ДокументыКорректировкиИРеализации
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.РеализацияУслугПрочихАктивов КАК РеализацияУслугПрочихАктивов
	|		ПО (РеализацияУслугПрочихАктивов.Дата <= &ОкончаниеПериода)
	|			И (РеализацияУслугПрочихАктивов.Контрагент В
	|				(ВЫБРАТЬ
	|					КонтролируемыеКонтрагенты.Контрагент
	|				ИЗ
	|					КонтролируемыеКонтрагенты КАК КонтролируемыеКонтрагенты))
	|			И (ВЫБОР
	|				КОГДА РеализацияУслугПрочихАктивов.Договор = ЗНАЧЕНИЕ(Справочник.ДоговорыКонтрагентов.ПустаяСсылка)
	|					ТОГДА ИСТИНА
	|				ИНАЧЕ РеализацияУслугПрочихАктивов.Договор.ТипДоговора = ЗНАЧЕНИЕ(Перечисление.ТипыДоговоров.СПокупателем)
	|			КОНЕЦ)
	|			И ДокументыКорректировкиИРеализации.Реализация = РеализацияУслугПрочихАктивов.Ссылка
	|			И (РеализацияУслугПрочихАктивов.Дата >= &НачалоПериода)
	|			И (РеализацияУслугПрочихАктивов.Проведен)
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Контрагент
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	ДокументыКорректировкиИРеализации.Реализация КАК Реализация,
	|	ВЫБОР 
	|		КОГДА ШапкаДокумента.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РеализацияКлиенту) ТОГДА
	|			ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.РаботаУслуга)
	|		КОГДА ШапкаДокумента.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РеализацияВнеоборотныхАктивов) ТОГДА
	|			
	|			ВЫБОР
	|				КОГДА ТИПЗНАЧЕНИЯ(УслугиПрочиеАктивы.АналитикаДоходов) В (ТИП(Справочник.ОбъектыЭксплуатации),
	|																			ТИП(Справочник.НематериальныеАктивы)) ТОГДА
	|						ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.ИнойОбъектГражданскихПрав)
	|				ИНАЧЕ
	|					ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.РаботаУслуга)
	|				КОНЕЦ
	|		КОГДА ШапкаДокумента.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РеализацияУслугПоАренде) ТОГДА
	|			ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.РаботаУслуга)
	|		КОНЕЦ КАК ТипПредметаСделки
	|ПОМЕСТИТЬ ТипыПредметовСделкиРеализацийПрочихАктивов
	|	ИЗ Документ.РеализацияУслугПрочихАктивов.Доходы КАК УслугиПрочиеАктивы
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ДокументыКорректировкиИРеализации КАК ДокументыКорректировкиИРеализации
	|		ПО УслугиПрочиеАктивы.Ссылка = ДокументыКорректировкиИРеализации.Реализация
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.РеализацияУслугПрочихАктивов КАК ШапкаДокумента
	|		ПО УслугиПрочиеАктивы.Ссылка = ШапкаДокумента.Ссылка 
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	ДанныеДокументовКорректировкиИРеализации.РасчетныйДокумент,
	|	ДанныеДокументовКорректировкиИРеализации.Период,
	|	ДанныеДокументовКорректировкиИРеализации.Организация,
	|	ДанныеДокументовКорректировкиИРеализации.Контрагент,
	|	ДанныеДокументовКорректировкиИРеализации.Комиссионер,
	|	ДанныеДокументовКорректировкиИРеализации.Валюта,
	|	ДанныеДокументовКорректировкиИРеализации.КорректировкаОблагаетсяЕНВД,
	|	ДанныеДокументовКорректировкиИРеализации.ОперацияОблагаетсяЕНВД,
	|	ДанныеДокументовКорректировкиИРеализации.Грузополучатель,
	|	ДанныеДокументовКорректировкиИРеализации.Грузоотправитель,
	|	ДанныеДокументовКорректировкиИРеализации.Договор,
	|	ДанныеДокументовКорректировкиИРеализации.Соглашение,
	|	ДанныеДокументовКорректировкиИРеализации.Корректировка КАК Корректировка,
	|	ВЫБОР
	|		КОГДА ВзаимозависимыеЛицаПоПериодам.Контрагент ЕСТЬ NULL 
	|			ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА
	|	КОНЕЦ КАК ВзаимозависимыеЛица,
	|	ВЫБОР
	|		КОГДА ИностранныеКонтрагенты.Контрагент ЕСТЬ NULL 
	|			ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА
	|	КОНЕЦ КАК ИностранныйКонтрагент,
	|	ЕСТЬNULL(ИностранныеКонтрагенты.ЗарегистрированВСтранеСЛьготнымНалогообложением, ЛОЖЬ) КАК ЗарегистрированВСтранеСЛьготнымНалогообложением,
	|	ДанныеДокументовКорректировкиИРеализации.ВернутьМногооборотнуюТару
	|ПОМЕСТИТЬ ДокументыКонтролируемыхСделок
	|ИЗ
	|	ДанныеДокументовКорректировкиИРеализации КАК ДанныеДокументовКорректировкиИРеализации
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВзаимозависимыеЛицаПоПериодам КАК ВзаимозависимыеЛицаПоПериодам
	|		ПО (ВзаимозависимыеЛицаПоПериодам.Организация = &Организация)
	|			И ДанныеДокументовКорректировкиИРеализации.Контрагент = ВзаимозависимыеЛицаПоПериодам.Контрагент
	|			И ДанныеДокументовКорректировкиИРеализации.Период >= ВзаимозависимыеЛицаПоПериодам.НачалоПериода
	|			И ДанныеДокументовКорректировкиИРеализации.Период <= ВзаимозависимыеЛицаПоПериодам.ОкончаниеПериода
	|		ЛЕВОЕ СОЕДИНЕНИЕ ИностранныеКонтрагенты КАК ИностранныеКонтрагенты
	|		ПО ДанныеДокументовКорректировкиИРеализации.Контрагент = ИностранныеКонтрагенты.Контрагент
	|ГДЕ
	|	(НЕ ВзаимозависимыеЛицаПоПериодам.Контрагент ЕСТЬ NULL 
	|			ИЛИ НЕ ИностранныеКонтрагенты.Контрагент ЕСТЬ NULL )
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Корректировка
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	ДокументыКонтролируемыхСделок.РасчетныйДокумент КАК РасчетныйДокумент,
	|	ДанныеДокумента.Ссылка КАК РегистраторРегистраСумм,
	|	ДокументыКонтролируемыхСделок.Период КАК Период,
	|	ДокументыКонтролируемыхСделок.Организация,
	|	ДокументыКонтролируемыхСделок.Контрагент,
	|	ДокументыКонтролируемыхСделок.Комиссионер,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыКонтролируемыхСделок.ПолученДоход) КАК ТипКонтролируемойСделки,
	|	ЕСТЬNULL(ДанныеНоменклатуры.Ссылка, ДанныеДокумента.Содержание) КАК ПредметСделки,
	|	ЕСТЬNULL(ТипыПредметовСделкиРеализацийПрочихАктивов.ТипПредметаСделки,
	|				ВЫБОР
	|					КОГДА ДанныеНоменклатуры.Ссылка ЕСТЬ NULL
	|					ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.ИнойОбъектГражданскихПрав)
	|					ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.РаботаУслуга)
	|				КОНЕЦ) КАК ТипПредметаСделки,
	|	ЕСТЬNULL(ДанныеНоменклатуры.НаименованиеПолное, ДанныеДокумента.Содержание) КАК НаименованиеПредметаСделки,
	|	ЗНАЧЕНИЕ(Справочник.СтраныМира.ПустаяСсылка) КАК СтранаПроисхожденияПредметаСделки,
	|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперацииКонтролируемыхСделок.Корректировка) КАК ХозяйственнаяОперация,
	|	ЕСТЬNULL(ДанныеДокумента.Характеристика.Принципал, ЕСТЬNULL(ДанныеНоменклатуры.Принципал, НЕОПРЕДЕЛЕНО)) = НЕОПРЕДЕЛЕНО
	|		ИЛИ ЕСТЬNULL(ДанныеДокумента.Характеристика.Принципал, ЕСТЬNULL(ДанныеНоменклатуры.Принципал, НЕОПРЕДЕЛЕНО))
	|		= ДокументыКонтролируемыхСделок.Организация КАК ВключатьСоставСделок,
	|	ДокументыКонтролируемыхСделок.Валюта,
	|	ЕСТЬNULL(ДанныеНоменклатуры.ЕдиницаИзмерения, &ЕдиницаИзмеренияШтука) КАК ЕдиницаИзмерения,
	|	СУММА(ДанныеДокумента.Количество) КАК Количество,
	|	ДанныеДокумента.СтавкаНДС,
	|	СУММА(ДанныеДокумента.СуммаСНДС - ДанныеДокумента.СуммаНДС) КАК СуммаБезНДС,
	|	СУММА(ДанныеДокумента.СуммаНДС) КАК СуммаНДС,
	|	ДокументыКонтролируемыхСделок.КорректировкаОблагаетсяЕНВД КАК ОперацияОблагаетсяЕНВД,
	|	ЛОЖЬ КАК ТоварМировойБиржевойТорговли,
	|	ДанныеДокумента.ИдентификаторСтроки,
	|	ДокументыКонтролируемыхСделок.ИностранныйКонтрагент,
	|	ДокументыКонтролируемыхСделок.ЗарегистрированВСтранеСЛьготнымНалогообложением,
	|	ДокументыКонтролируемыхСделок.ВзаимозависимыеЛица,
	|	ДокументыКонтролируемыхСделок.Грузополучатель,
	|	ДокументыКонтролируемыхСделок.Грузоотправитель,
	|	ДокументыКонтролируемыхСделок.Договор,
	|	ДокументыКонтролируемыхСделок.Соглашение,
	|	1 КАК МножительСуммовыхДанных
	|ПОМЕСТИТЬ ТоварыКонтролируемыхСделок
	|ИЗ
	|	ДокументыКонтролируемыхСделок КАК ДокументыКонтролируемыхСделок
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.КорректировкаРеализации.Расхождения КАК ДанныеДокумента
	|		ПО ДокументыКонтролируемыхСделок.Корректировка = ДанныеДокумента.Ссылка
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.Номенклатура КАК ДанныеНоменклатуры
	|		ПО ДанныеДокумента.Номенклатура = ДанныеНоменклатуры.Ссылка
	|		ЛЕВОЕ СОЕДИНЕНИЕ ТипыПредметовСделкиРеализацийПрочихАктивов КАК ТипыПредметовСделкиРеализацийПрочихАктивов
	|		ПО ТипыПредметовСделкиРеализацийПрочихАктивов.Реализация = ДокументыКонтролируемыхСделок.РасчетныйДокумент
	|ГДЕ
	|	НЕ ЕСТЬNULL(ДанныеНоменклатуры.ТипНоменклатуры, ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.ПустаяСсылка)) В
	|		(ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.Товар), ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.МногооборотнаяТара))
	|
	|СГРУППИРОВАТЬ ПО
	|	ДанныеДокумента.Ссылка,
	|	ДанныеДокумента.СтавкаНДС,
	|	ДанныеДокумента.ИдентификаторСтроки,
	|	ДокументыКонтролируемыхСделок.ИностранныйКонтрагент,
	|	ДокументыКонтролируемыхСделок.ЗарегистрированВСтранеСЛьготнымНалогообложением,
	|	ДокументыКонтролируемыхСделок.ВзаимозависимыеЛица,
	|	ДокументыКонтролируемыхСделок.РасчетныйДокумент,
	|	ДокументыКонтролируемыхСделок.Период,
	|	ДокументыКонтролируемыхСделок.Организация,
	|	ДокументыКонтролируемыхСделок.Контрагент,
	|	ДокументыКонтролируемыхСделок.Комиссионер,
	|	ДокументыКонтролируемыхСделок.Валюта,
	|	ДокументыКонтролируемыхСделок.Грузополучатель,
	|	ДокументыКонтролируемыхСделок.Грузоотправитель,
	|	ДокументыКонтролируемыхСделок.Договор,
	|	ДокументыКонтролируемыхСделок.Соглашение,
	|	ДокументыКонтролируемыхСделок.КорректировкаОблагаетсяЕНВД,
	|	ЕСТЬNULL(ДанныеНоменклатуры.Ссылка, ДанныеДокумента.Содержание),
	|	ЕСТЬNULL(ДанныеНоменклатуры.НаименованиеПолное, ДанныеДокумента.Содержание),
	|	ЕСТЬNULL(ТипыПредметовСделкиРеализацийПрочихАктивов.ТипПредметаСделки,
	|				ВЫБОР
	|					КОГДА ДанныеНоменклатуры.Ссылка ЕСТЬ NULL
	|					ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.ИнойОбъектГражданскихПрав)
	|					ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.РаботаУслуга)
	|				КОНЕЦ),
	|	ЕСТЬNULL(ДанныеДокумента.Характеристика.Принципал, ЕСТЬNULL(ДанныеНоменклатуры.Принципал, НЕОПРЕДЕЛЕНО)) = НЕОПРЕДЕЛЕНО
	|		ИЛИ ЕСТЬNULL(ДанныеДокумента.Характеристика.Принципал, ЕСТЬNULL(ДанныеНоменклатуры.Принципал, НЕОПРЕДЕЛЕНО))
	|		= ДокументыКонтролируемыхСделок.Организация,
	|	ЕСТЬNULL(ДанныеНоменклатуры.ЕдиницаИзмерения, &ЕдиницаИзмеренияШтука)
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ДокументыКонтролируемыхСделок.РасчетныйДокумент,
	|	КорректировкаРеализацииВидыЗапасовОприходование.Ссылка,
	|	ДокументыКонтролируемыхСделок.Период,
	|	ДокументыКонтролируемыхСделок.Организация,
	|	ДокументыКонтролируемыхСделок.Контрагент,
	|	ДокументыКонтролируемыхСделок.Комиссионер,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыКонтролируемыхСделок.ПолученДоход),
	|	АналитикаУчета.Номенклатура,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.Товар),
	|	АналитикаУчета.Номенклатура.НаименованиеПолное,
	|	ЕСТЬNULL(КорректировкаРеализацииВидыЗапасовОприходование.НомерГТД.СтранаПроисхождения, ЗНАЧЕНИЕ(Справочник.СтраныМира.Россия)),
	|	ВЫБОР
	|		КОГДА КорректировкаРеализацииВидыЗапасовОприходование.ВидЗапасов.ТипЗапасов В (ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.ПустаяСсылка), ЗНАЧЕНИЕ(Перечисление.Типызапасов.Товар))
	|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперацииКонтролируемыхСделок.РеализацияСобственныхТоваров)
	|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперацииКонтролируемыхСделок.РеализацияКомиссионныхТоваров)
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА КорректировкаРеализацииВидыЗапасовОприходование.ВидЗапасов.ТипЗапасов В (ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.ПустаяСсылка), ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.Товар))
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ,
	|	ДокументыКонтролируемыхСделок.Валюта,
	|	АналитикаУчета.Номенклатура.ЕдиницаИзмерения,
	|	-СУММА(КорректировкаРеализацииВидыЗапасовОприходование.Количество),
	|	КорректировкаРеализацииВидыЗапасовОприходование.СтавкаНДС,
	|	-СУММА(КорректировкаРеализацииВидыЗапасовОприходование.СуммаСНДС - КорректировкаРеализацииВидыЗапасовОприходование.СуммаНДС),
	|	-СУММА(КорректировкаРеализацииВидыЗапасовОприходование.СуммаНДС),
	|	ДокументыКонтролируемыхСделок.КорректировкаОблагаетсяЕНВД,
	|	ВЫБОР
	|		КОГДА ТоварыМировойБиржевойТорговли.ПредметСделки ЕСТЬ NULL 
	|			ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА
	|	КОНЕЦ,
	|	КорректировкаРеализацииВидыЗапасовОприходование.ИдентификаторСтроки,
	|	ДокументыКонтролируемыхСделок.ИностранныйКонтрагент,
	|	ДокументыКонтролируемыхСделок.ЗарегистрированВСтранеСЛьготнымНалогообложением,
	|	ДокументыКонтролируемыхСделок.ВзаимозависимыеЛица,
	|	ДокументыКонтролируемыхСделок.Грузополучатель,
	|	ДокументыКонтролируемыхСделок.Грузоотправитель,
	|	ДокументыКонтролируемыхСделок.Договор,
	|	ДокументыКонтролируемыхСделок.Соглашение,
	|	1
	|ИЗ
	|	ДокументыКонтролируемыхСделок КАК ДокументыКонтролируемыхСделок
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.КорректировкаРеализации.ВидыЗапасовОприходование КАК КорректировкаРеализацииВидыЗапасовОприходование
	|		ПО ДокументыКонтролируемыхСделок.Корректировка = КорректировкаРеализацииВидыЗапасовОприходование.Ссылка
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК АналитикаУчета
	|		ПО КорректировкаРеализацииВидыЗапасовОприходование.АналитикаУчетаНоменклатуры = АналитикаУчета.Ссылка
	|		ЛЕВОЕ СОЕДИНЕНИЕ ТоварыМировойБиржевойТорговли КАК ТоварыМировойБиржевойТорговли
	|		ПО АналитикаУчета.Номенклатура = ТоварыМировойБиржевойТорговли.ПредметСделки
	|			И ТоварыМировойБиржевойТорговли.ДатаНачалаДействия <= ДокументыКонтролируемыхСделок.Период
	|			И ТоварыМировойБиржевойТорговли.ДатаОкончанияДействия >= ДокументыКонтролируемыхСделок.Период
	|ГДЕ
	|	ВЫБОР
	|			КОГДА ДокументыКонтролируемыхСделок.ВернутьМногооборотнуюТару
	|				ТОГДА АналитикаУчета.Номенклатура.ТипНоменклатуры <> ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.МногооборотнаяТара)
	|			ИНАЧЕ ИСТИНА
	|		КОНЕЦ
	|
	|СГРУППИРОВАТЬ ПО
	|	КорректировкаРеализацииВидыЗапасовОприходование.Ссылка,
	|	КорректировкаРеализацииВидыЗапасовОприходование.СтавкаНДС,
	|	КорректировкаРеализацииВидыЗапасовОприходование.ИдентификаторСтроки,
	|	ДокументыКонтролируемыхСделок.ИностранныйКонтрагент,
	|	ДокументыКонтролируемыхСделок.ЗарегистрированВСтранеСЛьготнымНалогообложением,
	|	ДокументыКонтролируемыхСделок.ВзаимозависимыеЛица,
	|	ДокументыКонтролируемыхСделок.РасчетныйДокумент,
	|	ДокументыКонтролируемыхСделок.Период,
	|	ДокументыКонтролируемыхСделок.Организация,
	|	ДокументыКонтролируемыхСделок.Контрагент,
	|	ДокументыКонтролируемыхСделок.Комиссионер,
	|	ДокументыКонтролируемыхСделок.Валюта,
	|	ДокументыКонтролируемыхСделок.Грузополучатель,
	|	ДокументыКонтролируемыхСделок.Грузоотправитель,
	|	ДокументыКонтролируемыхСделок.Договор,
	|	ДокументыКонтролируемыхСделок.Соглашение,
	|	АналитикаУчета.Номенклатура.НаименованиеПолное,
	|	АналитикаУчета.Номенклатура,
	|	АналитикаУчета.Номенклатура.ЕдиницаИзмерения,
	|	ВЫБОР
	|		КОГДА ТоварыМировойБиржевойТорговли.ПредметСделки ЕСТЬ NULL 
	|			ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА
	|	КОНЕЦ,
	|	ЕСТЬNULL(КорректировкаРеализацииВидыЗапасовОприходование.НомерГТД.СтранаПроисхождения, ЗНАЧЕНИЕ(Справочник.СтраныМира.Россия)),
	|	ВЫБОР
	|		КОГДА КорректировкаРеализацииВидыЗапасовОприходование.ВидЗапасов.ТипЗапасов В (ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.ПустаяСсылка), ЗНАЧЕНИЕ(Перечисление.Типызапасов.Товар))
	|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперацииКонтролируемыхСделок.РеализацияСобственныхТоваров)
	|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперацииКонтролируемыхСделок.РеализацияКомиссионныхТоваров)
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА КорректировкаРеализацииВидыЗапасовОприходование.ВидЗапасов.ТипЗапасов В (ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.ПустаяСсылка), ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.Товар))
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ,
	|	ДокументыКонтролируемыхСделок.КорректировкаОблагаетсяЕНВД
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ДокументыКонтролируемыхСделок.РасчетныйДокумент,
	|	КорректировкаРеализацииВидыЗапасовСписание.Ссылка,
	|	ДокументыКонтролируемыхСделок.Период,
	|	ДокументыКонтролируемыхСделок.Организация,
	|	ДокументыКонтролируемыхСделок.Контрагент,
	|	ДокументыКонтролируемыхСделок.Комиссионер,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыКонтролируемыхСделок.ПолученДоход),
	|	АналитикаУчета.Номенклатура,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.Товар),
	|	АналитикаУчета.Номенклатура.НаименованиеПолное,
	|	ЕСТЬNULL(КорректировкаРеализацииВидыЗапасовСписание.НомерГТД.СтранаПроисхождения, ЗНАЧЕНИЕ(Справочник.СтраныМира.Россия)),
	|	ВЫБОР
	|		КОГДА КорректировкаРеализацииВидыЗапасовСписание.ВидЗапасов.ТипЗапасов В (ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.ПустаяСсылка), ЗНАЧЕНИЕ(Перечисление.Типызапасов.Товар))
	|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперацииКонтролируемыхСделок.РеализацияСобственныхТоваров)
	|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперацииКонтролируемыхСделок.РеализацияКомиссионныхТоваров)
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА КорректировкаРеализацииВидыЗапасовСписание.ВидЗапасов.ТипЗапасов В (ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.ПустаяСсылка), ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.Товар))
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ,
	|	ДокументыКонтролируемыхСделок.Валюта,
	|	АналитикаУчета.Номенклатура.ЕдиницаИзмерения,
	|	СУММА(КорректировкаРеализацииВидыЗапасовСписание.Количество),
	|	КорректировкаРеализацииВидыЗапасовСписание.СтавкаНДС,
	|	СУММА(КорректировкаРеализацииВидыЗапасовСписание.СуммаСНДС - КорректировкаРеализацииВидыЗапасовСписание.СуммаНДС),
	|	СУММА(КорректировкаРеализацииВидыЗапасовСписание.СуммаНДС),
	|	ДокументыКонтролируемыхСделок.КорректировкаОблагаетсяЕНВД,
	|	ВЫБОР
	|		КОГДА ТоварыМировойБиржевойТорговли.ПредметСделки ЕСТЬ NULL 
	|			ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА
	|	КОНЕЦ,
	|	КорректировкаРеализацииВидыЗапасовСписание.ИдентификаторСтроки,
	|	ДокументыКонтролируемыхСделок.ИностранныйКонтрагент,
	|	ДокументыКонтролируемыхСделок.ЗарегистрированВСтранеСЛьготнымНалогообложением,
	|	ДокументыКонтролируемыхСделок.ВзаимозависимыеЛица,
	|	ДокументыКонтролируемыхСделок.Грузополучатель,
	|	ДокументыКонтролируемыхСделок.Грузоотправитель,
	|	ДокументыКонтролируемыхСделок.Договор,
	|	ДокументыКонтролируемыхСделок.Соглашение,
	|	1
	|ИЗ
	|	ДокументыКонтролируемыхСделок КАК ДокументыКонтролируемыхСделок
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.КорректировкаРеализации.ВидыЗапасовСписание КАК КорректировкаРеализацииВидыЗапасовСписание
	|		ПО ДокументыКонтролируемыхСделок.Корректировка = КорректировкаРеализацииВидыЗапасовСписание.Ссылка
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК АналитикаУчета
	|		ПО КорректировкаРеализацииВидыЗапасовСписание.АналитикаУчетаНоменклатуры = АналитикаУчета.Ссылка
	|		ЛЕВОЕ СОЕДИНЕНИЕ ТоварыМировойБиржевойТорговли КАК ТоварыМировойБиржевойТорговли
	|		ПО АналитикаУчета.Номенклатура = ТоварыМировойБиржевойТорговли.ПредметСделки
	|			И ТоварыМировойБиржевойТорговли.ДатаНачалаДействия <= ДокументыКонтролируемыхСделок.Период
	|			И ТоварыМировойБиржевойТорговли.ДатаОкончанияДействия >= ДокументыКонтролируемыхСделок.Период
	|ГДЕ
	|	ВЫБОР
	|			КОГДА ДокументыКонтролируемыхСделок.ВернутьМногооборотнуюТару
	|				ТОГДА АналитикаУчета.Номенклатура.ТипНоменклатуры <> ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.МногооборотнаяТара)
	|			ИНАЧЕ ИСТИНА
	|		КОНЕЦ
	|
	|СГРУППИРОВАТЬ ПО
	|	КорректировкаРеализацииВидыЗапасовСписание.Ссылка,
	|	КорректировкаРеализацииВидыЗапасовСписание.СтавкаНДС,
	|	КорректировкаРеализацииВидыЗапасовСписание.ИдентификаторСтроки,
	|	ДокументыКонтролируемыхСделок.ИностранныйКонтрагент,
	|	ДокументыКонтролируемыхСделок.ЗарегистрированВСтранеСЛьготнымНалогообложением,
	|	ДокументыКонтролируемыхСделок.ВзаимозависимыеЛица,
	|	ДокументыКонтролируемыхСделок.РасчетныйДокумент,
	|	ДокументыКонтролируемыхСделок.Период,
	|	ДокументыКонтролируемыхСделок.Организация,
	|	ДокументыКонтролируемыхСделок.Контрагент,
	|	ДокументыКонтролируемыхСделок.Комиссионер,
	|	ДокументыКонтролируемыхСделок.Валюта,
	|	ДокументыКонтролируемыхСделок.Грузополучатель,
	|	ДокументыКонтролируемыхСделок.Грузоотправитель,
	|	ДокументыКонтролируемыхСделок.Договор,
	|	ДокументыКонтролируемыхСделок.Соглашение,
	|	АналитикаУчета.Номенклатура.НаименованиеПолное,
	|	АналитикаУчета.Номенклатура,
	|	АналитикаУчета.Номенклатура.ЕдиницаИзмерения,
	|	ВЫБОР
	|		КОГДА ТоварыМировойБиржевойТорговли.ПредметСделки ЕСТЬ NULL 
	|			ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА
	|	КОНЕЦ,
	|	ЕСТЬNULL(КорректировкаРеализацииВидыЗапасовСписание.НомерГТД.СтранаПроисхождения, ЗНАЧЕНИЕ(Справочник.СтраныМира.Россия)),
	|	ВЫБОР
	|		КОГДА КорректировкаРеализацииВидыЗапасовСписание.ВидЗапасов.ТипЗапасов В (ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.ПустаяСсылка), ЗНАЧЕНИЕ(Перечисление.Типызапасов.Товар))
	|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперацииКонтролируемыхСделок.РеализацияСобственныхТоваров)
	|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперацииКонтролируемыхСделок.РеализацияКомиссионныхТоваров)
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА КорректировкаРеализацииВидыЗапасовСписание.ВидЗапасов.ТипЗапасов В (ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.ПустаяСсылка), ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.Товар))
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ,
	|	ДокументыКонтролируемыхСделок.КорректировкаОблагаетсяЕНВД
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ДокументыКонтролируемыхСделок.РасчетныйДокумент,
	|	ТаблицаТоваров.Ссылка,
	|	ДокументыКонтролируемыхСделок.Период,
	|	ДокументыКонтролируемыхСделок.Организация,
	|	ДокументыКонтролируемыхСделок.Контрагент,
	|	ДокументыКонтролируемыхСделок.Комиссионер,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыКонтролируемыхСделок.ПолученДоход),
	|	АналитикаУчета.Номенклатура,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.Товар),
	|	АналитикаУчета.Номенклатура.НаименованиеПолное,
	|	ЕСТЬNULL(ТаблицаТоваров.НомерГТД.СтранаПроисхождения, ЗНАЧЕНИЕ(Справочник.СтраныМира.Россия)),
	|	ВЫБОР
	|		КОГДА ТаблицаТоваров.ВидЗапасов.ТипЗапасов В (ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.ПустаяСсылка), ЗНАЧЕНИЕ(Перечисление.Типызапасов.Товар))
	|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперацииКонтролируемыхСделок.РеализацияСобственныхТоваров)
	|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперацииКонтролируемыхСделок.РеализацияКомиссионныхТоваров)
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА ТаблицаТоваров.ВидЗапасов.ТипЗапасов В (ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.ПустаяСсылка), ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.Товар))
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ,
	|	ДокументыКонтролируемыхСделок.Валюта,
	|	АналитикаУчета.Номенклатура.ЕдиницаИзмерения,
	|	СУММА(0),
	|	ТаблицаТоваров.СтавкаНДС,
	|	СУММА(ТаблицаТоваров.СуммаСНДС - ТаблицаТоваров.СуммаНДС),
	|	СУММА(ТаблицаТоваров.СуммаНДС),
	|	ВЫБОР
	|		КОГДА ТаблицаТоваров.Ссылка.НалогообложениеНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаОблагаетсяЕНВД)
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА ТоварыМировойБиржевойТорговли.ПредметСделки ЕСТЬ NULL 
	|			ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА
	|	КОНЕЦ,
	|	ТаблицаТоваров.ИдентификаторСтроки,
	|	ДокументыКонтролируемыхСделок.ИностранныйКонтрагент,
	|	ДокументыКонтролируемыхСделок.ЗарегистрированВСтранеСЛьготнымНалогообложением,
	|	ДокументыКонтролируемыхСделок.ВзаимозависимыеЛица,
	|	ДокументыКонтролируемыхСделок.Грузополучатель,
	|	ДокументыКонтролируемыхСделок.Грузоотправитель,
	|	ДокументыКонтролируемыхСделок.Договор,
	|	ДокументыКонтролируемыхСделок.Соглашение,
	|	1
	|ИЗ
	|	ДокументыКонтролируемыхСделок КАК ДокументыКонтролируемыхСделок
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.КорректировкаРеализации.ВидыЗапасовКорректировкаВыручки КАК ТаблицаТоваров
	|		ПО ДокументыКонтролируемыхСделок.Корректировка = ТаблицаТоваров.Ссылка
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК АналитикаУчета
	|		ПО ТаблицаТоваров.АналитикаУчетаНоменклатуры = АналитикаУчета.Ссылка
	|		ЛЕВОЕ СОЕДИНЕНИЕ ТоварыМировойБиржевойТорговли КАК ТоварыМировойБиржевойТорговли
	|		ПО АналитикаУчета.Номенклатура = ТоварыМировойБиржевойТорговли.ПредметСделки
	|			И ТоварыМировойБиржевойТорговли.ДатаНачалаДействия <= ДокументыКонтролируемыхСделок.Период
	|			И ТоварыМировойБиржевойТорговли.ДатаОкончанияДействия >= ДокументыКонтролируемыхСделок.Период
	|ГДЕ
	|	ВЫБОР
	|			КОГДА ДокументыКонтролируемыхСделок.ВернутьМногооборотнуюТару
	|				ТОГДА АналитикаУчета.Номенклатура.ТипНоменклатуры <> ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.МногооборотнаяТара)
	|			ИНАЧЕ ИСТИНА
	|		КОНЕЦ
	|
	|СГРУППИРОВАТЬ ПО
	|	ТаблицаТоваров.Ссылка,
	|	ТаблицаТоваров.СтавкаНДС,
	|	ТаблицаТоваров.ИдентификаторСтроки,
	|	ДокументыКонтролируемыхСделок.ИностранныйКонтрагент,
	|	ДокументыКонтролируемыхСделок.ЗарегистрированВСтранеСЛьготнымНалогообложением,
	|	ДокументыКонтролируемыхСделок.ВзаимозависимыеЛица,
	|	ДокументыКонтролируемыхСделок.РасчетныйДокумент,
	|	ДокументыКонтролируемыхСделок.Период,
	|	ДокументыКонтролируемыхСделок.Организация,
	|	ДокументыКонтролируемыхСделок.Контрагент,
	|	ДокументыКонтролируемыхСделок.Комиссионер,
	|	ДокументыКонтролируемыхСделок.Валюта,
	|	ДокументыКонтролируемыхСделок.Грузополучатель,
	|	ДокументыКонтролируемыхСделок.Грузоотправитель,
	|	ДокументыКонтролируемыхСделок.Договор,
	|	ДокументыКонтролируемыхСделок.Соглашение,
	|	АналитикаУчета.Номенклатура.НаименованиеПолное,
	|	АналитикаУчета.Номенклатура,
	|	АналитикаУчета.Номенклатура.ЕдиницаИзмерения,
	|	ВЫБОР
	|		КОГДА ТоварыМировойБиржевойТорговли.ПредметСделки ЕСТЬ NULL 
	|			ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА
	|	КОНЕЦ,
	|	ЕСТЬNULL(ТаблицаТоваров.НомерГТД.СтранаПроисхождения, ЗНАЧЕНИЕ(Справочник.СтраныМира.Россия)),
	|	ВЫБОР
	|		КОГДА ТаблицаТоваров.ВидЗапасов.ТипЗапасов В (ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.ПустаяСсылка), ЗНАЧЕНИЕ(Перечисление.Типызапасов.Товар))
	|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперацииКонтролируемыхСделок.РеализацияСобственныхТоваров)
	|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперацииКонтролируемыхСделок.РеализацияКомиссионныхТоваров)
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА ТаблицаТоваров.ВидЗапасов.ТипЗапасов В (ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.ПустаяСсылка), ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.Товар))
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА ТаблицаТоваров.Ссылка.НалогообложениеНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаОблагаетсяЕНВД)
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ТоварыКонтролируемыхСделок.РасчетныйДокумент,
	|	ТоварыКонтролируемыхСделок.РегистраторРегистраСумм КАК РегистраторРегистраСумм,
	|	ТоварыКонтролируемыхСделок.Период,
	|	ТоварыКонтролируемыхСделок.Организация,
	|	ТоварыКонтролируемыхСделок.Контрагент,
	|	ТоварыКонтролируемыхСделок.Комиссионер,
	|	ТоварыКонтролируемыхСделок.ТипКонтролируемойСделки,
	|	ТоварыКонтролируемыхСделок.ПредметСделки,
	|	ТоварыКонтролируемыхСделок.ТипПредметаСделки,
	|	ТоварыКонтролируемыхСделок.НаименованиеПредметаСделки,
	|	ТоварыКонтролируемыхСделок.СтранаПроисхожденияПредметаСделки,
	|	ТоварыКонтролируемыхСделок.ХозяйственнаяОперация,
	|	ТоварыКонтролируемыхСделок.Валюта,
	|	ТоварыКонтролируемыхСделок.ЕдиницаИзмерения,
	|	ТоварыКонтролируемыхСделок.Количество,
	|	ТоварыКонтролируемыхСделок.СтавкаНДС,
	|	ТоварыКонтролируемыхСделок.СуммаБезНДС,
	|	ТоварыКонтролируемыхСделок.СуммаНДС,
	|	ТоварыКонтролируемыхСделок.ОперацияОблагаетсяЕНВД,
	|	ТоварыКонтролируемыхСделок.ТоварМировойБиржевойТорговли,
	|	ТоварыКонтролируемыхСделок.ИдентификаторСтроки КАК ИдентификаторСтроки,
	|	ВЫБОР
	|		КОГДА ТоварыКонтролируемыхСделок.ТипПредметаСделки = ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.Товар)
	|			ТОГДА ТоварыКонтролируемыхСделок.Грузополучатель
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	|	КОНЕЦ КАК Грузополучатель,
	|	ВЫБОР
	|		КОГДА ТоварыКонтролируемыхСделок.ТипПредметаСделки = ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.Товар)
	|			ТОГДА ТоварыКонтролируемыхСделок.Грузоотправитель
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	|	КОНЕЦ КАК Грузоотправитель,
	|	ТоварыКонтролируемыхСделок.Договор,
	|	ТоварыКонтролируемыхСделок.Соглашение,
	|	ТоварыКонтролируемыхСделок.МножительСуммовыхДанных
	|ПОМЕСТИТЬ ТаблицаСделок
	|ИЗ
	|	ТоварыКонтролируемыхСделок КАК ТоварыКонтролируемыхСделок
	|ГДЕ
	|	ТоварыКонтролируемыхСделок.ВключатьСоставСделок
	|	И (ТоварыКонтролируемыхСделок.ТоварМировойБиржевойТорговли
	|				И ТоварыКонтролируемыхСделок.ИностранныйКонтрагент
	|			ИЛИ ТоварыКонтролируемыхСделок.ВзаимозависимыеЛица
	|			ИЛИ ТоварыКонтролируемыхСделок.ЗарегистрированВСтранеСЛьготнымНалогообложением)
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	РегистраторРегистраСумм,
	|	ИдентификаторСтроки";
	
	Запрос.Выполнить();
	
	ВыборкаСделокРеализации = ПолучитьВыборкуТаблицыСделокСПреобразованиемСуммКРублевым(Запрос.МенеджерВременныхТаблиц);
	
	Пока ВыборкаСделокРеализации.Следующий() Цикл
		СтрокаСделки = ТаблицаСделок.Добавить();
		ЗаполнитьЗначенияСвойств(СтрокаСделки, ВыборкаСделокРеализации);
	КонецЦикла;
	
	ЗапросУдаленияВременныхТаблиц = Новый Запрос();
	ЗапросУдаленияВременныхТаблиц.МенеджерВременныхТаблиц = Запрос.МенеджерВременныхТаблиц;
	ЗапросУдаленияВременныхТаблиц.Текст = 
	"УНИЧТОЖИТЬ ДокументыРеализацияТоваровУслугДляАнализа
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ДокументыКорректировкиИРеализации
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ДанныеДокументовКорректировкиИРеализации
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ДокументыКонтролируемыхСделок
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ТоварыКонтролируемыхСделок
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ТаблицаСделок";
	
	ЗапросУдаленияВременныхТаблиц.Выполнить();
	
КонецПроцедуры

#КонецОбласти

#Область ДобавлениеСделокЗакупок

// Добавляет в список контролируемых сделок прриобретелния товаров и услуг.
//
// Параметры:
//  СтруктураПараметров - Структура - параметры контролируемых сделок:
//  * ВалютаРегламентированногоУчета - СправочникСсылка.Валюты - валюта регламетированного учета.
//  * НачалоПериода                  - Дата - начало периода формирования списка контролируемых сделок.
//  * ОкончаниеПериода               - Дата - окончание периода формирования списка контролируемых сделок.
//  * Организация                    - СправочникСсылка.Организации - код места представления.
//  * СписокПодчиненныхОрганизаций   - СписокЗначений из СправочникСсылка.Организации - список подчиненных организаций.
//  МенеджерВременныхТаблиц          - МенеджерВременныхТаблиц - временные таблицы запроса по контролируемым сделкам.
//  ТаблицаСделок                    - ТаблицаЗначений - таблица значений с данными о контролируемых сделках.
//
Процедура ДобавитьСделкиПриобретенияТоваровУслуг(СтруктураПараметров, МенеджерВременныхТаблиц, ТаблицаСделок)
	
	Запрос = ПодготовитьЗапросКДокументамИсточникам(СтруктураПараметров);
	Запрос.УстановитьПараметр("ИспользованиеСоглашений", ПолучитьФункциональнуюОпцию("ИспользоватьСоглашенияСПоставщиками"));
	Запрос.УстановитьПараметр("ИспользованиеДоговоров", ПолучитьФункциональнуюОпцию("ИспользоватьДоговорыСПоставщиками"));
	Запрос.МенеджерВременныхТаблиц = МенеджерВременныхТаблиц;
	Запрос.Текст =
	"ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	ПриобретениеТоваровУслуг.Ссылка КАК РасчетныйДокумент,
	|	ПриобретениеТоваровУслуг.Дата КАК Период,
	|	ПриобретениеТоваровУслуг.Контрагент,
	|	ПриобретениеТоваровУслуг.Организация,
	|	ВЫБОР
	|		КОГДА ВзаимозависимыеЛицаПоПериодам.Контрагент ЕСТЬ NULL 
	|			ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА
	|	КОНЕЦ КАК ВзаимозависимыеЛица,
	|	ВЫБОР
	|		КОГДА ИностранныеКонтрагенты.Контрагент ЕСТЬ NULL 
	|			ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА
	|	КОНЕЦ КАК ИностранныйКонтрагент,
	|	ЕСТЬNULL(ИностранныеКонтрагенты.ЗарегистрированВСтранеСЛьготнымНалогообложением, ЛОЖЬ) КАК ЗарегистрированВСтранеСЛьготнымНалогообложением,
	|	ПриобретениеТоваровУслуг.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ЗакупкаПоИмпортуТоварыВПути) КАК ИмпортВПути
	|ПОМЕСТИТЬ ДокументыКонтролируемыхСделок
	|ИЗ
	|	Документ.ПриобретениеТоваровУслуг КАК ПриобретениеТоваровУслуг
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВзаимозависимыеЛицаПоПериодам КАК ВзаимозависимыеЛицаПоПериодам
	|		ПО (ВзаимозависимыеЛицаПоПериодам.Организация = &Организация)
	|			И (ВзаимозависимыеЛицаПоПериодам.Контрагент = ПриобретениеТоваровУслуг.Контрагент)
	|			И ПриобретениеТоваровУслуг.Дата >= ВзаимозависимыеЛицаПоПериодам.НачалоПериода
	|			И ПриобретениеТоваровУслуг.Дата <= ВзаимозависимыеЛицаПоПериодам.ОкончаниеПериода
	|		ЛЕВОЕ СОЕДИНЕНИЕ ИностранныеКонтрагенты КАК ИностранныеКонтрагенты
	|		ПО ПриобретениеТоваровУслуг.Контрагент = ИностранныеКонтрагенты.Контрагент
	|      ЛЕВОЕ СОЕДИНЕНИЕ Документ.Сторно как ДокументыСторно 
	|      ПО ПриобретениеТоваровУслуг.Ссылка = ДокументыСторно.СторнируемыйДокумент
	|      И ДокументыСторно.Проведен
	|ГДЕ
	|	(НЕ ВзаимозависимыеЛицаПоПериодам.Контрагент ЕСТЬ NULL 
	|			ИЛИ НЕ ИностранныеКонтрагенты.Контрагент ЕСТЬ NULL )
	|	И ПриобретениеТоваровУслуг.Организация В(&СтруктураОрганизации)
	|	И ПриобретениеТоваровУслуг.Дата >= &НачалоПериода
	|	И ПриобретениеТоваровУслуг.Дата <= &ОкончаниеПериода
	|	И ПриобретениеТоваровУслуг.Проведен
	|	И ПриобретениеТоваровУслуг.Контрагент В
	|			(ВЫБРАТЬ
	|				КонтролируемыеКонтрагенты.Контрагент
	|			ИЗ
	|				КонтролируемыеКонтрагенты КАК КонтролируемыеКонтрагенты)
	|	И ВЫБОР
	|			КОГДА ПриобретениеТоваровУслуг.Договор = ЗНАЧЕНИЕ(Справочник.ДоговорыКонтрагентов.ПустаяСсылка)
	|				ТОГДА ИСТИНА
	|			ИНАЧЕ ПриобретениеТоваровУслуг.Договор.ТипДоговора В (ЗНАЧЕНИЕ(Перечисление.ТипыДоговоров.СПоставщиком),
	|					ЗНАЧЕНИЕ(Перечисление.ТипыДоговоров.Импорт), ЗНАЧЕНИЕ(Перечисление.ТипыДоговоров.ВвозИзЕАЭС))
	|		КОНЕЦ
	|   И ДокументыСторно.СторнируемыйДокумент ЕСТЬ NULL 
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	РасчетныйДокумент
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗЛИЧНЫЕ РАЗРЕШЕННЫЕ
	|	ТоварыПоступления.Ссылка КАК РасчетныйДокумент,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыКонтролируемыхСделок.ОсуществленРасход) КАК ТипКонтролируемойСделки,
	|	ТоварыПоступления.Номенклатура КАК ПредметСделки,
	|	ВЫБОР
	|		КОГДА ТоварыПоступления.Номенклатура.ТипНоменклатуры = ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.Работа)
	|				ИЛИ ТоварыПоступления.Номенклатура.ТипНоменклатуры = ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.Услуга)
	|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.РаботаУслуга)
	|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.Товар)
	|	КОНЕЦ КАК ТипПредметаСделки,
	|	ИСТИНА КАК ВключатьСоставСделок,
	|	ИСТИНА КАК УчитыватьНДСПриРаспределении,
	|	ТоварыПоступления.Количество,
	|	ТоварыПоступления.Номенклатура.ЕдиницаИзмерения КАК ЕдиницаИзмеренияПоКлассификатору,
	|	ТоварыПоступления.СтавкаНДС,
	|	ТоварыПоступления.СуммаСНДС - ТоварыПоступления.СуммаНДС КАК СуммаБезНДС,
	|	ТоварыПоступления.СуммаНДС,
	|	ВЫБОР
	|		КОГДА ТоварыПоступления.Ссылка.НалогообложениеНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаОблагаетсяЕНВД)
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ КАК ОперацияОблагаетсяЕНВД,
	|	ВЫБОР
	|		КОГДА ТоварыМировойБиржевойТорговли.ПредметСделки ЕСТЬ NULL 
	|			ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА
	|	КОНЕЦ КАК ТоварМировойБиржевойТорговли,
	|	ВЫБОР
	|		КОГДА ТоварыПоступления.Номенклатура.ТипНоменклатуры В (ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.Товар), ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.МногооборотнаяТара))
	|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперацииКонтролируемыхСделок.ПриобретениеТоваров)
	|		КОГДА ТоварыПоступления.Номенклатура.ТипНоменклатуры = ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.Услуга)
	|				И ТоварыПоступления.Номенклатура.ОсобенностьУчета В (ЗНАЧЕНИЕ(Перечисление.ОсобенностиУчетаНоменклатуры.ОрганизациейПоАгентскойСхеме), ЗНАЧЕНИЕ(Перечисление.ОсобенностиУчетаНоменклатуры.Партнером))
	|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперацииКонтролируемыхСделок.ПолучениеАгентскихУслуг)
	|		КОГДА ТоварыПоступления.Номенклатура.ТипНоменклатуры В (ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.Услуга), ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.Работа))
	|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперацииКонтролируемыхСделок.ПолучениеУслуг)
	|	КОНЕЦ КАК ХозяйственнаяОперация,
	|	ТоварыПоступления.ИдентификаторСтроки,
	|	ЕСТЬNULL(ТоварыПоступления.НомерГТД.СтранаПроисхождения, ЕСТЬNULL(ТоварыКОформлениюДокументовИмпорта.НомерГТД.СтранаПроисхождения, ЗНАЧЕНИЕ(Справочник.СтраныМира.ПустаяСсылка))) КАК СтранаПроисхождения,
	|	ДокументыКонтролируемыхСделок.ВзаимозависимыеЛица,
	|	ДокументыКонтролируемыхСделок.ИностранныйКонтрагент,
	|	ДокументыКонтролируемыхСделок.ЗарегистрированВСтранеСЛьготнымНалогообложением
	|ПОМЕСТИТЬ ТоварыКонтролируемыхСделок
	|ИЗ
	|	Документ.ПриобретениеТоваровУслуг.Товары КАК ТоварыПоступления
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ДокументыКонтролируемыхСделок КАК ДокументыКонтролируемыхСделок
	|		ПО ТоварыПоступления.Ссылка = ДокументыКонтролируемыхСделок.РасчетныйДокумент
	|		ЛЕВОЕ СОЕДИНЕНИЕ ТоварыМировойБиржевойТорговли КАК ТоварыМировойБиржевойТорговли
	|		ПО ТоварыПоступления.Номенклатура = ТоварыМировойБиржевойТорговли.ПредметСделки
	|			И ТоварыМировойБиржевойТорговли.ДатаНачалаДействия <= ДокументыКонтролируемыхСделок.Период
	|			И ТоварыМировойБиржевойТорговли.ДатаОкончанияДействия >= ДокументыКонтролируемыхСделок.Период
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ТоварыКОформлениюДокументовИмпорта КАК ТоварыКОформлениюДокументовИмпорта
	|		ПО ТоварыПоступления.Ссылка = ТоварыКОформлениюДокументовИмпорта.ДокументПоступления
	|			И ТоварыПоступления.ВидЗапасов = ТоварыКОформлениюДокументовИмпорта.ВидЗапасов
	|			И ТоварыПоступления.АналитикаУчетаНоменклатуры = ТоварыКОформлениюДокументовИмпорта.АналитикаУчетаНоменклатуры
	|			И (ТоварыКОформлениюДокументовИмпорта.Регистратор ССЫЛКА Документ.ТаможеннаяДекларацияИмпорт)
	|ГДЕ
	|	ВЫБОР
	|			КОГДА ТоварыПоступления.Ссылка.ВернутьМногооборотнуюТару
	|				ТОГДА ТоварыПоступления.Номенклатура.ТипНоменклатуры <> ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.МногооборотнаяТара)
	|			ИНАЧЕ ИСТИНА
	|		КОНЕЦ
	|	И НЕ ДокументыКонтролируемыхСделок.ИмпортВПути
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	ТоварыПоступления.Ссылка КАК РасчетныйДокумент,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыКонтролируемыхСделок.ОсуществленРасход) КАК ТипКонтролируемойСделки,
	|	Аналитика.Номенклатура КАК ПредметСделки,
	|	ВЫБОР
	|		КОГДА Аналитика.Номенклатура.ТипНоменклатуры = ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.Работа)
	|				ИЛИ Аналитика.Номенклатура.ТипНоменклатуры = ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.Услуга)
	|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.РаботаУслуга)
	|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.Товар)
	|	КОНЕЦ КАК ТипПредметаСделки,
	|	ИСТИНА КАК ВключатьСоставСделок,
	|	ИСТИНА КАК УчитыватьНДСПриРаспределении,
	|	ТоварыПоступления.Количество,
	|	Аналитика.Номенклатура.ЕдиницаИзмерения КАК ЕдиницаИзмеренияПоКлассификатору,
	|	ТоварыПоступления.СтавкаНДС,
	|	ТоварыПоступления.СуммаСНДС - ТоварыПоступления.СуммаНДС КАК СуммаБезНДС,
	|	ТоварыПоступления.СуммаНДС,
	|	ВЫБОР
	|		КОГДА ТоварыПоступления.Ссылка.НалогообложениеНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаОблагаетсяЕНВД)
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ КАК ОперацияОблагаетсяЕНВД,
	|	ВЫБОР
	|		КОГДА ТоварыМировойБиржевойТорговли.ПредметСделки ЕСТЬ NULL 
	|			ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА
	|	КОНЕЦ КАК ТоварМировойБиржевойТорговли,
	|	ВЫБОР
	|		КОГДА Аналитика.Номенклатура.ТипНоменклатуры В (ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.Товар), ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.МногооборотнаяТара))
	|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперацииКонтролируемыхСделок.ПриобретениеТоваров)
	|		КОГДА Аналитика.Номенклатура.ТипНоменклатуры = ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.Услуга)
	|				И Аналитика.Номенклатура.ОсобенностьУчета В (ЗНАЧЕНИЕ(Перечисление.ОсобенностиУчетаНоменклатуры.ОрганизациейПоАгентскойСхеме), ЗНАЧЕНИЕ(Перечисление.ОсобенностиУчетаНоменклатуры.Партнером))
	|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперацииКонтролируемыхСделок.ПолучениеАгентскихУслуг)
	|		КОГДА Аналитика.Номенклатура.ТипНоменклатуры В (ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.Услуга), ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.Работа))
	|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперацииКонтролируемыхСделок.ПолучениеУслуг)
	|	КОНЕЦ КАК ХозяйственнаяОперация,
	|	ТоварыПоступления.ИдентификаторСтроки,
	|	ЕСТЬNULL(ТоварыПоступления.НомерГТД.СтранаПроисхождения, ЕСТЬNULL(ТоварыКОформлениюДокументовИмпорта.НомерГТД.СтранаПроисхождения, ЗНАЧЕНИЕ(Справочник.СтраныМира.ПустаяСсылка))) КАК СтранаПроисхождения,
	|	ДокументыКонтролируемыхСделок.ВзаимозависимыеЛица,
	|	ДокументыКонтролируемыхСделок.ИностранныйКонтрагент,
	|	ДокументыКонтролируемыхСделок.ЗарегистрированВСтранеСЛьготнымНалогообложением
	|ИЗ
	|	Документ.ПриобретениеТоваровУслуг.ВидыЗапасов КАК ТоварыПоступления
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК Аналитика
	|		ПО ТоварыПоступления.АналитикаУчетаНоменклатуры = Аналитика.Ссылка
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ДокументыКонтролируемыхСделок КАК ДокументыКонтролируемыхСделок
	|		ПО ТоварыПоступления.Ссылка = ДокументыКонтролируемыхСделок.РасчетныйДокумент
	|		ЛЕВОЕ СОЕДИНЕНИЕ ТоварыМировойБиржевойТорговли КАК ТоварыМировойБиржевойТорговли
	|		ПО Аналитика.Номенклатура = ТоварыМировойБиржевойТорговли.ПредметСделки
	|			И ТоварыМировойБиржевойТорговли.ДатаНачалаДействия <= ДокументыКонтролируемыхСделок.Период
	|			И ТоварыМировойБиржевойТорговли.ДатаОкончанияДействия >= ДокументыКонтролируемыхСделок.Период
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ТоварыКОформлениюДокументовИмпорта КАК ТоварыКОформлениюДокументовИмпорта
	|		ПО ТоварыПоступления.Ссылка = ТоварыКОформлениюДокументовИмпорта.ДокументПоступления
	|			И ТоварыПоступления.ВидЗапасов = ТоварыКОформлениюДокументовИмпорта.ВидЗапасов
	|			И ТоварыПоступления.АналитикаУчетаНоменклатуры = ТоварыКОформлениюДокументовИмпорта.АналитикаУчетаНоменклатуры
	|			И (ТоварыКОформлениюДокументовИмпорта.Регистратор ССЫЛКА Документ.ТаможеннаяДекларацияИмпорт)
	|ГДЕ
	|	ВЫБОР
	|			КОГДА ТоварыПоступления.Ссылка.ВернутьМногооборотнуюТару
	|				ТОГДА Аналитика.Номенклатура.ТипНоменклатуры <> ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.МногооборотнаяТара)
	|			ИНАЧЕ ИСТИНА
	|		КОНЕЦ
	|	И ДокументыКонтролируемыхСделок.ИмпортВПути
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ТоварыКонтролируемыхСделок.РасчетныйДокумент,
	|	ТоварыКонтролируемыхСделок.РасчетныйДокумент.Дата КАК Период,
	|	ТоварыКонтролируемыхСделок.РасчетныйДокумент.Организация КАК Организация,
	|	ТоварыКонтролируемыхСделок.РасчетныйДокумент.Контрагент КАК Контрагент,
	|	ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка) КАК Комиссионер,
	|	ТоварыКонтролируемыхСделок.ПредметСделки,
	|	ТоварыКонтролируемыхСделок.ТипПредметаСделки,
	|	ТоварыКонтролируемыхСделок.ПредметСделки.НаименованиеПолное КАК НаименованиеПредметаСделки,
	|	ТоварыКонтролируемыхСделок.СтранаПроисхождения КАК СтранаПроисхожденияПредметаСделки,
	|	ТоварыКонтролируемыхСделок.ХозяйственнаяОперация,
	|	ТоварыКонтролируемыхСделок.РасчетныйДокумент.Валюта КАК Валюта,
	|	ТоварыКонтролируемыхСделок.ЕдиницаИзмеренияПоКлассификатору КАК ЕдиницаИзмерения,
	|	ТоварыКонтролируемыхСделок.Количество,
	|	ТоварыКонтролируемыхСделок.СтавкаНДС,
	|	ТоварыКонтролируемыхСделок.СуммаБезНДС,
	|	ТоварыКонтролируемыхСделок.СуммаНДС,
	|	ТоварыКонтролируемыхСделок.ТипКонтролируемойСделки,
	|	ТоварыКонтролируемыхСделок.ТоварМировойБиржевойТорговли,
	|	ТоварыКонтролируемыхСделок.ОперацияОблагаетсяЕНВД,
	|	ВЫБОР
	|		КОГДА ТоварыКонтролируемыхСделок.ТипПредметаСделки = ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.Товар)
	|			ТОГДА ТоварыКонтролируемыхСделок.РасчетныйДокумент.Организация
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	|	КОНЕЦ КАК Грузополучатель,
	|	ВЫБОР
	|		КОГДА ТоварыКонтролируемыхСделок.ТипПредметаСделки = ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.Товар)
	|			ТОГДА ВЫБОР
	|					КОГДА ТоварыКонтролируемыхСделок.РасчетныйДокумент.Грузоотправитель = ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	|						ТОГДА ТоварыКонтролируемыхСделок.РасчетныйДокумент.Контрагент
	|					ИНАЧЕ ТоварыКонтролируемыхСделок.РасчетныйДокумент.Грузоотправитель
	|				КОНЕЦ
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	|	КОНЕЦ КАК Грузоотправитель,
	|	ТоварыКонтролируемыхСделок.ИдентификаторСтроки КАК ИдентификаторСтроки,
	|	ВЫБОР
	|		КОГДА &ИспользованиеДоговоров
	|			ТОГДА ТоварыКонтролируемыхСделок.РасчетныйДокумент.Договор
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК Договор,
	|	ВЫБОР
	|		КОГДА &ИспользованиеСоглашений
	|			ТОГДА ТоварыКонтролируемыхСделок.РасчетныйДокумент.Соглашение
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК Соглашение,
	|	ТоварыКонтролируемыхСделок.РасчетныйДокумент КАК РегистраторРегистраСумм,
	|	1 КАК МножительСуммовыхДанных
	|ПОМЕСТИТЬ ТаблицаСделок
	|ИЗ
	|	ТоварыКонтролируемыхСделок КАК ТоварыКонтролируемыхСделок
	|ГДЕ
	|	(ТоварыКонтролируемыхСделок.ТоварМировойБиржевойТорговли
	|				И ТоварыКонтролируемыхСделок.ИностранныйКонтрагент
	|			ИЛИ ТоварыКонтролируемыхСделок.ВзаимозависимыеЛица
	|			ИЛИ ТоварыКонтролируемыхСделок.ЗарегистрированВСтранеСЛьготнымНалогообложением)
	|	И ТоварыКонтролируемыхСделок.ВключатьСоставСделок
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	РегистраторРегистраСумм,
	|	ИдентификаторСтроки";
	
	Запрос.Выполнить();
	
	ВыборкаСделокРеализации = ПолучитьВыборкуТаблицыСделокСПреобразованиемСуммКРублевым(Запрос.МенеджерВременныхТаблиц);
	
	Пока ВыборкаСделокРеализации.Следующий() Цикл
		СтрокаСделки = ТаблицаСделок.Добавить();
		ЗаполнитьЗначенияСвойств(СтрокаСделки, ВыборкаСделокРеализации);
	КонецЦикла;
	
	ЗапросУдаленияВременныхТаблиц = Новый Запрос();
	ЗапросУдаленияВременныхТаблиц.МенеджерВременныхТаблиц = Запрос.МенеджерВременныхТаблиц;
	ЗапросУдаленияВременныхТаблиц.Текст = 
	"УНИЧТОЖИТЬ ДокументыКонтролируемыхСделок
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ТоварыКонтролируемыхСделок
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ТаблицаСделок";
	
	ЗапросУдаленияВременныхТаблиц.Выполнить();
	
КонецПроцедуры

// Добавляет в список контролируемых сделок поступления услуг и прочих активов.
//
// Параметры:
//  СтруктураПараметров - Структура - параметры контролируемых сделок:
//  * ВалютаРегламентированногоУчета - СправочникСсылка.Валюты - валюта регламетированного учета.
//  * НачалоПериода                  - Дата - начало периода формирования списка контролируемых сделок.
//  * ОкончаниеПериода               - Дата - окончание периода формирования списка контролируемых сделок.
//  * Организация                    - СправочникСсылка.Организации - код места представления.
//  * СписокПодчиненныхОрганизаций   - СписокЗначений из СправочникСсылка.Организации - список подчиненных организаций.
//  МенеджерВременныхТаблиц          - МенеджерВременныхТаблиц - временные таблицы запроса по контролируемым сделкам.
//  ТаблицаСделок                    - ТаблицаЗначений - таблица значений с данными о контролируемых сделках.
//
Процедура ДобавитьСделкиПоступленияУслугПрочихАктивов(СтруктураПараметров, МенеджерВременныхТаблиц, ТаблицаСделок)
		
	Запрос = ПодготовитьЗапросКДокументамИсточникам(СтруктураПараметров);
	Запрос.УстановитьПараметр("ИспользованиеСоглашений", ПолучитьФункциональнуюОпцию("ИспользоватьСоглашенияСПоставщиками"));
	Запрос.УстановитьПараметр("ИспользованиеДоговоров", ПолучитьФункциональнуюОпцию("ИспользоватьДоговорыСПоставщиками"));
	Запрос.МенеджерВременныхТаблиц = МенеджерВременныхТаблиц;
	Запрос.Текст =
	"ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	ПриобретениеУслугПрочихАктивов.Ссылка КАК РасчетныйДокумент,
	|	ВЫБОР
	|		КОГДА ВзаимозависимыеЛицаПоПериодам.Контрагент ЕСТЬ NULL 
	|			ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА
	|	КОНЕЦ КАК ВзаимозависимыеЛица,
	|	ВЫБОР
	|		КОГДА ИностранныеКонтрагенты.Контрагент ЕСТЬ NULL 
	|			ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА
	|	КОНЕЦ КАК ИностранныйКонтрагент,
	|	ЕСТЬNULL(ИностранныеКонтрагенты.ЗарегистрированВСтранеСЛьготнымНалогообложением, ЛОЖЬ) КАК ЗарегистрированВСтранеСЛьготнымНалогообложением
	|ПОМЕСТИТЬ ДокументыКонтролируемыхСделок
	|ИЗ
	|	Документ.ПриобретениеУслугПрочихАктивов КАК ПриобретениеУслугПрочихАктивов
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВзаимозависимыеЛицаПоПериодам КАК ВзаимозависимыеЛицаПоПериодам
	|		ПО (ВзаимозависимыеЛицаПоПериодам.Организация = &Организация)
	|			И (ВзаимозависимыеЛицаПоПериодам.Контрагент = ПриобретениеУслугПрочихАктивов.Контрагент)
	|			И ПриобретениеУслугПрочихАктивов.Дата >= ВзаимозависимыеЛицаПоПериодам.НачалоПериода
	|			И ПриобретениеУслугПрочихАктивов.Дата <= ВзаимозависимыеЛицаПоПериодам.ОкончаниеПериода
	|		ЛЕВОЕ СОЕДИНЕНИЕ ИностранныеКонтрагенты КАК ИностранныеКонтрагенты
	|		ПО ПриобретениеУслугПрочихАктивов.Контрагент = ИностранныеКонтрагенты.Контрагент
	|      ЛЕВОЕ СОЕДИНЕНИЕ Документ.Сторно как ДокументыСторно 
	|      ПО ПриобретениеУслугПрочихАктивов.Ссылка = ДокументыСторно.СторнируемыйДокумент
	|      И ДокументыСторно.Проведен
	|ГДЕ
	|	(НЕ ВзаимозависимыеЛицаПоПериодам.Контрагент ЕСТЬ NULL 
	|			ИЛИ НЕ ИностранныеКонтрагенты.Контрагент ЕСТЬ NULL )
	|	И ПриобретениеУслугПрочихАктивов.Организация В(&СтруктураОрганизации)
	|	И ПриобретениеУслугПрочихАктивов.Дата >= &НачалоПериода
	|	И ПриобретениеУслугПрочихАктивов.Дата <= &ОкончаниеПериода
	|	И ПриобретениеУслугПрочихАктивов.Проведен
	|	И ПриобретениеУслугПрочихАктивов.Контрагент В
	|			(ВЫБРАТЬ
	|				КонтролируемыеКонтрагенты.Контрагент
	|			ИЗ
	|				КонтролируемыеКонтрагенты КАК КонтролируемыеКонтрагенты)
	|	И ВЫБОР
	|			КОГДА ПриобретениеУслугПрочихАктивов.Договор = ЗНАЧЕНИЕ(Справочник.ДоговорыКонтрагентов.ПустаяСсылка)
	|				ТОГДА ИСТИНА
	|			КОГДА ПриобретениеУслугПрочихАктивов.Договор.КомиссионныеПродажи25 И 
	|				ПриобретениеУслугПрочихАктивов.Договор.ТипДоговора = ЗНАЧЕНИЕ(Перечисление.ТипыДоговоров.СКомиссионером)
	|				ТОГДА ИСТИНА
	|			ИНАЧЕ ПриобретениеУслугПрочихАктивов.Договор.ТипДоговора В (ЗНАЧЕНИЕ(Перечисление.ТипыДоговоров.СПоставщиком),
	|					ЗНАЧЕНИЕ(Перечисление.ТипыДоговоров.Импорт), ЗНАЧЕНИЕ(Перечисление.ТипыДоговоров.ВвозИзЕАЭС))
	|		КОНЕЦ
	|   И ДокументыСторно.СторнируемыйДокумент ЕСТЬ NULL
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	РасчетныйДокумент
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	УслугиПрочиеАктивы.Ссылка КАК РасчетныйДокумент,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыКонтролируемыхСделок.ОсуществленРасход) КАК ТипКонтролируемойСделки,
	|	УслугиПрочиеАктивы.Содержание КАК ПредметСделки,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.ИнойОбъектГражданскихПрав) КАК ТипПредметаСделки,
	|	УслугиПрочиеАктивы.Количество,
	|	&ЕдиницаИзмеренияШтука КАК ЕдиницаИзмеренияПоКлассификатору,
	|	УслугиПрочиеАктивы.СтавкаНДС,
	|	УслугиПрочиеАктивы.СуммаСНДС - УслугиПрочиеАктивы.СуммаНДС КАК СуммаБезНДС,
	|	УслугиПрочиеАктивы.СуммаНДС,
	|	ВЫБОР
	|		КОГДА УслугиПрочиеАктивы.Ссылка.НалогообложениеНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаОблагаетсяЕНВД)
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ КАК ОперацияОблагаетсяЕНВД,
	|	ЛОЖЬ КАК ТоварМировойБиржевойТорговли,
	|	ЗНАЧЕНИЕ(Справочник.СтраныМира.Пустаяссылка) КАК СтранаПроисхождения,
	|	ДокументыКонтролируемыхСделок.ИностранныйКонтрагент,
	|	ДокументыКонтролируемыхСделок.ЗарегистрированВСтранеСЛьготнымНалогообложением,
	|	ДокументыКонтролируемыхСделок.ВзаимозависимыеЛица,
	|	УслугиПрочиеАктивы.ИдентификаторСтроки,
	|	ВЫБОР
	|		КОГДА УслугиПрочиеАктивы.СтатьяРасходов.ВидЦенностиНДС = ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.ОбъектыНезавершенногоСтроительства)
	|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперацииКонтролируемыхСделок.ПриобретениеОбъектовСтроительства)
	|		КОГДА УслугиПрочиеАктивы.СтатьяРасходов.ВидЦенностиНДС = ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.НМА)
	|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперацииКонтролируемыхСделок.ПриобретениеНематериальныхАктивов)
	|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперацииКонтролируемыхСделок.ПрочаяОперация)
	|	КОНЕЦ КАК ХозяйственнаяОперация,
	|	ИСТИНА КАК ВключатьСоставСделок
	|ПОМЕСТИТЬ ТоварыКонтролируемыхСделок
	|ИЗ
	|	Документ.ПриобретениеУслугПрочихАктивов.Расходы КАК УслугиПрочиеАктивы
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ДокументыКонтролируемыхСделок КАК ДокументыКонтролируемыхСделок
	|		ПО УслугиПрочиеАктивы.Ссылка = ДокументыКонтролируемыхСделок.РасчетныйДокумент
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ТоварыКонтролируемыхСделок.РасчетныйДокумент,
	|	ТоварыКонтролируемыхСделок.РасчетныйДокумент.Дата КАК Период,
	|	ТоварыКонтролируемыхСделок.РасчетныйДокумент.Организация КАК Организация,
	|	ТоварыКонтролируемыхСделок.РасчетныйДокумент.Контрагент КАК Контрагент,
	|	ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка) КАК Комиссионер,
	|	ТоварыКонтролируемыхСделок.ПредметСделки,
	|	ТоварыКонтролируемыхСделок.ТипПредметаСделки,
	|	ТоварыКонтролируемыхСделок.ПредметСделки КАК НаименованиеПредметаСделки,
	|	ТоварыКонтролируемыхСделок.СтранаПроисхождения КАК СтранаПроисхожденияПредметаСделки,
	|	ТоварыКонтролируемыхСделок.ХозяйственнаяОперация,
	|	ТоварыКонтролируемыхСделок.РасчетныйДокумент.Валюта КАК Валюта,
	|	ТоварыКонтролируемыхСделок.ЕдиницаИзмеренияПоКлассификатору КАК ЕдиницаИзмерения,
	|	ТоварыКонтролируемыхСделок.Количество,
	|	ТоварыКонтролируемыхСделок.СтавкаНДС,
	|	ТоварыКонтролируемыхСделок.СуммаБезНДС,
	|	ТоварыКонтролируемыхСделок.СуммаНДС,
	|	ТоварыКонтролируемыхСделок.ТипКонтролируемойСделки,
	|	ТоварыКонтролируемыхСделок.ТоварМировойБиржевойТорговли,
	|	ТоварыКонтролируемыхСделок.ОперацияОблагаетсяЕНВД,
	|	ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка) КАК Грузоотправитель,
	|	ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка) КАК Грузополучатель,
	|	ВЫБОР
	|		КОГДА &ИспользованиеДоговоров
	|			ТОГДА ТоварыКонтролируемыхСделок.РасчетныйДокумент.Договор
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК Договор,
	|	ВЫБОР
	|		КОГДА &ИспользованиеСоглашений
	|			ТОГДА ТоварыКонтролируемыхСделок.РасчетныйДокумент.Соглашение
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК Соглашение,
	|	ТоварыКонтролируемыхСделок.ИдентификаторСтроки КАК ИдентификаторСтроки,
	|	ТоварыКонтролируемыхСделок.РасчетныйДокумент КАК РегистраторРегистраСумм,
	|	1 КАК МножительСуммовыхДанных
	|ПОМЕСТИТЬ ТаблицаСделок
	|ИЗ
	|	ТоварыКонтролируемыхСделок КАК ТоварыКонтролируемыхСделок
	|ГДЕ
	|	(ТоварыКонтролируемыхСделок.ТоварМировойБиржевойТорговли
	|				И ТоварыКонтролируемыхСделок.ИностранныйКонтрагент
	|			ИЛИ ТоварыКонтролируемыхСделок.ВзаимозависимыеЛица
	|			ИЛИ ТоварыКонтролируемыхСделок.ЗарегистрированВСтранеСЛьготнымНалогообложением)
	|	И ТоварыКонтролируемыхСделок.ВключатьСоставСделок
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	РегистраторРегистраСумм,
	|	ИдентификаторСтроки";
	
	Запрос.Выполнить();
	
	ВыборкаСделокРеализации = ПолучитьВыборкуТаблицыСделокСПреобразованиемСуммКРублевым(Запрос.МенеджерВременныхТаблиц);
	
	Пока ВыборкаСделокРеализации.Следующий() Цикл
		СтрокаСделки = ТаблицаСделок.Добавить();
		ЗаполнитьЗначенияСвойств(СтрокаСделки, ВыборкаСделокРеализации);
	КонецЦикла;
	
	ЗапросУдаленияВременныхТаблиц = Новый Запрос();
	ЗапросУдаленияВременныхТаблиц.МенеджерВременныхТаблиц = Запрос.МенеджерВременныхТаблиц;
	ЗапросУдаленияВременныхТаблиц.Текст = 
	"УНИЧТОЖИТЬ ДокументыКонтролируемыхСделок
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ТоварыКонтролируемыхСделок
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ТаблицаСделок";
	
	ЗапросУдаленияВременныхТаблиц.Выполнить();
	
КонецПроцедуры

// Добавляет в список контролируемых сделок возвраты товаров поставщику.
//
// Параметры:
//  СтруктураПараметров - Структура - параметры контролируемых сделок:
//  * ВалютаРегламентированногоУчета - СправочникСсылка.Валюты - валюта регламетированного учета.
//  * НачалоПериода                  - Дата - начало периода формирования списка контролируемых сделок.
//  * ОкончаниеПериода               - Дата - окончание периода формирования списка контролируемых сделок.
//  * Организация                    - СправочникСсылка.Организации - код места представления.
//  * СписокПодчиненныхОрганизаций   - СписокЗначений из СправочникСсылка.Организации - список подчиненных организаций.
//  МенеджерВременныхТаблиц          - МенеджерВременныхТаблиц - временные таблицы запроса по контролируемым сделкам.
//  ТаблицаСделок                    - ТаблицаЗначений - таблица значений с данными о контролируемых сделках.
//
Процедура ДобавитьСделкиВозвратаТоваровПоставщику(СтруктураПараметров, МенеджерВременныхТаблиц, ТаблицаСделок)
		
	Запрос = ПодготовитьЗапросКДокументамИсточникам(СтруктураПараметров);
	Запрос.УстановитьПараметр("ИспользованиеСоглашений", ПолучитьФункциональнуюОпцию("ИспользоватьСоглашенияСПоставщиками"));
	Запрос.УстановитьПараметр("ИспользованиеДоговоров", ПолучитьФункциональнуюОпцию("ИспользоватьДоговорыСПоставщиками"));
	Запрос.МенеджерВременныхТаблиц = МенеджерВременныхТаблиц;
	Запрос.Текст =
	"ВЫБРАТЬ РАЗРЕШЕННЫЕ РАЗЛИЧНЫЕ
	|	ВозвратТоваровПоставщику.Ссылка КАК ДокументВозврата,
	|	ВЫБОР
	|		КОГДА ВзаимозависимыеЛицаПоПериодам.Контрагент ЕСТЬ NULL 
	|			ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА
	|	КОНЕЦ КАК ВзаимозависимыеЛица,
	|	ВЫБОР
	|		КОГДА ИностранныеКонтрагенты.Контрагент ЕСТЬ NULL 
	|			ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА
	|	КОНЕЦ КАК ИностранныйКонтрагент,
	|	ЕСТЬNULL(ИностранныеКонтрагенты.ЗарегистрированВСтранеСЛьготнымНалогообложением, ЛОЖЬ) КАК ЗарегистрированВСтранеСЛьготнымНалогообложением,
	|	ЕСТЬNULL(ПриобретениеТоваровУслуг.Ссылка,ВозвратТоваровПоставщику.Ссылка) КАК РасчетныйДокумент, 
	|	ЕСТЬNULL(ПриобретениеТоваровУслуг.Ссылка,Значение(Документ.ПриобретениеТоваровУслуг.ПустаяСсылка)) КАК РасчетныйДокументДляСвязи,
	|	ЕСТЬNULL(ПриобретениеТоваровУслуг.Дата,ВозвратТоваровПоставщику.Дата) КАК Период,
	|	ВозвратТоваровПоставщику.Организация КАК Организация,
	|	ВозвратТоваровПоставщику.Контрагент КАК Контрагент,
	|	ЕСТЬNULL(ПриобретениеТоваровУслуг.Валюта,ВозвратТоваровПоставщику.Валюта) КАК Валюта,
	|	ВЫБОР
	|		КОГДА ВозвратТоваровПоставщику.Грузополучатель = ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	|		ТОГДА ВозвратТоваровПоставщику.Контрагент
	|		ИНАЧЕ ВозвратТоваровПоставщику.Грузополучатель
	|	КОНЕЦ КАК Грузоотправитель,
	|	ВЫБОР
	|		КОГДА ВозвратТоваровПоставщику.Грузоотправитель = ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	|		ТОГДА ВозвратТоваровПоставщику.Организация
	|		ИНАЧЕ ВозвратТоваровПоставщику.Грузоотправитель
	|	КОНЕЦ КАК Грузополучатель,
	|	ВЫБОР
	|		КОГДА &ИспользованиеДоговоров
	|		ТОГДА ВозвратТоваровПоставщику.Договор
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК Договор,
	|	ВЫБОР
	|		КОГДА &ИспользованиеСоглашений
	|		ТОГДА ВозвратТоваровПоставщику.Соглашение
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК Соглашение
	|ПОМЕСТИТЬ ДокументыКонтролируемыхСделок
	|ИЗ
	|	Документ.ВозвратТоваровПоставщику КАК ВозвратТоваровПоставщику
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.ВозвратТоваровПоставщику.Товары КАК ВозвратТоваровПоставщикуТовары
	|		ПО ВозвратТоваровПоставщикуТовары.Ссылка = ВозвратТоваровПоставщику.Ссылка
	|			И ВозвратТоваровПоставщику.ДокументПоступления = ЗНАЧЕНИЕ(Документ.ПриобретениеТоваровУслуг.ПустаяСсылка)
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВзаимозависимыеЛицаПоПериодам КАК ВзаимозависимыеЛицаПоПериодам
	|		ПО (ВзаимозависимыеЛицаПоПериодам.Контрагент = ВозвратТоваровПоставщику.Контрагент)
	|			И ВозвратТоваровПоставщику.Дата >= ВзаимозависимыеЛицаПоПериодам.НачалоПериода
	|			И ВозвратТоваровПоставщику.Дата <= ВзаимозависимыеЛицаПоПериодам.ОкончаниеПериода
	|			И (ВзаимозависимыеЛицаПоПериодам.Организация = &Организация)
	|		ЛЕВОЕ СОЕДИНЕНИЕ ИностранныеКонтрагенты КАК ИностранныеКонтрагенты
	|		ПО (ИностранныеКонтрагенты.Контрагент = ВозвратТоваровПоставщику.Контрагент)
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.ПриобретениеТоваровУслуг КАК ПриобретениеТоваровУслуг
	|		ПО ЕСТЬNULL(ВозвратТоваровПоставщикуТовары.ДокументПоступления, ВозвратТоваровПоставщику.ДокументПоступления) = ПриобретениеТоваровУслуг.Ссылка
	|      ЛЕВОЕ СОЕДИНЕНИЕ Документ.Сторно как ДокументыСторно 
	|      ПО ВозвратТоваровПоставщику.Ссылка = ДокументыСторно.СторнируемыйДокумент
	|      И  ДокументыСторно.Проведен
	|ГДЕ
	|	ВозвратТоваровПоставщику.Организация В(&СтруктураОрганизации)
	|	И ВозвратТоваровПоставщику.Дата >= &НачалоПериода
	|	И ВозвратТоваровПоставщику.Проведен
	|	И ВозвратТоваровПоставщику.Контрагент В
	|			(ВЫБРАТЬ
	|				КонтролируемыеКонтрагенты.Контрагент
	|			ИЗ
	|				КонтролируемыеКонтрагенты КАК КонтролируемыеКонтрагенты)
	|	И (НЕ ВзаимозависимыеЛицаПоПериодам.Контрагент ЕСТЬ NULL 
	|			ИЛИ НЕ ИностранныеКонтрагенты.Контрагент ЕСТЬ NULL )
	|	И ВЫБОР
	|			КОГДА ВозвратТоваровПоставщику.Договор = ЗНАЧЕНИЕ(Справочник.ДоговорыКонтрагентов.ПустаяСсылка)
	|				ТОГДА ИСТИНА
	|			ИНАЧЕ ВозвратТоваровПоставщику.Договор.ТипДоговора  В (ЗНАЧЕНИЕ(Перечисление.ТипыДоговоров.СПоставщиком),
	|					ЗНАЧЕНИЕ(Перечисление.ТипыДоговоров.Импорт), ЗНАЧЕНИЕ(Перечисление.ТипыДоговоров.ВвозИзЕАЭС))
	|		КОНЕЦ
	|	И ЕСТЬNULL(ПриобретениеТоваровУслуг.Дата,ВозвратТоваровПоставщику.Дата) >= &НачалоПериода
	|	И ЕСТЬNULL(ПриобретениеТоваровУслуг.Дата,ВозвратТоваровПоставщику.Дата) <= &ОкончаниеПериода
	|   И ДокументыСторно.СторнируемыйДокумент ЕСТЬ NULL
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	ДокументВозврата
	|;
	|
	|///////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	ТоварыВозврата.Ссылка КАК Сделка,
	|	ДокументыКонтролируемыхСделок.РасчетныйДокумент КАК РасчетныйДокумент,
	|	ДокументыКонтролируемыхСделок.Период КАК Период,
	|	ДокументыКонтролируемыхСделок.Организация КАК Организация,
	|	ДокументыКонтролируемыхСделок.Контрагент КАК Контрагент,
	|	ДокументыКонтролируемыхСделок.Валюта КАК Валюта,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыКонтролируемыхСделок.ОсуществленРасход) КАК ТипКонтролируемойСделки,
	|	Аналитика.Номенклатура КАК ПредметСделки,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.Товар) КАК ТипПредметаСделки,
	|	ТоварыВозврата.Количество КАК Количество,
	|	Аналитика.Номенклатура.ЕдиницаИзмерения КАК ЕдиницаИзмеренияПоКлассификатору,
	|	ТоварыВозврата.СтавкаНДС,
	|	ТоварыВозврата.СуммаСНДС - ТоварыВозврата.СуммаНДС КАК СуммаБезНДС,
	|	ТоварыВозврата.СуммаНДС КАК СуммаНДС,
	|	ВЫБОР
	|		КОГДА ТоварыВозврата.Ссылка.НалогообложениеНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаОблагаетсяЕНВД)
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ КАК ОперацияОблагаетсяЕНВД,
	|	ВЫБОР
	|		КОГДА ТоварыМировойБиржевойТорговли.ПредметСделки ЕСТЬ NULL 
	|			ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА
	|	КОНЕЦ КАК ТоварМировойБиржевойТорговли,
	|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперацииКонтролируемыхСделок.ВозвратТоваров) КАК ХозяйственнаяОперация,
	|	ВЫБОР
	|		КОГДА ТоварыВозврата.ВидЗапасов.ТипЗапасов В (ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.ПустаяСсылка), ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.Товар))
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ КАК ВключатьСоставСделок,
	|	ЕСТЬNULL(ТоварыВозврата.НомерГТД.СтранаПроисхождения, ЗНАЧЕНИЕ(Справочник.СтраныМира.ПустаяСсылка)) КАК СтранаПроисхождения,
	|	ДокументыКонтролируемыхСделок.ИностранныйКонтрагент,
	|	ДокументыКонтролируемыхСделок.ЗарегистрированВСтранеСЛьготнымНалогообложением,
	|	ДокументыКонтролируемыхСделок.ВзаимозависимыеЛица,
	|	ДокументыКонтролируемыхСделок.Грузоотправитель КАК Грузоотправитель,
	|	ДокументыКонтролируемыхСделок.Грузополучатель КАК Грузополучатель,
	|	ДокументыКонтролируемыхСделок.Договор КАК Договор,
	|	ДокументыКонтролируемыхСделок.Соглашение КАК Соглашение,
	|	ТоварыВозврата.ИдентификаторСтроки
	|ПОМЕСТИТЬ ТоварыКонтролируемыхСделок
	|ИЗ
	|	Документ.ВозвратТоваровПоставщику.ВидыЗапасов КАК ТоварыВозврата
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК Аналитика
	|		ПО ТоварыВозврата.АналитикаУчетаНоменклатуры = Аналитика.Ссылка
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ДокументыКонтролируемыхСделок КАК ДокументыКонтролируемыхСделок
	|		ПО ТоварыВозврата.Ссылка = ДокументыКонтролируемыхСделок.ДокументВозврата
	|			И ТоварыВозврата.ДокументПоступления = ДокументыКонтролируемыхСделок.РасчетныйДокументДляСвязи
	|		ЛЕВОЕ СОЕДИНЕНИЕ ТоварыМировойБиржевойТорговли КАК ТоварыМировойБиржевойТорговли
	|		ПО Аналитика.Номенклатура = ТоварыМировойБиржевойТорговли.ПредметСделки
	|			И ТоварыМировойБиржевойТорговли.ДатаНачалаДействия <= ДокументыКонтролируемыхСделок.Период
	|			И ТоварыМировойБиржевойТорговли.ДатаОкончанияДействия >= ДокументыКонтролируемыхСделок.Период
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ТоварыКонтролируемыхСделок.РасчетныйДокумент КАК РасчетныйДокумент,
	|	ТоварыКонтролируемыхСделок.Период КАК Период,
	|	ТоварыКонтролируемыхСделок.Организация КАК Организация,
	|	ТоварыКонтролируемыхСделок.Контрагент КАК Контрагент,
	|	ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка) КАК Комиссионер,
	|	ТоварыКонтролируемыхСделок.ПредметСделки,
	|	ТоварыКонтролируемыхСделок.ТипПредметаСделки,
	|	ТоварыКонтролируемыхСделок.ПредметСделки.НаименованиеПолное КАК НаименованиеПредметаСделки,
	|	ТоварыКонтролируемыхСделок.СтранаПроисхождения КАК СтранаПроисхожденияПредметаСделки,
	|	ТоварыКонтролируемыхСделок.ХозяйственнаяОперация,
	|	ТоварыКонтролируемыхСделок.Валюта КАК Валюта,
	|	ТоварыКонтролируемыхСделок.ЕдиницаИзмеренияПоКлассификатору КАК ЕдиницаИзмерения,
	|	ТоварыКонтролируемыхСделок.Количество,
	|	ТоварыКонтролируемыхСделок.СтавкаНДС,
	|	ТоварыКонтролируемыхСделок.СуммаБезНДС,
	|	ТоварыКонтролируемыхСделок.СуммаНДС,
	|	ТоварыКонтролируемыхСделок.ТипКонтролируемойСделки,
	|	ТоварыКонтролируемыхСделок.ТоварМировойБиржевойТорговли,
	|	ТоварыКонтролируемыхСделок.ОперацияОблагаетсяЕНВД,
	|	ТоварыКонтролируемыхСделок.Грузоотправитель КАК Грузоотправитель,
	|	ТоварыКонтролируемыхСделок.Грузополучатель КАК Грузополучатель,
	|	ТоварыКонтролируемыхСделок.Договор КАК Договор,
	|	ТоварыКонтролируемыхСделок.Соглашение КАК Соглашение,
	|	ТоварыКонтролируемыхСделок.Сделка КАК РегистраторРегистраСумм,
	|	ТоварыКонтролируемыхСделок.ИдентификаторСтроки КАК ИдентификаторСтроки,
	|	-1 КАК МножительСуммовыхДанных
	|ПОМЕСТИТЬ ТаблицаСделок
	|ИЗ
	|	ТоварыКонтролируемыхСделок КАК ТоварыКонтролируемыхСделок
	|ГДЕ
	|	(ТоварыКонтролируемыхСделок.ТоварМировойБиржевойТорговли
	|				И ТоварыКонтролируемыхСделок.ИностранныйКонтрагент
	|			ИЛИ ТоварыКонтролируемыхСделок.ВзаимозависимыеЛица
	|			ИЛИ ТоварыКонтролируемыхСделок.ЗарегистрированВСтранеСЛьготнымНалогообложением)
	|	И ТоварыКонтролируемыхСделок.ВключатьСоставСделок
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	РегистраторРегистраСумм,
	|	ИдентификаторСтроки";
	
	Запрос.Выполнить();
	
	ВыборкаСделокРеализации = ПолучитьВыборкуТаблицыСделокСПреобразованиемСуммКРублевым(Запрос.МенеджерВременныхТаблиц);
	
	Пока ВыборкаСделокРеализации.Следующий() Цикл
		СтрокаСделки = ТаблицаСделок.Добавить();
		ЗаполнитьЗначенияСвойств(СтрокаСделки, ВыборкаСделокРеализации);
	КонецЦикла;;
	
	ЗапросУдаленияВременныхТаблиц = Новый Запрос();
	ЗапросУдаленияВременныхТаблиц.МенеджерВременныхТаблиц = Запрос.МенеджерВременныхТаблиц;
	ЗапросУдаленияВременныхТаблиц.Текст = 
	"УНИЧТОЖИТЬ ДокументыКонтролируемыхСделок
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ТоварыКонтролируемыхСделок
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ТаблицаСделок";
	
	ЗапросУдаленияВременныхТаблиц.Выполнить();
	
КонецПроцедуры

// Добавляет в список контролируемых сделок корректировки поступления.
//
// Параметры:
//  СтруктураПараметров - Структура - параметры контролируемых сделок:
//  * ВалютаРегламентированногоУчета - СправочникСсылка.Валюты - валюта регламетированного учета.
//  * НачалоПериода                  - Дата - начало периода формирования списка контролируемых сделок.
//  * ОкончаниеПериода               - Дата - окончание периода формирования списка контролируемых сделок.
//  * Организация                    - СправочникСсылка.Организации - код места представления.
//  * СписокПодчиненныхОрганизаций   - СписокЗначений из СправочникСсылка.Организации - список подчиненных организаций.
//  МенеджерВременныхТаблиц          - МенеджерВременныхТаблиц - временные таблицы запроса по контролируемым сделкам.
//  ТаблицаСделок                    - ТаблицаЗначений - таблица значений с данными о контролируемых сделках.
//
Процедура ДобавитьСделкиКорректировкиПоступления(СтруктураПараметров, МенеджерВременныхТаблиц, ТаблицаСделок)
		
	Запрос = ПодготовитьЗапросКДокументамИсточникам(СтруктураПараметров);
	Запрос.УстановитьПараметр("ИспользованиеСоглашений", ПолучитьФункциональнуюОпцию("ИспользоватьСоглашенияСПоставщиками"));
	Запрос.УстановитьПараметр("ИспользованиеДоговоров", ПолучитьФункциональнуюОпцию("ИспользоватьДоговорыСПоставщиками"));
	Запрос.МенеджерВременныхТаблиц = МенеджерВременныхТаблиц;
	Запрос.Текст =
	"ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	КорректировкаПриобретения.Ссылка КАК Корректировка,
	|	КорректировкаПриобретения.ДокументОснование КАК Поступление
	|ПОМЕСТИТЬ ДокументыКорректировкиИРеализации
	|ИЗ
	|	Документ.КорректировкаПриобретения КАК КорректировкаПриобретения
	|ГДЕ
	|	КорректировкаПриобретения.Организация В(&СтруктураОрганизации)
	|	И КорректировкаПриобретения.Дата >= &НачалоПериода
	|	И КорректировкаПриобретения.Проведен
	|	И КорректировкаПриобретения.Контрагент В
	|			(ВЫБРАТЬ
	|				КонтролируемыеКонтрагенты.Контрагент
	|			ИЗ
	|				КонтролируемыеКонтрагенты КАК КонтролируемыеКонтрагенты)
	|	И ВЫБОР
	|			КОГДА КорректировкаПриобретения.Договор = ЗНАЧЕНИЕ(Справочник.ДоговорыКонтрагентов.ПустаяСсылка)
	|				ТОГДА ИСТИНА
	|			ИНАЧЕ КорректировкаПриобретения.Договор.ТипДоговора В (ЗНАЧЕНИЕ(Перечисление.ТипыДоговоров.СПоставщиком),
	|					ЗНАЧЕНИЕ(Перечисление.ТипыДоговоров.Импорт), ЗНАЧЕНИЕ(Перечисление.ТипыДоговоров.ВвозИзЕАЭС))
	|		КОНЕЦ
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Корректировка,
	|	Поступление
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	ПриобретениеТоваровУслуг.Ссылка КАК РасчетныйДокумент,
	|	ПриобретениеТоваровУслуг.Дата КАК Период,
	|	ПриобретениеТоваровУслуг.Организация,
	|	ПриобретениеТоваровУслуг.Контрагент КАК Контрагент,
	|	ПриобретениеТоваровУслуг.Валюта,
	|	ВЫБОР
	|		КОГДА ПриобретениеТоваровУслуг.НалогообложениеНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаОблагаетсяЕНВД)
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ КАК ОперацияОблагаетсяЕНВД,
	|	ВЫБОР
	|		КОГДА ПриобретениеТоваровУслуг.Грузоотправитель = ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	|			ТОГДА ПриобретениеТоваровУслуг.Контрагент
	|		ИНАЧЕ ПриобретениеТоваровУслуг.Грузоотправитель
	|	КОНЕЦ КАК Грузоотправитель,
	|	ПриобретениеТоваровУслуг.Организация КАК Грузополучатель,
	|	ВЫБОР
	|		КОГДА &ИспользованиеДоговоров
	|			ТОГДА ПриобретениеТоваровУслуг.Договор
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК Договор,
	|	ВЫБОР
	|		КОГДА &ИспользованиеСоглашений
	|			ТОГДА ПриобретениеТоваровУслуг.Соглашение
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК Соглашение,
	|	ДокументыКорректировкиИРеализации.Корректировка КАК Корректировка,
	|	ПриобретениеТоваровУслуг.ВернутьМногооборотнуюТару
	|ПОМЕСТИТЬ ДанныеДокументовКорректировкиИРеализации
	|ИЗ
	|	ДокументыКорректировкиИРеализации КАК ДокументыКорректировкиИРеализации
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ПриобретениеТоваровУслуг КАК ПриобретениеТоваровУслуг
	|		ПО (ПриобретениеТоваровУслуг.Дата >= &НачалоПериода)
	|			И (ПриобретениеТоваровУслуг.Дата <= &ОкончаниеПериода)
	|			И (ПриобретениеТоваровУслуг.Проведен)
	|			И (ПриобретениеТоваровУслуг.Контрагент В
	|				(ВЫБРАТЬ
	|					КонтролируемыеКонтрагенты.Контрагент
	|				ИЗ
	|					КонтролируемыеКонтрагенты КАК КонтролируемыеКонтрагенты))
	|			И ДокументыКорректировкиИРеализации.Поступление = ПриобретениеТоваровУслуг.Ссылка
	|			И (ВЫБОР
	|				КОГДА ПриобретениеТоваровУслуг.Договор = ЗНАЧЕНИЕ(Справочник.ДоговорыКонтрагентов.ПустаяСсылка)
	|					ТОГДА ИСТИНА
	|				ИНАЧЕ ПриобретениеТоваровУслуг.Договор.ТипДоговора В (ЗНАЧЕНИЕ(Перечисление.ТипыДоговоров.СПоставщиком),
	|					ЗНАЧЕНИЕ(Перечисление.ТипыДоговоров.Импорт), ЗНАЧЕНИЕ(Перечисление.ТипыДоговоров.ВвозИзЕАЭС))
	|			КОНЕЦ)
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ПриобретениеУслугПрочихАктивов.Ссылка,
	|	ПриобретениеУслугПрочихАктивов.Дата,
	|	ПриобретениеУслугПрочихАктивов.Организация,
	|	ПриобретениеУслугПрочихАктивов.Контрагент,
	|	ПриобретениеУслугПрочихАктивов.Валюта,
	|	ВЫБОР
	|		КОГДА ПриобретениеУслугПрочихАктивов.НалогообложениеНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаОблагаетсяЕНВД)
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ,
	|	ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка),
	|	ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка),
	|	ВЫБОР
	|		КОГДА &ИспользованиеДоговоров
	|			ТОГДА ПриобретениеУслугПрочихАктивов.Договор
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК Договор,
	|	ВЫБОР
	|		КОГДА &ИспользованиеСоглашений
	|			ТОГДА ПриобретениеУслугПрочихАктивов.Соглашение
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК Соглашение,
	|	ДокументыКорректировкиИРеализации.Корректировка,
	|	ЛОЖЬ
	|ИЗ
	|	ДокументыКорректировкиИРеализации КАК ДокументыКорректировкиИРеализации
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ПриобретениеУслугПрочихАктивов КАК ПриобретениеУслугПрочихАктивов
	|		ПО (ПриобретениеУслугПрочихАктивов.Дата <= &ОкончаниеПериода)
	|			И (ПриобретениеУслугПрочихАктивов.Контрагент В
	|				(ВЫБРАТЬ
	|					КонтролируемыеКонтрагенты.Контрагент
	|				ИЗ
	|					КонтролируемыеКонтрагенты КАК КонтролируемыеКонтрагенты))
	|			И (ПриобретениеУслугПрочихАктивов.Дата >= &НачалоПериода)
	|			И (ПриобретениеУслугПрочихАктивов.Проведен)
	|			И ДокументыКорректировкиИРеализации.Поступление = ПриобретениеУслугПрочихАктивов.Ссылка
	|			И (ВЫБОР
	|				КОГДА ПриобретениеУслугПрочихАктивов.Договор = ЗНАЧЕНИЕ(Справочник.ДоговорыКонтрагентов.ПустаяСсылка)
	|					ТОГДА ИСТИНА
	|				ИНАЧЕ ПриобретениеУслугПрочихАктивов.Договор.ТипДоговора В (ЗНАЧЕНИЕ(Перечисление.ТипыДоговоров.СПоставщиком),
	|					ЗНАЧЕНИЕ(Перечисление.ТипыДоговоров.Импорт), ЗНАЧЕНИЕ(Перечисление.ТипыДоговоров.ВвозИзЕАЭС))
	|			КОНЕЦ)
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Контрагент
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	ДанныеДокументовКорректировкиИРеализации.РасчетныйДокумент,
	|	ДанныеДокументовКорректировкиИРеализации.Период,
	|	ДанныеДокументовКорректировкиИРеализации.Организация,
	|	ДанныеДокументовКорректировкиИРеализации.Контрагент,
	|	ДанныеДокументовКорректировкиИРеализации.Валюта,
	|	ДанныеДокументовКорректировкиИРеализации.ОперацияОблагаетсяЕНВД,
	|	ДанныеДокументовКорректировкиИРеализации.Грузоотправитель,
	|	ДанныеДокументовКорректировкиИРеализации.Договор,
	|	ДанныеДокументовКорректировкиИРеализации.Соглашение,
	|	ДанныеДокументовКорректировкиИРеализации.Корректировка КАК Корректировка,
	|	ВЫБОР
	|		КОГДА ВзаимозависимыеЛицаПоПериодам.Контрагент ЕСТЬ NULL 
	|			ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА
	|	КОНЕЦ КАК ВзаимозависимыеЛица,
	|	ВЫБОР
	|		КОГДА ИностранныеКонтрагенты.Контрагент ЕСТЬ NULL 
	|			ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА
	|	КОНЕЦ КАК ИностранныйКонтрагент,
	|	ЕСТЬNULL(ИностранныеКонтрагенты.ЗарегистрированВСтранеСЛьготнымНалогообложением, ЛОЖЬ) КАК ЗарегистрированВСтранеСЛьготнымНалогообложением,
	|	ДанныеДокументовКорректировкиИРеализации.ВернутьМногооборотнуюТару,
	|	ДанныеДокументовКорректировкиИРеализации.Грузополучатель
	|ПОМЕСТИТЬ ДокументыКонтролируемыхСделок
	|ИЗ
	|	ДанныеДокументовКорректировкиИРеализации КАК ДанныеДокументовКорректировкиИРеализации
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВзаимозависимыеЛицаПоПериодам КАК ВзаимозависимыеЛицаПоПериодам
	|		ПО (ВзаимозависимыеЛицаПоПериодам.Организация = &Организация)
	|			И ДанныеДокументовКорректировкиИРеализации.Контрагент = ВзаимозависимыеЛицаПоПериодам.Контрагент
	|			И ДанныеДокументовКорректировкиИРеализации.Период >= ВзаимозависимыеЛицаПоПериодам.НачалоПериода
	|			И ДанныеДокументовКорректировкиИРеализации.Период <= ВзаимозависимыеЛицаПоПериодам.ОкончаниеПериода
	|		ЛЕВОЕ СОЕДИНЕНИЕ ИностранныеКонтрагенты КАК ИностранныеКонтрагенты
	|		ПО ДанныеДокументовКорректировкиИРеализации.Контрагент = ИностранныеКонтрагенты.Контрагент
	|ГДЕ
	|	(НЕ ВзаимозависимыеЛицаПоПериодам.Контрагент ЕСТЬ NULL 
	|			ИЛИ НЕ ИностранныеКонтрагенты.Контрагент ЕСТЬ NULL )
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Корректировка
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	ДокументыКонтролируемыхСделок.РасчетныйДокумент КАК РасчетныйДокумент,
	|	ДанныеДокумента.Ссылка КАК РегистраторРегистраСумм,
	|	ДокументыКонтролируемыхСделок.Период КАК Период,
	|	ДокументыКонтролируемыхСделок.Организация,
	|	ДокументыКонтролируемыхСделок.Контрагент,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыКонтролируемыхСделок.ОсуществленРасход) КАК ТипКонтролируемойСделки,
	|	ЕСТЬNULL(ДанныеНоменклатуры.Ссылка, ДанныеДокумента.Содержание) КАК ПредметСделки,
	|	ВЫБОР
	|		КОГДА ДанныеНоменклатуры.Ссылка ЕСТЬ NULL
	|		ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.ИнойОбъектГражданскихПрав)
	|		КОГДА ЕСТЬNULL(ДанныеНоменклатуры.ТипНоменклатуры, ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.ПустаяСсылка)) В
	|			(ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.Работа), ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.Услуга))
	|		ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.РаботаУслуга)
	|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.Товар)
	|	КОНЕЦ КАК ТипПредметаСделки,
	|	ЕСТЬNULL(ДанныеНоменклатуры.НаименованиеПолное, ДанныеДокумента.Содержание) КАК НаименованиеПредметаСделки,
	|	ВЫБОР
	|		КОГДА ЕСТЬNULL(ДанныеНоменклатуры.ТипНоменклатуры, ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.Работа)) В
	|			(ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.Работа), ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.Услуга))
	|		ТОГДА ЗНАЧЕНИЕ(Справочник.СтраныМира.ПустаяСсылка)
	|		ИНАЧЕ ЕСТЬNULL(ДанныеДокумента.НомерГТД.СтранаПроисхождения, ЗНАЧЕНИЕ(Справочник.СтраныМира.ПустаяСсылка))
	|	КОНЕЦ КАК СтранаПроисхожденияПредметаСделки,
	|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперацииКонтролируемыхСделок.Корректировка) КАК ХозяйственнаяОперация,
	|	ЕСТЬNULL(ДанныеДокумента.Характеристика.Принципал, ЕСТЬNULL(ДанныеНоменклатуры.Принципал, НЕОПРЕДЕЛЕНО)) = НЕОПРЕДЕЛЕНО
	|		ИЛИ ЕСТЬNULL(ДанныеДокумента.Характеристика.Принципал, ЕСТЬNULL(ДанныеНоменклатуры.Принципал, НЕОПРЕДЕЛЕНО))
	|		= ДокументыКонтролируемыхСделок.Организация КАК ВключатьСоставСделок,
	|	ДокументыКонтролируемыхСделок.Валюта,
	|	ЕСТЬNULL(ДанныеНоменклатуры.ЕдиницаИзмерения, &ЕдиницаИзмеренияШтука) КАК ЕдиницаИзмерения,
	|	СУММА(ДанныеДокумента.Количество) КАК Количество,
	|	ДанныеДокумента.СтавкаНДС,
	|	СУММА(ДанныеДокумента.СуммаСНДС - ДанныеДокумента.СуммаНДС) КАК СуммаБезНДС,
	|	СУММА(ДанныеДокумента.СуммаНДС) КАК СуммаНДС,
	|	ДанныеДокумента.Ссылка.НалогообложениеНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаОблагаетсяЕНВД) КАК ОперацияОблагаетсяЕНВД,
	|	НЕ ТоварыМировойБиржевойТорговли.ПредметСделки ЕСТЬ NULL КАК ТоварМировойБиржевойТорговли,
	|	ДанныеДокумента.ИдентификаторСтроки,
	|	ДокументыКонтролируемыхСделок.ИностранныйКонтрагент,
	|	ДокументыКонтролируемыхСделок.ЗарегистрированВСтранеСЛьготнымНалогообложением,
	|	ДокументыКонтролируемыхСделок.ВзаимозависимыеЛица,
	|	ДокументыКонтролируемыхСделок.Грузополучатель,
	|	ДокументыКонтролируемыхСделок.Грузоотправитель,
	|	ДокументыКонтролируемыхСделок.Договор,
	|	ДокументыКонтролируемыхСделок.Соглашение,
	|	1 КАК МножительСуммовыхДанных
	|ПОМЕСТИТЬ ТоварыКонтролируемыхСделок
	|ИЗ
	|	ДокументыКонтролируемыхСделок КАК ДокументыКонтролируемыхСделок
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.КорректировкаПриобретения.Расхождения КАК ДанныеДокумента
	|		ПО ДокументыКонтролируемыхСделок.Корректировка = ДанныеДокумента.Ссылка
	|		ЛЕВОЕ СОЕДИНЕНИЕ ТоварыМировойБиржевойТорговли КАК ТоварыМировойБиржевойТорговли
	|		ПО ДанныеДокумента.Номенклатура = ТоварыМировойБиржевойТорговли.ПредметСделки
	|			И ТоварыМировойБиржевойТорговли.ДатаНачалаДействия <= ДокументыКонтролируемыхСделок.Период
	|			И ТоварыМировойБиржевойТорговли.ДатаОкончанияДействия >= ДокументыКонтролируемыхСделок.Период
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.Номенклатура КАК ДанныеНоменклатуры
	|		ПО ДанныеДокумента.Номенклатура = ДанныеНоменклатуры.Ссылка
	|ГДЕ
	|	НЕ ДокументыКонтролируемыхСделок.ВернутьМногооборотнуюТару
	|	ИЛИ ЕСТЬNULL(ДанныеНоменклатуры.ТипНоменклатуры, ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.ПустаяСсылка))
	|		<> ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.МногооборотнаяТара)
	|
	|СГРУППИРОВАТЬ ПО
	|	ДанныеДокумента.Ссылка,
	|	ДанныеДокумента.СтавкаНДС,
	|	ДанныеДокумента.ИдентификаторСтроки,
	|	ДокументыКонтролируемыхСделок.ИностранныйКонтрагент,
	|	ДокументыКонтролируемыхСделок.ЗарегистрированВСтранеСЛьготнымНалогообложением,
	|	ДокументыКонтролируемыхСделок.ВзаимозависимыеЛица,
	|	ДокументыКонтролируемыхСделок.РасчетныйДокумент,
	|	ДокументыКонтролируемыхСделок.Период,
	|	ДокументыКонтролируемыхСделок.Организация,
	|	ДокументыКонтролируемыхСделок.Контрагент,
	|	ДокументыКонтролируемыхСделок.Валюта,
	|	ДокументыКонтролируемыхСделок.Грузоотправитель,
	|	ДокументыКонтролируемыхСделок.Договор,
	|	ДокументыКонтролируемыхСделок.Соглашение,
	|	ЕСТЬNULL(ДанныеНоменклатуры.Ссылка, ДанныеДокумента.Содержание),
	|	ЕСТЬNULL(ДанныеНоменклатуры.НаименованиеПолное, ДанныеДокумента.Содержание),
	|	ВЫБОР
	|		КОГДА ДанныеНоменклатуры.Ссылка ЕСТЬ NULL
	|		ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.ИнойОбъектГражданскихПрав)
	|		КОГДА ЕСТЬNULL(ДанныеНоменклатуры.ТипНоменклатуры, ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.ПустаяСсылка)) В
	|			(ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.Работа), ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.Услуга))
	|		ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.РаботаУслуга)
	|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.Товар)
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА ЕСТЬNULL(ДанныеНоменклатуры.ТипНоменклатуры, ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.Работа)) В
	|			(ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.Работа), ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.Услуга))
	|		ТОГДА ЗНАЧЕНИЕ(Справочник.СтраныМира.ПустаяСсылка)
	|		ИНАЧЕ ЕСТЬNULL(ДанныеДокумента.НомерГТД.СтранаПроисхождения, ЗНАЧЕНИЕ(Справочник.СтраныМира.ПустаяСсылка))
	|	КОНЕЦ,
	|	ЕСТЬNULL(ДанныеДокумента.Характеристика.Принципал, ЕСТЬNULL(ДанныеНоменклатуры.Принципал, НЕОПРЕДЕЛЕНО)) = НЕОПРЕДЕЛЕНО
	|		ИЛИ ЕСТЬNULL(ДанныеДокумента.Характеристика.Принципал, ЕСТЬNULL(ДанныеНоменклатуры.Принципал, НЕОПРЕДЕЛЕНО))
	|		= ДокументыКонтролируемыхСделок.Организация,
	|	ЕСТЬNULL(ДанныеНоменклатуры.ЕдиницаИзмерения, &ЕдиницаИзмеренияШтука),
	|	ДокументыКонтролируемыхСделок.Грузополучатель,
	|	НЕ ТоварыМировойБиржевойТорговли.ПредметСделки ЕСТЬ NULL,
	|	ДанныеДокумента.Ссылка.НалогообложениеНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаОблагаетсяЕНВД)
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ТоварыКонтролируемыхСделок.РасчетныйДокумент,
	|	ТоварыКонтролируемыхСделок.РегистраторРегистраСумм КАК РегистраторРегистраСумм,
	|	ТоварыКонтролируемыхСделок.Период,
	|	ТоварыКонтролируемыхСделок.Организация,
	|	ТоварыКонтролируемыхСделок.Контрагент,
	|	ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка) КАК Комиссионер,
	|	ТоварыКонтролируемыхСделок.ТипКонтролируемойСделки,
	|	ТоварыКонтролируемыхСделок.ПредметСделки,
	|	ТоварыКонтролируемыхСделок.ТипПредметаСделки,
	|	ТоварыКонтролируемыхСделок.НаименованиеПредметаСделки,
	|	ТоварыКонтролируемыхСделок.СтранаПроисхожденияПредметаСделки,
	|	ТоварыКонтролируемыхСделок.ХозяйственнаяОперация,
	|	ТоварыКонтролируемыхСделок.Валюта,
	|	ТоварыКонтролируемыхСделок.ЕдиницаИзмерения,
	|	ТоварыКонтролируемыхСделок.Количество,
	|	ТоварыКонтролируемыхСделок.СтавкаНДС,
	|	ТоварыКонтролируемыхСделок.СуммаБезНДС,
	|	ТоварыКонтролируемыхСделок.СуммаНДС,
	|	ТоварыКонтролируемыхСделок.ОперацияОблагаетсяЕНВД,
	|	ТоварыКонтролируемыхСделок.ТоварМировойБиржевойТорговли,
	|	ТоварыКонтролируемыхСделок.ИдентификаторСтроки КАК ИдентификаторСтроки,
	|	ТоварыКонтролируемыхСделок.Грузополучатель,
	|	ВЫБОР
	|		КОГДА ТоварыКонтролируемыхСделок.ТипПредметаСделки = ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.Товар)
	|			ТОГДА ТоварыКонтролируемыхСделок.Грузоотправитель
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	|	КОНЕЦ КАК Грузоотправитель,
	|	ТоварыКонтролируемыхСделок.Договор,
	|	ТоварыКонтролируемыхСделок.Соглашение,
	|	ТоварыКонтролируемыхСделок.МножительСуммовыхДанных
	|ПОМЕСТИТЬ ТаблицаСделок
	|ИЗ
	|	ТоварыКонтролируемыхСделок КАК ТоварыКонтролируемыхСделок
	|ГДЕ
	|	ТоварыКонтролируемыхСделок.ВключатьСоставСделок
	|	И (ТоварыКонтролируемыхСделок.ТоварМировойБиржевойТорговли
	|				И ТоварыКонтролируемыхСделок.ИностранныйКонтрагент
	|			ИЛИ ТоварыКонтролируемыхСделок.ВзаимозависимыеЛица
	|			ИЛИ ТоварыКонтролируемыхСделок.ЗарегистрированВСтранеСЛьготнымНалогообложением)
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	РегистраторРегистраСумм,
	|	ИдентификаторСтроки";
	
	Запрос.Выполнить();
	
	ВыборкаСделокРеализации = ПолучитьВыборкуТаблицыСделокСПреобразованиемСуммКРублевым(Запрос.МенеджерВременныхТаблиц);
	
	Пока ВыборкаСделокРеализации.Следующий() Цикл
		СтрокаСделки = ТаблицаСделок.Добавить();
		ЗаполнитьЗначенияСвойств(СтрокаСделки, ВыборкаСделокРеализации);
	КонецЦикла;
	
	ЗапросУдаленияВременныхТаблиц = Новый Запрос();
	ЗапросУдаленияВременныхТаблиц.МенеджерВременныхТаблиц = Запрос.МенеджерВременныхТаблиц;
	ЗапросУдаленияВременныхТаблиц.Текст = 
	"УНИЧТОЖИТЬ ДокументыКорректировкиИРеализации
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ДанныеДокументовКорректировкиИРеализации
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ДокументыКонтролируемыхСделок
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ТоварыКонтролируемыхСделок
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ТаблицаСделок";
	
	ЗапросУдаленияВременныхТаблиц.Выполнить();
	
КонецПроцедуры

#КонецОбласти

#Область ДобавлениеСделокКомиссии

// Добавляет в список контролируемых сделок отчеты комитенту о продажах.
//
// Параметры:
//  СтруктураПараметров - Структура - параметры контролируемых сделок:
//  * ВалютаРегламентированногоУчета - СправочникСсылка.Валюты - валюта регламетированного учета.
//  * НачалоПериода                  - Дата - начало периода формирования списка контролируемых сделок.
//  * ОкончаниеПериода               - Дата - окончание периода формирования списка контролируемых сделок.
//  * Организация                    - СправочникСсылка.Организации - код места представления.
//  * СписокПодчиненныхОрганизаций   - СписокЗначений из СправочникСсылка.Организации - список подчиненных организаций.
//  МенеджерВременныхТаблиц          - МенеджерВременныхТаблиц - временные таблицы запроса по контролируемым сделкам.
//  ТаблицаСделок                    - ТаблицаЗначений - таблица значений с данными о контролируемых сделках.
//
Процедура ДобавитьСделкиОтчетаКомитентуОПродажах(СтруктураПараметров, МенеджерВременныхТаблиц, ТаблицаСделок)
	
	Запрос = ПодготовитьЗапросКДокументамИсточникам(СтруктураПараметров);
	Запрос.УстановитьПараметр("ИспользованиеСоглашений", ПолучитьФункциональнуюОпцию("ИспользоватьСоглашенияСПоставщиками"));
	Запрос.УстановитьПараметр("ИспользованиеДоговоров", ПолучитьФункциональнуюОпцию("ИспользоватьДоговорыСПоставщиками"));
	Запрос.МенеджерВременныхТаблиц = МенеджерВременныхТаблиц;
	Запрос.Текст =
	"ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	ОтчетКомитенту.Ссылка КАК РасчетныйДокумент,
	|	ОтчетКомитенту.Дата КАК Период,
	|	ОтчетКомитенту.Организация КАК Организация,
	|	ВЫБОР
	|		КОГДА ВзаимозависимыеЛицаПоПериодам.Контрагент ЕСТЬ NULL 
	|			ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА
	|	КОНЕЦ КАК ВзаимозависимыеЛица,
	|	ВЫБОР
	|		КОГДА ИностранныеКонтрагенты.Контрагент ЕСТЬ NULL 
	|			ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА
	|	КОНЕЦ КАК ИностранныйКонтрагент,
	|	ЕСТЬNULL(ИностранныеКонтрагенты.ЗарегистрированВСтранеСЛьготнымНалогообложением, ЛОЖЬ) КАК ЗарегистрированВСтранеСЛьготнымНалогообложением,
	|	ОтчетКомитенту.Контрагент,
	|	ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка) КАК Комиссионер,
	|	ОтчетКомитенту.Услуга КАК ПредметСделки,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.РаботаУслуга) КАК ТипПредметаСделки,
	|	ОтчетКомитенту.Услуга.НаименованиеПолное КАК НаименованиеПредметаСделки,
	|	ЗНАЧЕНИЕ(Справочник.СтраныМира.ПустаяСсылка) КАК СтранаПроисхожденияПредметаСделки,
	|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперацииКонтролируемыхСделок.РеализацияСобственныхУслуг) КАК ХозяйственнаяОперация,
	|	ОтчетКомитенту.Валюта,
	|	ОтчетКомитенту.Услуга.ЕдиницаИзмерения КАК ЕдиницаИзмерения,
	|	1 КАК Количество,
	|	ОтчетКомитенту.СтавкаНДСВознаграждения КАК СтавкаНДС,
	|	ОтчетКомитенту.СуммаВознаграждения - ОтчетКомитенту.СуммаНДСВознаграждения КАК СуммаБезНДС,
	|	ОтчетКомитенту.СуммаНДСВознаграждения КАК СуммаНДС,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыКонтролируемыхСделок.ПолученДоход) КАК ТипКонтролируемойСделки,
	|	ЛОЖЬ КАК ТоварМировойБиржевойТорговли,
	|	ВЫБОР
	|		КОГДА ОтчетКомитенту.НалогообложениеНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаОблагаетсяЕНВД)
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ КАК ОперацияОблагаетсяЕНВД,
	|	НЕОПРЕДЕЛЕНО КАК Грузоотправитель,
	|	ОтчетКомитенту.Контрагент КАК Грузополучатель,
	|	ВЫБОР
	|		КОГДА &ИспользованиеДоговоров
	|			ТОГДА ОтчетКомитенту.Договор
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК Договор,
	|	ВЫБОР
	|		КОГДА &ИспользованиеСоглашений
	|			ТОГДА ОтчетКомитенту.Соглашение
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК Соглашение,
	|	ОтчетКомитенту.Ссылка КАК РегистраторРегистраСумм,
	|	1 КАК МножительСуммовыхДанных,
	|	"""" КАК ИдентификаторСтроки
	|ПОМЕСТИТЬ ТаблицаСделок
	|ИЗ
	|	Документ.ОтчетКомитенту КАК ОтчетКомитенту
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВзаимозависимыеЛицаПоПериодам КАК ВзаимозависимыеЛицаПоПериодам
	|		ПО (ВзаимозависимыеЛицаПоПериодам.Организация = &Организация)
	|			И (ВзаимозависимыеЛицаПоПериодам.Контрагент = ОтчетКомитенту.Контрагент)
	|			И ОтчетКомитенту.Дата >= ВзаимозависимыеЛицаПоПериодам.НачалоПериода
	|			И ОтчетКомитенту.Дата <= ВзаимозависимыеЛицаПоПериодам.ОкончаниеПериода
	|		ЛЕВОЕ СОЕДИНЕНИЕ ИностранныеКонтрагенты КАК ИностранныеКонтрагенты
	|		ПО (ИностранныеКонтрагенты.Контрагент = ОтчетКомитенту.Контрагент)
	|ГДЕ
	|	ОтчетКомитенту.Организация В(&СтруктураОрганизации)
	|	И ОтчетКомитенту.Дата >= &НачалоПериода
	|	И ОтчетКомитенту.Дата <= &ОкончаниеПериода
	|	И ОтчетКомитенту.Проведен = ИСТИНА
	|	И ОтчетКомитенту.Контрагент В
	|			(ВЫБРАТЬ
	|				КонтролируемыеКонтрагенты.Контрагент
	|			ИЗ
	|				КонтролируемыеКонтрагенты КАК КонтролируемыеКонтрагенты)
	|	И (НЕ ВзаимозависимыеЛицаПоПериодам.Контрагент ЕСТЬ NULL 
	|			ИЛИ ЕСТЬNULL(ИностранныеКонтрагенты.ЗарегистрированВСтранеСЛьготнымНалогообложением, ЛОЖЬ))
	|	И ВЫБОР
	|			КОГДА ОтчетКомитенту.Договор = ЗНАЧЕНИЕ(Справочник.ДоговорыКонтрагентов.ПустаяСсылка)
	|				ТОГДА ИСТИНА
	|			ИНАЧЕ ОтчетКомитенту.Договор.ТипДоговора = ЗНАЧЕНИЕ(Перечисление.ТипыДоговоров.СКомитентом)
	|		КОНЕЦ
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	РегистраторРегистраСумм,
	|	ИдентификаторСтроки";
	
	Запрос.Выполнить();
	
	ВыборкаСделокРеализации = ПолучитьВыборкуТаблицыСделокСПреобразованиемСуммКРублевым(Запрос.МенеджерВременныхТаблиц);
	
	Пока ВыборкаСделокРеализации.Следующий() Цикл
		СтрокаСделки = ТаблицаСделок.Добавить();
		ЗаполнитьЗначенияСвойств(СтрокаСделки, ВыборкаСделокРеализации);
	КонецЦикла;
	
	ЗапросУдаленияВременныхТаблиц = Новый Запрос();
	ЗапросУдаленияВременныхТаблиц.МенеджерВременныхТаблиц = Запрос.МенеджерВременныхТаблиц;
	ЗапросУдаленияВременныхТаблиц.Текст = 
	"
	|УНИЧТОЖИТЬ ТаблицаСделок";
	
	ЗапросУдаленияВременныхТаблиц.Выполнить();
	
КонецПроцедуры

// Добавляет в список контролируемых сделок отчеты комитенту о списании.
//
// Параметры:
//  СтруктураПараметров - Структура - параметры контролируемых сделок:
//  * ВалютаРегламентированногоУчета - СправочникСсылка.Валюты - валюта регламетированного учета.
//  * НачалоПериода                  - Дата - начало периода формирования списка контролируемых сделок.
//  * ОкончаниеПериода               - Дата - окончание периода формирования списка контролируемых сделок.
//  * Организация                    - СправочникСсылка.Организации - код места представления.
//  * СписокПодчиненныхОрганизаций   - СписокЗначений из СправочникСсылка.Организации - список подчиненных организаций.
//  МенеджерВременныхТаблиц          - МенеджерВременныхТаблиц - временные таблицы запроса по контролируемым сделкам.
//  ТаблицаСделок                    - ТаблицаЗначений - таблица значений с данными о контролируемых сделках.
//
Процедура ДобавитьСделкиОтчетаКомитентуОСписании(СтруктураПараметров, МенеджерВременныхТаблиц, ТаблицаСделок)
	
	Запрос = ПодготовитьЗапросКДокументамИсточникам(СтруктураПараметров);
	Запрос.УстановитьПараметр("ИспользованиеСоглашений", ПолучитьФункциональнуюОпцию("ИспользоватьСоглашенияСПоставщиками"));
	Запрос.УстановитьПараметр("ИспользованиеДоговоров", ПолучитьФункциональнуюОпцию("ИспользоватьДоговорыСПоставщиками"));
	Запрос.МенеджерВременныхТаблиц = МенеджерВременныхТаблиц;
	Запрос.Текст =
	"ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	ОтчетКомитентуОСписании.Ссылка КАК РасчетныйДокумент,
	|	ОтчетКомитентуОСписании.Дата КАК Период,
	|	ОтчетКомитентуОСписании.Организация КАК Организация,
	|	ОтчетКомитентуОСписании.Контрагент КАК Контрагент,
	|	ОтчетКомитентуОСписании.Валюта КАК Валюта,
	|	ВЫБОР
	|		КОГДА &ИспользованиеДоговоров
	|		ТОГДА ОтчетКомитентуОСписании.Договор
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК Договор,
	|	ВЫБОР
	|		КОГДА &ИспользованиеСоглашений
	|		ТОГДА ОтчетКомитентуОСписании.Соглашение
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК Соглашение,
	|	ВЫБОР
	|		КОГДА ВзаимозависимыеЛицаПоПериодам.Контрагент ЕСТЬ NULL 
	|			ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА
	|	КОНЕЦ КАК ВзаимозависимыеЛица,
	|	ВЫБОР
	|		КОГДА ИностранныеКонтрагенты.Контрагент ЕСТЬ NULL 
	|			ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА
	|	КОНЕЦ КАК ИностранныйКонтрагент,
	|	ЕСТЬNULL(ИностранныеКонтрагенты.ЗарегистрированВСтранеСЛьготнымНалогообложением, ЛОЖЬ) КАК ЗарегистрированВСтранеСЛьготнымНалогообложением
	|ПОМЕСТИТЬ ДокументыКонтролируемыхСделок
	|ИЗ
	|	Документ.ОтчетКомитентуОСписании КАК ОтчетКомитентуОСписании
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВзаимозависимыеЛицаПоПериодам КАК ВзаимозависимыеЛицаПоПериодам
	|		ПО (ВзаимозависимыеЛицаПоПериодам.Организация = &Организация)
	|			И (ВзаимозависимыеЛицаПоПериодам.Контрагент = ОтчетКомитентуОСписании.Контрагент)
	|			И ОтчетКомитентуОСписании.Дата >= ВзаимозависимыеЛицаПоПериодам.НачалоПериода
	|			И ОтчетКомитентуОСписании.Дата <= ВзаимозависимыеЛицаПоПериодам.ОкончаниеПериода
	|		ЛЕВОЕ СОЕДИНЕНИЕ ИностранныеКонтрагенты КАК ИностранныеКонтрагенты
	|		ПО (ИностранныеКонтрагенты.Контрагент = ОтчетКомитентуОСписании.Контрагент)
	|ГДЕ
	|	ОтчетКомитентуОСписании.Организация В(&СтруктураОрганизации)
	|	И ОтчетКомитентуОСписании.Дата >= &НачалоПериода
	|	И ОтчетКомитентуОСписании.Дата <= &ОкончаниеПериода
	|	И ОтчетКомитентуОСписании.Проведен = ИСТИНА
	|	И ОтчетКомитентуОСписании.Контрагент В
	|			(ВЫБРАТЬ
	|				КонтролируемыеКонтрагенты.Контрагент
	|			ИЗ
	|				КонтролируемыеКонтрагенты КАК КонтролируемыеКонтрагенты)
	|	И (НЕ ВзаимозависимыеЛицаПоПериодам.Контрагент ЕСТЬ NULL 
	|			ИЛИ НЕ ИностранныеКонтрагенты.Контрагент ЕСТЬ NULL )
	|	И ВЫБОР
	|			КОГДА ОтчетКомитентуОСписании.Договор = ЗНАЧЕНИЕ(Справочник.ДоговорыКонтрагентов.ПустаяСсылка)
	|				ТОГДА ИСТИНА
	|			ИНАЧЕ ОтчетКомитентуОСписании.Договор.ТипДоговора = ЗНАЧЕНИЕ(Перечисление.ТипыДоговоров.СКомитентом)
	|		КОНЕЦ
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	РасчетныйДокумент
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	ТоварыКомитента.Ссылка КАК РасчетныйДокумент,
	|	ДокументыКонтролируемыхСделок.Период КАК Период,
	|	ДокументыКонтролируемыхСделок.Организация КАК Организация,
	|	ДокументыКонтролируемыхСделок.Контрагент КАК Контрагент,
	|	ДокументыКонтролируемыхСделок.Валюта КАК Валюта,
	|	ДокументыКонтролируемыхСделок.Договор КАК Договор,
	|	ДокументыКонтролируемыхСделок.Соглашение КАК Соглашение,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыКонтролируемыхСделок.ПолученДоход) КАК ТипКонтролируемойСделки,
	|	Аналитика.Номенклатура КАК ПредметСделки,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.Товар) КАК ТипПредметаСделки,
	|	СУММА(ТоварыКомитента.Количество) КАК Количество,
	|	Аналитика.Номенклатура.ЕдиницаИзмерения КАК ЕдиницаИзмеренияПоКлассификатору,
	|	СУММА(ТоварыКомитента.СуммаСНДС - ТоварыКомитента.СуммаНДС) КАК СуммаБезНДС,
	|	ТоварыКомитента.СтавкаНДС,
	|	СУММА(ТоварыКомитента.СуммаНДС) КАК СуммаНДС,
	|	ВЫБОР
	|		КОГДА ТоварыКомитента.Ссылка.НалогообложениеНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаОблагаетсяЕНВД)
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ КАК ОперацияОблагаетсяЕНВД,
	|	ВЫБОР
	|		КОГДА ТоварыМировойБиржевойТорговли.ПредметСделки ЕСТЬ NULL 
	|			ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА
	|	КОНЕЦ КАК ТоварМировойБиржевойТорговли,
	|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперацииКонтролируемыхСделок.ПриобретениеТоваров) КАК ХозяйственнаяОперация,
	|	ИСТИНА КАК ВключатьСоставСделок,
	|	ЕСТЬNULL(ТоварыКомитента.НомерГТД.СтранаПроисхождения, ЗНАЧЕНИЕ(Справочник.СтраныМира.Россия)) КАК СтранаПроисхождения,
	|	ДокументыКонтролируемыхСделок.ИностранныйКонтрагент,
	|	ДокументыКонтролируемыхСделок.ЗарегистрированВСтранеСЛьготнымНалогообложением,
	|	ДокументыКонтролируемыхСделок.ВзаимозависимыеЛица,
	|	ТоварыКомитента.ИдентификаторСтроки
	|ПОМЕСТИТЬ ТоварыКонтролируемыхСделок
	|ИЗ
	|	Документ.ОтчетКомитентуОСписании.ВидыЗапасов КАК ТоварыКомитента
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ДокументыКонтролируемыхСделок КАК ДокументыКонтролируемыхСделок
	|		ПО ТоварыКомитента.Ссылка = ДокументыКонтролируемыхСделок.РасчетныйДокумент
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК Аналитика
	|		ПО ТоварыКомитента.АналитикаУчетаНоменклатуры = Аналитика.Ссылка
	|		ЛЕВОЕ СОЕДИНЕНИЕ ТоварыМировойБиржевойТорговли КАК ТоварыМировойБиржевойТорговли
	|		ПО Аналитика.Номенклатура = ТоварыМировойБиржевойТорговли.ПредметСделки
	|			И ТоварыМировойБиржевойТорговли.ДатаНачалаДействия <= ДокументыКонтролируемыхСделок.Период
	|			И ТоварыМировойБиржевойТорговли.ДатаОкончанияДействия >= ДокументыКонтролируемыхСделок.Период
	|
	|СГРУППИРОВАТЬ ПО
	|	ТоварыКомитента.Ссылка,
	|	ДокументыКонтролируемыхСделок.Период,
	|	ДокументыКонтролируемыхСделок.Организация,
	|	ДокументыКонтролируемыхСделок.Контрагент,
	|	ДокументыКонтролируемыхСделок.Валюта,
	|	ДокументыКонтролируемыхСделок.Договор,
	|	ДокументыКонтролируемыхСделок.Соглашение,
	|	Аналитика.Номенклатура,
	|	Аналитика.Номенклатура.ЕдиницаИзмерения,
	|	ТоварыКомитента.СтавкаНДС,
	|	ВЫБОР
	|		КОГДА ТоварыМировойБиржевойТорговли.ПредметСделки ЕСТЬ NULL 
	|			ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА
	|	КОНЕЦ,
	|	ТоварыКомитента.ИдентификаторСтроки,
	|	ДокументыКонтролируемыхСделок.ВзаимозависимыеЛица,
	|	ДокументыКонтролируемыхСделок.ИностранныйКонтрагент,
	|	ДокументыКонтролируемыхСделок.ЗарегистрированВСтранеСЛьготнымНалогообложением,
	|	ЕСТЬNULL(ТоварыКомитента.НомерГТД.СтранаПроисхождения, ЗНАЧЕНИЕ(Справочник.СтраныМира.Россия)),
	|	ВЫБОР
	|		КОГДА ТоварыКомитента.Ссылка.НалогообложениеНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаОблагаетсяЕНВД)
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ТоварыКонтролируемыхСделок.РасчетныйДокумент КАК РасчетныйДокумент,
	|	ТоварыКонтролируемыхСделок.Период КАК Период,
	|	ТоварыКонтролируемыхСделок.Организация КАК Организация,
	|	ТоварыКонтролируемыхСделок.Контрагент КАК Контрагент,
	|	ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка) КАК Комиссионер,
	|	ТоварыКонтролируемыхСделок.ПредметСделки,
	|	ТоварыКонтролируемыхСделок.ТипПредметаСделки,
	|	ТоварыКонтролируемыхСделок.ПредметСделки.НаименованиеПолное КАК НаименованиеПредметаСделки,
	|	ТоварыКонтролируемыхСделок.СтранаПроисхождения КАК СтранаПроисхожденияПредметаСделки,
	|	ТоварыКонтролируемыхСделок.ХозяйственнаяОперация,
	|	ТоварыКонтролируемыхСделок.Валюта КАК Валюта,
	|	ТоварыКонтролируемыхСделок.ЕдиницаИзмеренияПоКлассификатору КАК ЕдиницаИзмерения,
	|	ТоварыКонтролируемыхСделок.Количество,
	|	ТоварыКонтролируемыхСделок.СтавкаНДС,
	|	ТоварыКонтролируемыхСделок.СуммаБезНДС,
	|	ТоварыКонтролируемыхСделок.СуммаНДС,
	|	ТоварыКонтролируемыхСделок.ТипКонтролируемойСделки,
	|	ТоварыКонтролируемыхСделок.ТоварМировойБиржевойТорговли,
	|	ТоварыКонтролируемыхСделок.ОперацияОблагаетсяЕНВД,
	|	ТоварыКонтролируемыхСделок.Договор КАК Договор,
	|	ТоварыКонтролируемыхСделок.Соглашение КАК Соглашение,
	|	ТоварыКонтролируемыхСделок.ИдентификаторСтроки КАК ИдентификаторСтроки,
	|	ТоварыКонтролируемыхСделок.РасчетныйДокумент КАК РегистраторРегистраСумм,
	|	-1 КАК МножительСуммовыхДанных,
	|	ТоварыКонтролируемыхСделок.Контрагент КАК Грузоотправитель,
	|	ТоварыКонтролируемыхСделок.Организация КАК Грузополучатель
	|ПОМЕСТИТЬ ТаблицаСделок
	|ИЗ
	|	ТоварыКонтролируемыхСделок КАК ТоварыКонтролируемыхСделок
	|ГДЕ
	|	(ТоварыКонтролируемыхСделок.ТоварМировойБиржевойТорговли
	|				И ТоварыКонтролируемыхСделок.ИностранныйКонтрагент
	|			ИЛИ ТоварыКонтролируемыхСделок.ВзаимозависимыеЛица
	|			ИЛИ ТоварыКонтролируемыхСделок.ЗарегистрированВСтранеСЛьготнымНалогообложением)
	|	И ТоварыКонтролируемыхСделок.ВключатьСоставСделок
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	РегистраторРегистраСумм,
	|	ИдентификаторСтроки";
	
	Запрос.Выполнить();
	
	ВыборкаСделокРеализации = ПолучитьВыборкуТаблицыСделокСПреобразованиемСуммКРублевым(Запрос.МенеджерВременныхТаблиц);
	
	Пока ВыборкаСделокРеализации.Следующий() Цикл
		СтрокаСделки = ТаблицаСделок.Добавить();
		ЗаполнитьЗначенияСвойств(СтрокаСделки, ВыборкаСделокРеализации);
	КонецЦикла;
	
	ЗапросУдаленияВременныхТаблиц = Новый Запрос();
	ЗапросУдаленияВременныхТаблиц.МенеджерВременныхТаблиц = Запрос.МенеджерВременныхТаблиц;
	ЗапросУдаленияВременныхТаблиц.Текст = 
	"УНИЧТОЖИТЬ ДокументыКонтролируемыхСделок
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ТоварыКонтролируемыхСделок
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ТаблицаСделок";
	
	ЗапросУдаленияВременныхТаблиц.Выполнить();
	
КонецПроцедуры

// Добавляет в список контролируемых сделок отчеты комитенту о закупках.
//
// Параметры:
//  СтруктураПараметров - Структура - параметры контролируемых сделок:
//  * ВалютаРегламентированногоУчета - СправочникСсылка.Валюты - валюта регламетированного учета.
//  * НачалоПериода                  - Дата - начало периода формирования списка контролируемых сделок.
//  * ОкончаниеПериода               - Дата - окончание периода формирования списка контролируемых сделок.
//  * Организация                    - СправочникСсылка.Организации - код места представления.
//  * СписокПодчиненныхОрганизаций   - СписокЗначений из СправочникСсылка.Организации - список подчиненных организаций.
//  МенеджерВременныхТаблиц          - МенеджерВременныхТаблиц - временные таблицы запроса по контролируемым сделкам.
//  ТаблицаСделок                    - ТаблицаЗначений - таблица значений с данными о контролируемых сделках.
//
Процедура ДобавитьСделкиОтчетаКомитентуОЗакупках(СтруктураПараметров, МенеджерВременныхТаблиц, ТаблицаСделок)
	
	Запрос = ПодготовитьЗапросКДокументамИсточникам(СтруктураПараметров);
	Запрос.УстановитьПараметр("ИспользованиеСоглашений", ПолучитьФункциональнуюОпцию("ИспользоватьСоглашенияСПоставщиками"));
	Запрос.УстановитьПараметр("ИспользованиеДоговоров", ПолучитьФункциональнуюОпцию("ИспользоватьДоговорыСПоставщиками"));
	Запрос.МенеджерВременныхТаблиц = МенеджерВременныхТаблиц;
	Запрос.Текст =
	"ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	ОтчетКомитенту.Ссылка КАК РасчетныйДокумент,
	|	ОтчетКомитенту.Дата КАК Период,
	|	ОтчетКомитенту.Организация КАК Организация,
	|	НЕ ВзаимозависимыеЛицаПоПериодам.Контрагент ЕСТЬ NULL КАК ВзаимозависимыеЛица,
	|	НЕ ИностранныеКонтрагенты.Контрагент ЕСТЬ NULL КАК ИностранныйКонтрагент,
	|	ЕСТЬNULL(ИностранныеКонтрагенты.ЗарегистрированВСтранеСЛьготнымНалогообложением, ЛОЖЬ) КАК ЗарегистрированВСтранеСЛьготнымНалогообложением,
	|	ОтчетКомитенту.Контрагент,
	|	ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка) КАК Комиссионер,
	|	ОтчетКомитенту.Услуга КАК ПредметСделки,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.РаботаУслуга) КАК ТипПредметаСделки,
	|	ОтчетКомитенту.Услуга.НаименованиеПолное КАК НаименованиеПредметаСделки,
	|	ЗНАЧЕНИЕ(Справочник.СтраныМира.ПустаяСсылка) КАК СтранаПроисхожденияПредметаСделки,
	|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперацииКонтролируемыхСделок.РеализацияСобственныхУслуг) КАК ХозяйственнаяОперация,
	|	ОтчетКомитенту.Валюта,
	|	ОтчетКомитенту.Услуга.ЕдиницаИзмерения КАК ЕдиницаИзмерения,
	|	1 КАК Количество,
	|	ОтчетКомитенту.СтавкаНДСВознаграждения КАК СтавкаНДС,
	|	ОтчетКомитенту.СуммаВознаграждения - ОтчетКомитенту.СуммаНДСВознаграждения КАК СуммаБезНДС,
	|	ОтчетКомитенту.СуммаНДСВознаграждения КАК СуммаНДС,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыКонтролируемыхСделок.ПолученДоход) КАК ТипКонтролируемойСделки,
	|	ЛОЖЬ КАК ТоварМировойБиржевойТорговли,
	|	ВЫБОР
	|		КОГДА ОтчетКомитенту.НалогообложениеНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаОблагаетсяЕНВД)
	|		ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ КАК ОперацияОблагаетсяЕНВД,
	|	ОтчетКомитенту.Контрагент КАК Грузоотправитель,
	|	НЕОПРЕДЕЛЕНО КАК Грузополучатель,
	|	ВЫБОР
	|		КОГДА &ИспользованиеДоговоров
	|		ТОГДА ОтчетКомитенту.Договор
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК Договор,
	|	ВЫБОР
	|		КОГДА &ИспользованиеСоглашений
	|		ТОГДА ОтчетКомитенту.Соглашение
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК Соглашение,
	|	ОтчетКомитенту.Ссылка КАК РегистраторРегистраСумм,
	|	1 КАК МножительСуммовыхДанных,
	|	ЕСТЬNULL(ТоварыВознаграждение.ИдентификаторСтрокиВознаграждения, """") КАК ИдентификаторСтроки
	|ПОМЕСТИТЬ ТаблицаСделок
	|ИЗ
	|	Документ.ОтчетКомитентуОЗакупках КАК ОтчетКомитенту
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.ОтчетКомитентуОЗакупках.Товары КАК ТоварыВознаграждение
	|		ПО ТоварыВознаграждение.Ссылка = ОтчетКомитенту.Ссылка
	|			И ТоварыВознаграждение.СуммаВознаграждения <> 0
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВзаимозависимыеЛицаПоПериодам КАК ВзаимозависимыеЛицаПоПериодам
	|		ПО (ВзаимозависимыеЛицаПоПериодам.Организация = &Организация)
	|			И (ВзаимозависимыеЛицаПоПериодам.Контрагент = ОтчетКомитенту.Контрагент)
	|			И ОтчетКомитенту.Дата >= ВзаимозависимыеЛицаПоПериодам.НачалоПериода
	|			И ОтчетКомитенту.Дата <= ВзаимозависимыеЛицаПоПериодам.ОкончаниеПериода
	|		ЛЕВОЕ СОЕДИНЕНИЕ ИностранныеКонтрагенты КАК ИностранныеКонтрагенты
	|		ПО (ИностранныеКонтрагенты.Контрагент = ОтчетКомитенту.Контрагент)
	|ГДЕ
	|	ОтчетКомитенту.Организация В(&СтруктураОрганизации)
	|	И ОтчетКомитенту.Дата >= &НачалоПериода
	|	И ОтчетКомитенту.Дата <= &ОкончаниеПериода
	|	И ОтчетКомитенту.Проведен = ИСТИНА
	|	И ОтчетКомитенту.Контрагент В
	|			(ВЫБРАТЬ
	|				КонтролируемыеКонтрагенты.Контрагент
	|			ИЗ
	|				КонтролируемыеКонтрагенты КАК КонтролируемыеКонтрагенты)
	|	И (НЕ ВзаимозависимыеЛицаПоПериодам.Контрагент ЕСТЬ NULL 
	|			ИЛИ ЕСТЬNULL(ИностранныеКонтрагенты.ЗарегистрированВСтранеСЛьготнымНалогообложением, ЛОЖЬ))
	|	И ВЫБОР
	|			КОГДА ОтчетКомитенту.Договор = ЗНАЧЕНИЕ(Справочник.ДоговорыКонтрагентов.ПустаяСсылка)
	|				ТОГДА ИСТИНА
	|			ИНАЧЕ ОтчетКомитенту.Договор.ТипДоговора = ЗНАЧЕНИЕ(Перечисление.ТипыДоговоров.СКомитентомНаЗакупку)
	|		КОНЕЦ
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	РегистраторРегистраСумм,
	|	ИдентификаторСтроки";
	
	Запрос.Выполнить();
	
	ВыборкаСделокРеализации = ПолучитьВыборкуТаблицыСделокСПреобразованиемСуммКРублевым(Запрос.МенеджерВременныхТаблиц);
	
	Пока ВыборкаСделокРеализации.Следующий() Цикл
		СтрокаСделки = ТаблицаСделок.Добавить();
		ЗаполнитьЗначенияСвойств(СтрокаСделки, ВыборкаСделокРеализации);
	КонецЦикла;
	
	ЗапросУдаленияВременныхТаблиц = Новый Запрос();
	ЗапросУдаленияВременныхТаблиц.МенеджерВременныхТаблиц = Запрос.МенеджерВременныхТаблиц;
	ЗапросУдаленияВременныхТаблиц.Текст = 
	"
	|УНИЧТОЖИТЬ ТаблицаСделок";
	
	ЗапросУдаленияВременныхТаблиц.Выполнить();
	
КонецПроцедуры

// Добавляет в список контролируемых сделок отчеты комиссионера о продажах.
//
// Параметры:
//  СтруктураПараметров - Структура - параметры контролируемых сделок:
//  * ВалютаРегламентированногоУчета - СправочникСсылка.Валюты - валюта регламетированного учета.
//  * НачалоПериода                  - Дата - начало периода формирования списка контролируемых сделок.
//  * ОкончаниеПериода               - Дата - окончание периода формирования списка контролируемых сделок.
//  * Организация                    - СправочникСсылка.Организации - код места представления.
//  * СписокПодчиненныхОрганизаций   - СписокЗначений из СправочникСсылка.Организации - список подчиненных организаций.
//  МенеджерВременныхТаблиц          - МенеджерВременныхТаблиц - временные таблицы запроса по контролируемым сделкам.
//  ТаблицаСделок                    - ТаблицаЗначений - таблица значений с данными о контролируемых сделках.
//
Процедура ДобавитьСделкиОтчетаКомиссионераОПродажах(СтруктураПараметров, МенеджерВременныхТаблиц, ТаблицаСделок)
	
	Запрос = ПодготовитьЗапросКДокументамИсточникам(СтруктураПараметров);
	Запрос.УстановитьПараметр("ИспользованиеСоглашений", ПолучитьФункциональнуюОпцию("ИспользоватьСоглашенияСКлиентами"));
	Запрос.УстановитьПараметр("ИспользованиеДоговоров", ПолучитьФункциональнуюОпцию("ИспользоватьДоговорыСКлиентами"));
	Запрос.МенеджерВременныхТаблиц = МенеджерВременныхТаблиц;
	Запрос.Текст =
	"ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	ОтчетКомиссионера.Ссылка КАК РасчетныйДокумент,
	|	ОтчетКомиссионера.Дата КАК Период,
	|	ОтчетКомиссионера.Организация КАК Организация,
	|	ОтчетКомиссионера.Контрагент,
	|	ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка) КАК Комиссионер,
	|	ОтчетКомиссионера.Услуга КАК ПредметСделки,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.РаботаУслуга) КАК ТипПредметаСделки,
	|	ОтчетКомиссионера.Услуга.НаименованиеПолное КАК НаименованиеПредметаСделки,
	|	ЗНАЧЕНИЕ(Справочник.СтраныМира.ПустаяСсылка) КАК СтранаПроисхожденияПредметаСделки,
	|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперацииКонтролируемыхСделок.ПолучениеУслуг) КАК ХозяйственнаяОперация,
	|	ОтчетКомиссионера.Валюта,
	|	ОтчетКомиссионера.Услуга.ЕдиницаИзмерения КАК ЕдиницаИзмерения,
	|	1 КАК Количество,
	|	ОтчетКомиссионера.СтавкаНДСВознаграждения КАК СтавкаНДС,
	|	ОтчетКомиссионера.СуммаВознаграждения - ОтчетКомиссионера.СуммаНДСВознаграждения КАК СуммаБезНДС,
	|	ОтчетКомиссионера.СуммаНДСВознаграждения КАК СуммаНДС,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыКонтролируемыхСделок.ОсуществленРасход) КАК ТипКонтролируемойСделки,
	|	ЛОЖЬ КАК ТоварМировойБиржевойТорговли,
	|	ВЫБОР
	|		КОГДА ОтчетКомиссионера.НалогообложениеНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаОблагаетсяЕНВД)
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ КАК ОперацияОблагаетсяЕНВД,
	|	НЕОПРЕДЕЛЕНО КАК Грузоотправитель,
	|	ОтчетКомиссионера.Организация КАК Грузополучатель,
	|	ВЫБОР
	|		КОГДА &ИспользованиеДоговоров
	|			ТОГДА ОтчетКомиссионера.Договор
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК Договор,
	|	ВЫБОР
	|		КОГДА &ИспользованиеСоглашений
	|			ТОГДА ОтчетКомиссионера.Соглашение
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК Соглашение,
	|	ОтчетКомиссионера.Ссылка КАК РегистраторРегистраСумм,
	|	1 КАК МножительСуммовыхДанных,
	|	"""" КАК ИдентификаторСтроки
	|ПОМЕСТИТЬ ТаблицаСделок
	|ИЗ
	|	Документ.ОтчетКомиссионера КАК ОтчетКомиссионера
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВзаимозависимыеЛицаПоПериодам КАК ВзаимозависимыеЛицаПоПериодам
	|		ПО (ВзаимозависимыеЛицаПоПериодам.Организация = &Организация)
	|			И (ВзаимозависимыеЛицаПоПериодам.Контрагент = ОтчетКомиссионера.Контрагент)
	|			И ОтчетКомиссионера.Дата >= ВзаимозависимыеЛицаПоПериодам.НачалоПериода
	|			И ОтчетКомиссионера.Дата <= ВзаимозависимыеЛицаПоПериодам.ОкончаниеПериода
	|		ЛЕВОЕ СОЕДИНЕНИЕ ИностранныеКонтрагенты КАК ИностранныеКонтрагенты
	|		ПО (ИностранныеКонтрагенты.Контрагент = ОтчетКомиссионера.Контрагент)
	|ГДЕ
	|	ОтчетКомиссионера.Организация В(&СтруктураОрганизации)
	|	И ОтчетКомиссионера.Дата >= &НачалоПериода
	|	И ОтчетКомиссионера.Дата <= &ОкончаниеПериода
	|	И ОтчетКомиссионера.Проведен = ИСТИНА
	|	И ОтчетКомиссионера.Контрагент В
	|			(ВЫБРАТЬ
	|				КонтролируемыеКонтрагенты.Контрагент
	|			ИЗ
	|				КонтролируемыеКонтрагенты КАК КонтролируемыеКонтрагенты)
	|	И (НЕ ВзаимозависимыеЛицаПоПериодам.Контрагент ЕСТЬ NULL 
	|			ИЛИ ЕСТЬNULL(ИностранныеКонтрагенты.ЗарегистрированВСтранеСЛьготнымНалогообложением, ЛОЖЬ))
	|	И ВЫБОР
	|			КОГДА ОтчетКомиссионера.Договор = ЗНАЧЕНИЕ(Справочник.ДоговорыКонтрагентов.ПустаяСсылка)
	|				ТОГДА ИСТИНА
	|			ИНАЧЕ ОтчетКомиссионера.Договор.ТипДоговора = ЗНАЧЕНИЕ(Перечисление.ТипыДоговоров.СКомиссионером)
	|		КОНЕЦ
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	РегистраторРегистраСумм,
	|	ИдентификаторСтроки";
	
	Запрос.Выполнить();
	
	ВыборкаСделокРеализации = ПолучитьВыборкуТаблицыСделокСПреобразованиемСуммКРублевым(Запрос.МенеджерВременныхТаблиц);
	
	Пока ВыборкаСделокРеализации.Следующий() Цикл
		СтрокаСделки = ТаблицаСделок.Добавить();
		ЗаполнитьЗначенияСвойств(СтрокаСделки, ВыборкаСделокРеализации);
	КонецЦикла;
	
	ЗапросУдаленияВременныхТаблиц = Новый Запрос();
	ЗапросУдаленияВременныхТаблиц.МенеджерВременныхТаблиц = Запрос.МенеджерВременныхТаблиц;
	ЗапросУдаленияВременныхТаблиц.Текст = 
	"
	|УНИЧТОЖИТЬ ТаблицаСделок";
	
	ЗапросУдаленияВременныхТаблиц.Выполнить();

КонецПроцедуры

// Добавляет в список контролируемых сделок отчеты комиссионера о продажах зависимым лицам.
//
// Параметры:
//  СтруктураПараметров - Структура - параметры контролируемых сделок:
//  * ВалютаРегламентированногоУчета - СправочникСсылка.Валюты - валюта регламетированного учета.
//  * НачалоПериода                  - Дата - начало периода формирования списка контролируемых сделок.
//  * ОкончаниеПериода               - Дата - окончание периода формирования списка контролируемых сделок.
//  * Организация                    - СправочникСсылка.Организации - код места представления.
//  * СписокПодчиненныхОрганизаций   - СписокЗначений из СправочникСсылка.Организации - список подчиненных организаций.
//  МенеджерВременныхТаблиц          - МенеджерВременныхТаблиц - временные таблицы запроса по контролируемым сделкам.
//  ТаблицаСделок                    - ТаблицаЗначений - таблица значений с данными о контролируемых сделках.
//
Процедура ДобавитьСделкиОтчетаКомиссионераОПродажахЗависимымЛицам(СтруктураПараметров, МенеджерВременныхТаблиц, ТаблицаСделок)
	
	Запрос = ПодготовитьЗапросКДокументамИсточникам(СтруктураПараметров);
	Запрос.МенеджерВременныхТаблиц = МенеджерВременныхТаблиц;
	Запрос.Текст =
	"ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	ОтчетКомиссионера.Ссылка КАК РасчетныйДокумент,
	|	ОтчетКомиссионера.Контрагент КАК Контрагент,
	|	ОтчетКомиссионера.Дата КАК Период,
	|	ОтчетКомиссионера.Организация КАК Организация,
	|	ОтчетКомиссионера.Валюта КАК Валюта
	|ПОМЕСТИТЬ ДокументыКонтролируемыхСделокБезПроверкиПоПокупателям
	|ИЗ
	|	Документ.ОтчетКомиссионера КАК ОтчетКомиссионера
	|ГДЕ
	|	ОтчетКомиссионера.Организация В(&СтруктураОрганизации)
	|	И ОтчетКомиссионера.Дата >= &НачалоПериода
	|	И ОтчетКомиссионера.Дата <= &ОкончаниеПериода
	|	И ОтчетКомиссионера.Проведен = ИСТИНА
	|	И ВЫБОР
	|			КОГДА ОтчетКомиссионера.Договор = ЗНАЧЕНИЕ(Справочник.ДоговорыКонтрагентов.ПустаяСсылка)
	|				ТОГДА ИСТИНА
	|			ИНАЧЕ ОтчетКомиссионера.Договор.ТипДоговора = ЗНАЧЕНИЕ(Перечисление.ТипыДоговоров.СКомиссионером)
	|		КОНЕЦ
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	РасчетныйДокумент
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	ОтчетКомиссионераТовары.Ссылка КАК РасчетныйДокумент,
	|	ВЫБОР
	|		КОГДА ВзаимозависимыеЛицаПоПериодам.Контрагент ЕСТЬ NULL
	|			ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА
	|	КОНЕЦ КАК ВзаимозависимыеЛица,
	|	ОтчетКомиссионераТовары.Покупатель КАК Покупатель,
	|	ДокументыКонтролируемыхСделокБезПроверкиПоПокупателям.Контрагент КАК Комиссионер,
	|	ДокументыКонтролируемыхСделокБезПроверкиПоПокупателям.Период КАК Период,
	|	ДокументыКонтролируемыхСделокБезПроверкиПоПокупателям.Организация КАК Организация,
	|	ДокументыКонтролируемыхСделокБезПроверкиПоПокупателям.Валюта КАК Валюта
	|ПОМЕСТИТЬ ДокументыКонтролируемыхСделок
	|ИЗ
	|	ДокументыКонтролируемыхСделокБезПроверкиПоПокупателям КАК ДокументыКонтролируемыхСделокБезПроверкиПоПокупателям
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ОтчетКомиссионера.Товары КАК ОтчетКомиссионераТовары
	|		ПО ДокументыКонтролируемыхСделокБезПроверкиПоПокупателям.РасчетныйДокумент = ОтчетКомиссионераТовары.Ссылка
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВзаимозависимыеЛицаПоПериодам КАК ВзаимозависимыеЛицаПоПериодам
	|		ПО (ВзаимозависимыеЛицаПоПериодам.Организация = &Организация)
	|			И ОтчетКомиссионераТовары.Покупатель = ВзаимозависимыеЛицаПоПериодам.Контрагент
	|			И ОтчетКомиссионераТовары.Ссылка.Дата >= ВзаимозависимыеЛицаПоПериодам.НачалоПериода
	|			И ОтчетКомиссионераТовары.Ссылка.Дата <= ВзаимозависимыеЛицаПоПериодам.ОкончаниеПериода
	|ГДЕ
	|	НЕ ВзаимозависимыеЛицаПоПериодам.Контрагент ЕСТЬ NULL
	|	И ОтчетКомиссионераТовары.Покупатель В
	|			(ВЫБРАТЬ
	|				КонтролируемыеКонтрагенты.Контрагент
	|			ИЗ
	|				КонтролируемыеКонтрагенты КАК КонтролируемыеКонтрагенты) 
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	РасчетныйДокумент,
	|	Покупатель
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	УслугиКомиссионера.Ссылка КАК РасчетныйДокумент,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыКонтролируемыхСделок.ПолученДоход) КАК ТипКонтролируемойСделки,
	|	УслугиКомиссионера.Номенклатура КАК ПредметСделки,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.РаботаУслуга) КАК ТипПредметаСделки,
	|	УслугиКомиссионера.Количество КАК Количество,
	|	УслугиКомиссионера.Номенклатура.ЕдиницаИзмерения КАК ЕдиницаИзмеренияПоКлассификатору,
	|	УслугиКомиссионера.СуммаСНДС - УслугиКомиссионера.СуммаНДС КАК СуммаБезНДС,
	|	УслугиКомиссионера.СтавкаНДС,
	|	УслугиКомиссионера.СуммаНДС КАК СуммаНДС,
	|	ЛОЖЬ КАК ОперацияОблагаетсяЕНВД,
	|	ЛОЖЬ КАК ТоварМировойБиржевойТорговли,
	|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперацииКонтролируемыхСделок.РеализацияСобственныхУслуг) КАК ХозяйственнаяОперация,
	|	ИСТИНА КАК ВключатьСоставСделок,
	|	ЗНАЧЕНИЕ(Справочник.СтраныМира.ПустаяСсылка) КАК СтранаПроисхождения,
	|	УслугиКомиссионера.ИдентификаторСтроки,
	|	УслугиКомиссионера.Покупатель КАК Контрагент,
	|	ДокументыКонтролируемыхСделок.Комиссионер КАК Комиссионер,
	|	ДокументыКонтролируемыхСделок.Период КАК Период,
	|	ДокументыКонтролируемыхСделок.Организация КАК Организация,
	|	ДокументыКонтролируемыхСделок.Валюта КАК Валюта
	|ПОМЕСТИТЬ ТоварыКонтролируемыхСделок
	|ИЗ
	|	Документ.ОтчетКомиссионера.Товары КАК УслугиКомиссионера
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ДокументыКонтролируемыхСделок КАК ДокументыКонтролируемыхСделок
	|		ПО УслугиКомиссионера.Ссылка = ДокументыКонтролируемыхСделок.РасчетныйДокумент
	|			И УслугиКомиссионера.Покупатель = ДокументыКонтролируемыхСделок.Покупатель
	|ГДЕ
	|	НЕ УслугиКомиссионера.Номенклатура.ТипНоменклатуры В (ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.Товар), ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.МногооборотнаяТара))
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ТоварыКомиссионера.Ссылка,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыКонтролируемыхСделок.ПолученДоход),
	|	Аналитика.Номенклатура,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.Товар),
	|	ТоварыКомиссионера.Количество,
	|	Аналитика.Номенклатура.ЕдиницаИзмерения,
	|	ТоварыКомиссионера.СуммаСНДС - ТоварыКомиссионера.СуммаНДС,
	|	ТоварыКомиссионера.СтавкаНДС,
	|	ТоварыКомиссионера.СуммаНДС,
	|	ЛОЖЬ,
	|	ВЫБОР
	|		КОГДА ТоварыМировойБиржевойТорговли.ПредметСделки ЕСТЬ NULL 
	|			ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА
	|	КОНЕЦ,
	|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперацииКонтролируемыхСделок.РеализацияСобственныхТоваров),
	|	ИСТИНА,
	|	ЕСТЬNULL(ТоварыКомиссионера.НомерГТД.СтранаПроисхождения, ЗНАЧЕНИЕ(Справочник.СтраныМира.Россия)),
	|	ТоварыКомиссионера.ИдентификаторСтроки,
	|	ТоварыКомиссионера.Покупатель,
	|	ДокументыКонтролируемыхСделок.Комиссионер КАК Комиссионер,
	|	ДокументыКонтролируемыхСделок.Период КАК Период,
	|	ДокументыКонтролируемыхСделок.Организация КАК Организация,
	|	ДокументыКонтролируемыхСделок.Валюта КАК Валюта
	|ИЗ
	|	Документ.ОтчетКомиссионера.ВидыЗапасов КАК ТоварыКомиссионера
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ДокументыКонтролируемыхСделок КАК ДокументыКонтролируемыхСделок
	|		ПО ТоварыКомиссионера.Ссылка = ДокументыКонтролируемыхСделок.РасчетныйДокумент
	|			И ТоварыКомиссионера.Покупатель = ДокументыКонтролируемыхСделок.Покупатель
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК Аналитика
	|		ПО ТоварыКомиссионера.АналитикаУчетаНоменклатуры = Аналитика.Ссылка
	|		ЛЕВОЕ СОЕДИНЕНИЕ ТоварыМировойБиржевойТорговли КАК ТоварыМировойБиржевойТорговли
	|		ПО Аналитика.Номенклатура = ТоварыМировойБиржевойТорговли.ПредметСделки
	|			И ТоварыМировойБиржевойТорговли.ДатаНачалаДействия <= ДокументыКонтролируемыхСделок.Период
	|			И ТоварыМировойБиржевойТорговли.ДатаОкончанияДействия >= ДокументыКонтролируемыхСделок.Период
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ТоварыКонтролируемыхСделок.РасчетныйДокумент КАК РасчетныйДокумент,
	|	ТоварыКонтролируемыхСделок.Период КАК Период,
	|	ТоварыКонтролируемыхСделок.Организация КАК Организация,
	|	ТоварыКонтролируемыхСделок.Контрагент КАК Контрагент,
	|	ТоварыКонтролируемыхСделок.Комиссионер КАК Комиссионер,
	|	ТоварыКонтролируемыхСделок.ПредметСделки,
	|	ТоварыКонтролируемыхСделок.ТипПредметаСделки,
	|	ТоварыКонтролируемыхСделок.ПредметСделки.НаименованиеПолное КАК НаименованиеПредметаСделки,
	|	ТоварыКонтролируемыхСделок.СтранаПроисхождения КАК СтранаПроисхожденияПредметаСделки,
	|	ТоварыКонтролируемыхСделок.ХозяйственнаяОперация,
	|	ТоварыКонтролируемыхСделок.Валюта КАК Валюта,
	|	ТоварыКонтролируемыхСделок.ЕдиницаИзмеренияПоКлассификатору КАК ЕдиницаИзмерения,
	|	ТоварыКонтролируемыхСделок.Количество,
	|	ТоварыКонтролируемыхСделок.СтавкаНДС,
	|	ТоварыКонтролируемыхСделок.СуммаБезНДС,
	|	ТоварыКонтролируемыхСделок.СуммаНДС,
	|	ТоварыКонтролируемыхСделок.ТипКонтролируемойСделки,
	|	ТоварыКонтролируемыхСделок.ТоварМировойБиржевойТорговли,
	|	ТоварыКонтролируемыхСделок.ОперацияОблагаетсяЕНВД,
	|	НЕОПРЕДЕЛЕНО КАК Договор,
	|	НЕОПРЕДЕЛЕНО КАК Соглашение,
	|	ТоварыКонтролируемыхСделок.ИдентификаторСтроки КАК ИдентификаторСтроки,
	|	ТоварыКонтролируемыхСделок.РасчетныйДокумент КАК РегистраторРегистраСумм,
	|	1 КАК МножительСуммовыхДанных,
	|	ТоварыКонтролируемыхСделок.Комиссионер КАК Грузоотправитель,
	|	ТоварыКонтролируемыхСделок.Контрагент КАК Грузополучатель
	|ПОМЕСТИТЬ ТаблицаСделок
	|ИЗ
	|	ТоварыКонтролируемыхСделок КАК ТоварыКонтролируемыхСделок
	|ГДЕ
	|	ТоварыКонтролируемыхСделок.ВключатьСоставСделок
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	РегистраторРегистраСумм,
	|	ИдентификаторСтроки";
	
	Запрос.Выполнить();
	
	ВыборкаСделокРеализации = ПолучитьВыборкуТаблицыСделокСПреобразованиемСуммКРублевым(Запрос.МенеджерВременныхТаблиц);
	
	Пока ВыборкаСделокРеализации.Следующий() Цикл
		СтрокаСделки = ТаблицаСделок.Добавить();
		ЗаполнитьЗначенияСвойств(СтрокаСделки, ВыборкаСделокРеализации);
	КонецЦикла;
	
	ЗапросУдаленияВременныхТаблиц = Новый Запрос();
	ЗапросУдаленияВременныхТаблиц.МенеджерВременныхТаблиц = Запрос.МенеджерВременныхТаблиц;
	ЗапросУдаленияВременныхТаблиц.Текст = 
	"УНИЧТОЖИТЬ ДокументыКонтролируемыхСделок
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ДокументыКонтролируемыхСделокБезПроверкиПоПокупателям
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ТоварыКонтролируемыхСделок
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ТаблицаСделок";
	
	ЗапросУдаленияВременныхТаблиц.Выполнить();
	
КонецПроцедуры

// Добавляет в список контролируемых сделок отчеты комиссионера о списании.
//
// Параметры:
//  СтруктураПараметров - Структура - параметры контролируемых сделок:
//  * ВалютаРегламентированногоУчета - СправочникСсылка.Валюты - валюта регламетированного учета.
//  * НачалоПериода                  - Дата - начало периода формирования списка контролируемых сделок.
//  * ОкончаниеПериода               - Дата - окончание периода формирования списка контролируемых сделок.
//  * Организация                    - СправочникСсылка.Организации - код места представления.
//  * СписокПодчиненныхОрганизаций   - СписокЗначений из СправочникСсылка.Организации - список подчиненных организаций.
//  МенеджерВременныхТаблиц          - МенеджерВременныхТаблиц - временные таблицы запроса по контролируемым сделкам.
//  ТаблицаСделок                    - ТаблицаЗначений - таблица значений с данными о контролируемых сделках.
//
Процедура ДобавитьСделкиОтчетаКомиссионераОСписании(СтруктураПараметров, МенеджерВременныхТаблиц, ТаблицаСделок)
	
	Запрос = ПодготовитьЗапросКДокументамИсточникам(СтруктураПараметров);
	Запрос.УстановитьПараметр("ИспользованиеСоглашений", ПолучитьФункциональнуюОпцию("ИспользоватьСоглашенияСКлиентами"));
	Запрос.УстановитьПараметр("ИспользованиеДоговоров", ПолучитьФункциональнуюОпцию("ИспользоватьДоговорыСКлиентами"));
	Запрос.МенеджерВременныхТаблиц = МенеджерВременныхТаблиц;
	Запрос.Текст =
	"ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	ОтчетКомиссионераОСписании.Ссылка КАК РасчетныйДокумент,
	|	ОтчетКомиссионераОСписании.Дата КАК Период,
	|	ОтчетКомиссионераОСписании.Организация КАК Организация,
	|	ОтчетКомиссионераОСписании.Контрагент КАК Контрагент,
	|	ОтчетКомиссионераОСписании.Валюта КАК Валюта,
	|	ВЫБОР
	|		КОГДА &ИспользованиеДоговоров
	|		ТОГДА ОтчетКомиссионераОСписании.Договор
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК Договор,
	|	ВЫБОР
	|		КОГДА &ИспользованиеСоглашений
	|		ТОГДА ОтчетКомиссионераОСписании.Соглашение
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК Соглашение,
	|	НЕ ВзаимозависимыеЛицаПоПериодам.Контрагент ЕСТЬ NULL КАК ВзаимозависимыеЛица,
	|	НЕ ИностранныеКонтрагенты.Контрагент ЕСТЬ NULL КАК ИностранныйКонтрагент,
	|	ЕСТЬNULL(ИностранныеКонтрагенты.ЗарегистрированВСтранеСЛьготнымНалогообложением, ЛОЖЬ) КАК ЗарегистрированВСтранеСЛьготнымНалогообложением
	|ПОМЕСТИТЬ ДокументыКонтролируемыхСделок
	|ИЗ
	|	Документ.ОтчетКомиссионераОСписании КАК ОтчетКомиссионераОСписании
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВзаимозависимыеЛицаПоПериодам КАК ВзаимозависимыеЛицаПоПериодам
	|		ПО (ВзаимозависимыеЛицаПоПериодам.Организация = &Организация)
	|			И (ВзаимозависимыеЛицаПоПериодам.Контрагент = ОтчетКомиссионераОСписании.Контрагент)
	|			И ОтчетКомиссионераОСписании.Дата >= ВзаимозависимыеЛицаПоПериодам.НачалоПериода
	|			И ОтчетКомиссионераОСписании.Дата <= ВзаимозависимыеЛицаПоПериодам.ОкончаниеПериода
	|		ЛЕВОЕ СОЕДИНЕНИЕ ИностранныеКонтрагенты КАК ИностранныеКонтрагенты
	|		ПО (ИностранныеКонтрагенты.Контрагент = ОтчетКомиссионераОСписании.Контрагент)
	|ГДЕ
	|	ОтчетКомиссионераОСписании.Организация В(&СтруктураОрганизации)
	|	И ОтчетКомиссионераОСписании.Дата >= &НачалоПериода
	|	И ОтчетКомиссионераОСписании.Дата <= &ОкончаниеПериода
	|	И ОтчетКомиссионераОСписании.Проведен = ИСТИНА
	|	И ОтчетКомиссионераОСписании.Контрагент В
	|			(ВЫБРАТЬ
	|				КонтролируемыеКонтрагенты.Контрагент
	|			ИЗ
	|				КонтролируемыеКонтрагенты КАК КонтролируемыеКонтрагенты)
	|	И (НЕ ВзаимозависимыеЛицаПоПериодам.Контрагент ЕСТЬ NULL 
	|			ИЛИ НЕ ИностранныеКонтрагенты.Контрагент ЕСТЬ NULL )
	|	И ВЫБОР
	|			КОГДА ОтчетКомиссионераОСписании.Договор = ЗНАЧЕНИЕ(Справочник.ДоговорыКонтрагентов.ПустаяСсылка)
	|				ТОГДА ИСТИНА
	|			ИНАЧЕ ОтчетКомиссионераОСписании.Договор.ТипДоговора = ЗНАЧЕНИЕ(Перечисление.ТипыДоговоров.СКомиссионером)
	|		КОНЕЦ
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	РасчетныйДокумент
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	ТоварыКомиссионера.Ссылка КАК РасчетныйДокумент,
	|	ДокументыКонтролируемыхСделок.Период КАК Период,
	|	ДокументыКонтролируемыхСделок.Организация КАК Организация,
	|	ДокументыКонтролируемыхСделок.Контрагент КАК Контрагент,
	|	ДокументыКонтролируемыхСделок.Валюта КАК Валюта,
	|	ДокументыКонтролируемыхСделок.Договор КАК Договор,
	|	ДокументыКонтролируемыхСделок.Соглашение КАК Соглашение,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыКонтролируемыхСделок.ОсуществленРасход) КАК ТипКонтролируемойСделки,
	|	Аналитика.Номенклатура КАК ПредметСделки,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.Товар) КАК ТипПредметаСделки,
	|	ТоварыКомиссионера.Количество КАК Количество,
	|	Аналитика.Номенклатура.ЕдиницаИзмерения КАК ЕдиницаИзмеренияПоКлассификатору,
	|	ТоварыКомиссионера.СуммаСНДС - ТоварыКомиссионера.СуммаНДС КАК СуммаБезНДС,
	|	ТоварыКомиссионера.СтавкаНДС,
	|	ТоварыКомиссионера.СуммаНДС КАК СуммаНДС,
	|	ВЫБОР
	|		КОГДА ТоварыКомиссионера.Ссылка.НалогообложениеНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаОблагаетсяЕНВД)
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ КАК ОперацияОблагаетсяЕНВД,
	|	ВЫБОР
	|		КОГДА ТоварыМировойБиржевойТорговли.ПредметСделки ЕСТЬ NULL 
	|			ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА
	|	КОНЕЦ КАК ТоварМировойБиржевойТорговли,
	|	ВЫБОР
	|		КОГДА ТоварыКомиссионера.ВидЗапасов.ТипЗапасов В (ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.ПустаяСсылка), ЗНАЧЕНИЕ(Перечисление.Типызапасов.Товар))
	|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперацииКонтролируемыхСделок.РеализацияСобственныхТоваров)
	|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперацииКонтролируемыхСделок.РеализацияКомиссионныхТоваров)
	|	КОНЕЦ КАК ХозяйственнаяОперация,
	|	ВЫБОР
	|		КОГДА ТоварыКомиссионера.ВидЗапасов.ТипЗапасов В (ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.ПустаяСсылка), ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.Товар))
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ КАК ВключатьСоставСделок,
	|	ЕСТЬNULL(ТоварыКомиссионера.НомерГТД.СтранаПроисхождения, ЗНАЧЕНИЕ(Справочник.СтраныМира.Россия)) КАК СтранаПроисхождения,
	|	ДокументыКонтролируемыхСделок.ИностранныйКонтрагент,
	|	ДокументыКонтролируемыхСделок.ЗарегистрированВСтранеСЛьготнымНалогообложением,
	|	ДокументыКонтролируемыхСделок.ВзаимозависимыеЛица,
	|	ТоварыКомиссионера.ИдентификаторСтроки
	|ПОМЕСТИТЬ ТоварыКонтролируемыхСделок
	|ИЗ
	|	Документ.ОтчетКомиссионераОСписании.ВидыЗапасов КАК ТоварыКомиссионера
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ДокументыКонтролируемыхСделок КАК ДокументыКонтролируемыхСделок
	|		ПО ТоварыКомиссионера.Ссылка = ДокументыКонтролируемыхСделок.РасчетныйДокумент
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК Аналитика
	|		ПО ТоварыКомиссионера.АналитикаУчетаНоменклатуры = Аналитика.Ссылка
	|		ЛЕВОЕ СОЕДИНЕНИЕ ТоварыМировойБиржевойТорговли КАК ТоварыМировойБиржевойТорговли
	|		ПО Аналитика.Номенклатура = ТоварыМировойБиржевойТорговли.ПредметСделки
	|			И ТоварыМировойБиржевойТорговли.ДатаНачалаДействия <= ДокументыКонтролируемыхСделок.Период
	|			И ТоварыМировойБиржевойТорговли.ДатаОкончанияДействия >= ДокументыКонтролируемыхСделок.Период
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ТоварыКонтролируемыхСделок.РасчетныйДокумент КАК РасчетныйДокумент,
	|	ТоварыКонтролируемыхСделок.Период КАК Период,
	|	ТоварыКонтролируемыхСделок.Организация КАК Организация,
	|	ТоварыКонтролируемыхСделок.Контрагент КАК Контрагент,
	|	ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка) КАК Комиссионер,
	|	ТоварыКонтролируемыхСделок.ПредметСделки,
	|	ТоварыКонтролируемыхСделок.ТипПредметаСделки,
	|	ТоварыКонтролируемыхСделок.ПредметСделки.НаименованиеПолное КАК НаименованиеПредметаСделки,
	|	ТоварыКонтролируемыхСделок.СтранаПроисхождения КАК СтранаПроисхожденияПредметаСделки,
	|	ТоварыКонтролируемыхСделок.ХозяйственнаяОперация,
	|	ТоварыКонтролируемыхСделок.Валюта КАК Валюта,
	|	ТоварыКонтролируемыхСделок.ЕдиницаИзмеренияПоКлассификатору КАК ЕдиницаИзмерения,
	|	ТоварыКонтролируемыхСделок.Количество,
	|	ТоварыКонтролируемыхСделок.СтавкаНДС,
	|	ТоварыКонтролируемыхСделок.СуммаБезНДС,
	|	ТоварыКонтролируемыхСделок.СуммаНДС,
	|	ТоварыКонтролируемыхСделок.ТипКонтролируемойСделки,
	|	ТоварыКонтролируемыхСделок.ТоварМировойБиржевойТорговли,
	|	ТоварыКонтролируемыхСделок.ОперацияОблагаетсяЕНВД,
	|	ТоварыКонтролируемыхСделок.Договор КАК Договор,
	|	ТоварыКонтролируемыхСделок.Соглашение КАК Соглашение,
	|	ТоварыКонтролируемыхСделок.ИдентификаторСтроки КАК ИдентификаторСтроки,
	|	ТоварыКонтролируемыхСделок.РасчетныйДокумент КАК РегистраторРегистраСумм,
	|	-1 КАК МножительСуммовыхДанных,
	|	ТоварыКонтролируемыхСделок.Организация КАК Грузоотправитель,
	|	ТоварыКонтролируемыхСделок.Контрагент КАК Грузополучатель
	|ПОМЕСТИТЬ ТаблицаСделок
	|ИЗ
	|	ТоварыКонтролируемыхСделок КАК ТоварыКонтролируемыхСделок
	|ГДЕ
	|	(ТоварыКонтролируемыхСделок.ТоварМировойБиржевойТорговли
	|				И ТоварыКонтролируемыхСделок.ИностранныйКонтрагент
	|			ИЛИ ТоварыКонтролируемыхСделок.ВзаимозависимыеЛица
	|			ИЛИ ТоварыКонтролируемыхСделок.ЗарегистрированВСтранеСЛьготнымНалогообложением)
	|	И ТоварыКонтролируемыхСделок.ВключатьСоставСделок
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	РегистраторРегистраСумм,
	|	ИдентификаторСтроки";
	
	Запрос.Выполнить();
	
	ВыборкаСделокРеализации = ПолучитьВыборкуТаблицыСделокСПреобразованиемСуммКРублевым(Запрос.МенеджерВременныхТаблиц);
	
	Пока ВыборкаСделокРеализации.Следующий() Цикл
		СтрокаСделки = ТаблицаСделок.Добавить();
		ЗаполнитьЗначенияСвойств(СтрокаСделки, ВыборкаСделокРеализации);
	КонецЦикла;
	
	ЗапросУдаленияВременныхТаблиц = Новый Запрос();
	ЗапросУдаленияВременныхТаблиц.МенеджерВременныхТаблиц = Запрос.МенеджерВременныхТаблиц;
	ЗапросУдаленияВременныхТаблиц.Текст = 
	"УНИЧТОЖИТЬ ДокументыКонтролируемыхСделок
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ТоварыКонтролируемыхСделок
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ТаблицаСделок";
	
	ЗапросУдаленияВременныхТаблиц.Выполнить();
	
КонецПроцедуры

#КонецОбласти

#Область ДобавлениеСделокИнтеркомпани

// Добавляет в список контролируемых сделок передачи товаров между организациями. Сценарий для организации отправителя.
//
// Параметры:
//  СтруктураПараметров - Структура - параметры контролируемых сделок:
//  * ВалютаРегламентированногоУчета - СправочникСсылка.Валюты - валюта регламетированного учета.
//  * НачалоПериода                  - Дата - начало периода формирования списка контролируемых сделок.
//  * ОкончаниеПериода               - Дата - окончание периода формирования списка контролируемых сделок.
//  * Организация                    - СправочникСсылка.Организации - код места представления.
//  * СписокПодчиненныхОрганизаций   - СписокЗначений из СправочникСсылка.Организации - список подчиненных организаций.
//  МенеджерВременныхТаблиц          - МенеджерВременныхТаблиц - временные таблицы запроса по контролируемым сделкам.
//  ТаблицаСделок                    - ТаблицаЗначений - таблица значений с данными о контролируемых сделках.
//
Процедура ДобавитьСделкиПередачиТоваровМеждуОрганизациями_ОрганизацияОтправитель(СтруктураПараметров, МенеджерВременныхТаблиц, ТаблицаСделок)
	
	Запрос = ПодготовитьЗапросКДокументамИсточникам(СтруктураПараметров);
	Запрос.УстановитьПараметр("ИспользованиеДоговоров", ПолучитьФункциональнуюОпцию("ИспользоватьДоговорыСПоставщиками"));
	Запрос.МенеджерВременныхТаблиц = МенеджерВременныхТаблиц;
	Запрос.Текст = 
	"ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	ПередачаТоваровМеждуОрганизациями.Ссылка КАК РасчетныйДокумент,
	|	ПередачаТоваровМеждуОрганизациями.Дата КАК Период,
	|	ПередачаТоваровМеждуОрганизациями.Организация КАК Организация,
	|	ПередачаТоваровМеждуОрганизациями.ОрганизацияПолучатель КАК Контрагент,
	|	ПередачаТоваровМеждуОрганизациями.Валюта КАК Валюта,
	|	ПередачаТоваровМеждуОрганизациями.Договор КАК Договор,
	|	ПередачаТоваровМеждуОрганизациями.НалогообложениеНДС КАК НалогообложениеНДС,
	|	ВЫБОР
	|		КОГДА ПередачаТоваровМеждуОрганизациями.Грузоотправитель = ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	|		ТОГДА ПередачаТоваровМеждуОрганизациями.Организация
	|		ИНАЧЕ ПередачаТоваровМеждуОрганизациями.Грузоотправитель
	|	КОНЕЦ КАК Грузоотправитель,
	|	ВЫБОР
	|		КОГДА ПередачаТоваровМеждуОрганизациями.Грузополучатель = ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	|		ТОГДА ПередачаТоваровМеждуОрганизациями.ОрганизацияПолучатель
	|		ИНАЧЕ ПередачаТоваровМеждуОрганизациями.Грузополучатель
	|	КОНЕЦ КАК Грузополучатель,
	|	ВЫБОР
	|		КОГДА ВзаимозависимыеЛицаПоПериодам.Контрагент ЕСТЬ NULL 
	|			ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА
	|	КОНЕЦ КАК ВзаимозависимыеЛица,
	|	ВЫБОР
	|		КОГДА ИностранныеОрганизации.Организация ЕСТЬ NULL 
	|			ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА
	|	КОНЕЦ КАК ИностраннаяОрганизация,
	|	ЕСТЬNULL(ИностранныеОрганизации.ЗарегистрированаВСтранеСЛьготнымНалогообложением, ЛОЖЬ) КАК ЗарегистрированаВСтранеСЛьготнымНалогообложением
	|ПОМЕСТИТЬ ДокументыКонтролируемыхСделок
	|ИЗ
	|	Документ.ПередачаТоваровМеждуОрганизациями КАК ПередачаТоваровМеждуОрганизациями
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВзаимозависимыеЛицаПоПериодам КАК ВзаимозависимыеЛицаПоПериодам
	|		ПО (ВзаимозависимыеЛицаПоПериодам.Организация = &Организация)
	|			И ПередачаТоваровМеждуОрганизациями.Дата >= ВзаимозависимыеЛицаПоПериодам.НачалоПериода
	|			И ПередачаТоваровМеждуОрганизациями.Дата <= ВзаимозависимыеЛицаПоПериодам.ОкончаниеПериода
	|			И (ВзаимозависимыеЛицаПоПериодам.Контрагент = ПередачаТоваровМеждуОрганизациями.ОрганизацияПолучатель)
	|		ЛЕВОЕ СОЕДИНЕНИЕ ИностранныеОрганизации КАК ИностранныеОрганизации
	|		ПО ПередачаТоваровМеждуОрганизациями.ОрганизацияПолучатель = ИностранныеОрганизации.Организация
	|ГДЕ
	|	ПередачаТоваровМеждуОрганизациями.Организация В(&СтруктураОрганизации)
	|	И ПередачаТоваровМеждуОрганизациями.Дата >= &НачалоПериода
	|	И ПередачаТоваровМеждуОрганизациями.Дата <= &ОкончаниеПериода
	|	И ПередачаТоваровМеждуОрганизациями.Проведен = ИСТИНА
	|	И ПередачаТоваровМеждуОрганизациями.ОрганизацияПолучатель В
	|			(ВЫБРАТЬ
	|				КонтролируемыеКонтрагенты.Контрагент
	|			ИЗ
	|				КонтролируемыеКонтрагенты КАК КонтролируемыеКонтрагенты)
	|	И ПередачаТоваровМеждуОрганизациями.ХозяйственнаяОперация <> ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РеализацияБезПереходаПраваСобственности)
	|	И (НЕ ВзаимозависимыеЛицаПоПериодам.Контрагент ЕСТЬ NULL 
	|			ИЛИ НЕ ИностранныеОрганизации.Организация ЕСТЬ NULL )
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	РасчетныйДокумент
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	ПередачаУслугМеждуОрганизациями.Ссылка КАК РасчетныйДокумент,
	|	ДокументыКонтролируемыхСделок.Период КАК Период,
	|	ДокументыКонтролируемыхСделок.Организация КАК Организация,
	|	ДокументыКонтролируемыхСделок.Контрагент КАК Контрагент,
	|	ДокументыКонтролируемыхСделок.Валюта КАК Валюта,
	|	ДокументыКонтролируемыхСделок.Договор КАК Договор,
	|	ДокументыКонтролируемыхСделок.Грузоотправитель КАК Грузоотправитель,
	|	ДокументыКонтролируемыхСделок.Грузополучатель КАК Грузополучатель,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыКонтролируемыхСделок.ПолученДоход) КАК ТипКонтролируемойСделки,
	|	ПередачаУслугМеждуОрганизациями.Номенклатура КАК ПредметСделки,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.РаботаУслуга) КАК ТипПредметаСделки,
	|	ПередачаУслугМеждуОрганизациями.Количество КАК Количество,
	|	ПередачаУслугМеждуОрганизациями.Номенклатура.ЕдиницаИзмерения КАК ЕдиницаИзмеренияПоКлассификатору,
	|	ПередачаУслугМеждуОрганизациями.СуммаСНДС - ПередачаУслугМеждуОрганизациями.СуммаНДС КАК СуммаБезНДС,
	|	ПередачаУслугМеждуОрганизациями.СтавкаНДС,
	|	ПередачаУслугМеждуОрганизациями.СуммаНДС КАК СуммаНДС,
	|	ДокументыКонтролируемыхСделок.НалогообложениеНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаОблагаетсяЕНВД) КАК ОперацияОблагаетсяЕНВД,
	|	ЛОЖЬ КАК ТоварМировойБиржевойТорговли,
	|	ВЫБОР
	|		КОГДА ЕСТЬNULL(ПередачаУслугМеждуОрганизациями.Характеристика.Принципал, ПередачаУслугМеждуОрганизациями.Номенклатура.Принципал) = НЕОПРЕДЕЛЕНО
	|			ИЛИ ЕСТЬNULL(ПередачаУслугМеждуОрганизациями.Характеристика.Принципал, ПередачаУслугМеждуОрганизациями.Номенклатура.Принципал) = ПередачаУслугМеждуОрганизациями.Ссылка.Организация
	|		ТОГДА ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперацииКонтролируемыхСделок.РеализацияСобственныхУслуг)
	|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперацииКонтролируемыхСделок.РеализацияКомиссионныхУслуг)
	|	КОНЕЦ КАК ХозяйственнаяОперация,
	|	ЕСТЬNULL(ПередачаУслугМеждуОрганизациями.Характеристика.Принципал, ПередачаУслугМеждуОрганизациями.Номенклатура.Принципал) = НЕОПРЕДЕЛЕНО
	|		ИЛИ ЕСТЬNULL(ПередачаУслугМеждуОрганизациями.Характеристика.Принципал, ПередачаУслугМеждуОрганизациями.Номенклатура.Принципал)
	|		= ДокументыКонтролируемыхСделок.Организация КАК ВключатьСоставСделок,
	|	ЗНАЧЕНИЕ(Справочник.СтраныМира.Пустаяссылка) КАК СтранаПроисхождения,
	|	ДокументыКонтролируемыхСделок.ВзаимозависимыеЛица,
	|	ПередачаУслугМеждуОрганизациями.ИдентификаторСтроки,
	|	ДокументыКонтролируемыхСделок.ИностраннаяОрганизация,
	|	ДокументыКонтролируемыхСделок.ЗарегистрированаВСтранеСЛьготнымНалогообложением
	|ПОМЕСТИТЬ ТоварыКонтролируемыхСделок
	|ИЗ
	|	Документ.ПередачаТоваровМеждуОрганизациями.Товары КАК ПередачаУслугМеждуОрганизациями
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ДокументыКонтролируемыхСделок КАК ДокументыКонтролируемыхСделок
	|		ПО ПередачаУслугМеждуОрганизациями.Ссылка = ДокументыКонтролируемыхСделок.РасчетныйДокумент
	|ГДЕ
	|	НЕ ПередачаУслугМеждуОрганизациями.Номенклатура.ТипНоменклатуры В (ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.Товар), ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.МногооборотнаяТара))
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ПередачаТоваровМеждуОрганизациями.Ссылка,
	|	ДокументыКонтролируемыхСделок.Период КАК Период,
	|	ДокументыКонтролируемыхСделок.Организация КАК Организация,
	|	ДокументыКонтролируемыхСделок.Контрагент КАК Контрагент,
	|	ДокументыКонтролируемыхСделок.Валюта КАК Валюта,
	|	ДокументыКонтролируемыхСделок.Договор КАК Договор,
	|	ДокументыКонтролируемыхСделок.Грузоотправитель КАК Грузоотправитель,
	|	ДокументыКонтролируемыхСделок.Грузополучатель КАК Грузополучатель,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыКонтролируемыхСделок.ПолученДоход),
	|	Аналитика.Номенклатура,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.Товар),
	|	СУММА(ПередачаТоваровМеждуОрганизациями.Количество),
	|	Аналитика.Номенклатура.ЕдиницаИзмерения,
	|	СУММА(ПередачаТоваровМеждуОрганизациями.СуммаСНДС - ПередачаТоваровМеждуОрганизациями.СуммаНДС),
	|	ПередачаТоваровМеждуОрганизациями.СтавкаНДС,
	|	СУММА(ПередачаТоваровМеждуОрганизациями.СуммаНДС),
	|	ДокументыКонтролируемыхСделок.НалогообложениеНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаОблагаетсяЕНВД),
	|	НЕ ТоварыМировойБиржевойТорговли.ПредметСделки ЕСТЬ NULL,
	|	ВЫБОР
	|		КОГДА ПередачаТоваровМеждуОрганизациями.ВидЗапасов.ТипЗапасов В (ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.ПустаяСсылка), ЗНАЧЕНИЕ(Перечисление.Типызапасов.Товар))
	|		ТОГДА ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперацииКонтролируемыхСделок.РеализацияСобственныхТоваров)
	|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперацииКонтролируемыхСделок.РеализацияКомиссионныхТоваров)
	|	КОНЕЦ,
	|	ПередачаТоваровМеждуОрганизациями.ВидЗапасов.ТипЗапасов В (ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.ПустаяСсылка), ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.Товар)),
	|	ЕСТЬNULL(ПередачаТоваровМеждуОрганизациями.НомерГТД.СтранаПроисхождения, ЗНАЧЕНИЕ(Справочник.СтраныМира.Россия)),
	|	ДокументыКонтролируемыхСделок.ВзаимозависимыеЛица,
	|	ПередачаТоваровМеждуОрганизациями.ИдентификаторСтроки,
	|	ДокументыКонтролируемыхСделок.ИностраннаяОрганизация,
	|	ДокументыКонтролируемыхСделок.ЗарегистрированаВСтранеСЛьготнымНалогообложением
	|ИЗ
	|	Документ.ПередачаТоваровМеждуОрганизациями.ВидыЗапасов КАК ПередачаТоваровМеждуОрганизациями
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ДокументыКонтролируемыхСделок КАК ДокументыКонтролируемыхСделок
	|		ПО ПередачаТоваровМеждуОрганизациями.Ссылка = ДокументыКонтролируемыхСделок.РасчетныйДокумент
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК Аналитика
	|		ПО ПередачаТоваровМеждуОрганизациями.АналитикаУчетаНоменклатуры = Аналитика.Ссылка
	|		ЛЕВОЕ СОЕДИНЕНИЕ ТоварыМировойБиржевойТорговли КАК ТоварыМировойБиржевойТорговли
	|		ПО Аналитика.Номенклатура = ТоварыМировойБиржевойТорговли.ПредметСделки
	|			И ТоварыМировойБиржевойТорговли.ДатаНачалаДействия <= ДокументыКонтролируемыхСделок.Период
	|			И ТоварыМировойБиржевойТорговли.ДатаОкончанияДействия >= ДокументыКонтролируемыхСделок.Период
	|
	|СГРУППИРОВАТЬ ПО
	|	ПередачаТоваровМеждуОрганизациями.Ссылка,
	|	ДокументыКонтролируемыхСделок.Период,
	|	ДокументыКонтролируемыхСделок.Организация,
	|	ДокументыКонтролируемыхСделок.Контрагент,
	|	ДокументыКонтролируемыхСделок.Валюта,
	|	ДокументыКонтролируемыхСделок.Договор,
	|	ДокументыКонтролируемыхСделок.Грузоотправитель,
	|	ДокументыКонтролируемыхСделок.Грузополучатель,
	|	Аналитика.Номенклатура,
	|	Аналитика.Номенклатура.ЕдиницаИзмерения,
	|	ПередачаТоваровМеждуОрганизациями.СтавкаНДС,
	|	НЕ ТоварыМировойБиржевойТорговли.ПредметСделки ЕСТЬ NULL,
	|	ПередачаТоваровМеждуОрганизациями.ИдентификаторСтроки,
	|	ДокументыКонтролируемыхСделок.ВзаимозависимыеЛица,
	|	ДокументыКонтролируемыхСделок.ИностраннаяОрганизация,
	|	ДокументыКонтролируемыхСделок.ЗарегистрированаВСтранеСЛьготнымНалогообложением,
	|	ДокументыКонтролируемыхСделок.НалогообложениеНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаОблагаетсяЕНВД),
	|	ВЫБОР
	|		КОГДА ПередачаТоваровМеждуОрганизациями.ВидЗапасов.ТипЗапасов В (ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.ПустаяСсылка), ЗНАЧЕНИЕ(Перечисление.Типызапасов.Товар))
	|		ТОГДА ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперацииКонтролируемыхСделок.РеализацияСобственныхТоваров)
	|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперацииКонтролируемыхСделок.РеализацияКомиссионныхТоваров)
	|	КОНЕЦ,
	|	ПередачаТоваровМеждуОрганизациями.ВидЗапасов.ТипЗапасов В (ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.ПустаяСсылка), ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.Товар)),
	|	ЕСТЬNULL(ПередачаТоваровМеждуОрганизациями.НомерГТД.СтранаПроисхождения, ЗНАЧЕНИЕ(Справочник.СтраныМира.Россия))
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ТоварыКонтролируемыхСделок.РасчетныйДокумент КАК РасчетныйДокумент,
	|	ТоварыКонтролируемыхСделок.Период КАК Период,
	|	ТоварыКонтролируемыхСделок.Организация КАК Организация,
	|	ТоварыКонтролируемыхСделок.Контрагент КАК Контрагент,
	|	ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка) КАК Комиссионер,
	|	ТоварыКонтролируемыхСделок.ПредметСделки,
	|	ТоварыКонтролируемыхСделок.ТипПредметаСделки,
	|	ТоварыКонтролируемыхСделок.ПредметСделки.НаименованиеПолное КАК НаименованиеПредметаСделки,
	|	ТоварыКонтролируемыхСделок.СтранаПроисхождения КАК СтранаПроисхожденияПредметаСделки,
	|	ТоварыКонтролируемыхСделок.ХозяйственнаяОперация,
	|	ТоварыКонтролируемыхСделок.Валюта КАК Валюта,
	|	ТоварыКонтролируемыхСделок.ЕдиницаИзмеренияПоКлассификатору КАК ЕдиницаИзмерения,
	|	ТоварыКонтролируемыхСделок.Количество,
	|	ТоварыКонтролируемыхСделок.СтавкаНДС,
	|	ТоварыКонтролируемыхСделок.СуммаБезНДС,
	|	ТоварыКонтролируемыхСделок.СуммаНДС,
	|	ТоварыКонтролируемыхСделок.ТипКонтролируемойСделки,
	|	ТоварыКонтролируемыхСделок.ТоварМировойБиржевойТорговли,
	|	ТоварыКонтролируемыхСделок.ОперацияОблагаетсяЕНВД,
	|	ВЫБОР
	|		КОГДА ТоварыКонтролируемыхСделок.ТипПредметаСделки = ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.Товар)
	|		ТОГДА ТоварыКонтролируемыхСделок.Грузоотправитель
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	|	КОНЕЦ КАК Грузоотправитель,
	|	ВЫБОР
	|		КОГДА ТоварыКонтролируемыхСделок.ТипПредметаСделки = ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.Товар)
	|		ТОГДА ТоварыКонтролируемыхСделок.Грузополучатель
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	|	КОНЕЦ КАК Грузополучатель,
	|	ТоварыКонтролируемыхСделок.ИдентификаторСтроки КАК ИдентификаторСтроки,
	|	ТоварыКонтролируемыхСделок.РасчетныйДокумент КАК РегистраторРегистраСумм,
	|	1 КАК МножительСуммовыхДанных,
	|	ТоварыКонтролируемыхСделок.Договор КАК Договор,
	|	НЕОПРЕДЕЛЕНО КАК Соглашение
	|ПОМЕСТИТЬ ТаблицаСделок
	|ИЗ
	|	ТоварыКонтролируемыхСделок КАК ТоварыКонтролируемыхСделок
	|ГДЕ
	|	ТоварыКонтролируемыхСделок.ВключатьСоставСделок
	|	И (ТоварыКонтролируемыхСделок.ТоварМировойБиржевойТорговли
	|				И ТоварыКонтролируемыхСделок.ИностраннаяОрганизация
	|			ИЛИ ТоварыКонтролируемыхСделок.ВзаимозависимыеЛица
	|			ИЛИ ТоварыКонтролируемыхСделок.ЗарегистрированаВСтранеСЛьготнымНалогообложением)
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	РегистраторРегистраСумм,
	|	ИдентификаторСтроки";
	
	Запрос.Выполнить();
	
	ВыборкаСделокРеализации = ПолучитьВыборкуТаблицыСделокСПреобразованиемСуммКРублевым(Запрос.МенеджерВременныхТаблиц);
	
	Пока ВыборкаСделокРеализации.Следующий() Цикл
		СтрокаСделки = ТаблицаСделок.Добавить();
		ЗаполнитьЗначенияСвойств(СтрокаСделки, ВыборкаСделокРеализации);
	КонецЦикла;
	
	ЗапросУдаленияВременныхТаблиц = Новый Запрос();
	ЗапросУдаленияВременныхТаблиц.МенеджерВременныхТаблиц = Запрос.МенеджерВременныхТаблиц;
	ЗапросУдаленияВременныхТаблиц.Текст = 
	"УНИЧТОЖИТЬ ДокументыКонтролируемыхСделок
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ТоварыКонтролируемыхСделок
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ТаблицаСделок";
	
	ЗапросУдаленияВременныхТаблиц.Выполнить();
	
КонецПроцедуры

// Добавляет в список контролируемых сделок передачи товаров между организациями. Сценарий для организации получателя.
//
// Параметры:
//  СтруктураПараметров - Структура - параметры контролируемых сделок:
//  * ВалютаРегламентированногоУчета - СправочникСсылка.Валюты - валюта регламетированного учета.
//  * НачалоПериода                  - Дата - начало периода формирования списка контролируемых сделок.
//  * ОкончаниеПериода               - Дата - окончание периода формирования списка контролируемых сделок.
//  * Организация                    - СправочникСсылка.Организации - код места представления.
//  * СписокПодчиненныхОрганизаций   - СписокЗначений из СправочникСсылка.Организации - список подчиненных организаций.
//  МенеджерВременныхТаблиц          - МенеджерВременныхТаблиц - временные таблицы запроса по контролируемым сделкам.
//  ТаблицаСделок                    - ТаблицаЗначений - таблица значений с данными о контролируемых сделках.
//
Процедура ДобавитьСделкиПередачиТоваровМеждуОрганизациями_ОрганизацияПолучатель(СтруктураПараметров, МенеджерВременныхТаблиц, ТаблицаСделок)
	
	Запрос = ПодготовитьЗапросКДокументамИсточникам(СтруктураПараметров);
	Запрос.УстановитьПараметр("ИспользованиеДоговоров", ПолучитьФункциональнуюОпцию("ИспользоватьДоговорыСПоставщиками"));
	Запрос.МенеджерВременныхТаблиц = МенеджерВременныхТаблиц;
	Запрос.Текст = 
	"ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	ПередачаТоваровМеждуОрганизациями.Ссылка КАК РасчетныйДокумент,
	|	ПередачаТоваровМеждуОрганизациями.Дата КАК Период,
	|	ПередачаТоваровМеждуОрганизациями.ОрганизацияПолучатель КАК Организация,
	|	ПередачаТоваровМеждуОрганизациями.Организация КАК Контрагент,
	|	ПередачаТоваровМеждуОрганизациями.Валюта КАК Валюта,
	|	ПередачаТоваровМеждуОрганизациями.Договор КАК Договор,
	|	ПередачаТоваровМеждуОрганизациями.НалогообложениеНДС КАК НалогообложениеНДС,
	|	ВЫБОР
	|		КОГДА ПередачаТоваровМеждуОрганизациями.Грузоотправитель = ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	|		ТОГДА ПередачаТоваровМеждуОрганизациями.Организация
	|		ИНАЧЕ ПередачаТоваровМеждуОрганизациями.Грузоотправитель
	|	КОНЕЦ КАК Грузоотправитель,
	|	ВЫБОР
	|		КОГДА ПередачаТоваровМеждуОрганизациями.Грузополучатель = ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	|		ТОГДА ПередачаТоваровМеждуОрганизациями.ОрганизацияПолучатель
	|		ИНАЧЕ ПередачаТоваровМеждуОрганизациями.Грузополучатель
	|	КОНЕЦ КАК Грузополучатель,
	|	ВЫБОР
	|		КОГДА ВзаимозависимыеЛицаПоПериодам.Контрагент ЕСТЬ NULL 
	|			ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА
	|	КОНЕЦ КАК ВзаимозависимыеЛица,
	|	ВЫБОР
	|		КОГДА ИностранныеОрганизации.Организация ЕСТЬ NULL 
	|			ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА
	|	КОНЕЦ КАК ИностраннаяОрганизация,
	|	ЕСТЬNULL(ИностранныеОрганизации.ЗарегистрированаВСтранеСЛьготнымНалогообложением, ЛОЖЬ) КАК ЗарегистрированаВСтранеСЛьготнымНалогообложением
	|ПОМЕСТИТЬ ДокументыКонтролируемыхСделок
	|ИЗ
	|	Документ.ПередачаТоваровМеждуОрганизациями КАК ПередачаТоваровМеждуОрганизациями
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВзаимозависимыеЛицаПоПериодам КАК ВзаимозависимыеЛицаПоПериодам
	|		ПО (ВзаимозависимыеЛицаПоПериодам.Организация = &Организация)
	|			И ПередачаТоваровМеждуОрганизациями.Дата >= ВзаимозависимыеЛицаПоПериодам.НачалоПериода
	|			И ПередачаТоваровМеждуОрганизациями.Дата <= ВзаимозависимыеЛицаПоПериодам.ОкончаниеПериода
	|			И (ВзаимозависимыеЛицаПоПериодам.Контрагент = ПередачаТоваровМеждуОрганизациями.Организация)
	|		ЛЕВОЕ СОЕДИНЕНИЕ ИностранныеОрганизации КАК ИностранныеОрганизации
	|		ПО ПередачаТоваровМеждуОрганизациями.Организация = ИностранныеОрганизации.Организация
	|ГДЕ
	|	ПередачаТоваровМеждуОрганизациями.ОрганизацияПолучатель В(&СтруктураОрганизации)
	|	И ПередачаТоваровМеждуОрганизациями.Дата >= &НачалоПериода
	|	И ПередачаТоваровМеждуОрганизациями.Дата <= &ОкончаниеПериода
	|	И ПередачаТоваровМеждуОрганизациями.Проведен = ИСТИНА
	|	И ПередачаТоваровМеждуОрганизациями.Организация В
	|			(ВЫБРАТЬ
	|				КонтролируемыеКонтрагенты.Контрагент
	|			ИЗ
	|				КонтролируемыеКонтрагенты КАК КонтролируемыеКонтрагенты)
	|	И ПередачаТоваровМеждуОрганизациями.ХозяйственнаяОперация <> ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РеализацияБезПереходаПраваСобственности)
	|	И (НЕ ВзаимозависимыеЛицаПоПериодам.Контрагент ЕСТЬ NULL 
	|			ИЛИ НЕ ИностранныеОрганизации.Организация ЕСТЬ NULL )
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	РасчетныйДокумент
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	УслугиПередачиМеждуОрганизациями.Ссылка КАК РасчетныйДокумент,
	|	ДокументыКонтролируемыхСделок.Период КАК Период,
	|	ДокументыКонтролируемыхСделок.Организация КАК Организация,
	|	ДокументыКонтролируемыхСделок.Контрагент КАК Контрагент,
	|	ДокументыКонтролируемыхСделок.Валюта КАК Валюта,
	|	ДокументыКонтролируемыхСделок.Договор КАК Договор,
	|	ДокументыКонтролируемыхСделок.Грузоотправитель КАК Грузоотправитель,
	|	ДокументыКонтролируемыхСделок.Грузополучатель КАК Грузополучатель,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыКонтролируемыхСделок.ОсуществленРасход) КАК ТипКонтролируемойСделки,
	|	УслугиПередачиМеждуОрганизациями.Номенклатура КАК ПредметСделки,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.РаботаУслуга) КАК ТипПредметаСделки,
	|	УслугиПередачиМеждуОрганизациями.Количество КАК Количество,
	|	УслугиПередачиМеждуОрганизациями.Номенклатура.ЕдиницаИзмерения КАК ЕдиницаИзмеренияПоКлассификатору,
	|	УслугиПередачиМеждуОрганизациями.СуммаСНДС - УслугиПередачиМеждуОрганизациями.СуммаНДС КАК СуммаБезНДС,
	|	УслугиПередачиМеждуОрганизациями.СтавкаНДС,
	|	УслугиПередачиМеждуОрганизациями.СуммаНДС КАК СуммаНДС,
	|	ДокументыКонтролируемыхСделок.НалогообложениеНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаОблагаетсяЕНВД) КАК ОперацияОблагаетсяЕНВД,
	|	ЛОЖЬ КАК ТоварМировойБиржевойТорговли,
	|	ВЫБОР
	|		КОГДА ЕСТЬNULL(УслугиПередачиМеждуОрганизациями.Характеристика.Принципал, УслугиПередачиМеждуОрганизациями.Номенклатура.Принципал) = НЕОПРЕДЕЛЕНО
	|			ИЛИ ЕСТЬNULL(УслугиПередачиМеждуОрганизациями.Характеристика.Принципал, УслугиПередачиМеждуОрганизациями.Номенклатура.Принципал) = ДокументыКонтролируемыхСделок.Контрагент
	|		ТОГДА ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперацииКонтролируемыхСделок.ПолучениеУслуг)
	|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперацииКонтролируемыхСделок.ПолучениеАгентскихУслуг)
	|	КОНЕЦ КАК ХозяйственнаяОперация,
	|	ИСТИНА КАК ВключатьСоставСделок,
	|	ЗНАЧЕНИЕ(Справочник.СтраныМира.Пустаяссылка) КАК СтранаПроисхождения,
	|	ДокументыКонтролируемыхСделок.ВзаимозависимыеЛица,
	|	УслугиПередачиМеждуОрганизациями.ИдентификаторСтроки,
	|	ДокументыКонтролируемыхСделок.ИностраннаяОрганизация,
	|	ДокументыКонтролируемыхСделок.ЗарегистрированаВСтранеСЛьготнымНалогообложением
	|ПОМЕСТИТЬ ТоварыКонтролируемыхСделок
	|ИЗ
	|	Документ.ПередачаТоваровМеждуОрганизациями.Товары КАК УслугиПередачиМеждуОрганизациями
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ДокументыКонтролируемыхСделок КАК ДокументыКонтролируемыхСделок
	|		ПО УслугиПередачиМеждуОрганизациями.Ссылка = ДокументыКонтролируемыхСделок.РасчетныйДокумент
	|ГДЕ
	|	НЕ УслугиПередачиМеждуОрганизациями.Номенклатура.ТипНоменклатуры В (ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.Товар), ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.МногооборотнаяТара))
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ПередачаТоваровМеждуОрганизациямиВидыЗапасов.Ссылка,
	|	ДокументыКонтролируемыхСделок.Период КАК Период,
	|	ДокументыКонтролируемыхСделок.Организация КАК Организация,
	|	ДокументыКонтролируемыхСделок.Контрагент КАК Контрагент,
	|	ДокументыКонтролируемыхСделок.Валюта КАК Валюта,
	|	ДокументыКонтролируемыхСделок.Договор КАК Договор,
	|	ДокументыКонтролируемыхСделок.Грузоотправитель КАК Грузоотправитель,
	|	ДокументыКонтролируемыхСделок.Грузополучатель КАК Грузополучатель,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыКонтролируемыхСделок.ОсуществленРасход),
	|	Аналитика.Номенклатура,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.Товар),
	|	СУММА(ПередачаТоваровМеждуОрганизациямиВидыЗапасов.Количество),
	|	Аналитика.Номенклатура.ЕдиницаИзмерения,
	|	СУММА(ПередачаТоваровМеждуОрганизациямиВидыЗапасов.СуммаСНДС - ПередачаТоваровМеждуОрганизациямиВидыЗапасов.СуммаНДС),
	|	ПередачаТоваровМеждуОрганизациямиВидыЗапасов.СтавкаНДС,
	|	СУММА(ПередачаТоваровМеждуОрганизациямиВидыЗапасов.СуммаНДС),
	|	ДокументыКонтролируемыхСделок.НалогообложениеНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаОблагаетсяЕНВД),
	|	НЕ ТоварыМировойБиржевойТорговли.ПредметСделки ЕСТЬ NULL,
	|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперацииКонтролируемыхСделок.ПриобретениеТоваров),
	|	ИСТИНА,
	|	ЕСТЬNULL(ПередачаТоваровМеждуОрганизациямиВидыЗапасов.НомерГТД.СтранаПроисхождения, ЗНАЧЕНИЕ(Справочник.СтраныМира.Россия)),
	|	ДокументыКонтролируемыхСделок.ВзаимозависимыеЛица,
	|	ПередачаТоваровМеждуОрганизациямиВидыЗапасов.ИдентификаторСтроки,
	|	ДокументыКонтролируемыхСделок.ИностраннаяОрганизация,
	|	ДокументыКонтролируемыхСделок.ЗарегистрированаВСтранеСЛьготнымНалогообложением
	|ИЗ
	|	Документ.ПередачаТоваровМеждуОрганизациями.ВидыЗапасов КАК ПередачаТоваровМеждуОрганизациямиВидыЗапасов
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ДокументыКонтролируемыхСделок КАК ДокументыКонтролируемыхСделок
	|		ПО ПередачаТоваровМеждуОрганизациямиВидыЗапасов.Ссылка = ДокументыКонтролируемыхСделок.РасчетныйДокумент
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК Аналитика
	|		ПО ПередачаТоваровМеждуОрганизациямиВидыЗапасов.АналитикаУчетаНоменклатуры = Аналитика.Ссылка
	|		ЛЕВОЕ СОЕДИНЕНИЕ ТоварыМировойБиржевойТорговли КАК ТоварыМировойБиржевойТорговли
	|		ПО Аналитика.Номенклатура = ТоварыМировойБиржевойТорговли.ПредметСделки
	|			И ТоварыМировойБиржевойТорговли.ДатаНачалаДействия <= ДокументыКонтролируемыхСделок.Период
	|			И ТоварыМировойБиржевойТорговли.ДатаОкончанияДействия >= ДокументыКонтролируемыхСделок.Период
	|
	|СГРУППИРОВАТЬ ПО
	|	ПередачаТоваровМеждуОрганизациямиВидыЗапасов.Ссылка,
	|	ДокументыКонтролируемыхСделок.Период,
	|	ДокументыКонтролируемыхСделок.Организация,
	|	ДокументыКонтролируемыхСделок.Контрагент,
	|	ДокументыКонтролируемыхСделок.Валюта,
	|	ДокументыКонтролируемыхСделок.Договор,
	|	ДокументыКонтролируемыхСделок.Грузоотправитель,
	|	ДокументыКонтролируемыхСделок.Грузополучатель,
	|	Аналитика.Номенклатура,
	|	Аналитика.Номенклатура.ЕдиницаИзмерения,
	|	ПередачаТоваровМеждуОрганизациямиВидыЗапасов.СтавкаНДС,
	|	НЕ ТоварыМировойБиржевойТорговли.ПредметСделки ЕСТЬ NULL,
	|	ПередачаТоваровМеждуОрганизациямиВидыЗапасов.ИдентификаторСтроки,
	|	ДокументыКонтролируемыхСделок.ВзаимозависимыеЛица,
	|	ДокументыКонтролируемыхСделок.ИностраннаяОрганизация,
	|	ДокументыКонтролируемыхСделок.ЗарегистрированаВСтранеСЛьготнымНалогообложением,
	|	ДокументыКонтролируемыхСделок.НалогообложениеНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаОблагаетсяЕНВД),
	|	ЕСТЬNULL(ПередачаТоваровМеждуОрганизациямиВидыЗапасов.НомерГТД.СтранаПроисхождения, ЗНАЧЕНИЕ(Справочник.СтраныМира.Россия))
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ТоварыКонтролируемыхСделок.РасчетныйДокумент КАК РасчетныйДокумент,
	|	ТоварыКонтролируемыхСделок.Период КАК Период,
	|	ТоварыКонтролируемыхСделок.Организация КАК Организация,
	|	ТоварыКонтролируемыхСделок.Контрагент КАК Контрагент,
	|	ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка) КАК Комиссионер,
	|	ТоварыКонтролируемыхСделок.ПредметСделки,
	|	ТоварыКонтролируемыхСделок.ТипПредметаСделки,
	|	ТоварыКонтролируемыхСделок.ПредметСделки.НаименованиеПолное КАК НаименованиеПредметаСделки,
	|	ТоварыКонтролируемыхСделок.СтранаПроисхождения КАК СтранаПроисхожденияПредметаСделки,
	|	ТоварыКонтролируемыхСделок.ХозяйственнаяОперация,
	|	ТоварыКонтролируемыхСделок.Валюта КАК Валюта,
	|	ТоварыКонтролируемыхСделок.ЕдиницаИзмеренияПоКлассификатору КАК ЕдиницаИзмерения,
	|	ТоварыКонтролируемыхСделок.Количество,
	|	ТоварыКонтролируемыхСделок.СтавкаНДС,
	|	ТоварыКонтролируемыхСделок.СуммаБезНДС,
	|	ТоварыКонтролируемыхСделок.СуммаНДС,
	|	ТоварыКонтролируемыхСделок.ТипКонтролируемойСделки,
	|	ТоварыКонтролируемыхСделок.ТоварМировойБиржевойТорговли,
	|	ТоварыКонтролируемыхСделок.ОперацияОблагаетсяЕНВД,
	|	ВЫБОР
	|		КОГДА ТоварыКонтролируемыхСделок.ТипПредметаСделки = ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.Товар)
	|		ТОГДА ТоварыКонтролируемыхСделок.Грузоотправитель
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	|	КОНЕЦ КАК Грузоотправитель,
	|	ВЫБОР
	|		КОГДА ТоварыКонтролируемыхСделок.ТипПредметаСделки = ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.Товар)
	|		ТОГДА ТоварыКонтролируемыхСделок.Грузополучатель
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	|	КОНЕЦ КАК Грузополучатель,
	|	ТоварыКонтролируемыхСделок.ИдентификаторСтроки КАК ИдентификаторСтроки,
	|	ТоварыКонтролируемыхСделок.РасчетныйДокумент КАК РегистраторРегистраСумм,
	|	1 КАК МножительСуммовыхДанных,
	|	ТоварыКонтролируемыхСделок.Договор КАК Договор,
	|	НЕОПРЕДЕЛЕНО КАК Соглашение
	|ПОМЕСТИТЬ ТаблицаСделок
	|ИЗ
	|	ТоварыКонтролируемыхСделок КАК ТоварыКонтролируемыхСделок
	|ГДЕ
	|	ТоварыКонтролируемыхСделок.ВключатьСоставСделок
	|	И (ТоварыКонтролируемыхСделок.ТоварМировойБиржевойТорговли
	|				И ТоварыКонтролируемыхСделок.ИностраннаяОрганизация
	|			ИЛИ ТоварыКонтролируемыхСделок.ВзаимозависимыеЛица
	|			ИЛИ ТоварыКонтролируемыхСделок.ЗарегистрированаВСтранеСЛьготнымНалогообложением)
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	РегистраторРегистраСумм,
	|	ИдентификаторСтроки";
	
	Запрос.Выполнить();
	
	ВыборкаСделокРеализации = ПолучитьВыборкуТаблицыСделокСПреобразованиемСуммКРублевым(Запрос.МенеджерВременныхТаблиц);
	
	Пока ВыборкаСделокРеализации.Следующий() Цикл
		СтрокаСделки = ТаблицаСделок.Добавить();
		ЗаполнитьЗначенияСвойств(СтрокаСделки, ВыборкаСделокРеализации);
	КонецЦикла;
	
	ЗапросУдаленияВременныхТаблиц = Новый Запрос();
	ЗапросУдаленияВременныхТаблиц.МенеджерВременныхТаблиц = Запрос.МенеджерВременныхТаблиц;
	ЗапросУдаленияВременныхТаблиц.Текст = 
	"УНИЧТОЖИТЬ ДокументыКонтролируемыхСделок
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ТоварыКонтролируемыхСделок
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ТаблицаСделок";
	
	ЗапросУдаленияВременныхТаблиц.Выполнить();
	
КонецПроцедуры

// Добавляет в список контролируемых сделок отчеты по комиссии между организациями.
//
// Параметры:
//  СтруктураПараметров - Структура - параметры контролируемых сделок:
//  * ВалютаРегламентированногоУчета - СправочникСсылка.Валюты - валюта регламетированного учета.
//  * НачалоПериода                  - Дата - начало периода формирования списка контролируемых сделок.
//  * ОкончаниеПериода               - Дата - окончание периода формирования списка контролируемых сделок.
//  * Организация                    - СправочникСсылка.Организации - код места представления.
//  * СписокПодчиненныхОрганизаций   - СписокЗначений из СправочникСсылка.Организации - список подчиненных организаций.
//  МенеджерВременныхТаблиц          - МенеджерВременныхТаблиц - временные таблицы запроса по контролируемым сделкам.
//  ТаблицаСделок                    - ТаблицаЗначений - таблица значений с данными о контролируемых сделках.
//
Процедура ДобавитьСделкиОтчетПоКомиссииМеждуОрганизациями(СтруктураПараметров, МенеджерВременныхТаблиц, ТаблицаСделок)
	
	Запрос = ПодготовитьЗапросКДокументамИсточникам(СтруктураПараметров);
	Запрос.УстановитьПараметр("ИспользованиеДоговоров", ПолучитьФункциональнуюОпцию("ИспользоватьДоговорыСПоставщиками"));
	Запрос.МенеджерВременныхТаблиц = МенеджерВременныхТаблиц;
	Запрос.Текст = 
	"ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	ОтчетПоКомиссииМеждуОрганизациями.Ссылка КАК РасчетныйДокумент,
	|	ОтчетПоКомиссииМеждуОрганизациями.Дата КАК Период,
	|	ОтчетПоКомиссииМеждуОрганизациями.Организация КАК Организация,
	|	ОтчетПоКомиссииМеждуОрганизациями.Валюта КАК Валюта,
	|	ОтчетПоКомиссииМеждуОрганизациями.Комиссионер КАК Грузоотправитель,
	|	ИСТИНА КАК ОрганизацияЯвляетсяКомитентом,
	|	ВЫБОР
	|		КОГДА ВзаимозависимыеЛицаПоПериодам.Контрагент ЕСТЬ NULL 
	|			ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА
	|	КОНЕЦ КАК ВзаимозависимыеЛица,
	|	ВЫБОР
	|		КОГДА ИностранныеОрганизации.Организация ЕСТЬ NULL 
	|			ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА
	|	КОНЕЦ КАК ИностраннаяОрганизация,
	|	ЕСТЬNULL(ИностранныеОрганизации.ЗарегистрированаВСтранеСЛьготнымНалогообложением, ЛОЖЬ) КАК ЗарегистрированаВСтранеСЛьготнымНалогообложением
	|ПОМЕСТИТЬ ДокументыКонтролируемыхСделок
	|ИЗ
	|	Документ.ОтчетПоКомиссииМеждуОрганизациями КАК ОтчетПоКомиссииМеждуОрганизациями
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВзаимозависимыеЛицаПоПериодам КАК ВзаимозависимыеЛицаПоПериодам
	|		ПО (ВзаимозависимыеЛицаПоПериодам.Организация = &Организация)
	|			И ОтчетПоКомиссииМеждуОрганизациями.Дата >= ВзаимозависимыеЛицаПоПериодам.НачалоПериода
	|			И ОтчетПоКомиссииМеждуОрганизациями.Дата <= ВзаимозависимыеЛицаПоПериодам.ОкончаниеПериода
	|			И ОтчетПоКомиссииМеждуОрганизациями.Комиссионер = ВзаимозависимыеЛицаПоПериодам.Контрагент
	|		ЛЕВОЕ СОЕДИНЕНИЕ ИностранныеОрганизации КАК ИностранныеОрганизации
	|		ПО ОтчетПоКомиссииМеждуОрганизациями.Комиссионер = ИностранныеОрганизации.Организация
	|ГДЕ
	|	ОтчетПоКомиссииМеждуОрганизациями.Организация В(&СтруктураОрганизации)
	|	И ОтчетПоКомиссииМеждуОрганизациями.Дата >= &НачалоПериода
	|	И ОтчетПоКомиссииМеждуОрганизациями.Дата <= &ОкончаниеПериода
	|	И ОтчетПоКомиссииМеждуОрганизациями.Проведен
	|	И ОтчетПоКомиссииМеждуОрганизациями.Комиссионер В
	|			(ВЫБРАТЬ
	|				КонтролируемыеКонтрагенты.Контрагент
	|			ИЗ
	|				КонтролируемыеКонтрагенты КАК КонтролируемыеКонтрагенты)
	|	И (НЕ ВзаимозависимыеЛицаПоПериодам.Контрагент ЕСТЬ NULL 
	|			ИЛИ НЕ ИностранныеОрганизации.Организация ЕСТЬ NULL )
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ОтчетПоКомиссииМеждуОрганизациями.Ссылка,
	|	ОтчетПоКомиссииМеждуОрганизациями.Дата КАК Период,
	|	ОтчетПоКомиссииМеждуОрганизациями.Комиссионер КАК Организация,
	|	ОтчетПоКомиссииМеждуОрганизациями.Валюта КАК Валюта,
	|	ОтчетПоКомиссииМеждуОрганизациями.Комиссионер КАК Грузоотправитель,
	|	ЛОЖЬ,
	|	ВЫБОР
	|		КОГДА ВзаимозависимыеЛицаПоПериодам.Контрагент ЕСТЬ NULL 
	|			ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА ИностранныеОрганизации.Организация ЕСТЬ NULL 
	|			ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА
	|	КОНЕЦ,
	|	ЕСТЬNULL(ИностранныеОрганизации.ЗарегистрированаВСтранеСЛьготнымНалогообложением, ЛОЖЬ)
	|ИЗ
	|	Документ.ОтчетПоКомиссииМеждуОрганизациями КАК ОтчетПоКомиссииМеждуОрганизациями
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВзаимозависимыеЛицаПоПериодам КАК ВзаимозависимыеЛицаПоПериодам
	|		ПО (ВзаимозависимыеЛицаПоПериодам.Организация = &Организация)
	|			И ОтчетПоКомиссииМеждуОрганизациями.Дата >= ВзаимозависимыеЛицаПоПериодам.НачалоПериода
	|			И ОтчетПоКомиссииМеждуОрганизациями.Дата <= ВзаимозависимыеЛицаПоПериодам.ОкончаниеПериода
	|			И ОтчетПоКомиссииМеждуОрганизациями.Организация = ВзаимозависимыеЛицаПоПериодам.Контрагент
	|		ЛЕВОЕ СОЕДИНЕНИЕ ИностранныеОрганизации КАК ИностранныеОрганизации
	|		ПО ОтчетПоКомиссииМеждуОрганизациями.Организация = ИностранныеОрганизации.Организация
	|ГДЕ
	|	ОтчетПоКомиссииМеждуОрганизациями.Комиссионер В(&СтруктураОрганизации)
	|	И ОтчетПоКомиссииМеждуОрганизациями.Дата >= &НачалоПериода
	|	И ОтчетПоКомиссииМеждуОрганизациями.Дата <= &ОкончаниеПериода
	|	И ОтчетПоКомиссииМеждуОрганизациями.Проведен
	|	И ОтчетПоКомиссииМеждуОрганизациями.Организация В
	|			(ВЫБРАТЬ
	|				КонтролируемыеКонтрагенты.Контрагент
	|			ИЗ
	|				КонтролируемыеКонтрагенты КАК КонтролируемыеКонтрагенты)
	|	И (НЕ ВзаимозависимыеЛицаПоПериодам.Контрагент ЕСТЬ NULL 
	|			ИЛИ НЕ ИностранныеОрганизации.Организация ЕСТЬ NULL )
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	РасчетныйДокумент
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	ОтчетПоКомиссииМеждуОрганизациямиТовары.Ссылка КАК РасчетныйДокумент,
	|	ДокументыКонтролируемыхСделок.Период КАК Период,
	|	ДокументыКонтролируемыхСделок.Организация КАК Организация,
	|	ДокументыКонтролируемыхСделок.Валюта КАК Валюта,
	|	ДокументыКонтролируемыхСделок.Грузоотправитель КАК Грузоотправитель,
	|	НЕ ВзаимозависимыеЛицаПоПериодам.Контрагент ЕСТЬ NULL КАК ВзаимозависимыеЛица,
	|	ОтчетПоКомиссииМеждуОрганизациямиТовары.Покупатель КАК Покупатель
	|ПОМЕСТИТЬ ДокументыКонтролируемыхСделокПокупатели
	|ИЗ
	|	Документ.ОтчетПоКомиссииМеждуОрганизациями.Товары КАК ОтчетПоКомиссииМеждуОрганизациямиТовары
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВзаимозависимыеЛицаПоПериодам КАК ВзаимозависимыеЛицаПоПериодам
	|		ПО (ВзаимозависимыеЛицаПоПериодам.Организация = &Организация)
	|			И ОтчетПоКомиссииМеждуОрганизациямиТовары.Ссылка.Дата >= ВзаимозависимыеЛицаПоПериодам.НачалоПериода
	|			И ОтчетПоКомиссииМеждуОрганизациямиТовары.Ссылка.Дата <= ВзаимозависимыеЛицаПоПериодам.ОкончаниеПериода
	|			И ОтчетПоКомиссииМеждуОрганизациямиТовары.Покупатель = ВзаимозависимыеЛицаПоПериодам.Контрагент
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ДокументыКонтролируемыхСделок КАК ДокументыКонтролируемыхСделок
	|		ПО ОтчетПоКомиссииМеждуОрганизациямиТовары.Ссылка = ДокументыКонтролируемыхСделок.РасчетныйДокумент
	|			И (ДокументыКонтролируемыхСделок.ОрганизацияЯвляетсяКомитентом)
	|ГДЕ
	|	НЕ ВзаимозависимыеЛицаПоПериодам.Контрагент ЕСТЬ NULL
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	РасчетныйДокумент,
	|	Покупатель
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	ОтчетПоКомиссииМеждуОрганизациями.Ссылка КАК РасчетныйДокумент,
	|	ДокументыКонтролируемыхСделок.Период КАК Период,
	|	ДокументыКонтролируемыхСделок.Организация КАК Организация,
	|	ДокументыКонтролируемыхСделок.Валюта КАК Валюта,
	|	ДокументыКонтролируемыхСделок.Грузоотправитель КАК Грузоотправитель,
	|	ВЫБОР
	|		КОГДА ДокументыКонтролируемыхСделок.ОрганизацияЯвляетсяКомитентом
	|		ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыКонтролируемыхСделок.ОсуществленРасход)
	|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.ТипыКонтролируемыхСделок.ПолученДоход)
	|	КОНЕЦ КАК ТипКонтролируемойСделки,
	|	ОтчетПоКомиссииМеждуОрганизациями.Услуга КАК ПредметСделки,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.РаботаУслуга) КАК ТипПредметаСделки,
	|	1 КАК Количество,
	|	ОтчетПоКомиссииМеждуОрганизациями.Услуга.ЕдиницаИзмерения КАК ЕдиницаИзмеренияПоКлассификатору,
	|	ОтчетПоКомиссииМеждуОрганизациями.СтавкаНДСВознаграждения КАК СтавкаНДС,
	|	ОтчетПоКомиссииМеждуОрганизациями.СуммаВознаграждения - ОтчетПоКомиссииМеждуОрганизациями.СуммаНДСВознаграждения КАК СуммаБезНДС,
	|	ОтчетПоКомиссииМеждуОрганизациями.СуммаНДСВознаграждения КАК СуммаНДС,
	|	ОтчетПоКомиссииМеждуОрганизациями.НалогообложениеНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаОблагаетсяЕНВД) КАК ОперацияОблагаетсяЕНВД,
	|	ЛОЖЬ КАК ТоварМировойБиржевойТорговли,
	|	ВЫБОР
	|		КОГДА ДокументыКонтролируемыхСделок.ОрганизацияЯвляетсяКомитентом
	|		ТОГДА ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперацииКонтролируемыхСделок.ПолучениеУслуг)
	|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперацииКонтролируемыхСделок.РеализацияСобственныхУслуг)
	|	КОНЕЦ КАК ХозяйственнаяОперация,
	|	ИСТИНА КАК ВключатьСоставСделок,
	|	ЗНАЧЕНИЕ(Справочник.СтраныМира.ПустаяСсылка) КАК СтранаПроисхождения,
	|	ДокументыКонтролируемыхСделок.ВзаимозависимыеЛица,
	|	ДокументыКонтролируемыхСделок.ИностраннаяОрганизация,
	|	ДокументыКонтролируемыхСделок.ЗарегистрированаВСтранеСЛьготнымНалогообложением,
	|	"""" КАК ИдентификаторСтроки,
	|	ДокументыКонтролируемыхСделок.ОрганизацияЯвляетсяКомитентом,
	|	ВЫБОР
	|		КОГДА ДокументыКонтролируемыхСделок.ОрганизацияЯвляетсяКомитентом
	|		ТОГДА ОтчетПоКомиссииМеждуОрганизациями.Комиссионер
	|		ИНАЧЕ ОтчетПоКомиссииМеждуОрганизациями.Организация
	|	КОНЕЦ КАК Контрагент
	|ПОМЕСТИТЬ ТоварыКонтролируемыхСделок
	|ИЗ
	|	ДокументыКонтролируемыхСделок КАК ДокументыКонтролируемыхСделок
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ОтчетПоКомиссииМеждуОрганизациями КАК ОтчетПоКомиссииМеждуОрганизациями
	|		ПО ДокументыКонтролируемыхСделок.РасчетныйДокумент = ОтчетПоКомиссииМеждуОрганизациями.Ссылка
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ПередачаУслугКомитентаЗависимымЛицам.Ссылка,
	|	ДокументыКонтролируемыхСделокПокупатели.Период КАК Период,
	|	ДокументыКонтролируемыхСделокПокупатели.Организация КАК Организация,
	|	ДокументыКонтролируемыхСделокПокупатели.Валюта КАК Валюта,
	|	ДокументыКонтролируемыхСделокПокупатели.Грузоотправитель КАК Грузоотправитель,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыКонтролируемыхСделок.ПолученДоход),
	|	ПередачаУслугКомитентаЗависимымЛицам.Номенклатура,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.РаботаУслуга),
	|	ПередачаУслугКомитентаЗависимымЛицам.Количество,
	|	ПередачаУслугКомитентаЗависимымЛицам.Номенклатура.ЕдиницаИзмерения,
	|	ПередачаУслугКомитентаЗависимымЛицам.СтавкаНДС,
	|	ПередачаУслугКомитентаЗависимымЛицам.СуммаСНДС - ПередачаУслугКомитентаЗависимымЛицам.СуммаНДС,
	|	ПередачаУслугКомитентаЗависимымЛицам.СуммаНДС,
	|	ЛОЖЬ,
	|	ЛОЖЬ,
	|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперацииКонтролируемыхСделок.РеализацияСобственныхУслуг),
	|	ИСТИНА,
	|	ЗНАЧЕНИЕ(Справочник.СтраныМира.ПустаяСсылка),
	|	ДокументыКонтролируемыхСделокПокупатели.ВзаимозависимыеЛица,
	|	ЛОЖЬ,
	|	ЛОЖЬ,
	|	"""",
	|	ИСТИНА,
	|	ПередачаУслугКомитентаЗависимымЛицам.Покупатель
	|ИЗ
	|	Документ.ОтчетПоКомиссииМеждуОрганизациями.Товары КАК ПередачаУслугКомитентаЗависимымЛицам
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ДокументыКонтролируемыхСделокПокупатели КАК ДокументыКонтролируемыхСделокПокупатели
	|		ПО ПередачаУслугКомитентаЗависимымЛицам.Ссылка = ДокументыКонтролируемыхСделокПокупатели.РасчетныйДокумент
	|			И ПередачаУслугКомитентаЗависимымЛицам.Покупатель = ДокументыКонтролируемыхСделокПокупатели.Покупатель
	|ГДЕ
	|	НЕ ПередачаУслугКомитентаЗависимымЛицам.Номенклатура.ТипНоменклатуры В (ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.Товар), ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.МногооборотнаяТара))
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ПередачаТоваровКомитентаЗависимымЛицам.Ссылка,
	|	ДокументыКонтролируемыхСделокПокупатели.Период КАК Период,
	|	ДокументыКонтролируемыхСделокПокупатели.Организация КАК Организация,
	|	ДокументыКонтролируемыхСделокПокупатели.Валюта КАК Валюта,
	|	ДокументыКонтролируемыхСделокПокупатели.Грузоотправитель КАК Грузоотправитель,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыКонтролируемыхСделок.ПолученДоход),
	|	Аналитика.Номенклатура,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.Товар),
	|	ПередачаТоваровКомитентаЗависимымЛицам.Количество,
	|	Аналитика.Номенклатура.ЕдиницаИзмерения,
	|	ПередачаТоваровКомитентаЗависимымЛицам.СтавкаНДС,
	|	ПередачаТоваровКомитентаЗависимымЛицам.СуммаСНДС - ПередачаТоваровКомитентаЗависимымЛицам.СуммаНДС,
	|	ПередачаТоваровКомитентаЗависимымЛицам.СуммаНДС,
	|	ЛОЖЬ,
	|	НЕ ТоварыМировойБиржевойТорговли.ПредметСделки ЕСТЬ NULL,
	|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперацииКонтролируемыхСделок.РеализацияСобственныхТоваров),
	|	ИСТИНА,
	|	ЕСТЬNULL(ПередачаТоваровКомитентаЗависимымЛицам.НомерГТД.СтранаПроисхождения, ЗНАЧЕНИЕ(Справочник.СтраныМира.Россия)),
	|	ДокументыКонтролируемыхСделокПокупатели.ВзаимозависимыеЛица,
	|	ЛОЖЬ,
	|	ЛОЖЬ,
	|	ПередачаТоваровКомитентаЗависимымЛицам.ИдентификаторСтроки,
	|	ИСТИНА,
	|	ПередачаТоваровКомитентаЗависимымЛицам.Покупатель
	|ИЗ
	|	Документ.ОтчетПоКомиссииМеждуОрганизациями.ВидыЗапасов КАК ПередачаТоваровКомитентаЗависимымЛицам
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ДокументыКонтролируемыхСделокПокупатели КАК ДокументыКонтролируемыхСделокПокупатели
	|		ПО ПередачаТоваровКомитентаЗависимымЛицам.Ссылка = ДокументыКонтролируемыхСделокПокупатели.РасчетныйДокумент
	|			И ПередачаТоваровКомитентаЗависимымЛицам.Покупатель = ДокументыКонтролируемыхСделокПокупатели.Покупатель
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК Аналитика
	|		ПО ПередачаТоваровКомитентаЗависимымЛицам.АналитикаУчетаНоменклатуры = Аналитика.Ссылка
	|		ЛЕВОЕ СОЕДИНЕНИЕ ТоварыМировойБиржевойТорговли КАК ТоварыМировойБиржевойТорговли
	|		ПО Аналитика.Номенклатура = ТоварыМировойБиржевойТорговли.ПредметСделки
	|			И ТоварыМировойБиржевойТорговли.ДатаНачалаДействия <= ДокументыКонтролируемыхСделокПокупатели.Период
	|			И ТоварыМировойБиржевойТорговли.ДатаОкончанияДействия >= ДокументыКонтролируемыхСделокПокупатели.Период
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ТоварыКонтролируемыхСделок.РасчетныйДокумент,
	|	ТоварыКонтролируемыхСделок.Период КАК Период,
	|	ТоварыКонтролируемыхСделок.Организация КАК Организация,
	|	ТоварыКонтролируемыхСделок.Контрагент,
	|	ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка) КАК Комиссионер,
	|	ТоварыКонтролируемыхСделок.ПредметСделки,
	|	ТоварыКонтролируемыхСделок.ТипПредметаСделки,
	|	ТоварыКонтролируемыхСделок.ПредметСделки.НаименованиеПолное КАК НаименованиеПредметаСделки,
	|	ТоварыКонтролируемыхСделок.СтранаПроисхождения КАК СтранаПроисхожденияПредметаСделки,
	|	ТоварыКонтролируемыхСделок.ХозяйственнаяОперация,
	|	ТоварыКонтролируемыхСделок.Валюта КАК Валюта,
	|	ТоварыКонтролируемыхСделок.ЕдиницаИзмеренияПоКлассификатору КАК ЕдиницаИзмерения,
	|	ТоварыКонтролируемыхСделок.Количество,
	|	ТоварыКонтролируемыхСделок.СтавкаНДС,
	|	ТоварыКонтролируемыхСделок.СуммаБезНДС,
	|	ТоварыКонтролируемыхСделок.СуммаНДС,
	|	ТоварыКонтролируемыхСделок.ТипКонтролируемойСделки,
	|	ТоварыКонтролируемыхСделок.ТоварМировойБиржевойТорговли,
	|	ТоварыКонтролируемыхСделок.ОперацияОблагаетсяЕНВД,
	|	ВЫБОР
	|		КОГДА ТоварыКонтролируемыхСделок.ТипПредметаСделки = ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.Товар)
	|		ТОГДА ТоварыКонтролируемыхСделок.Грузоотправитель
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	|	КОНЕЦ КАК Грузоотправитель,
	|	ВЫБОР
	|		КОГДА ТоварыКонтролируемыхСделок.ТипПредметаСделки = ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.Товар)
	|		ТОГДА ТоварыКонтролируемыхСделок.Контрагент
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	|	КОНЕЦ КАК Грузополучатель,
	|	ТоварыКонтролируемыхСделок.ИдентификаторСтроки,
	|	ТоварыКонтролируемыхСделок.РасчетныйДокумент КАК РегистраторРегистраСумм,
	|	1 КАК МножительСуммовыхДанных,
	|	НЕОПРЕДЕЛЕНО КАК Договор,
	|	НЕОПРЕДЕЛЕНО КАК Соглашение
	|ПОМЕСТИТЬ ТаблицаСделок
	|ИЗ
	|	ТоварыКонтролируемыхСделок КАК ТоварыКонтролируемыхСделок
	|ГДЕ
	|	ТоварыКонтролируемыхСделок.ВключатьСоставСделок
	|	И (ТоварыКонтролируемыхСделок.ТоварМировойБиржевойТорговли
	|				И ТоварыКонтролируемыхСделок.ИностраннаяОрганизация
	|			ИЛИ ТоварыКонтролируемыхСделок.ВзаимозависимыеЛица
	|			ИЛИ ТоварыКонтролируемыхСделок.ЗарегистрированаВСтранеСЛьготнымНалогообложением)";
	
	Запрос.Выполнить();
	
	ВыборкаСделокРеализации = ПолучитьВыборкуТаблицыСделокСПреобразованиемСуммКРублевым(Запрос.МенеджерВременныхТаблиц);
	
	Пока ВыборкаСделокРеализации.Следующий() Цикл
		СтрокаСделки = ТаблицаСделок.Добавить();
		ЗаполнитьЗначенияСвойств(СтрокаСделки, ВыборкаСделокРеализации);
	КонецЦикла;
	
	ЗапросУдаленияВременныхТаблиц = Новый Запрос();
	ЗапросУдаленияВременныхТаблиц.МенеджерВременныхТаблиц = Запрос.МенеджерВременныхТаблиц;
	ЗапросУдаленияВременныхТаблиц.Текст = 
	"УНИЧТОЖИТЬ ДокументыКонтролируемыхСделок
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ДокументыКонтролируемыхСделокПокупатели
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ТоварыКонтролируемыхСделок
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ТаблицаСделок";
	
	ЗапросУдаленияВременныхТаблиц.Выполнить();
	
КонецПроцедуры

// Добавляет в список контролируемых сделок возвраты товаров между организациями.
//
// Параметры:
//  СтруктураПараметров - Структура - параметры контролируемых сделок:
//  * ВалютаРегламентированногоУчета - СправочникСсылка.Валюты - валюта регламетированного учета.
//  * НачалоПериода                  - Дата - начало периода формирования списка контролируемых сделок.
//  * ОкончаниеПериода               - Дата - окончание периода формирования списка контролируемых сделок.
//  * Организация                    - СправочникСсылка.Организации - код места представления.
//  * СписокПодчиненныхОрганизаций   - СписокЗначений из СправочникСсылка.Организации - список подчиненных организаций.
//  МенеджерВременныхТаблиц          - МенеджерВременныхТаблиц - временные таблицы запроса по контролируемым сделкам.
//  ТаблицаСделок                    - ТаблицаЗначений - таблица значений с данными о контролируемых сделках.
//
Процедура ДобавитьСделкиВозвратаТоваровМеждуОрганизациями(СтруктураПараметров, МенеджерВременныхТаблиц, ТаблицаСделок)
	
	Запрос = ПодготовитьЗапросКДокументамИсточникам(СтруктураПараметров);
	Запрос.УстановитьПараметр("ИспользованиеДоговоров", ПолучитьФункциональнуюОпцию("ИспользоватьДоговорыСПоставщиками"));
	Запрос.МенеджерВременныхТаблиц = МенеджерВременныхТаблиц;
	Запрос.Текст = 
	"ВЫБРАТЬ РАЗЛИЧНЫЕ РАЗРЕШЕННЫЕ
	|	ВозвратТоваровМеждуОрганизациями.Ссылка КАК ДокументВозврата,
	|	ЛОЖЬ КАК ОрганизацияПринимаетВозврат,
	|	ВЫБОР
	|		КОГДА ВзаимозависимыеЛицаПоПериодам.Контрагент ЕСТЬ NULL 
	|			ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА
	|	КОНЕЦ КАК ВзаимозависимыеЛица,
	|	ВЫБОР
	|		КОГДА ИностранныеОрганизации.Организация ЕСТЬ NULL 
	|			ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА
	|	КОНЕЦ КАК ИностраннаяОрганизация,
	|	ЕСТЬNULL(ИностранныеОрганизации.ЗарегистрированаВСтранеСЛьготнымНалогообложением, ЛОЖЬ) КАК ЗарегистрированаВСтранеСЛьготнымНалогообложением,
	|	ПередачаТоваровМеждуОрганизациями.Ссылка КАК РасчетныйДокумент,
	|	ПередачаТоваровМеждуОрганизациями.Дата КАК Период,
	|	ПередачаТоваровМеждуОрганизациями.ОрганизацияПолучатель КАК Организация,
	|	ПередачаТоваровМеждуОрганизациями.Организация КАК Контрагент,
	|	ПередачаТоваровМеждуОрганизациями.Валюта КАК Валюта,
	|	ПередачаТоваровМеждуОрганизациями.Договор КАК Договор,
	|	ВЫБОР
	|		КОГДА ПередачаТоваровМеждуОрганизациями.Грузоотправитель = ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	|		ТОГДА ПередачаТоваровМеждуОрганизациями.ОрганизацияПолучатель
	|		ИНАЧЕ ПередачаТоваровМеждуОрганизациями.Грузоотправитель
	|	КОНЕЦ КАК Грузоотправитель,
	|	ВЫБОР
	|		КОГДА ПередачаТоваровМеждуОрганизациями.Грузополучатель = ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	|		ТОГДА ПередачаТоваровМеждуОрганизациями.Организация
	|		ИНАЧЕ ПередачаТоваровМеждуОрганизациями.Грузополучатель
	|	КОНЕЦ КАК Грузополучатель
	|ПОМЕСТИТЬ ДокументыКонтролируемыхСделок
	|ИЗ
	|	Документ.ВозвратТоваровМеждуОрганизациями КАК ВозвратТоваровМеждуОрганизациями
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.ВозвратТоваровМеждуОрганизациями.Товары КАК ВозвратТоваровМеждуОрганизациямиТовары
	|		ПО ВозвратТоваровМеждуОрганизациямиТовары.Ссылка = ВозвратТоваровМеждуОрганизациями.Ссылка
	|			И ВозвратТоваровМеждуОрганизациями.ДокументПередачи = ЗНАЧЕНИЕ(Документ.ПередачаТоваровМеждуОрганизациями.ПустаяСсылка)
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВзаимозависимыеЛицаПоПериодам КАК ВзаимозависимыеЛицаПоПериодам
	|		ПО (ВзаимозависимыеЛицаПоПериодам.Организация = &Организация)
	|			И ВозвратТоваровМеждуОрганизациями.Дата >= ВзаимозависимыеЛицаПоПериодам.НачалоПериода
	|			И ВозвратТоваровМеждуОрганизациями.Дата <= ВзаимозависимыеЛицаПоПериодам.ОкончаниеПериода
	|			И ВозвратТоваровМеждуОрганизациями.ОрганизацияПолучатель = ВзаимозависимыеЛицаПоПериодам.Контрагент
	|		ЛЕВОЕ СОЕДИНЕНИЕ ИностранныеОрганизации КАК ИностранныеОрганизации
	|		ПО ВозвратТоваровМеждуОрганизациями.ОрганизацияПолучатель = ИностранныеОрганизации.Организация
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ПередачаТоваровМеждуОрганизациями КАК ПередачаТоваровМеждуОрганизациями
	|		ПО ЕСТЬNULL(ВозвратТоваровМеждуОрганизациямиТовары.ДокументПередачи, ВозвратТоваровМеждуОрганизациями.ДокументПередачи) = ПередачаТоваровМеждуОрганизациями.Ссылка
	|ГДЕ
	|	ВозвратТоваровМеждуОрганизациями.Организация В(&СтруктураОрганизации)
	|	И ВозвратТоваровМеждуОрганизациями.Дата >= &НачалоПериода
	|	И ВозвратТоваровМеждуОрганизациями.Проведен
	|	И (НЕ ВзаимозависимыеЛицаПоПериодам.Контрагент ЕСТЬ NULL 
	|			ИЛИ НЕ ИностранныеОрганизации.Организация ЕСТЬ NULL )
	|	И ВозвратТоваровМеждуОрганизациями.ОрганизацияПолучатель В
	|			(ВЫБРАТЬ
	|				КонтролируемыеКонтрагенты.Контрагент
	|			ИЗ
	|				КонтролируемыеКонтрагенты КАК КонтролируемыеКонтрагенты)
	|	И ПередачаТоваровМеждуОрганизациями.Дата >= &НачалоПериода
	|	И ПередачаТоваровМеждуОрганизациями.Дата <= &ОкончаниеПериода
	|	И ПередачаТоваровМеждуОрганизациями.Проведен
	|	И ПередачаТоваровМеждуОрганизациями.ХозяйственнаяОперация <> ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РеализацияБезПереходаПраваСобственности)
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	ВозвратТоваровМеждуОрганизациями.Ссылка,
	|	ИСТИНА,
	|	ВЫБОР
	|		КОГДА ВзаимозависимыеЛицаПоПериодам.Контрагент ЕСТЬ NULL 
	|			ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА ИностранныеОрганизации.Организация ЕСТЬ NULL 
	|			ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА
	|	КОНЕЦ,
	|	ЕСТЬNULL(ИностранныеОрганизации.ЗарегистрированаВСтранеСЛьготнымНалогообложением, ЛОЖЬ),
	|	ПередачаТоваровМеждуОрганизациями.Ссылка,
	|	ПередачаТоваровМеждуОрганизациями.Дата КАК Период,
	|	ПередачаТоваровМеждуОрганизациями.Организация КАК Организация,
	|	ПередачаТоваровМеждуОрганизациями.ОрганизацияПолучатель КАК Контрагент,
	|	ПередачаТоваровМеждуОрганизациями.Валюта КАК Валюта,
	|	ПередачаТоваровМеждуОрганизациями.Договор КАК Договор,
	|	ВЫБОР
	|		КОГДА ПередачаТоваровМеждуОрганизациями.Грузоотправитель = ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	|		ТОГДА ПередачаТоваровМеждуОрганизациями.Организация
	|		ИНАЧЕ ПередачаТоваровМеждуОрганизациями.Грузоотправитель
	|	КОНЕЦ КАК Грузоотправитель,
	|	ВЫБОР
	|		КОГДА ПередачаТоваровМеждуОрганизациями.Грузополучатель = ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	|		ТОГДА ПередачаТоваровМеждуОрганизациями.ОрганизацияПолучатель
	|		ИНАЧЕ ПередачаТоваровМеждуОрганизациями.Грузополучатель
	|	КОНЕЦ КАК Грузополучатель
	|ИЗ
	|	Документ.ВозвратТоваровМеждуОрганизациями КАК ВозвратТоваровМеждуОрганизациями
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.ВозвратТоваровМеждуОрганизациями.Товары КАК ВозвратТоваровМеждуОрганизациямиТовары
	|		ПО ВозвратТоваровМеждуОрганизациямиТовары.Ссылка = ВозвратТоваровМеждуОрганизациями.Ссылка
	|			И ВозвратТоваровМеждуОрганизациями.ДокументПередачи = ЗНАЧЕНИЕ(Документ.ПередачаТоваровМеждуОрганизациями.ПустаяСсылка)
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВзаимозависимыеЛицаПоПериодам КАК ВзаимозависимыеЛицаПоПериодам
	|		ПО (ВзаимозависимыеЛицаПоПериодам.Организация = &Организация)
	|			И ВозвратТоваровМеждуОрганизациями.Дата >= ВзаимозависимыеЛицаПоПериодам.НачалоПериода
	|			И ВозвратТоваровМеждуОрганизациями.Дата <= ВзаимозависимыеЛицаПоПериодам.ОкончаниеПериода
	|			И ВозвратТоваровМеждуОрганизациями.Организация = ВзаимозависимыеЛицаПоПериодам.Контрагент
	|		ЛЕВОЕ СОЕДИНЕНИЕ ИностранныеОрганизации КАК ИностранныеОрганизации
	|		ПО ВозвратТоваровМеждуОрганизациями.Организация = ИностранныеОрганизации.Организация
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ПередачаТоваровМеждуОрганизациями КАК ПередачаТоваровМеждуОрганизациями
	|		ПО ЕСТЬNULL(ВозвратТоваровМеждуОрганизациями.ДокументПередачи, ВозвратТоваровМеждуОрганизациями.ДокументПередачи) = ПередачаТоваровМеждуОрганизациями.Ссылка
	|ГДЕ
	|	ВозвратТоваровМеждуОрганизациями.Дата >= &НачалоПериода
	|	И ВозвратТоваровМеждуОрганизациями.Проведен
	|	И ВозвратТоваровМеждуОрганизациями.Организация В
	|			(ВЫБРАТЬ
	|				КонтролируемыеКонтрагенты.Контрагент
	|			ИЗ
	|				КонтролируемыеКонтрагенты КАК КонтролируемыеКонтрагенты)
	|	И (НЕ ВзаимозависимыеЛицаПоПериодам.Контрагент ЕСТЬ NULL 
	|			ИЛИ НЕ ИностранныеОрганизации.Организация ЕСТЬ NULL )
	|	И ВозвратТоваровМеждуОрганизациями.ОрганизацияПолучатель В(&СтруктураОрганизации)
	|	И ПередачаТоваровМеждуОрганизациями.Дата >= &НачалоПериода
	|	И ПередачаТоваровМеждуОрганизациями.Дата <= &ОкончаниеПериода
	|	И ПередачаТоваровМеждуОрганизациями.Проведен
	|	И ПередачаТоваровМеждуОрганизациями.ХозяйственнаяОперация <> ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РеализацияБезПереходаПраваСобственности)
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	ДокументВозврата
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	ТоварыВозврата.Ссылка КАК Сделка,
	|	ВЫБОР
	|		КОГДА ДокументыКонтролируемыхСделок.ОрганизацияПринимаетВозврат
	|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыКонтролируемыхСделок.ПолученДоход)
	|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.ТипыКонтролируемыхСделок.ОсуществленРасход)
	|	КОНЕЦ КАК ТипКонтролируемойСделки,
	|	Аналитика.Номенклатура КАК ПредметСделки,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.Товар) КАК ТипПредметаСделки,
	|	ТоварыВозврата.Количество КАК Количество,
	|	Аналитика.Номенклатура.ЕдиницаИзмерения КАК ЕдиницаИзмеренияПоКлассификатору,
	|	ТоварыВозврата.СтавкаНДС КАК СтавкаНДС,
	|	ТоварыВозврата.СуммаСНДС - ТоварыВозврата.СуммаНДС КАК СуммаБезНДС,
	|	ТоварыВозврата.СуммаНДС КАК СуммаНДС,
	|	ВЫБОР
	|		КОГДА ТоварыВозврата.Ссылка.НалогообложениеНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаОблагаетсяЕНВД)
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ КАК ОперацияОблагаетсяЕНВД,
	|	ВЫБОР
	|		КОГДА ТоварыМировойБиржевойТорговли.ПредметСделки ЕСТЬ NULL 
	|			ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА
	|	КОНЕЦ КАК ТоварМировойБиржевойТорговли,
	|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперацииКонтролируемыхСделок.ВозвратТоваров) КАК ХозяйственнаяОперация,
	|	ВЫБОР
	|		КОГДА ТоварыВозврата.ВидЗапасов.ТипЗапасов В (ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.ПустаяСсылка), ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.Товар))
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ КАК ВключатьСоставСделок,
	|	ЕСТЬNULL(ТоварыВозврата.НомерГТД.СтранаПроисхождения, ЗНАЧЕНИЕ(Справочник.СтраныМира.Россия)) КАК СтранаПроисхождения,
	|	ДокументыКонтролируемыхСделок.ВзаимозависимыеЛица,
	|	ДокументыКонтролируемыхСделок.ИностраннаяОрганизация,
	|	ДокументыКонтролируемыхСделок.ЗарегистрированаВСтранеСЛьготнымНалогообложением,
	|	ТоварыВозврата.ИдентификаторСтроки КАК ИдентификаторСтроки,
	|	ДокументыКонтролируемыхСделок.ОрганизацияПринимаетВозврат,
	|	ДокументыКонтролируемыхСделок.РасчетныйДокумент КАК РасчетныйДокумент,
	|	ДокументыКонтролируемыхСделок.Период КАК Период,
	|	ДокументыКонтролируемыхСделок.Организация КАК Организация,
	|	ДокументыКонтролируемыхСделок.Контрагент КАК Контрагент,
	|	ДокументыКонтролируемыхСделок.Валюта КАК Валюта,
	|	ДокументыКонтролируемыхСделок.Договор КАК Договор,
	|	ДокументыКонтролируемыхСделок.Грузоотправитель КАК Грузоотправитель,
	|	ДокументыКонтролируемыхСделок.Грузополучатель КАК Грузополучатель
	|ПОМЕСТИТЬ ТоварыКонтролируемыхСделок
	|ИЗ
	|	Документ.ВозвратТоваровМеждуОрганизациями.ВидыЗапасов КАК ТоварыВозврата
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК Аналитика
	|		ПО ТоварыВозврата.АналитикаУчетаНоменклатуры = Аналитика.Ссылка
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ДокументыКонтролируемыхСделок КАК ДокументыКонтролируемыхСделок
	|		ПО ТоварыВозврата.Ссылка = ДокументыКонтролируемыхСделок.ДокументВозврата
	|			И ТоварыВозврата.ДокументПередачи = ДокументыКонтролируемыхСделок.РасчетныйДокумент
	|		ЛЕВОЕ СОЕДИНЕНИЕ ТоварыМировойБиржевойТорговли КАК ТоварыМировойБиржевойТорговли
	|		ПО Аналитика.Номенклатура = ТоварыМировойБиржевойТорговли.ПредметСделки
	|			И ТоварыМировойБиржевойТорговли.ДатаНачалаДействия <= ДокументыКонтролируемыхСделок.Период
	|			И ТоварыМировойБиржевойТорговли.ДатаОкончанияДействия >= ДокументыКонтролируемыхСделок.Период
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ТоварыКонтролируемыхСделок.РасчетныйДокумент,
	|	ТоварыКонтролируемыхСделок.Период КАК Период,
	|	ТоварыКонтролируемыхСделок.Организация КАК Организация,
	|	ТоварыКонтролируемыхСделок.Контрагент КАК Контрагент,
	|	ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка) КАК Комиссионер,
	|	ТоварыКонтролируемыхСделок.ПредметСделки,
	|	ТоварыКонтролируемыхСделок.ТипПредметаСделки,
	|	ТоварыКонтролируемыхСделок.ПредметСделки.НаименованиеПолное КАК НаименованиеПредметаСделки,
	|	ТоварыКонтролируемыхСделок.СтранаПроисхождения КАК СтранаПроисхожденияПредметаСделки,
	|	ТоварыКонтролируемыхСделок.ХозяйственнаяОперация,
	|	ТоварыКонтролируемыхСделок.Валюта КАК Валюта,
	|	ТоварыКонтролируемыхСделок.ЕдиницаИзмеренияПоКлассификатору КАК ЕдиницаИзмерения,
	|	ТоварыКонтролируемыхСделок.Количество,
	|	ТоварыКонтролируемыхСделок.СтавкаНДС,
	|	ТоварыКонтролируемыхСделок.СуммаБезНДС,
	|	ТоварыКонтролируемыхСделок.СуммаНДС,
	|	ТоварыКонтролируемыхСделок.ТипКонтролируемойСделки,
	|	ТоварыКонтролируемыхСделок.ТоварМировойБиржевойТорговли,
	|	ТоварыКонтролируемыхСделок.ОперацияОблагаетсяЕНВД,
	|	ТоварыКонтролируемыхСделок.Грузоотправитель КАК Грузоотправитель,
	|	ТоварыКонтролируемыхСделок.Грузополучатель КАК Грузополучатель,
	|	ТоварыКонтролируемыхСделок.ИдентификаторСтроки КАК ИдентификаторСтроки,
	|	-1 КАК МножительСуммовыхДанных,
	|	ТоварыКонтролируемыхСделок.Сделка КАК РегистраторРегистраСумм,
	|	ТоварыКонтролируемыхСделок.Договор КАК Договор,
	|	НЕОПРЕДЕЛЕНО КАК Соглашение
	|ПОМЕСТИТЬ ТаблицаСделок
	|ИЗ
	|	ТоварыКонтролируемыхСделок КАК ТоварыКонтролируемыхСделок
	|ГДЕ
	|	(ТоварыКонтролируемыхСделок.ТоварМировойБиржевойТорговли
	|				И ТоварыКонтролируемыхСделок.ИностраннаяОрганизация
	|			ИЛИ ТоварыКонтролируемыхСделок.ВзаимозависимыеЛица
	|			ИЛИ ТоварыКонтролируемыхСделок.ЗарегистрированаВСтранеСЛьготнымНалогообложением)
	|	И ТоварыКонтролируемыхСделок.ВключатьСоставСделок
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	РегистраторРегистраСумм,
	|	ИдентификаторСтроки";
	
	Запрос.Выполнить();
	
	ВыборкаСделокРеализации = ПолучитьВыборкуТаблицыСделокСПреобразованиемСуммКРублевым(Запрос.МенеджерВременныхТаблиц);
	
	Пока ВыборкаСделокРеализации.Следующий() Цикл
		СтрокаСделки = ТаблицаСделок.Добавить();
		ЗаполнитьЗначенияСвойств(СтрокаСделки, ВыборкаСделокРеализации);
	КонецЦикла;
	
	ЗапросУдаленияВременныхТаблиц = Новый Запрос();
	ЗапросУдаленияВременныхТаблиц.МенеджерВременныхТаблиц = Запрос.МенеджерВременныхТаблиц;
	ЗапросУдаленияВременныхТаблиц.Текст = 
	"УНИЧТОЖИТЬ ДокументыКонтролируемыхСделок
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ТоварыКонтролируемыхСделок
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ТаблицаСделок";
	
	ЗапросУдаленияВременныхТаблиц.Выполнить();
	
КонецПроцедуры

#КонецОбласти

#Область ДобавлениеСделокКредитовИДепозитов

// Добавляет в список контролируемых сделок начисления кредитов и депозитов.
//
// Параметры:
//  СтруктураПараметров - Структура - параметры контролируемых сделок:
//  * ВалютаРегламентированногоУчета - СправочникСсылка.Валюты - валюта регламетированного учета.
//  * НачалоПериода                  - Дата - начало периода формирования списка контролируемых сделок.
//  * ОкончаниеПериода               - Дата - окончание периода формирования списка контролируемых сделок.
//  * Организация                    - СправочникСсылка.Организации - код места представления.
//  * СписокПодчиненныхОрганизаций   - СписокЗначений из СправочникСсылка.Организации - список подчиненных организаций.
//  МенеджерВременныхТаблиц          - МенеджерВременныхТаблиц - временные таблицы запроса по контролируемым сделкам.
//  ТаблицаСделок                    - ТаблицаЗначений - таблица значений с данными о контролируемых сделках.
//
Процедура ДобавитьСделкиНачисленияКредитовИДепозитов(СтруктураПараметров, МенеджерВременныхТаблиц, ТаблицаСделок)
	
	Запрос = ПодготовитьЗапросКДокументамИсточникам(СтруктураПараметров);
	Запрос.МенеджерВременныхТаблиц = МенеджерВременныхТаблиц;
	Запрос.Текст =
	"ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	ДанныеРегистра.Регистратор КАК РасчетныйДокумент,
	|	ДанныеРегистра.Период КАК Период,
	|	ДанныеДоговора.Организация КАК Организация,
	|	ДанныеДоговора.Контрагент КАК Контрагент,
	|	ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка) КАК Комиссионер,
	|	ДанныеРегистра.ТипСуммы КАК ПредметСделки,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.ДолговоеОбязательство) КАК ТипПредметаСделки,
	|	ДанныеРегистра.ХозяйственнаяОперация КАК НаименованиеПредметаСделки,
	|	ЗНАЧЕНИЕ(Справочник.СтраныМира.ПустаяСсылка) КАК СтранаПроисхожденияПредметаСделки,
	|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперацииКонтролируемыхСделок.ПрочаяОперация) КАК ХозяйственнаяОперация,
	|	ДанныеРегистра.Валюта КАК Валюта,
	|	&ЕдиницаИзмеренияШтука КАК ЕдиницаИзмерения,
	|	1 КАК Количество,
	|	ЗНАЧЕНИЕ(Справочник.СтавкиНДС.БезНДС) КАК СтавкаНДС,
	|	СУММА(ДанныеРегистра.Сумма) КАК СуммаБезНДСВВалютеРасчетов,
	|	0 КАК СуммаНДСВВалютеРасчетов,
	|	СУММА(ДанныеРегистра.СуммаРегл) КАК СуммаБезНДСВРублях,
	|	0 КАК СуммаНДСВРублях,
	|	СРЕДНЕЕ(ДанныеРегистра.СуммаРегл) КАК ЦенаВРублях,
	|	ВЫБОР
	|		КОГДА ДанныеДоговора.ХарактерДоговора = ЗНАЧЕНИЕ(Перечисление.ХарактерыДоговоровФинансовыхИнструментов.КредитИлиЗайм)
	|		ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыКонтролируемыхСделок.ОсуществленРасход)
	|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.ТипыКонтролируемыхСделок.ПолученДоход)
	|	КОНЕЦ КАК ТипКонтролируемойСделки,
	|	ЛОЖЬ КАК ТоварМировойБиржевойТорговли,
	|	ЛОЖЬ КАК ОперацияОблагаетсяЕНВД,
	|	ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка) КАК Грузоотправитель,
	|	ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка) КАК Грузополучатель,
	|	ДанныеДоговора.Ссылка КАК Договор,
	|	НЕОПРЕДЕЛЕНО КАК Соглашение
	|ИЗ
	|	РегистрНакопления.РасчетыПоФинансовымИнструментам КАК ДанныеРегистра
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ДоговорыКредитовИДепозитов КАК ДанныеДоговора
	|	ПО ДанныеРегистра.Договор = ДанныеДоговора.Ссылка
	|	ЛЕВОЕ СОЕДИНЕНИЕ ВзаимозависимыеЛицаПоПериодам КАК ВзаимозависимыеЛицаПоПериодам
	|	ПО (ВзаимозависимыеЛицаПоПериодам.Организация = &Организация)
	|		И ДанныеРегистра.Период >= ВзаимозависимыеЛицаПоПериодам.НачалоПериода
	|		И ДанныеРегистра.Период <= ВзаимозависимыеЛицаПоПериодам.ОкончаниеПериода
	|		И ДанныеДоговора.Контрагент = ВзаимозависимыеЛицаПоПериодам.Контрагент
	|	ЛЕВОЕ СОЕДИНЕНИЕ ИностранныеКонтрагенты КАК ИностранныеКонтрагенты
	|	ПО ДанныеДоговора.Контрагент = ИностранныеКонтрагенты.Контрагент
	|ГДЕ
	|	ДанныеДоговора.Организация В(&СтруктураОрганизации)
	|	И ДанныеРегистра.Период >= &НачалоПериода
	|	И ДанныеРегистра.Период <= &ОкончаниеПериода
	|	И ДанныеРегистра.Активность И НЕ ДанныеРегистра.Сторно
	|	И ДанныеРегистра.ТипСуммы <> ЗНАЧЕНИЕ(Перечисление.ТипыСуммГрафикаКредитовИДепозитов.ОсновнойДолг)
	|	И ДанныеРегистра.ТипГрафика = ЗНАЧЕНИЕ(Перечисление.ТипыГрафиковФинансовыхИнструментов.Начисления)
	|	И ДанныеДоговора.Контрагент В
	|			(ВЫБРАТЬ
	|				КонтролируемыеКонтрагенты.Контрагент
	|			ИЗ
	|				КонтролируемыеКонтрагенты КАК КонтролируемыеКонтрагенты)
	|	И (НЕ ВзаимозависимыеЛицаПоПериодам.Контрагент ЕСТЬ NULL 
	|			ИЛИ ЕСТЬNULL(ИностранныеКонтрагенты.ЗарегистрированВСтранеСЛьготнымНалогообложением, ЛОЖЬ))
	|
	|СГРУППИРОВАТЬ ПО
	|	ДанныеРегистра.Регистратор,
	|	ДанныеРегистра.Период,
	|	ДанныеДоговора.Организация,
	|	ДанныеДоговора.Контрагент,
	|	ДанныеРегистра.ТипСуммы,
	|	ДанныеРегистра.ХозяйственнаяОперация,
	|	ДанныеРегистра.Валюта,
	|	ВЫБОР
	|		КОГДА ДанныеДоговора.ХарактерДоговора = ЗНАЧЕНИЕ(Перечисление.ХарактерыДоговоровФинансовыхИнструментов.КредитИлиЗайм)
	|		ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыКонтролируемыхСделок.ОсуществленРасход)
	|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.ТипыКонтролируемыхСделок.ПолученДоход)
	|	КОНЕЦ,
	|	ДанныеДоговора.Ссылка";
	
	Результат = Запрос.Выполнить();
	
	ВыборкаСделокРеализации = Результат.Выбрать();
	
	Пока ВыборкаСделокРеализации.Следующий() Цикл
		СтрокаСделки = ТаблицаСделок.Добавить();
		ЗаполнитьЗначенияСвойств(СтрокаСделки, ВыборкаСделокРеализации);
		СтрокаСделки.НаименованиеПредметаСделки = СтрокаСделки.НаименованиеПредметаСделки + " (" + ВыборкаСделокРеализации.ПредметСделки + ")";
		
		Если ЗначениеЗаполнено(СтрокаСделки.Договор) Тогда
			ДанныеПроцентнойСтавки = РегистрыСведений.ПроцентныеСтавкиФинансовыхИнструментов.ПрочитатьПроцентнуюСтавкуКомиссии(
				СтрокаСделки.Договор, СтрокаСделки.Период);
			СтрокаСделки.ПроцентнаяСтавка = ДанныеПроцентнойСтавки.Процент;
			СтрокаСделки.ДатаПроцентнойСтавки = ДанныеПроцентнойСтавки.Период;
		КонецЕсли;
		
	КонецЦикла;
	
КонецПроцедуры

#КонецОбласти

#Область ДобавлениеСделокАренды

// Добавляет в список контролируемых сделок поступления услуг по аренде.
//
// Параметры:
//  СтруктураПараметров - Структура - параметры контролируемых сделок:
//  * ВалютаРегламентированногоУчета - СправочникСсылка.Валюты - валюта регламетированного учета.
//  * НачалоПериода                  - Дата - начало периода формирования списка контролируемых сделок.
//  * ОкончаниеПериода               - Дата - окончание периода формирования списка контролируемых сделок.
//  * Организация                    - СправочникСсылка.Организации - код места представления.
//  * СписокПодчиненныхОрганизаций   - СписокЗначений из СправочникСсылка.Организации - список подчиненных организаций.
//  МенеджерВременныхТаблиц          - МенеджерВременныхТаблиц - временные таблицы запроса по контролируемым сделкам.
//  ТаблицаСделок                    - ТаблицаЗначений - таблица значений с данными о контролируемых сделках.
//
Процедура ДобавитьСделкиПоступленияУслугПоАренде(СтруктураПараметров, МенеджерВременныхТаблиц, ТаблицаСделок)
	
	Запрос = ПодготовитьЗапросКДокументамИсточникам(СтруктураПараметров);
	Запрос.МенеджерВременныхТаблиц = МенеджерВременныхТаблиц;
	Запрос.Текст =
	"ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	ПоступлениеУслугПоАренде.Ссылка КАК РасчетныйДокумент,
	|	ВЫБОР
	|		КОГДА ВзаимозависимыеЛицаПоПериодам.Контрагент ЕСТЬ NULL 
	|			ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА
	|	КОНЕЦ КАК ВзаимозависимыеЛица,
	|	ВЫБОР
	|		КОГДА ИностранныеКонтрагенты.Контрагент ЕСТЬ NULL 
	|			ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА
	|	КОНЕЦ КАК ИностранныйКонтрагент,
	|	ЕСТЬNULL(ИностранныеКонтрагенты.ЗарегистрированВСтранеСЛьготнымНалогообложением, ЛОЖЬ) КАК ЗарегистрированВСтранеСЛьготнымНалогообложением
	|ПОМЕСТИТЬ ДокументыКонтролируемыхСделок
	|ИЗ
	|	Документ.ПоступлениеУслугПоАренде КАК ПоступлениеУслугПоАренде
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВзаимозависимыеЛицаПоПериодам КАК ВзаимозависимыеЛицаПоПериодам
	|		ПО (ВзаимозависимыеЛицаПоПериодам.Организация = &Организация)
	|			И (ВзаимозависимыеЛицаПоПериодам.Контрагент = ПоступлениеУслугПоАренде.Контрагент)
	|			И ПоступлениеУслугПоАренде.Дата >= ВзаимозависимыеЛицаПоПериодам.НачалоПериода
	|			И ПоступлениеУслугПоАренде.Дата <= ВзаимозависимыеЛицаПоПериодам.ОкончаниеПериода
	|		ЛЕВОЕ СОЕДИНЕНИЕ ИностранныеКонтрагенты КАК ИностранныеКонтрагенты
	|		ПО (ИностранныеКонтрагенты.Контрагент = ПоступлениеУслугПоАренде.Контрагент)
	|ГДЕ
	|	ПоступлениеУслугПоАренде.Организация В(&СтруктураОрганизации)
	|	И ПоступлениеУслугПоАренде.Дата >= &НачалоПериода
	|	И ПоступлениеУслугПоАренде.Дата <= &ОкончаниеПериода
	|	И ПоступлениеУслугПоАренде.Проведен = ИСТИНА
	|	И ПоступлениеУслугПоАренде.Контрагент В
	|			(ВЫБРАТЬ
	|				КонтролируемыеКонтрагенты.Контрагент
	|			ИЗ
	|				КонтролируемыеКонтрагенты КАК КонтролируемыеКонтрагенты)
	|	И (НЕ ВзаимозависимыеЛицаПоПериодам.Контрагент ЕСТЬ NULL 
	|			ИЛИ ЕСТЬNULL(ИностранныеКонтрагенты.ЗарегистрированВСтранеСЛьготнымНалогообложением, ЛОЖЬ))
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	РасчетныйДокумент
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	ПоступлениеУслугПоАрендеНачисления.Ссылка КАК РасчетныйДокумент,
	|	ПоступлениеУслугПоАрендеНачисления.Ссылка.Дата КАК Период,
	|	ПоступлениеУслугПоАрендеНачисления.Ссылка.Организация,
	|	ПоступлениеУслугПоАрендеНачисления.Ссылка.Контрагент,
	|	ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка) КАК Комиссионер,
	|	ПоступлениеУслугПоАрендеНачисления.Содержание КАК ПредметСделки,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.ИнойОбъектГражданскихПрав) КАК ТипПредметаСделки,
	|	ПоступлениеУслугПоАрендеНачисления.Содержание КАК НаименованиеПредметаСделки,
	|	ЗНАЧЕНИЕ(Справочник.СтраныМира.ПустаяСсылка) КАК СтранаПроисхожденияПредметаСделки,
	|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперацииКонтролируемыхСделок.ПолучениеУслуг) КАК ХозяйственнаяОперация,
	|	ПоступлениеУслугПоАрендеНачисления.Ссылка.Валюта,
	|	&ЕдиницаИзмеренияШтука КАК ЕдиницаИзмерения,
	|	1 КАК Количество,
	|	ПоступлениеУслугПоАрендеНачисления.СтавкаНДС,
	|	ПоступлениеУслугПоАрендеНачисления.СуммаСНДС - ПоступлениеУслугПоАрендеНачисления.СуммаНДС КАК СуммаБезНДС,
	|	ПоступлениеУслугПоАрендеНачисления.СуммаНДС,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыКонтролируемыхСделок.ОсуществленРасход) КАК ТипКонтролируемойСделки,
	|	ЛОЖЬ КАК ТоварМировойБиржевойТорговли,
	|	ВЫБОР
	|		КОГДА ПоступлениеУслугПоАрендеНачисления.Ссылка.НалогообложениеНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаОблагаетсяЕНВД)
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ КАК ОперацияОблагаетсяЕНВД,
	|	ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка) КАК Грузоотправитель,
	|	ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка) КАК Грузополучатель,
	|	ПоступлениеУслугПоАрендеНачисления.Ссылка.Договор КАК Договор,
	|	НЕОПРЕДЕЛЕНО КАК Соглашение,
	|	ПоступлениеУслугПоАрендеНачисления.Ссылка КАК РегистраторРегистраСумм,
	|	1 КАК МножительСуммовыхДанных,
	|	ПоступлениеУслугПоАрендеНачисления.ИдентификаторСтроки КАК ИдентификаторСтроки
	|ПОМЕСТИТЬ ТаблицаСделок
	|ИЗ
	|	ДокументыКонтролируемыхСделок КАК ДокументыКонтролируемыхСделок
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ПоступлениеУслугПоАренде.Начисления КАК ПоступлениеУслугПоАрендеНачисления
	|		ПО ДокументыКонтролируемыхСделок.РасчетныйДокумент = ПоступлениеУслугПоАрендеНачисления.Ссылка
	|ГДЕ
	|	(ДокументыКонтролируемыхСделок.ВзаимозависимыеЛица
	|			ИЛИ ДокументыКонтролируемыхСделок.ЗарегистрированВСтранеСЛьготнымНалогообложением)
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	РегистраторРегистраСумм,
	|	ИдентификаторСтроки";
	
	Запрос.Выполнить();
	
	ВыборкаСделокРеализации = ПолучитьВыборкуТаблицыСделокСПреобразованиемСуммКРублевым(Запрос.МенеджерВременныхТаблиц);
	
	Пока ВыборкаСделокРеализации.Следующий() Цикл
		СтрокаСделки = ТаблицаСделок.Добавить();
		ЗаполнитьЗначенияСвойств(СтрокаСделки, ВыборкаСделокРеализации);
	КонецЦикла;
	
	ЗапросУдаленияВременныхТаблиц = Новый Запрос();
	ЗапросУдаленияВременныхТаблиц.МенеджерВременныхТаблиц = Запрос.МенеджерВременныхТаблиц;
	ЗапросУдаленияВременныхТаблиц.Текст = 
	"УНИЧТОЖИТЬ ДокументыКонтролируемыхСделок
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ТаблицаСделок";
	
	ЗапросУдаленияВременныхТаблиц.Выполнить();
	
КонецПроцедуры

#КонецОбласти

#Область ДобавлениеСделокВыкупаВозвратнойТары

// Добавляет в список контролируемых сделок выкупы возвратной тары клиентом.
//
// Параметры:
//  СтруктураПараметров - Структура - параметры контролируемых сделок:
//  * ВалютаРегламентированногоУчета - СправочникСсылка.Валюты - валюта регламетированного учета.
//  * НачалоПериода                  - Дата - начало периода формирования списка контролируемых сделок.
//  * ОкончаниеПериода               - Дата - окончание периода формирования списка контролируемых сделок.
//  * Организация                    - СправочникСсылка.Организации - код места представления.
//  * СписокПодчиненныхОрганизаций   - СписокЗначений из СправочникСсылка.Организации - список подчиненных организаций.
//  МенеджерВременныхТаблиц          - МенеджерВременныхТаблиц - временные таблицы запроса по контролируемым сделкам.
//  ТаблицаСделок                    - ТаблицаЗначений - таблица значений с данными о контролируемых сделках.
//
Процедура ДобавитьСделкиВыкупаВозвратнойТарыКлиентом(СтруктураПараметров, МенеджерВременныхТаблиц, ТаблицаСделок)
	
	Запрос = ПодготовитьЗапросКДокументамИсточникам(СтруктураПараметров);
	Запрос.УстановитьПараметр("ИспользованиеСоглашений", ПолучитьФункциональнуюОпцию("ИспользоватьСоглашенияСКлиентами"));
	Запрос.УстановитьПараметр("ИспользованиеДоговоров", ПолучитьФункциональнуюОпцию("ИспользоватьДоговорыСКлиентами"));
	Запрос.МенеджерВременныхТаблиц = МенеджерВременныхТаблиц;
	Запрос.Текст =
	"ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	ВыкупВозвратнойТарыКлиентом.Ссылка КАК РасчетныйДокумент,
	|	ВЫБОР
	|		КОГДА ВзаимозависимыеЛицаПоПериодам.Контрагент ЕСТЬ NULL 
	|			ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА
	|	КОНЕЦ КАК ВзаимозависимыеЛица,
	|	ВЫБОР
	|		КОГДА ИностранныеКонтрагенты.Контрагент ЕСТЬ NULL 
	|			ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА
	|	КОНЕЦ КАК ИностранныйКонтрагент,
	|	ЕСТЬNULL(ИностранныеКонтрагенты.ЗарегистрированВСтранеСЛьготнымНалогообложением, ЛОЖЬ) КАК ЗарегистрированВСтранеСЛьготнымНалогообложением
	|ПОМЕСТИТЬ ДокументыКонтролируемыхСделок
	|ИЗ
	|	Документ.ВыкупВозвратнойТарыКлиентом КАК ВыкупВозвратнойТарыКлиентом
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВзаимозависимыеЛицаПоПериодам КАК ВзаимозависимыеЛицаПоПериодам
	|		ПО (ВзаимозависимыеЛицаПоПериодам.Организация = &Организация)
	|			И (ВзаимозависимыеЛицаПоПериодам.Контрагент = ВыкупВозвратнойТарыКлиентом.Контрагент)
	|			И ВыкупВозвратнойТарыКлиентом.Дата >= ВзаимозависимыеЛицаПоПериодам.НачалоПериода
	|			И ВыкупВозвратнойТарыКлиентом.Дата <= ВзаимозависимыеЛицаПоПериодам.ОкончаниеПериода
	|		ЛЕВОЕ СОЕДИНЕНИЕ ИностранныеКонтрагенты КАК ИностранныеКонтрагенты
	|		ПО (ИностранныеКонтрагенты.Контрагент = ВыкупВозвратнойТарыКлиентом.Контрагент)
	|ГДЕ
	|	ВыкупВозвратнойТарыКлиентом.Организация В(&СтруктураОрганизации)
	|	И ВыкупВозвратнойТарыКлиентом.Дата >= &НачалоПериода
	|	И ВыкупВозвратнойТарыКлиентом.Дата <= &ОкончаниеПериода
	|	И ВыкупВозвратнойТарыКлиентом.Проведен = ИСТИНА
	|	И ВыкупВозвратнойТарыКлиентом.Контрагент В
	|			(ВЫБРАТЬ
	|				КонтролируемыеКонтрагенты.Контрагент
	|			ИЗ
	|				КонтролируемыеКонтрагенты КАК КонтролируемыеКонтрагенты)
	|	И (НЕ ВзаимозависимыеЛицаПоПериодам.Контрагент ЕСТЬ NULL 
	|			ИЛИ ЕСТЬNULL(ИностранныеКонтрагенты.ЗарегистрированВСтранеСЛьготнымНалогообложением, ЛОЖЬ))
	|	И ВЫБОР
	|			КОГДА ВыкупВозвратнойТарыКлиентом.Договор = ЗНАЧЕНИЕ(Справочник.ДоговорыКонтрагентов.ПустаяСсылка)
	|				ТОГДА ИСТИНА
	|			ИНАЧЕ ВыкупВозвратнойТарыКлиентом.Договор.ТипДоговора = ЗНАЧЕНИЕ(Перечисление.ТипыДоговоров.СПокупателем)
	|		КОНЕЦ
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	РасчетныйДокумент
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	ВозвратнаяТараДляВыкупа.Ссылка КАК РасчетныйДокумент,
	|	ВозвратнаяТараДляВыкупа.Ссылка.Дата КАК Период,
	|	ВозвратнаяТараДляВыкупа.Ссылка.Организация,
	|	ВозвратнаяТараДляВыкупа.Ссылка.Контрагент,
	|	ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка) КАК Комиссионер,
	|	Аналитика.Номенклатура КАК ПредметСделки,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.Товар) КАК ТипПредметаСделки,
	|	Аналитика.Номенклатура.НаименованиеПолное КАК НаименованиеПредметаСделки,
	|	ЕСТЬNULL(ВозвратнаяТараДляВыкупа.НомерГТД.СтранаПроисхождения, ЗНАЧЕНИЕ(Справочник.СтраныМира.Россия)) КАК СтранаПроисхожденияПредметаСделки,
	|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперацииКонтролируемыхСделок.РеализацияСобственныхТоваров) КАК ХозяйственнаяОперация,
	|	ВозвратнаяТараДляВыкупа.Ссылка.Валюта,
	|	Аналитика.Номенклатура.ЕдиницаИзмерения КАК ЕдиницаИзмерения,
	|	ВозвратнаяТараДляВыкупа.Количество КАК Количество,
	|	ВозвратнаяТараДляВыкупа.СтавкаНДС,
	|	ВозвратнаяТараДляВыкупа.СуммаСНДС - ВозвратнаяТараДляВыкупа.СуммаНДС КАК СуммаБезНДС,
	|	ВозвратнаяТараДляВыкупа.СуммаНДС,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыКонтролируемыхСделок.ПолученДоход) КАК ТипКонтролируемойСделки,
	|	ЛОЖЬ КАК ТоварМировойБиржевойТорговли,
	|	ВЫБОР
	|		КОГДА ВозвратнаяТараДляВыкупа.Ссылка.НалогообложениеНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаОблагаетсяЕНВД)
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ КАК ОперацияОблагаетсяЕНВД,
	|	ВЫБОР
	|		КОГДА ВозвратнаяТараДляВыкупа.Ссылка.Грузоотправитель = ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	|			ТОГДА ВозвратнаяТараДляВыкупа.Ссылка.Организация
	|		ИНАЧЕ ВозвратнаяТараДляВыкупа.Ссылка.Грузоотправитель
	|	КОНЕЦ КАК Грузоотправитель,
	|	ВЫБОР
	|		КОГДА ВозвратнаяТараДляВыкупа.Ссылка.Грузополучатель = ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	|			ТОГДА ВозвратнаяТараДляВыкупа.Ссылка.Контрагент
	|		ИНАЧЕ ВозвратнаяТараДляВыкупа.Ссылка.Грузополучатель
	|	КОНЕЦ КАК Грузополучатель,
	|	ВЫБОР
	|		КОГДА &ИспользованиеДоговоров
	|			ТОГДА ВозвратнаяТараДляВыкупа.Ссылка.Договор
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК Договор,
	|	ВЫБОР
	|		КОГДА &ИспользованиеСоглашений
	|			ТОГДА ВозвратнаяТараДляВыкупа.Ссылка.Соглашение
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК Соглашение,
	|	ВозвратнаяТараДляВыкупа.Ссылка КАК РегистраторРегистраСумм,
	|	1 КАК МножительСуммовыхДанных,
	|	ВозвратнаяТараДляВыкупа.ИдентификаторСтроки КАК ИдентификаторСтроки
	|ПОМЕСТИТЬ ТаблицаСделок
	|ИЗ
	|	ДокументыКонтролируемыхСделок КАК ДокументыКонтролируемыхСделок
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ВыкупВозвратнойТарыКлиентом.ВидыЗапасов КАК ВозвратнаяТараДляВыкупа
	|		ПО ДокументыКонтролируемыхСделок.РасчетныйДокумент = ВозвратнаяТараДляВыкупа.Ссылка
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК Аналитика
	|		ПО ВозвратнаяТараДляВыкупа.АналитикаУчетаНоменклатуры = Аналитика.Ссылка
	|ГДЕ
	|	(ДокументыКонтролируемыхСделок.ВзаимозависимыеЛица
	|			ИЛИ ДокументыКонтролируемыхСделок.ЗарегистрированВСтранеСЛьготнымНалогообложением)
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	РегистраторРегистраСумм,
	|	ИдентификаторСтроки";
	
	Запрос.Выполнить();
	
	ВыборкаСделокРеализации = ПолучитьВыборкуТаблицыСделокСПреобразованиемСуммКРублевым(Запрос.МенеджерВременныхТаблиц);
	
	Пока ВыборкаСделокРеализации.Следующий() Цикл
		СтрокаСделки = ТаблицаСделок.Добавить();
		ЗаполнитьЗначенияСвойств(СтрокаСделки, ВыборкаСделокРеализации);
	КонецЦикла;
	
	ЗапросУдаленияВременныхТаблиц = Новый Запрос();
	ЗапросУдаленияВременныхТаблиц.МенеджерВременныхТаблиц = Запрос.МенеджерВременныхТаблиц;
	ЗапросУдаленияВременныхТаблиц.Текст = 
	"УНИЧТОЖИТЬ ДокументыКонтролируемыхСделок
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ТаблицаСделок";
	
	ЗапросУдаленияВременныхТаблиц.Выполнить();
	
КонецПроцедуры

// Добавляет в список контролируемых сделок выкупы возвратной тары у поставщика.
//
// Параметры:
//  СтруктураПараметров - Структура - параметры контролируемых сделок:
//  * ВалютаРегламентированногоУчета - СправочникСсылка.Валюты - валюта регламетированного учета.
//  * НачалоПериода                  - Дата - начало периода формирования списка контролируемых сделок.
//  * ОкончаниеПериода               - Дата - окончание периода формирования списка контролируемых сделок.
//  * Организация                    - СправочникСсылка.Организации - код места представления.
//  * СписокПодчиненныхОрганизаций   - СписокЗначений из СправочникСсылка.Организации - список подчиненных организаций.
//  МенеджерВременныхТаблиц          - МенеджерВременныхТаблиц - временные таблицы запроса по контролируемым сделкам.
//  ТаблицаСделок                    - ТаблицаЗначений - таблица значений с данными о контролируемых сделках.
//
Процедура ДобавитьСделкиВыкупаВозвратнойТарыУПоставщика(СтруктураПараметров, МенеджерВременныхТаблиц, ТаблицаСделок)
	
	Запрос = ПодготовитьЗапросКДокументамИсточникам(СтруктураПараметров);
	Запрос.УстановитьПараметр("ИспользованиеСоглашений", ПолучитьФункциональнуюОпцию("ИспользоватьСоглашенияСПоставщиками"));
	Запрос.УстановитьПараметр("ИспользованиеДоговоров", ПолучитьФункциональнуюОпцию("ИспользоватьДоговорыСПоставщиками"));
	Запрос.МенеджерВременныхТаблиц = МенеджерВременныхТаблиц;
	Запрос.Текст =
	"ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	ВыкупВозвратнойТарыУПоставщика.Ссылка КАК РасчетныйДокумент,
	|	ВЫБОР
	|		КОГДА ВзаимозависимыеЛицаПоПериодам.Контрагент ЕСТЬ NULL 
	|			ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА
	|	КОНЕЦ КАК ВзаимозависимыеЛица,
	|	ВЫБОР
	|		КОГДА ИностранныеКонтрагенты.Контрагент ЕСТЬ NULL 
	|			ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА
	|	КОНЕЦ КАК ИностранныйКонтрагент,
	|	ЕСТЬNULL(ИностранныеКонтрагенты.ЗарегистрированВСтранеСЛьготнымНалогообложением, ЛОЖЬ) КАК ЗарегистрированВСтранеСЛьготнымНалогообложением
	|ПОМЕСТИТЬ ДокументыКонтролируемыхСделок
	|ИЗ
	|	Документ.ВыкупВозвратнойТарыУПоставщика КАК ВыкупВозвратнойТарыУПоставщика
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВзаимозависимыеЛицаПоПериодам КАК ВзаимозависимыеЛицаПоПериодам
	|		ПО (ВзаимозависимыеЛицаПоПериодам.Организация = &Организация)
	|			И (ВзаимозависимыеЛицаПоПериодам.Контрагент = ВыкупВозвратнойТарыУПоставщика.Контрагент)
	|			И ВыкупВозвратнойТарыУПоставщика.Дата >= ВзаимозависимыеЛицаПоПериодам.НачалоПериода
	|			И ВыкупВозвратнойТарыУПоставщика.Дата <= ВзаимозависимыеЛицаПоПериодам.ОкончаниеПериода
	|		ЛЕВОЕ СОЕДИНЕНИЕ ИностранныеКонтрагенты КАК ИностранныеКонтрагенты
	|		ПО (ИностранныеКонтрагенты.Контрагент = ВыкупВозвратнойТарыУПоставщика.Контрагент)
	|ГДЕ
	|	ВыкупВозвратнойТарыУПоставщика.Организация В(&СтруктураОрганизации)
	|	И ВыкупВозвратнойТарыУПоставщика.Дата >= &НачалоПериода
	|	И ВыкупВозвратнойТарыУПоставщика.Дата <= &ОкончаниеПериода
	|	И ВыкупВозвратнойТарыУПоставщика.Проведен = ИСТИНА
	|	И ВыкупВозвратнойТарыУПоставщика.Контрагент В
	|			(ВЫБРАТЬ
	|				КонтролируемыеКонтрагенты.Контрагент
	|			ИЗ
	|				КонтролируемыеКонтрагенты КАК КонтролируемыеКонтрагенты)
	|	И (НЕ ВзаимозависимыеЛицаПоПериодам.Контрагент ЕСТЬ NULL 
	|			ИЛИ ЕСТЬNULL(ИностранныеКонтрагенты.ЗарегистрированВСтранеСЛьготнымНалогообложением, ЛОЖЬ))
	|	И ВЫБОР
	|			КОГДА ВыкупВозвратнойТарыУПоставщика.Договор = ЗНАЧЕНИЕ(Справочник.ДоговорыКонтрагентов.ПустаяСсылка)
	|				ТОГДА ИСТИНА
	|			ИНАЧЕ ВыкупВозвратнойТарыУПоставщика.Договор.ТипДоговора = ЗНАЧЕНИЕ(Перечисление.ТипыДоговоров.СПоставщиком)
	|		КОНЕЦ
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	РасчетныйДокумент
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	ВозвратнаяТараДляВыкупа.Ссылка КАК РасчетныйДокумент,
	|	ВозвратнаяТараДляВыкупа.Ссылка.Дата КАК Период,
	|	ВозвратнаяТараДляВыкупа.Ссылка.Организация,
	|	ВозвратнаяТараДляВыкупа.Ссылка.Контрагент,
	|	ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка) КАК Комиссионер,
	|	ВозвратнаяТараДляВыкупа.Номенклатура КАК ПредметСделки,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.Товар) КАК ТипПредметаСделки,
	|	ВозвратнаяТараДляВыкупа.Номенклатура.НаименованиеПолное КАК НаименованиеПредметаСделки,
	|	ВЫБОР
	|		КОГДА ВозвратнаяТараДляВыкупа.Ссылка.Контрагент.ЮрФизЛицо = ЗНАЧЕНИЕ(Перечисление.ЮрФизЛицо.ЮрЛицоНеРезидент)
	|			ТОГДА ЕСТЬNULL(ВозвратнаяТараДляВыкупа.Ссылка.Контрагент.СтранаРегистрации, ЗНАЧЕНИЕ(Справочник.СтраныМира.ПустаяСсылка))
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.СтраныМира.Россия)
	|	КОНЕЦ КАК СтранаПроисхожденияПредметаСделки,
	|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперацииКонтролируемыхСделок.ПриобретениеТоваров) КАК ХозяйственнаяОперация,
	|	ВозвратнаяТараДляВыкупа.Ссылка.Валюта,
	|	ВозвратнаяТараДляВыкупа.Номенклатура.ЕдиницаИзмерения КАК ЕдиницаИзмерения,
	|	ВозвратнаяТараДляВыкупа.Количество КАК Количество,
	|	ВозвратнаяТараДляВыкупа.СтавкаНДС,
	|	ВозвратнаяТараДляВыкупа.СуммаСНДС - ВозвратнаяТараДляВыкупа.СуммаНДС КАК СуммаБезНДС,
	|	ВозвратнаяТараДляВыкупа.СуммаНДС,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыКонтролируемыхСделок.ОсуществленРасход) КАК ТипКонтролируемойСделки,
	|	ЛОЖЬ КАК ТоварМировойБиржевойТорговли,
	|	ВЫБОР
	|		КОГДА ВозвратнаяТараДляВыкупа.Ссылка.НалогообложениеНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаОблагаетсяЕНВД)
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ КАК ОперацияОблагаетсяЕНВД,
	|	ВозвратнаяТараДляВыкупа.Ссылка.Контрагент КАК Грузоотправитель,
	|	ВозвратнаяТараДляВыкупа.Ссылка.Организация КАК Грузополучатель,
	|	ВЫБОР
	|		КОГДА &ИспользованиеДоговоров
	|			ТОГДА ВозвратнаяТараДляВыкупа.Ссылка.Договор
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК Договор,
	|	ВЫБОР
	|		КОГДА &ИспользованиеСоглашений
	|			ТОГДА ВозвратнаяТараДляВыкупа.Ссылка.Соглашение
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК Соглашение,
	|	ВозвратнаяТараДляВыкупа.Ссылка КАК РегистраторРегистраСумм,
	|	1 КАК МножительСуммовыхДанных,
	|	ВозвратнаяТараДляВыкупа.ИдентификаторСтроки КАК ИдентификаторСтроки
	|ПОМЕСТИТЬ ТаблицаСделок
	|ИЗ
	|	ДокументыКонтролируемыхСделок КАК ДокументыКонтролируемыхСделок
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ВыкупВозвратнойТарыУПоставщика.Товары КАК ВозвратнаяТараДляВыкупа
	|		ПО ДокументыКонтролируемыхСделок.РасчетныйДокумент = ВозвратнаяТараДляВыкупа.Ссылка
	|ГДЕ
	|	(ДокументыКонтролируемыхСделок.ВзаимозависимыеЛица
	|			ИЛИ ДокументыКонтролируемыхСделок.ЗарегистрированВСтранеСЛьготнымНалогообложением)
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	РегистраторРегистраСумм,
	|	ИдентификаторСтроки";
	
	Запрос.Выполнить();
	
	ВыборкаСделокРеализации = ПолучитьВыборкуТаблицыСделокСПреобразованиемСуммКРублевым(Запрос.МенеджерВременныхТаблиц);
	
	Пока ВыборкаСделокРеализации.Следующий() Цикл
		СтрокаСделки = ТаблицаСделок.Добавить();
		ЗаполнитьЗначенияСвойств(СтрокаСделки, ВыборкаСделокРеализации);
	КонецЦикла;
	
	ЗапросУдаленияВременныхТаблиц = Новый Запрос();
	ЗапросУдаленияВременныхТаблиц.МенеджерВременныхТаблиц = Запрос.МенеджерВременныхТаблиц;
	ЗапросУдаленияВременныхТаблиц.Текст = 
	"УНИЧТОЖИТЬ ДокументыКонтролируемыхСделок
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ТаблицаСделок";
	
	ЗапросУдаленияВременныхТаблиц.Выполнить();
	
КонецПроцедуры

#КонецОбласти

//++ НЕ УТ

#Область ДобавлениеСделокСПереработчиком

//++ Устарело_Переработка24

// Добавляет в список контролируемых сделок отчеты переработчика.
//
// Параметры:
//  СтруктураПараметров - Структура - параметры контролируемых сделок:
//  * ВалютаРегламентированногоУчета - СправочникСсылка.Валюты - валюта регламетированного учета.
//  * НачалоПериода                  - Дата - начало периода формирования списка контролируемых сделок.
//  * ОкончаниеПериода               - Дата - окончание периода формирования списка контролируемых сделок.
//  * Организация                    - СправочникСсылка.Организации - код места представления.
//  * СписокПодчиненныхОрганизаций   - СписокЗначений из СправочникСсылка.Организации - список подчиненных организаций.
//  МенеджерВременныхТаблиц          - МенеджерВременныхТаблиц - временные таблицы запроса по контролируемым сделкам.
//  ТаблицаСделок                    - ТаблицаЗначений - таблица значений с данными о контролируемых сделках.
//
Процедура ДобавитьСделкиОтчетаПереработчика(СтруктураПараметров, МенеджерВременныхТаблиц, ТаблицаСделок)
	
	Запрос = ПодготовитьЗапросКДокументамИсточникам(СтруктураПараметров);
	Запрос.УстановитьПараметр("ИспользованиеДоговоров", ПолучитьФункциональнуюОпцию("ИспользоватьДоговорыСПоставщиками"));
	Запрос.МенеджерВременныхТаблиц = МенеджерВременныхТаблиц;
	Запрос.Текст =
	"ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	ОтчетПереработчика.Ссылка КАК РасчетныйДокумент,
	|	ОтчетПереработчика.Дата КАК Период,
	|	ОтчетПереработчика.Организация КАК Организация,
	|	ОтчетПереработчика.Контрагент,
	|	ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка) КАК Комиссионер,
	|	ОтчетПереработчика.Содержание КАК ПредметСделки,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.РаботаУслуга) КАК ТипПредметаСделки,
	|	ОтчетПереработчика.Содержание КАК НаименованиеПредметаСделки,
	|	ЗНАЧЕНИЕ(Справочник.СтраныМира.ПустаяСсылка) КАК СтранаПроисхожденияПредметаСделки,
	|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперацииКонтролируемыхСделок.ПолучениеУслуг) КАК ХозяйственнаяОперация,
	|	ОтчетПереработчика.Валюта,
	|	&ЕдиницаИзмеренияШтука КАК ЕдиницаИзмерения,
	|	1 КАК Количество,
	|	ОтчетПереработчика.СтавкаНДС,
	|	ОтчетПереработчика.СуммаСНДС - ОтчетПереработчика.СуммаНДС КАК СуммаБезНДС,
	|	ОтчетПереработчика.СуммаНДС,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыКонтролируемыхСделок.ОсуществленРасход) КАК ТипКонтролируемойСделки,
	|	ЛОЖЬ КАК ТоварМировойБиржевойТорговли,
	|	ЛОЖЬ КАК ОперацияОблагаетсяЕНВД,
	|	НЕОПРЕДЕЛЕНО КАК Грузоотправитель,
	|	ОтчетПереработчика.Организация КАК Грузополучатель,
	|	ВЫБОР
	|		КОГДА &ИспользованиеДоговоров
	|			ТОГДА ОтчетПереработчика.Договор
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК Договор,
	|	НЕОПРЕДЕЛЕНО КАК Соглашение,
	|	ОтчетПереработчика.Ссылка КАК РегистраторРегистраСумм,
	|	1 КАК МножительСуммовыхДанных,
	|	"""" КАК ИдентификаторСтроки
	|ПОМЕСТИТЬ ТаблицаСделок
	|ИЗ
	|	Документ.ОтчетПереработчика КАК ОтчетПереработчика
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВзаимозависимыеЛицаПоПериодам КАК ВзаимозависимыеЛицаПоПериодам
	|		ПО (ВзаимозависимыеЛицаПоПериодам.Организация = &Организация)
	|			И (ВзаимозависимыеЛицаПоПериодам.Контрагент = ОтчетПереработчика.Контрагент)
	|			И ОтчетПереработчика.Дата >= ВзаимозависимыеЛицаПоПериодам.НачалоПериода
	|			И ОтчетПереработчика.Дата <= ВзаимозависимыеЛицаПоПериодам.ОкончаниеПериода
	|		ЛЕВОЕ СОЕДИНЕНИЕ ИностранныеКонтрагенты КАК ИностранныеКонтрагенты
	|		ПО (ИностранныеКонтрагенты.Контрагент = ОтчетПереработчика.Контрагент)
	|ГДЕ
	|	ОтчетПереработчика.Организация В(&СтруктураОрганизации)
	|	И ОтчетПереработчика.Дата >= &НачалоПериода
	|	И ОтчетПереработчика.Дата <= &ОкончаниеПериода
	|	И ОтчетПереработчика.Проведен = ИСТИНА
	|	И ОтчетПереработчика.Контрагент В
	|			(ВЫБРАТЬ
	|				КонтролируемыеКонтрагенты.Контрагент
	|			ИЗ
	|				КонтролируемыеКонтрагенты КАК КонтролируемыеКонтрагенты)
	|	И (НЕ ВзаимозависимыеЛицаПоПериодам.Контрагент ЕСТЬ NULL 
	|			ИЛИ ЕСТЬNULL(ИностранныеКонтрагенты.ЗарегистрированВСтранеСЛьготнымНалогообложением, ЛОЖЬ))
	|	И ВЫБОР
	|			КОГДА ОтчетПереработчика.Договор = ЗНАЧЕНИЕ(Справочник.ДоговорыКонтрагентов.ПустаяСсылка)
	|				ТОГДА ИСТИНА
	|			ИНАЧЕ ОтчетПереработчика.Договор.ТипДоговора = ЗНАЧЕНИЕ(Перечисление.ТипыДоговоров.СПереработчиком)
	|		КОНЕЦ
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	РегистраторРегистраСумм,
	|	ИдентификаторСтроки";
	
	Запрос.Выполнить();
	
	ВыборкаСделокРеализации = ПолучитьВыборкуТаблицыСделокСПреобразованиемСуммКРублевым(Запрос.МенеджерВременныхТаблиц);
	
	Пока ВыборкаСделокРеализации.Следующий() Цикл
		СтрокаСделки = ТаблицаСделок.Добавить();
		ЗаполнитьЗначенияСвойств(СтрокаСделки, ВыборкаСделокРеализации);
	КонецЦикла;
	
	ЗапросУдаленияВременныхТаблиц = Новый Запрос();
	ЗапросУдаленияВременныхТаблиц.МенеджерВременныхТаблиц = Запрос.МенеджерВременныхТаблиц;
	ЗапросУдаленияВременныхТаблиц.Текст = 
	"
	|УНИЧТОЖИТЬ ТаблицаСделок";
	
	ЗапросУдаленияВременныхТаблиц.Выполнить();
	
КонецПроцедуры
//-- Устарело_Переработка24

// Добавляет в список контролируемых сделок отчеты переработчика версии 2.5.
//
// Параметры:
//  СтруктураПараметров - Структура - параметры контролируемых сделок:
//  * ВалютаРегламентированногоУчета - СправочникСсылка.Валюты - валюта регламетированного учета.
//  * НачалоПериода                  - Дата - начало периода формирования списка контролируемых сделок.
//  * ОкончаниеПериода               - Дата - окончание периода формирования списка контролируемых сделок.
//  * Организация                    - СправочникСсылка.Организации - код места представления.
//  * СписокПодчиненныхОрганизаций   - СписокЗначений из СправочникСсылка.Организации - список подчиненных организаций.
//  МенеджерВременныхТаблиц          - МенеджерВременныхТаблиц - временные таблицы запроса по контролируемым сделкам.
//  ТаблицаСделок                    - ТаблицаЗначений - таблица значений с данными о контролируемых сделках.
//
Процедура ДобавитьСделкиОтчетаПереработчика2_5(СтруктураПараметров, МенеджерВременныхТаблиц, ТаблицаСделок)
	
	Запрос = ПодготовитьЗапросКДокументамИсточникам(СтруктураПараметров);
	Запрос.УстановитьПараметр("ИспользованиеДоговоров", ПолучитьФункциональнуюОпцию("ИспользоватьДоговорыСПоставщиками"));
	Запрос.МенеджерВременныхТаблиц = МенеджерВременныхТаблиц;
	Запрос.Текст =
	"ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	ТаблицаУслуг.Ссылка КАК РасчетныйДокумент,
	|	ТаблицаУслуг.Ссылка.Дата КАК Период,
	|	ТаблицаУслуг.Ссылка.Организация КАК Организация,
	|	ТаблицаУслуг.Ссылка.Контрагент,
	|	ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка) КАК Комиссионер,
	|	ТаблицаУслуг.Номенклатура КАК ПредметСделки,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.РаботаУслуга) КАК ТипПредметаСделки,
	|	ТаблицаУслуг.Номенклатура.НаименованиеПолное КАК НаименованиеПредметаСделки,
	|	ЗНАЧЕНИЕ(Справочник.СтраныМира.ПустаяСсылка) КАК СтранаПроисхожденияПредметаСделки,
	|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперацииКонтролируемыхСделок.ПолучениеУслуг) КАК ХозяйственнаяОперация,
	|	ТаблицаУслуг.Ссылка.Валюта КАК Валюта,
	|	&ЕдиницаИзмеренияШтука КАК ЕдиницаИзмерения,
	|	ТаблицаУслуг.Количество КАК Количество,
	|	ТаблицаУслуг.СтавкаНДС КАК СтавкаНДС,
	|	ТаблицаУслуг.СуммаСНДС - ТаблицаУслуг.СуммаНДС КАК СуммаБезНДС,
	|	ТаблицаУслуг.СуммаНДС КАК СуммаНДС,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыКонтролируемыхСделок.ОсуществленРасход) КАК ТипКонтролируемойСделки,
	|	ЛОЖЬ КАК ТоварМировойБиржевойТорговли,
	|	ЛОЖЬ КАК ОперацияОблагаетсяЕНВД,
	|	НЕОПРЕДЕЛЕНО КАК Грузоотправитель,
	|	ТаблицаУслуг.Ссылка.Организация КАК Грузополучатель,
	|	ТаблицаУслуг.Ссылка.Договор КАК Договор,
	|	НЕОПРЕДЕЛЕНО КАК Соглашение,
	|	ТаблицаУслуг.Ссылка КАК РегистраторРегистраСумм,
	|	1 КАК МножительСуммовыхДанных,
	|	"""" КАК ИдентификаторСтроки
	|ПОМЕСТИТЬ ТаблицаСделок
	|ИЗ
	|	Документ.ОтчетПереработчика2_5.Услуги КАК ТаблицаУслуг
	|
	|	ЛЕВОЕ СОЕДИНЕНИЕ ВзаимозависимыеЛицаПоПериодам КАК ВзаимозависимыеЛицаПоПериодам
	|	ПО (ВзаимозависимыеЛицаПоПериодам.Организация = &Организация)
	|	И (ВзаимозависимыеЛицаПоПериодам.Контрагент = ТаблицаУслуг.Ссылка.Контрагент)
	|	И ТаблицаУслуг.Ссылка.Дата >= ВзаимозависимыеЛицаПоПериодам.НачалоПериода
	|	И ТаблицаУслуг.Ссылка.Дата <= ВзаимозависимыеЛицаПоПериодам.ОкончаниеПериода
	|	
	|	ЛЕВОЕ СОЕДИНЕНИЕ ИностранныеКонтрагенты КАК ИностранныеКонтрагенты
	|	ПО (ИностранныеКонтрагенты.Контрагент = ТаблицаУслуг.Ссылка.Контрагент)
	|	
	|ГДЕ
	|	ТаблицаУслуг.Ссылка.Организация В(&СтруктураОрганизации)
	|	И ТаблицаУслуг.Ссылка.Дата >= &НачалоПериода
	|	И ТаблицаУслуг.Ссылка.Дата <= &ОкончаниеПериода
	|	И ТаблицаУслуг.Ссылка.Проведен = ИСТИНА
	|	И ТаблицаУслуг.Ссылка.Контрагент В
	|			(ВЫБРАТЬ
	|				КонтролируемыеКонтрагенты.Контрагент
	|			ИЗ
	|				КонтролируемыеКонтрагенты КАК КонтролируемыеКонтрагенты)
	|	И (НЕ ВзаимозависимыеЛицаПоПериодам.Контрагент ЕСТЬ NULL 
	|			ИЛИ ЕСТЬNULL(ИностранныеКонтрагенты.ЗарегистрированВСтранеСЛьготнымНалогообложением, ЛОЖЬ))
	|	И (ТаблицаУслуг.Ссылка.Договор.ТипДоговора = ЗНАЧЕНИЕ(Перечисление.ТипыДоговоров.СПереработчиком2_5)
	|		ИЛИ ТаблицаУслуг.Ссылка.Договор.ТипДоговора = ЗНАЧЕНИЕ(Перечисление.ТипыДоговоров.СПереработчиком2_5_ЕАЭС))
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	РегистраторРегистраСумм,
	|	ИдентификаторСтроки";
	
	Запрос.Выполнить();
	
	ВыборкаСделокРеализации = ПолучитьВыборкуТаблицыСделокСПреобразованиемСуммКРублевым(Запрос.МенеджерВременныхТаблиц);
	
	Пока ВыборкаСделокРеализации.Следующий() Цикл
		СтрокаСделки = ТаблицаСделок.Добавить();
		ЗаполнитьЗначенияСвойств(СтрокаСделки, ВыборкаСделокРеализации);
	КонецЦикла;
	
	ЗапросУдаленияВременныхТаблиц = Новый Запрос();
	ЗапросУдаленияВременныхТаблиц.МенеджерВременныхТаблиц = Запрос.МенеджерВременныхТаблиц;
	ЗапросУдаленияВременныхТаблиц.Текст = 
	"
	|УНИЧТОЖИТЬ ТаблицаСделок";
	
	ЗапросУдаленияВременныхТаблиц.Выполнить();
	
КонецПроцедуры

#КонецОбласти

//++ НЕ УТКА

#Область ДобавлениеСделокСДавальцем
//++ Устарело_Переработка24

// Добавляет в список контролируемых сделок отчеты давальцу.
//
// Параметры:
//  СтруктураПараметров - Структура - параметры контролируемых сделок:
//  * ВалютаРегламентированногоУчета - СправочникСсылка.Валюты - валюта регламетированного учета.
//  * НачалоПериода                  - Дата - начало периода формирования списка контролируемых сделок.
//  * ОкончаниеПериода               - Дата - окончание периода формирования списка контролируемых сделок.
//  * Организация                    - СправочникСсылка.Организации - код места представления.
//  * СписокПодчиненныхОрганизаций   - СписокЗначений из СправочникСсылка.Организации - список подчиненных организаций.
//  МенеджерВременныхТаблиц          - МенеджерВременныхТаблиц - временные таблицы запроса по контролируемым сделкам.
//  ТаблицаСделок                    - ТаблицаЗначений - таблица значений с данными о контролируемых сделках.
//
Процедура ДобавитьСделкиОтчетаДавальцу(СтруктураПараметров, МенеджерВременныхТаблиц, ТаблицаСделок)
	
	Запрос = ПодготовитьЗапросКДокументамИсточникам(СтруктураПараметров);
	Запрос.УстановитьПараметр("ИспользованиеДоговоров", ПолучитьФункциональнуюОпцию("ИспользоватьДоговорыСПоставщиками"));
	Запрос.МенеджерВременныхТаблиц = МенеджерВременныхТаблиц;
	Запрос.Текст =
	"ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	ОтчетДавальцу.Ссылка КАК РасчетныйДокумент,
	|	ВЫБОР
	|		КОГДА ВзаимозависимыеЛицаПоПериодам.Контрагент ЕСТЬ NULL 
	|			ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА
	|	КОНЕЦ КАК ВзаимозависимыеЛица,
	|	ВЫБОР
	|		КОГДА ИностранныеКонтрагенты.Контрагент ЕСТЬ NULL 
	|			ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА
	|	КОНЕЦ КАК ИностранныйКонтрагент,
	|	ЕСТЬNULL(ИностранныеКонтрагенты.ЗарегистрированВСтранеСЛьготнымНалогообложением, ЛОЖЬ) КАК ЗарегистрированВСтранеСЛьготнымНалогообложением
	|ПОМЕСТИТЬ ДокументыКонтролируемыхСделок
	|ИЗ
	|	Документ.ОтчетДавальцу КАК ОтчетДавальцу
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВзаимозависимыеЛицаПоПериодам КАК ВзаимозависимыеЛицаПоПериодам
	|		ПО (ВзаимозависимыеЛицаПоПериодам.Организация = &Организация)
	|			И (ВзаимозависимыеЛицаПоПериодам.Контрагент = ОтчетДавальцу.Контрагент)
	|			И ОтчетДавальцу.Дата >= ВзаимозависимыеЛицаПоПериодам.НачалоПериода
	|			И ОтчетДавальцу.Дата <= ВзаимозависимыеЛицаПоПериодам.ОкончаниеПериода
	|		ЛЕВОЕ СОЕДИНЕНИЕ ИностранныеКонтрагенты КАК ИностранныеКонтрагенты
	|		ПО (ИностранныеКонтрагенты.Контрагент = ОтчетДавальцу.Контрагент)
	|ГДЕ
	|	ОтчетДавальцу.Организация В(&СтруктураОрганизации)
	|	И ОтчетДавальцу.Дата >= &НачалоПериода
	|	И ОтчетДавальцу.Дата <= &ОкончаниеПериода
	|	И ОтчетДавальцу.Проведен = ИСТИНА
	|	И ОтчетДавальцу.Контрагент В
	|			(ВЫБРАТЬ
	|				КонтролируемыеКонтрагенты.Контрагент
	|			ИЗ
	|				КонтролируемыеКонтрагенты КАК КонтролируемыеКонтрагенты)
	|	И (НЕ ВзаимозависимыеЛицаПоПериодам.Контрагент ЕСТЬ NULL 
	|			ИЛИ ЕСТЬNULL(ИностранныеКонтрагенты.ЗарегистрированВСтранеСЛьготнымНалогообложением, ЛОЖЬ))
	|	И ВЫБОР
	|			КОГДА ОтчетДавальцу.Договор = ЗНАЧЕНИЕ(Справочник.ДоговорыКонтрагентов.ПустаяСсылка)
	|				ТОГДА ИСТИНА
	|			ИНАЧЕ ОтчетДавальцу.Договор.ТипДоговора = ЗНАЧЕНИЕ(Перечисление.ТипыДоговоров.СДавальцем)
	|		КОНЕЦ
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	РасчетныйДокумент
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	ОтчетДавальцуПродукция.Ссылка КАК РасчетныйДокумент,
	|	ОтчетДавальцуПродукция.Ссылка.Дата КАК Период,
	|	ОтчетДавальцуПродукция.Ссылка.Организация,
	|	ОтчетДавальцуПродукция.Ссылка.Контрагент,
	|	ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка) КАК Комиссионер,
	|	ОтчетДавальцуПродукция.Ссылка.Номенклатура КАК ПредметСделки,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.РаботаУслуга) КАК ТипПредметаСделки,
	|	ОтчетДавальцуПродукция.Ссылка.Содержание КАК НаименованиеПредметаСделки,
	|	ЗНАЧЕНИЕ(Справочник.СтраныМира.ПустаяСсылка) КАК СтранаПроисхожденияПредметаСделки,
	|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперацииКонтролируемыхСделок.РеализацияСобственныхУслуг) КАК ХозяйственнаяОперация,
	|	ОтчетДавальцуПродукция.Ссылка.Валюта,
	|	ОтчетДавальцуПродукция.Ссылка.Номенклатура.ЕдиницаИзмерения КАК ЕдиницаИзмерения,
	|	1 КАК Количество,
	|	ОтчетДавальцуПродукция.СтавкаНДС,
	|	ОтчетДавальцуПродукция.СуммаСНДС - ОтчетДавальцуПродукция.СуммаНДС КАК СуммаБезНДС,
	|	ОтчетДавальцуПродукция.СуммаНДС,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыКонтролируемыхСделок.ПолученДоход) КАК ТипКонтролируемойСделки,
	|	ЛОЖЬ КАК ТоварМировойБиржевойТорговли,
	|	ВЫБОР
	|		КОГДА ОтчетДавальцуПродукция.Ссылка.НалогообложениеНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаОблагаетсяЕНВД)
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ КАК ОперацияОблагаетсяЕНВД,
	|	НЕОПРЕДЕЛЕНО КАК Грузоотправитель,
	|	ОтчетДавальцуПродукция.Ссылка.Контрагент КАК Грузополучатель,
	|	ВЫБОР
	|		КОГДА &ИспользованиеДоговоров
	|			ТОГДА ОтчетДавальцуПродукция.Ссылка.Договор
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК Договор,
	|	НЕОПРЕДЕЛЕНО КАК Соглашение,
	|	ОтчетДавальцуПродукция.Ссылка КАК РегистраторРегистраСумм,
	|	1 КАК МножительСуммовыхДанных,
	|	ОтчетДавальцуПродукция.ИдентификаторСтроки КАК ИдентификаторСтроки
	|ПОМЕСТИТЬ ТаблицаСделок
	|ИЗ
	|	ДокументыКонтролируемыхСделок КАК ДокументыКонтролируемыхСделок
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ОтчетДавальцу.Продукция КАК ОтчетДавальцуПродукция
	|		ПО ДокументыКонтролируемыхСделок.РасчетныйДокумент = ОтчетДавальцуПродукция.Ссылка
	|ГДЕ
	|	(ДокументыКонтролируемыхСделок.ВзаимозависимыеЛица
	|			ИЛИ ДокументыКонтролируемыхСделок.ЗарегистрированВСтранеСЛьготнымНалогообложением)
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	РегистраторРегистраСумм,
	|	ИдентификаторСтроки";
	
	Запрос.Выполнить();
	
	ВыборкаСделокРеализации = ПолучитьВыборкуТаблицыСделокСПреобразованиемСуммКРублевым(Запрос.МенеджерВременныхТаблиц);
	
	Пока ВыборкаСделокРеализации.Следующий() Цикл
		СтрокаСделки = ТаблицаСделок.Добавить();
		ЗаполнитьЗначенияСвойств(СтрокаСделки, ВыборкаСделокРеализации);
	КонецЦикла;
	
	ЗапросУдаленияВременныхТаблиц = Новый Запрос();
	ЗапросУдаленияВременныхТаблиц.МенеджерВременныхТаблиц = Запрос.МенеджерВременныхТаблиц;
	ЗапросУдаленияВременныхТаблиц.Текст = 
	"УНИЧТОЖИТЬ ДокументыКонтролируемыхСделок
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ТаблицаСделок";
	
	ЗапросУдаленияВременныхТаблиц.Выполнить();
	
КонецПроцедуры
//-- Устарело_Переработка24

// Добавляет в список контролируемых сделок отчеты отчеты давальцу версии 2.5.
//
// Параметры:
//  СтруктураПараметров - Структура - параметры контролируемых сделок:
//  * ВалютаРегламентированногоУчета - СправочникСсылка.Валюты - валюта регламетированного учета.
//  * НачалоПериода                  - Дата - начало периода формирования списка контролируемых сделок.
//  * ОкончаниеПериода               - Дата - окончание периода формирования списка контролируемых сделок.
//  * Организация                    - СправочникСсылка.Организации - код места представления.
//  * СписокПодчиненныхОрганизаций   - СписокЗначений из СправочникСсылка.Организации - список подчиненных организаций.
//  МенеджерВременныхТаблиц          - МенеджерВременныхТаблиц - временные таблицы запроса по контролируемым сделкам.
//  ТаблицаСделок                    - ТаблицаЗначений - таблица значений с данными о контролируемых сделках.
//
Процедура ДобавитьСделкиОтчетаДавальцу2_5(СтруктураПараметров, МенеджерВременныхТаблиц, ТаблицаСделок)
	
	Запрос = ПодготовитьЗапросКДокументамИсточникам(СтруктураПараметров);
	Запрос.УстановитьПараметр("ИспользованиеДоговоров", ПолучитьФункциональнуюОпцию("ИспользоватьДоговорыСПоставщиками"));
	Запрос.МенеджерВременныхТаблиц = МенеджерВременныхТаблиц;
	Запрос.Текст =
	"ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	ОтчетДавальцу2_5.Ссылка                               КАК РасчетныйДокумент,
	|	ВзаимозависимыеЛицаПоПериодам.Контрагент ЕСТЬ НЕ NULL КАК ВзаимозависимыеЛица,
	|	ИностранныеКонтрагенты.Контрагент ЕСТЬ НЕ NULL        КАК ИностранныйКонтрагент,
	|	ЕСТЬNULL(ИностранныеКонтрагенты.ЗарегистрированВСтранеСЛьготнымНалогообложением, ЛОЖЬ) КАК ЗарегистрированВСтранеСЛьготнымНалогообложением
	|ПОМЕСТИТЬ ДокументыКонтролируемыхСделок
	|ИЗ
	|	Документ.ОтчетДавальцу2_5 КАК ОтчетДавальцу2_5
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВзаимозависимыеЛицаПоПериодам КАК ВзаимозависимыеЛицаПоПериодам
	|		ПО (ВзаимозависимыеЛицаПоПериодам.Организация = &Организация)
	|			И (ВзаимозависимыеЛицаПоПериодам.Контрагент = ОтчетДавальцу2_5.Контрагент)
	|			И ОтчетДавальцу2_5.Дата >= ВзаимозависимыеЛицаПоПериодам.НачалоПериода
	|			И ОтчетДавальцу2_5.Дата <= ВзаимозависимыеЛицаПоПериодам.ОкончаниеПериода
	|		ЛЕВОЕ СОЕДИНЕНИЕ ИностранныеКонтрагенты КАК ИностранныеКонтрагенты
	|		ПО (ИностранныеКонтрагенты.Контрагент = ОтчетДавальцу2_5.Контрагент)
	|ГДЕ
	|	ОтчетДавальцу2_5.Организация В(&СтруктураОрганизации)
	|	И ОтчетДавальцу2_5.Дата >= &НачалоПериода
	|	И ОтчетДавальцу2_5.Дата <= &ОкончаниеПериода
	|	И ОтчетДавальцу2_5.Проведен
	|	И ОтчетДавальцу2_5.Контрагент В
	|			(ВЫБРАТЬ
	|				КонтролируемыеКонтрагенты.Контрагент
	|			ИЗ
	|				КонтролируемыеКонтрагенты КАК КонтролируемыеКонтрагенты)
	|	И (НЕ ВзаимозависимыеЛицаПоПериодам.Контрагент ЕСТЬ NULL 
	|			ИЛИ ЕСТЬNULL(ИностранныеКонтрагенты.ЗарегистрированВСтранеСЛьготнымНалогообложением, ЛОЖЬ))
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	РасчетныйДокумент
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	ОтчетДавальцу2_5Продукция.Ссылка                                         КАК РасчетныйДокумент,
	|	ОтчетДавальцу2_5Продукция.Ссылка.Дата                                    КАК Период,
	|	ОтчетДавальцу2_5Продукция.Ссылка.Организация                             КАК Организация,
	|	ОтчетДавальцу2_5Продукция.Ссылка.Контрагент                              КАК Контрагент,
	|	ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)                            КАК Комиссионер,
	|	НЕОПРЕДЕЛЕНО                                                             КАК ПредметСделки,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.РаботаУслуга)    КАК ТипПредметаСделки,
	|	ОтчетДавальцу2_5Продукция.Ссылка.УслугаПоПереработке                     КАК НаименованиеПредметаСделки,
	|	ЗНАЧЕНИЕ(Справочник.СтраныМира.ПустаяСсылка)                             КАК СтранаПроисхожденияПредметаСделки,
	|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперацииКонтролируемыхСделок.РеализацияСобственныхУслуг) КАК ХозяйственнаяОперация,
	|	ОтчетДавальцу2_5Продукция.Ссылка.Валюта                                  КАК Валюта,
	|	НЕОПРЕДЕЛЕНО                                                             КАК ЕдиницаИзмерения,
	|	1                                                                        КАК Количество,
	|	ОтчетДавальцу2_5Продукция.Ссылка.СтавкаНДС                               КАК СтавкаНДС,
	|	ОтчетДавальцу2_5Продукция.СуммаСНДС - ОтчетДавальцу2_5Продукция.СуммаНДС КАК СуммаБезНДС,
	|	ОтчетДавальцу2_5Продукция.СуммаНДС                                       КАК СуммаНДС,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыКонтролируемыхСделок.ПолученДоход)             КАК ТипКонтролируемойСделки,
	|	ЛОЖЬ                                                                     КАК ТоварМировойБиржевойТорговли,
	|	ОтчетДавальцу2_5Продукция.Ссылка.НалогообложениеНДС =
	|		ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаОблагаетсяЕНВД)  КАК ОперацияОблагаетсяЕНВД,
	|	НЕОПРЕДЕЛЕНО                                                             КАК Грузоотправитель,
	|	ОтчетДавальцу2_5Продукция.Ссылка.Контрагент                              КАК Грузополучатель,
	|	ВЫБОР
	|		КОГДА &ИспользованиеДоговоров
	|			ТОГДА ОтчетДавальцу2_5Продукция.Ссылка.Договор
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ                                                                    КАК Договор,
	|	НЕОПРЕДЕЛЕНО                                                             КАК Соглашение,
	|	ОтчетДавальцу2_5Продукция.Ссылка                                         КАК РегистраторРегистраСумм,
	|	1                                                                        КАК МножительСуммовыхДанных,
	|	ОтчетДавальцу2_5Продукция.ИдентификаторСтроки                            КАК ИдентификаторСтроки
	|ПОМЕСТИТЬ ТаблицаСделок
	|ИЗ
	|	ДокументыКонтролируемыхСделок КАК ДокументыКонтролируемыхСделок
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ОтчетДавальцу2_5.Продукция КАК ОтчетДавальцу2_5Продукция
	|		ПО ДокументыКонтролируемыхСделок.РасчетныйДокумент = ОтчетДавальцу2_5Продукция.Ссылка
	|ГДЕ
	|	(ДокументыКонтролируемыхСделок.ВзаимозависимыеЛица
	|			ИЛИ ДокументыКонтролируемыхСделок.ЗарегистрированВСтранеСЛьготнымНалогообложением)
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	РегистраторРегистраСумм,
	|	ИдентификаторСтроки";
	
	Запрос.Выполнить();
	
	ВыборкаСделокРеализации = ПолучитьВыборкуТаблицыСделокСПреобразованиемСуммКРублевым(Запрос.МенеджерВременныхТаблиц);
	
	Пока ВыборкаСделокРеализации.Следующий() Цикл
		СтрокаСделки = ТаблицаСделок.Добавить();
		ЗаполнитьЗначенияСвойств(СтрокаСделки, ВыборкаСделокРеализации);
	КонецЦикла;
	
	ЗапросУдаленияВременныхТаблиц = Новый Запрос();
	ЗапросУдаленияВременныхТаблиц.МенеджерВременныхТаблиц = Запрос.МенеджерВременныхТаблиц;
	ЗапросУдаленияВременныхТаблиц.Текст = 
	"УНИЧТОЖИТЬ ДокументыКонтролируемыхСделок
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ТаблицаСделок";
	
	ЗапросУдаленияВременныхТаблиц.Выполнить();
	
КонецПроцедуры

#КонецОбласти

//-- НЕ УТКА

//-- НЕ УТ

#КонецОбласти

#Область ПараметрыДляРегламентированнойОтчетности

// Получить сведения об уведомлении.
// 
// Параметры:
//  Уведомление - ДокументСсылка.УведомлениеОКонтролируемыхСделках - Уведомление
// 
// Возвращаемое значение:
//  Структура - Получить сведения об уведомлении (на примере уведомления за 2024 год):
//  * ВерсияУведомления               - Число - номер версии уведомления.
//  * ИндивидуальныйПредприниматель   - СправочникСсылка.ФизическиеЛица - индивидуальный предприниматель.
//  * ИНН                             - Строка - ИНН организации или ИП.
//  * КодМестаПредставления           - Строка - код места представления.
//  * КПП                             - Строка - КПП организации.
//  * КрупнейшийНалогоплательщик      - Булево - Истина, если организация является крупнейшим налогоплательщиком.
//  * НаименованиеОрганизации         - Строка - наименование организации.
//  * НомерКорректировки              - Число - номер корректировки уведомления.
//  * Организация                     - СправочникСсылка.Организации - организация, подающая уведомление.
//  * ОтчетныйГод                     - Дата - отчетный год, за который подается уведомление.
//  * ПараметрыВерсии                 - Структура - Структура измерений:
//    * ДлинаНомераЛистовРаздела1     - Число - длина номера листов раздел 1 уведомления.
//    * ДлинаНомераСтраница           - Число - длина номера страницы.
//    * Макеты                        - Структура - Структура измерений:
//      * Лист1А                      - Строка - наименование макета листа 1А.
//      * Лист1Б                      - Строка - наименование макета листа 1Б.
//      * Лист1В                      - Строка - наименование макета листа 1В.
//      * Лист1Г                      - Строка - наименование макета листа 1Г.
//      * Раздел2                     - Строка - наименование макета раздела 2.
//      * Раздел3                     - Строка - наименование макета раздела 3.
//      * Раздел4                     - Строка - наименование макета раздела 4.
//      * ТитульныйЛист               - Строка - наименование макета титульноо листа.
//      * ТитульныйЛистФизическоеЛицо - Строка - наименование макета физического лица на титульном листе.
Функция ПолучитьСведенияОбУведомлении(Уведомление) Экспорт
	
	Реквизиты = Новый Структура();
	Реквизиты.Вставить("Уведомление", "Ссылка");
	Реквизиты.Вставить("КодМестаПредставления", "КодМестаПредставления");
	Реквизиты.Вставить("Организация", "Организация");
	Реквизиты.Вставить("НаименованиеОрганизации", "Организация.НаименованиеПолное");
	Реквизиты.Вставить("ИНН", "Организация.ИНН");
	Реквизиты.Вставить("КПП", "Организация.КПП");
	Реквизиты.Вставить("КрупнейшийНалогоплательщик", "Организация.КрупнейшийНалогоплательщик");
	Реквизиты.Вставить("ОтчетныйГод", "ОтчетныйГод");
	Реквизиты.Вставить("ВерсияУведомления", "ВерсияУведомления");
	Реквизиты.Вставить("ЮридическоеФизическоеЛицо", "Организация.ЮридическоеФизическоеЛицо");
	Реквизиты.Вставить("НомерКорректировки", "НомерКорректировки");
	Реквизиты.Вставить("ИндивидуальныйПредприниматель", "Организация.ИндивидуальныйПредприниматель");
	Реквизиты.Вставить("ВерсияУведомления", "ВерсияУведомления");
	
	Сведения = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(Уведомление, Реквизиты);
	
	ДатаСведений = ТекущаяДатаСеанса();

	Если Сведения.ЮридическоеФизическоеЛицо = Перечисления.ЮридическоеФизическоеЛицо.ФизическоеЛицо
		И ЗначениеЗаполнено(Сведения.ИндивидуальныйПредприниматель) Тогда
	
		Сведения.Вставить("ИндивидуальныйПредпринимательФИО", ПолучитьФИОФизлица(Сведения.ИндивидуальныйПредприниматель, ДатаСведений));
		
	КонецЕсли;
	
	Если НЕ ЗначениеЗаполнено(Сведения.ВерсияУведомления) Тогда
		Сведения.ВерсияУведомления = КонтролируемыеСделкиКлиентСервер.ВерсияУведомления_2012();
	КонецЕсли;
	
	Сведения.Вставить("ПараметрыВерсии", ПараметрыВерсииУведомления(Сведения.ВерсияУведомления));
	
	Возврат Сведения;
	
КонецФункции  

// Код места представления крупнейший.
// 
// Возвращаемое значение:
//  Строка - Код места представления крупнейший
Функция КодМестаПредставленияКрупнейший() Экспорт
	Возврат "213";
КонецФункции

// Возвращает параметры печати уведомление о контралируемых сделках взависимости от версии уведомления.
//
// Параметры:
//  Версия - Число - код версии уведомления о контролируемых сделках.
// Возвращаемое значение:
//  Структура - структура параметров печати уведомления о контралируемых сделках.
Функция ПараметрыВерсииУведомления(Версия)
	
	ПараметрыПечати = Новый Структура();
	
	Если Версия >= КонтролируемыеСделкиКлиентСервер.ВерсияУведомления_2024() Тогда
		
		ПараметрыПечати.Вставить("ДлинаНомераСтраница", 3);
		ПараметрыПечати.Вставить("ДлинаНомераЛистовРаздела1", 10);
		
		Макеты = Новый Структура;
		Макеты.Вставить("ТитульныйЛист", "Лист1_2024");
		Макеты.Вставить("ТитульныйЛистФизическоеЛицо", "Лист2_2024");
		Макеты.Вставить("Лист1А", "Страница1А_2024");
		Макеты.Вставить("Лист1Б", "Страница1Б_2024");
		Макеты.Вставить("Лист1В", "Страница1В_2024");
		Макеты.Вставить("Лист1Г", "Страница1Г_2024");
		Макеты.Вставить("Раздел2", "Раздел2_2024");
		Макеты.Вставить("Раздел3", "Раздел3_2024");
		Макеты.Вставить("Раздел4", "Раздел4_2024");
		
		ПараметрыПечати.Вставить("Макеты", Макеты);
		
	ИначеЕсли Версия >= КонтролируемыеСделкиКлиентСервер.ВерсияУведомления_2019() Тогда
		
		ПараметрыПечати.Вставить("ДлинаНомераСтраница", 3);
		ПараметрыПечати.Вставить("ДлинаНомераЛистовРаздела1", 6);
		
		Макеты = Новый Структура;
		Макеты.Вставить("ТитульныйЛист", "Лист1_2019");
		Макеты.Вставить("ТитульныйЛистФизическоеЛицо", "Лист2_2019");
		Макеты.Вставить("Лист1А", "Страница1А_2019");
		Макеты.Вставить("Лист1Б", "Страница1Б_2019");
		Макеты.Вставить("Лист1В", "");
		Макеты.Вставить("Лист1Г", "");
		Макеты.Вставить("Раздел2", "Раздел2_2019");
		Макеты.Вставить("Раздел3", "Раздел3_2019");
		Макеты.Вставить("Раздел4", "");
		
		ПараметрыПечати.Вставить("Макеты", Макеты);
		
	ИначеЕсли Версия >= КонтролируемыеСделкиКлиентСервер.ВерсияУведомления_2018() Тогда
		
		ПараметрыПечати.Вставить("ДлинаНомераСтраница", 3);
		ПараметрыПечати.Вставить("ДлинаНомераЛистовРаздела1", 6);
		
		Макеты = Новый Структура;
		Макеты.Вставить("ТитульныйЛист", "Лист1_2018");
		Макеты.Вставить("ТитульныйЛистФизическоеЛицо", "Лист2_2018");
		Макеты.Вставить("Лист1А", "Страница1А_2018");
		Макеты.Вставить("Лист1Б", "Страница1Б_2018");
		Макеты.Вставить("Лист1В", "");
		Макеты.Вставить("Лист1Г", "");
		Макеты.Вставить("Раздел2", "Раздел2_2018");
		Макеты.Вставить("Раздел3", "Раздел3_2018");
		Макеты.Вставить("Раздел4", "");
		
		ПараметрыПечати.Вставить("Макеты", Макеты);
		
	Иначе
		
		ПараметрыПечати.Вставить("ДлинаНомераСтраница", 5);
		ПараметрыПечати.Вставить("ДлинаНомераЛистовРаздела1", 6);
		
		Макеты = Новый Структура;
		Макеты.Вставить("ТитульныйЛист", "Лист1");
		Макеты.Вставить("ТитульныйЛистФизическоеЛицо", "Лист2");
		Макеты.Вставить("Лист1А", "Страница1А");
		Макеты.Вставить("Лист1Б", "Страница1Б");
		Макеты.Вставить("Лист1В", "");
		Макеты.Вставить("Лист1Г", "");
		Макеты.Вставить("Раздел2", "Раздел2");
		Макеты.Вставить("Раздел3", "Раздел3");
		Макеты.Вставить("Раздел4", "");
		
		ПараметрыПечати.Вставить("Макеты", Макеты);
		
	КонецЕсли;
	
	Возврат ПараметрыПечати;
	
КонецФункции

// Получить основные сведения уведомления для выгрузки.
// 
// Параметры:
//  Уведомление - ДокументСсылка.УведомлениеОКонтролируемыхСделках - Уведомление
// 
// Возвращаемое значение:
//  Структура - Получить основные сведения уведомления для выгрузки:
// * ВерсияУведомления - Число - 
// * Организация - СправочникСсылка.Организации - 
// * ДатаДок - Дата - 
// * НомКорр - Строка - 
// * ПоМесту - Строка - 
// * ВерсПрог - Строка - 
// * ФормРеорг - Строка - 
// * ИННЮЛРеорг - Строка - 
// * КППЮЛРеорг - Строка - 
// * ОтчетГод - Строка - 
// * ОтчетныйГод - Дата - 
// * ОКТМО - Строка - 
// * ОКВЭД - Строка - 
// * Тлф - Строка - 
// * ЭлПочта - Строка, ТаблицаЗначений - :
// ** Объект - ЛюбаяСсылка - 
// ** Вид - СправочникСсылка.ВидыКонтактнойИнформации - 
// ** Тип - ПеречислениеСсылка.ТипыКонтактнойИнформации - 
// ** Значение - Строка - 
// ** Представление - Строка - 
// ** Дата - Дата - 
// ** ИдентификаторСтрокиТабличнойЧасти - Число - 
// ** ЗначенияПолей - Строка - 
// * НаименованиеОрганизации - Строка - 
// * РегистрацияВНалоговомОргане - СправочникСсылка.РегистрацииВНалоговомОргане - 
// * ЭтоПБОЮЛ - Булево - 
// * НаимОрг - Строка - 
// * НаименованиеДляЛиста1 - Строка - 
// * ИННЮЛ - ОпределяемыйТип.ИНН - 
// * КППЮЛ - Строка - 
// * КодНО - Строка - 
// * ИдФайл - Строка - 
Функция ПолучитьОсновныеСведенияУведомленияДляВыгрузки(Уведомление) Экспорт
	
	ОсновныеСведения = Новый Структура;
	
	РеквизитыУведомления = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(Уведомление,
		"Организация, НомерКорректировки, ВерсияУведомления, КодМестаПредставления,
		|ОтчетныйГод, КодФормыРеорганизации, ИННРеорганизованнойОрганизации, КППРеорганизованнойОрганизации");
	
	ВерсияУведомления = РеквизитыУведомления.ВерсияУведомления;
	Организация  = РеквизитыУведомления.Организация;
	ДатаСведений = ТекущаяДатаСеанса();
	
	ОсновныеСведения.Вставить("ВерсияУведомления", ВерсияУведомления);
	ОсновныеСведения.Вставить("Организация", Организация);
	ОсновныеСведения.Вставить("ДатаДок", ДатаСведений);
	ОсновныеСведения.Вставить("НомКорр", Формат(РеквизитыУведомления.НомерКорректировки, "ЧН=; ЧГ=0"));
	ОсновныеСведения.Вставить("ПоМесту", РеквизитыУведомления.КодМестаПредставления);
	ОсновныеСведения.Вставить("ВерсПрог", РегламентированнаяОтчетность.НазваниеИВерсияПрограммы());
	
	Если РеквизитыУведомления.КодФормыРеорганизации <> "" Тогда
		ОсновныеСведения.Вставить("ФормРеорг",  РеквизитыУведомления.КодФормыРеорганизации);
		ОсновныеСведения.Вставить("ИННЮЛРеорг", РеквизитыУведомления.ИННРеорганизованнойОрганизации);
		ОсновныеСведения.Вставить("КППЮЛРеорг", РеквизитыУведомления.КППРеорганизованнойОрганизации);
	КонецЕсли;
	
	ОтчетГод = Формат(РеквизитыУведомления.ОтчетныйГод, "ДФ=yyyy");
	ОсновныеСведения.Вставить("ОтчетГод", ОтчетГод);
	ОсновныеСведения.Вставить("ОтчетныйГод", РеквизитыУведомления.ОтчетныйГод);
	
	ПараметрыОрганизации = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(Организация,
		"ИНН, КПП, НаименованиеПолное, КодНалоговогоОргана, ЮридическоеФизическоеЛицо, ИндивидуальныйПредприниматель,
		|КодОКВЭД, КодОКВЭД2, РегистрацияВНалоговомОргане, КрупнейшийНалогоплательщик");
	
	ОрганизацияФизЛицо = ПараметрыОрганизации.ЮридическоеФизическоеЛицо = Перечисления.ЮридическоеФизическоеЛицо.ФизическоеЛицо;
	
	ТелефонОрганизации = УправлениеКонтактнойИнформацией.КонтактнаяИнформацияОбъекта(
				Организация, ?(ОрганизацияФизЛицо, Справочники.ВидыКонтактнойИнформации.ТелефонРабочийФизическиеЛица, Справочники.ВидыКонтактнойИнформации.ТелефонОрганизации), ДатаСведений);
	ЭлектроннаяПочтаОрганизации = ?(ОрганизацияФизЛицо, "", УправлениеКонтактнойИнформацией.КонтактнаяИнформацияОбъекта(Организация, Справочники.ВидыКонтактнойИнформации.EmailОрганизации, ДатаСведений));
	
	ТелефонОрганизации = СтрЗаменить(ТелефонОрганизации, " ", "");
	
	ОКАТО = "";
	ОКТМО = "";
	
	Если ЗначениеЗаполнено(ПараметрыОрганизации.РегистрацияВНалоговомОргане) Тогда
		ОКАТО = СокрЛП(ОбщегоНазначения.ЗначениеРеквизитаОбъекта(ПараметрыОрганизации.РегистрацияВНалоговомОргане, "КодПоОКАТО"));
		ОКТМО = СокрЛП(ОбщегоНазначения.ЗначениеРеквизитаОбъекта(ПараметрыОрганизации.РегистрацияВНалоговомОргане, "КодПоОКТМО"));
	КонецЕсли;
	
	Если ВерсияУведомления < КонтролируемыеСделкиКлиентСервер.ВерсияУведомления_2018() Тогда
		Если СтрДлина(ОКТМО) > 0 Тогда
			Пока СтрДлина(ОКТМО)< 11 Цикл
				ОКТМО = ОКТМО + "0";
			КонецЦикла;
		КонецЕсли;
		Если РеквизитыУведомления.ОтчетныйГод < Дата(2012,12,31) Тогда
			ОсновныеСведения.Вставить("ОКАТО", ОКАТО);
		Иначе
			ОсновныеСведения.Вставить("ОКТМО", ОКТМО);
		КонецЕсли;
		ОсновныеСведения.Вставить("ОКВЭД", ПараметрыОрганизации.КодОКВЭД);
	Иначе
		ОсновныеСведения.Вставить("ОКТМО", ОКТМО);
	КонецЕсли;
	
	Если ВерсияУведомления = КонтролируемыеСделкиКлиентСервер.ВерсияУведомления_2012() Тогда
		ОсновныеСведения.Вставить("ОКВЭД", ПараметрыОрганизации.КодОКВЭД);
	Иначе
		ОсновныеСведения.Вставить("ОКВЭД", ПараметрыОрганизации.КодОКВЭД2);
	КонецЕсли;
	
	ОсновныеСведения.Вставить("Тлф",   ТелефонОрганизации);
	ОсновныеСведения.Вставить("ЭлПочта", ЭлектроннаяПочтаОрганизации);
	
	ОсновныеСведения.Вставить("НаименованиеОрганизации", ПараметрыОрганизации.НаименованиеПолное);
	ОсновныеСведения.Вставить("РегистрацияВНалоговомОргане", ПараметрыОрганизации.РегистрацияВНалоговомОргане);
	
	Если ОрганизацияФизЛицо Тогда
		ИНН = ПараметрыОрганизации.ИНН;
		ЕстьИНН = ЗначениеЗаполнено(ИНН);
		
		ОсновныеСведения.Вставить("ЭтоПБОЮЛ", Истина);
		ОсновныеСведения.Вставить("ИндивидуальныйПредприниматель", ПараметрыОрганизации.ИндивидуальныйПредприниматель);
		ОсновныеСведения.Вставить("ЕстьИННФЛ", ЕстьИНН);
		ОсновныеСведения.Вставить("ИННФЛ", ИНН);
		
		СписокКадровыхДанных = "Фамилия, Имя, Отчество, ФамилияИО, ФИОПолные, ДокументВид, ДокументСерия, ДокументНомер, ДокументДатаВыдачи, ДокументКемВыдан, ДокументКодПодразделения, ДокументПредставление, Страна, СтатусНалогоплательщика, ДатаРождения, МестоРождения, АдресПоПрописке, АдресЗаПределамиРФ";
		
		КадровыеДанныеФизЛиц = КадровыйУчет.КадровыеДанныеФизическихЛиц(Истина, ПараметрыОрганизации.ИндивидуальныйПредприниматель, СписокКадровыхДанных, ДатаСведений);
		Если КадровыеДанныеФизЛиц.Количество()>0 Тогда
			ДанныеФизЛица = КадровыеДанныеФизЛиц[0];
			
			ОсновныеСведения.Вставить("НПФЛФамилия",  ДанныеФизЛица.Фамилия);
			ОсновныеСведения.Вставить("НПФЛИмя",      ДанныеФизЛица.Имя);
			ОсновныеСведения.Вставить("НПФЛОтчество", ДанныеФизЛица.Отчество);
			ОсновныеСведения.Вставить("НаименованиеДляЛиста1", ДанныеФизЛица.ФИОПолные);
			
			ОсновныеСведения.Вставить("НПФЛДатаРожд",  ДанныеФизЛица.ДатаРождения);
			ОсновныеСведения.Вставить("НПФЛМестоРожд", ПерсонифицированныйУчетКлиентСервер.ПредставлениеМестаРождения(ДанныеФизЛица.МестоРождения));
			
			Если ДанныеФизЛица.Страна = Справочники.СтраныМира.Россия Тогда
				ОсновныеСведения.Вставить("НПФЛНалГражд", "1");
				ОсновныеСведения.Вставить("НПФЛОКСМ", ОбщегоНазначения.ЗначениеРеквизитаОбъекта(ДанныеФизЛица.Страна, "Код"));
			ИначеЕсли ЗначениеЗаполнено(ДанныеФизЛица.Страна) Тогда
				ОсновныеСведения.Вставить("НПФЛНалГражд", "2");
				ОсновныеСведения.Вставить("НПФЛОКСМ", ОбщегоНазначения.ЗначениеРеквизитаОбъекта(ДанныеФизЛица.Страна, "Код"));
			Иначе
				ОсновныеСведения.Вставить("НПФЛНалГражд", "3");
				ОсновныеСведения.Вставить("НПФЛОКСМ", "");
			КонецЕсли;
			
			Если ДанныеФизЛица.СтатусНалогоплательщика = Справочники.СтатусыНалогоплательщиковПоНДФЛ.Резидент Тогда
				ОсновныеСведения.Вставить("НПФЛСтатусНП", "1");
			Иначе
				ОсновныеСведения.Вставить("НПФЛСтатусНП", "2");
			КонецЕсли;
			
			Если ЗначениеЗаполнено(ДанныеФизЛица.ДокументВид) Тогда
				ОсновныеСведения.Вставить("НПФЛКодВидДок", ОбщегоНазначения.ЗначениеРеквизитаОбъекта(ДанныеФизЛица.ДокументВид, "КодМВД"));
				ОсновныеСведения.Вставить("НПФЛСерНомДок", Строка(ДанныеФизЛица.ДокументСерия)+" "+Строка(ДанныеФизЛица.ДокументНомер));
				ОсновныеСведения.Вставить("НПФЛДатаДок",   ДанныеФизЛица.ДокументДатаВыдачи);
				ОсновныеСведения.Вставить("НПФЛВыдДок",    ДанныеФизЛица.ДокументКемВыдан);
			КонецЕсли;
			
			Если ЗначениеЗаполнено(ДанныеФизЛица.АдресПоПрописке) Тогда
				
				Если ДанныеФизЛица.Страна = Справочники.СтраныМира.Россия Тогда
					ОсновныеСведения.Вставить("НПФЛПрАдр", "1");
				Иначе
					ОсновныеСведения.Вставить("НПФЛПрАдр", "2");
				КонецЕсли;
				
				АдресСтруктурой = РаботаСАдресами.СведенияОбАдресе(ДанныеФизЛица.АдресПоПрописке);
				
				Если АдресСтруктурой.Свойство("Регион") Тогда
					ОсновныеСведения.Вставить("НПФЛКодРегион", РегламентированнаяОтчетностьВызовСервера.КодРегионаПоНазванию(АдресСтруктурой.Регион));
				Иначе
					ОсновныеСведения.Вставить("НПФЛКодРегион", "");
				КонецЕсли;
				
				ОсновныеСведения.Вставить("НПФЛИндекс", АдресСтруктурой.Индекс);
				ОсновныеСведения.Вставить("НПФЛРайон",  АдресСтруктурой.Район);
				ОсновныеСведения.Вставить("НПФЛГород",  АдресСтруктурой.Город);
				ОсновныеСведения.Вставить("НПФЛНаселПункт", АдресСтруктурой.НаселенныйПункт);
				ОсновныеСведения.Вставить("НПФЛУлица",   АдресСтруктурой.Улица);
				ОсновныеСведения.Вставить("НПФЛДом",     АдресСтруктурой.Дом);
				ОсновныеСведения.Вставить("НПФЛКорпус",  АдресСтруктурой.Корпус);
				ОсновныеСведения.Вставить("НПФЛКварт",   АдресСтруктурой.Квартира);
			КонецЕсли;
			
			Если ЗначениеЗаполнено(ДанныеФизЛица.АдресЗаПределамиРФ) Тогда
				АдресСтруктурой = РаботаСАдресами.СведенияОбАдресе(ДанныеФизЛица.АдресЗаПределамиРФ);
				ОсновныеСведения.Вставить("АдрИнКодСтраны", АдресСтруктурой.КодСтраны);
				Если СтрНайти(АдресСтруктурой.Представление, АдресСтруктурой.Страна+", ") = 1 Тогда
					ОсновныеСведения.Вставить("АдрИнТекст", Сред(АдресСтруктурой.Представление, СтрДлина(АдресСтруктурой.Страна+", ") + 1));
				Иначе
					ОсновныеСведения.Вставить("АдрИнТекст", АдресСтруктурой.Представление);
				КонецЕсли;
			КонецЕсли;
			
		Иначе
			
			// Заполним пустыми данными.
			ОсновныеСведения.Вставить("НПФЛФамилия");
			ОсновныеСведения.Вставить("НПФЛИмя");
			ОсновныеСведения.Вставить("НПФЛОтчество");
			ОсновныеСведения.Вставить("НПФЛДатаРожд");
			ОсновныеСведения.Вставить("НПФЛМестоРожд");
			ОсновныеСведения.Вставить("НПФЛНалГражд");
			ОсновныеСведения.Вставить("НПФЛСтатусНП");
			
		КонецЕсли;
		
	Иначе
		ОсновныеСведения.Вставить("ЭтоПБОЮЛ", Ложь);
		ОсновныеСведения.Вставить("НаимОрг", ПараметрыОрганизации.НаименованиеПолное);
		ОсновныеСведения.Вставить("НаименованиеДляЛиста1", ПараметрыОрганизации.НаименованиеПолное);
		ОсновныеСведения.Вставить("ИННЮЛ",   ПараметрыОрганизации.ИНН);
		ОсновныеСведения.Вставить("КППЮЛ",   ПараметрыОрганизации.КПП);
	КонецЕсли;
	
	ОсновныеСведения.Вставить("КодНО", ПараметрыОрганизации.КодНалоговогоОргана);
	
	ДобавитьСведенияОПодписанте(ОсновныеСведения, ДатаСведений);
	
	ИдентификаторФайла = ИдентификаторФайлаЭлектронногоПредставления(ОсновныеСведения);
	ОсновныеСведения.Вставить("ИдФайл", ИдентификаторФайла);
	
	Возврат ОсновныеСведения;
	
КонецФункции

// Добавляет в структуру основных сведений уведомления информацию о подписанте на запрашиваемую дату.
//
// Параметры:
//  ОсновныеСведения - Структура - структура основных сведений уведомления о контролируемых сделках.
//  ДатаСведений     - Дата - дата, на которую необходимо получить данные о подписанте.
//
Процедура ДобавитьСведенияОПодписанте(ОсновныеСведения, ДатаСведений)
	
	ТипПодписанта = "1";
	Подписант = "";
	НаименованиеОрганизацииПредставителя = "";
	ДокументПредставителя = "";
	
	Организация = ОсновныеСведения.Организация;
	КодНО = ОсновныеСведения.КодНО;
	КПП   = ?(ОсновныеСведения.Свойство("КППЮЛ"), ОсновныеСведения.КППЮЛ, "");
	
	СведенияОПредставителе = РегламентированнаяОтчетностьВызовСервера.ПолучитьПоКодамСведенияОПредставителе(Организация, КодНО, КПП);
	
	ТипПодписанта = СведенияОПредставителе.ТипПодписанта;
	ОсновныеСведения.Вставить("ПрПодп", ТипПодписанта);
	
	Если ТипПодписанта = "1" Тогда
		// Представителя нет.
		Если ОбщегоНазначения.ЗначениеРеквизитаОбъекта(Организация, "ЮридическоеФизическоеЛицо")
				= Перечисления.ЮридическоеФизическоеЛицо.ФизическоеЛицо Тогда
			// ФИО подписанта не заполняется.
		Иначе
			РеквизитыОтветственныхЛиц = ОтветственныеЛицаБП.ОтветственныеЛица(Организация, ДатаСведений);
			
			ОсновныеСведения.Вставить("ПодпФамилия",  РеквизитыОтветственныхЛиц.РуководительФИО.Фамилия);
			ОсновныеСведения.Вставить("ПодпИмя",      РеквизитыОтветственныхЛиц.РуководительФИО.Имя);
			ОсновныеСведения.Вставить("ПодпОтчество", РеквизитыОтветственныхЛиц.РуководительФИО.Отчество);
		КонецЕсли;
	Иначе
		// Есть представитель.
		Если ТипЗнч(СведенияОПредставителе.ПредставительСсылка) = Тип("СправочникСсылка.Контрагенты") Тогда
			ФИОПодписанта = ФизическиеЛицаКлиентСервер.ЧастиИмени(СведенияОПредставителе.ФИОПредставителя);
			ОсновныеСведения.Вставить("НаимОргПодп", СведенияОПредставителе.НаименованиеОрганизацииПредставителя);
		Иначе
			ФИОПодписанта = ПолучитьФИОФизлица(СведенияОПредставителе.ПредставительСсылка, ДатаСведений);
		КонецЕсли;
		
		ОсновныеСведения.Вставить("ПодпФамилия",  ФИОПодписанта.Фамилия);
		ОсновныеСведения.Вставить("ПодпИмя",      ФИОПодписанта.Имя);
		ОсновныеСведения.Вставить("ПодпОтчество", ФИОПодписанта.Отчество);
		
		ОсновныеСведения.Вставить("НаимДокПодп", СведенияОПредставителе.ДокументПредставителя);
		
	КонецЕсли;
	
КонецПроцедуры

// Идентификатор файла электронного представления.
// 
// Параметры:
//  СведенияОтправки - Структура - Сведения отправки:
// * ВерсияУведомления - Число - 
// * Организация - СправочникСсылка.Организации - 
// * ДатаДок - Дата - 
// * НомКорр - Строка - 
// * ПоМесту - Строка - 
// * ВерсПрог - Строка - 
// * ФормРеорг - Строка - 
// * ИННЮЛРеорг - Строка - 
// * КППЮЛРеорг - Строка - 
// * ОтчетГод - Строка - 
// * ОтчетныйГод - Дата - 
// * ОКТМО - Строка - 
// * ОКВЭД - Строка - 
// * Тлф - Строка - 
// * ЭлПочта - Строка, ТаблицаЗначений - :
// ** Объект - ЛюбаяСсылка - 
// ** Вид - СправочникСсылка.ВидыКонтактнойИнформации - 
// ** Тип - ПеречислениеСсылка.ТипыКонтактнойИнформации - 
// ** Значение - Строка - 
// ** Представление - Строка - 
// ** Дата - Дата - 
// ** ИдентификаторСтрокиТабличнойЧасти - Число - 
// ** ЗначенияПолей - Строка - 
// * НаименованиеОрганизации - Строка - 
// * РегистрацияВНалоговомОргане - СправочникСсылка.РегистрацииВНалоговомОргане - 
// * ЭтоПБОЮЛ - Булево - 
// * НаимОрг - Строка - 
// * НаименованиеДляЛиста1 - Строка - 
// * ИННЮЛ - ОпределяемыйТип.ИНН - 
// * КППЮЛ - Строка - 
// * КодНО - Строка - 
// 
// Возвращаемое значение:
//  Строка - Идентификатор файла электронного представления
Функция ИдентификаторФайлаЭлектронногоПредставления(СведенияОтправки) Экспорт
	
	Префикс = "UT_UVKNRSD";
	Если СведенияОтправки.ЭтоПБОЮЛ Тогда
		ИдентификаторОтправителя = СокрЛП(СведенияОтправки.ИННФЛ);
	Иначе
		ИдентификаторОтправителя = СокрЛП(СведенияОтправки.ИННЮЛ) + СокрЛП(СведенияОтправки.КППЮЛ);
	КонецЕсли;
	ИдентификаторПолучателя = СокрЛП(СведенияОтправки.КодНО) + "_" + СокрЛП(СведенияОтправки.КодНО);
	ДатаФормированияФайла = Формат(СведенияОтправки.ДатаДок, "ДФ=yyyyMMdd");
	ИдентификационныйНомер = Строка(Новый УникальныйИдентификатор);
	
	ИдентификаторФайла = Префикс
	                   + "_" + ИдентификаторПолучателя
	                   + "_" + ИдентификаторОтправителя
	                   + "_" + ДатаФормированияФайла
	                   + "_" + ИдентификационныйНомер;
	
	Возврат ИдентификаторФайла;
	
КонецФункции

// Возвращает структура ФИО физического лица на запрашиваемую дату.
//
// Параметры:
//  ФизЛицо      - СправочникСсылка.Организации, СправочникСсылка.ФизическиеЛица - данные о физическом лице.
//  ДатаСведений - Дата - дата, на которую необходимо получить структуру ФИО физического лица.
// Возвращаемое значение:
//  Структура    - структура ФИО физического лица:
//  * Фамилия    - Строка - фамилия.
//  * Имя        - Строка - имя.
//  * Отчество   - Строка - отчетство.
//
Функция ПолучитьФИОФизлица(ФизЛицо, ДатаСведений)
	
	ФИО = Новый Структура("Фамилия, Имя, Отчество", "", "", "");
	ДанныеФЛ = РегистрыСведений.ФИОФизическихЛиц.СрезПоследних(ДатаСведений, Новый Структура("ФизическоеЛицо", ФизЛицо));
	Если ДанныеФЛ.Количество() > 0 Тогда
		ЗаполнитьЗначенияСвойств(ФИО, ДанныеФЛ[0]);
	КонецЕсли;
	
	Возврат ФИО;
	
КонецФункции

#КонецОбласти

#Область ПроверкаЗаполненияДанныхУведомления

// Проверить заполнение уведомления.
// 
// Параметры:
//  Уведомление - ДокументСсылка.УведомлениеОКонтролируемыхСделках - Уведомление
//  УникальныйИдентификатор - Неопределено - Уникальный идентификатор
// 
// Возвращаемое значение:
//  Структура - Проверить заполнение уведомления:
// * АдресХранилища - Строка - 
Функция ПроверитьЗаполнениеУведомления(Уведомление, УникальныйИдентификатор = Неопределено) Экспорт
	
	ОсновныеСведения = ПолучитьОсновныеСведенияУведомленияДляВыгрузки(Уведомление);
	ОсновныеСведения.Вставить("УведомлениеОКонтролируемыхСделках", Уведомление);
	
	ЛистыУведомления = КонтролируемыеСделки.ПолучитьЛистыУведомления(Уведомление);
	
	ИнформацияОбОшибках = ВыводСообщенийОбОшибках.НовыйДетальнаяИнформацияОбОшибках();
	
	Ошибки = Новый СписокЗначений;
	
	ПроверитьТитульныйЛист(ОсновныеСведения, Ошибки);
	ПроверитьТитульныйЛистФизЛицо(ОсновныеСведения, Ошибки);
	ПроверитьЛисты1А(ОсновныеСведения, ЛистыУведомления, Ошибки);
	ПроверитьЛисты1Б(ОсновныеСведения, ЛистыУведомления, Ошибки);
	ПроверитьЛисты1В(ОсновныеСведения, ЛистыУведомления, Ошибки);
	ПроверитьЛисты1Г(ОсновныеСведения, ЛистыУведомления, Ошибки);
	ПроверитьЛистыРаздела2(ОсновныеСведения, ЛистыУведомления, Ошибки);
	ПроверитьЛистыРаздела3(ЛистыУведомления, Ошибки);
	ПроверитьЛистыРаздела4(ОсновныеСведения, ЛистыУведомления, Ошибки);
	
	СформироватьИнформациюОбОшибках(ИнформацияОбОшибках, Ошибки);
	
	ДанныеДляВывода = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(Уведомление, "Организация");
	ХранилищеЗначения = ВыводСообщенийОбОшибках.ОписаниеОшибок(ИнформацияОбОшибках, ПолучитьМакет("МакетВыводаОшибок"), ДанныеДляВывода);
	
	Если УникальныйИдентификатор = Неопределено Тогда
		АдресХранилища = ПоместитьВоВременноеХранилище(ХранилищеЗначения, Новый УникальныйИдентификатор);
	Иначе
		АдресХранилища = ПоместитьВоВременноеХранилище(ХранилищеЗначения, УникальныйИдентификатор);
	КонецЕсли;
	
	Возврат Новый Структура("АдресХранилища", АдресХранилища);
	
КонецФункции

// Проверяет титульный лист на наличие ошибок.
// При наличии ошибок записывет описание ошибок в список по разделам уведомления.
//
// Параметры:
//  ОсновныеСведения - Структура - параметры основных сведений уведомления.
//  Ошибки           - СписокЗначений из ТаблицаЗначений - описание ошибок по разделам уведомления.
//
Процедура ПроверитьТитульныйЛист(ОсновныеСведения, Ошибки)
	
	ТекущиеОшибки = ОписаниеТаблицыОшибок();
	
	// Код налогового органа
	Если Не ЗначениеЗаполнено(ОсновныеСведения.КодНО) Или СтрДлина(ОсновныеСведения.КодНО) <> 4 Тогда
		ДобавитьОшибку("1010", ОсновныеСведения.Организация, ТекущиеОшибки);		
	КонецЕсли;
	
	// Код по месту учета
	Если Не ЗначениеЗаполнено(ОсновныеСведения.ПоМесту) Тогда
		ДобавитьОшибку("1020", ОсновныеСведения.УведомлениеОКонтролируемыхСделках, ТекущиеОшибки);
	КонецЕсли;
	
	Если ОсновныеСведения.ВерсияУведомления < КонтролируемыеСделкиКлиентСервер.ВерсияУведомления_2018() Тогда
		Если ОсновныеСведения.ОтчетныйГод < Дата(2012,12,31) Тогда
			// Код ОКАТО
			Если Не ЗначениеЗаполнено(ОсновныеСведения.ОКАТО) Или СтрДлина(ОсновныеСведения.ОКАТО) <> 11 Тогда
				ДобавитьОшибку("1030", ОсновныеСведения.Организация, ТекущиеОшибки);
			КонецЕсли;
		Иначе
			// Код ОКТМО
			Если Не ЗначениеЗаполнено(ОсновныеСведения.ОКТМО) Тогда
				ДобавитьОшибку("1031", ОсновныеСведения.Организация, ТекущиеОшибки);
			КонецЕсли;
		КонецЕсли;
	Иначе
		// Код ОКТМО
		Если Не ЗначениеЗаполнено(ОсновныеСведения.ОКТМО) Тогда
			ДобавитьОшибку("1031", ОсновныеСведения.Организация, ТекущиеОшибки);
		КонецЕсли;
	КонецЕсли;
	
	// Наименование организации
	Если Не ЗначениеЗаполнено(ОсновныеСведения.НаименованиеОрганизации) Тогда
		ДобавитьОшибку("1050", ОсновныеСведения.Организация, ТекущиеОшибки);
	КонецЕсли;
	
	Если Не ОсновныеСведения.ЭтоПБОЮЛ Тогда
		
		// ИНН, КПП юр. лица
		Если Не ЗначениеЗаполнено(ОсновныеСведения.ИННЮЛ) Или СтрДлина(ОсновныеСведения.ИННЮЛ) <> 10
			Или Не ЗначениеЗаполнено(ОсновныеСведения.КППЮЛ) Или СтрДлина(ОсновныеСведения.КППЮЛ) <> 9 Тогда
			ДобавитьОшибку("1040", ОсновныеСведения.Организация, ТекущиеОшибки);
		КонецЕсли;
		
		// ИНН/КПП реорганизованной организации
		Если ОсновныеСведения.Свойство("ФормРеорг") И ЗначениеЗаполнено(ОсновныеСведения.ФормРеорг) Тогда 
			Если Не ЗначениеЗаполнено(ОсновныеСведения.ИННЮЛРеорг) Или Не ЗначениеЗаполнено(ОсновныеСведения.КППЮЛРеорг) Тогда
				ДобавитьОшибку("1060", ОсновныеСведения.УведомлениеОКонтролируемыхСделках, ТекущиеОшибки);
			КонецЕсли;
		КонецЕсли;
	
	КонецЕсли;
	
	Если ОсновныеСведения.ВерсияУведомления < КонтролируемыеСделкиКлиентСервер.ВерсияУведомления_2018() Тогда
		// Код ОКВЭД
		СтрокаПоиска = "/" + ОсновныеСведения.ПоМесту + "/";
		Если СтрНайти("/120/213/214/215/", СтрокаПоиска) > 0 Тогда
			Если Не ЗначениеЗаполнено(ОсновныеСведения.ОКВЭД) Тогда
				ДобавитьОшибку("1070", ОсновныеСведения.Организация, ТекущиеОшибки);
			КонецЕсли;
		КонецЕсли;
	КонецЕсли;
	
	// Титульный лист ФИО подписанта
	ФамилияПодписанта = Неопределено; ИмяПодписанта = Неопределено;
	
	ОсновныеСведения.Свойство("ПодпФамилия", ФамилияПодписанта);
	ОсновныеСведения.Свойство("ПодпИмя", ИмяПодписанта); 
	
	ФИОПодписантаЗаполнено = ЗначениеЗаполнено(ФамилияПодписанта) И ЗначениеЗаполнено(ИмяПодписанта);
	
	Если Не ФИОПодписантаЗаполнено Тогда
		Если ОсновныеСведения.ПрПодп = "1" Тогда // Если представителя нет
			Если Не ОсновныеСведения.ЭтоПБОЮЛ  Тогда
				ДобавитьОшибку("1080", ОсновныеСведения.Организация, ТекущиеОшибки);
			КонецЕсли;
		Иначе // есть представитель
			ДобавитьОшибку("1090", ОсновныеСведения.РегистрацияВНалоговомОргане, ТекущиеОшибки);
		КонецЕсли;
	КонецЕсли;
	
	// Наименование документа представителя
	Если ОсновныеСведения.ПрПодп <> "1" И Не ЗначениеЗаполнено(ОсновныеСведения.НаимДокПодп) Тогда
		ДобавитьОшибку("1100", ОсновныеСведения.РегистрацияВНалоговомОргане, ТекущиеОшибки);
	КонецЕсли;
	
	Ошибки.Добавить(ТекущиеОшибки, НСтр("ru = 'Титульный лист';
										|en = 'Cover page'"));
		
КонецПроцедуры

// Проверяет на титульном листе данные о физическом лице на наличие ошибок.
// При наличии ошибок записывет описание ошибок в список по разделам уведомления.
//
// Параметры:
//  ОсновныеСведения - Структура - параметры основных сведений уведомления.
//  Ошибки           - СписокЗначений из ТаблицаЗначений - описание ошибок по разделам уведомления.
//
Процедура ПроверитьТитульныйЛистФизЛицо(ОсновныеСведения, Ошибки)
	
	Если Не ОсновныеСведения.ЭтоПБОЮЛ Тогда
		Возврат;
	КонецЕсли;
	
	ТекущиеОшибки = ОписаниеТаблицыОшибок();
	
	// Фамилия, Имя
	Если Не ЗначениеЗаполнено(ОсновныеСведения.НПФЛФамилия) Или Не ЗначениеЗаполнено(ОсновныеСведения.НПФЛИмя) Тогда
		ДобавитьОшибку("2010", ОсновныеСведения.ИндивидуальныйПредприниматель, ТекущиеОшибки);
	КонецЕсли;
	
	// ИНН физ. лица
	СтрокаПоиска = "/" + ОсновныеСведения.ПоМесту + "/";
	Если СтрНайти("/120/125/126/", СтрокаПоиска) > 0 Тогда
		Если Не ЗначениеЗаполнено(ОсновныеСведения.ИННФЛ) Или СтрДлина(ОсновныеСведения.ИННФЛ) <> 12 Тогда
			ДобавитьОшибку("2020", ОсновныеСведения.Организация, ТекущиеОшибки);
		КонецЕсли;
	КонецЕсли;
	
	Если Не ЗначениеЗаполнено(ОсновныеСведения.ИННФЛ) Тогда
		
		// Дата рождения
		Если Не ЗначениеЗаполнено(ОсновныеСведения.НПФЛДатаРожд) Тогда
			ДобавитьОшибку("2030", ОсновныеСведения.ИндивидуальныйПредприниматель, ТекущиеОшибки);
		КонецЕсли;
		
		// Место рождения
		Если Не ЗначениеЗаполнено(ОсновныеСведения.НПФЛМестоРожд) Тогда
			ДобавитьОшибку("2040", ОсновныеСведения.ИндивидуальныйПредприниматель, ТекущиеОшибки);
		КонецЕсли;
		
		// Сведения о гражданстве
		ОшибкаЗаполнения = Не (ОсновныеСведения.НПФЛНалГражд = "1" Или (ОсновныеСведения.НПФЛНалГражд = "2" И ЗначениеЗаполнено(ОсновныеСведения.НПФЛОКСМ)));
		Если ОшибкаЗаполнения Тогда
			ДобавитьОшибку("2050", ОсновныеСведения.ИндивидуальныйПредприниматель, ТекущиеОшибки);
		КонецЕсли;
		
		Если ОсновныеСведения.НПФЛНалГражд = "1" Тогда
			
			// Адрес места жительства/прибывания
			АдресЗаполнен = ОсновныеСведения.Свойство("НПФЛКодРегион") И ЗначениеЗаполнено(ОсновныеСведения.НПФЛКодРегион);
			Если Не АдресЗаполнен Тогда
				ДобавитьОшибку("2060", ОсновныеСведения.ИндивидуальныйПредприниматель, ТекущиеОшибки);
			КонецЕсли;
			
		Иначе
			
			// Адрес за пределами РФ
			АдресЗаполнен = ОсновныеСведения.Свойство("АдрИнКодСтраны") И ЗначениеЗаполнено(ОсновныеСведения.АдрИнКодСтраны)
				И ЗначениеЗаполнено(ОсновныеСведения.АдрИнТекст);
				
			Если Не АдресЗаполнен Тогда
				ДобавитьОшибку("2070", ОсновныеСведения.ИндивидуальныйПредприниматель, ТекущиеОшибки);
			КонецЕсли;
			
		КонецЕсли;
		
		// Статус налогоплательщика
		Если Не ЗначениеЗаполнено(ОсновныеСведения.НПФЛСтатусНП) Тогда
			ДобавитьОшибку("2080", ОсновныеСведения.ИндивидуальныйПредприниматель, ТекущиеОшибки);
		КонецЕсли;
		
		// Документ удостоверяющий личность
		// Код вида документа, серия, номер, дата выдачи, кем выдан.
		ДанныеДокументаЗаполнены = ОсновныеСведения.Свойство("НПФЛКодВидДок") И ЗначениеЗаполнено(ОсновныеСведения.НПФЛКодВидДок) 
			И ЗначениеЗаполнено(ОсновныеСведения.НПФЛСерНомДок)	И ЗначениеЗаполнено(ОсновныеСведения.НПФЛДатаДок) 
			И ЗначениеЗаполнено(ОсновныеСведения.НПФЛВыдДок);
		
		Если Не ДанныеДокументаЗаполнены Тогда
			ДобавитьОшибку("2090", ОсновныеСведения.ИндивидуальныйПредприниматель, ТекущиеОшибки);
		КонецЕсли;
			
	КонецЕсли;
	
	Ошибки.Добавить(ТекущиеОшибки, НСтр("ru = 'Титульный лист (сведения о физ. лице)';
										|en = 'Cover page (information on an individual)'"));
		
КонецПроцедуры

// Проверяет листы 1А на наличие ошибок. При наличии ошибок записывет описание ошибок в список по разделам уведомления.
//
// Параметры:
//  ОсновныеСведения - Структура - параметры основных сведений уведомления.
//  ЛистыУведомления - Структура - структура данных уведомления, разделенная по разделам в виде таблиц значений.
//  Ошибки           - СписокЗначений из ТаблицаЗначений - описание ошибок по разделам уведомления.
//
Процедура ПроверитьЛисты1А(ОсновныеСведения, ЛистыУведомления, Ошибки)
	
	ТекущиеОшибки = ОписаниеТаблицыОшибок();
	
	СоответствиеКодов = КонтролируемыеСделки.ПолучитьСоответствиеКодовСтороныСделки();
	
	Для Каждого Лист Из ЛистыУведомления.ЛистыРаздела1А Цикл
		
		// Код наименования сделки
		Если Не ЗначениеЗаполнено(Лист.Строка210КодНаименованияСделки) Тогда
			ДобавитьОшибку("3010", ДанныеВыводаОшибкиСделка(Лист), ТекущиеОшибки);
		КонецЕсли;
		
		// Код стороны сделки
		Если Не ЗначениеЗаполнено(Лист.Строка211КодСтороныСделки) Тогда
			ДобавитьОшибку("3020", ДанныеВыводаОшибкиСделка(Лист), ТекущиеОшибки);
		КонецЕсли;
		
		// Соответствие кодов
		Если ЗначениеЗаполнено(Лист.Строка210КодНаименованияСделки) И ЗначениеЗаполнено(Лист.Строка211КодСтороныСделки) Тогда
						
			КодыСторонСделки = СоответствиеКодов.Получить(Лист.Строка210КодНаименованияСделки);
			
			Если КодыСторонСделки = Неопределено Тогда
				ДобавитьОшибку("3030", ДанныеВыводаОшибкиСделка(Лист), ТекущиеОшибки);	
			ИначеЕсли КодыСторонСделки.НайтиПоЗначению(Лист.Строка211КодСтороныСделки) = Неопределено Тогда
				ДобавитьОшибку("3040", ДанныеВыводаОшибкиСделка(Лист), ТекущиеОшибки);
			КонецЕсли;
			
		КонецЕсли;
		
		Если ОсновныеСведения.ВерсияУведомления < КонтролируемыеСделкиКлиентСервер.ВерсияУведомления_2024() Тогда
			// Комментарий по признаку определения цены сделки, он выводится для 2024 года.
			// Затем он удален.
			Если Лист.Строка220ПризнакОпределенияЦеныСделки = "1"
				И Не ЗначениеЗаполнено(Лист.Строка220_1Комментарий) Тогда
				ДобавитьОшибку("3050", Лист.СпособОпределенияЦеныСделки, ТекущиеОшибки);
			КонецЕсли;
		КонецЕсли;
		
		// наличие листов раздела 1Б
		Если Лист.Количество1Б = 0 Тогда
			ДобавитьОшибку("3060", ДанныеВыводаОшибкиСделка(Лист), ТекущиеОшибки);
		КонецЕсли;
		
		Если ОсновныеСведения.ВерсияУведомления >= КонтролируемыеСделкиКлиентСервер.ВерсияУведомления_2024() Тогда
			// Код методов ценообразования должен попадать в список 01...07. Остальные коды недействуют,
			// например код 08 был ранее, но теперь он недоступен
			Если ЗначениеЗаполнено(Лист.Строка240КодМетодовЦенообразования)
				И СтрНайти("|01|02|03|04|05|06|07|", "|" + Лист.Строка240КодМетодовЦенообразования + "|") = 0 Тогда
				ДобавитьОшибку("3090", ДанныеВыводаОшибкиСделка(Лист), ТекущиеОшибки);
			КонецЕсли;
		КонецЕсли;
		
		Если ОсновныеСведения.ВерсияУведомления >= КонтролируемыеСделкиКлиентСервер.ВерсияУведомления_2024() Тогда
			Если Лист.УказыватьСведенияЦепочкиСозданияСтоимости И Лист.Количество1В = 0 Тогда
				ДобавитьОшибку("3100", ДанныеВыводаОшибкиСделка(Лист), ТекущиеОшибки);
			КонецЕсли;
		КонецЕсли;
		
		// Одновременное заполнение показателей 122-123 и 131-138
		Если Лист.Строка122СделкаВОбластиВнешнейТорговли = "1"
			ИЛИ Лист.Строка123СделкаСКонтрагентомСЛьготнымНалогообложением = "1" Тогда
			
			Если ОсновныеСведения.ВерсияУведомления < КонтролируемыеСделкиКлиентСервер.ВерсияУведомления_2018() Тогда
				Если Лист.ОснованиеКонтролируемости131 = "1"
					ИЛИ Лист.ОснованиеКонтролируемости132 = "1"
					ИЛИ Лист.ОснованиеКонтролируемости133 = "1"
					ИЛИ Лист.ОснованиеКонтролируемости134 = "1"
					ИЛИ Лист.ОснованиеКонтролируемости135 = "1" Тогда
					
					ДобавитьОшибку("3070", ДанныеВыводаОшибкиСделка(Лист), ТекущиеОшибки);
					
				КонецЕсли;
				
			Иначе
				
				Если Лист.ОснованиеКонтролируемости131 = "1"
					ИЛИ Лист.ОснованиеКонтролируемости132 = "1"
					ИЛИ Лист.ОснованиеКонтролируемости133 = "1"
					ИЛИ Лист.ОснованиеКонтролируемости134 = "1"
					ИЛИ Лист.ОснованиеКонтролируемости135 = "1"
					ИЛИ Лист.ОснованиеКонтролируемости136 = "1"
					ИЛИ Лист.ОснованиеКонтролируемости137 = "1"
					ИЛИ Лист.ОснованиеКонтролируемости138 = "1"
					ИЛИ Лист.ОснованиеКонтролируемости139 = "1"
					ИЛИ Лист.ОснованиеКонтролируемости140 = "1" Тогда
					
					ДобавитьОшибку("3070", ДанныеВыводаОшибкиСделка(Лист), ТекущиеОшибки);
					
				КонецЕсли;
			КонецЕсли;
			
		КонецЕсли;
		
		Если ОсновныеСведения.ВерсияУведомления >= КонтролируемыеСделкиКлиентСервер.ВерсияУведомления_2018() Тогда
			Если Лист.СделкаСовАгент = "1"
				И Не ЗначениеЗаполнено(Лист.Комиссионер) Тогда
				ДобавитьОшибку("3080", ДанныеВыводаОшибкиСделка(Лист), ТекущиеОшибки);
			КонецЕсли;
		КонецЕсли;
		
	КонецЦикла;
	
	Ошибки.Добавить(ТекущиеОшибки, НСтр("ru = 'Лист 1А';
										|en = 'Sheet 1A'"));
	
КонецПроцедуры

// Проверяет листы 1Б на наличие ошибок. При наличии ошибок записывет описание ошибок в список по разделам уведомления.
//
// Параметры:
//  ОсновныеСведения - Структура - параметры основных сведений уведомления.
//  ЛистыУведомления - Структура - структура данных уведомления, разделенная по разделам в виде таблиц значений.
//  Ошибки           - СписокЗначений из ТаблицаЗначений - описание ошибок по разделам уведомления.
//
Процедура ПроверитьЛисты1Б(ОсновныеСведения, ЛистыУведомления, Ошибки)
	
	ТекущиеОшибки = ОписаниеТаблицыОшибок();
	
	Для Каждого Лист Из ЛистыУведомления.ЛистыРаздела1Б Цикл
		
		Если ЗначениеЗаполнено(Лист.Строка020ТипПредмета) Тогда
			
			Если ОсновныеСведения.ВерсияУведомления = КонтролируемыеСделкиКлиентСервер.ВерсияУведомления_2012() Тогда
			
				Если Лист.ТипПредметаСделки = Перечисления.ТипыПредметовКонтролируемыхСделок.Товар Тогда
					
					// Код ОКВЭД
					Если ЗначениеЗаполнено(Лист.Строка045КодОКВЭД) Тогда
						ДобавитьОшибку("4030", ДанныеВыводаОшибкиСделка(Лист), ТекущиеОшибки);
					КонецЕсли;
					
					// Должен быть указан код ОКП или код ТНВЭД
					Если НЕ ЗначениеЗаполнено(Лист.Строка040КодПоТНВЭД)
						И НЕ ЗначениеЗаполнено(Лист.Строка043КодПоОКП) Тогда
						ДобавитьОшибку("4055", ДанныеВыводаОшибкиСделка(Лист), ТекущиеОшибки);
					КонецЕсли;
					
				ИначеЕсли Лист.ТипПредметаСделки = Перечисления.ТипыПредметовКонтролируемыхСделок.РаботаУслуга
					Или Лист.ТипПредметаСделки = Перечисления.ТипыПредметовКонтролируемыхСделок.ИнойОбъектГражданскихПрав Тогда
					
					// Код ТНВЭД
					Если ЗначениеЗаполнено(Лист.Строка040КодПоТНВЭД) Тогда
						ДобавитьОшибку("4040", ДанныеВыводаОшибкиСделка(Лист), ТекущиеОшибки);
					КонецЕсли;
					
					// Код ОКП
					Если ЗначениеЗаполнено(Лист.Строка043КодПоОКП) Тогда
						ДобавитьОшибку("4050", ДанныеВыводаОшибкиСделка(Лист), ТекущиеОшибки);
					КонецЕсли;
					
				КонецЕсли;
				
			Иначе
				
				Если Лист.ТипПредметаСделки = Перечисления.ТипыПредметовКонтролируемыхСделок.Товар Тогда
					
					// Код ОКВЭД2 для товаров не заполняется
					Если ЗначениеЗаполнено(Лист.Строка045КодОКВЭД2) Тогда
						ДобавитьОшибку("4130", ДанныеВыводаОшибкиСделка(Лист), ТекущиеОшибки);
					КонецЕсли;
					
					// Для внешнеторговых сделок должен быть указан код код ТНВЭД
					Если НЕ ЗначениеЗаполнено(Лист.Строка040КодПоТНВЭД)
						И Лист.ВнешнеторговаяСделка Тогда
						ДобавитьОшибку("4150", ДанныеВыводаОшибкиСделка(Лист), ТекущиеОшибки);
					КонецЕсли;
					
					// Для внутрироссийских сделок должен быть указан код код по ОКПД2
					Если НЕ ЗначениеЗаполнено(Лист.Строка043КодПоОКПД2)
						И НЕ Лист.ВнешнеторговаяСделка Тогда
						ДобавитьОшибку("4160", ДанныеВыводаОшибкиСделка(Лист), ТекущиеОшибки);
					КонецЕсли;
					
				Иначе
					
					// Код ТНВЭД
					Если ЗначениеЗаполнено(Лист.Строка040КодПоТНВЭД) Тогда
						ДобавитьОшибку("4040", ДанныеВыводаОшибкиСделка(Лист), ТекущиеОшибки);
					КонецЕсли;
					
					// Код ОКПД2
					Если ЗначениеЗаполнено(Лист.Строка043КодПоОКПД2) Тогда
						ДобавитьОшибку("4140", ДанныеВыводаОшибкиСделка(Лист), ТекущиеОшибки);
					КонецЕсли;
					
					// Код ОКВЭД2
					Если НЕ ЗначениеЗаполнено(Лист.Строка045КодОКВЭД2) Тогда
						ДобавитьОшибку("4135", ДанныеВыводаОшибкиСделка(Лист), ТекущиеОшибки);
					КонецЕсли;
					
				КонецЕсли;
				
			КонецЕсли;
			
		Иначе
			// Тип предмета сделки
			ДобавитьОшибку("4010", ДанныеВыводаОшибкиСделка(Лист), ТекущиеОшибки);
		КонецЕсли;
		
		// Наименование предмета сделки
		Если Не ЗначениеЗаполнено(Лист.Строка030НаименованиеПредмета) Тогда
			ДобавитьОшибку("4020", ДанныеВыводаОшибкиСделка(Лист), ТекущиеОшибки);
		КонецЕсли;
		
		Если Не ЗначениеЗаполнено(Лист.Договор) Тогда
			// Договор контрагента
			ДобавитьОшибку("4060", ДанныеВыводаОшибкиСделка(Лист), ТекущиеОшибки);
			
		ИначеЕсли Не ЗначениеЗаполнено(Лист.Строка060НомерДоговора) Или Не ЗначениеЗаполнено(Лист.Строка065ДатаДоговора) Тогда
			// Номер, дата договора
			ДобавитьОшибку("4070", Лист.Договор, ТекущиеОшибки);
			
		КонецЕсли;
		
		Если Лист.ТипПредметаСделки = Перечисления.ТипыПредметовКонтролируемыхСделок.Товар Тогда
			
			// Код страны происхождения
			Если Не ЗначениеЗаполнено(Лист.Строка070КодСтраныПроисхождения) Тогда
				ДобавитьОшибку("4080", ДанныеВыводаОшибкиСделка(Лист), ТекущиеОшибки);
			ИначеЕсли НЕ СтроковыеФункцииКлиентСервер.ТолькоЦифрыВСтроке(СокрЛП(Лист.Строка070КодСтраныПроисхождения)) Тогда
				ДобавитьОшибку("4081", ДанныеВыводаОшибкиСделка(Лист), ТекущиеОшибки);
			КонецЕсли;
			
			Если ОсновныеСведения.ВерсияУведомления < КонтролируемыеСделкиКлиентСервер.ВерсияУведомления_2024() Тогда
				// Страна отправки товара проверялась до уведомления 2024. Начиная с этой версии страна отправки вообще не заполняется.
				Если ЗначениеЗаполнено(Лист.Строка080КодСтраныОтправки)
					И НЕ СтроковыеФункцииКлиентСервер.ТолькоЦифрыВСтроке(СокрЛП(Лист.Строка080КодСтраныОтправки)) Тогда
					ДобавитьОшибку("4085", ДанныеВыводаОшибкиСведенияОПредметеСделки(Лист), ТекущиеОшибки);
				КонецЕсли;
			КонецЕсли;
			
		ИначеЕсли Лист.ТипПредметаСделки = Перечисления.ТипыПредметовКонтролируемыхСделок.РаботаУслуга
			Или Лист.ТипПредметаСделки = Перечисления.ТипыПредметовКонтролируемыхСделок.ИнойОбъектГражданскихПрав Тогда
			
			// Код условий поставки
			Если ЗначениеЗаполнено(Лист.Строка100КодУсловийПоставки) Тогда
				ДобавитьОшибку("4100", ДанныеВыводаОшибкиСведенияОПредметеСделки(Лист), ТекущиеОшибки);
			КонецЕсли;
			
		КонецЕсли;
		
		Если ОсновныеСведения.ВерсияУведомления < КонтролируемыеСделкиКлиентСервер.ВерсияУведомления_2024() Тогда
		
			// Страна совершения сделки
			Если ЗначениеЗаполнено(Лист.Строка090КодСтраныСовершенияСделки)
				И НЕ СтроковыеФункцииКлиентСервер.ТолькоЦифрыВСтроке(СокрЛП(Лист.Строка090КодСтраныСовершенияСделки)) Тогда
				ДобавитьОшибку("4090", ДанныеВыводаОшибкиСведенияОПредметеСделки(Лист), ТекущиеОшибки);
			КонецЕсли;
			
			// Код региона совершения сделки
			Если Лист.Строка090КодСтраныСовершенияСделки = "643" 
				И НЕ ЗначениеЗаполнено(Лист.Строка090КодРегионаСовершенияСделки) Тогда
				ДобавитьОшибку("4091", ДанныеВыводаОшибкиСведенияОПредметеСделки(Лист), ТекущиеОшибки);
			КонецЕсли;
			
		КонецЕсли;
		
		// Код единицы измерения
		Если Не ЗначениеЗаполнено(Лист.Строка110КодЕдиницыИзмерения) Тогда
			ДобавитьОшибку("4110", ДанныеВыводаОшибкиСведенияОПредметеСделки(Лист), ТекущиеОшибки);
		КонецЕсли;
		
		ДлинаКодаЕдиницыИзмерения = СтрДлина(СокрЛП((Лист.Строка110КодЕдиницыИзмерения)));
		Если ДлинаКодаЕдиницыИзмерения < 3 Или ДлинаКодаЕдиницыИзмерения > 4 Тогда
			ДобавитьОшибку("4111", ДанныеВыводаОшибкиСведенияОПредметеСделки(Лист), ТекущиеОшибки);
		КонецЕсли;
		
		// Количество
		Если Лист.Строка120Количество <= 0 Тогда
			ДобавитьОшибку("4120", ДанныеВыводаОшибкиСведенияОПредметеСделки(Лист), ТекущиеОшибки);
		КонецЕсли;
		
		Если ОсновныеСведения.ВерсияУведомления >= КонтролируемыеСделкиКлиентСервер.ВерсияУведомления_2018() Тогда
			// Код валюты сделки
			Если Не ЗначениеЗаполнено(Лист.Строка140КодВалюты) Тогда
				ДобавитьОшибку("4170", ДанныеВыводаОшибкиСделка(Лист), ТекущиеОшибки);
			КонецЕсли;
			
			// Долговое обязательство должно быть заполнено.
			Если Лист.ТипПредметаСделки = Перечисления.ТипыПредметовКонтролируемыхСделок.ДолговоеОбязательство Тогда
				Если Не ЗначениеЗаполнено(Лист.Строка150ПроцентнаяСтавка) Тогда
					ДобавитьОшибку("4180", ДанныеВыводаОшибкиСделка(Лист), ТекущиеОшибки);
				КонецЕсли;
				
				Если ЗначениеЗаполнено(Лист.Строка130Цена)
					ИЛИ ЗначениеЗаполнено(Лист.Строка160Стоимость) Тогда
					ДобавитьОшибку("4190", ДанныеВыводаОшибкиСделка(Лист), ТекущиеОшибки);
				КонецЕсли;
			Иначе
				Если ЗначениеЗаполнено(Лист.Строка150ПроцентнаяСтавка) Тогда
					ДобавитьОшибку("4200", ДанныеВыводаОшибкиСделка(Лист), ТекущиеОшибки);
				КонецЕсли;
				Если Не ЗначениеЗаполнено(Лист.Строка130Цена)
					ИЛИ Не ЗначениеЗаполнено(Лист.Строка160Стоимость) Тогда
					ДобавитьОшибку("4210", ДанныеВыводаОшибкиСделка(Лист), ТекущиеОшибки);
				КонецЕсли;
			КонецЕсли;
			
		КонецЕсли;
		
	КонецЦикла;
	
	Ошибки.Добавить(ТекущиеОшибки, НСтр("ru = 'Лист 1Б';
										|en = 'Sheet 1B'"));
	
КонецПроцедуры

// Проверяет листы 1В на наличие ошибок. При наличии ошибок записывет описание ошибок в список по разделам уведомления.
//
// Параметры:
//  ОсновныеСведения - Структура - параметры основных сведений уведомления.
//  ЛистыУведомления - Структура - структура данных уведомления, разделенная по разделам в виде таблиц значений.
//  Ошибки           - СписокЗначений из ТаблицаЗначений - описание ошибок по разделам уведомления.
//
Процедура ПроверитьЛисты1В(ОсновныеСведения, ЛистыУведомления, Ошибки)
	
	Если ОсновныеСведения.ВерсияУведомления < КонтролируемыеСделкиКлиентСервер.ВерсияУведомления_2024() Тогда
		Возврат;
	КонецЕсли;
	
	ТекущиеОшибки = ОписаниеТаблицыОшибок();
	
	Для Каждого Лист Из ЛистыУведомления.ЛистыРаздела1В Цикл
		
		Если Лист.НомерЛиста1Б = 0
			И Не ЗначениеЗаполнено(Лист.КомментарийКЛисту1Б) Тогда
			ДобавитьОшибку("7010", ДанныеВыводаОшибкиСведенияОПоследующейРеализации(Лист), ТекущиеОшибки);
		КонецЕсли;
		
		КодИспользованияТовара = Перечисления.ТипыИспользованияПроисхожденияТовараКонтролируемыхСделок.КодДляВыгрузки(
			Лист.ИспользованиеПроисхождениеТовара);
		Если СтрНайти("|1|2|3|4|5|", "|" + КодИспользованияТовара + "|") = 0 Тогда
			ДобавитьОшибку("7020", ДанныеВыводаОшибкиСведенияОПоследующейРеализации(Лист), ТекущиеОшибки);
		КонецЕсли;
		
		Если КодИспользованияТовара = "5"
			И Не ЗначениеЗаполнено(Лист.НаименованиеИспользованияПроисхожденияТовара) Тогда
			ДобавитьОшибку("7030", ДанныеВыводаОшибкиСведенияОПоследующейРеализации(Лист), ТекущиеОшибки);
		КонецЕсли;
		
		НужноВыгружатьСведенияОСделке = Перечисления.ТипыИспользованияПроисхожденияТовараКонтролируемыхСделок.НужноВыгружатьСведенияОСделке(
			Лист.ИспользованиеПроисхождениеТовара);
		Если НужноВыгружатьСведенияОСделке Тогда
			
			ПрУчСд = Перечисления.ТипыУчастниковЦепочкиКонтролируемыхСделок.КодДляВыгрузки(Лист.ПризнакУчастникаСделки);
			
			Если ПрУчСд <> "3" И Не ЗначениеЗаполнено(Лист.Контрагент) Тогда
				ДобавитьОшибку("7040", ДанныеВыводаОшибкиСведенияОПоследующейРеализации(Лист), ТекущиеОшибки);
			КонецЕсли;
			
			Если ПрУчСд <> "3" И (Не ЗначениеЗаполнено(Лист.НомерДоговора)
				Или Не ЗначениеЗаполнено(Лист.ДатаДоговора)) Тогда
				ДобавитьОшибку("7050", ДанныеВыводаОшибкиСведенияОПоследующейРеализации(Лист), ТекущиеОшибки);
			КонецЕсли;
			
			Если ПрУчСд <> "3" И Не ЗначениеЗаполнено(Лист.СтранаСовершенияСделки) Тогда
				ДобавитьОшибку("7060", ДанныеВыводаОшибкиСведенияОПоследующейРеализации(Лист), ТекущиеОшибки);
			КонецЕсли;
			
			Если Лист.Количество <= 0 Тогда
				ДобавитьОшибку("7070", ДанныеВыводаОшибкиСведенияОПоследующейРеализации(Лист), ТекущиеОшибки);
			КонецЕсли;
			
			Если ПрУчСд <> "3" И Не ЗначениеЗаполнено(Лист.Цена) Тогда
				ДобавитьОшибку("7080", ДанныеВыводаОшибкиСведенияОПоследующейРеализации(Лист), ТекущиеОшибки);
			КонецЕсли;
			
			Если ПрУчСд <> "3" И Не ЗначениеЗаполнено(Лист.ДатаСовершенияСделки) Тогда
				ДобавитьОшибку("7090", ДанныеВыводаОшибкиСведенияОПоследующейРеализации(Лист), ТекущиеОшибки);
			КонецЕсли;
			
		КонецЕсли;
		
	КонецЦикла;
	
	Ошибки.Добавить(ТекущиеОшибки, "Лист 1В");
	
КонецПроцедуры

// Проверяет листы 1Г на наличие ошибок. При наличии ошибок записывет описание ошибок в список по разделам уведомления.
//
// Параметры:
//  ОсновныеСведения - Структура - параметры основных сведений уведомления.
//  ЛистыУведомления - Структура - структура данных уведомления, разделенная по разделам в виде таблиц значений.
//  Ошибки           - СписокЗначений из ТаблицаЗначений - описание ошибок по разделам уведомления.
//
Процедура ПроверитьЛисты1Г(ОсновныеСведения, ЛистыУведомления, Ошибки)
	
	Если ОсновныеСведения.ВерсияУведомления < КонтролируемыеСделкиКлиентСервер.ВерсияУведомления_2024() Тогда
		Возврат;
	КонецЕсли;
	
	ТекущиеОшибки = ОписаниеТаблицыОшибок();
	
	Для Каждого Лист Из ЛистыУведомления.ЛистыРаздела1Г Цикл
		
		Если Не ЗначениеЗаполнено(Лист.НомерЛиста1Б) Тогда
			ДобавитьОшибку("8010", ДанныеВыводаОшибкиСведенияОСопутствующихУслугах(Лист), ТекущиеОшибки);
		КонецЕсли;
		
		Если Не ЗначениеЗаполнено(Лист.НаименованиеУслуги) Тогда
			ДобавитьОшибку("8020", ДанныеВыводаОшибкиСведенияОСопутствующихУслугах(Лист), ТекущиеОшибки);
		КонецЕсли;
		
		Если Не ЗначениеЗаполнено(Лист.Контрагент) Тогда
			ДобавитьОшибку("8030", ДанныеВыводаОшибкиСведенияОСопутствующихУслугах(Лист), ТекущиеОшибки);
		КонецЕсли;
		
	КонецЦикла;
	
	Ошибки.Добавить(ТекущиеОшибки, "Лист 1Г");
	
КонецПроцедуры

// Проверяет листы раздела 2 на наличие ошибок. 
// При наличии ошибок записывет описание ошибок в список по разделам уведомления.
//
// Параметры:
//  ОсновныеСведения - Структура - параметры основных сведений уведомления.
//  ЛистыУведомления - Структура - структура данных уведомления, разделенная по разделам в виде таблиц значений.
//  Ошибки           - СписокЗначений из ТаблицаЗначений - описание ошибок по разделам уведомления.
//
Процедура ПроверитьЛистыРаздела2(ОсновныеСведения, ЛистыУведомления, Ошибки)
	
	ТекущиеОшибки = ОписаниеТаблицыОшибок();
	
	Для Каждого Лист Из ЛистыУведомления.ДанныеРаздела2 Цикл
		
		// Наименование контрагента
		Если Не ЗначениеЗаполнено(Лист.Строка040Наименование) Тогда
			ДобавитьОшибку("5010", Лист.Контрагент, ТекущиеОшибки);
		КонецЕсли;

		Если ЗначениеЗаполнено(Лист.Строка030КакКодСтраныРегистрации) Тогда 
			
			Если Лист.Строка020ТипОрганизации = 1 Тогда
				
				// ИНН/КПП
				Если Не ЗначениеЗаполнено(Лист.Строка050ИНН) Или СтрДлина(Лист.Строка050ИНН) <> 10
					Или Не ЗначениеЗаполнено(Лист.Строка060КПП) Или СтрДлина(Лист.Строка060КПП) <> 9 Тогда
					ДобавитьОшибку("5030", Лист.Контрагент, ТекущиеОшибки);
				КонецЕсли;
				
				Если ЗначениеЗаполнено(Лист.Строка050ИНН) Тогда
					РезультатПроверки = ИдентификационныеНомераНалогоплательщиковКлиентСервер.ПроверитьСоответствиеТребованиямИНН(
						Лист.Строка050ИНН, Истина);
					Если НЕ РезультатПроверки.СоответствуетТребованиям Тогда
						ДобавитьОшибку("5050", Лист.Контрагент, ТекущиеОшибки);
					КонецЕсли;
				КонецЕсли;
				
				Если ЗначениеЗаполнено(Лист.Строка060КПП) Тогда
					РезультатПроверки = ИдентификационныеНомераНалогоплательщиковКлиентСервер.ПроверитьСоответствиеТребованиямФорматаКПП(
						Лист.Строка060КПП, Истина);
					Если НЕ РезультатПроверки.СоответствуетТребованиям Тогда
						ДобавитьОшибку("5055", Лист.Контрагент, ТекущиеОшибки);
					КонецЕсли;
				КонецЕсли;
				
			Иначе
				
				Если ОсновныеСведения.ВерсияУведомления < КонтролируемыеСделкиКлиентСервер.ВерсияУведомления_2024() Тогда
					
					// Должен быть заполнен один из:
					//   Регистрационный номер в стране регистрации (инкорпорации)
					//   Код налогоплательщика в стране регистрации (инкорпорациии)
					
					ОшибкаЗаполнения = Не (ЗначениеЗаполнено(Лист.Строка070РегНомерВСтрокеРегистрации) ИЛИ ЗначениеЗаполнено(Лист.Строка080КодНалогВСтранеРегистрации));
					Если ОшибкаЗаполнения Тогда
						ДобавитьОшибку("5040", Лист.Контрагент, ТекущиеОшибки);
					КонецЕсли;
					
				КонецЕсли;
				
			КонецЕсли;
			
		Иначе
			
			// Страна регистрации
			ДобавитьОшибку("5020", Лист.Контрагент, ТекущиеОшибки);
			
		КонецЕсли;
		
	КонецЦикла;
	
	Ошибки.Добавить(ТекущиеОшибки, "Раздел 2");
	
КонецПроцедуры

// Проверяет листы раздела 3 на наличие ошибок. 
// При наличии ошибок записывет описание ошибок в список по разделам уведомления.
//
// Параметры:
//  ОсновныеСведения - Структура - параметры основных сведений уведомления.
//  ЛистыУведомления - Структура - структура данных уведомления, разделенная по разделам в виде таблиц значений.
//  Ошибки           - СписокЗначений из ТаблицаЗначений - описание ошибок по разделам уведомления.
//
Процедура ПроверитьЛистыРаздела3(ЛистыУведомления, Ошибки)
	
	ТекущиеОшибки = ОписаниеТаблицыОшибок();
	
	Для Каждого Лист Из ЛистыУведомления.ДанныеРаздела3 Цикл
		
		//
		Если Не ЗначениеЗаполнено(Лист.ФизическоеЛицо) Тогда
			ДобавитьОшибку("6010", ДанныеВыводаОшибкиСведенияОРегистрации(Лист.Контрагент), ТекущиеОшибки);
		КонецЕсли;
		
		// Код вида деятельности
		Если Не ЗначениеЗаполнено(Лист.Строка020КодВидаДеятельности) Тогда
			ДобавитьОшибку("6030", ДанныеВыводаОшибкиСведенияОРегистрации(Лист.Контрагент), ТекущиеОшибки);
		КонецЕсли;
		
		Если Не ЗначениеЗаполнено(Лист.ФизическоеЛицо) Тогда
			Продолжить;
		КонецЕсли;
		
		// Фамилия, имя физ. лица
		Если Не ЗначениеЗаполнено(Лист.Фамилия) Или Не ЗначениеЗаполнено(Лист.Имя) Тогда
			ДобавитьОшибку("6020", Лист.ФизическоеЛицо, ТекущиеОшибки);
		КонецЕсли;
		
		Если Не ЗначениеЗаполнено(Лист.Строка030ИНН) Тогда
			
			// Дата рождения
			Если Не ЗначениеЗаполнено(Лист.ДатаРождения) Тогда
				ДобавитьОшибку("6050", Лист.ФизическоеЛицо, ТекущиеОшибки);
			КонецЕсли;
			
			// Место рождения
			МестоРождения = ПерсонифицированныйУчетКлиентСервер.ПредставлениеМестаРождения(Лист.МестоРождения);
			Если Не ЗначениеЗаполнено(МестоРождения) Тогда
				ДобавитьОшибку("6060", Лист.ФизическоеЛицо, ТекущиеОшибки);
			КонецЕсли;
			
			// Сведения о гражданстве
			Если Не ЗначениеЗаполнено(Лист.ГражданствоФизЛицСтрана) Тогда
				ДобавитьОшибку("6070", Лист.ФизическоеЛицо, ТекущиеОшибки);
			КонецЕсли;
			
			Если Лист.ГражданствоФизЛицСтрана = Справочники.СтраныМира.Россия ИЛИ Не ЗначениеЗаполнено(Лист.ГражданствоФизЛицСтрана) Тогда
				
				// ИНН физ. лица.
				ДобавитьОшибку("6040", Лист.Контрагент, ТекущиеОшибки);
				
				// Адрес места жительства/прибывания
				АдресСтруктурой = РаботаСАдресами.СведенияОбАдресе(Лист.КонтактнаяИнформацияЗначенияПолей);
				
				АдресЗаполнен = АдресСтруктурой.Свойство("КодРегиона") И ЗначениеЗаполнено(АдресСтруктурой.КодРегиона);  
				Если Не АдресЗаполнен Тогда
					ДобавитьОшибку("6080", Лист.ФизическоеЛицо, ТекущиеОшибки);	
				КонецЕсли;
				
			Иначе
				
				// Адрес за пределами РФ
				АдресЗаполнен = ЗначениеЗаполнено(Лист.КонтактнаяИнформацияЗаРФСтрана) И ЗначениеЗаполнено(Лист.КонтактнаяИнформацияЗаРФПредставление); 
				Если Не АдресЗаполнен Тогда
					ДобавитьОшибку("6090", Лист.ФизическоеЛицо, ТекущиеОшибки);
				КонецЕсли;
				
			КонецЕсли;
			
			// Документ удостоверяющий личность
			// Код вида документа, серия, номер, дата выдачи, кем выдан.
			КодВидаДокумента = КонтролируемыеСделкиПовтИсп.ПолучитьКодВидаДокументаПоВидуДокумента(Лист.ВидДокумента);
			
			ДанныеДокументаЗаполнены = ЗначениеЗаполнено(КодВидаДокумента) И ЗначениеЗаполнено(Лист.ДокументСерия) И ЗначениеЗаполнено(Лист.ДокументНомер)
				И ЗначениеЗаполнено(Лист.ДокументДатаВыдачи) И ЗначениеЗаполнено(Лист.ДокументКемВыдан);
				
			Если Не ДанныеДокументаЗаполнены Тогда
				ДобавитьОшибку("6100", Лист.ФизическоеЛицо, ТекущиеОшибки);
			КонецЕсли;
			
		Иначе
			
			Если ЗначениеЗаполнено(Лист.Строка030ИНН) Тогда
				РезультатПроверки = ИдентификационныеНомераНалогоплательщиковКлиентСервер.ПроверитьСоответствиеТребованиямИНН(
					Лист.Строка030ИНН, Ложь);
				Если НЕ РезультатПроверки.СоответствуетТребованиям Тогда
					ДобавитьОшибку("6045", Лист.Контрагент, ТекущиеОшибки);
				КонецЕсли;
			КонецЕсли;
			
		КонецЕсли;
		
	КонецЦикла;
	
	Ошибки.Добавить(ТекущиеОшибки, "Раздел 3");
	
КонецПроцедуры

// Проверяет листы раздела 4 на наличие ошибок. 
// При наличии ошибок записывет описание ошибок в список по разделам уведомления.
//
// Параметры:
//  ОсновныеСведения - Структура - параметры основных сведений уведомления.
//  ЛистыУведомления - Структура - структура данных уведомления, разделенная по разделам в виде таблиц значений.
//  Ошибки           - СписокЗначений из ТаблицаЗначений - описание ошибок по разделам уведомления.
//
Процедура ПроверитьЛистыРаздела4(ОсновныеСведения, ЛистыУведомления, Ошибки)
	
	Если ОсновныеСведения.ВерсияУведомления < КонтролируемыеСделкиКлиентСервер.ВерсияУведомления_2024() Тогда
		Возврат;
	КонецЕсли;
	
	ТекущиеОшибки = ОписаниеТаблицыОшибок();
	
	Для Каждого Лист Из ЛистыУведомления.ДанныеРаздела4 Цикл
		
		Если Не ЗначениеЗаполнено(Лист.НаименованиеКонтрагента) Тогда
			ДобавитьОшибку("9010", ДанныеВыводаОшибкиСведенияОРегистрации(Лист.Контрагент), ТекущиеОшибки);
		КонецЕсли;
		
		Если Не ЗначениеЗаполнено(Лист.КодСтраныРегистрации) Тогда
			ДобавитьОшибку("9020", ДанныеВыводаОшибкиСведенияОРегистрации(Лист.Контрагент), ТекущиеОшибки);
		КонецЕсли;
		
		Если Не ЗначениеЗаполнено(Лист.РегистрационныйНомер) Тогда
			ДобавитьОшибку("9030", ДанныеВыводаОшибкиСведенияОРегистрации(Лист.Контрагент), ТекущиеОшибки);
		КонецЕсли;
		
	КонецЦикла;
	
	Ошибки.Добавить(ТекущиеОшибки, "Раздел 4");
	
КонецПроцедуры

// Формирует информацию по ошибка в уведомлении. 
// При наличии ошибок записывет описание ошибок в список по разделам уведомления.
//
// Параметры:
//  ИнформацияОбОшибках - ДеревоЗначений - параметры информации об ошибке.
//  Ошибки           - СписокЗначений из ТаблицаЗначений - описание ошибок по разделам уведомления.
//
Процедура СформироватьИнформациюОбОшибках(ИнформацияОбОшибках, Ошибки)
	
	ПредставлениеОшибок = ПолучитьОписаниеОшибок();
	
	Для Каждого Ошибка Из Ошибки Цикл
		
		РазделОтчета  = Ошибка.Представление;
		ТаблицаОшибок = Ошибка.Значение;
		
		ОписаниеОшибки = ВыводСообщенийОбОшибках.ДобавитьОписаниеОшибки(ИнформацияОбОшибках);
		
		СекцияРазделОтчета = ВыводСообщенийОбОшибках.ДобавитьСекцию(ОписаниеОшибки, "Раздел", РазделОтчета);
		
		Если ТаблицаОшибок.Количество() > 0 Тогда
			
			ТаблицаОшибок.Сортировать("Код");
			
			Для Каждого ДанныеОшибки Из ТаблицаОшибок Цикл
				
				ОписаниеОшибки = ПредставлениеОшибок.Найти(ДанныеОшибки.Код, "Код");
				
				Если ОписаниеОшибки = Неопределено Тогда
					Продолжить;
				КонецЕсли;
				
				СекцияОшибка = ВыводСообщенийОбОшибках.ДобавитьСекцию(СекцияРазделОтчета, "Раздел", ОписаниеОшибки.Текст);
				
				Если ЗначениеЗаполнено(ОписаниеОшибки.Описание) Тогда
					ВыводСообщенийОбОшибках.ДобавитьСекцию(СекцияОшибка, "Текст", ОписаниеОшибки.Описание);
				КонецЕсли;
				
				Если ЗначениеЗаполнено(ОписаниеОшибки.Рекомендации) Тогда
					ВыводСообщенийОбОшибках.ДобавитьСекцию(СекцияОшибка, "Текст", ОписаниеОшибки.Рекомендации);
				КонецЕсли;
				
				Для Каждого ЭлементКоллекции Из ДанныеОшибки.Объекты Цикл
					Если ТипЗнч(ЭлементКоллекции.Значение) = Тип("Структура") Тогда
						ВыводСообщенийОбОшибках.ДобавитьСекцию(СекцияОшибка, "СсылкаПроизвольная", ЭлементКоллекции.Значение);
					Иначе
						ВыводСообщенийОбОшибках.ДобавитьСекцию(СекцияОшибка, "Ссылка", ЭлементКоллекции.Значение);
					КонецЕсли;
				КонецЦикла;
				
			КонецЦикла;
			
		Иначе
			
			ВыводСообщенийОбОшибках.ДобавитьСекцию(СекцияРазделОтчета, "Текст", НСтр("ru = 'Ошибок не обнаружено.';
																					|en = 'No errors detected.'"));
			
		КонецЕсли;
		
	КонецЦикла;
	
КонецПроцедуры

// Добавляет ошибку в таблицу значний ошибок.
// Параметры:
//  КодОшибки     - Строка - код ошибки.
//  Объект        - СправочникСсылка.РегистрацииВНалоговомОргане - сведения о регистрации в налоговых органах 
//                                                                 обособленных подразделений, не выделенных на баланс.
//  ТаблицаОшибок - ТаблицаЗначений - таблица описания ошибок.
//
Процедура ДобавитьОшибку(КодОшибки, Объект, ТаблицаОшибок)
	
	ДанныеОшибки = ТаблицаОшибок.Найти(КодОшибки, "Код");
	
	Если ДанныеОшибки = Неопределено Тогда
		ДанныеОшибки = ТаблицаОшибок.Добавить();
		ДанныеОшибки.Код 	 = КодОшибки;
		ДанныеОшибки.Объекты = Новый Соответствие;
	КонецЕсли;
	
	Если ТипЗнч(Объект) = Тип("Структура") Тогда
		ДанныеОшибки.Объекты.Вставить(Объект.Ключ, Объект);	
	Иначе
		ДанныеОшибки.Объекты.Вставить(Объект, Объект);	
	КонецЕсли;
	
КонецПроцедуры

// Получает таблицу значений с описанием ошибок в уведомлении о контролируемых сделках.
// Возвращаемое значение:
//  ТаблицаЗначений - структура полей:
// * Код          - Строка - код ошибки.
// * Текст        - Строка - описание места ошибки.
// * Описание     - Строка - описание причины ошибки.
// * Рекомендации - Строка - рекоммендации по устранению ошибки.
//
Функция ПолучитьОписаниеОшибок()
	
	ОписаниеТиповСтрока = Новый ОписаниеТипов("Строка");
	
	Таблица = Новый ТаблицаЗначений;
	
	Таблица.Колонки.Добавить("Код", ОписаниеТиповСтрока);
	Таблица.Колонки.Добавить("Текст", ОписаниеТиповСтрока);
	Таблица.Колонки.Добавить("Описание", ОписаниеТиповСтрока);
	Таблица.Колонки.Добавить("Рекомендации", ОписаниеТиповСтрока);
	
	Макет = ПолучитьМакет("ОписаниеОшибок");
	ОписаниеОшибок = Макет.ПолучитьОбласть("ОписаниеОшибок");
	
	Для НомерСтроки = 1 По Макет.ВысотаТаблицы Цикл
		
		Код = ОписаниеОшибок.Область(НомерСтроки, 1).Текст;
		
		Если Не ЗначениеЗаполнено(Код) Тогда
			Продолжить;
		КонецЕсли;
		
		НоваяСтрока = Таблица.Добавить();
		НоваяСтрока.Код = Код;
		НоваяСтрока.Текст = ОписаниеОшибок.Область(НомерСтроки, 2).Текст;
		НоваяСтрока.Описание = ОписаниеОшибок.Область(НомерСтроки, 3).Текст;
		НоваяСтрока.Рекомендации = ОписаниеОшибок.Область(НомерСтроки, 4).Текст;
		
	КонецЦикла;
	
	Таблица.Индексы.Добавить("Код");
	
	Возврат Таблица;
	
КонецФункции

// Возвращает таблицу значений описания ошибок.
//
// Возвращаемое значение:
//  ТаблицаЗначений - таблица значений с описанием параметров ошибок.
//
Функция ОписаниеТаблицыОшибок()
	
	Таблица = Новый ТаблицаЗначений;
	Таблица.Колонки.Добавить("Код");
	Таблица.Колонки.Добавить("Объекты");
	
	Возврат Таблица;
	
КонецФункции

// Возвращает структуру описания ошибки сведений регистрации контрагента.
//
// Параметры:
//  Контрагент      - СправочникСсылка.Контрагенты, СправочникСсылка.Организации - проверяемый контрагент.
// Возвращаемое значение:
//  Структура       - структура описания ошибоки сведений регистрации контрагента:
//  * Ключ          - СправочникСсылка.Контрагенты, СправочникСсылка.Организации - ссылка на контрагента.
//  * Ссылка        - Структура - парамерты расшифровки.
//  * Представление - Строка - описане ошибки.
//
Функция ДанныеВыводаОшибкиСведенияОРегистрации(Контрагент)
	
	Расшифровка = ВыводСообщенийОбОшибках.НовыйОписаниеРасшифровки("ФормаЗаписиУчастникиКонтролируемыхСделок");
	Расшифровка.Вставить("Контрагент", Контрагент);
	
	ДанныеВывода = Новый Структура;
	ДанныеВывода.Вставить("Ключ",   Контрагент);
	ДанныеВывода.Вставить("Ссылка", Расшифровка);
	ДанныеВывода.Вставить("Представление", СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
		НСтр("ru = 'Сведения о регистрации %1';
			|en = 'Information on registration %1'"),
		Контрагент));
	
	Возврат ДанныеВывода;

КонецФункции

// Возвращает структуру описания ошибки сведений о предмете сделки.
//
// Параметры:
//  ДанныеЛиста     - СтрокаТаблицыЗначений - проверяемый предмет сделки.
// Возвращаемое значение:
//  Структура       - структура описания ошибоки сведений регистрации контрагента:
//  * Ключ          - Строка - навигационная ссылка.
//  * Ссылка        - Структура - парамерты расшифровки.
//  * Представление - Строка - описане ошибки.
//
Функция ДанныеВыводаОшибкиСведенияОПредметеСделки(ДанныеЛиста)
	
	КлючОбъекта = ПолучитьНавигационнуюСсылку(ДанныеЛиста.Сделка, "Сделки.НомерСтроки", ДанныеЛиста.НомерСтроки - 1);
	
	Расшифровка = ВыводСообщенийОбОшибках.НовыйОписаниеРасшифровки("ФормаДокументаСтрокаТабличнойЧасти");
	Расшифровка.Вставить("Объект", "Документ.КонтролируемаяСделка");
	Расшифровка.Вставить("Документ", ДанныеЛиста.Сделка);
	Расшифровка.Вставить("ИмяТабличнойЧасти", "Сделки");
	Расшифровка.Вставить("НомерСтроки", ДанныеЛиста.НомерСтроки);
	
	ДанныеВывода = Новый Структура;
	
	ДанныеВывода.Вставить("Ключ", 	КлючОбъекта);
	ДанныеВывода.Вставить("Ссылка", Расшифровка);
	ДанныеВывода.Вставить("Представление", СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
		НСтр("ru = 'Лист 1А № %1, листы 1Б, строка %2';
			|en = 'Sheet 1A No. %1, sheets 1B, line %2'"),
		ДанныеЛиста.НомерЛиста1А,
		ДанныеЛиста.НомерСтроки));
	
	Возврат ДанныеВывода;

КонецФункции

// Возвращает структуру описания ошибки сведений о последующей реализации в цепочке сделок.
//
// Параметры:
//  ДанныеЛиста     - СтрокаТаблицыЗначений - проверяемая последующая реализация в цепочке сделок.
// Возвращаемое значение:
//  Структура       - структура описания ошибоки сведений регистрации контрагента:
//  * Ключ          - Строка - навигационная ссылка.
//  * Ссылка        - Структура - парамерты расшифровки.
//  * Представление - Строка - описане ошибки.
//
Функция ДанныеВыводаОшибкиСведенияОПоследующейРеализации(ДанныеЛиста)
	
	КлючОбъекта = ПолучитьНавигационнуюСсылку(ДанныеЛиста.Сделка, "Листы1В.НомерСтроки", ДанныеЛиста.НомерСтроки - 1);
	
	Расшифровка = ВыводСообщенийОбОшибках.НовыйОписаниеРасшифровки("ФормаДокументаСтрокаТабличнойЧасти");
	Расшифровка.Вставить("Объект", "Документ.КонтролируемаяСделка");
	Расшифровка.Вставить("Документ", ДанныеЛиста.Сделка);
	Расшифровка.Вставить("ИмяТабличнойЧасти", "Листы1В");
	Расшифровка.Вставить("НомерСтроки", ДанныеЛиста.НомерСтроки);
	
	ДанныеВывода = Новый Структура;
	
	ДанныеВывода.Вставить("Ключ", 	КлючОбъекта);
	ДанныеВывода.Вставить("Ссылка", Расшифровка);
	ДанныеВывода.Вставить("Представление", СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
		НСтр("ru = 'Лист 1А № %1, листы 1В, строка %2';
			|en = 'Лист 1А № %1, листы 1В, строка %2'"),
		ДанныеЛиста.НомерЛиста1А,
		ДанныеЛиста.НомерСтроки));
	
	Возврат ДанныеВывода;

КонецФункции

// Возвращает структуру описания ошибки сведений о сопутсвтсвующих услугах в цепочке сделок.
//
// Параметры:
//  ДанныеЛиста     - СтрокаТаблицыЗначений - проверяемые сопутсвтсвующие услуги в цепочке сделок.
// Возвращаемое значение:
//  Структура       - структура описания ошибоки сведений регистрации контрагента:
//  * Ключ          - Строка - навигационная ссылка.
//  * Ссылка        - Структура - парамерты расшифровки.
//  * Представление - Строка - описане ошибки.
//
Функция ДанныеВыводаОшибкиСведенияОСопутствующихУслугах(ДанныеЛиста)
	
	КлючОбъекта = ПолучитьНавигационнуюСсылку(ДанныеЛиста.Сделка, "Листы1Г.НомерСтроки", ДанныеЛиста.НомерСтроки - 1);
	
	Расшифровка = ВыводСообщенийОбОшибках.НовыйОписаниеРасшифровки("ФормаДокументаСтрокаТабличнойЧасти");
	Расшифровка.Вставить("Объект", "Документ.КонтролируемаяСделка");
	Расшифровка.Вставить("Документ", ДанныеЛиста.Сделка);
	Расшифровка.Вставить("ИмяТабличнойЧасти", "Листы1Г");
	Расшифровка.Вставить("НомерСтроки", ДанныеЛиста.НомерСтроки);
	
	ДанныеВывода = Новый Структура;
	
	ДанныеВывода.Вставить("Ключ", 	КлючОбъекта);
	ДанныеВывода.Вставить("Ссылка", Расшифровка);
	ДанныеВывода.Вставить("Представление", СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
		НСтр("ru = 'Лист 1А № %1, листы 1Г, строка %2';
			|en = 'Лист 1А № %1, листы 1Г, строка %2'"),
		ДанныеЛиста.НомерЛиста1А,
		ДанныеЛиста.НомерСтроки));
	
	Возврат ДанныеВывода;

КонецФункции

// Возвращает структуру описания ошибки сведений о контролируемой сделке.
//
// Параметры:
//  ДанныеЛиста     - СтрокаТаблицыЗначений - проверяемая сделка.
// Возвращаемое значение:
//  Структура       - структура описания ошибоки сведений регистрации контрагента:
//  * Ключ          - ДокументСсылка.КонтролируемаяСделка - ссылка на сделку.
//  * Ссылка        - Структура - парамерты расшифровки.
//  * Представление - Строка - описане ошибки.
//
Функция ДанныеВыводаОшибкиСделка(ДанныеЛиста)
	
	Расшифровка = ВыводСообщенийОбОшибках.НовыйОписаниеРасшифровки("Ссылка");
	Расшифровка.Вставить("Ссылка", ДанныеЛиста.Сделка);
	
	ДанныеВывода = Новый Структура;
	ДанныеВывода.Вставить("Ключ",   ДанныеЛиста.Сделка);
	ДанныеВывода.Вставить("Ссылка", Расшифровка);
	ДанныеВывода.Вставить("Представление", СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
		НСтр("ru = 'Лист 1А № %1';
			|en = 'Sheet 1A No. %1'"),
		ДанныеЛиста.НомерЛиста1А));
	
	Возврат ДанныеВывода;
	
КонецФункции

#КонецОбласти

#Область ОбновлениеИнформационнойБазы

// Устанавливает версию уведомления о контролируемых сделках.
Процедура УстановитьВерсиюУведомленияОКонтролируемыхСделках() Экспорт
	
	Запрос = Новый Запрос();
	Запрос.Текст =
	"ВЫБРАТЬ
	|	УведомлениеОКонтролируемыхСделках.Ссылка КАК Уведомление,
	|	УведомлениеОКонтролируемыхСделках.ОтчетныйГод
	|ИЗ
	|	Документ.УведомлениеОКонтролируемыхСделках КАК УведомлениеОКонтролируемыхСделках
	|ГДЕ
	|	УведомлениеОКонтролируемыхСделках.ВерсияУведомления = 0";
	
	Выборка = Запрос.Выполнить().Выбрать();
	Пока Выборка.Следующий() Цикл
		ОбъектУведомление = Выборка.Уведомление.ПолучитьОбъект();
		ОбъектУведомление.ВерсияУведомления = Документы.УведомлениеОКонтролируемыхСделках.ВерсияУведомленияПоОтчетномуГоду(Выборка.ОтчетныйГод);
		ОбновлениеИнформационнойБазы.ЗаписатьОбъект(ОбъектУведомление);
	КонецЦикла;
	
КонецПроцедуры

// Устанавливает версию уведомления о контролируемых сделках с 2019 года.
Процедура УстановитьВерсиюУведомленияОКонтролируемыхСделках2019() Экспорт
	
	Версия2019 = КонтролируемыеСделкиКлиентСервер.ВерсияУведомления_2019();
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("Версия2019", Версия2019);
	Запрос.Текст =
	"ВЫБРАТЬ
	|	УведомлениеОКонтролируемыхСделках.Ссылка КАК Ссылка
	|ИЗ
	|	Документ.УведомлениеОКонтролируемыхСделках КАК УведомлениеОКонтролируемыхСделках
	|ГДЕ
	|	УведомлениеОКонтролируемыхСделках.ОтчетныйГод >= ДАТАВРЕМЯ(2019, 1, 1)
	|	И УведомлениеОКонтролируемыхСделках.ВерсияУведомления <> &Версия2019";
	
	Выборка = Запрос.Выполнить().Выбрать();
	Пока Выборка.Следующий() Цикл
		УведомлениеОбъект = Выборка.Ссылка.ПолучитьОбъект();
		УведомлениеОбъект.ВерсияУведомления = Версия2019;
		ОбновлениеИнформационнойБазы.ЗаписатьОбъект(УведомлениеОбъект);
	КонецЦикла;
	
КонецПроцедуры

// Устанавливает версию уведомления о контролируемых сделках с 2021 года.
Процедура УстановитьВерсиюУведомленияОКонтролируемыхСделках2021() Экспорт
	
	Версия2021 = КонтролируемыеСделкиКлиентСервер.ВерсияУведомления_2021();
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("Версия2021", Версия2021);
	Запрос.Текст =
	"ВЫБРАТЬ
	|	УведомлениеОКонтролируемыхСделках.Ссылка КАК Ссылка
	|ИЗ
	|	Документ.УведомлениеОКонтролируемыхСделках КАК УведомлениеОКонтролируемыхСделках
	|ГДЕ
	|	УведомлениеОКонтролируемыхСделках.ОтчетныйГод >= ДАТАВРЕМЯ(2021, 1, 1)
	|	И УведомлениеОКонтролируемыхСделках.ВерсияУведомления <> &Версия2021";
	
	Выборка = Запрос.Выполнить().Выбрать();
	Пока Выборка.Следующий() Цикл
		УведомлениеОбъект = Выборка.Ссылка.ПолучитьОбъект();
		УведомлениеОбъект.ВерсияУведомления = Версия2021;
		ОбновлениеИнформационнойБазы.ЗаписатьОбъект(УведомлениеОбъект);
	КонецЦикла;
	
КонецПроцедуры

// Устанавливает версию уведомления о контролируемых сделках с 2024 года.
Процедура УстановитьВерсиюУведомленияОКонтролируемыхСделках2024() Экспорт
	
	Версия2024 = КонтролируемыеСделкиКлиентСервер.ВерсияУведомления_2024();
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("Версия2024", Версия2024);
	Запрос.Текст =
	"ВЫБРАТЬ
	|	УведомлениеОКонтролируемыхСделках.Ссылка КАК Ссылка
	|ИЗ
	|	Документ.УведомлениеОКонтролируемыхСделках КАК УведомлениеОКонтролируемыхСделках
	|ГДЕ
	|	УведомлениеОКонтролируемыхСделках.ОтчетныйГод >= ДАТАВРЕМЯ(2024, 1, 1)
	|	И УведомлениеОКонтролируемыхСделках.ВерсияУведомления <> &Версия2024";
	
	Выборка = Запрос.Выполнить().Выбрать();
	Пока Выборка.Следующий() Цикл
		УведомлениеОбъект = Выборка.Ссылка.ПолучитьОбъект();
		УведомлениеОбъект.ВерсияУведомления = Версия2024;
		ОбновлениеИнформационнойБазы.ЗаписатьОбъект(УведомлениеОбъект);
	КонецЦикла;
	
КонецПроцедуры

#КонецОбласти
#КонецОбласти

#КонецЕсли
