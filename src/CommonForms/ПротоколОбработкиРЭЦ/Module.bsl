
&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	ТипИсточника = ТипЗнч(Параметры.ИсточникСсылка);
	
	Отправка = Неопределено;
	
	Если ТипИсточника = Тип("СправочникСсылка.ОтправкиРЭЦ") Тогда
		Отправка = Параметры.ИсточникСсылка;	
	Иначе 
		Отправка = ДокументооборотСРЭЦ.ПолучитьПоследнююОтправкуОтчета(Параметры.ИсточникСсылка);
	КонецЕсли;
	
	Если ЗначениеЗаполнено(Отправка) Тогда        
		Если ЗначениеЗаполнено(Отправка.Протокол) Тогда
			ПротоколДД = РаботаСФайлами.ДвоичныеДанныеФайла(Отправка.Протокол);
			ТекстJSON = ПолучитьСтрокуИзДвоичныхДанных(ПротоколДД);   
			ОбъектПротокол = ПолучитьОбъектИзJSON(ТекстJSON);
			
			HTMLТекст = "<html>";		
			Если ОбъектПротокол.status = "success" Тогда
				HTMLТекст = HTMLТекст + "
					|<h1><font color=""green"">Проверка пройдена</font></h1><br/>";
			Иначе     
				HTMLТекст = HTMLТекст + "
					|<h1><font color=""red"">Проверка не пройдена</font></h1><br/>
					|<span>Ошибки:</span>
					|<br/>  
					|<ul>"; 
				Для Каждого Ошибка Из ОбъектПротокол.errors Цикл 
	    			HTMLТекст = HTMLТекст + "<li>" + Ошибка + "</li>";
				КонецЦикла;
				HTMLТекст = HTMLТекст + "
					|</ul>";          
			КонецЕсли;    
			HTMLТекст = HTMLТекст + "
					|</html>";  
		Иначе
			HTMLТекст = "<html>
						|<h1><font color=""black"">Протокол отсутствует</font></h1>
						|</html>";	
		КонецЕсли;
	Иначе
		Отказ = Истина;
	КонецЕсли;
	
	Если Отправка.СтатусОтправки = Перечисления.СтатусыОтправки.Сдан Тогда
		Заголовок = НСтр("ru = 'Протокол о сдаче';
						|en = 'Протокол о сдаче'");
	Иначе
		Заголовок = НСтр("ru = 'Протокол ошибок';
						|en = 'Протокол ошибок'");
	КонецЕсли;
	
	Элементы.КнопкаПечать.Видимость = Параметры.Свойство("ПечатьВозможна") И Параметры.ПечатьВозможна = Истина;
	
КонецПроцедуры

Функция ПолучитьОбъектИзJSON(Текст)
	
	ЧтениеJSON = Новый ЧтениеJSON;
	ЧтениеJSON.УстановитьСтроку(Текст);
	Объект = ПрочитатьJSON(ЧтениеJSON);
	ЧтениеJSON.Закрыть();
	
	Возврат Объект;
	
КонецФункции

&НаКлиенте
Процедура Печать(Команда)
	
	Элементы.HTMLТекст.Документ.execCommand("Print");
	
КонецПроцедуры
