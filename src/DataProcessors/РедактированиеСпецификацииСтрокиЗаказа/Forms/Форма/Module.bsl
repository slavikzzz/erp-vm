//++ Устарело_Производство21
#Область ОписаниеПеременных

&НаКлиенте
Перем КэшированныеЗначения;

#КонецОбласти

#Область ОбработчикиСобытийФормы

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	Если Параметры.Свойство("АвтоТест") Тогда
		Возврат;
	КонецЕсли;
	
	Если НЕ ЭтоАдресВременногоХранилища(Параметры.АдресСпецификация) Тогда
		ТекстСообщения = НСтр("ru = 'Непосредственное открытие формы ""Редактирование спецификации строки заказа"" не предусмотрено. 
			|Для открытия формы можно воспользоваться командой ""Изменить позицию заказа"" в форме документа ""Заказ на производство"".';
			|en = 'Direct opening of the ""Edit order line BOM"" form is not possible. 
			|To open the form, click ""Change order item"" in the ""Production order"" document form.'");
		ВызватьИсключение ТекстСообщения;
	КонецЕсли;
	
	// Инициализируем настройки формы
	ЗаполнитьРеквизитыПоПараметрамФормы();
	
	ПараметрыВстраивания = Обработки.РедактированиеСпецификацииСтрокиЗаказа.ДоступныеОстаткиПараметрыВстраивания();
	ОбеспечениеВДокументахСервер.ДоступныеОстаткиПриСозданииНаСервере(ЭтотОбъект, ПараметрыВстраивания);
	
	УстановитьУсловноеОформление();
	
	Параметры.Свойство("ЗаписыватьРезультатРедактирования", ЗаписыватьРезультатРедактирования);
	
	ИспользованиеУпаковок      = ПолучитьФункциональнуюОпцию("ИспользоватьУпаковкиНоменклатуры");
	ХарактеристикиИспользуются = ПолучитьФункциональнуюОпцию("ИспользоватьХарактеристикиНоменклатуры");
	
	//++ НЕ УТКА
	ПравоЧтенияАналогов = ПолучитьФункциональнуюОпцию("ИспользоватьАналогиМатериалов")
						  И ПравоДоступа("Чтение", Метаданные.РегистрыСведений.АналогиМатериалов);
	//-- НЕ УТКА					  
	
	УправлениеФормой();
	
	НаборУпаковок = ДанныеПродукции.НаборУпаковок;
	
	Элементы.Упаковка.Видимость = ЗначениеЗаполнено(НаборУпаковок);
	Элементы.ЕдиницаИзмерения.Видимость = Не ЗначениеЗаполнено(НаборУпаковок) Или Не ДанныеПродукции.ИспользоватьУпаковки Или Не ИспользованиеУпаковок;
	
	ПараметрыВыбора = Новый Структура("Номенклатура", Объект.Номенклатура);
	ДанныеВыбора = ПолучитьДанныеВыбора(Тип("СправочникСсылка.УпаковкиЕдиницыИзмерения"), ПараметрыВыбора);
	СписокВыбора = Элементы.Упаковка.СписокВыбора;
	
	Для каждого ЗначениеВыбора Из ДанныеВыбора Цикл
		СписокВыбора.Добавить(ЗначениеВыбора.Значение, ЗначениеВыбора.Представление);
	КонецЦикла;
	
	Если ЗначениеЗаполнено(Объект.Упаковка) Тогда
		Упаковка = Объект.Упаковка;
	КонецЕсли;
	
	// Характеристики.
	Если Не ЗначениеЗаполнено(Объект.Характеристика) Тогда
		Элементы.Характеристика.Доступность = Ложь;
	КонецЕсли;
	
	// Тип номенклатуры.
	Если ДанныеПродукции.ЭтоРабота Тогда
		Элементы.Склад.Видимость = Ложь;
	Иначе
		Элементы.Подразделение.Видимость = Ложь;
	КонецЕсли;
	
	//++ Устарело_Переработка24
	ИспользуетсяПроизводствоНаСтороне = Константы.ИспользоватьПроизводствоНаСтороне.Получить();
	//-- Устарело_Переработка24
	
	ПланированиеПроизводства.ПостроитьСтруктуруЭтапов(Объект.Этапы);
	
	НастроитьОтображениеПредупрежденийПриРедактировании();
	
	ПараметрыУказанияСерий = Новый ФиксированнаяСтруктура(НоменклатураСервер.ПараметрыУказанияСерий(Объект, Документы.ЗаказНаПроизводство));
	Элементы.МатериалыИУслугиСерия.Видимость = ПараметрыУказанияСерий.ИспользоватьСерииНоменклатуры;
	
	// Обработчик механизма "Назначения".
	Справочники.Назначения.ФормаДокументаПриСозданииНаСервере(ЭтаФорма);
	
	ПараметрыВыбораСпецификаций = УправлениеДаннымиОбИзделиях.ПараметрыВыбораСпецификаций(Объект, Обработки.РедактированиеСпецификацииСтрокиЗаказа);
	УправлениеДаннымиОбИзделияхКлиентСервер.УстановитьПараметрыВыбораСпецификаций(Элементы.Спецификация, ПараметрыВыбораСпецификаций);
	
	ОбеспечениеВДокументахСервер.ДоступныеОстаткиПриЧтенииНаСервере(ЭтотОбъект, ПараметрыВстраивания);
	РаботаСТабличнымиЧастями.ИнициализироватьКэшСтрок(Элементы.МатериалыИУслуги);
	
КонецПроцедуры

&НаКлиенте
Процедура ПриОткрытии(Отказ)
	ОбновитьСостояниеСпецификацииЗаказа(ЭтаФорма);
КонецПроцедуры

&НаКлиенте
Процедура ОбработкаВыбора(ВыбранноеЗначение, ИсточникВыбора)
	
	ОбработкаВыбораВыполнена = Ложь;
	ТребуетсяРассчитатьГрафик = Ложь;

	// &ЗамерПроизводительности
	ОценкаПроизводительностиКлиент.НачатьЗамерВремени(Истина,
		"Обработка.РедактированиеСпецификацииСтрокиЗаказа.Форма.Форма.Событие.ОбработкаВыбора");
	
	Если ИсточникВыбора.ИмяФормы = "Обработка.ПодборТоваровВДокументПродажи.Форма.Форма" Тогда
		
		ОбработкаВыбораПодборНаКлиенте(ВыбранноеЗначение);
		
		ОбработкаВыбораВыполнена = Истина;
		ТребуетсяРассчитатьГрафик = Истина;
		
	//++ НЕ УТКА	
	ИначеЕсли ИсточникВыбора.ИмяФормы = "Документ.РазрешениеНаЗаменуМатериалов.Форма.ПодборАналогов" Тогда
		
		ЗаменитьНаАналоги(ВыбранноеЗначение.АдресВХранилище);
	//-- НЕ УТКА
		
	КонецЕсли;
	
	Модифицированность = Истина;
	
	Объект.ЕстьСоответствиеСтандартнойСпецификации = ?(
		ОбработкаВыбораВыполнена, 
		Объект.ЕстьСоответствиеСтандартнойСпецификации, 
		Ложь
	);
	
	СтатусГрафикаПроизводства = ?(
		ОбработкаВыбораВыполнена И НЕ ТребуетсяРассчитатьГрафик,
		СтатусГрафикаПроизводства,
		ПредопределенноеЗначение("Перечисление.СтатусыГрафикаПроизводстваВЗаказеНаПроизводство.ТребуетсяРассчитать"));
	
	ОбновитьСостояниеСпецификацииЗаказа(ЭтаФорма);
	
	Если ОбработкаВыбораВыполнена Тогда
		Возврат;
	КонецЕсли;
	
	ТекущиеДанные = ТекущийЭлемент.ТекущиеДанные;
	Если ТекущиеДанные = Неопределено Тогда 
		Возврат;
	КонецЕсли;
	
	ОчиститьСообщения();
	
	ВыполняемаяОперация = Неопределено;
	Если ТипЗнч(ВыбранноеЗначение) = Тип("Структура") Тогда
		ВыбранноеЗначение.Свойство("ВыполняемаяОперация", ВыполняемаяОперация)
	КонецЕсли;
	
	Если ВыполняемаяОперация = "ВыборЭтапаПроизводства" Тогда
		
		ЗаполнитьЗначенияСвойств(ТекущиеДанные, ВыбранноеЗначение.ЗначениеВыбора);
		ОбработатьИзменениеЭтапаНаСервере(ТекущийЭлемент.Имя);
		
	ИначеЕсли ВыполняемаяОперация = "РедактированиеЭтапаПроизводства" Тогда
		
		ИзменитьДанныеЭтапа(ВыбранноеЗначение.АдресВХранилище, ТекущиеДанные.ПолучитьИдентификатор(), КэшированныеЗначения);
		
		Если Объект.ЕстьСоответствиеСтандартнойСпецификации Тогда
			Объект.ЕстьСоответствиеСтандартнойСпецификации = Ложь;
			ОбновитьСостояниеСпецификацииЗаказа(ЭтаФорма);
		КонецЕсли;
		
	ИначеЕсли НоменклатураКлиент.ЭтоУказаниеСерий(ИсточникВыбора) Тогда
		
		НоменклатураКлиент.ОбработатьУказаниеСерии(ЭтаФорма, ПараметрыУказанияСерий, ВыбранноеЗначение);
		
	ИначеЕсли ВыполняемаяОперация = "ВыборЭтапаВыпускаПолуфабриката" Тогда
		
		ОбработатьВыборЭтапаПолуфабрикатаНаКлиенте(ТекущиеДанные, ВыбранноеЗначение);
		
	ИначеЕсли ИсточникВыбора.ИмяФормы = "Справочник.РесурсныеСпецификации.Форма.ФормаВыбораПоНоменклатуре" Тогда
		
		ОбработатьВыборСпецификацииПолуфабрикатаНаКлиенте(ТекущиеДанные, ВыбранноеЗначение);
		
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ОбработкаВыбораПодборНаКлиенте(ВыбранноеЗначение)
	
	Если Не ЗначениеЗаполнено(ВыбранноеЗначение) Тогда
		Возврат;
	КонецЕсли;
	
	ОбработкаВыбораПодборНаСервере(ВыбранноеЗначение);
	
КонецПроцедуры

&НаСервере
Процедура ОбработкаВыбораПодборНаСервере(ВыбранноеЗначение)
	
	ТаблицаТоваров = ПолучитьИзВременногоХранилища(ВыбранноеЗначение.АдресТоваровВХранилище);
	
	НачалоДня = НачалоДня(ТекущаяДатаСеанса());
	Если Не МногоэтапнаяСпецификация Тогда
		
		ТаблицаМатериалов = Новый ТаблицаЗначений;
		
		ТаблицаМатериалов.Колонки.Добавить(
			"Подразделение", 
			Новый ОписаниеТипов("СправочникСсылка.СтруктураПредприятия"));
		ТаблицаМатериалов.Колонки.Добавить(
			"ПроизводствоНаСтороне", 
			Новый ОписаниеТипов("Булево"));
		ТаблицаМатериалов.Колонки.Добавить(
			"Номенклатура", 
			Новый ОписаниеТипов("СправочникСсылка.Номенклатура"));
		ТаблицаМатериалов.Колонки.Добавить(
			"Характеристика", 
			Новый ОписаниеТипов("СправочникСсылка.ХарактеристикиНоменклатуры"));
		
	КонецЕсли;
	
	МассивНовыхСтрок = Новый Массив;
	Для каждого СтрокаТовара Из ТаблицаТоваров Цикл
		
		НоваяСтрока = Объект.МатериалыИУслуги.Добавить();
		МассивНовыхСтрок.Добавить(НоваяСтрока);
		
		НоваяСтрока.КодСтроки = 0;
		НоваяСтрока.КлючСвязи = Новый УникальныйИдентификатор;
		НоваяСтрока.КлючСвязиПродукция = Объект.КлючСвязи;
		
		ЗаполнитьЗначенияСвойств(
			НоваяСтрока,
			СтрокаТовара,
			"Номенклатура,
			|Характеристика,
			|Упаковка,
			|КоличествоУпаковок,
			|Количество,
			|Склад,
			|ВариантОбеспечения,
			|Обособленно,
			|Серия");
		
		НоваяСтрока.ДатаПотребности = ОбеспечениеВДокументахСервер.ДатаОтгрузкиОбработкаВыбораПодбор(
			СтрокаТовара.ДатаОтгрузки,
			НоваяСтрока.ВариантОбеспечения,
			НачалоДня);
		
		ЗаполнитьКоличествоМатериалаНаЕдиницуИзделия(НоваяСтрока, Объект.КоличествоУпаковок);
		
		Если Не МногоэтапнаяСпецификация Тогда
			
			
			ЗаполнитьДанныеЭтапаВСтрокеДляОдноэтапнойСпецификацииНаСервере(НоваяСтрока, "МатериалыИУслуги");
			
			ЗаполнитьЗначенияСвойств(ТаблицаМатериалов.Добавить(), НоваяСтрока);
			
		КонецЕсли;
		
	КонецЦикла;
	
	Если Не МногоэтапнаяСпецификация Тогда
		
		МенеджерВременныхТаблиц = Документы.ЗаказНаПроизводство.СоздатьВтСпособыПолученияМатериалов(Объект);
		
		ДанныеЗаказа = Новый Структура("ПодразделениеДиспетчер, Назначение, НачатьНеРанее");
		ЗаполнитьЗначенияСвойств(ДанныеЗаказа, Объект);
		
		СпособыПолученияМатериаловПоУмолчанию = ОбеспечениеПроизводства.СпособыПолученияМатериаловПоУмолчанию(
			ДанныеЗаказа, 
			ТаблицаМатериалов, 
			МенеджерВременныхТаблиц);
		
		ПараметрыОтбора = Новый Структура("
			|Подразделение, 
			|ПроизводствоНаСтороне, 
			|Номенклатура, 
			|Характеристика");
		
		Для Каждого НоваяСтрока Из МассивНовыхСтрок Цикл
			ЗаполнитьЗначенияСвойств(ПараметрыОтбора, НоваяСтрока);
			Для Каждого СпособПолученияМатериала Из СпособыПолученияМатериаловПоУмолчанию.НайтиСтроки(ПараметрыОтбора) Цикл
				ЗаполнитьЗначенияСвойств(НоваяСтрока, СпособПолученияМатериала, , "ВариантОбеспечения,Обособленно,Склад");
				Если Не ЗначениеЗаполнено(НоваяСтрока.ВариантОбеспечения) Тогда
					НоваяСтрока.ВариантОбеспечения = СпособПолученияМатериала.ВариантОбеспечения;
					НоваяСтрока.Обособленно = СпособПолученияМатериала.Обособленно;
				КонецЕсли;
				Если Не ЗначениеЗаполнено(НоваяСтрока.Склад) Тогда
					НоваяСтрока.Склад = СпособПолученияМатериала.Склад;
				КонецЕсли;
				Прервать;
			КонецЦикла;
		КонецЦикла;
		
	КонецЕсли;
	
	СтруктураДействий = Новый Структура();
	Для Каждого НоваяСтрока Из МассивНовыхСтрок Цикл
		
		Если Не ЗначениеЗаполнено(НоваяСтрока.ВариантОбеспечения) Тогда
			ДобавитьДействияОбеспеченияНаСервере(СтруктураДействий, "ВариантОбеспечения", НоваяСтрока);
		КонецЕсли;
		ОбработкаТабличнойЧастиСервер.ОбработатьСтрокуТЧ(НоваяСтрока, СтруктураДействий, Неопределено);
		ЗаполнитьНазначениеВСтрокеТЧМатериалыИУслугиНаСервере(НоваяСтрока, Истина);
		
	КонецЦикла;
	
	СтруктураДействий = Новый Структура;
	СтруктураДействий.Вставить("ЗаполнитьПризнакХарактеристикиИспользуются",
								Новый Структура("Номенклатура", "ХарактеристикиИспользуются"));
	СтруктураДействий.Вставить("ЗаполнитьПризнакТипНоменклатуры",
								Новый Структура("Номенклатура", "ТипНоменклатуры"));
	СтруктураДействий.Вставить("ЗаполнитьПризнакАртикул",
								Новый Структура("Номенклатура", "Артикул"));
	
	НоменклатураСервер.ЗаполнитьСлужебныеРеквизитыПоНоменклатуреВКоллекции(Объект.МатериалыИУслуги, СтруктураДействий);
	НоменклатураСервер.ЗаполнитьСтатусыУказанияСерий(Объект, ПараметрыУказанияСерий);
	
	//++ НЕ УТКА
	Если ПравоЧтенияАналогов И ПоказатьАналоги Тогда
		ОтметитьНаличиеАналогов();
	КонецЕсли;
	//-- НЕ УТКА
	ОбновитьКолонкуДоступноСервер();
	
КонецПроцедуры

&НаКлиенте
Процедура ПередЗакрытием(Отказ, ЗавершениеРаботы, ТекстПредупреждения, СтандартнаяОбработка)
	
	ОповещениеСохранитьИЗакрыть = Новый ОписаниеОповещения(
		"ПередЗакрытиемСохранитьИЗакрыть", ЭтотОбъект);
	
	ОбщегоНазначенияКлиент.ПоказатьПодтверждениеЗакрытияФормы(
		ОповещениеСохранитьИЗакрыть, Отказ, ЗавершениеРаботы);
		
КонецПроцедуры

&НаКлиенте
Процедура ПередЗакрытиемСохранитьИЗакрыть(Ответ, ДополнительныеПараметры) Экспорт
	
	ЗавершитьРедактирование();
	
КонецПроцедуры

&НаСервере
Процедура ПриЗагрузкеДанныхИзНастроекНаСервере(Настройки)
	
	СписокДействий = "";
	
	//++ НЕ УТКА
	Если ПравоЧтенияАналогов И ПоказатьАналоги Тогда
		СписокДействий = СписокДействий + ?(ЗначениеЗаполнено(СписокДействий), ",", "") + "ПоказатьАналоги";
		ОтметитьНаличиеАналогов();
	КонецЕсли;
	//-- НЕ УТКА
	
	Если ЗначениеЗаполнено(СписокДействий) Тогда
		УправлениеФормой(СписокДействий);
	КонецЕсли;	
	
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиСобытийЭлементовШапкиФормы

&НаКлиенте
Процедура СпецификацияПриИзменении(Элемент)
	
	ЗаполнитьПоСпецификацииКлиент();
	
КонецПроцедуры

&НаКлиенте
Процедура КоличествоУпаковокПриИзменении(Элемент)
	
	СтруктураДействий = Новый Структура;
	СтруктураДействий.Вставить("ПересчитатьКоличествоЕдиниц");
	
	ОбработкаТабличнойЧастиКлиент.ОбработатьСтрокуТЧ(Объект, СтруктураДействий, КэшированныеЗначения);
	
	ЗаполнитьПоСпецификацииКлиент();
	
	СтатусГрафикаПроизводства = ПредопределенноеЗначение("Перечисление.СтатусыГрафикаПроизводстваВЗаказеНаПроизводство.ТребуетсяРассчитать");
	
КонецПроцедуры

&НаКлиенте
Процедура УпаковкаПриИзменении(Элемент)
	
	СтруктураДействий = Новый Структура;
	
	СтруктураДействий.Вставить("ПересчитатьКоличествоЕдиниц");
	
	Объект.Упаковка = Упаковка;
	
	ОбработкаТабличнойЧастиКлиент.ОбработатьСтрокуТЧ(Объект, СтруктураДействий, КэшированныеЗначения);
	
	ЗаполнитьПоСпецификацииКлиент();
	
	УстановитьЗаголовокКолонкиКоличествоНаЕдиницуПродукции();
		
	СтатусГрафикаПроизводства = ПредопределенноеЗначение("Перечисление.СтатусыГрафикаПроизводстваВЗаказеНаПроизводство.ТребуетсяРассчитать");
	
КонецПроцедуры

&НаКлиенте
Процедура ЕдиницаИзмеренияПриИзменении(Элемент)
	
	УстановитьЗаголовокКолонкиКоличествоНаЕдиницуПродукции();
	
КонецПроцедуры

&НаКлиенте
Процедура СкладПриИзменении(Элемент)
	
	СкладПриИзмененииНаСервере();
	
КонецПроцедуры

&НаКлиенте
Процедура ПодразделениеПриИзменении(Элемент)
	
	СтруктураОтбора = Новый Структура("НаправлениеВыпуска, Подразделение",
		ПредопределенноеЗначение("Перечисление.ХозяйственныеОперации.ВыпускПродукцииВПодразделение"), СохраненноеЗначениеПодразделение);
	
	СтрокиВыходныеИзделия = Объект.ВыходныеИзделия.НайтиСтроки(СтруктураОтбора);
	СтрокиОходы           = Объект.ВозвратныеОтходы.НайтиСтроки(СтруктураОтбора);
	
	СохраненноеЗначениеПодразделение = Объект.Подразделение;
	
	Если СтрокиВыходныеИзделия.Количество() = 0 И СтрокиОходы.Количество() = 0 Тогда
		Возврат;
	КонецЕсли;
	
	Для каждого Строка Из СтрокиВыходныеИзделия Цикл
		Строка.Подразделение = Объект.Подразделение;
		Строка.Получатель = Объект.Подразделение;
	КонецЦикла;
	
	Для каждого Строка Из СтрокиОходы Цикл
		Строка.Подразделение = Объект.Подразделение;
		Строка.Получатель = Объект.Подразделение;
	КонецЦикла;
	
	СтатусГрафикаПроизводства = ПредопределенноеЗначение("Перечисление.СтатусыГрафикаПроизводстваВЗаказеНаПроизводство.ТребуетсяРассчитать");
	ПодразделениеПриИзмененииНаСервере();
	
КонецПроцедуры

&НаКлиенте
Процедура НоменклатураПриИзменении(Элемент)
	
	ДанныеПродукцииСохраненныеЗначения = ОбщегоНазначенияКлиентСервер.СкопироватьСтруктуру(ДанныеПродукции);
	
	ЗаполнитьДанныеПродукцииНаКлиенте();
	
	ЗаполнитьНазначениеВТЧВыходныеИзделияНаКлиенте(ДанныеПродукцииСохраненныеЗначения);
	
КонецПроцедуры

&НаКлиенте
Процедура ХарактеристикаПриИзменении(Элемент)
	
	ДанныеПродукцииСохраненныеЗначения = ОбщегоНазначенияКлиентСервер.СкопироватьСтруктуру(ДанныеПродукции);
	
	ЗаполнитьДанныеПродукцииНаКлиенте();
	
	ЗаполнитьНазначениеВТЧВыходныеИзделияНаКлиенте(ДанныеПродукцииСохраненныеЗначения);
	
КонецПроцедуры

&НаКлиенте
Процедура НазначениеПриИзменении(Элемент)
	
	НазначениеПриИзмененииНаСервере();
	
КонецПроцедуры

&НаКлиенте
Процедура НачатьНеРанееПриИзменении(Элемент)
	СтатусГрафикаПроизводства = ПредопределенноеЗначение("Перечисление.СтатусыГрафикаПроизводстваВЗаказеНаПроизводство.ТребуетсяРассчитать");
КонецПроцедуры

&НаКлиенте
Процедура ДатаПотребностиПриИзменении(Элемент)
	
	//++ НЕ УТКА
	Если ПравоЧтенияАналогов И ПоказатьАналоги Тогда
		ОтметитьНаличиеАналогов();
	КонецЕсли;
	//-- НЕ УТКА
	
	СтатусГрафикаПроизводства = ПредопределенноеЗначение("Перечисление.СтатусыГрафикаПроизводстваВЗаказеНаПроизводство.ТребуетсяРассчитать");
	
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиСобытийЭлементовТаблицыФормыВыходныеИзделия

&НаКлиенте
Процедура ВыходныеИзделияПередНачаломДобавления(Элемент, Отказ, Копирование, Родитель, Группа)
	
	ТекущиеДанные = Элемент.ТекущиеДанные;
	
	Если Копирование И ТекущиеДанные.ЭтапВыполнен Тогда
		Отказ = Истина;
		ПоказатьПредупреждение(Неопределено, НСтр("ru = 'Редактирование выполненного этапа недоступно.';
													|en = 'Cannot edit the completed stage.'"));
	ИначеЕсли Копирование И ТекущиеДанные.Номенклатура = Объект.Номенклатура И ТекущиеДанные.Характеристика = Объект.Характеристика Тогда
		Отказ = Истина;
		ПоказатьПредупреждение(Неопределено, НСтр("ru = 'Копирование основного выходного изделия недоступно.';
													|en = 'Copying of the main finished product is unavailable.'"));
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ВыходныеИзделияПриНачалеРедактирования(Элемент, НоваяСтрока, Копирование)
	
	ТекущиеДанные = Элемент.ТекущиеДанные;
	
	Если НоваяСтрока Тогда
		
		ТекущиеДанные.КлючСвязи = Новый УникальныйИдентификатор;
		ТекущиеДанные.КлючСвязиПродукция = Объект.КлючСвязи;
		
		ТекущиеДанные.НаправлениеВыпуска = ПредопределенноеЗначение("Перечисление.ХозяйственныеОперации.ВыпускПродукцииНаСклад");
		ТекущиеДанные.Склад              = Объект.Склад;
		ТекущиеДанные.Подразделение      = ПредопределенноеЗначение("Справочник.СтруктураПредприятия.ПустаяСсылка");
		ТекущиеДанные.Получатель         = Объект.Склад;
		
		ТекущиеДанные.ПроизводитсяВПроцессе = Ложь;
		
		ЗаполнитьДанныеЭтапаВСтрокеДляОдноэтапнойСпецификации(ТекущиеДанные);
		
		ВсегоИзделий = Объект.ВыходныеИзделия.Количество() + Объект.ВозвратныеОтходы.Количество();
		
	КонецЕсли;
	
	СохранитьДанныеСтроки("ВыходныеИзделия", ТекущиеДанные);
	
КонецПроцедуры

&НаКлиенте
Процедура ВыходныеИзделияНоменклатураПриИзменении(Элемент)
	
	ТекущиеДанные = Элементы.ВыходныеИзделия.ТекущиеДанные;
	
	ПараметрыПересчетаКоличестваЕдиниц = ПланированиеПроизводстваКлиентСервер.ПараметрыПересчетаКоличестваЕдиниц(ТекущиеДанные, "ВыходныеИзделия");
	
	СтруктураДействий = Новый Структура;
	СтруктураДействий.Вставить("ПересчитатьКоличествоЕдиниц", ПараметрыПересчетаКоличестваЕдиниц);
	СтруктураДействий.Вставить("ПроверитьХарактеристикуПоВладельцу", ТекущиеДанные.Характеристика);
	СтруктураДействий.Вставить("ПроверитьЗаполнитьУпаковкуПоВладельцу", ТекущиеДанные.Упаковка);
	СтруктураДействий.Вставить("ЗаполнитьПризнакТипНоменклатуры", Новый Структура("Номенклатура", "ТипНоменклатуры"));
	
	ОбработкаТабличнойЧастиКлиент.ОбработатьСтрокуТЧ(ТекущиеДанные, СтруктураДействий, КэшированныеЗначения);
	
	Если ТекущиеДанные.ТипНоменклатуры = ПредопределенноеЗначение("Перечисление.ТипыНоменклатуры.Работа") Тогда
		
		ТекущиеДанные.НаправлениеВыпуска = ПредопределенноеЗначение("Перечисление.ХозяйственныеОперации.ВыпускПродукцииВПодразделение");
		ТекущиеДанные.Склад = ПредопределенноеЗначение("Справочник.Склады.ПустаяСсылка");
		
		Если ЗначениеЗаполнено(Объект.Подразделение) Тогда
			ТекущиеДанные.Подразделение = Объект.Подразделение;
		Иначе
			ТекущиеДанные.Подразделение = ОбщегоНазначенияУТВызовСервера.ЗначениеРеквизитаОбъекта(ТекущиеДанные.Этап, "Подразделение");
		КонецЕсли;
		
		ТекущиеДанные.Получатель = ТекущиеДанные.Подразделение;
	Иначе
		ТекущиеДанные.НаправлениеВыпуска = ПредопределенноеЗначение("Перечисление.ХозяйственныеОперации.ВыпускПродукцииНаСклад");
		ТекущиеДанные.Подразделение = ПредопределенноеЗначение("Справочник.СтруктураПредприятия.ПустаяСсылка");
		ТекущиеДанные.Склад = Объект.Склад;
		ТекущиеДанные.Получатель = Объект.Склад;
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ВыходныеИзделияУпаковкаПриИзменении(Элемент)
	
	ТекущиеДанные = Элементы.ВыходныеИзделия.ТекущиеДанные;
	
	СтруктураДействий = Новый Структура;
	
	ПараметрыПересчетаКоличестваЕдиниц = ПланированиеПроизводстваКлиентСервер.ПараметрыПересчетаКоличестваЕдиниц(ТекущиеДанные, "ВыходныеИзделия");
	СтруктураДействий.Вставить("ПересчитатьКоличествоЕдиниц", ПараметрыПересчетаКоличестваЕдиниц);
	
	ОбработкаТабличнойЧастиКлиент.ОбработатьСтрокуТЧ(ТекущиеДанные, СтруктураДействий, КэшированныеЗначения);
	
КонецПроцедуры

&НаКлиенте
Процедура ВыходныеИзделияКоличествоУпаковокПриИзменении(Элемент)
	
	ТекущиеДанные = Элементы.ВыходныеИзделия.ТекущиеДанные;
	
	СтруктураДействий = Новый Структура;
	
	ПараметрыПересчетаКоличестваЕдиниц = ПланированиеПроизводстваКлиентСервер.ПараметрыПересчетаКоличестваЕдиниц(ТекущиеДанные, "ВыходныеИзделия");
	СтруктураДействий.Вставить("ПересчитатьКоличествоЕдиниц", ПараметрыПересчетаКоличестваЕдиниц);
	
	ОбработкаТабличнойЧастиКлиент.ОбработатьСтрокуТЧ(ТекущиеДанные, СтруктураДействий, КэшированныеЗначения);
	
КонецПроцедуры

&НаКлиенте
Процедура ВыходныеИзделияЭтапНачалоВыбора(Элемент, ДанныеВыбора, СтандартнаяОбработка)
	
	ВыборЭтапаПроизводства(СтандартнаяОбработка);
	
КонецПроцедуры

&НаКлиенте
Процедура ВыходныеИзделияПередУдалением(Элемент, Отказ)
	
	ТекущиеДанные = Элементы.ВыходныеИзделия.ТекущиеДанные;
	
	Если ТекущиеДанные.ЭтапВыполнен Тогда
		Отказ = Истина;
		ПоказатьПредупреждение(Неопределено, НСтр("ru = 'Удаление данных выполненного этапа недоступно.';
													|en = 'Cannot remove data of the completed stage.'"));
		Возврат;
	КонецЕсли;
	
	Если ТекущиеДанные.Номенклатура = Объект.Номенклатура И ТекущиеДанные.Характеристика = Объект.Характеристика Тогда
		Отказ = Истина;
		ПоказатьПредупреждение(Неопределено, НСтр("ru = 'Нельзя удалить производимое изделие.';
													|en = 'Cannot remove the manufactured product.'"));
	КонецЕсли;
	
	Если ТекущиеДанные.ПроизводитсяВПроцессе Тогда
		Отказ = Истина;
		ПоказатьПредупреждение(Неопределено, НСтр("ru = 'Нельзя удалить производимый в процессе полуфабрикат.';
													|en = 'Cannot remove a semi-finished product manufactured in the process.'"));
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ВыходныеИзделияПриОкончанииРедактирования(Элемент, НоваяСтрока, ОтменаРедактирования)
	
	ТекущиеДанные = Элементы.ВыходныеИзделия.ТекущиеДанные;
	Если ТекущиеДанные = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	ИзменилисьОбязательныеРеквизиты = ИзменениеОбязательныхРеквизитовСтроки(Объект, ТекущиеДанные, СохраненныеЗначения);
	
	ОбработатьОкончаниеРедактированияВыходныхИзделий(
		ТекущиеДанные.ПолучитьИдентификатор(), НоваяСтрока, ИзменилисьОбязательныеРеквизиты);
	
КонецПроцедуры

&НаКлиенте
Процедура ВыходныеИзделияПослеУдаления(Элемент)
	
	ОбработатьУдалениеВыходныхИзделий();
	
КонецПроцедуры

&НаКлиенте
Процедура ВыходныеИзделияНаправлениеВыпускаПриИзменении(Элемент)
	
	ТекущиеДанные = Элементы.ВыходныеИзделия.ТекущиеДанные;
	
	Если ТекущиеДанные.НаправлениеВыпуска = ПредопределенноеЗначение("Перечисление.ХозяйственныеОперации.ВыпускПродукцииНаСклад") Тогда
		
		ТекущиеДанные.Склад = Объект.Склад;
		ТекущиеДанные.Подразделение = ПредопределенноеЗначение("Справочник.СтруктураПредприятия.ПустаяСсылка");
		ТекущиеДанные.Получатель = Объект.Склад;
		
	ИначеЕсли НЕ ТекущиеДанные.ПроизводитсяВПроцессе Тогда
		
		ТекущиеДанные.Склад = ПредопределенноеЗначение("Справочник.Склады.ПустаяСсылка");
		ТекущиеДанные.Подразделение = ОбщегоНазначенияУТВызовСервера.ЗначениеРеквизитаОбъекта(ТекущиеДанные.Этап, "Подразделение");
		ТекущиеДанные.Получатель = ТекущиеДанные.Подразделение;
		
	КонецЕсли;
	
	ЗаполнитьСкладМатериалаНаОснованииСтрокиИзделия(ТекущиеДанные, ТекущиеДанные.КлючСвязиПолуфабрикат);
	
КонецПроцедуры

&НаКлиенте
Процедура ВыходныеИзделияПолучательПриИзменении(Элемент)
	
	ТекущиеДанные = Элементы.ВыходныеИзделия.ТекущиеДанные;
	
	Если ТекущиеДанные.НаправлениеВыпуска = ПредопределенноеЗначение("Перечисление.ХозяйственныеОперации.ВыпускПродукцииНаСклад") Тогда
		ТекущиеДанные.Склад = ТекущиеДанные.Получатель;
		ТекущиеДанные.Подразделение = ПредопределенноеЗначение("Справочник.СтруктураПредприятия.ПустаяСсылка");
	Иначе
		ТекущиеДанные.Склад = ПредопределенноеЗначение("Справочник.Склады.ПустаяСсылка");
		ТекущиеДанные.Подразделение = ТекущиеДанные.Получатель;
	КонецЕсли;
	
	ЗаполнитьСкладМатериалаНаОснованииСтрокиИзделия(ТекущиеДанные, ТекущиеДанные.КлючСвязиПолуфабрикат);
	
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиСобытийЭлементовТаблицыФормыВозвратныеОтходы

&НаКлиенте
Процедура ВозвратныеОтходыПередНачаломДобавления(Элемент, Отказ, Копирование, Родитель, Группа)
	
	ТекущиеДанные = Элемент.ТекущиеДанные;
	
	Если Копирование И ТекущиеДанные.ЭтапВыполнен Тогда
		Отказ = Истина;
		ПоказатьПредупреждение(Неопределено, НСтр("ru = 'Редактирование данных выполненного этапа недоступно.';
													|en = 'Cannot edit the completed stage data.'"));
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ВозвратныеОтходыПередУдалением(Элемент, Отказ)
	
	МассивСтрок = Новый Массив;

	КоличествоВсего = 0;
	КоличествоВыполненныхСтрок = 0;
	КоличествоПолуфабрикатовВПроцессе = 0;
	
	Для каждого ЭлементКоллекции Из Элементы.ВозвратныеОтходы.ВыделенныеСтроки Цикл
		
		ДанныеСтроки = Элементы.ВозвратныеОтходы.ДанныеСтроки(ЭлементКоллекции);
		
		Если ДанныеСтроки.ЭтапВыполнен Тогда
			
			КоличествоВыполненныхСтрок = КоличествоВыполненныхСтрок + 1;
			
		КонецЕсли;
		
		Если ДанныеСтроки.ПроизводитсяВПроцессе Тогда
			
			КоличествоПолуфабрикатовВПроцессе = КоличествоПолуфабрикатовВПроцессе + 1;
			
		КонецЕсли;
			
		Если НЕ (ДанныеСтроки.ЭтапВыполнен ИЛИ ДанныеСтроки.ПроизводитсяВПроцессе) Тогда
			
			МассивСтрок.Добавить(ДанныеСтроки);
			
		КонецЕсли;
		
		КоличествоВсего = КоличествоВсего + 1;
		
	КонецЦикла;
	
	Если КоличествоВыполненныхСтрок > 0 ИЛИ КоличествоПолуфабрикатовВПроцессе > 0 Тогда
		
		Отказ = Истина;
		
		Если МассивСтрок.Количество() > 0 Тогда
			
			ПараметрыОповещения = Новый Структура("МассивСтрок", МассивСтрок);
				
			Если КоличествоВыполненныхСтрок > 0 И КоличествоПолуфабрикатовВПроцессе > 0 Тогда
				
				ТекстВопроса = НСтр("ru = 'Удаление строк выполненных этапов, а также полуфабрикатов, производимых в процессе, невозможно. Удалить остальные строки?';
									|en = 'Cannot remove lines of the completed stages and semi-finished products manufactured in the process. Remove the remaining lines?'");
				
			ИначеЕсли КоличествоВыполненныхСтрок > 0 Тогда
				
				ТекстВопроса = НСтр("ru = 'Удаление строк выполненных этапов невозможно. Удалить остальные строки?';
									|en = 'Cannot remove lines of the completed stages. Remove the remaining lines?'");
				
			Иначе
				
				ТекстВопроса = НСтр("ru = 'Удаление строк полуфабрикатов, производимых в процессе, невозможно. Удалить остальные строки?';
									|en = 'Cannot remove lines of the semi-finished products manufactured in the process. Remove the remaining lines?'");
				
			КонецЕсли;
			
			ОписаниеОповещения = Новый ОписаниеОповещения(
				"ВозвратныеОтходыПередУдалениемЗавершение", 
				ЭтотОбъект, 
				ПараметрыОповещения);
			
			ПоказатьВопрос(ОписаниеОповещения, ТекстВопроса, РежимДиалогаВопрос.ДаНет);
			
		ИначеЕсли КоличествоВыполненныхСтрок = КоличествоВсего Тогда
			
			ПоказатьПредупреждение(Неопределено, НСтр("ru = 'Удаление данных выполненного этапа недоступно.';
														|en = 'Cannot remove data of the completed stage.'"));
			
		Иначе
			
			ПоказатьПредупреждение(Неопределено, НСтр("ru = 'Удаление полуфабрикатов, потребляемых на следующих этапах, невозможно.';
														|en = 'Cannot remove semi-finished products consumed at the following stages.'"));
			
		КонецЕсли;
		
		Возврат;
		
	КонецЕсли;

КонецПроцедуры

&НаКлиенте
Процедура ВозвратныеОтходыПередУдалениемЗавершение(РезультатВопроса, ДополнительныеПараметры) Экспорт
	
	Если РезультатВопроса = КодВозвратаДиалога.Нет Тогда
		
		Возврат;
		
	КонецЕсли;
	
	Для каждого Строка Из ДополнительныеПараметры.МассивСтрок Цикл
		
		Объект.ВозвратныеОтходы.Удалить(Строка);
		
	КонецЦикла;
	
	ВозвратныеОтходыПослеУдаленияНаСервере();
	
КонецПроцедуры

&НаКлиенте
Процедура ВозвратныеОтходыПриНачалеРедактирования(Элемент, НоваяСтрока, Копирование)
	
	ТекущиеДанные = Элемент.ТекущиеДанные;
	
	Если НоваяСтрока Тогда
		
		ТекущиеДанные.КлючСвязи          = Новый УникальныйИдентификатор;
		ТекущиеДанные.КлючСвязиПродукция = Объект.КлючСвязи;
		
		ТекущиеДанные.НаправлениеВыпуска = ПредопределенноеЗначение("Перечисление.ХозяйственныеОперации.ВыпускПродукцииНаСклад");
		ТекущиеДанные.Склад              = Объект.Склад;
		ТекущиеДанные.Подразделение      = ПредопределенноеЗначение("Справочник.СтруктураПредприятия.ПустаяСсылка");
		ТекущиеДанные.Получатель         = Объект.Склад;
		
		Если ТекущиеДанные.ПроизводитсяВПроцессе Тогда
			
			ТекущиеДанные.ПроизводитсяВПроцессе = Ложь;
			ТекущиеДанные.КлючСвязиМатериалыИУслуги = ПолучитьПустойУникальныйИдентификатор();
			ТекущиеДанные.СтатьяКалькуляции = ПредопределенноеЗначение("Справочник.СтатьиКалькуляции.ПустаяСсылка");
			
		КонецЕсли;
		
		ЗаполнитьДанныеЭтапаВСтрокеДляОдноэтапнойСпецификации(ТекущиеДанные);
		
		ВсегоИзделий = Объект.ВыходныеИзделия.Количество() + Объект.ВозвратныеОтходы.Количество();
		
	КонецЕсли;
	
	СохранитьДанныеСтроки("ВозвратныеОтходы", ТекущиеДанные);
	
КонецПроцедуры

&НаКлиенте
Процедура ВозвратныеОтходыПриОкончанииРедактирования(Элемент, НоваяСтрока, ОтменаРедактирования)
	
	ТекущиеДанные = Элементы.ВозвратныеОтходы.ТекущиеДанные;
	
	Если ТекущиеДанные = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	ЗаполнитьНазначениеВСтрокеТЧВыходныеИзделияНаКлиенте(
		ТекущиеДанные, НоваяСтрока, ПредопределенноеЗначение("Перечисление.ТипыСтоимостиВыходныхИзделий.Фиксированная"));
	
	Если НоваяСтрока И Объект.ЕстьСоответствиеСтандартнойСпецификации
		ИЛИ ИзменениеОбязательныхРеквизитовСтроки(Объект, ТекущиеДанные, СохраненныеЗначения) Тогда
		Объект.ЕстьСоответствиеСтандартнойСпецификации = Ложь;
		ОбновитьСостояниеСпецификацииЗаказа(ЭтаФорма);
		НастроитьОтображениеПредупрежденийПриРедактировании();
	КонецЕсли;
	
	СтатусГрафикаПроизводства = ПредопределенноеЗначение("Перечисление.СтатусыГрафикаПроизводстваВЗаказеНаПроизводство.ТребуетсяРассчитать");
	
КонецПроцедуры

&НаКлиенте
Процедура ВозвратныеОтходыНоменклатураПриИзменении(Элемент)
	
	ТекущиеДанные = Элементы.ВозвратныеОтходы.ТекущиеДанные;
	
	СтруктураДействий = Новый Структура;
	СтруктураДействий.Вставить("ПроверитьХарактеристикуПоВладельцу", ТекущиеДанные.Характеристика);
	СтруктураДействий.Вставить("ПроверитьЗаполнитьУпаковкуПоВладельцу", ТекущиеДанные.Упаковка);
	СтруктураДействий.Вставить("ЗаполнитьПризнакТипНоменклатуры", Новый Структура("Номенклатура", "ТипНоменклатуры"));
	
	ПараметрыПересчетаКоличестваЕдиниц = ПланированиеПроизводстваКлиентСервер.ПараметрыПересчетаКоличестваЕдиниц(ТекущиеДанные, "ВозвратныеОтходы");
	СтруктураДействий.Вставить("ПересчитатьКоличествоЕдиниц", ПараметрыПересчетаКоличестваЕдиниц);
	
	ОбработкаТабличнойЧастиКлиент.ОбработатьСтрокуТЧ(ТекущиеДанные, СтруктураДействий, КэшированныеЗначения);
	
	Если ТекущиеДанные.ТипНоменклатуры = ПредопределенноеЗначение("Перечисление.ТипыНоменклатуры.Работа") Тогда
		ТекущиеДанные.НаправлениеВыпуска = ПредопределенноеЗначение("Перечисление.ХозяйственныеОперации.ВыпускПродукцииВПодразделение");
		
		Если ЗначениеЗаполнено(Объект.Подразделение) Тогда
			ТекущиеДанные.Подразделение = Объект.Подразделение;
		Иначе
			ТекущиеДанные.Подразделение = ОбщегоНазначенияУТВызовСервера.ЗначениеРеквизитаОбъекта(ТекущиеДанные.Этап, "Подразделение");
		КонецЕсли;
		
		ТекущиеДанные.Получатель = ТекущиеДанные.Подразделение;
		ТекущиеДанные.Склад = ПредопределенноеЗначение("Справочник.Склады.ПустаяСсылка");
	Иначе
		ТекущиеДанные.НаправлениеВыпуска = ПредопределенноеЗначение("Перечисление.ХозяйственныеОперации.ВыпускПродукцииНаСклад");
		ТекущиеДанные.Подразделение = ПредопределенноеЗначение("Справочник.СтруктураПредприятия.ПустаяСсылка");
		ТекущиеДанные.Склад = Объект.Склад;
		ТекущиеДанные.Получатель = Объект.Склад;
	КонецЕсли;
	
	ВозвратныеОтходыПриИзмененииНоменклатурыХарактеристикиНаСервере();
	
КонецПроцедуры

&НаКлиенте
Процедура ВозвратныеОтходыХарактеристикаПриИзменении(Элемент)
	
	ВозвратныеОтходыПриИзмененииНоменклатурыХарактеристикиНаСервере();
	
КонецПроцедуры

&НаКлиенте
Процедура ВозвратныеОтходыКоличествоУпаковокПриИзменении(Элемент)
	
	ВозвратныеОтходыОбработкаСобытияКоличествоПриИзменении(Элементы.ВозвратныеОтходы.ТекущиеДанные);
	
КонецПроцедуры

&НаКлиенте
Процедура ВозвратныеОтходыУпаковкаПриИзменении(Элемент)
	
	ВозвратныеОтходыОбработкаСобытияКоличествоПриИзменении(Элементы.ВозвратныеОтходы.ТекущиеДанные);
	
КонецПроцедуры

&НаКлиенте
Процедура ВозвратныеОтходыОбработкаСобытияКоличествоПриИзменении(ТекущиеДанные, ИмяРеквизита = "КоличествоУпаковок")
	
	СтруктураДействий = Новый Структура;
	
	ПараметрыПересчетаКоличестваЕдиниц = ПланированиеПроизводстваКлиентСервер.ПараметрыПересчетаКоличестваЕдиниц(ТекущиеДанные, "ВозвратныеОтходы");
	СтруктураДействий.Вставить("ПересчитатьКоличествоЕдиниц", ПараметрыПересчетаКоличестваЕдиниц);
	
	ОбработкаТабличнойЧастиКлиент.ОбработатьСтрокуТЧ(ТекущиеДанные, СтруктураДействий, КэшированныеЗначения);
	
КонецПроцедуры

&НаКлиенте
Процедура ВозвратныеОтходыПослеУдаления(Элемент)
	
	ВозвратныеОтходыПослеУдаленияНаСервере();
	
КонецПроцедуры

&НаКлиенте
Процедура ВозвратныеОтходыЭтапНачалоВыбора(Элемент, ДанныеВыбора, СтандартнаяОбработка)
	ВыборЭтапаПроизводства(СтандартнаяОбработка);
КонецПроцедуры

&НаКлиенте
Процедура ВозвратныеОтходыНаправлениеВыпускаПриИзменении(Элемент)
	
	ТекущиеДанные = Элементы.ВозвратныеОтходы.ТекущиеДанные;
	
	Если ТекущиеДанные.НаправлениеВыпуска = ПредопределенноеЗначение("Перечисление.ХозяйственныеОперации.ВыпускПродукцииНаСклад") Тогда
		
		ТекущиеДанные.Склад = Объект.Склад;
		ТекущиеДанные.Подразделение = ПредопределенноеЗначение("Справочник.СтруктураПредприятия.ПустаяСсылка");
		ТекущиеДанные.Получатель = Объект.Склад;
		
	ИначеЕсли НЕ ТекущиеДанные.ПроизводитсяВПроцессе Тогда
		
		ТекущиеДанные.Склад = ПредопределенноеЗначение("Справочник.Склады.ПустаяСсылка");
		ТекущиеДанные.Подразделение = ОбщегоНазначенияУТВызовСервера.ЗначениеРеквизитаОбъекта(ТекущиеДанные.Этап, "Подразделение");
		ТекущиеДанные.Получатель = ТекущиеДанные.Подразделение;
		
	КонецЕсли;
	
	ЗаполнитьСкладМатериалаНаОснованииСтрокиИзделия(ТекущиеДанные, ТекущиеДанные.КлючСвязиМатериалыИУслуги);

КонецПроцедуры

&НаКлиенте
Процедура ВозвратныеОтходыПолучательПриИзменении(Элемент)
	
	ТекущиеДанные = Элементы.ВозвратныеОтходы.ТекущиеДанные;
	
	Если ТекущиеДанные.НаправлениеВыпуска = ПредопределенноеЗначение("Перечисление.ХозяйственныеОперации.ВыпускПродукцииНаСклад") Тогда
		ТекущиеДанные.Склад = ТекущиеДанные.Получатель;
		ТекущиеДанные.Подразделение = ПредопределенноеЗначение("Справочник.СтруктураПредприятия.ПустаяСсылка");
	Иначе
		ТекущиеДанные.Склад = ПредопределенноеЗначение("Справочник.Склады.ПустаяСсылка");
		ТекущиеДанные.Подразделение = ТекущиеДанные.Получатель;
	КонецЕсли;
	
	ЗаполнитьСкладМатериалаНаОснованииСтрокиИзделия(ТекущиеДанные, ТекущиеДанные.КлючСвязиМатериалыИУслуги);
	
КонецПроцедуры

&НаСервере
Процедура ВозвратныеОтходыПриИзмененииНоменклатурыХарактеристикиНаСервере()
	
	ПроверитьНаличиеУточненийНоменклатурыТабличнойЧасти("ВозвратныеОтходы", "ЕстьУточненияПобочныхИзделий");
	
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиСобытийЭлементовТаблицыФормыМатериалыИУслуги

&НаКлиенте
Процедура МатериалыИУслугиВыбор(Элемент, ВыбраннаяСтрока, Поле, СтандартнаяОбработка)
	
	// &ЗамерПроизводительности
	ОценкаПроизводительностиКлиент.НачатьЗамерВремени(Истина,
		"Обработка.РедактированиеСпецификацииСтрокиЗаказа.Форма.Форма.Элементы..МатериалыИУслуги.Выбор");
	
	ТекущиеДанные = Элементы.МатериалыИУслуги.ТекущиеДанные;
	
	Если ТолькоПросмотр
		Или ТекущиеДанные = Неопределено
		Или ТекущиеДанные.ЭтапВыполнен
		Или ТекущиеДанные.Отменено Тогда
		Возврат;
	КонецЕсли;
	
	Если Поле.Имя = Элементы.МатериалыИУслугиДоступно.Имя Тогда
		
		СтандартнаяОбработка = Ложь;
		МатериалыИУслугиВыборДоступности(ТекущиеДанные)
		
	//++ НЕ УТКА	
	ИначеЕсли Поле.Имя = "МатериалыИУслугиЕстьАналогиМатериала"
			И ТекущиеДанные.ЕстьАналогиМатериала 
			И Не ТолькоПросмотр Тогда
		
		СтандартнаяОбработка = Ложь;
		ОткрытьПодборАналогов();
	//-- НЕ УТКА
	
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура МатериалыИУслугиПередНачаломДобавления(Элемент, Отказ, Копирование, Родитель, Группа)
	
	ТекущиеДанные = Элемент.ТекущиеДанные;
	
	Если Копирование И ТекущиеДанные.ЭтапВыполнен Тогда
		Отказ = Истина;
		ПоказатьПредупреждение(Неопределено, НСтр("ru = 'Редактирование выполненного этапа недоступно.';
													|en = 'Cannot edit the completed stage.'"));
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура МатериалыИУслугиПриНачалеРедактирования(Элемент, НоваяСтрока, Копирование)
	
	РаботаСТабличнымиЧастямиКлиент.КэшироватьТекущуюСтроку(Элементы.МатериалыИУслуги, ЭтотОбъект);
	ТекущиеДанные = Элементы.МатериалыИУслуги.ТекущиеДанные;
	
	Если Копирование Тогда
		
		СтруктураДействий = Новый Структура();
		ДобавитьДействияОбеспеченияНаКлиенте(СтруктураДействий, "ВариантОбеспечения",ТекущиеДанные);
		ОбработкаТабличнойЧастиКлиент.ОбработатьСтрокуТЧ(ТекущиеДанные, СтруктураДействий, КэшированныеЗначения);
		
	КонецЕсли;
	
	Если НоваяСтрока Или Не ЗначениеЗаполнено(ТекущиеДанные.КлючСвязи) Тогда
		
		ТекущиеДанные.Отменено = Ложь;
		
		ТекущиеДанные.КодСтроки = 0;
		ТекущиеДанные.КлючСвязи = Новый УникальныйИдентификатор;
		
		ТекущиеДанные.КлючСвязиПродукция = Объект.КлючСвязи;
		
		Если ТекущиеДанные.ПроизводитсяВПроцессе Тогда
			
			ТекущиеДанные.ПроизводитсяВПроцессе = Ложь;
			
			ТекущиеДанные.ЗаказатьНаСклад = Ложь;
			ТекущиеДанные.ВариантОбеспечения = ПредопределенноеЗначение("Перечисление.ВариантыОбеспечения.НеТребуется");
			ТекущиеДанные.Обособленно = Ложь;
			
			ТекущиеДанные.ИсточникПолученияПолуфабриката = ПредопределенноеЗначение("Справочник.РесурсныеСпецификации.ПустаяСсылка");
			ТекущиеДанные.КлючСвязиЭтапВыпуска = Неопределено;
			
			ТекущиеДанные.СтатьяКалькуляции = ПредопределенноеЗначение("Справочник.СтатьиКалькуляции.ПустаяСсылка");
			
		ИначеЕсли Не Копирование Тогда
			
			ТекущиеДанные.ЗаказатьНаСклад = Ложь;
			ТекущиеДанные.ВариантОбеспечения = ПредопределенноеЗначение("Перечисление.ВариантыОбеспечения.НеТребуется");
			ТекущиеДанные.Обособленно = Ложь;
			
			ТекущиеДанные.ИсточникПолученияПолуфабриката = ПредопределенноеЗначение("Справочник.РесурсныеСпецификации.ПустаяСсылка");
			ТекущиеДанные.КлючСвязиЭтапВыпуска = Неопределено;
		
		КонецЕсли;
		
		ЗаполнитьДанныеЭтапаВСтрокеДляОдноэтапнойСпецификации(ТекущиеДанные, "МатериалыИУслуги");
		
	КонецЕсли;
	
	Если Копирование Тогда
		
		СтруктураДействий = Новый Структура();
		СтруктураДействий.Вставить("ПроверитьСериюРассчитатьСтатус", Новый Структура("Склад, ПараметрыУказанияСерий", ТекущиеДанные.Склад, ПараметрыУказанияСерий));
		СтруктураДействий.Вставить("ПересчитатьКоличествоЕдиниц", ПланированиеПроизводстваКлиентСервер.ПараметрыПересчетаКоличестваЕдиниц(ТекущиеДанные, "МатериалыИУслуги"));
		ДобавитьДействияОбеспеченияНаКлиенте(СтруктураДействий, "Доступно", ТекущиеДанные);
		ОбработкаТабличнойЧастиКлиент.ОбработатьСтрокуТЧ(ТекущиеДанные, СтруктураДействий, КэшированныеЗначения);
		
	КонецЕсли;
	
	СохранитьДанныеСтроки("МатериалыИУслуги", ТекущиеДанные);
	
КонецПроцедуры

&НаКлиенте
Процедура МатериалыИУслугиПриОкончанииРедактирования(Элемент, НоваяСтрока, ОтменаРедактирования)
	
	Если ОтменаРедактирования Тогда
		Возврат;
	КонецЕсли;
	
	ТекущиеДанные = Элементы.МатериалыИУслуги.ТекущиеДанные;
	
	Если ТекущиеДанные = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	ЗаполнитьНазначениеВСтрокеТЧМатериалыИУслугиНаКлиенте(ТекущиеДанные, НоваяСтрока);
	
	Если НоваяСтрока И Объект.ЕстьСоответствиеСтандартнойСпецификации
		ИЛИ ИзменениеОбязательныхРеквизитовСтроки(Объект, ТекущиеДанные, СохраненныеЗначения) Тогда
		Объект.ЕстьСоответствиеСтандартнойСпецификации = Ложь;
		ОбновитьСостояниеСпецификацииЗаказа(ЭтаФорма);
		НастроитьОтображениеПредупрежденийПриРедактировании();
	КонецЕсли;
	
	СтатусГрафикаПроизводства = ПредопределенноеЗначение("Перечисление.СтатусыГрафикаПроизводстваВЗаказеНаПроизводство.ТребуетсяРассчитать");
	
КонецПроцедуры

&НаКлиенте
Процедура МатериалыИУслугиНоменклатураПриИзменении(Элемент)
	
	ТекущиеДанные = Элементы.МатериалыИУслуги.ТекущиеДанные;
	МатериалыИУслугиПриИзмененииНоменклатурыНаСервере(ТекущиеДанные.ПолучитьИдентификатор());
	ЗаполнитьКоличествоМатериалаНаЕдиницуИзделия(ТекущиеДанные, Объект.КоличествоУпаковок);
	
КонецПроцедуры

&НаКлиенте
Процедура МатериалыИУслугиХарактеристикаПриИзменении(Элемент)
	
	ТекущиеДанные = Элементы.МатериалыИУслуги.ТекущиеДанные;
	МатериалыИУслугиПриИзмененииХарактеристикиНаСервере(ТекущиеДанные.ПолучитьИдентификатор());
	
КонецПроцедуры

&НаКлиенте
Процедура МатериалыИУслугиКоличествоНаЕдиницуИзделияПриИзменении(Элемент)
	
	ТекущиеДанные = Элементы.МатериалыИУслуги.ТекущиеДанные;
	
	ТекущиеДанные.КоличествоУпаковок = ТекущиеДанные.КоличествоНаЕдиницуИзделия * Объект.КоличествоУпаковок;
	
	МатериалыИУслугиОбработкаСобытияКоличествоПриИзменении(ТекущиеДанные);
	
КонецПроцедуры

&НаКлиенте
Процедура МатериалыИУслугиКоличествоУпаковокПриИзменении(Элемент)
	
	МатериалыИУслугиОбработкаСобытияКоличествоПриИзменении(Элементы.МатериалыИУслуги.ТекущиеДанные);
	
КонецПроцедуры

&НаКлиенте
Процедура МатериалыИУслугиУпаковкаПриИзменении(Элемент)
	
	МатериалыИУслугиОбработкаСобытияКоличествоПриИзменении(Элементы.МатериалыИУслуги.ТекущиеДанные);
	
КонецПроцедуры

&НаКлиенте
Процедура МатериалыИУслугиЭтапНачалоВыбора(Элемент, ДанныеВыбора, СтандартнаяОбработка)
	
	ВыборЭтапаПроизводства(СтандартнаяОбработка);
	
КонецПроцедуры

&НаКлиенте
Процедура МатериалыИУслугиСерияНачалоВыбора(Элемент, ДанныеВыбора, СтандартнаяОбработка)
	
	СтандартнаяОбработка = Ложь;
	ОткрытьПодборСерий(Элемент.ТекстРедактирования);
	
КонецПроцедуры

&НаКлиенте
Процедура МатериалыИУслугиСерияПриИзменении(Элемент)
	
	ВыбранноеЗначение = НоменклатураКлиентСервер.ВыбраннаяСерия();
	
	ВыбранноеЗначение.Значение            		 = Элементы.МатериалыИУслуги.ТекущиеДанные.Серия;
	ВыбранноеЗначение.ИдентификаторТекущейСтроки = Элементы.МатериалыИУслуги.ТекущиеДанные.ПолучитьИдентификатор();
	
	НоменклатураКлиент.ОбработатьУказаниеСерии(ЭтаФорма, ПараметрыУказанияСерий, ВыбранноеЗначение);
	
КонецПроцедуры

&НаКлиенте
Процедура МатериалыИУслугиПередУдалением(Элемент, Отказ)
	
	МассивСтрок = Новый Массив;
	МассивДанных = Новый Массив;
	
	СтруктураДанных = Новый Структура("
		|КлючСвязи, 
		|КлючСвязиЭтапВыпуска,
		|Номенклатура,
		|Характеристика,
		|Подразделение,
		|Упаковка,
		|КоличествоУпаковок,
		|Количество,
		|ПроизводитсяВПроцессе,
		|СпособПолученияПолуфабриката,
		|ИсточникПолученияПолуфабриката,
		|Склад,
		|ЗаказатьНаСклад");

	КоличествоВыполненныхСтрок = 0;
	ЕстьПолуфабрикатыПроизводимыеВПроцессе = Ложь;
	
	Для каждого ЭлементКоллекции Из Элементы.МатериалыИУслуги.ВыделенныеСтроки Цикл
		
		ДанныеСтроки = Элементы.МатериалыИУслуги.ДанныеСтроки(ЭлементКоллекции);
		
		Если ДанныеСтроки.ЭтапВыполнен Тогда
			
			КоличествоВыполненныхСтрок = КоличествоВыполненныхСтрок + 1;
			
		Иначе
			
			ЗаполнитьЗначенияСвойств(СтруктураДанных, ДанныеСтроки);
			
			МассивСтрок.Добавить(ДанныеСтроки);
			МассивДанных.Добавить(СтруктураДанных);
			
		КонецЕсли;
		
		ЕстьПолуфабрикатыПроизводимыеВПроцессе = ЕстьПолуфабрикатыПроизводимыеВПроцессе ИЛИ ДанныеСтроки.ПроизводитсяВПроцессе;
		
	КонецЦикла;
	
	Если КоличествоВыполненныхСтрок > 0 ИЛИ ЕстьПолуфабрикатыПроизводимыеВПроцессе Тогда
		
		Отказ = Истина;
		
		Если КоличествоВыполненныхСтрок = Элементы.МатериалыИУслуги.ВыделенныеСтроки.Количество() Тогда
			
			ПоказатьПредупреждение(Неопределено, НСтр("ru = 'Удаление данных выполненного этапа недоступно.';
														|en = 'Cannot remove data of the completed stage.'"));
			
		Иначе
		
			ПараметрыОповещения = Новый Структура("МассивДанных, МассивСтрок, ЕстьПолуфабрикатыПроизводимыеВПроцессе", 
				МассивДанных, МассивСтрок, ЕстьПолуфабрикатыПроизводимыеВПроцессе);
				
			Если КоличествоВыполненныхСтрок > 0 Тогда
					
				ТекстВопроса = НСтр("ru = 'По некоторым из выбранных строк этапы уже выполнены, их удаление невозможно. Удалить остальные строки?';
									|en = 'Stages by some of the selected lines have already been completed. They cannot be removed. Remove the other lines?'");
				
				ОписаниеОповещения = Новый ОписаниеОповещения(
					"МатериалыИУслугиПередУдалениемПродолжение", 
					ЭтотОбъект, 
					ПараметрыОповещения);
				
				ПоказатьВопрос(ОписаниеОповещения, ТекстВопроса, РежимДиалогаВопрос.ДаНет);
				
			Иначе
				
				МатериалыИУслугиПередУдалениемПродолжение(КодВозвратаДиалога.Да, ПараметрыОповещения);
				
			КонецЕсли;
			
		КонецЕсли;
		
		Возврат;
		
	КонецЕсли;

	УдаляемыеСтрокиМассивДанных = Новый ФиксированныйМассив(МассивДанных);
	
КонецПроцедуры

&НаКлиенте
Процедура МатериалыИУслугиПередУдалениемПродолжение(РезультатВопроса, ДополнительныеПараметры) Экспорт
	
	Если РезультатВопроса = КодВозвратаДиалога.Нет Тогда
		
		Возврат;
		
	КонецЕсли;
	
	Если ДополнительныеПараметры.ЕстьПолуфабрикатыПроизводимыеВПроцессе Тогда
		
		Если ДополнительныеПараметры.МассивДанных.Количество() > 1 Тогда
			
			ТекстВопроса = НСтр("ru = 'Удаление строк приведет к потере связанных данных о производимых в процессе полуфабрикатах. Продолжить?';
								|en = 'If the lines are removed, linked data about the semi-finished products manufactured in the process will be lost. Continue?'");
			
		Иначе
			
			ТекстВопроса = НСтр("ru = 'Удаление строки приведет к потере связанных данных о производимых в процессе полуфабрикатах. Продолжить?';
								|en = 'If the line is removed, linked data about the semi-finished products manufactured in the process will be lost. Continue?'");
			
		КонецЕсли;
		
		ОписаниеОповещения = Новый ОписаниеОповещения(
			"МатериалыИУслугиПередУдалениемЗавершение", 
			ЭтотОбъект,
			ДополнительныеПараметры);
		
		ПоказатьВопрос(ОписаниеОповещения, ТекстВопроса, РежимДиалогаВопрос.ДаНет);
		
		Возврат;
		
	КонецЕсли;
	
	МатериалыИУслугиПередУдалениемЗавершение(РезультатВопроса, ДополнительныеПараметры);
	
КонецПроцедуры

&НаКлиенте
Процедура МатериалыИУслугиПередУдалениемЗавершение(РезультатВопроса, ДополнительныеПараметры) Экспорт
	
	Если РезультатВопроса = КодВозвратаДиалога.Нет Тогда
		
		Возврат;
		
	КонецЕсли;
	
	УдаляемыеСтрокиМассивДанных = Новый ФиксированныйМассив(ДополнительныеПараметры.МассивДанных);
	
	Для каждого Строка Из ДополнительныеПараметры.МассивСтрок Цикл
		
		Объект.МатериалыИУслуги.Удалить(Строка);
		
	КонецЦикла;
	
	МатериалыИУслугиПослеУдаленияНаСервере();
	
КонецПроцедуры

&НаКлиенте
Процедура МатериалыИУслугиПослеУдаления(Элемент)

	МатериалыИУслугиПослеУдаленияНаСервере();
	
КонецПроцедуры

&НаКлиенте
Процедура МатериалыИУслугиОтменитьПолучениеПриИзменении(Элемент)
	
	ТекущиеДанные = Элементы.МатериалыИУслуги.ТекущиеДанные;
	
	ПриИзмененииОтменено(ТекущиеДанные);
	
КонецПроцедуры

&НаКлиенте
Процедура МатериалыИУслугиПроизводитсяВПроцессеПриИзменении(Элемент)
	
	ТекущиеДанные = Элементы.МатериалыИУслуги.ТекущиеДанные;
	
	Если ТекущиеДанные.ПроизводитсяВПроцессе 
		И НЕ ЗначениеЗаполнено(ТекущиеДанные.СпособПолученияПолуфабриката) Тогда
		ТекущиеДанные.СпособПолученияПолуфабриката = ПредопределенноеЗначение("Перечисление.СпособыПолучениеМатериаловЭтапаПроизводства.ПроизвестиПоСпецификации");
	ИначеЕсли НЕ ТекущиеДанные.ПроизводитсяВПроцессе Тогда
		ТекущиеДанные.СпособПолученияПолуфабриката = ПредопределенноеЗначение("Перечисление.СпособыПолучениеМатериаловЭтапаПроизводства.ПустаяСсылка");
	КонецЕсли; 
	
	ПриИзмененииПараметровПроизводитсяВПроцессе();
	
КонецПроцедуры

&НаКлиенте
Процедура МатериалыИУслугиСпособПолученияПолуфабрикатаПриИзменении(Элемент)
	
	ТекущиеДанные = Элементы.МатериалыИУслуги.ТекущиеДанные;
	
	Если НЕ ЗначениеЗаполнено(ТекущиеДанные.СпособПолученияПолуфабриката) Тогда
		ТекущиеДанные.СпособПолученияПолуфабриката = ПредопределенноеЗначение("Перечисление.СпособыПолучениеМатериаловЭтапаПроизводства.ПроизвестиПоСпецификации");
	КонецЕсли; 
	
	ПриИзмененииПараметровПроизводитсяВПроцессе();
	
КонецПроцедуры

&НаКлиенте
Процедура МатериалыИУслугиСпособПолученияПолуфабрикатаОчистка(Элемент, СтандартнаяОбработка)
	
	ТекущиеДанные = Элементы.МатериалыИУслуги.ТекущиеДанные;
	
	Если Не ЗначениеЗаполнено(ТекущиеДанные.СпособПолученияПолуфабриката) Тогда
		СтандартнаяОбработка = Ложь;
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура МатериалыИУслугиИсточникПолученияПолуфабрикатаПриИзменении(Элемент)
	
	ТекущиеДанные = Элементы.МатериалыИУслуги.ТекущиеДанные;
	
	Если ТекущиеДанные.СпособПолученияПолуфабриката = ПредопределенноеЗначение("Перечисление.СпособыПолучениеМатериаловЭтапаПроизводства.ПроизвестиПоСпецификации") Тогда
		
		ПродукцияЗаполнитьЭтапыВыходныеИзделияМатериалыИУслугиНаКлиенте(ТекущиеДанные)
		
	ИначеЕсли ТекущиеДанные.СпособПолученияПолуфабриката = ПредопределенноеЗначение("Перечисление.СпособыПолучениеМатериаловЭтапаПроизводства.ПроизвестиНаЭтапе") Тогда
		
		ОтменитьПотребностьВоВнутреннихПолуфабрикатах(ТекущиеДанные);
		
	КонецЕсли;
	
	Если ИзменениеОбязательныхРеквизитовСтроки(Объект, ТекущиеДанные, СохраненныеЗначения) Тогда
		Объект.ЕстьСоответствиеСтандартнойСпецификации = Ложь;
		ОбновитьСостояниеСпецификацииЗаказа(ЭтаФорма);
		НастроитьОтображениеПредупрежденийПриРедактировании();
		СохраненныеЗначения = Неопределено;
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура МатериалыИУслугиИсточникПолученияПолуфабрикатаНачалоВыбора(Элемент, ДанныеВыбора, СтандартнаяОбработка)
	
	ТекущиеДанные = Элементы.МатериалыИУслуги.ТекущиеДанные;
	
	ПроизвестиНаЭтапе = ТекущиеДанные.СпособПолученияПолуфабриката = ПредопределенноеЗначение("Перечисление.СпособыПолучениеМатериаловЭтапаПроизводства.ПроизвестиНаЭтапе");
	
	ПроизвестиПоСпецификации = ТекущиеДанные.СпособПолученияПолуфабриката = ПредопределенноеЗначение("Перечисление.СпособыПолучениеМатериаловЭтапаПроизводства.ПроизвестиПоСпецификации");
	
	Если ПроизвестиНаЭтапе ИЛИ ПроизвестиПоСпецификации Тогда
	
		СтандартнаяОбработка = Ложь;
		
		Если Не ЗначениеЗаполнено(ТекущиеДанные.Этап) Тогда
			ПоказатьПредупреждение(Неопределено, НСтр("ru = 'Необходимо указать этап производства.';
														|en = 'Specify a production stage.'"));
			Возврат;
		КонецЕсли;
		
		Если ПроизвестиПоСпецификации Тогда
			
			ДанныеОбИзделии = УправлениеДаннымиОбИзделияхКлиентСервер.СтруктураДанныхОбИзделииДляВыбораСпецификации();
			ДанныеОбИзделии.Номенклатура            = ТекущиеДанные.Номенклатура;
			ДанныеОбИзделии.Характеристика          = ТекущиеДанные.Характеристика;
			ДанныеОбИзделии.ПодразделениеДиспетчер  = ТекущиеДанные.Подразделение;
			ДанныеОбИзделии.НачалоПроизводства      = Объект.НачатьНеРанее;
			
			УправлениеДаннымиОбИзделияхКлиент.ОткрытьФормуВыбораСпецификацийПоНоменклатуре(
				ДанныеОбИзделии,
				ПараметрыВыбораСпецификаций,
				ЭтаФорма);
			
		ИначеЕсли ПроизвестиНаЭтапе Тогда
			
			ПараметрыФормы = Новый Структура;
			ПараметрыФормы.Вставить("ВыполняемаяОперация", "ВыборЭтапаВыпускаПолуфабриката");
			ПараметрыФормы.Вставить("Номенклатура", ТекущиеДанные.Номенклатура);
			ПараметрыФормы.Вставить("Характеристика", ТекущиеДанные.Характеристика);
			ПараметрыФормы.Вставить("Адрес", ПоместитьТаблицуДоступныхДляВыбораЭтаповВыпускаПолуфабрикатаВХранилище());
			
			ОткрытьФорму("Обработка.РедактированиеСпецификацииСтрокиЗаказа.Форма.ФормаВыбораЭтапаПроизводства", ПараметрыФормы, ЭтаФорма);
			
		КонецЕсли;
		
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура МатериалыИУслугиИсточникПолученияПолуфабрикатаОчистка(Элемент, СтандартнаяОбработка)
	
	ТекущиеДанные = Элементы.МатериалыИУслуги.ТекущиеДанные;
	
	Если Не ЗначениеЗаполнено(ТекущиеДанные.ИсточникПолученияПолуфабриката) Тогда
		СтандартнаяОбработка = Ложь;
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура МатериалыИУслугиСкладПриИзменении(Элемент)
	
	ТекущиеДанные = Элементы.МатериалыИУслуги.ТекущиеДанные;
	
	СтруктураДействий = Новый Структура;
	СтруктураДействий.Вставить("ПроверитьСериюРассчитатьСтатус", Новый Структура("Склад, ПараметрыУказанияСерий", ТекущиеДанные.Склад, ПараметрыУказанияСерий));
	ДобавитьДействияОбеспеченияНаКлиенте(СтруктураДействий, "ВариантОбеспечения,ДоступноВДругихСтроках", ТекущиеДанные);
	ОбработкаТабличнойЧастиКлиент.ОбработатьСтрокуТЧ(ТекущиеДанные, СтруктураДействий, КэшированныеЗначения);
	Если ОбеспечениеВДокументахКлиент.ТребуетсяОбновитьКолонкуДоступно(СтруктураДействий) Тогда
		ОбновитьКолонкуДоступноСервер();
	КонецЕсли;
	
	Если ТекущиеДанные.ВариантОбеспечения = ПредопределенноеЗначение("Перечисление.ВариантыОбеспечения.НеТребуется")
		И ТекущиеДанные.ЗаказатьНаСклад Тогда
		ТекущиеДанные.ЗаказатьНаСклад = Ложь;
	ИначеЕсли ТекущиеДанные.ВариантОбеспечения <> ПредопределенноеЗначение("Перечисление.ВариантыОбеспечения.НеТребуется")
		И НЕ ТекущиеДанные.ЗаказатьНаСклад 
		И ТекущиеДанные.ТипНоменклатуры <> ПредопределенноеЗначение("Перечисление.ТипыНоменклатуры.Работа") Тогда
		ТекущиеДанные.ЗаказатьНаСклад = Истина;
	КонецЕсли;
	
	Если ТекущиеДанные.ПроизводитсяВПроцессе Тогда
		ЗаполнитьНаправлениеВыпускаНаОснованииСтрокиМатериала(ТекущиеДанные, "КлючСвязиПолуфабрикат", Объект.ВыходныеИзделия);
		ЗаполнитьНаправлениеВыпускаНаОснованииСтрокиМатериала(ТекущиеДанные, "КлючСвязиМатериалыИУслуги", Объект.ВозвратныеОтходы);
	КонецЕсли;
	
	Если ТекущиеДанные.ЗаказатьНаСклад
		И НЕ ТекущиеДанные.ПроизводитсяВПроцессе Тогда
		
		Если Не ЗначениеЗаполнено(ТекущиеДанные.Номенклатура)
			Или (Не ЗначениеЗаполнено(ТекущиеДанные.Характеристика) И ТекущиеДанные.ХарактеристикиИспользуются)
			Или Не ЗначениеЗаполнено(ТекущиеДанные.Склад) Тогда
			
			ТекущиеДанные.Запланировать = Ложь;
			
		Иначе
			ТекущиеДанные.Запланировать = ПризнакПланированияПолуфабрикатов(
				ТекущиеДанные.ТипНоменклатуры, ТекущиеДанные.Номенклатура, ТекущиеДанные.Характеристика, ТекущиеДанные.Склад, Объект.ПодразделениеДиспетчер);
		КонецЕсли;
	
	КонецЕсли;
	
	Если ИзменениеОбязательныхРеквизитовСтроки(Объект, ТекущиеДанные, СохраненныеЗначения) Тогда
		Объект.ЕстьСоответствиеСтандартнойСпецификации = Ложь;
		ОбновитьСостояниеСпецификацииЗаказа(ЭтаФорма);
		НастроитьОтображениеПредупрежденийПриРедактировании();
		СохраненныеЗначения = Неопределено;
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура МатериалыИУслугиВыборДоступности(ТекущиеДанные)
	
	Если ТекущиеДанные.ПроизводитсяВПроцессе И НЕ ТекущиеДанные.ЗаказатьНаСклад Тогда
		Возврат;
	КонецЕсли;
	
	ПараметрыФормы = ПараметрыФормыЗапросаКоличестваИСерий(Неопределено);
	
	Если ПараметрыФормы <> Неопределено Тогда
		ОткрытьФорму("Обработка.ЗапросКоличестваИСерий.Форма", ПараметрыФормы, ЭтотОбъект);
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура МатериалыИУслугиВариантОбеспеченияПриИзменении(Элемент)
	
	Перем ПараметрыФормы;
	Если ОбеспечениеВДокументахКлиент.ОткрытьФормуВыбораСкладаИСерий(ЭтотОбъект) Тогда
		ВариантПолученияПараметров = ОбеспечениеВДокументахКлиентСервер.РежимВыборДействия();
		ПараметрыФормы = ПараметрыФормыЗапросаКоличестваИСерий(ВариантПолученияПараметров); // вызов сервера
	КонецЕсли;
	
	ОбеспечениеВДокументахКлиент.ВариантОбеспеченияПриИзменении(
		ЭтотОбъект,
		ПараметрыФормы,
		"ОбработатьВыборСкладаИСерии",
		Ложь,
		"МатериалыИУслугиВариантОбеспеченияПриИзмененииНаКлиенте");
	
КонецПроцедуры

&НаКлиенте
Процедура МатериалыИУслугиВариантОбеспеченияОчистка(Элемент, СтандартнаяОбработка)
	
	СтандартнаяОбработка = Ложь;
	
КонецПроцедуры

&НаКлиенте
Процедура МатериалыИУслугиВариантОбеспеченияНачалоВыбора(Элемент, ДанныеВыбора, СтандартнаяОбработка)
	
	НовыйМассив = Новый Массив();
	
	ТекущиеДанные = Элементы.МатериалыИУслуги.ТекущиеДанные;
	
	Если ТекущиеДанные.ТипНоменклатуры = ПредопределенноеЗначение("Перечисление.ТипыНоменклатуры.Работа")
			Или ТекущиеДанные.ПроизводствоНаСтороне Тогда
		
		МассивДействий = Новый Массив();
		МассивДействий.Добавить(ПредопределенноеЗначение("Перечисление.ВариантыОбеспечения.СоСклада"));
		МассивДействий.Добавить(ПредопределенноеЗначение("Перечисление.ВариантыОбеспечения.РезервироватьПоМереПоступления"));
		МассивДействий.Добавить(ПредопределенноеЗначение("Перечисление.ВариантыОбеспечения.НеТребуется"));
		
		ДопустимыеДействия = Новый ФиксированныйМассив(МассивДействий);
		НовыйПараметр = Новый ПараметрВыбора("ДопустимыеДействия", ДопустимыеДействия);
		НовыйМассив.Добавить(НовыйПараметр);
		
	КонецЕсли;
	
	Если ТекущиеДанные.ПроизводитсяВПроцессе Тогда
		НовыйПараметр = Новый ПараметрВыбора("ИспользоватьЧастичнуюОтгрузку", Ложь);
		НовыйМассив.Добавить(НовыйПараметр);
	КонецЕсли;
	
	Элемент.ПараметрыВыбора = Новый ФиксированныйМассив(НовыйМассив);
	
КонецПроцедуры

&НаКлиенте
Процедура МатериалыИУслугиВариантОбеспеченияОбработкаВыбора(Элемент, ВыбранноеЗначение, СтандартнаяОбработка)
	
	ОбеспечениеВДокументахКлиент.ВариантОбеспеченияОбработкаВыбора(
		ЭтотОбъект,
		Элементы.МатериалыИУслуги.ТекущиеДанные,
		ВыбранноеЗначение);
	
КонецПроцедуры

&НаКлиенте
Процедура МатериалыИУслугиОбособленноПриИзменении(Элемент)
	
	СтрокаТаблицы = Элементы.МатериалыИУслуги.ТекущиеДанные;
	ОбеспечениеВДокументахКлиент.ОбособленноПриИзменении(СтрокаТаблицы);
	СтруктураДействий = Новый Структура();
	ДобавитьДействияОбеспеченияНаКлиенте(СтруктураДействий, "ДоступноВДругихСтроках", СтрокаТаблицы);
	ОбработкаТабличнойЧастиКлиент.ОбработатьСтрокуТЧ(СтрокаТаблицы, СтруктураДействий, Неопределено);
	Если ОбеспечениеВДокументахКлиент.ТребуетсяОбновитьКолонкуДоступно(СтруктураДействий) Тогда
		ОбновитьКолонкуДоступноСервер();
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиСобытийЭлементовТаблицыФормыТрудозатраты

&НаКлиенте
Процедура ТрудозатратыПередНачаломДобавления(Элемент, Отказ, Копирование, Родитель, Группа)
	
	ТекущиеДанные = Элемент.ТекущиеДанные;
	
	Если Копирование И ТекущиеДанные.ЭтапВыполнен Тогда
		Отказ = Истина;
		ПоказатьПредупреждение(Неопределено, НСтр("ru = 'Редактирование выполненного этапа недоступно.';
													|en = 'Cannot edit the completed stage.'"));
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ТрудозатратыПередУдалением(Элемент, Отказ)
	
	ТекущиеДанные = Элемент.ТекущиеДанные;
	
	Если ТекущиеДанные.ЭтапВыполнен Тогда
		Отказ = Истина;
		ПоказатьПредупреждение(Неопределено, НСтр("ru = 'Удаление данных выполненного этапа недоступно.';
													|en = 'Cannot remove data of the completed stage.'"));
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ТрудозатратыПриНачалеРедактирования(Элемент, НоваяСтрока, Копирование)
	
	ТекущиеДанные = Элемент.ТекущиеДанные;
	
	Если НоваяСтрока Тогда
		
		ТекущиеДанные.КлючСвязи = Новый УникальныйИдентификатор;
		ТекущиеДанные.КлючСвязиПродукция = Объект.КлючСвязи;
		
		ЗаполнитьДанныеЭтапаВСтрокеДляОдноэтапнойСпецификации(ТекущиеДанные);
		
	КонецЕсли;
	
	СохранитьДанныеСтроки("Трудозатраты", ТекущиеДанные);
	
КонецПроцедуры

&НаКлиенте
Процедура ТрудозатратыЭтапНачалоВыбора(Элемент, ДанныеВыбора, СтандартнаяОбработка)
	
	ВыборЭтапаПроизводства(СтандартнаяОбработка);
	
КонецПроцедуры

&НаКлиенте
Процедура ТрудозатратыПриОкончанииРедактирования(Элемент, НоваяСтрока, ОтменаРедактирования)
	
	ТекущиеДанные = Элементы.Трудозатраты.ТекущиеДанные;
	
	Если ТекущиеДанные = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	Если НоваяСтрока И Объект.ЕстьСоответствиеСтандартнойСпецификации
		ИЛИ ИзменениеОбязательныхРеквизитовСтроки(Объект, ТекущиеДанные, СохраненныеЗначения) Тогда
		Объект.ЕстьСоответствиеСтандартнойСпецификации = Ложь;
		ОбновитьСостояниеСпецификацииЗаказа(ЭтаФорма);
		НастроитьОтображениеПредупрежденийПриРедактировании();
	КонецЕсли;
	
	СтатусГрафикаПроизводства = ПредопределенноеЗначение("Перечисление.СтатусыГрафикаПроизводстваВЗаказеНаПроизводство.ТребуетсяРассчитать");
	
КонецПроцедуры

&НаКлиенте
Процедура ТрудозатратыПослеУдаления(Элемент)
	
	Если Объект.ЕстьСоответствиеСтандартнойСпецификации Тогда
		Объект.ЕстьСоответствиеСтандартнойСпецификации = Ложь;
		ОбновитьСостояниеСпецификацииЗаказа(ЭтаФорма);
		НастроитьОтображениеПредупрежденийПриРедактировании();
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиСобытийЭлементовТаблицыФормыЭтапы

&НаКлиенте
Процедура ЭтапыВыбор(Элемент, ВыбраннаяСтрока, Поле, СтандартнаяОбработка)
	
	СтандартнаяОбработка = Ложь;
	
	ЭтапыРедактирование();
	
КонецПроцедуры

&НаКлиенте
Процедура ЭтапыПередУдалением(Элемент, Отказ)
	
	Перем ОписаниеОшибки;
	
	ТекущиеДанные = Элемент.ТекущиеДанные;
	
	Если ТекущиеДанные.ЭтапВыполнен Тогда
		Отказ = Истина;
		ОписаниеОшибки = НСтр("ru = 'Удаление выполненного этапа недоступно.';
								|en = 'Cannot remove the completed stage.'");
		ПоказатьПредупреждение(Неопределено, ОписаниеОшибки);
		Возврат;
	КонецЕсли;
	
	УдалитьДанныеЭтапа(ТекущиеДанные.КлючСвязи, Отказ, ОписаниеОшибки);
	
	Если Отказ Тогда
		ПоказатьПредупреждение(Неопределено, ОписаниеОшибки);
		Возврат;
	КонецЕсли;
	
	Модифицированность = Истина;
	ВсегоИзделий = Объект.ВыходныеИзделия.Количество() + Объект.ВозвратныеОтходы.Количество();
	
	ОбновитьСостояниеСпецификацииЗаказа(ЭтаФорма);
	
	СтатусГрафикаПроизводства = ПредопределенноеЗначение("Перечисление.СтатусыГрафикаПроизводстваВЗаказеНаПроизводство.ТребуетсяРассчитать");
	
КонецПроцедуры

&НаКлиенте
Процедура ЭтапыПередНачаломДобавления(Элемент, Отказ, Копирование, Родитель, Группа, Параметр)
	
	Отказ = Истина;
	
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиКомандФормы

&НаКлиенте
Процедура ЗаполнитьДатуПотребности(Команда)

	ВыбранныеСтроки = Элементы.МатериалыИУслуги.ВыделенныеСтроки;
	Если ВыбранныеСтроки.Количество() > 0 Тогда
		
		Оповещение = Новый ОписаниеОповещения("ЗаполнитьДатуПотребностиЗавершение", ЭтотОбъект, Новый Структура("ВыбранныеСтроки", ВыбранныеСтроки));
		
		ОбщегоНазначенияУТКлиент.ВвестиДатуСКонтролемПустогоЗначения('00010101', НСтр("ru = 'Введите дату потребности';
																						|en = 'Enter demand date'"), ЧастиДаты.Дата, Оповещение);
		
	Иначе
		ТекстПредупреждения = НСтр("ru = 'В документе не выбраны строки для заполнения. Дата потребности не будет заполнена.';
									|en = 'No lines to fill in are selected in the document. Date of demand will not be filled in.'");
		ПоказатьПредупреждение(Неопределено, ТекстПредупреждения);
	КонецЕсли;

КонецПроцедуры

&НаКлиенте
Процедура ЗаполнитьПоСпецификации(Команда)
	
	ЗаполнитьПоСпецификацииКлиент();
	
КонецПроцедуры

&НаКлиенте
Процедура СравнитьСоСпецификацией(Команда)
	
	Если Не ЗначениеЗаполнено(Объект.Спецификация) Тогда
		
		ТекстПредупреждения = НСтр("ru = 'Не указана стандартная спецификация';
									|en = 'Standard bill of materials is not specified'");
		
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(
			ТекстПредупреждения,
			,
			"Спецификация",
			"Объект",);
		
		Возврат;
		
	КонецЕсли;
	
	ДанныеЗаказа = Новый Соответствие;
	
	СтруктураДанных = Новый Структура;
	СтруктураДанных.Вставить("КлючСвязиПродукция",      Объект.КлючСвязи);
	СтруктураДанных.Вставить("НомерСтроки",             Объект.НомерСтроки);
	СтруктураДанных.Вставить("Номенклатура",            Объект.Номенклатура);
	СтруктураДанных.Вставить("Характеристика",          Объект.Характеристика);
	СтруктураДанных.Вставить("Спецификация",            Объект.Спецификация);
	СтруктураДанных.Вставить("Количество",              Объект.КоличествоУпаковок);
	СтруктураДанных.Вставить("Упаковка",                Объект.Упаковка);
	
	СтруктураДанных.Вставить("НачалоПроизводства",      Объект.НачатьНеРанее);
	СтруктураДанных.Вставить("ПодразделениеДиспетчер",  Объект.ПодразделениеДиспетчер);
	СтруктураДанных.Вставить("НаправлениеДеятельности", ПредопределенноеЗначение("Справочник.НаправленияДеятельности.ПустаяСсылка"));
	
	ДанныеЗаказа.Вставить(СтруктураДанных.НомерСтроки, СтруктураДанных);
	
	ПараметрыФормы = Новый Структура;
	ПараметрыФормы.Вставить("ДанныеЗаказа",       ДанныеЗаказа);
	ПараметрыФормы.Вставить("Этапы",              Объект.Этапы);
	ПараметрыФормы.Вставить("МатериалыИУслуги",   Объект.МатериалыИУслуги);
	ПараметрыФормы.Вставить("ВыходныеИзделия",    Объект.ВыходныеИзделия);
	ПараметрыФормы.Вставить("ВозвратныеОтходы",   Объект.ВозвратныеОтходы);
	ПараметрыФормы.Вставить("ВидыРабочихЦентров", Объект.ВидыРабочихЦентров);
	
	ОткрытьФорму("Обработка.СравнениеСпецификаций.Форма.СравнениеЗаказаСоСпецификациями", ПараметрыФормы);
	
КонецПроцедуры

&НаКлиенте
Процедура УточнитьМатериалПредыдущий(Команда)
	
	ТекущиеДанные = Элементы.МатериалыИУслуги.ТекущиеДанные;
	
	Если ТекущиеДанные = Неопределено ИЛИ НЕ ЕстьУточненияМатериалов Тогда
		Возврат;
	КонецЕсли;
	
	УправлениеПроизводствомКлиент.ПерейтиКСтрокеСАвтовыборомКоторуюТребуетсяУточнить(Объект,
		ЭтаФорма, "МатериалыИУслуги", ТекущиеДанные.НомерСтроки, -1);
	
КонецПроцедуры

&НаКлиенте
Процедура УточнитьМатериалСледующий(Команда)
	
	ТекущиеДанные = Элементы.МатериалыИУслуги.ТекущиеДанные;
	
	Если ТекущиеДанные = Неопределено ИЛИ НЕ ЕстьУточненияМатериалов Тогда
		Возврат;
	КонецЕсли;
	
	УправлениеПроизводствомКлиент.ПерейтиКСтрокеСАвтовыборомКоторуюТребуетсяУточнить(Объект,
		ЭтаФорма, "МатериалыИУслуги", ТекущиеДанные.НомерСтроки, 1);
	
КонецПроцедуры

&НаКлиенте
Процедура УточнитьПобочноеИзделиеПредыдущий(Команда)
	
	ТекущиеДанные = Элементы.ВозвратныеОтходы.ТекущиеДанные;
	
	Если ТекущиеДанные = Неопределено ИЛИ НЕ ЕстьУточненияПобочныхИзделий Тогда
		Возврат;
	КонецЕсли;
	
	УправлениеПроизводствомКлиент.ПерейтиКСтрокеСАвтовыборомКоторуюТребуетсяУточнить(Объект,
		ЭтаФорма, "ВозвратныеОтходы", ТекущиеДанные.НомерСтроки, -1);
	
КонецПроцедуры

&НаКлиенте
Процедура УточнитьПобочноеИзделиеСледующий(Команда)
	
	ТекущиеДанные = Элементы.ВозвратныеОтходы.ТекущиеДанные;
	
	Если ТекущиеДанные = Неопределено ИЛИ НЕ ЕстьУточненияПобочныхИзделий Тогда
		Возврат;
	КонецЕсли;
	
	УправлениеПроизводствомКлиент.ПерейтиКСтрокеСАвтовыборомКоторуюТребуетсяУточнить(Объект,
		ЭтаФорма, "ВозвратныеОтходы", ТекущиеДанные.НомерСтроки, 1)
	
КонецПроцедуры

&НаКлиенте
Процедура КомандаПроверитьЗаполнениеСпецификации(Команда)
	
	ОчиститьСообщения();
	
	РезультатПроверки = ПроверитьЗаполнение();
	
	Если Не РезультатПроверки И Не ЕстьУточненияМатериалов Тогда
		ЕстьОшибкиЗаполнения = Истина;
	Иначе
		ЕстьОшибкиЗаполнения = Ложь;
	КонецЕсли;
	
	Если Не ЕстьОшибкиЗаполнения И Не ЕстьУточненияМатериалов Тогда 
		ПоказатьПредупреждение(Новый ОписаниеОповещения("КомандаПроверитьЗаполнениеСпецификацииЗавершение", ЭтотОбъект), НСтр("ru = 'Ошибок не обнаружено.';
																																|en = 'No errors detected.'"));
        Возврат;
	КонецЕсли;
	
	КомандаПроверитьЗаполнениеСпецификацииФрагмент();
КонецПроцедуры

&НаКлиенте
Процедура КомандаПроверитьЗаполнениеСпецификацииЗавершение(ДополнительныеПараметры) Экспорт
    
    КомандаПроверитьЗаполнениеСпецификацииФрагмент();

КонецПроцедуры

&НаКлиенте
Процедура КомандаПроверитьЗаполнениеСпецификацииФрагмент()
    
    ОбновитьСостояниеСпецификацииЗаказа(ЭтаФорма);

КонецПроцедуры

&НаКлиенте
Процедура СтруктураИзделия(Команда)
	
	ПараметрыФормы = Новый Структура("СформироватьПриОткрытии, Заголовок", Истина, НСтр("ru = 'Структура изделия';
																						|en = 'Product structure'"));
	
	ПараметрыФормы.Вставить("Режим", УправлениеДаннымиОбИзделияхКлиентСервер.РежимДеревоСпецификацийЗаказа());
	
	ПараметрыФормы.Вставить("Номенклатура",					Объект.Номенклатура);
	ПараметрыФормы.Вставить("ХарактеристикаНоменклатуры",	Объект.Характеристика);
	ПараметрыФормы.Вставить("Спецификация",					Объект.Спецификация);
	ПараметрыФормы.Вставить("Количество",					Объект.Количество);
	ПараметрыФормы.Вставить("КоличествоУпаковок",			Объект.КоличествоУпаковок);
	ПараметрыФормы.Вставить("Упаковка",						Объект.Упаковка);
	ПараметрыФормы.Вставить("ПодразделениеДиспетчер",		Объект.ПодразделениеДиспетчер);
	
	СтруктураОтбора = Новый Структура("Номенклатура, Характеристика", Объект.Номенклатура, Объект.Характеристика);
	
	НайденныеСтроки = Объект.ВыходныеИзделия.НайтиСтроки(СтруктураОтбора);
	Если НайденныеСтроки.Количество() = 1 Тогда
		ПараметрыФормы.Вставить("КлючСвязи", НайденныеСтроки[0].КлючСвязиПолуфабрикат);
	Иначе
		ПараметрыФормы.Вставить("КлючСвязи", ПолучитьПустойУникальныйИдентификатор());
	КонецЕсли;
	
	ПараметрыФормы.Вставить("АдресВХранилище", ДанныеСпецификацииВХранилище());
	
	ОткрытьФорму("Обработка.ДеревоРесурсныхСпецификаций.Форма", ПараметрыФормы, ЭтаФорма);
	
КонецПроцедуры

&НаКлиенте
Процедура РедактироватьЭтап(Команда)
	
	ЭтапыРедактирование();
	
КонецПроцедуры

&НаКлиенте
Процедура ПоказатьАналоги(Команда)
	
	//++ НЕ УТКА
	ПоказатьАналоги = Не ПоказатьАналоги;
	Если ПравоЧтенияАналогов И ПоказатьАналоги Тогда
		ОтметитьНаличиеАналогов();
	КонецЕсли;
	
	Элементы.МатериалыИУслугиПоказатьАналоги.Пометка = ПоказатьАналоги;
	Элементы.МатериалыИУслугиЕстьАналогиМатериала.Видимость = ПоказатьАналоги;
	//-- НЕ УТКА
	
КонецПроцедуры

&НаКлиенте
Процедура ПодобратьАналоги(Команда)
	
	 //++ НЕ УТКА
	ОценкаПроизводительностиКлиент.НачатьЗамерВремени(Истина,
		"Обработка.РедактированиеСпецификацииСтрокиЗаказа.Форма.Форма.Команда.ПодобратьАналоги");
	
	ОткрытьПодборАналогов();
	//-- НЕ УТКА
	
КонецПроцедуры

&НаКлиенте
Процедура ПодборТоваров(Команда)
	
	// &ЗамерПроизводительности
	ОценкаПроизводительностиКлиент.НачатьЗамерВремени(Истина,
		"Обработка.РедактированиеСпецификацииСтрокиЗаказа.Форма.Команда.ПодобратьТовары");
	
	МассивТиповНоменклатуры = Новый Массив;
	МассивТиповНоменклатуры.Добавить(ПредопределенноеЗначение("Перечисление.ТипыНоменклатуры.Товар"));
	МассивТиповНоменклатуры.Добавить(ПредопределенноеЗначение("Перечисление.ТипыНоменклатуры.Работа"));
	МассивТиповНоменклатуры.Добавить(ПредопределенноеЗначение("Перечисление.ТипыНоменклатуры.МногооборотнаяТара"));
	
	ПараметрыФормы = Новый Структура;
	ПараметрыФормы.Вставить("РежимПодбораБезСуммовыхПараметров",         Истина);
	ПараметрыФормы.Вставить("ОтборПоТипуНоменклатуры",                   Новый ФиксированныйМассив(МассивТиповНоменклатуры));
	ПараметрыФормы.Вставить("ИспользоватьДатыОтгрузки",                  Истина);
	ПараметрыФормы.Вставить("СкрыватьКолонкуВидЦены",                    Истина);
	ПараметрыФормы.Вставить("СкрыватьКомандуЦеныНоменклатуры",           Истина);
	ПараметрыФормы.Вставить("Заголовок",                                 НСтр("ru = 'Подбор товаров';
																				|en = 'Pick goods'"));
	ПараметрыФормы.Вставить("Дата",                                      Объект.НачатьНеРанее);
	ПараметрыФормы.Вставить("Документ",                                  Объект.Ссылка);
	ПараметрыФормы.Вставить("ПараметрыУказанияСерий",                    ПараметрыУказанияСерий);
	ПараметрыФормы.Вставить("Назначение",                                Объект.Назначение);
	ПараметрыФормы.Вставить("Подразделение",                             Объект.Подразделение);
	ПараметрыФормы.Вставить("РежимПодбораИспользоватьСкладыВТабличнойЧасти", Истина);
	ПараметрыФормы.Вставить("ПодборВариантовОбеспечения",                Истина);
	ПараметрыФормы.Вставить("ДоступныеОстаткиПараметрыДокумента",        Неопределено);
	ПараметрыФормы.Вставить("ОстаткиПоВсемСкладам",                      Истина);
	
	ОткрытьФорму("Обработка.ПодборТоваровВДокументПродажи.Форма", ПараметрыФормы, ЭтаФорма, УникальныйИдентификатор);
	
КонецПроцедуры

&НаКлиенте
Процедура СоздатьКорректировкуНазначенияРезервирование(Команда)
	
	СтруктураОбъектаОснования = ПолучитьОбъектОснования();
	
	ОбъектыОснований = Новый Массив();
	ОбъектыОснований.Добавить(СтруктураОбъектаОснования.ОбъектОснования);
	
	ОписаниеКоманды = Новый Структура();
	ОписаниеКоманды.Вставить("ОбъектыОснований", ОбъектыОснований);
	ОписаниеКоманды.Вставить("Форма", ЭтаФорма);
	
	Если Объект.СтатусЗаказаНаПроизводство = ПредопределенноеЗначение("Перечисление.СтатусыЗаказовНаПроизводство.Создан") Тогда
		МинимальныйСтатус = ПредопределенноеЗначение("Перечисление.СтатусыЗаказовНаПроизводство.КПроизводству");
		ОбеспечениеКлиент.СообщитьОНеобходимомМинимальномСтатусеДокумента(Истина, Строка(МинимальныйСтатус));
	ИначеЕсли ЭтаФорма.ВладелецФормы.Модифицированность
		Или Модифицированность
		Или Не СтруктураОбъектаОснования.Проведен 
		Тогда
		ПоказатьПредупреждение(, НСтр("ru = 'Для резервирования под назначение необходимо предварительно провести документ.';
										|en = 'To reserve for assignment, post the document first.'"));
	ИначеЕсли ЗначениеЗаполнено(Объект.Назначение) Тогда
		ПоказатьПредупреждение(, НСтр("ru = 'Для спецификации указано назначение. Резервирование для указанного назначения доступно
			|из соответствующего заказа, или с помощью документа ""Корректировка назначения товаров"".';
			|en = 'Assignment is specified for BOM. Reservation for the specified assignment is available
			|from the corresponding order, or using the ""Goods assignment adjustment"" document.'"));
	Иначе
		
		Если ЕстьТоварыКОбособленномуОбеспечению() Тогда
			СозданиеНаОснованииУТКлиент.ОткрытьМастерРезервирования(ОписаниеКоманды);
		Иначе
			ОбеспечениеКлиент.СообщитьОбОтсутствииТовараКОбособленномуОбеспечению();
		КонецЕсли;
		
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура СоздатьКорректировкуНазначенияСнятиеРезерва(Команда)
	
	СтруктураОбъектаОснования = ПолучитьОбъектОснования();
	
	ОбъектыОснований = Новый Массив();
	ОбъектыОснований.Добавить(СтруктураОбъектаОснования.ОбъектОснования);
	
	ОписаниеКоманды = Новый Структура();
	ОписаниеКоманды.Вставить("ОбъектыОснований", ОбъектыОснований);
	ОписаниеКоманды.Вставить("Форма", ЭтаФорма);
	
	Если Объект.СтатусЗаказаНаПроизводство = ПредопределенноеЗначение("Перечисление.СтатусыЗаказовНаПроизводство.Создан") Тогда
		МинимальныйСтатус = ПредопределенноеЗначение("Перечисление.СтатусыЗаказовНаПроизводство.КПроизводству");
		ОбеспечениеКлиент.СообщитьОНеобходимомМинимальномСтатусеДокумента(Ложь, Строка(МинимальныйСтатус));
	ИначеЕсли ЭтаФорма.ВладелецФормы.Модифицированность
		Или Модифицированность
		Или Не СтруктураОбъектаОснования.Проведен 
		Тогда
		ПоказатьПредупреждение(, НСтр("ru = 'Для снятия резерва под назначение необходимо предварительно провести документ.';
										|en = 'To unreserve inventory, please post the document.'"));
	ИначеЕсли ЗначениеЗаполнено(Объект.Назначение) Тогда
		ПоказатьПредупреждение(, НСтр("ru = 'Для спецификации указано назначение. Снятие резерва для указанного назначения доступно
			|из соответствующего заказа, или с помощью документа ""Корректировка назначения товаров"".';
			|en = 'Assignment is specified for BOM. You can remove reserve for the specified assignment
			|from the corresponding order, or using the ""Goods assignment adjustment"" document.'"));
	Иначе
		
		Если ЕстьТоварыКСнятиюРезерва() Тогда
			СозданиеНаОснованииУТКлиент.ОткрытьМастерСнятияРезерва(ОписаниеКоманды);
		Иначе
			ОбеспечениеКлиент.СообщитьОбОтсутствииТовараКСнятиюРезерва();
		КонецЕсли;
		
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Функция ЕстьТоварыКОбособленномуОбеспечению()
	
	НазначениеДокумента = Документы.КорректировкаНазначенияТоваров.НазначениеЗаказа(Объект.Ссылка);
	Возврат Документы.КорректировкаНазначенияТоваров.ЕстьТоварыКОбособленномуОбеспечению(НазначениеДокумента);
	
КонецФункции

&НаСервере
Функция ЕстьТоварыКСнятиюРезерва()
	
	НазначениеДокумента = Документы.КорректировкаНазначенияТоваров.НазначениеЗаказа(Объект.Ссылка);
	Возврат Документы.КорректировкаНазначенияТоваров.ЕстьТоварыКСнятиюРезерва(НазначениеДокумента);
	
КонецФункции

&НаКлиенте
Процедура ЗапретитьРедактирование(Команда)
	
	Если Объект.ИзмененияЗапрещены Тогда
		Возврат;
	КонецЕсли;
	
	ОчиститьСообщения();
	ЕстьОшибкиЗаполнения = Не ПроверитьЗаполнение();
	ОбновитьСостояниеСпецификацииЗаказа(ЭтаФорма);
	
	Если ЕстьОшибкиЗаполнения Или ЕстьУточненияМатериалов Тогда
		Возврат;
	КонецЕсли;
	
	ТекстПредупреждения = НСтр("ru = 'Запретить редактирование спецификации заказа?';
								|en = 'Prohibit editing the order BOM?'");
	
	КодВозврата = Неопределено;

	
	ПоказатьВопрос(Новый ОписаниеОповещения("ЗапретитьРедактированиеЗавершение", ЭтотОбъект), ТекстПредупреждения, РежимДиалогаВопрос.ДаНет);
	
КонецПроцедуры

&НаКлиенте
Процедура ЗапретитьРедактированиеЗавершение(РезультатВопроса, ДополнительныеПараметры) Экспорт
	
	КодВозврата = РезультатВопроса;
	
	Если КодВозврата = КодВозвратаДиалога.Да  Тогда
		
		ТолькоПросмотр = Истина;
		
		Объект.ИзмененияЗапрещены = Истина;
		Элементы.ФормаЗавершитьРедактирование.Доступность = Истина;
		
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура РазрешитьРедактирование(Команда)
	
	Если Не Объект.ИзмененияЗапрещены Тогда
		Возврат;
	КонецЕсли;
	
	ТекстПредупреждения = НСтр("ru = 'Разрешить редактирование спецификации заказа?';
								|en = 'Allow editing order BOM?'");
	
	КодВозврата = Неопределено;
	
	ПоказатьВопрос(Новый ОписаниеОповещения("РазрешитьРедактированиеЗавершение", ЭтотОбъект), ТекстПредупреждения, РежимДиалогаВопрос.ДаНет);
	
КонецПроцедуры

&НаКлиенте
Процедура РазрешитьРедактированиеЗавершение(РезультатВопроса, ДополнительныеПараметры) Экспорт
	
	КодВозврата = РезультатВопроса;
	
	Если КодВозврата = КодВозвратаДиалога.Да Тогда
		
		ТолькоПросмотр = Ложь;
		
		УправлениеФормой("НастроитьДоступностьЭлементов");
		
		Объект.ИзмененияЗапрещены = Ложь;
		Элементы.ФормаЗавершитьРедактирование.Доступность = Истина;
		
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура КомандаСоздатьСпецификациюНаОснованииСпецификацииЗаказа(Команда)
	
	ОписаниеОповещения = Новый ОписаниеОповещения("СоздатьСпецификациюНаОснованииСпецификацииЗаказаЗавершение", ЭтотОбъект);
	
	УправлениеДаннымиОбИзделияхКлиент.СоздатьСпецификациюНаОснованииСпецификацииЗаказа(Объект, ОписаниеОповещения);
	
КонецПроцедуры

&НаКлиенте
Процедура ВключитьОбособленноеОбеспечение(Команда)
	
	ОбеспечениеУстановитьДействие("ФЛАГ_ОБОСОБЛЕННО");
	
КонецПроцедуры

&НаКлиенте
Процедура ВыключитьОбособленноеОбеспечение(Команда)
	
	ОбеспечениеУстановитьДействие("ФЛАГ_НЕОБОСОБЛЕННО");
	
КонецПроцедуры

&НаКлиенте
Процедура КОбеспечению(Команда)
	
	ОбеспечениеУстановитьДействиеСВопросом("ДЕЙСТВИЕ_КОБЕСПЕЧЕНИЮ");
	
КонецПроцедуры

&НаКлиенте
Процедура РезервироватьПоМереПоступления(Команда)
	
	ОбеспечениеУстановитьДействие("ДЕЙСТВИЕ_РЕЗЕРВИРОВАТЬПОМЕРЕПОСТУПЛЕНИЯ");
	
КонецПроцедуры

&НаКлиенте
Процедура НеОбеспечивать(Команда)
	
	ОбеспечениеУстановитьДействиеСВопросом("ДЕЙСТВИЕ_НЕОБЕСПЕЧИВАТЬ");
	
КонецПроцедуры

&НаКлиенте
Процедура Отгрузить(Команда)
	
	ОбеспечениеУстановитьДействиеСВопросом("ДЕЙСТВИЕ_ОТГРУЗИТЬ");
	
КонецПроцедуры

&НаКлиенте
Процедура Резервировать(Команда)
	
	ОбеспечениеУстановитьДействиеСВопросом("ДЕЙСТВИЕ_РЕЗЕРВИРОВАТЬ");
	
КонецПроцедуры

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

&НаСервере
Процедура СкладПриИзмененииНаСервере()
	
	СтруктураОтбора = Новый Структура("НаправлениеВыпуска, Склад",
		Перечисления.ХозяйственныеОперации.ВыпускПродукцииНаСклад, СохраненноеЗначениеСклад);
	
	СтрокиВыходныеИзделия = Объект.ВыходныеИзделия.НайтиСтроки(СтруктураОтбора);
	СтрокиОходы           = Объект.ВозвратныеОтходы.НайтиСтроки(СтруктураОтбора);
	
	СохраненноеЗначениеСклад = Объект.Склад;
	
	Если СтрокиВыходныеИзделия.Количество() = 0 И СтрокиОходы.Количество() = 0 Тогда
		Возврат;
	КонецЕсли;
	
	Для каждого Строка Из СтрокиВыходныеИзделия Цикл
		Строка.Склад = Объект.Склад;
		Строка.Получатель = Объект.Склад;
	КонецЦикла;
	
	Для каждого Строка Из СтрокиОходы Цикл
		Строка.Склад = Объект.Склад;
		Строка.Получатель = Объект.Склад;
	КонецЦикла;
	
	СтатусГрафикаПроизводства = ПредопределенноеЗначение("Перечисление.СтатусыГрафикаПроизводстваВЗаказеНаПроизводство.ТребуетсяРассчитать");
	
КонецПроцедуры

&НаСервере
Процедура ПодразделениеПриИзмененииНаСервере()
	
	ОбновитьКолонкуДоступноСервер();
	
КонецПроцедуры

&НаСервере
Процедура НазначениеПриИзмененииНаСервере()
	
	ДанныеПродукцииСохраненныеЗначения = ОбщегоНазначенияКлиентСервер.СкопироватьСтруктуру(ДанныеПродукции);
	
	ЗаполнитьДанныеПродукцииНаСервере();
	
	ЗаполнитьНазначениеВТЧВыходныеИзделияНаСервере(ДанныеПродукцииСохраненныеЗначения);
	ЗаполнитьНазначениеВТЧМатериалыИУслугиНаСервере(ДанныеПродукцииСохраненныеЗначения);
	
	//++ НЕ УТКА
	Если ПравоЧтенияАналогов И ПоказатьАналоги Тогда
		ОтметитьНаличиеАналогов();
	КонецЕсли;
	//-- НЕ УТКА
	ОбеспечениеВДокументахСервер.ПриИзмененииРеквизитаДокумента(ЭтотОбъект);
	
КонецПроцедуры

&НаКлиенте
Процедура ЗаполнитьДатуПотребностиЗавершение(ВыбраннаяДата, ДополнительныеПараметры) Экспорт
	
	Если ВыбраннаяДата <> Неопределено И ЗначениеЗаполнено(ВыбраннаяДата) Тогда
		
		ДатаПотребности = ВыбраннаяДата;
		ВыбранныеСтроки = ДополнительныеПараметры.ВыбранныеСтроки;
		
		ЗаполнитьДатуПотребностиСервер(ДатаПотребности, ВыбранныеСтроки);
		ПродажиКлиент.ОповеститьОбОкончанииЗаполненияДатОтгрузки(ВыбранныеСтроки, Истина);
		
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Процедура ЗаполнитьДатуПотребностиСервер(ДатаПотребности, ВыбранныеСтроки)
	
	ОбеспечениеВДокументахСервер.ЗаполнитьРеквизитВКоллекции(Объект.МатериалыИУслуги,
		"ДатаПотребности", ДатаПотребности, ВыбранныеСтроки);
	
КонецПроцедуры

&НаСервере
Процедура ЗаполнитьРеквизитыПоПараметрамФормы()
	
	АдресДвиженийЗаказа = Параметры.АдресДвиженийЗаказа;
	
	СтруктураДанных = ПолучитьИзВременногоХранилища(Параметры.АдресСпецификация);
	
	Если Параметры.Свойство("Модифицированность") Тогда
		Модифицированность = Параметры.Модифицированность;
	КонецЕсли;
	
	ТолькоПросмотр = СтруктураДанных.СтруктураПродукции.ИзмененияЗапрещены И НЕ Модифицированность;
	
	ЗаполнитьЗначенияСвойств(ЭтаФорма, СтруктураДанных.СтруктураПродукции, "ЕстьОшибкиЗаполнения, СтатусГрафикаПроизводства, СтатусЗаказаНаПроизводство");
	ЗаполнитьЗначенияСвойств(Объект, СтруктураДанных.СтруктураПродукции);
	
	Если ЗначениеЗаполнено(Объект.Назначение) Тогда
		ЗаказНазначения = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(Объект.Назначение, "Заказ");
	КонецЕсли; 
	
	СтруктураОтбора = Новый Структура;
	
	// Этапы
	Объект.Этапы.Загрузить(СтруктураДанных.Этапы);
	
	// Выходные изделия
	Объект.ВыходныеИзделия.Загрузить(СтруктураДанных.ВыходныеИзделия);
	
	// Возвратные отходы
	Объект.ВозвратныеОтходы.Загрузить(СтруктураДанных.ВозвратныеОтходы);
	
	// Материалы и услуги
	Объект.МатериалыИУслуги.Загрузить(СтруктураДанных.МатериалыИУслуги);
	
	ПроверитьНаличиеУточненийНоменклатурыТабличнойЧасти("МатериалыИУслуги", "ЕстьУточненияМатериалов");
	ПроверитьНаличиеУточненийНоменклатурыТабличнойЧасти("ВозвратныеОтходы", "ЕстьУточненияПобочныхИзделий");
	
	// Трудозатраты
	Объект.Трудозатраты.Загрузить(СтруктураДанных.Трудозатраты);
	Для каждого Строка Из Объект.Трудозатраты Цикл
		
		СтруктураОтбора.Вставить("КлючСвязи", Строка.КлючСвязиЭтапы);
		
		НайденныеСтроки = Объект.Этапы.НайтиСтроки(СтруктураОтбора);
		
		Если НайденныеСтроки.Количество() > 0 Тогда
			Строка.Этап = НайденныеСтроки[0].Этап;
		КонецЕсли;
		
	КонецЦикла;
	
	Объект.ВидыРабочихЦентров.Загрузить(СтруктураДанных.ВидыРабочихЦентров);
	Объект.АльтернативныеВидыРабочихЦентров.Загрузить(СтруктураДанных.АльтернативныеВидыРабочихЦентров);
	Объект.ЭтапыВосстановленияБрака.Загрузить(СтруктураДанных.ЭтапыВосстановленияБрака);
	
	// Данные о ходе выполнения этапов
	ПолучитьДанныеОХодеВыполненияЭтапов();
	
	// Параметры редактирования материалов
	Если ЗаписыватьРезультатРедактирования
		И Параметры.Свойство("ПараметрыРедактированияМатериалов")
		И Параметры.ПараметрыРедактированияМатериалов.ИспользоватьКорректировки Тогда 
		
		ПараметрыРедактированияМатериалов = Обработки.ВводКорректировкиЗаказаМатериалов.ПараметрыРедактированияМатериалов(УникальныйИдентификатор);
		
		КорректировкиЗаказаМатериалов = Обработки.ВводКорректировкиЗаказаМатериалов.ПолучитьРезультатКорректировкиСпецификацииЗаказаИзХранилища(
			Параметры.ПараметрыРедактированияМатериалов, 
			Объект.КлючСвязи);
			
		Обработки.ВводКорректировкиЗаказаМатериалов.ПоместитьРезультатКорректировкиСпецификацииЗаказаВХранилище(
			Объект.КлючСвязи, 
			ПараметрыРедактированияМатериалов, 
			КорректировкиЗаказаМатериалов);
			
	ИначеЕсли Не Параметры.Свойство("ПараметрыРедактированияМатериалов", ПараметрыРедактированияМатериалов) Тогда
		
		ПараметрыРедактированияМатериалов = Обработки.ВводКорректировкиЗаказаМатериалов.ПараметрыРедактированияМатериалов(УникальныйИдентификатор);
		
	КонецЕсли;
	
	ИспользуютсяКорректировкиЗаказаМатериалов = Обработки.ВводКорректировкиЗаказаМатериалов.ИспользуютсяКорректировки(Объект);
	
	//++ Устарело_Переработка24
	
	// Дополнительные реквизиты продукции
	Если Не Объект.ПроизводствоПоЗаказу И ЗначениеЗаполнено(Объект.Назначение) Тогда
		
		МассивНазначений = ОбщегоНазначенияКлиентСервер.ЗначениеВМассиве(Объект.Назначение);
		СвойстваНазначений = Справочники.Назначения.СвойстваНазначений(МассивНазначений);
		СвойстваНазначения = СвойстваНазначений.Получить(Объект.Назначение);
		Объект.ПроизводствоПоЗаказу =
			СвойстваНазначения <> Неопределено
			И СвойстваНазначения.ЭтоНазначениеДавальца;
		
	КонецЕсли;
	//-- Устарело_Переработка24
	
	ЗаполнитьДанныеПродукцииНаСервере();
	
	// Параметры производственного процесса
	ЗаполнитьПараметрыПроизводственногоПроцессаНаСервере();
	
	// Служебные реквизиты
	ЗаполнитьСлужебныеРеквизиты();
	
	ВсегоИзделий = Объект.ВыходныеИзделия.Количество() + Объект.ВозвратныеОтходы.Количество();
	
КонецПроцедуры

&НаСервере
Функция ДанныеСпецификацииВХранилище()
	
	ДанныеЗаказа = Новый Структура;
	
	ДанныеЗаказа.Вставить("Этапы",            Объект.Этапы.Выгрузить());
	ДанныеЗаказа.Вставить("ВыходныеИзделия",  Объект.ВыходныеИзделия.Выгрузить());
	ДанныеЗаказа.Вставить("ВозвратныеОтходы", Объект.ВозвратныеОтходы.Выгрузить());
	ДанныеЗаказа.Вставить("МатериалыИУслуги", Объект.МатериалыИУслуги.Выгрузить());
	ДанныеЗаказа.Вставить("Трудозатраты",     Объект.Трудозатраты.Выгрузить());
	
	Возврат ПоместитьВоВременноеХранилище(ДанныеЗаказа, УникальныйИдентификатор);
	
КонецФункции

&НаСервере
Функция ДанныеЭтапаВХранилище(КлючСвязи)
	
	ДанныеЭтапа = Объект.Этапы.НайтиСтроки(Новый Структура("КлючСвязи", КлючСвязи))[0];
	
	СвойстваЭтапа = Новый Структура;
	
	СвойстваЭтапа.Вставить("Владелец", ОбщегоНазначения.ЗначениеРеквизитаОбъекта(ДанныеЭтапа.Этап, "Владелец"));
	СвойстваЭтапа.Вставить("Ссылка",   ОбщегоНазначения.ЗначениеРеквизитаОбъекта(ДанныеЭтапа.Этап, "Ссылка"));
	
	СвойстваЭтапа.Вставить("Подразделение",                          ДанныеЭтапа.Подразделение);
	СвойстваЭтапа.Вставить("НомерЭтапа",                             ДанныеЭтапа.НомерЭтапа);
	СвойстваЭтапа.Вставить("НомерСледующегоЭтапа",                   ДанныеЭтапа.НомерСледующегоЭтапа);
	СвойстваЭтапа.Вставить("МаршрутнаяКарта",                        ДанныеЭтапа.МаршрутнаяКарта);
	СвойстваЭтапа.Вставить("ПланироватьРаботуВидовРабочихЦентров",   ДанныеЭтапа.ПланироватьРаботуВидовРабочихЦентров);
	СвойстваЭтапа.Вставить("Описание",                               ДанныеЭтапа.Описание);
	СвойстваЭтапа.Вставить("ДлительностьЭтапа",                      ДанныеЭтапа.ДлительностьЭтапа);
	СвойстваЭтапа.Вставить("ЕдиницаИзмеренияДлительностиЭтапа",      ДанныеЭтапа.ЕдиницаИзмеренияДлительностиЭтапа);
	СвойстваЭтапа.Вставить("ПредварительныйБуфер",                   ДанныеЭтапа.ПредварительныйБуфер);
	СвойстваЭтапа.Вставить("ЗавершающийБуфер",                       ДанныеЭтапа.ЗавершающийБуфер);
	СвойстваЭтапа.Вставить("ЕдиницаИзмеренияПредварительногоБуфера", ДанныеЭтапа.ЕдиницаИзмеренияПредварительногоБуфера);
	СвойстваЭтапа.Вставить("ЕдиницаИзмеренияЗавершающегоБуфера",     ДанныеЭтапа.ЕдиницаИзмеренияЗавершающегоБуфера);
	СвойстваЭтапа.Вставить("Наименование",                           ДанныеЭтапа.НаименованиеЭтапа);
	СвойстваЭтапа.Вставить("Непрерывный",                            ДанныеЭтапа.Непрерывный);
	СвойстваЭтапа.Вставить("ПроизводствоНаСтороне",                  ДанныеЭтапа.ПроизводствоНаСтороне);
	СвойстваЭтапа.Вставить("Партнер",                                ДанныеЭтапа.Партнер);
	СвойстваЭтапа.Вставить("ГрафикРаботыПартнера",                   ДанныеЭтапа.ГрафикРаботыПартнера);
	СвойстваЭтапа.Вставить("УслугаПереработчика",                    ДанныеЭтапа.УслугаПереработчика);
	СвойстваЭтапа.Вставить("ХарактеристикаУслугиПереработчика",      ДанныеЭтапа.ХарактеристикаУслугиПереработчика);
	СвойстваЭтапа.Вставить("СтатьяКалькуляции",                      ДанныеЭтапа.СтатьяКалькуляции);
	СвойстваЭтапа.Вставить("ОдновременноПроизводимоеКоличествоЕдиницПартийИзделий", ДанныеЭтапа.ОдновременноПроизводимоеКоличествоЕдиницПартийИзделий);
	
	СвойстваЭтапа.Вставить("НомерЭтапаФорма",           ДанныеЭтапа.НомерЭтапаФорма);
	СвойстваЭтапа.Вставить("НомерСледующегоЭтапаФорма", ДанныеЭтапа.НомерСледующегоЭтапаФорма);
	
	СтруктураОтбора = Новый Структура("КлючСвязиЭтапы", КлючСвязи);
	
	СвойстваЭтапа.Вставить("ВидыРабочихЦентров", Объект.ВидыРабочихЦентров.Выгрузить(СтруктураОтбора));
	
	АльтернативныеВидыРабочихЦентров = Новый ТаблицаЗначений;
	
	Для каждого Строка Из СвойстваЭтапа.ВидыРабочихЦентров Цикл
		
		СтруктураОтбора.Очистить();
		СтруктураОтбора.Вставить("КлючСвязиВидыРабочихЦентров", Строка.КлючСвязи);
		
		Если АльтернативныеВидыРабочихЦентров.Количество() = 0 Тогда
			АльтернативныеВидыРабочихЦентров = Объект.АльтернативныеВидыРабочихЦентров.Выгрузить(СтруктураОтбора);
		Иначе
			НайденныеСтроки = Объект.АльтернативныеВидыРабочихЦентров.НайтиСтроки(СтруктураОтбора);
			
			Для каждого СтрокаАльтернативныеВидыРабочихЦентров Из НайденныеСтроки Цикл
				ЗаполнитьЗначенияСвойств(АльтернативныеВидыРабочихЦентров.Добавить(), СтрокаАльтернативныеВидыРабочихЦентров);
			КонецЦикла;
			
		КонецЕсли;
		
	КонецЦикла;
	
	СвойстваЭтапа.Вставить("АльтернативныеВидыРабочихЦентров", АльтернативныеВидыРабочихЦентров);
	
	МассивКодовСтрок = Новый Массив;
	
	Для каждого НайденнаяСтрока Из Объект.МатериалыИУслуги.НайтиСтроки(Новый Структура("КлючСвязиЭтапы", КлючСвязи)) Цикл
		
		Если НайденнаяСтрока.КодСтроки <> 0 Тогда
			
			МассивКодовСтрок.Добавить(НайденнаяСтрока.КодСтроки);
			
		КонецЕсли;
		
	КонецЦикла;
	
	ЕстьКорректировкиМатериалов = Ложь;
	
	Если МассивКодовСтрок.Количество() > 0 Тогда
		
		Запрос = Новый Запрос;
		Запрос.УстановитьПараметр("Распоряжение", Объект.Ссылка);
		Запрос.УстановитьПараметр("МассивКодовСтрок", МассивКодовСтрок);
		Запрос.Текст = 
		"ВЫБРАТЬ ПЕРВЫЕ 1 1
		|ИЗ
		|	РегистрНакопления.ЗаказыМатериаловСУчетомКорректировок КАК Т
		|ГДЕ
		|	Т.Распоряжение = &Распоряжение
		|	И Т.КодСтрокиРаспоряжения В (&МассивКодовСтрок)
		|	И Т.Регистратор ССЫЛКА Документ.КорректировкаЗаказаМатериаловВПроизводство";
		
		ЕстьКорректировкиМатериалов = НЕ Запрос.Выполнить().Пустой();
				
	КонецЕсли;
	
	СвойстваЭтапа.Вставить("Выполняется", ДанныеЭтапа.ВыполненоЗапланировано > 0);
	СвойстваЭтапа.Вставить("ЕстьКорректировкиМатериалов", ЕстьКорректировкиМатериалов);
	
	Возврат ПоместитьВоВременноеХранилище(СвойстваЭтапа, УникальныйИдентификатор);
	
КонецФункции

&НаСервере
Функция РезультатРедактированияВХранилище()
	
	СтруктураДанных = Новый Структура;
	
	СтруктураПродукции = Новый Структура;
	
	СтруктураПродукции.Вставить("НомерСтроки",                               Объект.НомерСтроки);
	СтруктураПродукции.Вставить("Номенклатура",                              Объект.Номенклатура);
	СтруктураПродукции.Вставить("Характеристика",                            Объект.Характеристика);
	СтруктураПродукции.Вставить("Упаковка",                                  Объект.Упаковка);
	СтруктураПродукции.Вставить("КоличествоУпаковок",                        Объект.КоличествоУпаковок);
	СтруктураПродукции.Вставить("Количество",                                Объект.Количество);
	СтруктураПродукции.Вставить("Спецификация",                              Объект.Спецификация);
	СтруктураПродукции.Вставить("ДатаПотребности",                           Объект.ДатаПотребности);
	СтруктураПродукции.Вставить("НачатьНеРанее",                             Объект.НачатьНеРанее);
	СтруктураПродукции.Вставить("РазмещениеВыпуска",                         Объект.РазмещениеВыпуска);
	СтруктураПродукции.Вставить("Склад",                                     Объект.Склад);
	СтруктураПродукции.Вставить("Подразделение",                             Объект.Подразделение);
	СтруктураПродукции.Вставить("Назначение",                                Объект.Назначение);
	СтруктураПродукции.Вставить("ИзмененияЗапрещены",                        Объект.ИзмененияЗапрещены);
	СтруктураПродукции.Вставить("КодСтроки",                                 Объект.КодСтроки);
	СтруктураПродукции.Вставить("КлючСвязи",                                 Объект.КлючСвязи);
	СтруктураПродукции.Вставить("КлючСвязиМатериалыИУслуги",                 Объект.КлючСвязиМатериалыИУслуги);
	СтруктураПродукции.Вставить("КлючСвязиПродукция",                        Объект.КлючСвязиПродукция);
	СтруктураПродукции.Вставить("ЕстьСоответствиеСтандартнойСпецификации",   Объект.ЕстьСоответствиеСтандартнойСпецификации);
	СтруктураПродукции.Вставить("ЕстьУточненияМатериалов",                   ЕстьУточненияМатериалов);
	СтруктураПродукции.Вставить("ЕстьУточненияПобочныхИзделий",              ЕстьУточненияПобочныхИзделий);
	СтруктураПродукции.Вставить("ЕстьОшибкиЗаполнения",                      ЕстьОшибкиЗаполнения);
	СтруктураПродукции.Вставить("ОптимальноеКоличествоПередачиМеждуЭтапами", Объект.ОптимальноеКоличествоПередачиМеждуЭтапами);
	
	СтруктураДанных.Вставить("СтруктураПродукции",               СтруктураПродукции);
	СтруктураДанных.Вставить("Этапы",                            Объект.Этапы.Выгрузить());
	
	СтруктураДанных.Вставить("ВыходныеИзделия",                  Объект.ВыходныеИзделия.Выгрузить());
	СтруктураДанных.Вставить("ВозвратныеОтходы",                 Объект.ВозвратныеОтходы.Выгрузить());
	СтруктураДанных.Вставить("МатериалыИУслуги",                 Объект.МатериалыИУслуги.Выгрузить());
	СтруктураДанных.Вставить("Трудозатраты",                     Объект.Трудозатраты.Выгрузить());
	СтруктураДанных.Вставить("ВидыРабочихЦентров",               Объект.ВидыРабочихЦентров.Выгрузить());
	СтруктураДанных.Вставить("АльтернативныеВидыРабочихЦентров", Объект.АльтернативныеВидыРабочихЦентров.Выгрузить());
	СтруктураДанных.Вставить("ЭтапыВосстановленияБрака",         Объект.ЭтапыВосстановленияБрака.Выгрузить());
	
	Возврат ПоместитьВоВременноеХранилище(СтруктураДанных, УникальныйИдентификатор);
	
КонецФункции

&НаСервере
Процедура УстановитьЗаголовокФормыНаСервере()
	
	ТекстЗаголовка = НСтр("ru = 'Спецификация заказа (строка %1: %2)';
							|en = 'Order BOM (line %1: %2)'");
	
	ЭтаФорма.Заголовок = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
		ТекстЗаголовка, Объект.НомерСтроки, Объект.Номенклатура);

КонецПроцедуры

&НаКлиенте
Процедура УстановитьЗаголовокКолонкиКоличествоНаЕдиницуПродукции()
	
	Если Элементы.Упаковка.Видимость Тогда
		
		ТекстЗаголовка = ТекстЗаголовкаКолонкиКоличествоНаЕдиницуПродукции(Объект.Номенклатура, Объект.Упаковка);
		
	Иначе
		
		ТекстЗаголовка = ТекстЗаголовкаКолонкиКоличествоНаЕдиницуПродукции(Объект.Номенклатура);
		
	КонецЕсли;
	
	Элементы.МатериалыИУслугиКоличествоНаЕдиницуИзделия.Заголовок = ТекстЗаголовка;
	
КонецПроцедуры

&НаСервере
Процедура УстановитьЗаголовокКолонкиКоличествоНаЕдиницуПродукцииНаСервере()
	
	Если Элементы.Упаковка.Видимость Тогда
		
		ТекстЗаголовка = ТекстЗаголовкаКолонкиКоличествоНаЕдиницуПродукции(Объект.Номенклатура, Объект.Упаковка);
		
	Иначе
		
		ТекстЗаголовка = ТекстЗаголовкаКолонкиКоличествоНаЕдиницуПродукции(Объект.Номенклатура);
		
	КонецЕсли;
	
	Элементы.МатериалыИУслугиКоличествоНаЕдиницуИзделия.Заголовок = ТекстЗаголовка;
	
КонецПроцедуры

&НаКлиенте
Процедура ВыборЭтапаПроизводства(СтандартнаяОбработка)
	
	СтандартнаяОбработка = Ложь;
	
	ТекущиеДанные = ТекущийЭлемент.ТекущиеДанные;
	
	Если ТекущиеДанные = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	ПараметрыФормы = Новый Структура("Этапы", Объект.Этапы);
	ПараметрыФормы.Вставить("ТекущийЭтап", ТекущиеДанные.КлючСвязиЭтапы);
	
	ОткрытьФорму("Обработка.РедактированиеСпецификацииСтрокиЗаказа.Форма.ФормаВыбораЭтапаПроизводства", ПараметрыФормы, ЭтаФорма);
	
КонецПроцедуры

&НаКлиенте
Процедура ЗавершитьРедактирование()
	
	ОчиститьСообщения();
	ЕстьОшибкиЗаполнения = Не ПроверитьЗаполнение();
	
	ОбновитьСостояниеСпецификацииЗаказа(ЭтаФорма);
	
	// Возврат результата редактирования в форму документа.
	Если Не ЗаписыватьРезультатРедактирования Тогда
		
		Если ЕстьОшибкиЗаполнения ИЛИ ЕстьУточненияМатериалов ИЛИ ЕстьУточненияПобочныхИзделий Тогда
			ПоказатьПредупреждение(Неопределено, НСтр("ru = 'Обнаружены ошибки заполнения, завершение редактирования невозможно.';
														|en = 'Population errors are detected. Unable to complete the editing.   '"));
			Возврат;
		КонецЕсли;
		
		РезультатРедактирования = РезультатРедактированияВХранилище();
		
		Модифицированность = Ложь;
		ОповеститьОВыборе(Новый Структура("ВыполняемаяОперация, АдресВХранилище", "СпецификацияСтрокиЗаказа", РезультатРедактирования));
		
	Иначе
		// Запись результата редактирования.
		
		Если Модифицированность Тогда
			
			Если ЕстьОшибкиЗаполнения ИЛИ ЕстьУточненияМатериалов ИЛИ ЕстьУточненияПобочныхИзделий Тогда
				ПоказатьПредупреждение(Неопределено, НСтр("ru = 'Обнаружены ошибки заполнения, завершение редактирования невозможно.';
															|en = 'Population errors are detected. Unable to complete the editing.   '"));
				Возврат;
			КонецЕсли;
			
			ЗаписатьДокументНаСервере();
			
			ПараметрыОповещения = Новый Структура;
			ПараметрыОповещения.Вставить("РежимЗаписи", РежимЗаписиДокумента.Проведение);
			
			Оповестить("Запись_ЗаказНаПроизводство", ПараметрыОповещения, Объект.Ссылка);
			Модифицированность = Ложь;
			
		КонецЕсли;
		
		Закрыть();
		
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Процедура УправлениеФормой(Действие = "")
	
	ВсеДействия = ПустаяСтрока(Действие);
	//++ НЕ УТКА
	СтруктураДействий = Новый Структура(Действие);
	 //-- НЕ УТКА
	
	Если ВсеДействия Тогда
		
		УстановитьЗаголовокФормыНаСервере();
		
		УстановитьЗаголовокКолонкиКоличествоНаЕдиницуПродукцииНаСервере();
		
		ПравоИзменения = ПравоДоступа("Изменение", Метаданные.Документы.ЗаказНаПроизводство);
		
		ТолькоПросмотр = ТолькоПросмотр Или Не ПравоИзменения;
		
		Элементы.ФормаЗавершитьРедактирование.Доступность = Не ТолькоПросмотр;
		Элементы.ФормаЗапретитьРедактирование.Доступность = ПравоИзменения;
		Элементы.ФормаРазрешитьРедактирование.Доступность = ПравоИзменения;
		
		Элементы.Номенклатура.ТолькоПросмотр       = Выполняется;
		Элементы.Характеристика.ТолькоПросмотр     = Выполняется;
		Элементы.Спецификация.ТолькоПросмотр       = Выполняется;
		Элементы.Упаковка.ТолькоПросмотр           = Выполняется;
		Элементы.КоличествоУпаковок.ТолькоПросмотр = Выполняется;
		
		Элементы.ФормаЗаполнитьПоСпецификации.Видимость = Не Выполняется;
		
		Элементы.Назначение.Доступность = НЕ (Объект.ПроизводствоПоЗаказу И ТипЗнч(Объект.Заказ) = Тип("ДокументСсылка.ЗаказДавальца"));
		
		#Область Материалы
		
		Элементы.МатериалыИУслугиВариантОбеспечения.ТолькоПросмотр = ИспользуютсяКорректировкиЗаказаМатериалов;
		Элементы.МатериалыИУслугиОбособленно.ТолькоПросмотр = ИспользуютсяКорректировкиЗаказаМатериалов;
		Элементы.МатериалыИУслугиОтгрузить.Видимость = Не ИспользуютсяКорректировкиЗаказаМатериалов;
		Элементы.МатериалыИУслугиРезервировать.Видимость = Не ИспользуютсяКорректировкиЗаказаМатериалов;
		Элементы.МатериалыИУслугиРезервироватьПоМереПоступления.Видимость = Не ИспользуютсяКорректировкиЗаказаМатериалов;
		Элементы.МатериалыИУслугиКОбеспечению.Видимость = Не ИспользуютсяКорректировкиЗаказаМатериалов;
		Элементы.МатериалыИУслугиНеОбеспечивать.Видимость = Не ИспользуютсяКорректировкиЗаказаМатериалов;
		Элементы.МатериалыИУслугиВключитьОбособленноеОбеспечение.Видимость = Не ИспользуютсяКорректировкиЗаказаМатериалов;
		Элементы.МатериалыИУслугиВыключитьОбособленноеОбеспечение.Видимость = Не ИспользуютсяКорректировкиЗаказаМатериалов;
		Элементы.МатериалыИУслугиКонтекстноеМенюОтгрузить.Видимость = Не ИспользуютсяКорректировкиЗаказаМатериалов;
		Элементы.МатериалыИУслугиКонтекстноеМенюРезервировать.Видимость = Не ИспользуютсяКорректировкиЗаказаМатериалов;
		Элементы.МатериалыИУслугиКонтекстноеМенюКОбеспечению.Видимость = Не ИспользуютсяКорректировкиЗаказаМатериалов;
		Элементы.МатериалыИУслугиКонтекстноеМенюНеОбеспечивать.Видимость = Не ИспользуютсяКорректировкиЗаказаМатериалов;
		
		Элементы.ГруппаУточнениеМатериалов.Видимость = Не Выполняется;
		
		#КонецОбласти
		
		Элементы.ГруппаУточнениеПобочныхИзделий.Видимость = НЕ Выполняется;
		
	КонецЕсли;
	
	//++ НЕ УТКА
	Если СтруктураДействий.Свойство("ПоказатьАналоги") Или ВсеДействия Тогда
		
		Если ПравоЧтенияАналогов Тогда		
			Элементы.МатериалыИУслугиПоказатьАналоги.Пометка = ПоказатьАналоги;
			Элементы.МатериалыИУслугиЕстьАналогиМатериала.Видимость = ПоказатьАналоги;
		Иначе
			Элементы.МатериалыИУслугиПоказатьАналоги.Видимость = ПравоЧтенияАналогов;
			Элементы.МатериалыИУслугиПодобратьАналоги.Видимость = ПравоЧтенияАналогов;
			Элементы.МатериалыИУслугиЕстьАналогиМатериала.Видимость = ПравоЧтенияАналогов;
		КонецЕсли;	
		
	КонецЕсли;
	//-- НЕ УТКА
	
	Если Не ПравоДоступа("Добавление", Метаданные.Документы.КорректировкаНазначенияТоваров)
		Или Не ПолучитьФункциональнуюОпцию("ИспользоватьОбособленноеОбеспечениеЗаказов") Тогда
		Элементы.ТоварыСоздатьКорректировкуНазначенияСнятиеРезерва.Видимость = Ложь;
		Элементы.ТоварыСоздатьКорректировкуНазначенияРезервирование.Видимость = Ложь;
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Процедура УстановитьУсловноеОформление()
	
	УсловноеОформление.Элементы.Очистить();

#Область ВыходныеИзделия

	// выходное изделие указанное в заказе выделяется жирным

	Элемент = УсловноеОформление.Элементы.Добавить();

	ПолеЭлемента = Элемент.Поля.Элементы.Добавить();
	ПолеЭлемента.Поле = Новый ПолеКомпоновкиДанных(Элементы.ВыходныеИзделияНомерСтроки.Имя);

	ПолеЭлемента = Элемент.Поля.Элементы.Добавить();
	ПолеЭлемента.Поле = Новый ПолеКомпоновкиДанных(Элементы.ВыходныеИзделияНоменклатура.Имя);

	ПолеЭлемента = Элемент.Поля.Элементы.Добавить();
	ПолеЭлемента.Поле = Новый ПолеКомпоновкиДанных(Элементы.ВыходныеИзделияХарактеристика.Имя);

	ПолеЭлемента = Элемент.Поля.Элементы.Добавить();
	ПолеЭлемента.Поле = Новый ПолеКомпоновкиДанных(Элементы.ВыходныеИзделияКоличествоУпаковок.Имя);

	ПолеЭлемента = Элемент.Поля.Элементы.Добавить();
	ПолеЭлемента.Поле = Новый ПолеКомпоновкиДанных(Элементы.ВыходныеИзделияУпаковка.Имя);

	ПолеЭлемента = Элемент.Поля.Элементы.Добавить();
	ПолеЭлемента.Поле = Новый ПолеКомпоновкиДанных(Элементы.ВыходныеИзделияНоменклатураЕдиницаИзмерения.Имя);

	ПолеЭлемента = Элемент.Поля.Элементы.Добавить();
	ПолеЭлемента.Поле = Новый ПолеКомпоновкиДанных(Элементы.ВыходныеИзделияЭтап.Имя);
	
	ПолеЭлемента = Элемент.Поля.Элементы.Добавить();
	ПолеЭлемента.Поле = Новый ПолеКомпоновкиДанных(Элементы.ВыходныеИзделияНаименованиеПолуфабриката.Имя);

	ПолеЭлемента = Элемент.Поля.Элементы.Добавить();
	ПолеЭлемента.Поле = Новый ПолеКомпоновкиДанных(Элементы.ВыходныеИзделияДоляСтоимости.Имя);

	ПолеЭлемента = Элемент.Поля.Элементы.Добавить();
	ПолеЭлемента.Поле = Новый ПолеКомпоновкиДанных(Элементы.ВыходныеИзделияНаправлениеВыпуска.Имя);

	ПолеЭлемента = Элемент.Поля.Элементы.Добавить();
	ПолеЭлемента.Поле = Новый ПолеКомпоновкиДанных(Элементы.ВыходныеИзделияПолучатель.Имя);

	ОтборЭлемента = Элемент.Отбор.Элементы.Добавить(Тип("ЭлементОтбораКомпоновкиДанных"));
	ОтборЭлемента.ЛевоеЗначение = Новый ПолеКомпоновкиДанных("Объект.ВыходныеИзделия.Номенклатура");
	ОтборЭлемента.ВидСравнения = ВидСравненияКомпоновкиДанных.Равно;
	ОтборЭлемента.ПравоеЗначение = Новый ПолеКомпоновкиДанных("Объект.Номенклатура");

	ОтборЭлемента = Элемент.Отбор.Элементы.Добавить(Тип("ЭлементОтбораКомпоновкиДанных"));
	ОтборЭлемента.ЛевоеЗначение = Новый ПолеКомпоновкиДанных("Объект.ВыходныеИзделия.Характеристика");
	ОтборЭлемента.ВидСравнения = ВидСравненияКомпоновкиДанных.Равно;
	ОтборЭлемента.ПравоеЗначение = Новый ПолеКомпоновкиДанных("Объект.Характеристика");
	
	Элемент.Оформление.УстановитьЗначениеПараметра("Шрифт", Новый Шрифт(WindowsШрифты.DefaultGUIFont, , , Истина, Ложь, Ложь, Ложь, ));

	// упаковки
	
	НоменклатураСервер.УстановитьУсловноеОформлениеЕдиницИзмерения(ЭтаФорма, 
																   "ВыходныеИзделияНоменклатураЕдиницаИзмерения", 
                                                                   "Объект.ВыходныеИзделия.Упаковка");
	
	// полуфабрикаты выделяются коричневым

	Элемент = УсловноеОформление.Элементы.Добавить();

	ПолеЭлемента = Элемент.Поля.Элементы.Добавить();
	ПолеЭлемента.Поле = Новый ПолеКомпоновкиДанных(Элементы.ВыходныеИзделияНомерСтроки.Имя);

	ПолеЭлемента = Элемент.Поля.Элементы.Добавить();
	ПолеЭлемента.Поле = Новый ПолеКомпоновкиДанных(Элементы.ВыходныеИзделияНоменклатура.Имя);

	ПолеЭлемента = Элемент.Поля.Элементы.Добавить();
	ПолеЭлемента.Поле = Новый ПолеКомпоновкиДанных(Элементы.ВыходныеИзделияХарактеристика.Имя);

	ПолеЭлемента = Элемент.Поля.Элементы.Добавить();
	ПолеЭлемента.Поле = Новый ПолеКомпоновкиДанных(Элементы.ВыходныеИзделияКоличествоУпаковок.Имя);

	ПолеЭлемента = Элемент.Поля.Элементы.Добавить();
	ПолеЭлемента.Поле = Новый ПолеКомпоновкиДанных(Элементы.ВыходныеИзделияУпаковка.Имя);

	ПолеЭлемента = Элемент.Поля.Элементы.Добавить();
	ПолеЭлемента.Поле = Новый ПолеКомпоновкиДанных(Элементы.ВыходныеИзделияНоменклатураЕдиницаИзмерения.Имя);

	ПолеЭлемента = Элемент.Поля.Элементы.Добавить();
	ПолеЭлемента.Поле = Новый ПолеКомпоновкиДанных(Элементы.ВыходныеИзделияЭтап.Имя);
	
	ПолеЭлемента = Элемент.Поля.Элементы.Добавить();
	ПолеЭлемента.Поле = Новый ПолеКомпоновкиДанных(Элементы.ВыходныеИзделияНаименованиеПолуфабриката.Имя);

	ПолеЭлемента = Элемент.Поля.Элементы.Добавить();
	ПолеЭлемента.Поле = Новый ПолеКомпоновкиДанных(Элементы.ВыходныеИзделияНаправлениеВыпуска.Имя);

	ПолеЭлемента = Элемент.Поля.Элементы.Добавить();
	ПолеЭлемента.Поле = Новый ПолеКомпоновкиДанных(Элементы.ВыходныеИзделияДоляСтоимости.Имя);

	ПолеЭлемента = Элемент.Поля.Элементы.Добавить();
	ПолеЭлемента.Поле = Новый ПолеКомпоновкиДанных(Элементы.ВыходныеИзделияПолучатель.Имя);

	ОтборЭлемента = Элемент.Отбор.Элементы.Добавить(Тип("ЭлементОтбораКомпоновкиДанных"));
	ОтборЭлемента.ЛевоеЗначение = Новый ПолеКомпоновкиДанных("Объект.ВыходныеИзделия.ПроизводитсяВПроцессе");
	ОтборЭлемента.ВидСравнения = ВидСравненияКомпоновкиДанных.Равно;
	ОтборЭлемента.ПравоеЗначение = Истина;

	ГруппаОтбора1 = Элемент.Отбор.Элементы.Добавить(Тип("ГруппаЭлементовОтбораКомпоновкиДанных"));
	ГруппаОтбора1.ТипГруппы = ТипГруппыЭлементовОтбораКомпоновкиДанных.NotGroup;

	ОтборЭлемента = ГруппаОтбора1.Элементы.Добавить(Тип("ЭлементОтбораКомпоновкиДанных"));
	ОтборЭлемента.ЛевоеЗначение = Новый ПолеКомпоновкиДанных("Объект.ВыходныеИзделия.Номенклатура");
	ОтборЭлемента.ВидСравнения = ВидСравненияКомпоновкиДанных.Равно;
	ОтборЭлемента.ПравоеЗначение = Новый ПолеКомпоновкиДанных("Объект.Номенклатура");

	ОтборЭлемента = ГруппаОтбора1.Элементы.Добавить(Тип("ЭлементОтбораКомпоновкиДанных"));
	ОтборЭлемента.ЛевоеЗначение = Новый ПолеКомпоновкиДанных("Объект.ВыходныеИзделия.Характеристика");
	ОтборЭлемента.ВидСравнения = ВидСравненияКомпоновкиДанных.Равно;
	ОтборЭлемента.ПравоеЗначение = Новый ПолеКомпоновкиДанных("Объект.Характеристика");

	Элемент.Оформление.УстановитьЗначениеПараметра("ЦветТекста", ЦветаСтиля.ТекстПредопределенногоЗначения);

	// характеристики

	НоменклатураСервер.УстановитьУсловноеОформлениеХарактеристикНоменклатуры(ЭтаФорма, 
																			 "ВыходныеИзделияХарактеристика",
																		     "Объект.ВыходныеИзделия.ХарактеристикиИспользуются");

	// Данные изделия, этап выпуска, направление выпуска, склад изделия, указанного в заказе менять нельзя.

	Элемент = УсловноеОформление.Элементы.Добавить();

	ПолеЭлемента = Элемент.Поля.Элементы.Добавить();
	ПолеЭлемента.Поле = Новый ПолеКомпоновкиДанных(Элементы.ВыходныеИзделияНоменклатура.Имя);

	ПолеЭлемента = Элемент.Поля.Элементы.Добавить();
	ПолеЭлемента.Поле = Новый ПолеКомпоновкиДанных(Элементы.ВыходныеИзделияХарактеристика.Имя);

	ПолеЭлемента = Элемент.Поля.Элементы.Добавить();
	ПолеЭлемента.Поле = Новый ПолеКомпоновкиДанных(Элементы.ВыходныеИзделияЭтап.Имя);

	ПолеЭлемента = Элемент.Поля.Элементы.Добавить();
	ПолеЭлемента.Поле = Новый ПолеКомпоновкиДанных(Элементы.ВыходныеИзделияНаправлениеВыпуска.Имя);

	ПолеЭлемента = Элемент.Поля.Элементы.Добавить();
	ПолеЭлемента.Поле = Новый ПолеКомпоновкиДанных(Элементы.ВыходныеИзделияПолучатель.Имя);

	ОтборЭлемента = Элемент.Отбор.Элементы.Добавить(Тип("ЭлементОтбораКомпоновкиДанных"));
	ОтборЭлемента.ЛевоеЗначение = Новый ПолеКомпоновкиДанных("Объект.Номенклатура");
	ОтборЭлемента.ВидСравнения = ВидСравненияКомпоновкиДанных.Равно;
	ОтборЭлемента.ПравоеЗначение = Новый ПолеКомпоновкиДанных("Объект.ВыходныеИзделия.Номенклатура");

	ОтборЭлемента = Элемент.Отбор.Элементы.Добавить(Тип("ЭлементОтбораКомпоновкиДанных"));
	ОтборЭлемента.ЛевоеЗначение = Новый ПолеКомпоновкиДанных("Объект.Характеристика");
	ОтборЭлемента.ВидСравнения = ВидСравненияКомпоновкиДанных.Равно;
	ОтборЭлемента.ПравоеЗначение = Новый ПолеКомпоновкиДанных("Объект.ВыходныеИзделия.Характеристика");

	Элемент.Оформление.УстановитьЗначениеПараметра("ТолькоПросмотр", Истина);

	// запрет изменения реквизитов изделия если это ПФ производимый в процессе

	Элемент = УсловноеОформление.Элементы.Добавить();

	ПолеЭлемента = Элемент.Поля.Элементы.Добавить();
	ПолеЭлемента.Поле = Новый ПолеКомпоновкиДанных(Элементы.ВыходныеИзделияНоменклатура.Имя);

	ПолеЭлемента = Элемент.Поля.Элементы.Добавить();
	ПолеЭлемента.Поле = Новый ПолеКомпоновкиДанных(Элементы.ВыходныеИзделияХарактеристика.Имя);

	ПолеЭлемента = Элемент.Поля.Элементы.Добавить();
	ПолеЭлемента.Поле = Новый ПолеКомпоновкиДанных(Элементы.ВыходныеИзделияЭтап.Имя);

	ОтборЭлемента = Элемент.Отбор.Элементы.Добавить(Тип("ЭлементОтбораКомпоновкиДанных"));
	ОтборЭлемента.ЛевоеЗначение = Новый ПолеКомпоновкиДанных("Объект.ВыходныеИзделия.ПроизводитсяВПроцессе");
	ОтборЭлемента.ВидСравнения = ВидСравненияКомпоновкиДанных.Равно;
	ОтборЭлемента.ПравоеЗначение = Истина;

	Элемент.Оформление.УстановитьЗначениеПараметра("ТолькоПросмотр", Истина);
	
	// выполненные этапы редактировать нельзя

	Элемент = УсловноеОформление.Элементы.Добавить();

	ПолеЭлемента = Элемент.Поля.Элементы.Добавить();
	ПолеЭлемента.Поле = Новый ПолеКомпоновкиДанных(Элементы.ВыходныеИзделияНомерСтроки.Имя);

	ПолеЭлемента = Элемент.Поля.Элементы.Добавить();
	ПолеЭлемента.Поле = Новый ПолеКомпоновкиДанных(Элементы.ВыходныеИзделияНоменклатура.Имя);

	ПолеЭлемента = Элемент.Поля.Элементы.Добавить();
	ПолеЭлемента.Поле = Новый ПолеКомпоновкиДанных(Элементы.ВыходныеИзделияХарактеристика.Имя);

	ПолеЭлемента = Элемент.Поля.Элементы.Добавить();
	ПолеЭлемента.Поле = Новый ПолеКомпоновкиДанных(Элементы.ВыходныеИзделияНазначение.Имя);

	ПолеЭлемента = Элемент.Поля.Элементы.Добавить();
	ПолеЭлемента.Поле = Новый ПолеКомпоновкиДанных(Элементы.ВыходныеИзделияКоличествоУпаковок.Имя);

	ПолеЭлемента = Элемент.Поля.Элементы.Добавить();
	ПолеЭлемента.Поле = Новый ПолеКомпоновкиДанных(Элементы.ВыходныеИзделияУпаковка.Имя);

	ПолеЭлемента = Элемент.Поля.Элементы.Добавить();
	ПолеЭлемента.Поле = Новый ПолеКомпоновкиДанных(Элементы.ВыходныеИзделияНоменклатураЕдиницаИзмерения.Имя);

	ПолеЭлемента = Элемент.Поля.Элементы.Добавить();
	ПолеЭлемента.Поле = Новый ПолеКомпоновкиДанных(Элементы.ВыходныеИзделияЭтап.Имя);

	ПолеЭлемента = Элемент.Поля.Элементы.Добавить();
	ПолеЭлемента.Поле = Новый ПолеКомпоновкиДанных(Элементы.ВыходныеИзделияПолучатель.Имя);

	ПолеЭлемента = Элемент.Поля.Элементы.Добавить();
	ПолеЭлемента.Поле = Новый ПолеКомпоновкиДанных(Элементы.ВыходныеИзделияДоляСтоимости.Имя);
	
	ПолеЭлемента = Элемент.Поля.Элементы.Добавить();
	ПолеЭлемента.Поле = Новый ПолеКомпоновкиДанных(Элементы.ВыходныеИзделияНаправлениеВыпуска.Имя);

	ОтборЭлемента = Элемент.Отбор.Элементы.Добавить(Тип("ЭлементОтбораКомпоновкиДанных"));
	ОтборЭлемента.ЛевоеЗначение = Новый ПолеКомпоновкиДанных("Объект.ВыходныеИзделия.ЭтапВыполнен");
	ОтборЭлемента.ВидСравнения = ВидСравненияКомпоновкиДанных.Равно;
	ОтборЭлемента.ПравоеЗначение = Истина;

	Элемент.Оформление.УстановитьЗначениеПараметра("ЦветТекста", ЦветаСтиля.ЦветТекстаОтмененнойСтрокиДокумента);
	Элемент.Оформление.УстановитьЗначениеПараметра("ТолькоПросмотр", Истина);
	
	// направление выпуска для работ и услуг только В подразделение
	
	Элемент = УсловноеОформление.Элементы.Добавить();
	
	ПолеЭлемента = Элемент.Поля.Элементы.Добавить();
	ПолеЭлемента.Поле = Новый ПолеКомпоновкиДанных(Элементы.ВыходныеИзделияНаправлениеВыпуска.Имя);
	
	ОтборЭлемента = Элемент.Отбор.Элементы.Добавить(Тип("ЭлементОтбораКомпоновкиДанных"));
	ОтборЭлемента.ЛевоеЗначение = Новый ПолеКомпоновкиДанных("Объект.ВыходныеИзделия.ТипНоменклатуры");
	ОтборЭлемента.ВидСравнения = ВидСравненияКомпоновкиДанных.ВСписке;
	СписокЗначений = Новый СписокЗначений;
	СписокЗначений.Добавить(Перечисления.ТипыНоменклатуры.Работа);
	ОтборЭлемента.ПравоеЗначение = СписокЗначений;
	
	Элемент.Оформление.УстановитьЗначениеПараметра("ТолькоПросмотр", Истина);
	
	// если изделий больше 2, то тип стоимости обязателен для заполнения

	Элемент = УсловноеОформление.Элементы.Добавить();

	ПолеЭлемента = Элемент.Поля.Элементы.Добавить();
	ПолеЭлемента.Поле = Новый ПолеКомпоновкиДанных(Элементы.ВыходныеИзделияДоляСтоимости.Имя);

	ОтборЭлемента = Элемент.Отбор.Элементы.Добавить(Тип("ЭлементОтбораКомпоновкиДанных"));
	ОтборЭлемента.ЛевоеЗначение = Новый ПолеКомпоновкиДанных("Объект.ВыходныеИзделия.КоличествоИзделийСТипомСтоимостиРассчитывается");
	ОтборЭлемента.ВидСравнения = ВидСравненияКомпоновкиДанных.Меньше;
	ОтборЭлемента.ПравоеЗначение = 2;

	Элемент.Оформление.УстановитьЗначениеПараметра("ОтметкаНезаполненного", Ложь);
	
	// только просмотр получателя для полуфабрикатов производимых в подразделение
	
	Элемент = УсловноеОформление.Элементы.Добавить();
	
	ПолеЭлемента = Элемент.Поля.Элементы.Добавить();
	ПолеЭлемента.Поле = Новый ПолеКомпоновкиДанных(Элементы.ВыходныеИзделияПолучатель.Имя);
	
	ОтборЭлемента = Элемент.Отбор.Элементы.Добавить(Тип("ЭлементОтбораКомпоновкиДанных"));
	ОтборЭлемента.ЛевоеЗначение = Новый ПолеКомпоновкиДанных("Объект.ВыходныеИзделия.ПроизводитсяВПроцессе");
	ОтборЭлемента.ВидСравнения = ВидСравненияКомпоновкиДанных.Равно;
	ОтборЭлемента.ПравоеЗначение = Истина;
	
	ОтборЭлемента = Элемент.Отбор.Элементы.Добавить(Тип("ЭлементОтбораКомпоновкиДанных"));
	ОтборЭлемента.ЛевоеЗначение = Новый ПолеКомпоновкиДанных("Объект.ВыходныеИзделия.НаправлениеВыпуска");
	ОтборЭлемента.ВидСравнения = ВидСравненияКомпоновкиДанных.Равно;
	ОтборЭлемента.ПравоеЗначение = Перечисления.ХозяйственныеОперации.ВыпускПродукцииВПодразделение;
	
	Элемент.Оформление.УстановитьЗначениеПараметра("ТолькоПросмотр", Истина);
	
	// только просмотр получателя для полуфабрикатов производимых в подразделение
	
	Элемент = УсловноеОформление.Элементы.Добавить();
	
	ПолеЭлемента = Элемент.Поля.Элементы.Добавить();
	ПолеЭлемента.Поле = Новый ПолеКомпоновкиДанных(Элементы.ВозвратныеОтходыПолучатель.Имя);
	
	ОтборЭлемента = Элемент.Отбор.Элементы.Добавить(Тип("ЭлементОтбораКомпоновкиДанных"));
	ОтборЭлемента.ЛевоеЗначение = Новый ПолеКомпоновкиДанных("Объект.ВозвратныеОтходы.ПроизводитсяВПроцессе");
	ОтборЭлемента.ВидСравнения = ВидСравненияКомпоновкиДанных.Равно;
	ОтборЭлемента.ПравоеЗначение = Истина;
	
	ОтборЭлемента = Элемент.Отбор.Элементы.Добавить(Тип("ЭлементОтбораКомпоновкиДанных"));
	ОтборЭлемента.ЛевоеЗначение = Новый ПолеКомпоновкиДанных("Объект.ВозвратныеОтходы.НаправлениеВыпуска");
	ОтборЭлемента.ВидСравнения = ВидСравненияКомпоновкиДанных.Равно;
	ОтборЭлемента.ПравоеЗначение = Перечисления.ХозяйственныеОперации.ВыпускПродукцииВПодразделение;
	
	Элемент.Оформление.УстановитьЗначениеПараметра("ТолькоПросмотр", Истина);
	
	// Текст 'На склад' в поле ВыходныеИзделия.НаправлениеВыпуска
	Элемент = УсловноеОформление.Элементы.Добавить();

	ПолеЭлемента = Элемент.Поля.Элементы.Добавить();
	ПолеЭлемента.Поле = Новый ПолеКомпоновкиДанных(Элементы.ВыходныеИзделияНаправлениеВыпуска.Имя);

	ОтборЭлемента = Элемент.Отбор.Элементы.Добавить(Тип("ЭлементОтбораКомпоновкиДанных"));
	ОтборЭлемента.ЛевоеЗначение = Новый ПолеКомпоновкиДанных("Объект.ВыходныеИзделия.НаправлениеВыпуска");
	ОтборЭлемента.ВидСравнения = ВидСравненияКомпоновкиДанных.Равно;
	ОтборЭлемента.ПравоеЗначение = Перечисления.ХозяйственныеОперации.ВыпускПродукцииНаСклад;

	Элемент.Оформление.УстановитьЗначениеПараметра("Текст", НСтр("ru = 'На склад';
																|en = 'To warehouse'"));
	
	// Текст 'В подразделение' в поле ВыходныеИзделия.НаправлениеВыпуска
	Элемент = УсловноеОформление.Элементы.Добавить();

	ПолеЭлемента = Элемент.Поля.Элементы.Добавить();
	ПолеЭлемента.Поле = Новый ПолеКомпоновкиДанных(Элементы.ВыходныеИзделияНаправлениеВыпуска.Имя);

	ОтборЭлемента = Элемент.Отбор.Элементы.Добавить(Тип("ЭлементОтбораКомпоновкиДанных"));
	ОтборЭлемента.ЛевоеЗначение = Новый ПолеКомпоновкиДанных("Объект.ВыходныеИзделия.НаправлениеВыпуска");
	ОтборЭлемента.ВидСравнения = ВидСравненияКомпоновкиДанных.Равно;
	ОтборЭлемента.ПравоеЗначение = Перечисления.ХозяйственныеОперации.ВыпускПродукцииВПодразделение;

	Элемент.Оформление.УстановитьЗначениеПараметра("Текст", НСтр("ru = 'В подразделение';
																|en = 'To business unit'"));
	
	// Текст 'На склад' в поле ВозвратныеОтходы.НаправлениеВыпуска
	Элемент = УсловноеОформление.Элементы.Добавить();

	ПолеЭлемента = Элемент.Поля.Элементы.Добавить();
	ПолеЭлемента.Поле = Новый ПолеКомпоновкиДанных(Элементы.ВозвратныеОтходыНаправлениеВыпуска.Имя);

	ОтборЭлемента = Элемент.Отбор.Элементы.Добавить(Тип("ЭлементОтбораКомпоновкиДанных"));
	ОтборЭлемента.ЛевоеЗначение = Новый ПолеКомпоновкиДанных("Объект.ВозвратныеОтходы.НаправлениеВыпуска");
	ОтборЭлемента.ВидСравнения = ВидСравненияКомпоновкиДанных.Равно;
	ОтборЭлемента.ПравоеЗначение = Перечисления.ХозяйственныеОперации.ВыпускПродукцииНаСклад;

	Элемент.Оформление.УстановитьЗначениеПараметра("Текст", НСтр("ru = 'На склад';
																|en = 'To warehouse'"));
	
	// Текст 'В подразделение' в поле ВозвратныеОтходы.НаправлениеВыпуска
	Элемент = УсловноеОформление.Элементы.Добавить();

	ПолеЭлемента = Элемент.Поля.Элементы.Добавить();
	ПолеЭлемента.Поле = Новый ПолеКомпоновкиДанных(Элементы.ВозвратныеОтходыНаправлениеВыпуска.Имя);

	ОтборЭлемента = Элемент.Отбор.Элементы.Добавить(Тип("ЭлементОтбораКомпоновкиДанных"));
	ОтборЭлемента.ЛевоеЗначение = Новый ПолеКомпоновкиДанных("Объект.ВозвратныеОтходы.НаправлениеВыпуска");
	ОтборЭлемента.ВидСравнения = ВидСравненияКомпоновкиДанных.Равно;
	ОтборЭлемента.ПравоеЗначение = Перечисления.ХозяйственныеОперации.ВыпускПродукцииВПодразделение;

	Элемент.Оформление.УстановитьЗначениеПараметра("Текст", НСтр("ru = 'В подразделение';
																|en = 'To business unit'"));
	
#КонецОбласти

#Область ВозвратныеОтходы

	// характеристики

	НоменклатураСервер.УстановитьУсловноеОформлениеХарактеристикНоменклатуры(ЭтаФорма, 
																			 "ВозвратныеОтходыХарактеристика",
																		     "Объект.ВозвратныеОтходы.ХарактеристикиИспользуются");

	// упаковки
	
	
	НоменклатураСервер.УстановитьУсловноеОформлениеЕдиницИзмерения(ЭтаФорма, 
																   "ВозвратныеОтходыНоменклатураЕдиницаИзмерения", 
                                                                   "Объект.ВозвратныеОтходы.Упаковка");

	// полуфабрикаты выделяются коричневым

	Элемент = УсловноеОформление.Элементы.Добавить();
	
	ЗаполнитьПоляЭлементаУсловногоОформления(Элемент, Элементы.ВозвратныеОтходы.ПодчиненныеЭлементы);
	
	ОтборЭлемента = Элемент.Отбор.Элементы.Добавить(Тип("ЭлементОтбораКомпоновкиДанных"));
	ОтборЭлемента.ЛевоеЗначение = Новый ПолеКомпоновкиДанных("Объект.ВозвратныеОтходы.ПроизводитсяВПроцессе");
	ОтборЭлемента.ВидСравнения = ВидСравненияКомпоновкиДанных.Равно;
	ОтборЭлемента.ПравоеЗначение = Истина;
	
	Элемент.Оформление.УстановитьЗначениеПараметра("ЦветТекста", ЦветаСтиля.ТекстПредопределенногоЗначения);

	// для полуфабрикатов можно менять только ограниченный набор полей

	Элемент = УсловноеОформление.Элементы.Добавить();

	ПолеЭлемента = Элемент.Поля.Элементы.Добавить();
	ПолеЭлемента.Поле = Новый ПолеКомпоновкиДанных(Элементы.ВозвратныеОтходыНоменклатура.Имя);

	ПолеЭлемента = Элемент.Поля.Элементы.Добавить();
	ПолеЭлемента.Поле = Новый ПолеКомпоновкиДанных(Элементы.ВозвратныеОтходыХарактеристика.Имя);

	ПолеЭлемента = Элемент.Поля.Элементы.Добавить();
	ПолеЭлемента.Поле = Новый ПолеКомпоновкиДанных(Элементы.ВозвратныеОтходыЭтап.Имя);

	ПолеЭлемента = Элемент.Поля.Элементы.Добавить();
	ПолеЭлемента.Поле = Новый ПолеКомпоновкиДанных(Элементы.ВозвратныеОтходыНаименованиеПолуфабриката.Имя);
	
	ПолеЭлемента = Элемент.Поля.Элементы.Добавить();
	ПолеЭлемента.Поле = Новый ПолеКомпоновкиДанных(Элементы.ВозвратныеОтходыСтатьяКалькуляции.Имя);
	
	ОтборЭлемента = Элемент.Отбор.Элементы.Добавить(Тип("ЭлементОтбораКомпоновкиДанных"));
	ОтборЭлемента.ЛевоеЗначение = Новый ПолеКомпоновкиДанных("Объект.ВозвратныеОтходы.ПроизводитсяВПроцессе");
	ОтборЭлемента.ВидСравнения = ВидСравненияКомпоновкиДанных.Равно;
	ОтборЭлемента.ПравоеЗначение = Истина;

	Элемент.Оформление.УстановитьЗначениеПараметра("ТолькоПросмотр", Истина);
	
	// выполненные этапы редактировать нельзя

	Элемент = УсловноеОформление.Элементы.Добавить();

	ПолеЭлемента = Элемент.Поля.Элементы.Добавить();
	ПолеЭлемента.Поле = Новый ПолеКомпоновкиДанных(Элементы.ВозвратныеОтходыНомерСтроки.Имя);

	ПолеЭлемента = Элемент.Поля.Элементы.Добавить();
	ПолеЭлемента.Поле = Новый ПолеКомпоновкиДанных(Элементы.ВозвратныеОтходыНоменклатура.Имя);

	ПолеЭлемента = Элемент.Поля.Элементы.Добавить();
	ПолеЭлемента.Поле = Новый ПолеКомпоновкиДанных(Элементы.ВозвратныеОтходыХарактеристика.Имя);

	ПолеЭлемента = Элемент.Поля.Элементы.Добавить();
	ПолеЭлемента.Поле = Новый ПолеКомпоновкиДанных(Элементы.ВозвратныеОтходыНазначение.Имя);

	ПолеЭлемента = Элемент.Поля.Элементы.Добавить();
	ПолеЭлемента.Поле = Новый ПолеКомпоновкиДанных(Элементы.ВозвратныеОтходыСтатьяКалькуляции.Имя);

	ПолеЭлемента = Элемент.Поля.Элементы.Добавить();
	ПолеЭлемента.Поле = Новый ПолеКомпоновкиДанных(Элементы.ВозвратныеОтходыКоличествоУпаковок.Имя);

	ПолеЭлемента = Элемент.Поля.Элементы.Добавить();
	ПолеЭлемента.Поле = Новый ПолеКомпоновкиДанных(Элементы.ВозвратныеОтходыУпаковка.Имя);

	ПолеЭлемента = Элемент.Поля.Элементы.Добавить();
	ПолеЭлемента.Поле = Новый ПолеКомпоновкиДанных(Элементы.ВозвратныеОтходыНоменклатураЕдиницаИзмерения.Имя);

	ПолеЭлемента = Элемент.Поля.Элементы.Добавить();
	ПолеЭлемента.Поле = Новый ПолеКомпоновкиДанных(Элементы.ВозвратныеОтходыЭтап.Имя);

	ПолеЭлемента = Элемент.Поля.Элементы.Добавить();
	ПолеЭлемента.Поле = Новый ПолеКомпоновкиДанных(Элементы.ВозвратныеОтходыПолучатель.Имя);

	ПолеЭлемента = Элемент.Поля.Элементы.Добавить();
	ПолеЭлемента.Поле = Новый ПолеКомпоновкиДанных(Элементы.ВозвратныеОтходыНаправлениеВыпуска.Имя);

	ОтборЭлемента = Элемент.Отбор.Элементы.Добавить(Тип("ЭлементОтбораКомпоновкиДанных"));
	ОтборЭлемента.ЛевоеЗначение = Новый ПолеКомпоновкиДанных("Объект.ВозвратныеОтходы.ЭтапВыполнен");
	ОтборЭлемента.ВидСравнения = ВидСравненияКомпоновкиДанных.Равно;
	ОтборЭлемента.ПравоеЗначение = Истина;

	Элемент.Оформление.УстановитьЗначениеПараметра("ЦветТекста", ЦветаСтиля.ЦветТекстаОтмененнойСтрокиДокумента);
	Элемент.Оформление.УстановитьЗначениеПараметра("ТолькоПросмотр", Истина);

	// статья калькуляции

	Элемент = УсловноеОформление.Элементы.Добавить();

	ПолеЭлемента = Элемент.Поля.Элементы.Добавить();
	ПолеЭлемента.Поле = Новый ПолеКомпоновкиДанных(Элементы.ВозвратныеОтходыСтатьяКалькуляции.Имя);
	
	ОтборЭлемента = Элемент.Отбор.Элементы.Добавить(Тип("ЭлементОтбораКомпоновкиДанных"));
	ОтборЭлемента.ЛевоеЗначение = Новый ПолеКомпоновкиДанных("Объект.ВозвратныеОтходы.ПроизводитсяВПроцессе");
	ОтборЭлемента.ВидСравнения = ВидСравненияКомпоновкиДанных.Равно;
	ОтборЭлемента.ПравоеЗначение = Истина;
	
	Элемент.Оформление.УстановитьЗначениеПараметра("Текст", НСтр("ru = '<не требуется>';
																|en = '<not required>'"));
	
	// направление выпуска для работ и услуг только В подразделение
	
	Элемент = УсловноеОформление.Элементы.Добавить();
	
	ПолеЭлемента = Элемент.Поля.Элементы.Добавить();
	ПолеЭлемента.Поле = Новый ПолеКомпоновкиДанных(Элементы.ВозвратныеОтходыНаправлениеВыпуска.Имя);
	
	ОтборЭлемента = Элемент.Отбор.Элементы.Добавить(Тип("ЭлементОтбораКомпоновкиДанных"));
	ОтборЭлемента.ЛевоеЗначение = Новый ПолеКомпоновкиДанных("Объект.ВозвратныеОтходы.ТипНоменклатуры");
	ОтборЭлемента.ВидСравнения = ВидСравненияКомпоновкиДанных.ВСписке;
	СписокЗначений = Новый СписокЗначений;
	СписокЗначений.Добавить(Перечисления.ТипыНоменклатуры.Услуга);
	СписокЗначений.Добавить(Перечисления.ТипыНоменклатуры.Работа);
	ОтборЭлемента.ПравоеЗначение = СписокЗначений;
	
	Элемент.Оформление.УстановитьЗначениеПараметра("ТолькоПросмотр", Истина);
	
#КонецОбласти

#Область Этапы

	// выполненные этапы редактировать нельзя

	Элемент = УсловноеОформление.Элементы.Добавить();

	ПолеЭлемента = Элемент.Поля.Элементы.Добавить();
	ПолеЭлемента.Поле = Новый ПолеКомпоновкиДанных(Элементы.ЭтапыНомерЭтапа.Имя);

	ПолеЭлемента = Элемент.Поля.Элементы.Добавить();
	ПолеЭлемента.Поле = Новый ПолеКомпоновкиДанных(Элементы.ЭтапыНомерСледующегоЭтапа.Имя);

	ПолеЭлемента = Элемент.Поля.Элементы.Добавить();
	ПолеЭлемента.Поле = Новый ПолеКомпоновкиДанных(Элементы.ЭтапыЭтап.Имя);
	
	ПолеЭлемента = Элемент.Поля.Элементы.Добавить();
	ПолеЭлемента.Поле = Новый ПолеКомпоновкиДанных(Элементы.ЭтапыНаименованиеПолуфабриката.Имя);
	
	ПолеЭлемента = Элемент.Поля.Элементы.Добавить();
	ПолеЭлемента.Поле = Новый ПолеКомпоновкиДанных(Элементы.ЭтапыПодразделение.Имя);

	ПолеЭлемента = Элемент.Поля.Элементы.Добавить();
	ПолеЭлемента.Поле = Новый ПолеКомпоновкиДанных(Элементы.ЭтапыКоличество.Имя);

	ПолеЭлемента = Элемент.Поля.Элементы.Добавить();
	ПолеЭлемента.Поле = Новый ПолеКомпоновкиДанных(Элементы.ЭтапыВыполненоЗапланировано.Имя);

	ОтборЭлемента = Элемент.Отбор.Элементы.Добавить(Тип("ЭлементОтбораКомпоновкиДанных"));
	ОтборЭлемента.ЛевоеЗначение = Новый ПолеКомпоновкиДанных("Объект.Этапы.ЭтапВыполнен");
	ОтборЭлемента.ВидСравнения = ВидСравненияКомпоновкиДанных.Равно;
	ОтборЭлемента.ПравоеЗначение = Истина;

	Элемент.Оформление.УстановитьЗначениеПараметра("ЦветТекста", ЦветаСтиля.ЦветТекстаОтмененнойСтрокиДокумента);
	Элемент.Оформление.УстановитьЗначениеПараметра("ТолькоПросмотр", Истина);
	
	//
	
	Элемент = УсловноеОформление.Элементы.Добавить();
	
	ПолеЭлемента = Элемент.Поля.Элементы.Добавить();
	ПолеЭлемента.Поле = Новый ПолеКомпоновкиДанных(Элементы.ЭтапыПроизводствоНаСтороне.Имя);

	ОтборЭлемента = Элемент.Отбор.Элементы.Добавить(Тип("ЭлементОтбораКомпоновкиДанных"));
	ОтборЭлемента.ЛевоеЗначение = Новый ПолеКомпоновкиДанных("ИспользуетсяПроизводствоНаСтороне");
	ОтборЭлемента.ВидСравнения = ВидСравненияКомпоновкиДанных.Равно;
	ОтборЭлемента.ПравоеЗначение = Ложь;

	Элемент.Оформление.УстановитьЗначениеПараметра("Видимость", Ложь);
	
#КонецОбласти

#Область Трудозатраты

	// выполненные этапы редактировать нельзя

	Элемент = УсловноеОформление.Элементы.Добавить();

	ПолеЭлемента = Элемент.Поля.Элементы.Добавить();
	ПолеЭлемента.Поле = Новый ПолеКомпоновкиДанных(Элементы.ТрудозатратыНомерСтроки.Имя);

	ПолеЭлемента = Элемент.Поля.Элементы.Добавить();
	ПолеЭлемента.Поле = Новый ПолеКомпоновкиДанных(Элементы.ТрудозатратыВидРабот.Имя);

	ПолеЭлемента = Элемент.Поля.Элементы.Добавить();
	ПолеЭлемента.Поле = Новый ПолеКомпоновкиДанных(Элементы.ТрудозатратыКоличество.Имя);

	ПолеЭлемента = Элемент.Поля.Элементы.Добавить();
	ПолеЭлемента.Поле = Новый ПолеКомпоновкиДанных(Элементы.ТрудозатратыВидРаботЕдиницаИзмерения.Имя);

	ПолеЭлемента = Элемент.Поля.Элементы.Добавить();
	ПолеЭлемента.Поле = Новый ПолеКомпоновкиДанных(Элементы.ТрудозатратыЭтап.Имя);

	ПолеЭлемента = Элемент.Поля.Элементы.Добавить();
	ПолеЭлемента.Поле = Новый ПолеКомпоновкиДанных(Элементы.ТрудозатратыНаименованиеПолуфабриката.Имя);

	ПолеЭлемента = Элемент.Поля.Элементы.Добавить();
	ПолеЭлемента.Поле = Новый ПолеКомпоновкиДанных(Элементы.ТрудозатратыСтатьяКалькуляции.Имя);

	ОтборЭлемента = Элемент.Отбор.Элементы.Добавить(Тип("ЭлементОтбораКомпоновкиДанных"));
	ОтборЭлемента.ЛевоеЗначение = Новый ПолеКомпоновкиДанных("Объект.Трудозатраты.ЭтапВыполнен");
	ОтборЭлемента.ВидСравнения = ВидСравненияКомпоновкиДанных.Равно;
	ОтборЭлемента.ПравоеЗначение = Истина;

	Элемент.Оформление.УстановитьЗначениеПараметра("ЦветТекста", ЦветаСтиля.ЦветТекстаОтмененнойСтрокиДокумента);
	Элемент.Оформление.УстановитьЗначениеПараметра("ТолькоПросмотр", Истина);

#КонецОбласти

#Область МатериалыИУслуги
	
	ОбеспечениеВДокументахСервер.УстановитьУсловноеОформлениеОбособленно(
		УсловноеОформление,
		Элементы.МатериалыИУслугиОбособленно,
		"Объект.МатериалыИУслуги.ВариантОбеспечения",
		"Объект.МатериалыИУслуги.ТипНоменклатуры");
	
	ОбеспечениеВДокументахСервер.ДоступныеОстаткиДобавитьОформлениеКолонкиДоступно(ЭтотОбъект);
	
	Обработки.ВводКорректировкиЗаказаМатериалов.УстановитьУсловноеОформление(УсловноеОформление, Элементы, "Объект", "", Ложь);
	
	// характеристики
	
	НоменклатураСервер.УстановитьУсловноеОформлениеХарактеристикНоменклатуры(ЭтаФорма, 
																			 "МатериалыИУслугиХарактеристика",
																		     "Объект.МатериалыИУслуги.ХарактеристикиИспользуются");
	// упаковки
	
	НоменклатураСервер.УстановитьУсловноеОформлениеЕдиницИзмерения(ЭтаФорма, 
																   "МатериалыИУслугиНоменклатураЕдиницаИзмерения", 
                                                                   "Объект.МатериалыИУслуги.Упаковка");
																   
	// статья калькуляции

	Элемент = УсловноеОформление.Элементы.Добавить();

	ПолеЭлемента = Элемент.Поля.Элементы.Добавить();
	ПолеЭлемента.Поле = Новый ПолеКомпоновкиДанных(Элементы.МатериалыИУслугиСтатьяКалькуляции.Имя);

	ОтборГруппа = Элемент.Отбор.Элементы.Добавить(Тип("ГруппаЭлементовОтбораКомпоновкиДанных"));
	ОтборГруппа.ТипГруппы = ТипГруппыЭлементовОтбораКомпоновкиДанных.ГруппаИли;
	
	ОтборЭлемента = ОтборГруппа.Элементы.Добавить(Тип("ЭлементОтбораКомпоновкиДанных"));
	ОтборЭлемента.ЛевоеЗначение = Новый ПолеКомпоновкиДанных("Объект.МатериалыИУслуги.ПроизводитсяВПроцессе");
	ОтборЭлемента.ВидСравнения = ВидСравненияКомпоновкиДанных.Равно;
	ОтборЭлемента.ПравоеЗначение = Истина;

	ОтборЭлемента = ОтборГруппа.Элементы.Добавить(Тип("ЭлементОтбораКомпоновкиДанных"));
	ОтборЭлемента.ЛевоеЗначение = Новый ПолеКомпоновкиДанных("Объект.МатериалыИУслуги.Отменено");
	ОтборЭлемента.ВидСравнения = ВидСравненияКомпоновкиДанных.Равно;
	ОтборЭлемента.ПравоеЗначение = Истина;
	
	Элемент.Оформление.УстановитьЗначениеПараметра("ТолькоПросмотр", Истина);
	Элемент.Оформление.УстановитьЗначениеПараметра("Текст", НСтр("ru = '<не требуется>';
																|en = '<not required>'"));
	Элемент.Оформление.УстановитьЗначениеПараметра("ЦветТекста", ЦветаСтиля.ТекстЗапрещеннойЯчейкиЦвет);
	Элемент.Оформление.УстановитьЗначениеПараметра("ОтметкаНезаполненного", Ложь);
	
	// отменено для полуфабрикатов

	Элемент = УсловноеОформление.Элементы.Добавить();

	ПолеЭлемента = Элемент.Поля.Элементы.Добавить();
	ПолеЭлемента.Поле = Новый ПолеКомпоновкиДанных(Элементы.МатериалыИУслугиОтменитьПолучение.Имя);

	ОтборЭлемента = Элемент.Отбор.Элементы.Добавить(Тип("ЭлементОтбораКомпоновкиДанных"));
	ОтборЭлемента.ЛевоеЗначение = Новый ПолеКомпоновкиДанных("Объект.МатериалыИУслуги.ПроизводитсяВПроцессе");
	ОтборЭлемента.ВидСравнения = ВидСравненияКомпоновкиДанных.Равно;
	ОтборЭлемента.ПравоеЗначение = Истина;

	Элемент.Оформление.УстановитьЗначениеПараметра("ТолькоПросмотр", Истина);
	
	// выполненные этапы отображаются серым цветом

	Элемент = УсловноеОформление.Элементы.Добавить();
	
	ПолеЭлемента = Элемент.Поля.Элементы.Добавить();
	ПолеЭлемента.Поле = Новый ПолеКомпоновкиДанных(Элементы.МатериалыИУслуги.Имя);
	
	ОтборЭлемента = Элемент.Отбор.Элементы.Добавить(Тип("ЭлементОтбораКомпоновкиДанных"));
	ОтборЭлемента.ЛевоеЗначение = Новый ПолеКомпоновкиДанных("Объект.МатериалыИУслуги.ЭтапВыполнен");
	ОтборЭлемента.ВидСравнения = ВидСравненияКомпоновкиДанных.Равно;
	ОтборЭлемента.ПравоеЗначение = Истина;

	Элемент.Оформление.УстановитьЗначениеПараметра("ЦветТекста", ЦветаСтиля.ЦветТекстаОтмененнойСтрокиДокумента);
	
	// Выполненные этапы редактировать нельзя, можно только отменить и изменить количество.

	Элемент = УсловноеОформление.Элементы.Добавить();
	
	МассивИсключений = Новый Массив;
	МассивИсключений.Добавить("МатериалыИУслугиОтменитьПолучение");
	МассивИсключений.Добавить("МатериалыИУслугиКоличествоУпаковок");
	
	ЗаполнитьПоляЭлементаУсловногоОформления(Элемент, Элементы.МатериалыИУслуги.ПодчиненныеЭлементы, МассивИсключений);
	
	ОтборЭлемента = Элемент.Отбор.Элементы.Добавить(Тип("ЭлементОтбораКомпоновкиДанных"));
	ОтборЭлемента.ЛевоеЗначение = Новый ПолеКомпоновкиДанных("Объект.МатериалыИУслуги.ЭтапВыполнен");
	ОтборЭлемента.ВидСравнения = ВидСравненияКомпоновкиДанных.Равно;
	ОтборЭлемента.ПравоеЗначение = Истина;
	
	Элемент.Оформление.УстановитьЗначениеПараметра("ТолькоПросмотр", Истина);
	
	// отмененные строки редактировать нельзя
	
	Элемент = УсловноеОформление.Элементы.Добавить();
	
	МассивИсключений = Новый Массив;
	МассивИсключений.Добавить("МатериалыИУслугиОтменитьПолучение");
	
	ЗаполнитьПоляЭлементаУсловногоОформления(Элемент, Элементы.МатериалыИУслуги.ПодчиненныеЭлементы, МассивИсключений);
	
	ОтборЭлемента = Элемент.Отбор.Элементы.Добавить(Тип("ЭлементОтбораКомпоновкиДанных"));
	ОтборЭлемента.ЛевоеЗначение = Новый ПолеКомпоновкиДанных("Объект.МатериалыИУслуги.Отменено");
	ОтборЭлемента.ВидСравнения = ВидСравненияКомпоновкиДанных.Равно;
	ОтборЭлемента.ПравоеЗначение = Истина;
	
	Элемент.Оформление.УстановитьЗначениеПараметра("ТолькоПросмотр", Истина);
	
	// нельзя выбрать спецификацию если материал не производится

	Элемент = УсловноеОформление.Элементы.Добавить();

	ПолеЭлемента = Элемент.Поля.Элементы.Добавить();
	ПолеЭлемента.Поле = Новый ПолеКомпоновкиДанных(Элементы.МатериалыИУслугиИсточникПолученияПолуфабриката.Имя);

	ОтборЭлемента = Элемент.Отбор.Элементы.Добавить(Тип("ЭлементОтбораКомпоновкиДанных"));
	ОтборЭлемента.ЛевоеЗначение = Новый ПолеКомпоновкиДанных("Объект.МатериалыИУслуги.ПроизводитсяВПроцессе");
	ОтборЭлемента.ВидСравнения = ВидСравненияКомпоновкиДанных.Равно;
	ОтборЭлемента.ПравоеЗначение = Ложь;

	Элемент.Оформление.УстановитьЗначениеПараметра("ТолькоПросмотр", Истина);
	Элемент.Оформление.УстановитьЗначениеПараметра("ОтметкаНезаполненного", Ложь);
	
	// Если материал производится и получается из подразделения то нужно изменить текст варианта обеспечения.

	Элемент = УсловноеОформление.Элементы.Добавить();

	ПолеЭлемента = Элемент.Поля.Элементы.Добавить();
	ПолеЭлемента.Поле = Новый ПолеКомпоновкиДанных(Элементы.МатериалыИУслугиВариантОбеспечения.Имя);

	ОтборЭлемента = Элемент.Отбор.Элементы.Добавить(Тип("ЭлементОтбораКомпоновкиДанных"));
	ОтборЭлемента.ЛевоеЗначение = Новый ПолеКомпоновкиДанных("Объект.МатериалыИУслуги.ПроизводитсяВПроцессе");
	ОтборЭлемента.ВидСравнения = ВидСравненияКомпоновкиДанных.Равно;
	ОтборЭлемента.ПравоеЗначение = Истина;

	ОтборЭлемента = Элемент.Отбор.Элементы.Добавить(Тип("ЭлементОтбораКомпоновкиДанных"));
	ОтборЭлемента.ЛевоеЗначение = Новый ПолеКомпоновкиДанных("Объект.МатериалыИУслуги.ЗаказатьНаСклад");
	ОтборЭлемента.ВидСравнения = ВидСравненияКомпоновкиДанных.Равно;
	ОтборЭлемента.ПравоеЗначение = Ложь;
	
	Элемент.Оформление.УстановитьЗначениеПараметра("Текст", НСтр("ru = '<не используется>';
																|en = '<not used>'"));
	
	// Изменение флага обособленно недоступно для полуфабрикатов производимых в процессе и материалов из запаса подразделения.

	Элемент = УсловноеОформление.Элементы.Добавить();

	ПолеЭлемента = Элемент.Поля.Элементы.Добавить();
	ПолеЭлемента.Поле = Новый ПолеКомпоновкиДанных(Элементы.МатериалыИУслугиОбособленно.Имя);
	
	ОтборЭлемента = Элемент.Отбор.Элементы.Добавить(Тип("ЭлементОтбораКомпоновкиДанных"));
	ОтборЭлемента.ЛевоеЗначение = Новый ПолеКомпоновкиДанных("Объект.МатериалыИУслуги.ТипНоменклатуры");
	ОтборЭлемента.ВидСравнения = ВидСравненияКомпоновкиДанных.НеРавно;
	ОтборЭлемента.ПравоеЗначение = Перечисления.ТипыНоменклатуры.Работа;
	
	ГруппаИли = Элемент.Отбор.Элементы.Добавить(Тип("ГруппаЭлементовОтбораКомпоновкиДанных"));
	ГруппаИли.ТипГруппы = ТипГруппыЭлементовОтбораКомпоновкиДанных.ГруппаИли;
	
	ОтборЭлемента = ГруппаИли.Элементы.Добавить(Тип("ЭлементОтбораКомпоновкиДанных"));
	ОтборЭлемента.ЛевоеЗначение = Новый ПолеКомпоновкиДанных("Объект.МатериалыИУслуги.ПроизводитсяВПроцессе");
	ОтборЭлемента.ВидСравнения = ВидСравненияКомпоновкиДанных.Равно;
	ОтборЭлемента.ПравоеЗначение = Истина;

	ОтборЭлемента = ГруппаИли.Элементы.Добавить(Тип("ЭлементОтбораКомпоновкиДанных"));
	ОтборЭлемента.ЛевоеЗначение = Новый ПолеКомпоновкиДанных("Объект.МатериалыИУслуги.ЗаказатьНаСклад");
	ОтборЭлемента.ВидСравнения = ВидСравненияКомпоновкиДанных.Равно;
	ОтборЭлемента.ПравоеЗначение = Ложь;

	ОтборЭлемента = ГруппаИли.Элементы.Добавить(Тип("ЭлементОтбораКомпоновкиДанных"));
	ОтборЭлемента.ЛевоеЗначение = Новый ПолеКомпоновкиДанных("ИспользуютсяКорректировкиЗаказаМатериалов");
	ОтборЭлемента.ВидСравнения = ВидСравненияКомпоновкиДанных.Равно;
	ОтборЭлемента.ПравоеЗначение = Истина;

	Элемент.Оформление.УстановитьЗначениеПараметра("ТолькоПросмотр", Истина);
	
	// Изменение флага обособленно недоступно для полуфабрикатов-работ производимых в процессе.

	Элемент = УсловноеОформление.Элементы.Добавить();

	ПолеЭлемента = Элемент.Поля.Элементы.Добавить();
	ПолеЭлемента.Поле = Новый ПолеКомпоновкиДанных(Элементы.МатериалыИУслугиОбособленно.Имя);
	
	ОтборЭлемента = Элемент.Отбор.Элементы.Добавить(Тип("ЭлементОтбораКомпоновкиДанных"));
	ОтборЭлемента.ЛевоеЗначение = Новый ПолеКомпоновкиДанных("Объект.МатериалыИУслуги.ТипНоменклатуры");
	ОтборЭлемента.ВидСравнения = ВидСравненияКомпоновкиДанных.Равно;
	ОтборЭлемента.ПравоеЗначение = Перечисления.ТипыНоменклатуры.Работа;
	
	ГруппаИли = Элемент.Отбор.Элементы.Добавить(Тип("ГруппаЭлементовОтбораКомпоновкиДанных"));
	ГруппаИли.ТипГруппы = ТипГруппыЭлементовОтбораКомпоновкиДанных.ГруппаИли;
	
	ОтборЭлемента = ГруппаИли.Элементы.Добавить(Тип("ЭлементОтбораКомпоновкиДанных"));
	ОтборЭлемента.ЛевоеЗначение = Новый ПолеКомпоновкиДанных("Объект.МатериалыИУслуги.ПроизводитсяВПроцессе");
	ОтборЭлемента.ВидСравнения = ВидСравненияКомпоновкиДанных.Равно;
	ОтборЭлемента.ПравоеЗначение = Истина;

	ОтборЭлемента = ГруппаИли.Элементы.Добавить(Тип("ЭлементОтбораКомпоновкиДанных"));
	ОтборЭлемента.ЛевоеЗначение = Новый ПолеКомпоновкиДанных("ИспользуютсяКорректировкиЗаказаМатериалов");
	ОтборЭлемента.ВидСравнения = ВидСравненияКомпоновкиДанных.Равно;
	ОтборЭлемента.ПравоеЗначение = Истина;

	Элемент.Оформление.УстановитьЗначениеПараметра("ТолькоПросмотр", Истина);
	
	// Изменение варианта обеспечения недоступно для полуфабрикатов производимых в процессе.

	Элемент = УсловноеОформление.Элементы.Добавить();
	
	ПолеЭлемента = Элемент.Поля.Элементы.Добавить();
	ПолеЭлемента.Поле = Новый ПолеКомпоновкиДанных(Элементы.МатериалыИУслугиВариантОбеспечения.Имя);
	
	ГруппаИли = Элемент.Отбор.Элементы.Добавить(Тип("ГруппаЭлементовОтбораКомпоновкиДанных"));
	ГруппаИли.ТипГруппы = ТипГруппыЭлементовОтбораКомпоновкиДанных.ГруппаИли;
	
	ОтборЭлемента = ГруппаИли.Элементы.Добавить(Тип("ЭлементОтбораКомпоновкиДанных"));
	ОтборЭлемента.ЛевоеЗначение = Новый ПолеКомпоновкиДанных("Объект.МатериалыИУслуги.ПроизводитсяВПроцессе");
	ОтборЭлемента.ВидСравнения = ВидСравненияКомпоновкиДанных.Равно;
	ОтборЭлемента.ПравоеЗначение = Истина;

	ОтборЭлемента = ГруппаИли.Элементы.Добавить(Тип("ЭлементОтбораКомпоновкиДанных"));
	ОтборЭлемента.ЛевоеЗначение = Новый ПолеКомпоновкиДанных("ИспользуютсяКорректировкиЗаказаМатериалов");
	ОтборЭлемента.ВидСравнения = ВидСравненияКомпоновкиДанных.Равно;
	ОтборЭлемента.ПравоеЗначение = Истина;

	Элемент.Оформление.УстановитьЗначениеПараметра("ТолькоПросмотр", Истина);
	
	// Изменение варианта обеспечения недоступно для работ.

	Элемент = УсловноеОформление.Элементы.Добавить();
	
	ПолеЭлемента = Элемент.Поля.Элементы.Добавить();
	ПолеЭлемента.Поле = Новый ПолеКомпоновкиДанных(Элементы.МатериалыИУслугиВариантОбеспечения.Имя);
	
	ОтборЭлемента = Элемент.Отбор.Элементы.Добавить(Тип("ЭлементОтбораКомпоновкиДанных"));
	ОтборЭлемента.ЛевоеЗначение = Новый ПолеКомпоновкиДанных("Объект.МатериалыИУслуги.ТипНоменклатуры");
	ОтборЭлемента.ВидСравнения = ВидСравненияКомпоновкиДанных.Равно;
	ОтборЭлемента.ПравоеЗначение = Перечисления.ТипыНоменклатуры.Работа;
	
	Элемент.Оформление.УстановитьЗначениеПараметра("ТолькоПросмотр", Истина);
	
#Область ОтметкаНезаполненнойДатыОтгрузкиСтрокиЗаказа
	Элемент = УсловноеОформление.Элементы.Добавить();

	ПолеЭлемента = Элемент.Поля.Элементы.Добавить();
	ПолеЭлемента.Поле = Новый ПолеКомпоновкиДанных(Элементы.МатериалыИУслугиДатаПотребности.Имя);

	ОтборЭлемента = Элемент.Отбор.Элементы.Добавить(Тип("ЭлементОтбораКомпоновкиДанных"));
	ОтборЭлемента.ЛевоеЗначение = Новый ПолеКомпоновкиДанных("Объект.СтатусЗаказаНаПроизводство");
	ОтборЭлемента.ВидСравнения   = ВидСравненияКомпоновкиДанных.Равно;
	ОтборЭлемента.ПравоеЗначение = Перечисления.СтатусыЗаказовНаПроизводство.Создан;

	Элемент.Оформление.УстановитьЗначениеПараметра("ОтметкаНезаполненного", Ложь);

#КонецОбласти
	
	// Текст способа получения полуфабриката "на этапе" или "по спецификации"
	#Область ТекстСпособПолученияПолуфабриката
	Элемент = УсловноеОформление.Элементы.Добавить();

	ПолеЭлемента = Элемент.Поля.Элементы.Добавить();
	ПолеЭлемента.Поле = Новый ПолеКомпоновкиДанных(Элементы.МатериалыИУслугиСпособПолученияПолуфабриката.Имя);

	ОтборЭлемента = Элемент.Отбор.Элементы.Добавить(Тип("ЭлементОтбораКомпоновкиДанных"));
	ОтборЭлемента.ЛевоеЗначение = Новый ПолеКомпоновкиДанных("Объект.МатериалыИУслуги.ПроизводитсяВПроцессе");
	ОтборЭлемента.ВидСравнения = ВидСравненияКомпоновкиДанных.Равно;
	ОтборЭлемента.ПравоеЗначение = Истина;

	ОтборЭлемента = Элемент.Отбор.Элементы.Добавить(Тип("ЭлементОтбораКомпоновкиДанных"));
	ОтборЭлемента.ЛевоеЗначение = Новый ПолеКомпоновкиДанных("Объект.МатериалыИУслуги.СпособПолученияПолуфабриката");
	ОтборЭлемента.ВидСравнения = ВидСравненияКомпоновкиДанных.Равно;
	ОтборЭлемента.ПравоеЗначение = Перечисления.СпособыПолучениеМатериаловЭтапаПроизводства.ПроизвестиНаЭтапе;
	
	Элемент.Оформление.УстановитьЗначениеПараметра("ЦветТекста", ЦветаСтиля.ПоясняющийТекст);
	Элемент.Оформление.УстановитьЗначениеПараметра("Текст", " " + НСтр("ru = 'на этапе';
																		|en = 'on step'"));

	//

	Элемент = УсловноеОформление.Элементы.Добавить();

	ПолеЭлемента = Элемент.Поля.Элементы.Добавить();
	ПолеЭлемента.Поле = Новый ПолеКомпоновкиДанных(Элементы.МатериалыИУслугиСпособПолученияПолуфабриката.Имя);

	ОтборЭлемента = Элемент.Отбор.Элементы.Добавить(Тип("ЭлементОтбораКомпоновкиДанных"));
	ОтборЭлемента.ЛевоеЗначение = Новый ПолеКомпоновкиДанных("Объект.МатериалыИУслуги.ПроизводитсяВПроцессе");
	ОтборЭлемента.ВидСравнения = ВидСравненияКомпоновкиДанных.Равно;
	ОтборЭлемента.ПравоеЗначение = Истина;

	ОтборЭлемента = Элемент.Отбор.Элементы.Добавить(Тип("ЭлементОтбораКомпоновкиДанных"));
	ОтборЭлемента.ЛевоеЗначение = Новый ПолеКомпоновкиДанных("Объект.МатериалыИУслуги.СпособПолученияПолуфабриката");
	ОтборЭлемента.ВидСравнения = ВидСравненияКомпоновкиДанных.Равно;
	ОтборЭлемента.ПравоеЗначение = Перечисления.СпособыПолучениеМатериаловЭтапаПроизводства.ПроизвестиПоСпецификации;
	
	Элемент.Оформление.УстановитьЗначениеПараметра("ЦветТекста", ЦветаСтиля.ПоясняющийТекст);
	Элемент.Оформление.УстановитьЗначениеПараметра("Текст", " " + НСтр("ru = 'по спецификации';
																		|en = 'by bill of materials'"));
	
	//

	Элемент = УсловноеОформление.Элементы.Добавить();

	ПолеЭлемента = Элемент.Поля.Элементы.Добавить();
	ПолеЭлемента.Поле = Новый ПолеКомпоновкиДанных(Элементы.МатериалыИУслугиСпособПолученияПолуфабриката.Имя);
	
	ПолеЭлемента = Элемент.Поля.Элементы.Добавить();
	ПолеЭлемента.Поле = Новый ПолеКомпоновкиДанных(Элементы.МатериалыИУслугиИсточникПолученияПолуфабриката.Имя);

	ОтборЭлемента = Элемент.Отбор.Элементы.Добавить(Тип("ЭлементОтбораКомпоновкиДанных"));
	ОтборЭлемента.ЛевоеЗначение = Новый ПолеКомпоновкиДанных("Объект.МатериалыИУслуги.ПроизводитсяВПроцессе");
	ОтборЭлемента.ВидСравнения = ВидСравненияКомпоновкиДанных.Равно;
	ОтборЭлемента.ПравоеЗначение = Ложь;

	Элемент.Оформление.УстановитьЗначениеПараметра("Отображать", Ложь);
	
	#КонецОбласти
	
	// Нельзя производить ПФ, если этап выполняется силами переработчика.
	Элемент = УсловноеОформление.Элементы.Добавить();

	ПолеЭлемента = Элемент.Поля.Элементы.Добавить();
	ПолеЭлемента.Поле = Новый ПолеКомпоновкиДанных(Элементы.МатериалыИУслугиПроизводитсяВПроцессе.Имя);

	ОтборЭлемента = Элемент.Отбор.Элементы.Добавить(Тип("ЭлементОтбораКомпоновкиДанных"));
	ОтборЭлемента.ЛевоеЗначение = Новый ПолеКомпоновкиДанных("Объект.МатериалыИУслуги.ПроизводствоНаСтороне");
	ОтборЭлемента.ВидСравнения = ВидСравненияКомпоновкиДанных.Равно;
	ОтборЭлемента.ПравоеЗначение = Истина;

	Элемент.Оформление.УстановитьЗначениеПараметра("ТолькоПросмотр", Истина);
	
#КонецОбласти

#Область Серии

	//

	НоменклатураСервер.УстановитьУсловноеОформлениеСерийНоменклатуры(ЭтаФорма, "СерииВсегдаВТЧТовары", 
																     "МатериалыИУслугиСерия", 
																     "Объект.МатериалыИУслуги.СтатусУказанияСерий", 
																     "Объект.МатериалыИУслуги.ТипНоменклатуры");
																	 
#КонецОбласти

КонецПроцедуры

&НаСервере
Процедура ЗаполнитьПоляЭлементаУсловногоОформления(ЭлементУсловногоОформления, КоллекцияПолей, Исключения = Неопределено)
	
	Для каждого ЭлементКоллекции Из КоллекцияПолей Цикл
		
		Если ЗначениеЗаполнено(Исключения) И Исключения.Найти(ЭлементКоллекции.Имя) <> Неопределено Тогда
			Продолжить;
		ИначеЕсли ТипЗнч(ЭлементКоллекции) = Тип("ГруппаФормы") Тогда
			ЗаполнитьПоляЭлементаУсловногоОформления(ЭлементУсловногоОформления, ЭлементКоллекции.ПодчиненныеЭлементы, Исключения);
		КонецЕсли;
		
		ПолеЭлемента = ЭлементУсловногоОформления.Поля.Элементы.Добавить();
		ПолеЭлемента.Поле = Новый ПолеКомпоновкиДанных(ЭлементКоллекции.Имя);
		
	КонецЦикла
	
КонецПроцедуры

&НаСервереБезКонтекста
Функция ТекстЗаголовкаКолонкиКоличествоНаЕдиницуПродукции(Номенклатура, Упаковка = Неопределено)
	
	Запрос = Новый Запрос;
	
	Если ЗначениеЗаполнено(Упаковка) Тогда
		
		Запрос.Текст = 
		"ВЫБРАТЬ
		|	УпаковкиНоменклатуры.Представление КАК Представление
		|ИЗ
		|	Справочник.УпаковкиЕдиницыИзмерения КАК УпаковкиНоменклатуры
		|ГДЕ
		|	УпаковкиНоменклатуры.Ссылка = &Упаковка";
		
		Запрос.УстановитьПараметр("Упаковка", Упаковка);
		
	Иначе
		
		Запрос.Текст = 
		"ВЫБРАТЬ
		|	Номенклатура.ЕдиницаИзмерения.Представление КАК Представление
		|ИЗ
		|	Справочник.Номенклатура КАК Номенклатура
		|ГДЕ
		|	Номенклатура.Ссылка = &Номенклатура";
		
		Запрос.УстановитьПараметр("Номенклатура", Номенклатура);
		
	КонецЕсли;
	
	РезультатЗапроса = Запрос.Выполнить();
	
	Если РезультатЗапроса.Пустой() Тогда
		
		ТекстЗаголовка = НСтр("ru = 'Количество на единицу продукции';
								|en = 'Quantity per product unit'");
		
	Иначе
		
		Выборка = РезультатЗапроса.Выбрать();
		Выборка.Следующий();
		
		ТекстШаблона = НСтр("ru = 'Количество на 1 %1 продукции';
							|en = 'Quantity for 1 %1 products'");
		ТекстЗаголовка = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(ТекстШаблона, Выборка.Представление);
	
	КонецЕсли;
	
	Возврат ТекстЗаголовка;
	
КонецФункции

&НаКлиенте
Процедура СохранитьДанныеСтроки(ИмяТЧ, ДанныеСтроки)
	
	Если ИмяТЧ = "МатериалыИУслуги" Тогда
		
		СохраненныеЗначения = Новый Структура("
			|Номенклатура, Характеристика, ПроизводитсяВПроцессе,
			|Обособленно, ВариантОбеспечения, Назначение,
			|Этап,
			|СтатьяКалькуляции,
			|СпособПолученияПолуфабриката,
			|ИсточникПолученияПолуфабриката, КлючСвязиЭтапВыпуска,
			|Склад, Подразделение,
			|Упаковка, КоличествоУпаковок");
			
	ИначеЕсли ИмяТЧ = "ВыходныеИзделия" Тогда
		
		СохраненныеЗначения = Новый Структура("
			|Номенклатура, Характеристика, ПроизводитсяВПроцессе,
			|Склад, Подразделение,
			|Этап, ДоляСтоимости,
			|Упаковка, КоличествоУпаковок");
			
	ИначеЕсли ИмяТЧ = "ВозвратныеОтходы" Тогда
		
		СохраненныеЗначения = Новый Структура("
			|Номенклатура, Характеристика, ПроизводитсяВПроцессе, 
			|Склад, Подразделение,
			|Этап, СтатьяКалькуляции,
			|Упаковка, КоличествоУпаковок");
			
	ИначеЕсли ИмяТЧ = "Трудозатраты" Тогда
		
		СохраненныеЗначения = Новый Структура("ВидРабот, Количество, СтатьяКалькуляции, Этап");
		
	Иначе
		
		СохраненныеЗначения = Новый Структура;
		
	КонецЕсли;
	
	ЗаполнитьЗначенияСвойств(СохраненныеЗначения, ДанныеСтроки);
	
КонецПроцедуры

&НаКлиентеНаСервереБезКонтекста
Функция ИзменениеОбязательныхРеквизитовСтроки(Объект, ТекущиеДанные, СохраненныеЗначения)
	
	Если Не Объект.ЕстьСоответствиеСтандартнойСпецификации Или СохраненныеЗначения = Неопределено Тогда
		Возврат Ложь;
	КонецЕсли;
	
	Если Не ЗначениеЗаполнено(Объект.Спецификация) Или Не ЗначениеЗаполнено(Объект.Количество) Тогда
		Возврат Ложь;
	КонецЕсли;
	
	МассивИсключений = Новый Массив;
	
	МассивИсключений.Добавить("ПроизводитсяВПроцессе");
	МассивИсключений.Добавить("Подразделение");
	МассивИсключений.Добавить("Склад");
	
	МассивИсключений.Добавить("СпособПолученияПолуфабриката");
	
	МассивИсключений.Добавить("ВариантОбеспечения");
	МассивИсключений.Добавить("Назначение");
	
	Для каждого Элемент Из СохраненныеЗначения Цикл
		
		Если МассивИсключений.Найти(Элемент.Ключ) <> Неопределено Тогда
			Продолжить;
		КонецЕсли;
		
		Если Элемент.Значение <> ТекущиеДанные[Элемент.Ключ] Тогда
			Возврат Истина;
		КонецЕсли;
		
	КонецЦикла;
	
	Возврат Ложь;
	
КонецФункции

&НаКлиенте
Процедура ЗаполнитьПоСпецификацииКлиент()
	
	Если Объект.Количество = 0 Тогда
		
		ТекстСообщения = НСтр("ru = 'Поле ""количество"" не заполнено';
								|en = 'The ""quantity"" field is not filled in'");
		
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(
			ТекстСообщения,
			,
			"КоличествоУпаковок",
			"Объект", );
			
		Возврат;
		
	КонецЕсли;
	
	ЕстьУточненияМатериалов = Ложь;
	ЕстьУточненияПобочныхИзделий = Ложь;
	ЕстьОшибкиЗаполнения = Ложь;
	Объект.ЕстьСоответствиеСтандартнойСпецификации = Истина;
	
	ПродукцияЗаполнитьЭтапыВыходныеИзделияМатериалыИУслугиНаКлиенте();
	
	ОбновитьСостояниеСпецификацииЗаказа(ЭтаФорма);
	
КонецПроцедуры

&НаКлиенте
Процедура ПродукцияЗаполнитьЭтапыВыходныеИзделияМатериалыИУслугиНаКлиенте(ТекущиеДанные = Неопределено)
	
	МассивДанных = Новый Массив;
	ДанныеПоНоменклатуре = Новый Структура;
	
	Если ТекущиеДанные <> Неопределено Тогда
		
		ДанныеПоНоменклатуре.Вставить("КлючСвязиПродукция",             Объект.КлючСвязи);
		ДанныеПоНоменклатуре.Вставить("Номенклатура",                   ТекущиеДанные.Номенклатура);
		ДанныеПоНоменклатуре.Вставить("Характеристика",                 ТекущиеДанные.Характеристика);
		ДанныеПоНоменклатуре.Вставить("Склад",                          ТекущиеДанные.Склад);
		ДанныеПоНоменклатуре.Вставить("Подразделение",                  ТекущиеДанные.Подразделение);
		ДанныеПоНоменклатуре.Вставить("Спецификация",                   ТекущиеДанные.ИсточникПолученияПолуфабриката);
		ДанныеПоНоменклатуре.Вставить("Количество",                     ТекущиеДанные.Количество);
		ДанныеПоНоменклатуре.Вставить("Упаковка",                       ТекущиеДанные.Упаковка);
		ДанныеПоНоменклатуре.Вставить("ПодразделениеДиспетчер",         Объект.ПодразделениеДиспетчер);
		ДанныеПоНоменклатуре.Вставить("КлючСвязиЭтапы",                 ТекущиеДанные.КлючСвязиЭтапы);
		ДанныеПоНоменклатуре.Вставить("Назначение",                     Объект.Назначение);
		ДанныеПоНоменклатуре.Вставить("НазначениеЗаказа",               Объект.НазначениеЗаказа);
		ДанныеПоНоменклатуре.Вставить("ОбосабливатьПоНазначениюЗаказа", Объект.ОбосабливатьПоНазначениюЗаказа);
		ДанныеПоНоменклатуре.Вставить("НачалоПроизводства",             Объект.НачатьНеРанее);
		ДанныеПоНоменклатуре.Вставить("ЗаказатьНаСклад",                ТекущиеДанные.ЗаказатьНаСклад);
		
		КлючСвязиПолуфабрикат = ТекущиеДанные.КлючСвязи;
		
	Иначе
		
		ОчиститьТабличныеЧасти();
		
		ДанныеПоНоменклатуре.Вставить("КлючСвязиПродукция",             Объект.КлючСвязи);
		ДанныеПоНоменклатуре.Вставить("Номенклатура",                   Объект.Номенклатура);
		ДанныеПоНоменклатуре.Вставить("Характеристика",                 Объект.Характеристика);
		ДанныеПоНоменклатуре.Вставить("Склад",                          Объект.Склад);
		ДанныеПоНоменклатуре.Вставить("Подразделение",                  Объект.Подразделение);
		ДанныеПоНоменклатуре.Вставить("Спецификация",                   Объект.Спецификация);
		ДанныеПоНоменклатуре.Вставить("Количество",                     Объект.Количество);
		ДанныеПоНоменклатуре.Вставить("Упаковка",                       Объект.Упаковка);
		ДанныеПоНоменклатуре.Вставить("ПодразделениеДиспетчер",         Объект.ПодразделениеДиспетчер);
		ДанныеПоНоменклатуре.Вставить("КлючСвязиЭтапы");
		ДанныеПоНоменклатуре.Вставить("Назначение",                     Объект.Назначение);
		ДанныеПоНоменклатуре.Вставить("НазначениеЗаказа",               Объект.НазначениеЗаказа);
		ДанныеПоНоменклатуре.Вставить("ОбосабливатьПоНазначениюЗаказа", Объект.ОбосабливатьПоНазначениюЗаказа);
		ДанныеПоНоменклатуре.Вставить("НачалоПроизводства",             Объект.НачатьНеРанее);
		ДанныеПоНоменклатуре.Вставить("ЗаказатьНаСклад",                Истина);
		
		КлючСвязиПолуфабрикат = Неопределено;
		
	КонецЕсли;
	
	ДанныеПоНоменклатуре.Вставить("КлючСвязиПолуфабрикат", КлючСвязиПолуфабрикат);
	
	МассивДанных.Добавить(ДанныеПоНоменклатуре);
	
	ПродукцияЗаполнитьЭтапыВыходныеИзделияМатериалыИУслугиНаСервере(МассивДанных, КэшированныеЗначения, КлючСвязиПолуфабрикат);
	
	ОбновитьСостояниеСпецификацииЗаказа(ЭтаФорма);
	
КонецПроцедуры

&НаСервере
Процедура ПродукцияЗаполнитьЭтапыВыходныеИзделияМатериалыИУслугиНаСервере(МассивДанных, КэшированныеЗначения, КлючСвязиПолуфабрикат = Неопределено)
	
	ЗаполнятьИнформациюПоАвтовыбору = Истина;
	
	Если КлючСвязиПолуфабрикат <> Неопределено Тогда
		МатериалыИУслугиУдалитьДанныеПолуфабриката(КлючСвязиПолуфабрикат);
	КонецЕсли;
	
	ПланированиеПроизводства.ЗаполнитьСпецификациюЗаказа(
		Объект,
		МассивДанных,
		КэшированныеЗначения,
		Истина,
		ЕстьУточненияМатериалов,
		ЕстьУточненияПобочныхИзделий);
	
	ПланированиеПроизводства.ЗаполнитьКоличествоЭтаповНаЕдиницуСледующегоЭтапаРекурсивно(Объект, Объект.КлючСвязи);
	
	ПланированиеПроизводства.ПостроитьСтруктуруЭтапов(Объект.Этапы);
	
	ЗаполнитьСлужебныеРеквизиты();
	
	ЗаполнитьПараметрыПроизводственногоПроцессаНаСервере();
	
	//++ НЕ УТКА
	Если ПравоЧтенияАналогов И ПоказатьАналоги Тогда
		ОтметитьНаличиеАналогов();
	КонецЕсли;
	//-- НЕ УТКА
	ОбновитьКолонкуДоступноСервер();
	
	НастроитьОтображениеПредупрежденийПриРедактировании();
	
	ВсегоИзделий = Объект.ВыходныеИзделия.Количество() + Объект.ВозвратныеОтходы.Количество();

КонецПроцедуры

&НаСервере
Процедура ИзменениеСоставаТЧВыходныеИзделияИВозвратныеОтходыНаСервере()
	
	ВсегоИзделий = Объект.ВыходныеИзделия.Количество() + Объект.ВозвратныеОтходы.Количество();
	Если Объект.ЕстьСоответствиеСтандартнойСпецификации Тогда
		Объект.ЕстьСоответствиеСтандартнойСпецификации = Ложь;
		ОбновитьСостояниеСпецификацииЗаказа(ЭтаФорма);
		НастроитьОтображениеПредупрежденийПриРедактировании();
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Процедура ОбработатьУдалениеВыходныхИзделий()
	
	ИзменениеСоставаТЧВыходныеИзделияИВозвратныеОтходыНаСервере();
	
	ЗаполнитьКоличествоИзделийСТипомСтоимостиРассчитывается();
	
КонецПроцедуры

&НаСервере
Процедура ОбработатьОкончаниеРедактированияВыходныхИзделий(Идентификатор, НоваяСтрока, ИзменилисьОбязательныеРеквизиты)
	
	ТекущиеДанные = Объект.ВыходныеИзделия.НайтиПоИдентификатору(Идентификатор);
	Если ТекущиеДанные = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	ТипСтоимостиРассчитывается = ПредопределенноеЗначение("Перечисление.ТипыСтоимостиВыходныхИзделий.Рассчитывается");
	
	ЗаполнитьНазначениеВСтрокеТЧВыходныеИзделияНаСервере(
		ТекущиеДанные, НоваяСтрока, ТипСтоимостиРассчитывается);
	
	Если НоваяСтрока И Объект.ЕстьСоответствиеСтандартнойСпецификации
		ИЛИ ИзменилисьОбязательныеРеквизиты Тогда
		Объект.ЕстьСоответствиеСтандартнойСпецификации = Ложь;
		ОбновитьСостояниеСпецификацииЗаказа(ЭтаФорма);
		НастроитьОтображениеПредупрежденийПриРедактировании();
	КонецЕсли;
	
	ЗаполнитьКоличествоИзделийСТипомСтоимостиРассчитывается();
	
	СтатусГрафикаПроизводства = Перечисления.СтатусыГрафикаПроизводстваВЗаказеНаПроизводство.ТребуетсяРассчитать;

КонецПроцедуры

&НаСервере
Процедура ЗаполнитьКоличествоИзделийСТипомСтоимостиРассчитывается()
	
	ПараметрыОтбора = Новый Структура("КлючСвязиЭтапы");
	
	ВременнаяТаблица = Объект.ВыходныеИзделия.Выгрузить(, "КлючСвязиЭтапы");
	ВременнаяТаблица.Индексы.Добавить("КлючСвязиЭтапы");

	Для каждого Строка Из Объект.ВыходныеИзделия Цикл
		
		ПараметрыОтбора.КлючСвязиЭтапы = Строка.КлючСвязиЭтапы;
		
		КоличествоИзделий = ВременнаяТаблица.НайтиСтроки(ПараметрыОтбора).Количество();
		
		Строка.КоличествоИзделийСТипомСтоимостиРассчитывается = КоличествоИзделий;
		
	КонецЦикла;
	
КонецПроцедуры

&НаСервере
Функция ПолучитьОбъектОснования()
	
	ОбъектОснования = Объект.Ссылка;
	
	ИспользуетсяЗаказДавальца = Ложь;
	
	Если ЗначениеЗаполнено(Объект.Назначение) Тогда
		Заказ = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(Объект.Назначение, "Заказ");
		Если ЗначениеЗаполнено(Заказ) Тогда
			//++ НЕ УТКА
			ИспользуетсяЗаказДавальца = ТипЗнч(Заказ) = Тип("ДокументСсылка.ЗаказДавальца");
			//-- НЕ УТКА
			Если ИспользуетсяЗаказДавальца Тогда
				ОбъектОснования = Заказ;
			КонецЕсли;
		КонецЕсли;
	КонецЕсли;
	
	СтруктураОтвета = Новый Структура();
	СтруктураОтвета.Вставить("ОбъектОснования", ОбъектОснования);
	СтруктураОтвета.Вставить("Проведен", ОбъектОснования.Проведен);
	
	Возврат СтруктураОтвета;
	
КонецФункции

#Область Обеспечение

&НаКлиенте
Процедура МатериалыИУслугиВариантОбеспеченияПриИзмененииНаКлиенте(Ответ, ДополнительныеПараметры) Экспорт
	
	МатериалыИУслугиВариантОбеспеченияПриИзмененииНаСервере();
	
КонецПроцедуры

&НаСервере
Функция ПараметрыВыбораОбеспечения(Режим)
	
	ПараметрыФормы = ОбеспечениеВДокументахСервер.ПараметрыВыбораОбеспечения(
		ЭтотОбъект,
		Элементы.МатериалыИУслуги.ТекущаяСтрока,
		Режим);
	
	Возврат ПараметрыФормы;
	
КонецФункции

&НаКлиенте
Функция ПараметрыФормыЗапросаКоличестваИСерий(Режим)
	
	ПараметрыПроверки = ОбеспечениеКлиентСервер.ИнициализироватьПараметрыПроверкиЗаполнения(
		"МатериалыИУслуги", НСтр("ru = 'Материалы и услуги';
								|en = 'Materials and services'"));
	
	ПараметрыПроверки.Поля.Удалить("Склад");
	
	Если Не ОбеспечениеКлиент.ПроверитьЗаполнение(
			Объект,
			Объект.МатериалыИУслуги,
			Элементы.МатериалыИУслуги.ТекущаяСтрока,
			ПараметрыПроверки,
			Неопределено,
			Режим) Тогда
		Возврат Неопределено;
	КонецЕсли;
	
	ПараметрыФормы = ПараметрыВыбораОбеспечения(Режим);
	
	ТекущаяСтрока = Элементы.МатериалыИУслуги.ТекущиеДанные;
	
	ПараметрыФормы.ПараметрыУказанияСерий = ПараметрыУказанияСерий;
	ПараметрыФормы.ДопКолонкиДляУказанияСерий = Новый Структура("ЗаказатьНаСклад,ПроизводитсяВПроцессе");
	ЗаполнитьЗначенияСвойств(ПараметрыФормы.ДопКолонкиДляУказанияСерий, ТекущаяСтрока);
	
	Если ТекущаяСтрока.ПроизводитсяВПроцессе Тогда
		
		ПараметрыФормы.РазбиватьСтрокиЗапрещено = Истина;
		
	КонецЕсли;
	
	Возврат ПараметрыФормы;
	
КонецФункции

&НаСервере
Процедура МатериалыИУслугиВариантОбеспеченияПриИзмененииНаСервере()
	
	Изменения = ОбеспечениеВДокументахСервер.ВариантОбеспеченияПриИзменении(
		ЭтотОбъект,
		Элементы.МатериалыИУслуги.ТекущаяСтрока);
		
	Режим = ОбеспечениеВДокументахКлиентСервер.РежимВыборДействияНепосредственно();
	ПослеЗаполненияОбеспечения(Изменения, Режим);
	
КонецПроцедуры

&НаСервере
Функция ОбеспечениеУстановитьДействие(КодДействия)
	
	Результат = ОбеспечениеВДокументахСервер.ОбеспечениеУстановитьДействиеСтруктураРезультата();
	
	Если КодДействия = "ФЛАГ_ОБОСОБЛЕННО" Или КодДействия = "ФЛАГ_НЕОБОСОБЛЕННО" Тогда
		
		// Ограничение выбора действий для поизводимых полуфабрикатов и для не заказываемых на склад.
		Идентификаторы = Новый Массив();
		Для Каждого Идентификатор Из Элементы.МатериалыИУслуги.ВыделенныеСтроки Цикл
			
			СтрокаТовары = Объект.МатериалыИУслуги.НайтиПоИдентификатору(Идентификатор);
			Если СтрокаТовары.ЭтапВыполнен Или СтрокаТовары.Отменено Тогда
				Продолжить;
			КонецЕсли;
			
			Если КодДействия = "ФЛАГ_НЕОБОСОБЛЕННО" И СтрокаТовары.ПроизводитсяВПроцессе
				Или Не СтрокаТовары.ЗаказатьНаСклад И СтрокаТовары.ТипНоменклатуры <> Перечисления.ТипыНоменклатуры.Работа Тогда
				Продолжить;
			КонецЕсли;
			Идентификаторы.Добавить(Идентификатор);
			
		КонецЦикла;
		
		Изменения = ОбеспечениеВДокументахСервер.УстановитьДействиеОбособленно(
			КодДействия,
			ЭтотОбъект,
			Идентификаторы);
		
		Для Каждого Идентификатор Из Идентификаторы Цикл
			
			ЗаполнитьНазначениеВСтрокеТЧМатериалыИУслугиНаСервере(
				Объект.МатериалыИУслуги.НайтиПоИдентификатору(Идентификатор));
			
		КонецЦикла;
		
		СтатусГрафикаПроизводства = ПредопределенноеЗначение("Перечисление.СтатусыГрафикаПроизводстваВЗаказеНаПроизводство.ТребуетсяРассчитать");
		ОбновитьСостояниеСпецификацииЗаказа(ЭтотОбъект);
		
		ОбновитьКолонкуДоступноСервер();
		
	Иначе
		
		Форма = ЭтотОбъект;
		Результат = ОбеспечениеВДокументахСервер.ОбеспечениеУстановитьДействиеСтруктураРезультата();
		
		// Ограничение выбора действий для не заказываемых на склад.
		Идентификаторы = Новый Массив();
		Для Каждого Идентификатор Из Элементы.МатериалыИУслуги.ВыделенныеСтроки Цикл
			
			СтрокаТовары = Объект.МатериалыИУслуги.НайтиПоИдентификатору(Идентификатор);
			Если СтрокаТовары.ЭтапВыполнен Или СтрокаТовары.Отменено Тогда
				Продолжить;
			КонецЕсли;
			Если СтрокаТовары.ПроизводитсяВПроцессе Или СтрокаТовары.ТипНоменклатуры = Перечисления.ТипыНоменклатуры.Работа Тогда
				Продолжить;
			КонецЕсли;
			Идентификаторы.Добавить(Идентификатор);
			
		КонецЦикла;

		Изменения = ОбеспечениеВДокументахСервер.ИзмененияДляУстановкиДействий(
			КодДействия,
			Форма,
			Идентификаторы);
		
		НужноЗадатьВопрос = Изменения.ТаблицаИзмененийЦелымиУпаковками <> Неопределено;
		
		Если Не НужноЗадатьВопрос Тогда
			
			// Учет ограничений указания вариантов обеспечения в заказе на производство.
			Документы.ЗаказНаПроизводство.УдалитьНедопустимыеДанныеЗаполнения(
				Объект.МатериалыИУслуги,
				Ложь,
				Изменения.ТаблицаИзменений);
			
			// Перенос данных в таблицу формы.
			ОбеспечениеВДокументахСервер.УстановитьДействияИзТаблицы(Форма, Изменения.ТаблицаИзменений);
			
		Иначе
			
			АдресИзменений = ПоместитьВоВременноеХранилище(Изменения, Форма.УникальныйИдентификатор);
			Результат.АдресИзменений = АдресИзменений;
			Результат.ЗадаватьВопросОЗаполненииЦелымиУпаковками = Изменения.ТаблицаИзмененийЦелымиУпаковками <> Неопределено;
			
		КонецЕсли;
		
		Если Не НужноЗадатьВопрос Тогда
			ПослеЗаполненияОбеспечения(
				Изменения.ТаблицаИзменений,
				ОбеспечениеВДокументахКлиентСервер.РежимВыборДействия(),
				Результат);
		КонецЕсли;
		
	КонецЕсли;
	
	Возврат Результат;
	
КонецФункции

&НаКлиенте
Процедура ОбеспечениеУстановитьДействиеСВопросом(КодДействия)
	
	Результат = ОбеспечениеУстановитьДействие(КодДействия);
	
	ОбеспечениеВДокументахКлиент.ПоказатьВопросЗаполнятьОбеспечениеЦелымиУпаковками(
		ЭтотОбъект,
		Объект.МатериалыИУслуги,
		Результат,
		"ПослеВопросаЗаполнятьОбеспечениеЦелымиУпаковками");
	
КонецПроцедуры

&НаКлиенте
Процедура ПослеВопросаЗаполнятьОбеспечениеЦелымиУпаковками(Ответ, Результат) Экспорт
	
	ОбеспечениеУстановитьДействиеПослеВопроса(Ответ, Результат);
	
КонецПроцедуры

&НаСервере
Процедура ОбеспечениеУстановитьДействиеПослеВопроса(Ответ, Результат)
	
	Форма = ЭтотОбъект;
	
	Изменения = ПолучитьИзВременногоХранилища(Результат.АдресИзменений);
	УдалитьИзВременногоХранилища(Результат.АдресИзменений);
	
	ТаблицаИзменений = Неопределено;
	Если Ответ = "ДРОБНЫМИ_УПАКОВКАМИ" Или Ответ = "ОТГРУЖАТЬ_ЧАСТЯМИ_ДРОБНЫМИ_УПАКОВКАМИ" Тогда
		ТаблицаИзменений = Изменения.ТаблицаИзменений;
	Иначе
		ТаблицаИзменений = Изменения.ТаблицаИзмененийЦелымиУпаковками;
	КонецЕсли;
	
	ОбеспечениеВДокументахСервер.УстановитьДействияИзТаблицы(Форма, ТаблицаИзменений);
	
	СтруктураРезультата = Новый Структура();
	СтруктураРезультата.Вставить("ТаблицаИзменений",                ТаблицаИзменений);
	СтруктураРезультата.Вставить("СнятьФлагОТгружатьОднойДатой",    Ложь);
	СтруктураРезультата.Вставить("ЗаполнитьДатуОтгрузкиОднойДатой", Ложь);
	
	ПослеЗаполненияОбеспечения(
		СтруктураРезультата.ТаблицаИзменений,
		ОбеспечениеВДокументахКлиентСервер.РежимВыборДействия(),
		СтруктураРезультата);
	
КонецПроцедуры

&НаСервере
Процедура ПослеЗаполненияОбеспечения(Изменения, Режим = Неопределено, ПараметрыЗаполнения = Неопределено)
	
	Если ОбеспечениеВДокументахКлиентСервер.НужноПроверитьЗаполнитьДатуОтгрузкиДляСтрокОтгрузить(Режим) Тогда
		
		ОбеспечениеВДокументахСервер.ПроверитьЗаполнитьДатуОтгрузкиДляСтрокОтгрузить(
			Изменения.ВыгрузитьКолонку("Строка"),
			"ДатаПотребности",
			Ложь,
			Неопределено);
			
	КонецЕсли;
	
	ОбеспечениеВДокументахСервер.ПересчитатьКоличествоЕдиниц(Изменения);
	
	НоменклатураСервер.ЗаполнитьСтатусыУказанияСерий(Объект, ПараметрыУказанияСерий);
	
	Для Каждого Изменение Из Изменения Цикл
		
		ТекСтрока = Изменение.Строка;
		
		Если ТекСтрока.ТипНоменклатуры = Перечисления.ТипыНоменклатуры.Работа
				И ТекСтрока.ВариантОбеспечения = Перечисления.ВариантыОбеспечения.Отгрузить Тогда
				
				ТекСтрока.ВариантОбеспечения =
					?(ТекСтрока.Обособленно, Перечисления.ВариантыОбеспечения.РезервироватьПоМереПоступления, Перечисления.ВариантыОбеспечения.НеТребуется);
				
		КонецЕсли;
		
		Если ТекСтрока.ПроизводствоНаСтороне И ТекСтрока.ВариантОбеспечения = Перечисления.ВариантыОбеспечения.Отгрузить Тогда
			ТекСтрока.ВариантОбеспечения = Перечисления.ВариантыОбеспечения.СоСклада;
		КонецЕсли;
		
		Если ТекСтрока.ВариантОбеспечения = Перечисления.ВариантыОбеспечения.НеТребуется
			И ТекСтрока.ЗаказатьНаСклад Тогда
			ТекСтрока.ЗаказатьНаСклад = Ложь;
		ИначеЕсли ТекСтрока.ВариантОбеспечения <> Перечисления.ВариантыОбеспечения.НеТребуется
			И НЕ ТекСтрока.ЗаказатьНаСклад
			И ТекСтрока.ТипНоменклатуры <> Перечисления.ТипыНоменклатуры.Работа Тогда
			ТекСтрока.ЗаказатьНаСклад = Истина;
		КонецЕсли;
		
		Если НЕ ТекСтрока.ЗаказатьНаСклад Тогда
			ТекСтрока.Склад = Справочники.Склады.ПустаяСсылка();
		КонецЕсли;
		Если Не ТекСтрока.ЗаказатьНаСклад И Не ТекСтрока.ПроизводствоНаСтороне Тогда
			ТекСтрока.Обособленно = Ложь;
		КонецЕсли;
		
		Если ТекСтрока.ПроизводитсяВПроцессе Тогда
			
			ЗаполнитьНаправлениеВыпускаНаОснованииСтрокиМатериала(
				ТекСтрока, "КлючСвязиПолуфабрикат", Объект.ВыходныеИзделия);
			
			ЗаполнитьНаправлениеВыпускаНаОснованииСтрокиМатериала(
				ТекСтрока, "КлючСвязиМатериалыИУслуги", Объект.ВозвратныеОтходы);
			
		КонецЕсли;
		
		Если ТекСтрока.ЗаказатьНаСклад И Не ТекСтрока.ПроизводитсяВПроцессе Тогда
			
			Если Не ЗначениеЗаполнено(ТекСтрока.Номенклатура)
			 Или (Не ЗначениеЗаполнено(ТекСтрока.Характеристика) И ТекСтрока.ХарактеристикиИспользуются)
			 Или Не ЗначениеЗаполнено(ТекСтрока.Склад) Тогда
				
				ТекСтрока.Запланировать = Ложь;
				
			Иначе
				
				ТекСтрока.Запланировать = ПризнакПланированияПолуфабрикатов(
												ТекСтрока.ТипНоменклатуры,
												ТекСтрока.Номенклатура,
												ТекСтрока.Характеристика,
												ТекСтрока.Склад,
												Объект.ПодразделениеДиспетчер);
				
			КонецЕсли;
		
		КонецЕсли;
			
		Если ПланированиеПроизводстваКлиентСервер.НеобходимоОбновитьНазначениеВСтрокеТЧМатериалыИУслуги(
				ТекСтрока, Неопределено) Тогда
				
			ПланированиеПроизводстваКлиентСервер.ЗаполнитьНазначениеВСтрокеТЧМатериалыИУслуги(
				ТекСтрока, ДанныеПродукции);
				
		КонецЕсли;
		
		Если Объект.ЕстьСоответствиеСтандартнойСпецификации
		   И ИзменениеОбязательныхРеквизитовСтроки(Объект, ТекСтрока, СохраненныеЗначения) Тогда
			Объект.ЕстьСоответствиеСтандартнойСпецификации = Ложь;
			НастроитьОтображениеПредупрежденийПриРедактировании();
			СохраненныеЗначения = Неопределено;
		КонецЕсли;
		
	КонецЦикла;
	
	СтатусГрафикаПроизводства = ПредопределенноеЗначение("Перечисление.СтатусыГрафикаПроизводстваВЗаказеНаПроизводство.ТребуетсяРассчитать");
	ОбновитьСостояниеСпецификацииЗаказа(ЭтотОбъект);
	ОбновитьКолонкуДоступноСервер();
	
КонецПроцедуры

&НаСервере
Процедура ОбновитьКолонкуДоступноСервер()
	
	ОбеспечениеВДокументахСервер.ОбновитьКолонкуДоступно(ЭтотОбъект);
	
КонецПроцедуры

&НаКлиенте
Процедура ДобавитьДействияОбеспеченияНаКлиенте(СтруктураДействий, ПоляСтрокой, ТекущиеДанные)
	
	ПараметрыДокумента = ПараметрыДокументаДляДействийОбеспечения(ЭтотОбъект, ТекущиеДанные);
	ОбеспечениеВДокументахКлиентСервер.ДобавитьДействияОбеспечения(СтруктураДействий, ПоляСтрокой, ПараметрыДокумента);
	
КонецПроцедуры

&НаСервере
Процедура ДобавитьДействияОбеспеченияНаСервере(СтруктураДействий, ПоляСтрокой, ТекущиеДанные)
	
	ПараметрыДокумента = ПараметрыДокументаДляДействийОбеспечения(ЭтотОбъект, ТекущиеДанные);
	ОбеспечениеВДокументахКлиентСервер.ДобавитьДействияОбеспечения(СтруктураДействий, ПоляСтрокой, ПараметрыДокумента);
	
КонецПроцедуры

&НаКлиентеНаСервереБезКонтекста
Функция ПараметрыДокументаДляДействийОбеспечения(Форма, ТекущиеДанные)
	
	ВариантОбеспеченияИФлагОбособленно = ПланированиеПроизводстваКлиентСервер.ВариантОбеспеченияИФлагОбособленноПоУмолчанию(
		ТекущиеДанные.ПроизводитсяВПроцессе,
		Не ЗначениеЗаполнено(ТекущиеДанные.Склад));
	
	ПараметрыДокумента = Новый Структура();
	ПараметрыДокумента.Вставить("Форма",                              Форма);
	ПараметрыДокумента.Вставить("Коллекция",                          Форма.Объект.МатериалыИУслуги);
	ПараметрыДокумента.Вставить("ВариантОбеспеченияИФлагОбособленно", ВариантОбеспеченияИФлагОбособленно);
	
	Возврат ПараметрыДокумента;
	
КонецФункции

&НаКлиенте
Процедура ОбработатьВыборСкладаИСерии(ВыбранноеЗначение, ПараметрыФормы) Экспорт
	
	Если Не ОбеспечениеВДокументахКлиент.ЕстьПодобранныеТовары(ВыбранноеЗначение) Тогда
		Возврат;
	КонецЕсли;
	
	Оповещение = ОбработатьВыборСкладаИСерииНаСервере(ВыбранноеЗначение, ПараметрыФормы);
	ТекстОповещения = ОбеспечениеВДокументахКлиент.ТекстОповещенияОбработкиВыборСкладаИСерии(ПараметрыФормы.Режим);
	ПоказатьОповещениеПользователя(ТекстОповещения, , Оповещение);
	
КонецПроцедуры

&НаСервере
Функция ОбработатьВыборСкладаИСерииНаСервере(ВыбранноеЗначение, ПараметрыФормы)
	
	ТекущиеДанные = Объект.МатериалыИУслуги.НайтиПоИдентификатору(Элементы.МатериалыИУслуги.ТекущаяСтрока);
	Если ТекущиеДанные.ПроизводитсяВПроцессе И ВыбранноеЗначение.ПодобранныеТовары.Количество() > 1 Тогда
		Возврат НСтр("ru = 'Действие не выполнено, т.к. разбиение строки не допускается.';
					|en = 'The action is not completed as the line split is not allowed.'");
	КонецЕсли;
	
	Модифицированность = Истина;
	Изменения = ОбеспечениеВДокументахСервер.ПриВыбореСклада(
		ВыбранноеЗначение,
		ЭтотОбъект,
		Элементы.МатериалыИУслуги.ТекущаяСтрока,
		ПараметрыФормы.ЗаполняемыеПоля);
		
	ПослеЗаполненияОбеспечения(Изменения, ПараметрыФормы.Режим);
	
	ТекстОбработаноСтрок = ОбеспечениеВДокументахСервер.ТекстОбработаноСтрок(Изменения.Количество());
	Возврат ТекстОбработаноСтрок;
	
КонецФункции

#КонецОбласти

#Область ОбслуживаниеТабличнойЧастиВозвратныеОтходы

&НаСервере
Процедура ВозвратныеОтходыПослеУдаленияНаСервере()
	
	ВсегоИзделий = Объект.ВыходныеИзделия.Количество() + Объект.ВозвратныеОтходы.Количество();
	
	Если Объект.ЕстьСоответствиеСтандартнойСпецификации Тогда
		
		Объект.ЕстьСоответствиеСтандартнойСпецификации = Ложь;
		
		ОбновитьСостояниеСпецификацииЗаказа(ЭтаФорма);
		НастроитьОтображениеПредупрежденийПриРедактировании();
		
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти

#КонецОбласти

#Область ОбслуживаниеОдноэтапныхСпецификаций

&НаКлиенте
Процедура ЗаполнитьДанныеЭтапаВСтрокеДляОдноэтапнойСпецификации(ТекущиеДанные, ТекущийЭлемент = "")
	
	Если МногоэтапнаяСпецификация Тогда
		Возврат;
	КонецЕсли;
	
	Если ДанныеЭтапаОдноэтапнойСпецификации = Неопределено Тогда
		ЗаполнитьПараметрыПроизводственногоПроцесса();
	КонецЕсли;
	
	ЗаполнитьЗначенияСвойств(ТекущиеДанные, ДанныеЭтапаОдноэтапнойСпецификации);
	
	Если ТекущийЭлемент = "МатериалыИУслуги" И ТекущиеДанные.ПроизводствоНаСтороне Тогда
		ТекущиеДанные.ЗаказатьНаСклад = Истина;
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Процедура ЗаполнитьДанныеЭтапаВСтрокеДляОдноэтапнойСпецификацииНаСервере(ТекущиеДанные, ТекущийЭлемент = "")
	
	Если МногоэтапнаяСпецификация Тогда
		Возврат;
	КонецЕсли;
	
	Если ДанныеЭтапаОдноэтапнойСпецификации = Неопределено Тогда
		ЗаполнитьПараметрыПроизводственногоПроцессаНаСервере();
	КонецЕсли;
	
	ЗаполнитьЗначенияСвойств(ТекущиеДанные, ДанныеЭтапаОдноэтапнойСпецификации);
	
	Если ТекущийЭлемент = "МатериалыИУслуги" И ТекущиеДанные.ПроизводствоНаСтороне Тогда
		ТекущиеДанные.ЗаказатьНаСклад = Истина;
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ЗаполнитьПараметрыПроизводственногоПроцесса()
	
	НовоеЗначениеМногоэтапнаяСпецификация = Объект.Этапы.Количество() > 1;
	
	Если НовоеЗначениеМногоэтапнаяСпецификация И НЕ МногоэтапнаяСпецификация Тогда
		
		ДанныеЭтапаОдноэтапнойСпецификации = Неопределено;
		
	ИначеЕсли НЕ НовоеЗначениеМногоэтапнаяСпецификация 
				И (МногоэтапнаяСпецификация 
						ИЛИ ДанныеЭтапаОдноэтапнойСпецификации = Неопределено) Тогда
		
		ДанныеЭтапаОдноэтапнойСпецификации = ПолучитьДанныеЭтапаОдноэтапнойСпецификацииНаСервере(Объект.Этапы);
		
	КонецЕсли;
	
	МногоэтапнаяСпецификация = НовоеЗначениеМногоэтапнаяСпецификация;
	
КонецПроцедуры

&НаСервере
Процедура ЗаполнитьПараметрыПроизводственногоПроцессаНаСервере()
	
	НовоеЗначениеМногоэтапнаяСпецификация = Объект.Этапы.Количество() > 1;
	
	Если НовоеЗначениеМногоэтапнаяСпецификация Тогда
		
		ДанныеЭтапаОдноэтапнойСпецификации = Неопределено;
		
	ИначеЕсли НЕ НовоеЗначениеМногоэтапнаяСпецификация
				И (МногоэтапнаяСпецификация 
						ИЛИ ДанныеЭтапаОдноэтапнойСпецификации = Неопределено) Тогда
		
		ДанныеЭтапаОдноэтапнойСпецификации = ПолучитьДанныеЭтапаОдноэтапнойСпецификацииНаСервере(Объект.Этапы);
		
	КонецЕсли;
	
	МногоэтапнаяСпецификация = НовоеЗначениеМногоэтапнаяСпецификация;
	
КонецПроцедуры

&НаСервереБезКонтекста
Функция ПолучитьДанныеЭтапаОдноэтапнойСпецификацииНаСервере(Этапы)
	
	Результат = Новый Структура;
	Результат.Вставить("Этап");
	Результат.Вставить("КлючСвязиЭтапы");
	Результат.Вставить("КлючСвязиЭтапыСтрока");
	Результат.Вставить("Подразделение");
	Результат.Вставить("ПроизводствоНаСтороне");
	Результат.Вставить("НаименованиеЭтапа");
	Результат.Вставить("НаименованиеПолуфабриката");
	Результат.Вставить("ЭтапВосстановленияБрака");
	Результат.Вставить("ЭтапВыполнен");
	
	Если Этапы.Количество() > 0 И НЕ Этапы[0].ЭтапВыполнен Тогда
		
		ДанныеПервогоЭтапа = Этапы[0];
		
		Результат.Этап = ДанныеПервогоЭтапа.Этап;
		Результат.КлючСвязиЭтапы = ДанныеПервогоЭтапа.КлючСвязи;
		Результат.КлючСвязиЭтапыСтрока = Строка(ДанныеПервогоЭтапа.КлючСвязи);
		
		Результат.Подразделение = ДанныеПервогоЭтапа.Подразделение;
		Результат.ПроизводствоНаСтороне = ДанныеПервогоЭтапа.ПроизводствоНаСтороне;
		
		Результат.НаименованиеЭтапа = ДанныеПервогоЭтапа.НаименованиеЭтапа;
		Результат.НаименованиеПолуфабриката = ДанныеПервогоЭтапа.НаименованиеПолуфабриката;
		Результат.ЭтапВосстановленияБрака = ДанныеПервогоЭтапа.ЭтапВосстановленияБрака;
		Результат.ЭтапВыполнен = ДанныеПервогоЭтапа.ЭтапВыполнен;
		
	КонецЕсли;
	
	Возврат Результат; 
	
КонецФункции

#КонецОбласти

#Область ОбслуживаниеТабличнойЧастиМатериалыИУслуги

&НаКлиенте
Процедура МатериалыИУслугиОбработкаСобытияКоличествоПриИзменении(ТекущиеДанные)
	
	СтруктураДействий = Новый Структура;
	
	ПараметрыПересчетаКоличестваЕдиниц = ПланированиеПроизводстваКлиентСервер.ПараметрыПересчетаКоличестваЕдиниц(ТекущиеДанные, "МатериалыИУслуги");
	СтруктураДействий.Вставить("ПересчитатьКоличествоЕдиниц", ПараметрыПересчетаКоличестваЕдиниц);
	ДобавитьДействияОбеспеченияНаКлиенте(СтруктураДействий, "ДоступноВДругихСтроках", ТекущиеДанные);
	
	ОбработкаТабличнойЧастиКлиент.ОбработатьСтрокуТЧ(ТекущиеДанные, СтруктураДействий, КэшированныеЗначения);
	
	Если ТекущиеДанные.ПроизводитсяВПроцессе 
		И ТекущиеДанные.СпособПолученияПолуфабриката = ПредопределенноеЗначение("Перечисление.СпособыПолучениеМатериаловЭтапаПроизводства.ПроизвестиПоСпецификации")
		И СтатусЗаказаНаПроизводство = ПредопределенноеЗначение("Перечисление.СтатусыЗаказовНаПроизводство.Создан") Тогда
		
		ПродукцияЗаполнитьЭтапыВыходныеИзделияМатериалыИУслугиНаКлиенте(ТекущиеДанные);
		
	ИначеЕсли ТекущиеДанные.ПроизводитсяВПроцессе 
		И ТекущиеДанные.СпособПолученияПолуфабриката = ПредопределенноеЗначение("Перечисление.СпособыПолучениеМатериаловЭтапаПроизводства.ПроизвестиНаЭтапе") Тогда
		
		СтруктураПотребности = ПотребностьВПолуфабрикатахПоСтроке(ТекущиеДанные);
		
		ИзменитьПотребностьВоВнутреннихПолуфабрикатах(СтруктураПотребности, Истина);
		
	КонецЕсли;
		
	Если Объект.ЕстьСоответствиеСтандартнойСпецификации Тогда
		
		Объект.ЕстьСоответствиеСтандартнойСпецификации = Ложь;
		
		ОбновитьСостояниеСпецификацииЗаказа(ЭтаФорма);
		НастроитьОтображениеПредупрежденийПриРедактировании();
		
	КонецЕсли;
	
	ЗаполнитьКоличествоМатериалаНаЕдиницуИзделия(ТекущиеДанные, Объект.КоличествоУпаковок);
	
	Если ОбеспечениеВДокументахКлиент.ТребуетсяОбновитьКолонкуДоступно(СтруктураДействий) Тогда
		ОбновитьКолонкуДоступноСервер();
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Процедура ЗаполнитьСпособПолученияМатериаловПоУмолчаниюНаСервере(ТекущиеДанные)
	
	Если ТекущиеДанные.ПроизводитсяВПроцессе Тогда
		
		МатериалыИУслугиУдалитьДанныеПолуфабриката(ТекущиеДанные.КлючСвязи);
		
		ТекущиеДанные.ПроизводитсяВПроцессе = Ложь;
		ТекущиеДанные.СтатьяКалькуляции = Справочники.СтатьиКалькуляции.ПустаяСсылка();
		ТекущиеДанные.ИсточникПолученияПолуфабриката = Справочники.РесурсныеСпецификации.ПустаяСсылка();
		
	КонецЕсли;
	
	МенеджерВременныхТаблиц = Документы.ЗаказНаПроизводство.СоздатьВтСпособыПолученияМатериалов(Объект);
	
	ДанныеЗаказа = Новый Структура("ПодразделениеДиспетчер, Назначение, НачатьНеРанее, ПроизводствоПоЗаказу, Заказ");
	ЗаполнитьЗначенияСвойств(ДанныеЗаказа, Объект);
	
	ДанныеМатериала = Новый Структура("Подразделение, ПроизводствоНаСтороне, Номенклатура, Характеристика");
	ЗаполнитьЗначенияСвойств(ДанныеМатериала, ТекущиеДанные);
	
	СпособПолученияМатериала = ОбеспечениеПроизводства.СпособПолученияМатериалаПоУмолчанию(ДанныеЗаказа, ДанныеМатериала, МенеджерВременныхТаблиц);
	ЗаполнитьЗначенияСвойств(ТекущиеДанные, СпособПолученияМатериала);
	
КонецПроцедуры

&НаСервере
Процедура МатериалыИУслугиПослеУдаленияНаСервере()
	
	Если Не ЗначениеЗаполнено(УдаляемыеСтрокиМассивДанных) Тогда
		
		//++ НЕ УТКА
		Если ПравоЧтенияАналогов И ПоказатьАналоги Тогда
			ОтметитьНаличиеАналогов();
		КонецЕсли;
		//-- НЕ УТКА
		
		ОбновитьКолонкуДоступноСервер();
		
		Возврат;
		
	КонецЕсли;
	
	// удаление связанных полуфабрикатов
	
	Для каждого ДанныеСтроки Из УдаляемыеСтрокиМассивДанных Цикл
		
		Если ДанныеСтроки.ПроизводитсяВПроцессе 
			И ДанныеСтроки.СпособПолученияПолуфабриката = Перечисления.СпособыПолучениеМатериаловЭтапаПроизводства.ПроизвестиПоСпецификации Тогда
			
			МатериалыИУслугиУдалитьДанныеПолуфабриката(ДанныеСтроки.КлючСвязи);
			
		ИначеЕсли ДанныеСтроки.ПроизводитсяВПроцессе 
			И ДанныеСтроки.СпособПолученияПолуфабриката = Перечисления.СпособыПолучениеМатериаловЭтапаПроизводства.ПроизвестиНаЭтапе Тогда
			
			СтруктураПотребности = ПотребностьВПолуфабрикатахПоСтроке(ДанныеСтроки);
			ОтменитьПотребностьВоВнутреннихПолуфабрикатахНаСервере(СтруктураПотребности);
			
		КонецЕсли;
		
	КонецЦикла;
	
	ПроверитьНаличиеУточненийНоменклатурыТабличнойЧасти("МатериалыИУслуги", "ЕстьУточненияМатериалов");
	
	ОбновитьСостояниеСпецификацииЗаказа(ЭтаФорма);
	
	Если Объект.ЕстьСоответствиеСтандартнойСпецификации Тогда
		Объект.ЕстьСоответствиеСтандартнойСпецификации = Ложь;
		НастроитьОтображениеПредупрежденийПриРедактировании();
	КонецЕсли;
	
	УдаляемыеСтрокиМассивДанных = Неопределено;
	
	//++ НЕ УТКА
	Если ПравоЧтенияАналогов И ПоказатьАналоги Тогда
		ОтметитьНаличиеАналогов();
	КонецЕсли;
	//-- НЕ УТКА
	
	ОбновитьКолонкуДоступноСервер();
	
КонецПроцедуры

&НаКлиенте
Процедура ОткрытьПодборСерий(Текст = "", ТекущиеДанные = Неопределено)
	
	ПараметрыФормы = ПараметрыФормыЗапросаКоличестваИСерий(ОбеспечениеВДокументахКлиентСервер.РежимПодборСерий());
	Если ПараметрыФормы <> Неопределено Тогда
		Если ПараметрыФормы = Неопределено Тогда
			Возврат;
		КонецЕсли;
		ПараметрыФормы.Вставить("ВыборСерии", Истина);
		
		ОткрытьФорму(
			"Обработка.ЗапросКоличестваИСерий.Форма",
			ПараметрыФормы,
			ЭтотОбъект,
			,
			,
			,
			Новый ОписаниеОповещения("ОбработатьВыборСкладаИСерии", ЭтотОбъект, ПараметрыФормы));
			
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Процедура МатериалыИУслугиУдалитьДанныеПолуфабриката(КлючСвязи)
	
	Обработки.РедактированиеСпецификацииСтрокиЗаказа.УдалитьДанныеПолуфабрикатаИзСпецификации(КлючСвязи, Объект);
	
	ЗаполнитьПараметрыПроизводственногоПроцессаНаСервере();
	
	ВсегоИзделий = Объект.ВыходныеИзделия.Количество() + Объект.ВозвратныеОтходы.Количество();
	
КонецПроцедуры

&НаСервереБезКонтекста
Функция ПризнакПланированияПолуфабрикатов(ТипНоменклатуры, Номенклатура, Характеристика, Склад, ПодразделениеДиспетчер)
	
	Если Не ЗначениеЗаполнено(Склад)
			И (ТипНоменклатуры = Перечисления.ТипыНоменклатуры.Товар Или ТипНоменклатуры = Перечисления.ТипыНоменклатуры.МногооборотнаяТара)
		Или Не ЗначениеЗаполнено(ПодразделениеДиспетчер) Тогда
		
		Возврат Ложь;
		
	КонецЕсли;
	
	Запрос = Новый Запрос;
	
	Запрос.Текст =
	"ВЫБРАТЬ
	|	&Номенклатура,
	|	&Характеристика,
	|	&Склад
	|ПОМЕСТИТЬ ВТТовары
	|;
	|
	|///////////////////////////////////////
	|" + СтрЗаменить(РегистрыСведений.СхемыОбеспечения.ВременнаяТаблицаСпособыОбеспечения("ВЫЧИСЛЯТЬ"), "РАЗРЕШЕННЫЕ", "")
	+"ВЫБРАТЬ
	|	ИСТИНА КАК Запланировать
	|ИЗ
	|	ВтСпособыОбеспечения КАК Фильтр
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.СпособыОбеспеченияПотребностей КАК СпрСпособы
	|		ПО СпрСпособы.Ссылка = Фильтр.СпособОбеспеченияПотребностей
	|		И СпрСпособы.ИсточникОбеспеченияПотребностей = &ПодразделениеДиспетчер
	|		И СпрСпособы.ТипОбеспечения = ЗНАЧЕНИЕ(Перечисление.ТипыОбеспечения.Производство)
	|ГДЕ
	|	НЕ СпрСпособы.Ссылка ЕСТЬ NULL";
	
	Запрос.УстановитьПараметр("Номенклатура",            Номенклатура);
	Запрос.УстановитьПараметр("Характеристика",          Характеристика);
	Запрос.УстановитьПараметр("Склад",                   Склад);
	Запрос.УстановитьПараметр("ПодразделениеДиспетчер",  ПодразделениеДиспетчер);
	
	УстановитьПривилегированныйРежим(Истина);
	Результат = Запрос.Выполнить();
	
	Возврат Не Результат.Пустой();
	
КонецФункции

&НаКлиентеНаСервереБезКонтекста
Функция ЗаполнитьКоличествоМатериалаНаЕдиницуИзделия(ТекущиеДанные, ИзделиеКоличествоУпаковок)
	
	Если ИзделиеКоличествоУпаковок > 0 Тогда
		
		ТекущиеДанные.КоличествоНаЕдиницуИзделия = ТекущиеДанные.КоличествоУпаковок / ИзделиеКоличествоУпаковок;
		
	Иначе
		
		ТекущиеДанные.КоличествоНаЕдиницуИзделия = ТекущиеДанные.КоличествоУпаковок;
		
	КонецЕсли;
	
КонецФункции

&НаСервере
Функция ПоместитьТаблицуДоступныхДляВыбораЭтаповВыпускаПолуфабрикатаВХранилище()
	
	Адрес = Неопределено;
	
	ТекущаяСтрока = Элементы.МатериалыИУслуги.ТекущаяСтрока;
	ТекущиеДанные = Объект.МатериалыИУслуги.НайтиПоИдентификатору(ТекущаяСтрока);
	
	Если ЗначениеЗаполнено(ТекущиеДанные.Этап)
		И ЗначениеЗаполнено(ТекущиеДанные.Номенклатура)
		И (ТекущиеДанные.ХарактеристикиИспользуются И ЗначениеЗаполнено(ТекущиеДанные.Характеристика)
			ИЛИ НЕ ТекущиеДанные.ХарактеристикиИспользуются) Тогда
			
		// Таблица этапов
		ТаблицаЭтапов = Новый ТаблицаЗначений;
		
		ТаблицаЭтапов.Колонки.Добавить("НомерЭтапа", Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(4, 0, ДопустимыйЗнак.Неотрицательный)));
		ТаблицаЭтапов.Колонки.Добавить("НомерСледующегоЭтапа", Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(4, 0, ДопустимыйЗнак.Неотрицательный)));
		ТаблицаЭтапов.Колонки.Добавить("НомерЭтапаФорма", Новый ОписаниеТипов("Строка", , Новый КвалификаторыСтроки(7)));
		ТаблицаЭтапов.Колонки.Добавить("НомерСледующегоЭтапаФорма", Новый ОписаниеТипов("Строка", , Новый КвалификаторыСтроки(7)));
		ТаблицаЭтапов.Колонки.Добавить("Этап", Новый ОписаниеТипов("СправочникСсылка.ЭтапыПроизводства"));
		ТаблицаЭтапов.Колонки.Добавить("Количество", Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(15, 3, ДопустимыйЗнак.Неотрицательный)));
		ТаблицаЭтапов.Колонки.Добавить("КлючСвязиСтрока", Новый ОписаниеТипов("Строка", , Новый КвалификаторыСтроки(36)));
		ТаблицаЭтапов.Колонки.Добавить("НаименованиеЭтапа", Новый ОписаниеТипов("Строка"));
		ТаблицаЭтапов.Колонки.Добавить("НаименованиеПолуфабриката", Новый ОписаниеТипов("Строка"));
		ТаблицаЭтапов.Колонки.Добавить("Подразделение", Новый ОписаниеТипов("СправочникСсылка.СтруктураПредприятия"));
		
		ПараметрыОтбора = Новый Структура;
		ПараметрыОтбора.Вставить("ЭтапВыполнен", Ложь);
		ПараметрыОтбора.Вставить("ПроизводствоНаСтороне", Ложь);
		
		НомерТекущегоЭтапа = 0;
		
		Для каждого ЭлементКоллекции Из Объект.Этапы.НайтиСтроки(ПараметрыОтбора) Цикл
			
			Если ЭлементКоллекции.КлючСвязи = ТекущиеДанные.КлючСвязиЭтапы Тогда
				НомерТекущегоЭтапа = ЭлементКоллекции.НомерЭтапа;
			КонецЕсли;
			
			НоваяСтрока = ТаблицаЭтапов.Добавить();
			
			ЗаполнитьЗначенияСвойств(НоваяСтрока, ЭлементКоллекции);
			
			НоваяСтрока.КлючСвязиСтрока = Строка(ЭлементКоллекции.КлючСвязи);
			
		КонецЦикла;
		
		// Таблица полуфабрикатов
		ТаблицаПолуфабрикатов = Новый ТаблицаЗначений;
		ТаблицаПолуфабрикатов.Колонки.Добавить("Этап", Новый ОписаниеТипов("СправочникСсылка.ЭтапыПроизводства"));
		ТаблицаПолуфабрикатов.Колонки.Добавить("КлючСвязиСтрока", Новый ОписаниеТипов("Строка", , Новый КвалификаторыСтроки(36)));
		ТаблицаПолуфабрикатов.Колонки.Добавить("Количество", Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(15, 3, ДопустимыйЗнак.Неотрицательный)));

		ПараметрыОтбора = Новый Структура;
		ПараметрыОтбора.Вставить("Номенклатура", ТекущиеДанные.Номенклатура);
		
		Если ТекущиеДанные.ХарактеристикиИспользуются Тогда
			
			ПараметрыОтбора.Вставить("Характеристика", ТекущиеДанные.Характеристика);
			
		КонецЕсли;
		
		ПараметрыОтбора.Вставить("ЭтапВыполнен", Ложь);
		ПараметрыОтбора.Вставить("НаправлениеВыпуска", Перечисления.ХозяйственныеОперации.ВыпускПродукцииНаСклад);
		
		Для каждого ЭлементКоллекции Из Объект.ВозвратныеОтходы.НайтиСтроки(ПараметрыОтбора) Цикл
			
			НоваяСтрока = ТаблицаПолуфабрикатов.Добавить();
			
			ЗаполнитьЗначенияСвойств(НоваяСтрока, ЭлементКоллекции);
			
			НоваяСтрока.КлючСвязиСтрока = Строка(ЭлементКоллекции.КлючСвязиЭтапы);
			
		КонецЦикла;
		
		ТаблицаПолуфабрикатов.Свернуть("Этап, КлючСвязиСтрока", "Количество");
		
		// Таблица этапов для выбора
		Запрос = Новый Запрос;
		
		Запрос.УстановитьПараметр("Этап",      ТекущиеДанные.Этап);
		Запрос.УстановитьПараметр("НомерЭтап", НомерТекущегоЭтапа);
		
		Запрос.УстановитьПараметр("Номенклатура", ТекущиеДанные.Номенклатура);
		Запрос.УстановитьПараметр("Упаковка",     ТекущиеДанные.Упаковка);
		Запрос.УстановитьПараметр("Количество",   ТекущиеДанные.Количество);
		
		Запрос.УстановитьПараметр("ТаблицаЭтапов", ТаблицаЭтапов);
		Запрос.УстановитьПараметр("ТаблицаПолуфабрикатов", ТаблицаПолуфабрикатов);
		
		ТекстЗапроса = 
		"ВЫБРАТЬ
		|	Таблица.НомерЭтапа КАК НомерЭтапа,
		|	Таблица.НомерСледующегоЭтапа КАК НомерСледующегоЭтапа,
		|	Таблица.НомерЭтапаФорма КАК НомерЭтапаФорма,
		|	Таблица.НомерСледующегоЭтапаФорма КАК НомерСледующегоЭтапаФорма,
		|	Таблица.Этап КАК Этап,
		|	Таблица.Количество КАК Количество,
		|	Таблица.КлючСвязиСтрока КАК КлючСвязиСтрока,
		|	Таблица.НаименованиеЭтапа КАК НаименованиеЭтапа,
		|	Таблица.НаименованиеПолуфабриката КАК НаименованиеПолуфабриката,
		|	Таблица.Подразделение КАК Подразделение
		|ПОМЕСТИТЬ ВТТаблицаЭтапов
		|ИЗ
		|	&ТаблицаЭтапов КАК Таблица
		|ГДЕ
		|	Таблица.НомерЭтапа < &НомерЭтап
		|	И Таблица.НомерСледующегоЭтапа <> 0
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	Таблица.Этап КАК Этап,
		|	Таблица.КлючСвязиСтрока КАК КлючСвязиСтрока,
		|	Таблица.Количество КАК Количество
		|ПОМЕСТИТЬ ВТТаблицаПолуфабрикатов
		|ИЗ
		|	&ТаблицаПолуфабрикатов КАК Таблица
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ТаблицаЭтапов.Этап КАК Этап,
		|	ТаблицаЭтапов.НаименованиеЭтапа КАК НаименованиеЭтапа,
		|	ТаблицаЭтапов.НаименованиеПолуфабриката КАК НаименованиеПолуфабриката,
		|	ТаблицаЭтапов.КлючСвязиСтрока КАК КлючСвязиСтрока,
		|	ТаблицаЭтапов.НомерЭтапаФорма КАК НомерЭтапаФорма,
		|	ТаблицаЭтапов.НомерСледующегоЭтапаФорма КАК НомерСледующегоЭтапаФорма,
		|	ТаблицаЭтапов.Подразделение КАК Подразделение,
		|	ЛОЖЬ КАК ПроизводствоНаСтороне,
		|	ЛОЖЬ КАК ЭтапВыполнен,
		|	ТаблицаЭтапов.Количество КАК Количество,
		|	ЕСТЬNULL(ТаблицаПолуфабрикатов.Количество, 0) / ВЫБОР
		|		КОГДА &Упаковка <> ЗНАЧЕНИЕ(Справочник.УпаковкиЕдиницыИзмерения.ПустаяСсылка)
		|			ТОГДА &ТекстЗапросаКоэффициентУпаковки
		|		ИНАЧЕ 1
		|	КОНЕЦ КАК КоличествоИзделия,
		|	ВЫБОР
		|		КОГДА ЕСТЬNULL(ТаблицаПолуфабрикатов.Количество, 0) >= &Количество
		|			ТОГДА ИСТИНА
		|		ИНАЧЕ ЛОЖЬ
		|	КОНЕЦ КАК КоличествоИзделияДостаточно,
		|	ВЫБОР
		|		КОГДА &Упаковка <> ЗНАЧЕНИЕ(Справочник.УпаковкиЕдиницыИзмерения.ПустаяСсылка)
		|			ТОГДА ВЫРАЗИТЬ(&Упаковка КАК Справочник.УпаковкиЕдиницыИзмерения).Представление
		|		ИНАЧЕ ВЫРАЗИТЬ(&Номенклатура КАК Справочник.Номенклатура).ЕдиницаИзмерения.Представление
		|	КОНЕЦ КАК УпаковкаИзделияПредставление
		|ИЗ
		|	ВТТаблицаЭтапов КАК ТаблицаЭтапов
		|		ЛЕВОЕ СОЕДИНЕНИЕ ВТТаблицаПолуфабрикатов КАК ТаблицаПолуфабрикатов
		|		ПО ТаблицаЭтапов.КлючСвязиСтрока = ТаблицаПолуфабрикатов.КлючСвязиСтрока
		|
		|УПОРЯДОЧИТЬ ПО
		|	ТаблицаЭтапов.НомерЭтапа";
		
		ТекстЗапроса = СтрЗаменить(ТекстЗапроса,
									"&ТекстЗапросаКоэффициентУпаковки",
									Справочники.УпаковкиЕдиницыИзмерения.ТекстЗапросаКоэффициентаУпаковки("ВЫРАЗИТЬ(&Упаковка КАК Справочник.УпаковкиЕдиницыИзмерения)",
																										"ВЫРАЗИТЬ(&Номенклатура КАК Справочник.Номенклатура)"));
		
		Запрос.Текст = ТекстЗапроса;
		
		РезультатЗапроса = Запрос.Выполнить();
		
		ТаблицаЭтапов = Неопределено;
		ТаблицаПолуфабрикатов = Неопределено;
		
		Если Не РезультатЗапроса.Пустой() Тогда
			
			ТаблицаЭтапов = Новый ТаблицаЗначений;
			
			ТаблицаЭтапов.Колонки.Добавить("Этап");
			ТаблицаЭтапов.Колонки.Добавить("НаименованиеЭтапа");
			ТаблицаЭтапов.Колонки.Добавить("НаименованиеПолуфабриката");
			ТаблицаЭтапов.Колонки.Добавить("КлючСвязи");
			ТаблицаЭтапов.Колонки.Добавить("НомерЭтапаФорма");
			ТаблицаЭтапов.Колонки.Добавить("НомерСледующегоЭтапаФорма");
			ТаблицаЭтапов.Колонки.Добавить("Подразделение");
			ТаблицаЭтапов.Колонки.Добавить("ПроизводствоНаСтороне");
			ТаблицаЭтапов.Колонки.Добавить("ЭтапВыполнен");
			ТаблицаЭтапов.Колонки.Добавить("Количество");
			
			ТаблицаЭтапов.Колонки.Добавить("КоличествоИзделия");
			ТаблицаЭтапов.Колонки.Добавить("КоличествоИзделияДостаточно");
			ТаблицаЭтапов.Колонки.Добавить("УпаковкаИзделияПредставление");
			
			Выборка = РезультатЗапроса.Выбрать();
			
			Пока Выборка.Следующий() Цикл
				
				НоваяСтрока = ТаблицаЭтапов.Добавить();
				
				ЗаполнитьЗначенияСвойств(НоваяСтрока, Выборка);
				
				НоваяСтрока.КлючСвязи = Новый УникальныйИдентификатор(Выборка.КлючСвязиСтрока);
				
			КонецЦикла;
			
			Адрес = ПоместитьВоВременноеХранилище(ТаблицаЭтапов, УникальныйИдентификатор);
			
		КонецЕсли;
		
	КонецЕсли;
	
	Возврат Адрес;
	
КонецФункции

&НаКлиенте
Процедура ПриИзмененииПараметровПроизводитсяВПроцессе()

	ТекущиеДанные = Элементы.МатериалыИУслуги.ТекущиеДанные;
	
	Если ТекущиеДанные = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	Если СохраненныеЗначения.СпособПолученияПолуфабриката = ПредопределенноеЗначение("Перечисление.СпособыПолучениеМатериаловЭтапаПроизводства.ПроизвестиПоСпецификации")
		И СохраненныеЗначения.СпособПолученияПолуфабриката <> ТекущиеДанные.СпособПолученияПолуфабриката
		И ЗначениеЗаполнено(СохраненныеЗначения.ИсточникПолученияПолуфабриката) Тогда
		
		ТекстВопроса = НСтр("ru = 'Изменение настройки приведет к удалению данных спецификации полуфабриката. Продолжить?';
							|en = 'Changing the setting will delete the data of semi-finished product BOM. Continue?'");
		
		ОписаниеОповещения = Новый ОписаниеОповещения("УдалитьДанныеПолуфабрикатаЗавершение", ЭтотОбъект, Новый Структура("ТекущиеДанные", ТекущиеДанные));
		ПоказатьВопрос(ОписаниеОповещения, ТекстВопроса, РежимДиалогаВопрос.ДаНет);
		
		Возврат;
		
	ИначеЕсли СохраненныеЗначения.СпособПолученияПолуфабриката = ПредопределенноеЗначение("Перечисление.СпособыПолучениеМатериаловЭтапаПроизводства.ПроизвестиНаЭтапе") Тогда
		
		Если СохраненныеЗначения.СпособПолученияПолуфабриката = ТекущиеДанные.СпособПолученияПолуфабриката
			И СохраненныеЗначения.ИсточникПолученияПолуфабриката = ТекущиеДанные.ИсточникПолученияПолуфабриката
			И СохраненныеЗначения.КлючСвязиЭтапВыпуска = ТекущиеДанные.КлючСвязиЭтапВыпуска Тогда
			
			Возврат;
			
		КонецЕсли;
		
		ОтменитьПотребностьВоВнутреннихПолуфабрикатах(ТекущиеДанные);
		
	КонецЕсли;
	
	Идентификатор = ТекущиеДанные.ПолучитьИдентификатор();
	ПослеИзмененияПараметровПроизводитсяВПроцессе(Идентификатор);
	
КонецПроцедуры

&НаКлиенте
Процедура УдалитьДанныеПолуфабрикатаЗавершение(РезультатВопроса, ДополнительныеПараметры) Экспорт
	
	ТекущиеДанные = ДополнительныеПараметры.ТекущиеДанные;
	
	Если РезультатВопроса <> КодВозвратаДиалога.Да Тогда
		ТекущиеДанные.ПроизводитсяВПроцессе = СохраненныеЗначения.ПроизводитсяВПроцессе;
		ТекущиеДанные.СпособПолученияПолуфабриката = СохраненныеЗначения.СпособПолученияПолуфабриката;
		Возврат;
	КонецЕсли;
	
	МатериалыИУслугиУдалитьДанныеПолуфабриката(ТекущиеДанные.КлючСвязи);
	
	Если НЕ ТекущиеДанные.ПроизводитсяВПроцессе Тогда
		ТекущиеДанные.СпособПолученияПолуфабриката = ПредопределенноеЗначение("Перечисление.СпособыПолучениеМатериаловЭтапаПроизводства.ПустаяСсылка");
	КонецЕсли;
	ТекущиеДанные.ИсточникПолученияПолуфабриката = ПредопределенноеЗначение("Справочник.РесурсныеСпецификации.ПустаяСсылка");
	
	Идентификатор = ТекущиеДанные.ПолучитьИдентификатор();
	ПослеИзмененияПараметровПроизводитсяВПроцессе(Идентификатор);

КонецПроцедуры

&НаСервере
Процедура ПослеИзмененияПараметровПроизводитсяВПроцессе(Знач Идентификатор)
	
	ТекущиеДанные = Объект.МатериалыИУслуги.НайтиПоИдентификатору(Идентификатор);
	
	Если ТекущиеДанные.ПроизводитсяВПроцессе Тогда
		
		ТекущиеДанные.СтатьяКалькуляции = ПредопределенноеЗначение("Справочник.СтатьиКалькуляции.ПолуфабрикатыПроизводимыеВПроцессе");
		Если НЕ ЗначениеЗаполнено(ТекущиеДанные.СпособПолученияПолуфабриката) Тогда
			ТекущиеДанные.СпособПолученияПолуфабриката = ПредопределенноеЗначение("Перечисление.СпособыПолучениеМатериаловЭтапаПроизводства.ПроизвестиПоСпецификации");
		КонецЕсли;
		
		Если ТекущиеДанные.СпособПолученияПолуфабриката = ПредопределенноеЗначение("Перечисление.СпособыПолучениеМатериаловЭтапаПроизводства.ПроизвестиНаЭтапе")
			И ТипЗнч(ТекущиеДанные.ИсточникПолученияПолуфабриката) <> Тип("СправочникСсылка.ЭтапыПроизводства") Тогда
			ТекущиеДанные.ИсточникПолученияПолуфабриката = ПредопределенноеЗначение("Справочник.ЭтапыПроизводства.ПустаяСсылка");
		ИначеЕсли ТекущиеДанные.СпособПолученияПолуфабриката = ПредопределенноеЗначение("Перечисление.СпособыПолучениеМатериаловЭтапаПроизводства.ПроизвестиПоСпецификации")
			И ТипЗнч(ТекущиеДанные.ИсточникПолученияПолуфабриката) <> Тип("СправочникСсылка.РесурсныеСпецификации") Тогда
			ТекущиеДанные.ИсточникПолученияПолуфабриката = ПредопределенноеЗначение("Справочник.РесурсныеСпецификации.ПустаяСсылка");
		КонецЕсли;
		
		СтруктураДействий = Новый Структура();
		ДобавитьДействияОбеспеченияНаСервере(СтруктураДействий, "ВариантОбеспечения", ТекущиеДанные);
		ОбработкаТабличнойЧастиСервер.ОбработатьСтрокуТЧ(ТекущиеДанные, СтруктураДействий, Неопределено);

	Иначе
		
		ТекущиеДанные.СпособПолученияПолуфабриката = ПредопределенноеЗначение("Перечисление.СпособыПолучениеМатериаловЭтапаПроизводства.ПустаяСсылка");
		ТекущиеДанные.ИсточникПолученияПолуфабриката = ПредопределенноеЗначение("Справочник.РесурсныеСпецификации.ПустаяСсылка");
		ТекущиеДанные.КлючСвязиЭтапВыпуска = Неопределено;
		
		Если СохраненныеЗначения.ПроизводитсяВПроцессе
			И ТекущиеДанные.СтатьяКалькуляции = ПредопределенноеЗначение("Справочник.СтатьиКалькуляции.ПолуфабрикатыПроизводимыеВПроцессе") Тогда
		
			ТекущиеДанные.СтатьяКалькуляции = ПредопределенноеЗначение("Справочник.СтатьиКалькуляции.ПустаяСсылка");
		КонецЕсли;
		
		ЗаполнитьСпособПолученияМатериаловПоУмолчаниюНаСервере(ТекущиеДанные);
		
	КонецЕсли;
	
	СтруктураДействий = Новый Структура();
	СтруктураДействий.Вставить("ПроверитьСериюРассчитатьСтатус", Новый Структура("Склад, ПараметрыУказанияСерий", ТекущиеДанные.Склад, ПараметрыУказанияСерий));
	ОбработкаТабличнойЧастиСервер.ОбработатьСтрокуТЧ(ТекущиеДанные, СтруктураДействий, Неопределено);
	
	//++ НЕ УТКА
	Если ПравоЧтенияАналогов И ПоказатьАналоги Тогда 
		ОтметитьНаличиеАналогов();
	КонецЕсли;
	//-- НЕ УТКА
	ОбновитьКолонкуДоступноСервер();
	
КонецПроцедуры

#Область УточненияНоменклатуры

&НаСервере
Процедура ПроверитьНаличиеУточненийНоменклатурыТабличнойЧасти(ИмяТЧ, Реквизит)
	
	НайденныеСтроки = Объект[ИмяТЧ].НайтиСтроки(Новый Структура("ИспользуетсяАвтовыбор", Истина));
	
	Для каждого Строка Из НайденныеСтроки Цикл
		
		Если (Строка.Номенклатура.Пустая()
			ИЛИ Строка.Характеристика.Пустая() И Строка.ХарактеристикиИспользуются И ХарактеристикиИспользуются) Тогда
			
			ЭтаФорма[Реквизит] = Истина;
			
			Возврат;
			
		КонецЕсли;
		
	КонецЦикла;
	
	Если ЭтаФорма[Реквизит] Тогда
		ЭтаФорма[Реквизит] = Ложь;
		ОбновитьСостояниеСпецификацииЗаказа = Истина;
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти

//++ НЕ УТКА
#Область МатериалыИУслугиАналоги

&НаСервере
Процедура ОтметитьНаличиеАналогов()
	
	ИмяТаблицы = "МатериалыИУслуги";
	АналогиМатериалов.ОтметитьНаличиеАналогов(Объект[ИмяТаблицы], ПараметрыВыбораАналогов(ИмяТаблицы, 0));
	
КонецПроцедуры

&НаКлиенте
Процедура ОткрытьПодборАналогов()
	
	ИмяТаблицы = "МатериалыИУслуги";
	ТекстПредупреждения = "";
	
	ВыделенныеСтроки = Элементы[ИмяТаблицы].ВыделенныеСтроки;
	Если ВыделенныеСтроки.Количество() = 0 Тогда
		ТекстПредупреждения = НСтр("ru = 'Необходимо выделить строку(и)';
									|en = 'Highlight the line(s)'");
	Иначе
		
		ВыделенныеЭтапы = Новый Массив;
		
		Для каждого ИдентификаторСтроки Из ВыделенныеСтроки Цикл
			
			СтрокаТаблицы = Объект[ИмяТаблицы].НайтиПоИдентификатору(ИдентификаторСтроки);
			
			Если ВыделенныеЭтапы.Количество() = 0 Тогда
				ВыделенныеЭтапы.Добавить(СтрокаТаблицы.Этап);
			ИначеЕсли ВыделенныеЭтапы.Найти(СтрокаТаблицы.Этап) = Неопределено Тогда
				ТекстПредупреждения = НСтр("ru = 'Необходимо выбрать строки одного этапа';
											|en = 'Select lines of the same step'");
				Прервать;
			КонецЕсли;
			
		КонецЦикла;
		
	КонецЕсли;
	
	Если ЗначениеЗаполнено(ТекстПредупреждения) Тогда
		ПоказатьПредупреждение(, ТекстПредупреждения);
		Возврат;
	КонецЕсли;	
	
	АналогиМатериаловКлиент.ОткрытьПодборАналогов(ПараметрыВыбораАналогов(ИмяТаблицы, 1), ЭтаФорма);
	
КонецПроцедуры

&НаСервере
Процедура ЗаменитьНаАналоги(АдресВХранилище)
	
 	ИмяТаблицы = "МатериалыИУслуги";
	ДополнительныеПоля = "Этап, КлючСвязиЭтапы, КлючСвязиЭтапыСтрока, "
						 + "Подразделение, ПроизводствоНаСтороне, "
						 + "НаименованиеЭтапа, НаименованиеПолуфабриката, "
						 + "ЭтапВосстановленияБрака, ЭтапВыполнен, "
						 + "ДатаПотребности, Назначение, СтатьяКалькуляции, "
						 + "СпособПолученияПолуфабриката, ИсточникПолученияПолуфабриката";
	
	Результат = АналогиМатериалов.ВыполнитьЗаменуНаАналоги(
		Объект[ИмяТаблицы], АдресВХранилище, ДополнительныеПоля, "ДЕЙСТВИЕ_АНАЛОГИ_РЕЗЕРВИРОВАТЬ");
	
	ИндексыИзмененныхСтрок = Результат.ИндексыИзмененныхСтрок;
	ИндексыНовыхСтрок = Результат.ИндексыНовыхСтрок;
	
	КоличествоПроизведенныхЗамен = ИндексыИзмененныхСтрок.Количество() + ИндексыНовыхСтрок.Количество();
	ТекстСообщения  = СтрШаблон(НСтр("ru = 'Количество проведенных замен: %1';
									|en = 'Number of replacements: %1'"), КоличествоПроизведенныхЗамен);
	ОбщегоНазначения.СообщитьПользователю(ТекстСообщения);

	Если КоличествоПроизведенныхЗамен = 0 Тогда
		Возврат;
	КонецЕсли;
	
	Модифицированность = Истина;
	
	ДатаПоУмолчанию = Макс(НачалоДня(ТекущаяДатаСеанса()), Объект.НачатьНеРанее);
	
	Для каждого ИндексСтроки Из ИндексыНовыхСтрок Цикл
		
		СтрокаТЧ = Объект[ИмяТаблицы][ИндексСтроки];
		
		СтрокаТЧ.КлючСвязи = Новый УникальныйИдентификатор;
		СтрокаТЧ.КлючСвязиПродукция = Объект.КлючСвязи;
		
		СтруктураДействий = Новый Структура();
		ДобавитьДействияОбеспеченияНаСервере(СтруктураДействий, "ВариантОбеспечения", СтрокаТЧ);
		Если Не ЗначениеЗаполнено(СтрокаТЧ.ВариантОбеспечения) Тогда
			ОбработкаТабличнойЧастиСервер.ОбработатьСтрокуТЧ(СтрокаТЧ, СтруктураДействий, Неопределено);
		КонецЕсли;
		
		Если Не ЗначениеЗаполнено(СтрокаТЧ.ДатаПотребности) Тогда
			СтрокаТЧ.ДатаПотребности = ДатаПоУмолчанию;
		КонецЕсли;	
		
		Если Не ЗначениеЗаполнено(СтрокаТЧ.Назначение) Тогда
			ЗаполнитьНазначениеВСтрокеТЧМатериалыИУслугиНаСервере(СтрокаТЧ, Истина);
		КонецЕсли;
		
		СтрокаТЧ.Обособленно = ЗначениеЗаполнено(СтрокаТЧ.Назначение);
		
		ЗаполнитьКоличествоМатериалаНаЕдиницуИзделия(СтрокаТЧ, Объект.КоличествоУпаковок);
		
	КонецЦикла;
	
	СтатусГрафикаПроизводства = Перечисления.СтатусыГрафикаПроизводстваВЗаказеНаПроизводство.ТребуетсяРассчитать;
	
	СтруктураДействий = Новый Структура;
	СтруктураДействий.Вставить("ЗаполнитьПризнакХарактеристикиИспользуются",
								Новый Структура("Номенклатура", "ХарактеристикиИспользуются"));
	СтруктураДействий.Вставить("ЗаполнитьПризнакТипНоменклатуры",
								Новый Структура("Номенклатура", "ТипНоменклатуры"));
	СтруктураДействий.Вставить("ЗаполнитьПризнакАртикул",
								Новый Структура("Номенклатура", "Артикул"));
	
	НоменклатураСервер.ЗаполнитьСлужебныеРеквизитыПоНоменклатуреВКоллекции(Объект.МатериалыИУслуги, СтруктураДействий);
	НоменклатураСервер.ЗаполнитьСтатусыУказанияСерий(Объект, ПараметрыУказанияСерий);
	ОбновитьКолонкуДоступноСервер();
	
КонецПроцедуры

// Формирует параметры выбора аналогов
//
// Параметры:
//	ИмяТаблицы - Строка - Имя обрабатываемой таблицы
//	Режим      - Число  - 0 - показать аналоги
//                        1 - подобрать аналоги
//                        2 - заменить аналогами
// 
// Возвращаемое значение:
//  Структура - см. АналогиМатериалов.ПараметрыВыбораАналогов
//
&НаСервере
Функция ПараметрыВыбораАналогов(ИмяТаблицы, Режим)

	ТипИсточника = Новый ОписаниеТипов("СправочникСсылка.ЭтапыПроизводства");
	ПараметрыФормы = АналогиМатериалов.ПараметрыВыбораАналогов(ТипИсточника);
	
	// ПараметрыОбщие
	ПараметрыФормы.ПараметрыОбщие.ПоказатьОстатки = Истина;	
	
	// ПараметрыТоваров
	СтруктураПолей = АналогиМатериалов.СтруктураПолейТаблицыДляЗаменыНаАналоги();
	СтруктураПолей.ДополнительныеПоля.Вставить("Ссылка", Новый ОписаниеТипов("СправочникСсылка.ЭтапыПроизводства"));
	СтруктураПолей.ПодменяемыеПоля.Вставить("Ссылка", "Этап");
	
	ОтборСтрок = Новый Структура;
	ОтборСтрок.Вставить("ПроизводитсяВПроцессе", Новый Массив);
	ОтборСтрок.Вставить("Отменено", Новый Массив);
	
	ОтборСтрок.ПроизводитсяВПроцессе.Добавить(Ложь);
	ОтборСтрок.Отменено.Добавить(Ложь);
	
	ИмяОбъекта = "Объект";
	
	ДанныеФормы = Новый Структура;
	ДанныеФормы.Вставить("Элементы", Элементы);
	ДанныеФормы.Вставить("УникальныйИдентификатор", УникальныйИдентификатор);
	ДанныеФормы.Вставить("Модифицированность", Модифицированность);
	ДанныеФормы.Вставить("ДоступныеОстаткиПараметрыВстраивания", ДоступныеОстаткиПараметрыВстраивания);
	ДанныеФормы.Вставить("АдресДвиженийЗаказа", АдресДвиженийЗаказа);
	ДанныеФормы.Вставить(ИмяОбъекта, Новый Структура);
	
	ДанныеФормы[ИмяОбъекта].Вставить(ИмяТаблицы, Объект[ИмяТаблицы]);
	ДанныеФормы[ИмяОбъекта].Вставить("СтатусЗаказаНаПроизводство", Объект.СтатусЗаказаНаПроизводство);
	ДанныеФормы[ИмяОбъекта].Вставить("НачатьНеРанее", Объект.НачатьНеРанее);
	ДанныеФормы[ИмяОбъекта].Вставить("Назначение", Объект.Назначение);
	ДанныеФормы[ИмяОбъекта].Вставить("Ссылка", Объект.Ссылка);
	
	ДопПараметры = АналогиМатериалов.ДополнительныеПараметры();
	ДопПараметры.ОтборСтрок = ОтборСтрок;
	
	ДанныеТоваров = АналогиМатериалов.ПолучитьДанныеТоваров(
		ДанныеФормы, ИмяОбъекта, ИмяТаблицы, Режим, Истина, СтруктураПолей, ДопПараметры);
		
	ЗаполнитьЗначенияСвойств(ПараметрыФормы.ПараметрыТоваров, ДанныеТоваров);
	
	// ПараметрыАналогов
	ТаблицаПараметров = ПараметрыФормы.ПараметрыАналогов.ТаблицаПараметров;
	
	СтруктураДанных = Новый Структура;
	СтруктураДанных.Вставить("ДатаДействияРазрешений", НачалоДня(Объект.ДатаПотребности));
	СтруктураДанных.Вставить("ЗаказНаПроизводство", Объект.Ссылка);
	СтруктураДанных.Вставить("ЗаказКлиента", ЗаказНазначения);
	СтруктураДанных.Вставить("Изделие", Объект.Номенклатура);
	СтруктураДанных.Вставить("ХарактеристикаИзделия", Объект.Характеристика);
	СтруктураДанных.Вставить("НаправлениеДеятельности", Объект.НаправлениеДеятельности);
	
	Если Режим = 1 Тогда// подобрать аналоги
		
		ТекущаяСтрока = Объект[ИмяТаблицы].НайтиПоИдентификатору(Элементы[ИмяТаблицы].ВыделенныеСтроки[0]);
		
		СтрокаТаблицы = ТаблицаПараметров.Добавить();
		ЗаполнитьЗначенияСвойств(СтрокаТаблицы, СтруктураДанных);
		СтрокаТаблицы.Ссылка = ТекущаяСтрока.Этап;
		СтрокаТаблицы.Спецификация = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(ТекущаяСтрока.Этап, "Владелец");
		
	    МассивСтрок = Объект.Этапы.НайтиСтроки(Новый Структура("КлючСвязи", ТекущаяСтрока.КлючСвязиЭтапы));
		Если МассивСтрок.Количество() > 0 Тогда
			СтрокаТаблицы.Подразделение = МассивСтрок[0].Подразделение;	
		КонецЕсли;	
	
	Иначе	
		
		Запрос = Новый Запрос;
		Запрос.Текст = "ВЫБРАТЬ
		               |	ТаблицаДанных.Этап КАК Этап,
		               |	ТаблицаДанных.КлючСвязиЭтапы КАК КлючСвязиЭтапы
		               |ПОМЕСТИТЬ ТаблицаДанных
		               |ИЗ
		               |	&ТаблицаДанных КАК ТаблицаДанных
		               |
		               |ИНДЕКСИРОВАТЬ ПО
		               |	КлючСвязиЭтапы
		               |;
		               |
		               |////////////////////////////////////////////////////////////////////////////////
		               |ВЫБРАТЬ
		               |	ТаблицаЭтапов.Подразделение КАК Подразделение,
		               |	ТаблицаЭтапов.КлючСвязи КАК КлючСвязи
		               |ПОМЕСТИТЬ ТаблицаЭтапов
		               |ИЗ
		               |	&ТаблицаЭтапов КАК ТаблицаЭтапов
		               |
		               |ИНДЕКСИРОВАТЬ ПО
		               |	КлючСвязи
		               |;
		               |
		               |////////////////////////////////////////////////////////////////////////////////
		               |ВЫБРАТЬ РАЗЛИЧНЫЕ
		               |	ТаблицаДанных.Этап КАК Ссылка,
		               |	ЕСТЬNULL(ТаблицаЭтапов.Подразделение, ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка)) КАК Подразделение,
		               |	РесурсныеСпецификации.Ссылка КАК Спецификация
		               |ИЗ
		               |	ТаблицаДанных КАК ТаблицаДанных
		               |		ЛЕВОЕ СОЕДИНЕНИЕ ТаблицаЭтапов КАК ТаблицаЭтапов
		               |		ПО ТаблицаДанных.КлючСвязиЭтапы = ТаблицаЭтапов.КлючСвязи
		               |		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ЭтапыПроизводства КАК ЭтапыПроизводства
		               |		ПО ТаблицаДанных.Этап = ЭтапыПроизводства.Ссылка
		               |		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.РесурсныеСпецификации КАК РесурсныеСпецификации
		               |		ПО (ЭтапыПроизводства.Владелец = РесурсныеСпецификации.Ссылка)";
					   
		Запрос.УстановитьПараметр("ТаблицаДанных", Объект[ИмяТаблицы].Выгрузить(, "Этап, КлючСвязиЭтапы"));
		Запрос.УстановитьПараметр("ТаблицаЭтапов", Объект.Этапы.Выгрузить(, "Подразделение, КлючСвязи"));
		
		Результат = Запрос.Выполнить();
		
		Выборка = Результат.Выбрать();
		Пока Выборка.Следующий() Цикл
			СтрокаТаблицы = ТаблицаПараметров.Добавить();
			ЗаполнитьЗначенияСвойств(СтрокаТаблицы, СтруктураДанных);
			ЗаполнитьЗначенияСвойств(СтрокаТаблицы, Выборка);
		КонецЦикла;	
		
	КонецЕсли;	
		
	ПараметрыФормы.ПараметрыАналогов.ТаблицаПараметров = 
		ПоместитьВоВременноеХранилище(ТаблицаПараметров, УникальныйИдентификатор);
	
	Возврат ПараметрыФормы;
	
КонецФункции

#КонецОбласти

&НаСервере
Процедура МатериалыИУслугиПриИзмененииНоменклатурыНаСервере(Идентификатор)
	
	ТекущиеДанные = Объект.МатериалыИУслуги.НайтиПоИдентификатору(Идентификатор);
	
	ЗаполнитьСпособПолученияМатериаловПоУмолчаниюНаСервере(ТекущиеДанные);
	
	СтруктураДействий = Новый Структура;
	СтруктураДействий.Вставить("ПроверитьХарактеристикуПоВладельцу", ТекущиеДанные.Характеристика);
	СтруктураДействий.Вставить("ПроверитьЗаполнитьУпаковкуПоВладельцу", ТекущиеДанные.Упаковка);
	СтруктураДействий.Вставить("ЗаполнитьПризнакТипНоменклатуры", Новый Структура("Номенклатура", "ТипНоменклатуры"));
	СтруктураДействий.Вставить("ПроверитьСериюРассчитатьСтатус", Новый Структура("Склад, ПараметрыУказанияСерий", ТекущиеДанные.Склад, ПараметрыУказанияСерий));
	ДобавитьДействияОбеспеченияНаСервере(СтруктураДействий, "ВариантОбеспечения", ТекущиеДанные);
	СтруктураДействий.Вставить("ПересчитатьКоличествоЕдиниц", ПланированиеПроизводстваКлиентСервер.ПараметрыПересчетаКоличестваЕдиниц(ТекущиеДанные, "МатериалыИУслуги"));
	ОбработкаТабличнойЧастиСервер.ОбработатьСтрокуТЧ(ТекущиеДанные, СтруктураДействий, ОбработкаТабличнойЧастиКлиентСервер.ПолучитьСтруктуруКэшируемыеЗначения());
	
	ПроверитьНаличиеУточненийНоменклатурыТабличнойЧасти("МатериалыИУслуги", "ЕстьУточненияМатериалов");
	
	//++ НЕ УТКА
	Если ПравоЧтенияАналогов И ПоказатьАналоги Тогда
		ОтметитьНаличиеАналогов();
	КонецЕсли;
	//-- НЕ УТКА
	
	ОбновитьКолонкуДоступноСервер();

КонецПроцедуры

&НаСервере
Процедура МатериалыИУслугиПриИзмененииХарактеристикиНаСервере(Идентификатор)
	
	ТекущиеДанные = Объект.МатериалыИУслуги.НайтиПоИдентификатору(Идентификатор);
	
	ЗаполнитьСпособПолученияМатериаловПоУмолчаниюНаСервере(ТекущиеДанные);
	
	СтруктураДействий = Новый Структура();
	ДобавитьДействияОбеспеченияНаСервере(СтруктураДействий, "ВариантОбеспечения", ТекущиеДанные);
	ОбработкаТабличнойЧастиСервер.ОбработатьСтрокуТЧ(ТекущиеДанные, СтруктураДействий, ОбработкаТабличнойЧастиКлиентСервер.ПолучитьСтруктуруКэшируемыеЗначения());
	
	ПроверитьНаличиеУточненийНоменклатурыТабличнойЧасти("МатериалыИУслуги", "ЕстьУточненияМатериалов");
	
	//++ НЕ УТКА
	Если ПравоЧтенияАналогов И ПоказатьАналоги Тогда
		ОтметитьНаличиеАналогов();
	КонецЕсли;
	//-- НЕ УТКА
	ОбновитьКолонкуДоступноСервер();
	
КонецПроцедуры
//-- НЕ УТКА

#КонецОбласти

#Область ОбслуживаниеТабличнойЧастиЭтапы

&НаКлиенте
Процедура ЭтапыРедактирование()
	
	ТекущиеДанные = Элементы.Этапы.ТекущиеДанные;
	
	Если ТекущиеДанные = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	ПараметрыФормы = Новый Структура;
	ПараметрыФормы.Вставить("Режим",           "СпецификацияЗаказа");
	ПараметрыФормы.Вставить("ТолькоПросмотр",  ТолькоПросмотр Или ТекущиеДанные.ЭтапВыполнен);
	ПараметрыФормы.Вставить("АдресВХранилище", ДанныеЭтапаВХранилище(ТекущиеДанные.КлючСвязи));
	
	ОткрытьФорму("Справочник.ЭтапыПроизводства.ФормаОбъекта", ПараметрыФормы, ЭтаФорма);
	
КонецПроцедуры

&НаСервере
Процедура ИзменитьДанныеЭтапа(АдресВХранилище, Идентификатор, КэшированныеЗначения)
	
	ТекущиеДанные = Объект.Этапы.НайтиПоИдентификатору(Идентификатор);
	
	ОтборКлючСвязиЭтапы = Новый Структура;
	ОтборКлючСвязиЭтапы.Вставить("КлючСвязиЭтапы", ТекущиеДанные.КлючСвязи);
	
	СвойстваЭтапа = ПолучитьИзВременногоХранилища(АдресВХранилище);
	
	ИзмененоПодразделение     = СвойстваЭтапа.Подразделение <> ТекущиеДанные.Подразделение;
	ИзмененоНаименование      = СвойстваЭтапа.НаименованиеЭтапа <> ТекущиеДанные.НаименованиеЭтапа;
	ИзмененСпособПроизводства = СвойстваЭтапа.ПроизводствоНаСтороне <> ТекущиеДанные.ПроизводствоНаСтороне;
	
	Если ИзмененоНаименование Тогда
		НайденныеСтроки = Объект.ВыходныеИзделия.НайтиСтроки(ОтборКлючСвязиЭтапы);
		Для каждого Строка Из НайденныеСтроки Цикл
			Строка.НаименованиеЭтапа = СвойстваЭтапа.НаименованиеЭтапа;
		КонецЦикла;
		
		НайденныеСтроки = Объект.Трудозатраты.НайтиСтроки(ОтборКлючСвязиЭтапы);
		Для каждого Строка Из НайденныеСтроки Цикл
			Строка.НаименованиеЭтапа = СвойстваЭтапа.НаименованиеЭтапа;
		КонецЦикла;
	КонецЕсли;
	
	Если ИзмененСпособПроизводства ИЛИ ИзмененоНаименование ИЛИ ИзмененоПодразделение Тогда
		
		Для каждого Строка Из Объект.МатериалыИУслуги.НайтиСтроки(ОтборКлючСвязиЭтапы) Цикл
			
			Строка.НаименованиеЭтапа = СвойстваЭтапа.НаименованиеЭтапа;
			
			Если ИзмененСпособПроизводства Тогда
				
				Строка.ПроизводствоНаСтороне = СвойстваЭтапа.ПроизводствоНаСтороне;
				
				Если Строка.ПроизводствоНаСтороне Тогда // в форме настройки этапа установили "производится на стороне"
				
					Если Строка.ВариантОбеспечения = Перечисления.ВариантыОбеспечения.НеТребуется
						ИЛИ Строка.ПроизводитсяВПроцессе Тогда 
						
						ЗаполнитьСпособПолученияМатериаловПоУмолчаниюНаСервере(Строка);
						ЗаполнитьНазначениеВСтрокеТЧМатериалыИУслугиНаСервере(Строка);
						
					КонецЕсли;
					
				КонецЕсли;
				
			КонецЕсли;
			
			Если ИзмененоПодразделение Тогда
				
				Строка.Подразделение = СвойстваЭтапа.Подразделение;
				
				СтруктураДействий = Новый Структура;
				СтруктураДействий.Вставить("ПроверитьСериюРассчитатьСтатус", 
					Новый Структура("Склад, ПараметрыУказанияСерий", Строка.Склад, ПараметрыУказанияСерий));
				
				ОбработкаТабличнойЧастиСервер.ОбработатьСтрокуТЧ(Строка, СтруктураДействий, КэшированныеЗначения);
				
			КонецЕсли;
			
		КонецЦикла;
		
	КонецЕсли;
	
	ЗаполнитьЗначенияСвойств(ТекущиеДанные, СвойстваЭтапа);
	
	НайденныеСтроки = Объект.ВидыРабочихЦентров.НайтиСтроки(ОтборКлючСвязиЭтапы);
	Для каждого ДанныеСтроки Из НайденныеСтроки Цикл
		Объект.ВидыРабочихЦентров.Удалить(ДанныеСтроки);
	КонецЦикла;
	
	НайденныеСтроки = Объект.АльтернативныеВидыРабочихЦентров.НайтиСтроки(ОтборКлючСвязиЭтапы);
	Для каждого ДанныеСтроки Из НайденныеСтроки Цикл
		Объект.АльтернативныеВидыРабочихЦентров.Удалить(ДанныеСтроки);
	КонецЦикла;
	
	ПустойКлюч = ПолучитьПустойУникальныйИдентификатор();
	КлючиСвязиВидовРабочихЦентров = Новый Соответствие;
	
	ОтборКлючСвязиЭтапы.Очистить();
	Для каждого ДанныеСтроки Из СвойстваЭтапа.ВидыРабочихЦентров Цикл
		Строка = Объект.ВидыРабочихЦентров.Добавить();
		ЗаполнитьЗначенияСвойств(Строка, ДанныеСтроки);
		Строка.КлючСвязиЭтапы = ТекущиеДанные.КлючСвязи;
		Строка.КлючСвязиПродукция = ТекущиеДанные.КлючСвязиПродукция;
		
		ОтборКлючСвязиЭтапы.Вставить("КлючСвязиВидыРабочихЦентров", Строка.КлючСвязи);
		АльтернативныеВидыРабочихЦентров = СвойстваЭтапа.АльтернативныеВидыРабочихЦентров.НайтиСтроки(ОтборКлючСвязиЭтапы);
		
		Для каждого СтрокаАльтернативныеВидыРабочихЦентров Из АльтернативныеВидыРабочихЦентров Цикл
			НоваяСтрока = Объект.АльтернативныеВидыРабочихЦентров.Добавить();
			ЗаполнитьЗначенияСвойств(НоваяСтрока, СтрокаАльтернативныеВидыРабочихЦентров);
			Если НоваяСтрока.КлючСвязи = ПустойКлюч Тогда
				НоваяСтрока.КлючСвязи = Новый УникальныйИдентификатор;
			КонецЕсли;
			НоваяСтрока.КлючСвязиЭтапы = ТекущиеДанные.КлючСвязи;
			НоваяСтрока.КлючСвязиПродукция = ТекущиеДанные.КлючСвязиПродукция;
			НоваяСтрока.КлючСвязиВидыРабочихЦентров = Строка.КлючСвязи;
		КонецЦикла;
		
	КонецЦикла;
	
	НастроитьОтображениеПредупрежденийПриРедактировании();
	
КонецПроцедуры

&НаСервере
Процедура УдалитьДанныеЭтапа(КлючСвязи, Отказ, ОписаниеОшибки)
	
	ПланированиеПроизводства.УдалитьЭтапПроизводства(Объект, КлючСвязи, Отказ, ОписаниеОшибки, БракПоМаршрутнымЛистам);
	
	Если Объект.ЕстьСоответствиеСтандартнойСпецификации Тогда
		Объект.ЕстьСоответствиеСтандартнойСпецификации = Ложь;
		НастроитьОтображениеПредупрежденийПриРедактировании();
	КонецЕсли;
	
	ПланированиеПроизводства.ПостроитьСтруктуруЭтапов(Объект.Этапы);
	
	ЗаполнитьПараметрыПроизводственногоПроцессаНаСервере();
	
	//++ НЕ УТКА
	Если ПравоЧтенияАналогов И ПоказатьАналоги Тогда
		ОтметитьНаличиеАналогов();
	КонецЕсли;
	//-- НЕ УТКА
	ОбновитьКолонкуДоступноСервер();
	
КонецПроцедуры

&НаСервере
Процедура ПолучитьДанныеОХодеВыполненияЭтапов()
	
	Запрос = Новый Запрос;
	
	Запрос.УстановитьПараметр("Распоряжение", Объект.Ссылка);
	Запрос.УстановитьПараметр("КлючСвязиПродукция", Объект.КлючСвязи);
	Запрос.УстановитьПараметр("КодСтрокиПродукция", Объект.КодСтроки);
	
	Запрос.Текст =
	"ВЫБРАТЬ
	|	ЗаказНаПроизводствоЭтапыГрафик.КодСтроки      КАК КодСтроки,
	|	ЗаказНаПроизводствоЭтапыГрафик.КлючСвязиЭтапы КАК КлючСвязиЭтапы
	|ПОМЕСТИТЬ ВТГрафик
	|ИЗ
	|	Документ.ЗаказНаПроизводство.ЭтапыГрафик КАК ЗаказНаПроизводствоЭтапыГрафик
	|ГДЕ
	|	ЗаказНаПроизводствоЭтапыГрафик.Ссылка = &Распоряжение
	|	И ЗаказНаПроизводствоЭтапыГрафик.КлючСвязиПродукция = &КлючСвязиПродукция
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	КодСтроки
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ТЭтапыПроизводства.КодСтрокиЭтапыГрафик     КАК КодСтроки,
	|	(ТЭтапыПроизводства.КВыполнениюОборот
	|		+ ТЭтапыПроизводства.ВыполненоОборот
	|		+ ТЭтапыПроизводства.БракОборот)        КАК ВыполненоЗапланировано
	|ПОМЕСТИТЬ ВТЭтапыПроизводства
	|ИЗ
	|	РегистрНакопления.ЭтапыПроизводства.Обороты(,,,
	|			Распоряжение = &Распоряжение
	|				И КодСтрокиПродукция = &КодСтрокиПродукция) КАК ТЭтапыПроизводства
	|ГДЕ
	|	(ТЭтапыПроизводства.КВыполнениюОборот
	|		+ ТЭтапыПроизводства.ВыполненоОборот
	|		+ ТЭтапыПроизводства.БракОборот) > 0
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	КодСтроки
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ТГрафик.КлючСвязиЭтапы                           КАК КлючСвязи,
	|	СУММА(ТЭтапыПроизводства.ВыполненоЗапланировано) КАК ВыполненоЗапланировано
	|ИЗ
	|	ВТГрафик КАК ТГрафик
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТЭтапыПроизводства КАК ТЭтапыПроизводства
	|		ПО ТГрафик.КодСтроки = ТЭтапыПроизводства.КодСтроки
	|
	|СГРУППИРОВАТЬ ПО
	|	ТГрафик.КлючСвязиЭтапы";
	
	РезультатЗапроса = Запрос.Выполнить();
	
	Если Не РезультатЗапроса.Пустой() Тогда
		
		Выполняется = Истина;
		
		ОтборКлючСвязи = Новый Структура("КлючСвязи");
		ОтборКлючСвязиЭтапы = Новый Структура("КлючСвязиЭтапы");
		
		Выборка = РезультатЗапроса.Выбрать();
		
		Пока Выборка.Следующий() Цикл
			
			ОтборКлючСвязи.КлючСвязи = Выборка.КлючСвязи;
			
			НайденныеСтроки = Объект.Этапы.НайтиСтроки(ОтборКлючСвязи);
			
			Если НайденныеСтроки.Количество() = 0 Тогда
				Продолжить;
			КонецЕсли;
			
			ЭтапСпецификации = НайденныеСтроки[0];
			
			ЭтапСпецификации.ВыполненоЗапланировано = Выборка.ВыполненоЗапланировано;
			ЭтапСпецификации.ЭтапВыполнен           = (ЭтапСпецификации.Количество = Выборка.ВыполненоЗапланировано);
			
			ОтборКлючСвязиЭтапы.КлючСвязиЭтапы = Выборка.КлючСвязи;

			// установка отметки выполненных этапов.
			Если ЭтапСпецификации.ЭтапВыполнен Тогда
				
				Для каждого Строка Из Объект.ВыходныеИзделия.НайтиСтроки(ОтборКлючСвязиЭтапы) Цикл
					Строка.ЭтапВыполнен = Истина;
				КонецЦикла;
				
				Для каждого Строка Из Объект.ВозвратныеОтходы.НайтиСтроки(ОтборКлючСвязиЭтапы) Цикл
					Строка.ЭтапВыполнен = Истина;
				КонецЦикла;
				
				Для каждого Строка Из Объект.МатериалыИУслуги.НайтиСтроки(ОтборКлючСвязиЭтапы) Цикл
					Строка.ЭтапВыполнен = Истина;
				КонецЦикла;
				
				Для каждого Строка Из Объект.Трудозатраты.НайтиСтроки(ОтборКлючСвязиЭтапы) Цикл
					Строка.ЭтапВыполнен = Истина;
				КонецЦикла;
				
			КонецЕсли;
			
		КонецЦикла;
		
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти

#Область ОбслуживаниеВнутреннихПолуфабрикатов

&НаКлиенте
Процедура ОбработатьВыборЭтапаПолуфабрикатаНаКлиенте(ТекущиеДанные, ВыбранноеЗначение)
	
	ЗначениеВыбора = ВыбранноеЗначение.ЗначениеВыбора;
	
	Если ТекущиеДанные.КлючСвязиЭтапВыпуска = ЗначениеВыбора.КлючСвязиЭтапы Тогда
		Возврат;
	КонецЕсли;
	
	ТекущиеДанные.КлючСвязиЭтапВыпуска           = ЗначениеВыбора.КлючСвязиЭтапы;
	ТекущиеДанные.ИсточникПолученияПолуфабриката = ЗначениеВыбора.Этап;
	
	ЗаполнитьНазначениеВСтрокеТЧМатериалыИУслугиНаКлиенте(ТекущиеДанные);
	
	СтруктураПотребности = ПотребностьВПолуфабрикатахПоСтроке(ТекущиеДанные);
	
	ОбработатьВыборЭтапаПолуфабрикатаНаСервере(СтруктураПотребности);
	
КонецПроцедуры


&НаКлиенте
Процедура ОбработатьВыборСпецификацииПолуфабрикатаНаКлиенте(Знач ТекущиеДанные, Знач ВыбранноеЗначение)
	
	ТекущиеДанные.ИсточникПолученияПолуфабриката = ВыбранноеЗначение;
	
	ЗаполнитьНазначениеВСтрокеТЧМатериалыИУслугиНаКлиенте(ТекущиеДанные);
	
	ПродукцияЗаполнитьЭтапыВыходныеИзделияМатериалыИУслугиНаКлиенте(ТекущиеДанные);

КонецПроцедуры

&НаКлиенте
Процедура ОтменитьПотребностьВоВнутреннихПолуфабрикатах(ТекущиеДанные)
	
	СтруктураПотребности = ПотребностьВПолуфабрикатахПоСтроке(ТекущиеДанные);
	
	ОтменитьПотребностьВоВнутреннихПолуфабрикатахНаСервере(СтруктураПотребности);
	
КонецПроцедуры

&НаСервере
Процедура ОбработатьВыборЭтапаПолуфабрикатаНаСервере(СтруктураПотребности)
	
	ОтменитьПотребностьВоВнутреннихПолуфабрикатахНаСервере(СтруктураПотребности);
	ИзменитьПотребностьВоВнутреннихПолуфабрикатах(СтруктураПотребности, Ложь);
	
КонецПроцедуры

&НаСервере
Процедура ИзменитьПотребностьВоВнутреннихПолуфабрикатах(СтруктураПотребности, Изменение = Истина)
	
	Если Изменение Тогда
		
		ПромежуточныйВыпуск = 0;
		
		НайденныеСтроки = Объект.ВозвратныеОтходы.НайтиСтроки(Новый Структура("КлючСвязиМатериалыИУслуги", СтруктураПотребности.КлючСвязи));
		Для каждого НайденнаяСтрока Из НайденныеСтроки Цикл
			ПромежуточныйВыпуск = ПромежуточныйВыпуск + НайденнаяСтрока.Количество;
		КонецЦикла;
		
		КоличествоПотребность = СтруктураПотребности.Количество - ПромежуточныйВыпуск;
		
	Иначе
		
		КоличествоПотребность = СтруктураПотребности.КоличествоУпаковок;
		
	КонецЕсли;
	
	Если КоличествоПотребность > 0 Тогда
		
		УвеличитьПотребностьВоВнутреннихПолуфабрикатах(СтруктураПотребности, КоличествоПотребность);
		
	ИначеЕсли КоличествоПотребность < 0 Тогда
	
		УменьшитьПотребностьВоВнутреннихПолуфабрикатах(СтруктураПотребности, КоличествоПотребность);
		
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Процедура ОтменитьПотребностьВоВнутреннихПолуфабрикатахНаСервере(СтруктураПотребности)
	
	УменьшитьПотребностьВоВнутреннихПолуфабрикатах(СтруктураПотребности);
	
КонецПроцедуры

&НаСервере
Процедура УменьшитьПотребностьВоВнутреннихПолуфабрикатах(СтруктураПотребности, Знач КоличествоПотребность = Неопределено)
	
	Перем КэшированныеЗначения;
	
	СтруктураОтбора = Новый Структура;
	СтруктураОтбора.Вставить("КлючСвязи", СтруктураПотребности.КлючСвязиЭтапВыпуска);
	
	ЭтапВыпуска = Объект.Этапы.НайтиСтроки(СтруктураОтбора);
	Если ЭтапВыпуска.ВГраница() = -1
		ИЛИ ЭтапВыпуска[0].ЭтапВыполнен Тогда
		Возврат;
	КонецЕсли;
	
	УменьшитьПотребность = (КоличествоПотребность <> Неопределено);
	
	СтруктураОтбора = Новый Структура;
	СтруктураОтбора.Вставить("КлючСвязиМатериалыИУслуги", СтруктураПотребности.КлючСвязи);
	
	ПромежуточныйВыпуски = Объект.ВозвратныеОтходы.НайтиСтроки(СтруктураОтбора);
	Если ПромежуточныйВыпуски.ВГраница() = -1 Тогда
		Возврат;
	КонецЕсли;
	
	МассивНовыхСтрок      = Новый Массив;
	МассивСтрокКУдалению  = Новый Массив;
	МассивСтрокКПересчету = Новый Массив;
	
	СтруктураПоиска = Новый Структура("
		|Номенклатура,
		|Характеристика,
		|КлючСвязиЭтапы");
		
	СтруктураПоиска.Вставить("Склад", Объект.Склад);
	
	Для каждого ПромежуточныйВыпуск Из ПромежуточныйВыпуски Цикл
		
		Если УменьшитьПотребность Тогда
			
			Если КоличествоПотребность = 0 Тогда
				Прервать;
			КонецЕсли;
			
			КоличествоНеТребуется = Мин(-КоличествоПотребность, ПромежуточныйВыпуск.Количество);
			
		Иначе
			
			КоличествоНеТребуется = ПромежуточныйВыпуск.Количество;
			
		КонецЕсли;
	
		ЗаполнитьЗначенияСвойств(СтруктураПоиска, ПромежуточныйВыпуск,, "Склад");
		
		ПобочныеВыпуски = Объект.ВозвратныеОтходы.НайтиСтроки(СтруктураПоиска);
		
		Если КоличествоНеТребуется < ПромежуточныйВыпуск.Количество Тогда
			
			ПромежуточныйВыпуск.Количество = ПромежуточныйВыпуск.Количество - КоличествоНеТребуется;
			
			МассивСтрокКПересчету.Добавить(ПромежуточныйВыпуск);
			
			Если ПобочныеВыпуски.ВГраница() <> -1 Тогда
				
				ПобочныйВыпуск = ПобочныеВыпуски[0];
				ПобочныйВыпуск.Количество = ПобочныйВыпуск.Количество + КоличествоНеТребуется;
				
				МассивСтрокКПересчету.Добавить(ПобочныйВыпуск);
				
			Иначе
				
				НоваяСтрока = Объект.ВозвратныеОтходы.Добавить();
				
				ЗаполнитьЗначенияСвойств(НоваяСтрока, ПромежуточныйВыпуск,
					"Номенклатура,
					|Характеристика,
					|Упаковка,
					|Этап,
					|НаименованиеЭтапа,
					|НаименованиеПолуфабриката,
					|КлючСвязиПродукция,
					|КлючСвязиЭтапы,
					|КлючСвязиПолуфабрикат,
					|СтатьяКалькуляции,
					|ОписаниеИзделия");
				
				НоваяСтрока.КлючСвязи = Новый УникальныйИдентификатор;
				
				НоваяСтрока.НаправлениеВыпуска = Перечисления.ХозяйственныеОперации.ВыпускПродукцииНаСклад;
				НоваяСтрока.Склад              = Объект.Склад;
				НоваяСтрока.Подразделение      = Справочники.СтруктураПредприятия.ПустаяСсылка();
				НоваяСтрока.Получатель         = Объект.Склад;
				
				НоваяСтрока.Количество         = КоличествоНеТребуется;
				
				МассивНовыхСтрок.Добавить(НоваяСтрока);
				
			КонецЕсли;
			
		Иначе
			
			Если ПобочныеВыпуски.ВГраница() <> -1 Тогда
				
				ПобочныйВыпуск = ПобочныеВыпуски[0];
				ПобочныйВыпуск.Количество = ПобочныйВыпуск.Количество + КоличествоНеТребуется;
				
				МассивСтрокКУдалению.Добавить(ПромежуточныйВыпуск);
				МассивСтрокКПересчету.Добавить(ПобочныйВыпуск);
				
			Иначе
				
				ПромежуточныйВыпуск.ПроизводитсяВПроцессе = Ложь;
				ПромежуточныйВыпуск.КлючСвязиМатериалыИУслуги = ПолучитьПустойУникальныйИдентификатор();
				
				ПромежуточныйВыпуск.НаправлениеВыпуска = Перечисления.ХозяйственныеОперации.ВыпускПродукцииНаСклад;
				ПромежуточныйВыпуск.Склад              = Объект.Склад;
				ПромежуточныйВыпуск.Подразделение      = Справочники.СтруктураПредприятия.ПустаяСсылка();
				ПромежуточныйВыпуск.Получатель         = Объект.Склад;
				
			КонецЕсли;
			
		КонецЕсли;
		
		Если УменьшитьПотребность Тогда
			
			КоличествоПотребность = КоличествоПотребность + КоличествоНеТребуется;
			
		КонецЕсли;
		
	КонецЦикла;
	
	Для каждого Строка Из МассивСтрокКУдалению Цикл
		
		Объект.ВозвратныеОтходы.Удалить(Строка);
		
	КонецЦикла;
	
	СтруктураДействий = Новый Структура;
	СтруктураДействий.Вставить("ПересчитатьКоличествоУпаковок");
	
	Для каждого Строка Из МассивСтрокКПересчету Цикл
		
		ОбработкаТабличнойЧастиСервер.ОбработатьСтрокуТЧ(Строка, СтруктураДействий, КэшированныеЗначения);
		
	КонецЦикла;
	
	СтруктураДействий.Вставить("ЗаполнитьПризнакХарактеристикиИспользуются", 
								Новый Структура("Номенклатура", "ХарактеристикиИспользуются"));
	СтруктураДействий.Вставить("ЗаполнитьПризнакТипНоменклатуры", 
								Новый Структура("Номенклатура", "ТипНоменклатуры"));
	
	Для каждого Строка Из МассивНовыхСтрок Цикл
		
		ЗаполнитьНазначениеВСтрокеТЧВыходныеИзделияНаСервере(
			Строка, Истина, ПредопределенноеЗначение("Перечисление.ТипыСтоимостиВыходныхИзделий.Фиксированная"));
			
		ОбработкаТабличнойЧастиСервер.ОбработатьСтрокуТЧ(Строка, СтруктураДействий, КэшированныеЗначения);
		
	КонецЦикла;
	
	ИзменениеСоставаТЧВыходныеИзделияИВозвратныеОтходыНаСервере();
	
КонецПроцедуры

&НаСервере
Процедура УвеличитьПотребностьВоВнутреннихПолуфабрикатах(СтруктураПотребности, Знач КоличествоПотребность)
	
	Перем КэшированныеЗначения;
	
	СтруктураОтбора = Новый Структура;
	СтруктураОтбора.Вставить("КлючСвязи", СтруктураПотребности.КлючСвязиЭтапВыпуска);
	
	ЭтапВыпуска = Объект.Этапы.НайтиСтроки(СтруктураОтбора);
	Если ЭтапВыпуска.ВГраница() = -1
		ИЛИ ЭтапВыпуска[0].ЭтапВыполнен Тогда
		Возврат;
	КонецЕсли;
	
	МассивНовыхСтрок      = Новый Массив;
	МассивСтрокКУдалению  = Новый Массив;
	МассивСтрокКПересчету = Новый Массив;
	
	ПромежуточныйВыпуск = Неопределено;
	
	СтруктураОтбора = Новый Структура;
	СтруктураОтбора.Вставить("КлючСвязиМатериалыИУслуги", СтруктураПотребности.КлючСвязи);
	
	НайденныеСтроки = Объект.ВозвратныеОтходы.НайтиСтроки(СтруктураОтбора);
	Для каждого НайденнаяСтрока Из НайденныеСтроки Цикл
		ПромежуточныйВыпуск = НайденнаяСтрока;
		Прервать;
	КонецЦикла;
	
	СтруктураОтбора = Новый Структура;
	СтруктураОтбора.Вставить("Номенклатура",       СтруктураПотребности.Номенклатура);
	СтруктураОтбора.Вставить("Характеристика",     СтруктураПотребности.Характеристика);
	СтруктураОтбора.Вставить("НаправлениеВыпуска", Перечисления.ХозяйственныеОперации.ВыпускПродукцииНаСклад);
	
	СтруктураОтбора.Вставить("КлючСвязиЭтапы",     СтруктураПотребности.КлючСвязиЭтапВыпуска);
	
	НайденныеСтроки = Объект.ВозвратныеОтходы.НайтиСтроки(СтруктураОтбора);
	Для каждого ПобочныйВыпуск Из НайденныеСтроки Цикл
		
		Если КоличествоПотребность = 0 Тогда
			Прервать;
		КонецЕсли;
		
		Если ПобочныйВыпуск.Количество = 0 Тогда
			Продолжить;
		КонецЕсли;
		
		КоличествоОстаток      = Макс(ПобочныйВыпуск.Количество - КоличествоПотребность, 0);
		КоличествоИспользовано = ПобочныйВыпуск.Количество - КоличествоОстаток;
		
		Если КоличествоОстаток > 0 Тогда
			
			ПобочныйВыпуск.Количество = КоличествоОстаток;
			
			МассивСтрокКПересчету.Добавить(ПобочныйВыпуск);
			
		Иначе
			
			МассивСтрокКУдалению.Добавить(ПобочныйВыпуск);
			
		КонецЕсли;
		
		Если ПромежуточныйВыпуск <> Неопределено Тогда
			
			ПромежуточныйВыпуск.Количество = ПромежуточныйВыпуск.Количество + КоличествоИспользовано;
			
			МассивСтрокКПересчету.Добавить(ПромежуточныйВыпуск);
			
		Иначе
			
			НоваяСтрока = Объект.ВозвратныеОтходы.Добавить();
			
			ЗаполнитьЗначенияСвойств(НоваяСтрока, ПобочныйВыпуск);
			
			НоваяСтрока.КлючСвязи = Новый УникальныйИдентификатор;
			
			НоваяСтрока.ПроизводитсяВПроцессе = Истина;
			НоваяСтрока.КлючСвязиМатериалыИУслуги = СтруктураПотребности.КлючСвязи;
			
			НоваяСтрока.Склад              = Справочники.Склады.ПустаяСсылка();
			НоваяСтрока.Подразделение      = СтруктураПотребности.Подразделение;
			НоваяСтрока.НаправлениеВыпуска = Перечисления.ХозяйственныеОперации.ВыпускПродукцииВПодразделение;
			НоваяСтрока.Получатель         = СтруктураПотребности.Подразделение;
			
			НоваяСтрока.СтатьяКалькуляции  = Справочники.СтатьиКалькуляции.ПолуфабрикатыПроизводимыеВПроцессе;
			
			НоваяСтрока.Упаковка           = СтруктураПотребности.Упаковка;
			НоваяСтрока.Количество         = КоличествоИспользовано;
			
			ЗаполнитьНаправлениеВыпускаНаОснованииСтрокиМатериала(СтруктураПотребности, "КлючСвязиМатериалыИУслуги", Объект.ВозвратныеОтходы);
			
			МассивНовыхСтрок.Добавить(НоваяСтрока);
			
		КонецЕсли;
		
		КоличествоПотребность = КоличествоПотребность - КоличествоИспользовано;
		
	КонецЦикла;
	
	Для каждого Строка Из МассивСтрокКУдалению Цикл
		
		Объект.ВозвратныеОтходы.Удалить(Строка);
		
	КонецЦикла;

	СтруктураДействий = Новый Структура;
	СтруктураДействий.Вставить("ПересчитатьКоличествоУпаковок");
	
	Для каждого Строка Из МассивСтрокКПересчету Цикл
		
		ОбработкаТабличнойЧастиСервер.ОбработатьСтрокуТЧ(Строка, СтруктураДействий, КэшированныеЗначения);
		
	КонецЦикла;
	
	СтруктураДействий.Вставить("ЗаполнитьПризнакХарактеристикиИспользуются", 
								Новый Структура("Номенклатура", "ХарактеристикиИспользуются"));
	СтруктураДействий.Вставить("ЗаполнитьПризнакТипНоменклатуры", 
								Новый Структура("Номенклатура", "ТипНоменклатуры"));
	
	Для каждого Строка Из МассивНовыхСтрок Цикл
		
		ЗаполнитьНазначениеВСтрокеТЧВыходныеИзделияНаСервере(
			Строка, Истина, ПредопределенноеЗначение("Перечисление.ТипыСтоимостиВыходныхИзделий.Фиксированная"));
			
		ОбработкаТабличнойЧастиСервер.ОбработатьСтрокуТЧ(Строка, СтруктураДействий, КэшированныеЗначения);
		
	КонецЦикла;
	
	ИзменениеСоставаТЧВыходныеИзделияИВозвратныеОтходыНаСервере();
	
КонецПроцедуры

&НаКлиентеНаСервереБезКонтекста
Функция ПотребностьВПолуфабрикатахПоСтроке(ТекущиеДанные)
	
	СтруктураПотребности = Новый Структура;
	
	СтруктураПотребности.Вставить("КлючСвязи",            ТекущиеДанные.КлючСвязи);
	СтруктураПотребности.Вставить("КлючСвязиЭтапВыпуска", ТекущиеДанные.КлючСвязиЭтапВыпуска);
	
	СтруктураПотребности.Вставить("Номенклатура",         ТекущиеДанные.Номенклатура);
	СтруктураПотребности.Вставить("Характеристика",       ТекущиеДанные.Характеристика);
	СтруктураПотребности.Вставить("Подразделение",        ТекущиеДанные.Подразделение);
	СтруктураПотребности.Вставить("Склад",                ТекущиеДанные.Склад);
	СтруктураПотребности.Вставить("ЗаказатьНаСклад",      ТекущиеДанные.ЗаказатьНаСклад);
	СтруктураПотребности.Вставить("Количество",           ТекущиеДанные.Количество);
	СтруктураПотребности.Вставить("Упаковка",             ТекущиеДанные.Упаковка);
	СтруктураПотребности.Вставить("КоличествоУпаковок",   ТекущиеДанные.КоличествоУпаковок);
	СтруктураПотребности.Вставить("ПроизводитсяВПроцессе",ТекущиеДанные.ПроизводитсяВПроцессе);
	
	Возврат СтруктураПотребности;
	
КонецФункции

#КонецОбласти

#Область Прочее

&НаКлиенте
Функция ОчиститьТабличныеЧасти()
	
	Объект.Этапы.Очистить();
	Объект.ВыходныеИзделия.Очистить();
	Объект.ВозвратныеОтходы.Очистить();
	Объект.МатериалыИУслуги.Очистить();
	Объект.Трудозатраты.Очистить();
	Объект.ВидыРабочихЦентров.Очистить();
	Объект.АльтернативныеВидыРабочихЦентров.Очистить();
	
КонецФункции

&НаКлиентеНаСервереБезКонтекста
Процедура ОбновитьСостояниеСпецификацииЗаказа(Форма)
	
	Объект = Форма.Объект;
	Элементы = Форма.Элементы;
	
	ЕстьОшибкиЗаполнения         = Форма.ЕстьОшибкиЗаполнения;
	ЕстьУточненияМатериалов      = Форма.ЕстьУточненияМатериалов;
	ЕстьУточненияПобочныхИзделий = Форма.ЕстьУточненияПобочныхИзделий;
	
	// Установка страницы ошибок.
	Если ЕстьОшибкиЗаполнения ИЛИ ЕстьУточненияМатериалов ИЛИ ЕстьУточненияПобочныхИзделий Тогда
		Элементы.ПанельОшибок.ТекущаяСтраница = Элементы.ПанельОшибок.ПодчиненныеЭлементы.СтраницаЕстьОшибки;
	Иначе
		Элементы.ПанельОшибок.ТекущаяСтраница = Элементы.ПанельОшибок.ПодчиненныеЭлементы.СтраницаНетОшибок;
	КонецЕсли;
	
	// Установка страницы соответствия.
	Если Объект.ЕстьСоответствиеСтандартнойСпецификации Тогда
		Элементы.ПанельСоответствияСтандартной.ТекущаяСтраница = Элементы.ПанельСоответствияСтандартной.ПодчиненныеЭлементы.СтраницаСостояниеИзмененийНет;
	Иначе
		Элементы.ПанельСоответствияСтандартной.ТекущаяСтраница = Элементы.ПанельСоответствияСтандартной.ПодчиненныеЭлементы.СтраницаСостояниеИзмененияЕсть;
	КонецЕсли;
	
	// Формирование надписи.
	
	Если (ЕстьУточненияМатериалов ИЛИ ЕстьУточненияПобочныхИзделий) И ЕстьОшибкиЗаполнения Тогда
		Форма.ТекстИнформационнойНадписи = НСтр("ru = 'Требуется уточнить номенклатуру, обнаружены ошибки заполнения.';
												|en = 'Specify products. Population errors detected.'");
	ИначеЕсли ЕстьУточненияМатериалов Тогда
		Форма.ТекстИнформационнойНадписи = НСтр("ru = 'Требуется уточнить материалы.';
												|en = 'It is required to specify materials.'");
	ИначеЕсли ЕстьУточненияПобочныхИзделий Тогда
		Форма.ТекстИнформационнойНадписи = НСтр("ru = 'Требуется уточнить побочные изделия.';
												|en = 'Specify side products.'");
	ИначеЕсли ЕстьОшибкиЗаполнения Тогда
		Форма.ТекстИнформационнойНадписи = НСтр("ru = 'Обнаружены ошибки заполнения.';
												|en = 'Population errors are detected.'");
	КонецЕсли;
	
	Форма.ВсегоИзделий = Объект.ВыходныеИзделия.Количество() + Объект.ВозвратныеОтходы.Количество();
	
	Форма.ОбновитьСостояниеСпецификацииЗаказа = Ложь;
	
КонецПроцедуры

&НаКлиентеНаСервереБезКонтекста
Функция ПолучитьПустойУникальныйИдентификатор()
	
	Возврат Новый УникальныйИдентификатор("00000000-0000-0000-0000-000000000000");
	
КонецФункции

&НаСервере
Процедура НастроитьОтображениеПредупрежденийПриРедактировании()
	
	ТекстПредупреждения = НСтр("ru = 'Спецификация изменена. Изменение приведет к возврату стандартной спецификации';
								|en = 'Bill of materials is changed. If it is changed, you will return to the standard bill of materials'");
	
	Элементы.КоличествоУпаковок.ПредупреждениеПриРедактировании = ТекстПредупреждения;
	Элементы.Упаковка.ПредупреждениеПриРедактировании = ТекстПредупреждения;
	
	Если Объект.ЕстьСоответствиеСтандартнойСпецификации Тогда
		Элементы.КоличествоУпаковок.ОтображениеПредупрежденияПриРедактировании = ОтображениеПредупрежденияПриРедактировании.Авто;
		Элементы.Упаковка.ОтображениеПредупрежденияПриРедактировании = ОтображениеПредупрежденияПриРедактировании.Авто;
		Элементы.Спецификация.ОтображениеПредупрежденияПриРедактировании = ОтображениеПредупрежденияПриРедактировании.Авто;
	Иначе
		Элементы.КоличествоУпаковок.ОтображениеПредупрежденияПриРедактировании = ОтображениеПредупрежденияПриРедактировании.Отображать;
		Элементы.Упаковка.ОтображениеПредупрежденияПриРедактировании = ОтображениеПредупрежденияПриРедактировании.Отображать;
		Элементы.Спецификация.ОтображениеПредупрежденияПриРедактировании = ОтображениеПредупрежденияПриРедактировании.Отображать;
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Процедура ДобавитьСвязанныеЭтапы(МассивСтрокЦепочки, НомерЭтапаФорма, Испорчено)
	
	СтруктураОтбора = Новый Структура("НомерСледующегоЭтапаФорма", НомерЭтапаФорма);
	
	НайденныеСтроки = Объект.Этапы.НайтиСтроки(СтруктураОтбора);
	
	Для каждого Строка Из НайденныеСтроки Цикл
		
		Если МассивСтрокЦепочки.Найти(Строка) <> Неопределено Тогда
			Продолжить;
		Иначе
			Строка.КоличествоЭтаповВосстановления = Испорчено * Строка.КоличествоЭтаповНаЕдиницуСледующегоЭтапа;
			МассивСтрокЦепочки.Добавить(Строка);
			
			ДобавитьСвязанныеЭтапы(МассивСтрокЦепочки, Строка.НомерЭтапаФорма, Испорчено);
		КонецЕсли;
		
	КонецЦикла;
	
КонецПроцедуры

&НаСервере
Процедура ЗаписатьДокументНаСервере()
	
	ЗаказОбъект = Объект.Ссылка.ПолучитьОбъект();

	ПланированиеПроизводства.УдалитьДанныеСпецификацииПоКлючу(ЗаказОбъект, Объект.КлючСвязи);
	
	// Запись изменений в реквизиты заказа.
	ЗаказОбъект.СтатусГрафикаПроизводства = СтатусГрафикаПроизводства;
	
	// Запись изменений в табличную часть Продукция.
	СтрокаПродукции = ЗаказОбъект.Продукция.Найти(Объект.КлючСвязи, "КлючСвязи");
	СтрокаПродукции.ГрафикРассчитан = Ложь;
	
	ЗаполнитьЗначенияСвойств(СтрокаПродукции, Объект, "Упаковка, КоличествоУпаковок, Количество, ДатаПотребности,
		|НачатьНеРанее, РазмещениеВыпуска, Склад, Назначение, ЕстьСоответствиеСтандартнойСпецификации");
	
	// Запись изменений в табличную часть Этапы.
	Для каждого Строка Из Объект.Этапы Цикл
		ЗаполнитьЗначенияСвойств(ЗаказОбъект.Этапы.Добавить(), Строка);
	КонецЦикла;
	
	// Запись изменений в табличную часть ВыходныеИзделия.
	Для каждого Строка Из Объект.ВыходныеИзделия Цикл
		ЗаполнитьЗначенияСвойств(ЗаказОбъект.ВыходныеИзделия.Добавить(), Строка);
	КонецЦикла;
	
	// Запись изменений в табличную часть ВозвратныеОтходы.
	Для каждого Строка Из Объект.ВозвратныеОтходы Цикл
		ЗаполнитьЗначенияСвойств(ЗаказОбъект.ВозвратныеОтходы.Добавить(), Строка);
	КонецЦикла;
	
	// Запись изменений в табличную часть МатериалыИУслуги.
	Для каждого Строка Из Объект.МатериалыИУслуги Цикл
		ЗаполнитьЗначенияСвойств(ЗаказОбъект.МатериалыИУслуги.Добавить(), Строка);
	КонецЦикла;
	
	// Запись изменений в табличную часть Трудозатраты.
	Для каждого Строка Из Объект.Трудозатраты Цикл
		ЗаполнитьЗначенияСвойств(ЗаказОбъект.Трудозатраты.Добавить(), Строка);
	КонецЦикла;
	
	// Запись изменений в табличную часть ВидыРабочихЦентров.
	Для каждого Строка Из Объект.ВидыРабочихЦентров Цикл
		ЗаполнитьЗначенияСвойств(ЗаказОбъект.ВидыРабочихЦентров.Добавить(), Строка);
	КонецЦикла;
	
	// Запись изменений в табличную часть АльтернативныеВидыРабочихЦентров.
	Для каждого Строка Из Объект.АльтернативныеВидыРабочихЦентров Цикл
		ЗаполнитьЗначенияСвойств(ЗаказОбъект.АльтернативныеВидыРабочихЦентров.Добавить(), Строка);
	КонецЦикла;
	
	// Запись изменений в табличную часть ЭтапыВосстановленияБрака.
	Для каждого Строка Из Объект.ЭтапыВосстановленияБрака Цикл
		ЗаполнитьЗначенияСвойств(ЗаказОбъект.ЭтапыВосстановленияБрака.Добавить(), Строка);
	КонецЦикла;
	
	НачатьТранзакцию();
	
	Попытка
		
		Обработки.ВводКорректировкиЗаказаМатериалов.СохранитьКорректировкиЗаказаМатериаловПоЗаказуНаПроизводство(ЗаказОбъект, ПараметрыРедактированияМатериалов);
		
		ЗаказОбъект.Записать(РежимЗаписиДокумента.Проведение);
		
		ЗафиксироватьТранзакцию();
		
	Исключение
		
		ОтменитьТранзакцию();
		
		ТекстСообщения = КраткоеПредставлениеОшибки(ИнформацияОбОшибке());
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения);
		
	КонецПопытки; 
	
КонецПроцедуры

&НаСервере
Процедура ЗаполнитьСлужебныеРеквизиты()
	
	СтруктураДействий = Новый Структура;
	СтруктураДействий.Вставить("ЗаполнитьПризнакХарактеристикиИспользуются",
								Новый Структура("Номенклатура", "ХарактеристикиИспользуются"));
	СтруктураДействий.Вставить("ЗаполнитьПризнакТипНоменклатуры",
								Новый Структура("Номенклатура", "ТипНоменклатуры"));
			
	НоменклатураСервер.ЗаполнитьСлужебныеРеквизитыПоНоменклатуреВКоллекции(Объект.ВыходныеИзделия, СтруктураДействий);
	НоменклатураСервер.ЗаполнитьСлужебныеРеквизитыПоНоменклатуреВКоллекции(Объект.ВозвратныеОтходы, СтруктураДействий);
	
	СтруктураДействий = Новый Структура;
	СтруктураДействий.Вставить("ЗаполнитьПризнакХарактеристикиИспользуются",
								Новый Структура("Номенклатура", "ХарактеристикиИспользуются"));
	СтруктураДействий.Вставить("ЗаполнитьПризнакТипНоменклатуры",
								Новый Структура("Номенклатура", "ТипНоменклатуры"));
	СтруктураДействий.Вставить("ЗаполнитьПризнакАртикул",
								Новый Структура("Номенклатура", "Артикул"));
		
	НоменклатураСервер.ЗаполнитьСлужебныеРеквизитыПоНоменклатуреВКоллекции(Объект.МатериалыИУслуги, СтруктураДействий);
	
	Для каждого Строка Из Объект.МатериалыИУслуги Цикл
		
		Если Строка.ПроизводитсяВПроцессе 
			И ТипЗнч(Строка.ИсточникПолученияПолуфабриката) = Тип("СправочникСсылка.РесурсныеСпецификации") Тогда
			Строка.СпособПолученияПолуфабриката = Перечисления.СпособыПолучениеМатериаловЭтапаПроизводства.ПроизвестиПоСпецификации;
		ИначеЕсли Строка.ПроизводитсяВПроцессе 
			И ТипЗнч(Строка.ИсточникПолученияПолуфабриката) = Тип("СправочникСсылка.ЭтапыПроизводства") Тогда
			Строка.СпособПолученияПолуфабриката = Перечисления.СпособыПолучениеМатериаловЭтапаПроизводства.ПроизвестиНаЭтапе;
		Иначе
			Строка.СпособПолученияПолуфабриката = Перечисления.СпособыПолучениеМатериаловЭтапаПроизводства.ПустаяСсылка();
		КонецЕсли;
		
		ЗаполнитьКоличествоМатериалаНаЕдиницуИзделия(Строка, Объект.КоличествоУпаковок);
	
	КонецЦикла;
	
	Для каждого Строка Из Объект.ВыходныеИзделия Цикл
		
		Если Строка.ПроизводитсяВПроцессе Тогда
			
			Если ЗначениеЗаполнено(Строка.Склад) Тогда
				Строка.НаправлениеВыпуска = Перечисления.ХозяйственныеОперации.ВыпускПродукцииНаСклад;
				Строка.Получатель         = Строка.Склад;
			Иначе
				Строка.НаправлениеВыпуска = Перечисления.ХозяйственныеОперации.ВыпускПродукцииВПодразделение;
				Строка.Получатель         = Строка.Подразделение;
			КонецЕсли; 
			
		ИначеЕсли Строка.ТипНоменклатуры = Перечисления.ТипыНоменклатуры.Работа
			Или Строка.Подразделение <> Справочники.СтруктураПредприятия.ПустаяСсылка() Тогда
			
			Строка.НаправлениеВыпуска = Перечисления.ХозяйственныеОперации.ВыпускПродукцииВПодразделение;
			Строка.Получатель         = Строка.Подразделение;
			
		Иначе
			
			Строка.НаправлениеВыпуска = Перечисления.ХозяйственныеОперации.ВыпускПродукцииНаСклад;
			Строка.Получатель         = Строка.Склад;
			
		КонецЕсли;
		
	КонецЦикла;
	
	Для каждого Строка Из Объект.ВозвратныеОтходы Цикл
		
		Если Строка.ПроизводитсяВПроцессе Тогда
			
			Если ЗначениеЗаполнено(Строка.Склад) Тогда
				Строка.НаправлениеВыпуска = Перечисления.ХозяйственныеОперации.ВыпускПродукцииНаСклад;
				Строка.Получатель         = Строка.Склад;
			Иначе
				Строка.НаправлениеВыпуска = Перечисления.ХозяйственныеОперации.ВыпускПродукцииВПодразделение;
				Строка.Получатель         = Строка.Подразделение;
			КонецЕсли; 
			
		ИначеЕсли Строка.ТипНоменклатуры = Перечисления.ТипыНоменклатуры.Работа
			Или Строка.Подразделение <> Справочники.СтруктураПредприятия.ПустаяСсылка() Тогда
			
			Строка.НаправлениеВыпуска = Перечисления.ХозяйственныеОперации.ВыпускПродукцииВПодразделение;
			Строка.Получатель         = Строка.Подразделение;
			
		Иначе
			
			Строка.НаправлениеВыпуска = Перечисления.ХозяйственныеОперации.ВыпускПродукцииНаСклад;
			Строка.Получатель         = Строка.Склад;
			
		КонецЕсли;
		
	КонецЦикла;
	
	ЗаполнитьСлужебныеРеквизитыЭтапов();
	
	СохраненноеЗначениеПодразделение = Объект.Подразделение;
	СохраненноеЗначениеСклад = Объект.Склад;
	
КонецПроцедуры

&НаСервере
Процедура ЗаполнитьСлужебныеРеквизитыЭтапов()
	
	ТаблицаПолуфабрикатов = Новый ТаблицаЗначений;
	ТаблицаПолуфабрикатов.Колонки.Добавить("КлючСвязи", Новый ОписаниеТипов("Строка"));
	ТаблицаПолуфабрикатов.Колонки.Добавить("Номенклатура", Новый ОписаниеТипов("СправочникСсылка.Номенклатура"));
	ТаблицаПолуфабрикатов.Колонки.Добавить("Характеристика", Новый ОписаниеТипов("СправочникСсылка.ХарактеристикиНоменклатуры"));
	
	ПараметрыОтбора = Новый Структура("КлючСвязи");
	
	Для каждого СтрокаЭтап Из Объект.Этапы Цикл
		
		Если ЗначениеЗаполнено(СтрокаЭтап.КлючСвязиПолуфабрикат) Тогда
			
			ПараметрыОтбора.КлючСвязи = СтрокаЭтап.КлючСвязиПолуфабрикат;
			
			Для каждого СтрокаМатериал Из Объект.МатериалыИУслуги.НайтиСтроки(ПараметрыОтбора) Цикл
				
				НоваяСтрока = ТаблицаПолуфабрикатов.Добавить();
				НоваяСтрока.КлючСвязи = Строка(СтрокаЭтап.КлючСвязи);
				НоваяСтрока.Номенклатура = СтрокаМатериал.Номенклатура;
				НоваяСтрока.Характеристика = СтрокаМатериал.Характеристика;
				
				Прервать;
				
			КонецЦикла;
			
		КонецЕсли;
		
	КонецЦикла;
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	ТПолуфабрикатов.КлючСвязи КАК КлючСвязи,
	|	ТПолуфабрикатов.Номенклатура КАК Номенклатура,
	|	ТПолуфабрикатов.Характеристика КАК Характеристика
	|ПОМЕСТИТЬ ВТПолуфабрикатов
	|ИЗ
	|	&ТаблицаПолуфабрикатов КАК ТПолуфабрикатов
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ТПолуфабрикатов.КлючСвязи КАК КлючСвязи,
	|	ВЫБОР
	|		КОГДА ТПолуфабрикатов.Номенклатура = ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка)
	|			ТОГДА ""-""
	|		ИНАЧЕ ТПолуфабрикатов.Номенклатура.Наименование
	|	КОНЕЦ КАК Номенклатура,
	|	ТПолуфабрикатов.Характеристика.Наименование КАК Характеристика
	|ИЗ
	|	ВТПолуфабрикатов КАК ТПолуфабрикатов";
	
	Запрос.УстановитьПараметр("ТаблицаПолуфабрикатов", ТаблицаПолуфабрикатов);
	
	ДанныеПолуфабрикатов = Запрос.Выполнить().Выгрузить();
	
	ПараметрыОтбора = Новый Структура("КлючСвязи", "");
	
	СоответствиеДанныеЭтапов = Новый Соответствие;
	СоответствиеВыполнениеЭтаповНаСтороне = Новый Соответствие;
	
	ЭтапыВосстановленияБрака = Новый Массив;
	
	// Этапы.
	Для каждого Строка Из Объект.Этапы Цикл
		
		Строка.НаименованиеПолуфабриката = "";
		
		Если ЗначениеЗаполнено(Строка.КлючСвязиПолуфабрикат) Тогда
			
			ПараметрыОтбора.КлючСвязи = Строка(Строка.КлючСвязи);
			
			Для каждого СтрокаМатериал Из ДанныеПолуфабрикатов.НайтиСтроки(ПараметрыОтбора) Цикл
				
				Строка.НаименованиеПолуфабриката = НоменклатураКлиентСервер.ПредставлениеНоменклатуры(
																						СтрокаМатериал.Номенклатура, 
																						СтрокаМатериал.Характеристика);
				
				Прервать;
				
			КонецЦикла;
			
		КонецЕсли;
		
		ДанныеЭтапа = Новый Структура;
		ДанныеЭтапа.Вставить("НаименованиеЭтапа", Строка.НаименованиеЭтапа);
		ДанныеЭтапа.Вставить("НаименованиеПолуфабриката", Строка.НаименованиеПолуфабриката); 
			
		СоответствиеДанныеЭтапов.Вставить(Строка.КлючСвязи, ДанныеЭтапа);
		СоответствиеВыполнениеЭтаповНаСтороне.Вставить(Строка.КлючСвязи, Строка.ПроизводствоНаСтороне);
		
		Если Строка.ЭтапВосстановленияБрака Тогда
			ЭтапыВосстановленияБрака.Добавить(Строка.КлючСвязи);
		КонецЕсли;
		
	КонецЦикла;
	
	// Выходные изделия.
	Для каждого Строка Из Объект.ВыходныеИзделия Цикл
		
		ЗаполнитьЗначенияСвойств(Строка, СоответствиеДанныеЭтапов[Строка.КлючСвязиЭтапы]);
		
		Если ЭтапыВосстановленияБрака.Найти(Строка.КлючСвязиЭтапы) <> Неопределено Тогда
			Строка.ЭтапВосстановленияБрака = Истина;
		КонецЕсли;
		
	КонецЦикла;
	
	// Возвратные отходы.
	Для каждого Строка Из Объект.ВозвратныеОтходы Цикл
		
		ЗаполнитьЗначенияСвойств(Строка, СоответствиеДанныеЭтапов[Строка.КлючСвязиЭтапы]);
		
		Если ЭтапыВосстановленияБрака.Найти(Строка.КлючСвязиЭтапы) <> Неопределено Тогда
			Строка.ЭтапВосстановленияБрака = Истина;
		КонецЕсли;
		
	КонецЦикла;
	
	// Материалы и услуги.
	Для каждого Строка Из Объект.МатериалыИУслуги Цикл
		
		ЗаполнитьЗначенияСвойств(Строка, СоответствиеДанныеЭтапов[Строка.КлючСвязиЭтапы]);
		
		Строка.ПроизводствоНаСтороне = СоответствиеВыполнениеЭтаповНаСтороне[Строка.КлючСвязиЭтапы];
		Если ЭтапыВосстановленияБрака.Найти(Строка.КлючСвязиЭтапы) <> Неопределено Тогда
			Строка.ЭтапВосстановленияБрака = Истина;
		КонецЕсли;
		
	КонецЦикла;
		
	// Трудозатраты.
	Для каждого Строка Из Объект.Трудозатраты Цикл
		
		ЗаполнитьЗначенияСвойств(Строка, СоответствиеДанныеЭтапов[Строка.КлючСвязиЭтапы]);
		
		Если ЭтапыВосстановленияБрака.Найти(Строка.КлючСвязиЭтапы) <> Неопределено Тогда
			Строка.ЭтапВосстановленияБрака = Истина;
		КонецЕсли;
		
	КонецЦикла;
	
КонецПроцедуры

&НаСервере
Функция СоздатьСпецификациюНаОснованииСпецификацииЗаказа(ПараметрыСпецификации)

	НоваяСпецификация = УправлениеДаннымиОбИзделиях.СоздатьСпецификациюНаОснованииСпецификацииЗаказа(
							Объект, 
							Объект, 
							ПараметрыСпецификации);
	
	Возврат НоваяСпецификация;
	
КонецФункции

&НаКлиенте
Процедура СоздатьСпецификациюНаОснованииСпецификацииЗаказаЗавершение(РезультатЗакрытия, ДополнительныеПараметры) Экспорт

	Если ТипЗнч(РезультатЗакрытия) <> Тип("Структура") Тогда
		Возврат;
	КонецЕсли;
	
	НоваяСпецификация = СоздатьСпецификациюНаОснованииСпецификацииЗаказа(РезультатЗакрытия);
	Если НоваяСпецификация <> Неопределено Тогда
		
		ПоказатьЗначение(, НоваяСпецификация.Ссылка);
		
		ОповеститьОбИзменении(Тип("СправочникСсылка.РесурсныеСпецификации"));
		Оповестить("Запись_ЭтапыПроизводства");
		
		ПоказатьОповещениеПользователя(
				НСтр("ru = 'Создание:';
					|en = 'Created:'"), 
				ПолучитьНавигационнуюСсылку(НоваяСпецификация.Ссылка), 
				НоваяСпецификация.Наименование);
			
	Иначе
		
		ПоказатьПредупреждение(, НСтр("ru = 'Ошибка создания спецификации.';
										|en = 'An error occurred when creating BOM.'"));
		
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ПриИзмененииОтменено(ТекущиеДанные)
	
	СтруктураДействий = Новый Структура();
	
	Если ТекущиеДанные.Отменено
		И ТекущиеДанные.ВариантОбеспечения <> ПредопределенноеЗначение("Перечисление.ВариантыОбеспечения.НеТребуется") Тогда
		
		ТекущиеДанные.ЗаказатьНаСклад = Ложь;
		ТекущиеДанные.Склад = ПредопределенноеЗначение("Справочник.Склады.ПустаяСсылка");
		
		ДобавитьДействияОбеспеченияНаКлиенте(СтруктураДействий, "ВариантОбеспечения,ДоступноВДругихСтроках", ТекущиеДанные);
		ОбработкаТабличнойЧастиКлиент.ОбработатьСтрокуТЧ(ТекущиеДанные, СтруктураДействий, Неопределено);
		Если ОбеспечениеВДокументахКлиент.ТребуетсяОбновитьКолонкуДоступно(СтруктураДействий) Тогда
			ОбновитьКолонкуДоступноСервер();
		КонецЕсли;
		
	КонецЕсли;
	
	//++ НЕ УТКА
	Если ПравоЧтенияАналогов И ПоказатьАналоги Тогда 
		ОтметитьНаличиеАналогов();
	КонецЕсли;
	//-- НЕ УТКА
	
КонецПроцедуры

&НаСервере
Процедура ОбработатьИзменениеЭтапаНаСервере(ИмяТЧ)

	Если ИмяТЧ = "МатериалыИУслуги" Тогда
		
		ТекущаяСтрока = Элементы.МатериалыИУслуги.ТекущаяСтрока;
		ТекущиеДанные = Объект.МатериалыИУслуги.НайтиПоИдентификатору(ТекущаяСтрока);
		
		ЗаполнитьСпособПолученияМатериаловПоУмолчаниюНаСервере(ТекущиеДанные);
		ЗаполнитьНазначениеВСтрокеТЧМатериалыИУслугиНаСервере(ТекущиеДанные);
		
		//++ НЕ УТКА
		Если ПравоЧтенияАналогов И ПоказатьАналоги Тогда 
			ОтметитьНаличиеАналогов();
		КонецЕсли;
		//-- НЕ УТКА
		
	ИначеЕсли ИмяТЧ = "ВыходныеИзделия" Тогда
		
		ТекущаяСтрока = Элементы.ВыходныеИзделия.ТекущаяСтрока;
		ТекущиеДанные = Объект.ВыходныеИзделия.НайтиПоИдентификатору(ТекущаяСтрока);
	
		ЗаполнитьНазначениеВСтрокеТЧВыходныеИзделияНаСервере(
			ТекущиеДанные, Ложь, ПредопределенноеЗначение("Перечисление.ТипыСтоимостиВыходныхИзделий.Рассчитывается"));
		
		ЗаполнитьКоличествоИзделийСТипомСтоимостиРассчитывается();
		
	ИначеЕсли ИмяТЧ = "ВозвратныеОтходы" Тогда
		
		ТекущаяСтрока = Элементы.ВозвратныеОтходы.ТекущаяСтрока;
		ТекущиеДанные = Объект.ВозвратныеОтходы.НайтиПоИдентификатору(ТекущаяСтрока);
		
		ЗаполнитьНазначениеВСтрокеТЧВыходныеИзделияНаСервере(
			ТекущиеДанные, Ложь, ПредопределенноеЗначение("Перечисление.ТипыСтоимостиВыходныхИзделий.Фиксированная"));
			
	КонецЕсли;
	
	НастроитьОтображениеПредупрежденийПриРедактировании();

КонецПроцедуры

&НаКлиенте
Процедура ОткрытьПодборСерийЗавершение(РезультатЗакрытия, ДополнительныеПараметры) Экспорт

	Если РезультатЗакрытия <> Неопределено Тогда
		ОбработатьУказаниеСерийСервер(ДополнительныеПараметры.ПараметрыУказанияСерий, ДополнительныеПараметры.ПараметрыФормыУказанияСерий);
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Процедура ОбработатьУказаниеСерийСервер(ПараметрыУказанияСерий, ПараметрыФормыУказанияСерий)
	
	НоменклатураСервер.ОбработатьУказаниеСерий(Объект, ПараметрыУказанияСерий, ПараметрыФормыУказанияСерий);
	
КонецПроцедуры

&НаКлиенте
Процедура ЗаполнитьДанныеПродукцииНаКлиенте()
	
	ДанныеЗаполнения = Новый Структура;
	
	ДанныеЗаполнения.Вставить("КлючСвязи",        Объект.КлючСвязи);
	ДанныеЗаполнения.Вставить("Номенклатура",     Объект.Номенклатура);
	ДанныеЗаполнения.Вставить("Характеристика",   Объект.Характеристика);
	ДанныеЗаполнения.Вставить("Подразделение",    Объект.Подразделение);
	ДанныеЗаполнения.Вставить("Склад",            Объект.Склад);
	ДанныеЗаполнения.Вставить("Назначение",       Объект.Назначение);
	ДанныеЗаполнения.Вставить("НазначениеЗаказа", Объект.НазначениеЗаказа);
	
	ДанныеПродукции = ПланированиеПроизводстваКлиентСервер.СтруктураДанныхПродукции(ДанныеЗаполнения);
	ДанныеПродукции.ПоЗаказуДавальца               = Объект.ПроизводствоПоЗаказу;
	ДанныеПродукции.ОбосабливатьПоНазначениюЗаказа = Объект.ОбосабливатьПоНазначениюЗаказа;
	
КонецПроцедуры

&НаСервере
Процедура ЗаполнитьДанныеПродукцииНаСервере()
	
	ДанныеЗаполнения = Новый Структура;
	
	ДанныеЗаполнения.Вставить("КлючСвязи",        Объект.КлючСвязи);
	ДанныеЗаполнения.Вставить("Номенклатура",     Объект.Номенклатура);
	ДанныеЗаполнения.Вставить("Характеристика",   Объект.Характеристика);
	ДанныеЗаполнения.Вставить("Подразделение",    Объект.Подразделение);
	ДанныеЗаполнения.Вставить("Склад",            Объект.Склад);
	ДанныеЗаполнения.Вставить("Назначение",       Объект.Назначение);
	ДанныеЗаполнения.Вставить("НазначениеЗаказа", Объект.НазначениеЗаказа);
	
	ДанныеПродукции = ПланированиеПроизводства.СтруктураДанныхПродукции(ДанныеЗаполнения);
	ДанныеПродукции.ПоЗаказуДавальца               = Объект.ПроизводствоПоЗаказу;
	ДанныеПродукции.ОбосабливатьПоНазначениюЗаказа = Объект.ОбосабливатьПоНазначениюЗаказа;
	
КонецПроцедуры

&НаКлиенте
Процедура ЗаполнитьНазначениеВСтрокеТЧВыходныеИзделияНаКлиенте(ТекущиеДанные, НоваяСтрока, ТипСтоимости)

	Если ПланированиеПроизводстваКлиентСервер.НеобходимоОбновитьНазначениеВСтрокеТЧВыходныеИзделия(
			ТекущиеДанные, СохраненныеЗначения, ТипСтоимости, НоваяСтрока) Тогда
		
		ПланированиеПроизводстваКлиентСервер.ЗаполнитьНазначениеВСтрокеТЧВыходныеИзделия(
			ТекущиеДанные, ДанныеПродукции, ТипСтоимости);
		
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Процедура ЗаполнитьНазначениеВСтрокеТЧВыходныеИзделияНаСервере(ТекущиеДанные, НоваяСтрока, ТипСтоимости)

	Если ПланированиеПроизводстваКлиентСервер.НеобходимоОбновитьНазначениеВСтрокеТЧВыходныеИзделия(
			ТекущиеДанные, СохраненныеЗначения, ТипСтоимости, НоваяСтрока) Тогда
		
		ПланированиеПроизводстваКлиентСервер.ЗаполнитьНазначениеВСтрокеТЧВыходныеИзделия(
			ТекущиеДанные, ДанныеПродукции, ТипСтоимости);
		
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ЗаполнитьНазначениеВТЧВыходныеИзделияНаКлиенте(ДанныеПродукцииСохраненныеЗначения)
	
	РежимОбновления = "";
	
	Если ПланированиеПроизводстваКлиентСервер.НеобходимоОбновитьНазначениеВТЧВыходныеИзделия(
													ДанныеПродукции,
													ДанныеПродукцииСохраненныеЗначения,
													РежимОбновления) Тогда
		
		ЗаполнитьНазначениеВТЧВыходныеИзделияНаСервере(ДанныеПродукцииСохраненныеЗначения, Истина, РежимОбновления);
		
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Процедура ЗаполнитьНазначениеВТЧВыходныеИзделияНаСервере(ДанныеПродукцииСохраненныеЗначения, Обновить = Ложь, РежимОбновления = "")
	
	Если Обновить ИЛИ ПланированиеПроизводстваКлиентСервер.НеобходимоОбновитьНазначениеВТЧВыходныеИзделия(
													ДанныеПродукции,
													ДанныеПродукцииСохраненныеЗначения,
													РежимОбновления) Тогда
		
		ПланированиеПроизводстваКлиентСервер.ЗаполнитьНазначениеВТЧВыходныеИзделия(Объект, ДанныеПродукции, РежимОбновления);
		
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ЗаполнитьНазначениеВСтрокеТЧМатериалыИУслугиНаКлиенте(ТекущиеДанные, НоваяСтрока = Ложь)
	
	Если ПланированиеПроизводстваКлиентСервер.НеобходимоОбновитьНазначениеВСтрокеТЧМатериалыИУслуги(
			ТекущиеДанные, СохраненныеЗначения, НоваяСтрока) Тогда
		
		ПланированиеПроизводстваКлиентСервер.ЗаполнитьНазначениеВСтрокеТЧМатериалыИУслуги(
			ТекущиеДанные, ДанныеПродукции);
		
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Процедура ЗаполнитьНазначениеВСтрокеТЧМатериалыИУслугиНаСервере(ТекущиеДанные, НоваяСтрока = Ложь)
	
	Если ПланированиеПроизводстваКлиентСервер.НеобходимоОбновитьНазначениеВСтрокеТЧМатериалыИУслуги(
			ТекущиеДанные, СохраненныеЗначения, НоваяСтрока) Тогда
		
		ПланированиеПроизводстваКлиентСервер.ЗаполнитьНазначениеВСтрокеТЧМатериалыИУслуги(
			ТекущиеДанные, ДанныеПродукции);
		
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Процедура ЗаполнитьНазначениеВТЧМатериалыИУслугиНаСервере(ДанныеПродукцииСохраненныеЗначения, Обновить = Ложь)
	
	Если Обновить ИЛИ ПланированиеПроизводстваКлиентСервер.НеобходимоОбновитьНазначениеВТЧМатериалыИУслуги(
													ДанныеПродукции,
													ДанныеПродукцииСохраненныеЗначения) Тогда
		
		ПланированиеПроизводстваКлиентСервер.ЗаполнитьНазначениеВТЧМатериалыИУслуги(Объект, ДанныеПродукции);
		
	КонецЕсли;
	
КонецПроцедуры

&НаКлиентеНаСервереБезКонтекста
Процедура ЗаполнитьНаправлениеВыпускаНаОснованииСтрокиМатериала(ТекущиеДанные, ИмяПоляКлючСвязи, ТабличнаяЧасть)

	Если НЕ ТекущиеДанные.ПроизводитсяВПроцессе Тогда
		Возврат;
	КонецЕсли;
	
	СтруктураПоиска = Новый Структура(ИмяПоляКлючСвязи, ТекущиеДанные.КлючСвязи);
 	СписокСтрок = ТабличнаяЧасть.НайтиСтроки(СтруктураПоиска);
	Для каждого СтрокаИзделие Из СписокСтрок Цикл
		Если СтрокаИзделие.Номенклатура <> ТекущиеДанные.Номенклатура
			ИЛИ СтрокаИзделие.Характеристика <> ТекущиеДанные.Характеристика Тогда
			Продолжить; // Выходное изделие не относится к материалу (в спецификации несколько выходных изделий)
		КонецЕсли;
		
		Если ТекущиеДанные.ЗаказатьНаСклад Тогда
			СтрокаИзделие.НаправлениеВыпуска = ПредопределенноеЗначение("Перечисление.ХозяйственныеОперации.ВыпускПродукцииНаСклад");
			СтрокаИзделие.Получатель = ТекущиеДанные.Склад;
			СтрокаИзделие.Склад = ТекущиеДанные.Склад;
			СтрокаИзделие.Подразделение = ПредопределенноеЗначение("Справочник.СтруктураПредприятия.ПустаяСсылка");
		Иначе
			СтрокаИзделие.НаправлениеВыпуска = ПредопределенноеЗначение("Перечисление.ХозяйственныеОперации.ВыпускПродукцииВПодразделение");
			СтрокаИзделие.Получатель = ТекущиеДанные.Подразделение;
			СтрокаИзделие.Склад = ПредопределенноеЗначение("Справочник.Склады.ПустаяСсылка");
			СтрокаИзделие.Подразделение = ТекущиеДанные.Подразделение;
		КонецЕсли; 
	КонецЦикла; 

КонецПроцедуры

&НаКлиенте
Процедура ЗаполнитьСкладМатериалаНаОснованииСтрокиИзделия(ТекущиеДанные, КлючСвязи)

	Если НЕ ТекущиеДанные.ПроизводитсяВПроцессе Тогда
		Возврат;
	КонецЕсли;
	
	СтруктураПоиска = Новый Структура("КлючСвязи", КлючСвязи);
 	СписокСтрок = Объект.МатериалыИУслуги.НайтиСтроки(СтруктураПоиска);
	Для каждого СтрокаМатериал Из СписокСтрок Цикл
		
		Если ТекущиеДанные.НаправлениеВыпуска = ПредопределенноеЗначение("Перечисление.ХозяйственныеОперации.ВыпускПродукцииНаСклад") Тогда
			НовыйСклад = ТекущиеДанные.Получатель;
		Иначе
			НовыйСклад = ПредопределенноеЗначение("Справочник.Склады.ПустаяСсылка");
			ТекущиеДанные.Склад = ПредопределенноеЗначение("Справочник.Склады.ПустаяСсылка");
			ТекущиеДанные.Подразделение = СтрокаМатериал.Подразделение;
			ТекущиеДанные.Получатель = ТекущиеДанные.Подразделение;
		КонецЕсли; 
		
		Если СтрокаМатериал.Склад = НовыйСклад Тогда
			Продолжить;
		КонецЕсли;
		
		Если СтрокаМатериал.Номенклатура = ТекущиеДанные.Номенклатура
			И СтрокаМатериал.Характеристика = ТекущиеДанные.Характеристика Тогда
			
			СтрокаМатериал.Склад = НовыйСклад;
			СтрокаМатериал.ЗаказатьНаСклад = ЗначениеЗаполнено(СтрокаМатериал.Склад);
			
			СтруктураДействий = Новый Структура;
			СтруктураДействий.Вставить("ПроверитьСериюРассчитатьСтатус", Новый Структура("Склад, ПараметрыУказанияСерий", СтрокаМатериал.Склад, ПараметрыУказанияСерий));
			ДобавитьДействияОбеспеченияНаКлиенте(СтруктураДействий, "ВариантОбеспечения,ДоступноВДругихСтроках", СтрокаМатериал);
			ОбработкаТабличнойЧастиКлиент.ОбработатьСтрокуТЧ(СтрокаМатериал, СтруктураДействий, КэшированныеЗначения);
			Если ОбеспечениеВДокументахКлиент.ТребуетсяОбновитьКолонкуДоступно(СтруктураДействий) Тогда
				ОбновитьКолонкуДоступноСервер();
			КонецЕсли;
			
		КонецЕсли;
		
	КонецЦикла;
	
КонецПроцедуры

#КонецОбласти

//-- Устарело_Производство21
