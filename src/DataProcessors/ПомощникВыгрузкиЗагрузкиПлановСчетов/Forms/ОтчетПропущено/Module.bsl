#Область ОбработчикиСобытийФормы

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	Параметры.Свойство("ТабличныйДокумент", ТабличныйДокумент);
	
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиСобытийЭлементовШапкиФормы

&НаКлиенте
Процедура ТабличныйДокументОбработкаРасшифровки(Элемент, Расшифровка, СтандартнаяОбработка, ДополнительныеПараметры)
	СтандартнаяОбработка = Ложь;;
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиКомандФормы

&НаКлиенте
Процедура СохранитьТаблицуПропущенных(Команда)
	
	Оповещение = Новый ОписаниеОповещения("ПослеВыбораФайлаДляСохраненияТаблицыПропущенных", ЭтотОбъект);
	ДиалогВыбораФайла = Новый ДиалогВыбораФайла(РежимДиалогаВыбораФайла.Сохранение);
	ДиалогВыбораФайла.Фильтр = НСтр("ru = 'Книга Excel 97 (*.xls)|*.xls|Книга Excel 2007 (*.xlsx)|*.xlsx|Электронная таблица OpenDocument (*.ods)|*.ods|Табличный документ (*.mxl)|*.mxl';
									|en = 'Microsoft Excel 97 (*.xls)|*.xls|Microsoft Excel 2007 (*.xlsx)|*.xlsx|OpenDocument Spreadsheet (*.ods)|*.ods|Spreadsheet document (*.mxl)|*.mxl'");
	ДиалогВыбораФайла.Заголовок = НСтр("ru = 'Укажите имя файла для сохранения таблицы пропущенных элементов';
										|en = 'To save the skipped items table, specify the file name'");
	ДиалогВыбораФайла.Расширение = "xls";
	ДиалогВыбораФайла.МножественныйВыбор = Ложь;
	ДиалогВыбораФайла.ПолноеИмяФайла = НСтр("ru = 'Таблицы пропущенных элементов';
											|en = 'Skipped items tables'");
	ДиалогВыбораФайла.ИндексФильтра = 0;
	ФайловаяСистемаКлиент.ПоказатьДиалогВыбора(Оповещение, ДиалогВыбораФайла);
	
КонецПроцедуры

&НаКлиенте
Процедура ЗагрузитьПовторно(Команда)
	
	Закрыть(ТабличныйДокумент);
	
КонецПроцедуры

&НаКлиенте
Процедура Готово(Команда)
	
	Закрыть();
	
КонецПроцедуры

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

&НаКлиенте
Процедура ПослеВыбораФайлаДляСохраненияТаблицыПропущенных(Результат, ДополнительныеПараметры) Экспорт
	
	Если НЕ Результат = Неопределено Тогда
		
		АдресВоВременномХранилище = СформироватьФайлНаСервере(ТабличныйДокумент, Результат[0]);
		ФайловаяСистемаКлиент.СохранитьФайл(Неопределено, АдресВоВременномХранилище, Результат[0]);
		
	КонецЕсли;
	
КонецПроцедуры

&НаСервереБезКонтекста
Функция СформироватьФайлНаСервере(ТабличныйДокумент, ПолноеИмяФайла)
	
	РасширениеФайла = ОбщегоНазначенияКлиентСервер.РасширениеБезТочки(ОбщегоНазначенияКлиентСервер.ПолучитьРасширениеИмениФайла(ПолноеИмяФайла));;
	
	ИмяФайла = ПолучитьИмяВременногоФайла(РасширениеФайла);
	Если РасширениеФайла = "xlsx" Тогда
		
		ТабличныйДокумент.Записать(ИмяФайла, ТипФайлаТабличногоДокумента.XLSX);
		
	ИначеЕсли РасширениеФайла = "xls" Тогда
		
		ТабличныйДокумент.Записать(ИмяФайла, ТипФайлаТабличногоДокумента.XLS);
		
	ИначеЕсли РасширениеФайла = "ods" Тогда
		
		ТабличныйДокумент.Записать(ИмяФайла, ТипФайлаТабличногоДокумента.ODS);
		
	Иначе 
		
		ТабличныйДокумент.Записать(ИмяФайла, ТипФайлаТабличногоДокумента.MXL);
		
	КонецЕсли;
	
	ДвоичныеДанные = Новый ДвоичныеДанные(ИмяФайла);
	
	АдресВоВременномХранилище = ПоместитьВоВременноеХранилище(ДвоичныеДанные, АдресВоВременномХранилище);
	
	ФайловаяСистема.УдалитьВременныйФайл(ИмяФайла);
	
	Возврат АдресВоВременномХранилище;
	
КонецФункции

#КонецОбласти