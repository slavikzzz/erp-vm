
#Область ОписаниеПеременных

&НаКлиенте
Перем мКэшКопированияВставки;

&НаКлиенте
Перем ЗакрытиеФормы;

#КонецОбласти

#Область ОбработчикиСобытийФормы

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	Если Параметры.Свойство("АвтоТест") Тогда
		Возврат;
	КонецЕсли;
	
	ДанныеФормы = Справочники.ЭлементыФинансовыхОтчетов.ФормаПриСозданииНаСервере(ЭтаФорма);
	ЗначениеВРеквизитФормы(ДанныеФормы.ЭлементыТаблицы, "ЭлементыТаблицы");
	
	ИдентификаторГлавногоХранилища = Параметры.ИдентификаторГлавногоХранилища;
	ИспользоватьДляВводаПлана = Параметры.ИспользоватьДляВводаПлана;
	ВариантРасположенияГраницыФактическихДанных = Параметры.ВариантРасположенияГраницыФактическихДанных;
	РедактируемыеЗначения = Параметры.РедактируемыеЗначения;
	СкорректироватьРедактируемыеЗначенияНаЭлементыТекущейТаблицы();
	
	Если Параметры.Свойство("ПроверятьВидТаблицы") Тогда
		ВидТаблицы = Неопределено;
		Параметры.Свойство("ВидТаблицы", ВидТаблицы);
		Если ВидТаблицы = Перечисления.ВидыЭлементовФинансовогоОтчета.ТаблицаПоказателиВКолонках
		 ИЛИ ВидТаблицы = Перечисления.ВидыЭлементовФинансовогоОтчета.ТаблицаПоказателиВСтроках Тогда
			ЭтоПростаяТаблица = Истина;
		КонецЕсли;
	КонецЕсли;
	
	Шапка = РеквизитФормыВЗначение("Объект").ПолучитьМакет("ЛегендаНастройкиЯчеек");
	ПредставлениеОтчета.Очистить();
	
	Если ЭтоПростаяТаблица Тогда
		Элементы.ПредставлениеОтчетаКонтекстноеМенюВырезать.Видимость = Ложь;
		Элементы.ПредставлениеОтчетаКонтекстноеМенюВырезать.Доступность = Ложь;
		Элементы.ПредставлениеОтчетаКонтекстноеМенюКопировать.Видимость = Ложь;
		Элементы.ПредставлениеОтчетаКонтекстноеМенюКопировать.Доступность = Ложь;
		Элементы.ПредставлениеОтчетаКонтекстноеМенюВставить.Видимость = Ложь;
		Элементы.ПредставлениеОтчетаКонтекстноеМенюВставить.Доступность = Ложь;
		Элементы.ПредставлениеОтчетаКонтекстноеМенюОчистить.Видимость = Ложь;
		Элементы.ПредставлениеОтчетаКонтекстноеМенюОчистить.Доступность = Ложь;
		Элементы.ПредставлениеОтчетаКонтекстноеМенюСвойства.Видимость = Ложь;
		Элементы.ПредставлениеОтчетаКонтекстноеМенюСвойства.Доступность = Ложь;
	ИначеЕсли Не ЭтоПростаяТаблица Тогда
		Легенда = Шапка.ПолучитьОбласть(?(ИспользоватьДляВводаПлана, "ЛегендаОбластиВвода", "ЛегендаОбласти"));
		ПредставлениеОтчета.Вывести(Легенда);
	КонецЕсли;
	
	СтрокаОтчета = Параметры.ЭлементыОтчета.НайтиПоИдентификатору(Параметры.ИдентификаторСтрокиЭлементаОтчета);
	ИдентификаторСтрокиЭлементаОтчета = СтрокаОтчета.АдресСтруктурыЭлемента;
	ДеревоЭлементов = ДанныеФормыВЗначение(Параметры.ЭлементыОтчета, Тип("ДеревоЗначений"));
	КопияДереваЭлементов = ДеревоЭлементов.Скопировать();
	КопияДереваЭлементов.Строки.Очистить();
	
	СтрокаДерева = ФинансоваяОтчетностьСервер.ТаблицаЭлемента(ДеревоЭлементов, АдресЭлементаВХранилище);
	Если СтрокаДерева = Неопределено Тогда
		ВызватьИсключение НСтр("ru = 'Неверные параметры данных настройки ячеек';
								|en = 'Incorrect parameters of cell setting data'")
	КонецЕсли;
	
	ПараметрыУстановки = ФинансоваяОтчетностьСервер.ШаблонПараметровУстановкиНовогоРодителя();
	ПараметрыУстановки.КонтрольЗацикливания = Ложь;
	ФинансоваяОтчетностьСервер.УстановитьНовогоРодителя(СтрокаДерева, КопияДереваЭлементов, ПараметрыУстановки);
	
	СтруктураШирин = Справочники.ЭлементыФинансовыхОтчетов.ВывестиТаблицуНастройкиСложнойТаблицы(
				ЭтаФорма, КопияДереваЭлементов);
	
	АдресЭлементовОтчета = ПоместитьВоВременноеХранилище(КопияДереваЭлементов, УникальныйИдентификатор);
	
	ШиринаМакета = СтруктураШирин.мШиринаМакета;
	ВысотаМакета = СтруктураШирин.мВысотаМакета;
	ВысотаШапки = СтруктураШирин.мВысотаШапки;
	ГлубинаОбъединения = БюджетнаяОтчетностьРасчетКэшаСервер.РассчитатьГлубинуУровней(КопияДереваЭлементов);
	
	СтруктураЭлемента  = ПолучитьИзВременногоХранилища(АдресЭлементаВХранилище); // См. ФинансоваяОтчетностьКлиентСервер.СтруктураЭлементаОтчета
	Для Каждого СтрокаЭлементаОформления Из СтруктураЭлемента.ЭлементыОформления Цикл
		
		НоваяСтрока = СписокЭлементовОформления.Добавить();
		НоваяСтрока.КлючЭлементаОформления = СтрокаЭлементаОформления.КлючЭлементаОформления;
		НоваяСтрока.ТипОформляемойОбласти  = СтрокаЭлементаОформления.ТипОформляемойОбласти;
		
		НоваяСтрока.УсловиеХранилище    = ПоместитьВоВременноеХранилище(СтрокаЭлементаОформления.Условие.Получить(), УникальныйИдентификатор);
		НоваяСтрока.ОформлениеХранилище = ПоместитьВоВременноеХранилище(СтрокаЭлементаОформления.Оформление.Получить(), УникальныйИдентификатор);
		
		СтруктураПоиска = Новый Структура("КлючЭлементаОформления", НоваяСтрока.КлючЭлементаОформления);
		
		ТаблицаОформляемыхЭлементов = СтруктураЭлемента.ОформляемыеСтроки.Скопировать(СтруктураПоиска);
		НоваяСтрока.ОформляемыеСтрокиХранилище  = ПоместитьВоВременноеХранилище(ТаблицаОформляемыхЭлементов, УникальныйИдентификатор);
		
		ТаблицаОформляемыхЭлементов = СтруктураЭлемента.ОформляемыеКолонки.Скопировать(СтруктураПоиска);
		НоваяСтрока.ОформляемыеКолонкиХранилище = ПоместитьВоВременноеХранилище(ТаблицаОформляемыхЭлементов, УникальныйИдентификатор);
		
		ТаблицаОформляемыхЭлементов = СтруктураЭлемента.РасшифровкаПолейОтбораЭО.Скопировать(СтруктураПоиска);
		НоваяСтрока.РасшифровкаПолейОтбораЭОХранилище = ПоместитьВоВременноеХранилище(ТаблицаОформляемыхЭлементов, УникальныйИдентификатор);
		
		ЗаполнитьПредставленияСтроки(НоваяСтрока);
		
	КонецЦикла;
	
	ОбновитьНомераСтрокУсловногоОформления();
	
	УправлениеФормой();
	УстановитьВидимостьЭлементовОформления();
	
	УстановитьЦветЯчеек();
	
	ВидимостьЭлементовОформления = Ложь;
	
	
	СобытияФорм.ПриСозданииНаСервере(ЭтаФорма, Отказ, СтандартнаяОбработка);
	
КонецПроцедуры

&НаКлиенте
Процедура ПриОткрытии(Отказ)
	
	ОбластьРедактирования = ПолучитьОбластьРедактирования(ЭтаФорма);
	Всего = ОбластьРедактирования.Право - ОбластьРедактирования.Лево + 1;
	
	Если Всего Тогда
		ШиринаЗанято = 0;
		Для Сч = 1 По ОбластьРедактирования.Лево - 1 Цикл
			ШиринаЗанято = ШиринаЗанято + ПредставлениеОтчета.Область(,Сч,,Сч).ШиринаКолонки;
		КонецЦикла;
		ВсегоШирина = 120; // рекомендуемая ширина таблицы
		ШиринаСвободно = ВсегоШирина - ШиринаЗанято;
		ШиринаКолонкиРекомендуемая = Макс(Мин(ШиринаСвободно / Всего, 30), 15);
		
		Для Сч = ОбластьРедактирования.Лево По ОбластьРедактирования.Право Цикл
			ПредставлениеОтчета.Область(,Сч,,Сч).ШиринаКолонки = ШиринаКолонкиРекомендуемая;
		КонецЦикла;
	КонецЕсли;
	
	ПредставлениеОтчета.ФиксацияСверху = ПолучитьОбластьРедактирования(ЭтаФорма).Верх - 1;
	
КонецПроцедуры

&НаСервере
Процедура ПередЗаписьюНаСервере(Отказ, ТекущийОбъект, ПараметрыЗаписи)
	
	Справочники.ЭлементыФинансовыхОтчетов.ФормаПередЗаписьюНаСервере(ЭтаФорма, ТекущийОбъект, Отказ);
	Если ЗначениеЗаполнено(ЭтаФорма.АдресЭлементаВХранилище) Тогда
		
		СтруктураЭлемента = ПолучитьИзВременногоХранилища(ЭтаФорма.АдресЭлементаВХранилище); // См. ФинансоваяОтчетностьКлиентСервер.СтруктураЭлементаОтчета
		АдресВХранилище = ЭлементыОтчета();
		СтруктураЭлемента.ЭлементыТаблицы = ПолучитьИзВременногоХранилища(АдресВХранилище);
		
		СтруктураЭлемента.ЭлементыОформления.Очистить();
		СтруктураЭлемента.ОформляемыеСтроки.Очистить();
		СтруктураЭлемента.ОформляемыеКолонки.Очистить();
		СтруктураЭлемента.РасшифровкаПолейОтбораЭО.Очистить();
		
		Для Каждого СтрокаУсловногоОформления Из СписокЭлементовОформления Цикл
			
			НовыйЭлементОформления = СтруктураЭлемента.ЭлементыОформления.Добавить();
			ЗаполнитьЗначенияСвойств(НовыйЭлементОформления, СтрокаУсловногоОформления);
			НовыйЭлементОформления.Оформление = Новый ХранилищеЗначения(
						ПолучитьИзВременногоХранилища(СтрокаУсловногоОформления.ОформлениеХранилище));
			НовыйЭлементОформления.Условие = Новый ХранилищеЗначения(
						ПолучитьИзВременногоХранилища(СтрокаУсловногоОформления.УсловиеХранилище));
			
			Таблица = ПолучитьИзВременногоХранилища(СтрокаУсловногоОформления.ОформляемыеСтрокиХранилище);
			Если Таблица.Колонки.Найти("КлючЭлементаОформления") = Неопределено Тогда
				Таблица.Колонки.Добавить("КлючЭлементаОформления");
			КонецЕсли;
			Таблица.ЗаполнитьЗначения(СтрокаУсловногоОформления.КлючЭлементаОформления, "КлючЭлементаОформления");
			ОбщегоНазначенияКлиентСервер.ДополнитьТаблицу(Таблица, СтруктураЭлемента.ОформляемыеСтроки);
			
			Таблица = ПолучитьИзВременногоХранилища(СтрокаУсловногоОформления.ОформляемыеКолонкиХранилище);
			Если Таблица.Колонки.Найти("КлючЭлементаОформления") = Неопределено Тогда
				Таблица.Колонки.Добавить("КлючЭлементаОформления");
			КонецЕсли;
			Таблица.ЗаполнитьЗначения(СтрокаУсловногоОформления.КлючЭлементаОформления, "КлючЭлементаОформления");
			ОбщегоНазначенияКлиентСервер.ДополнитьТаблицу(Таблица, СтруктураЭлемента.ОформляемыеКолонки);
			
			Таблица = ПолучитьИзВременногоХранилища(СтрокаУсловногоОформления.РасшифровкаПолейОтбораЭОХранилище);
			Если Таблица.Колонки.Найти("КлючЭлементаОформления") = Неопределено Тогда
				Таблица.Колонки.Добавить("КлючЭлементаОформления");
			КонецЕсли;
			Таблица.ЗаполнитьЗначения(СтрокаУсловногоОформления.КлючЭлементаОформления, "КлючЭлементаОформления");
			ОбщегоНазначенияКлиентСервер.ДополнитьТаблицу(Таблица, СтруктураЭлемента.РасшифровкаПолейОтбораЭО);
			
		КонецЦикла;
		
		ПоместитьВоВременноеХранилище(СтруктураЭлемента, ЭтаФорма.АдресЭлементаВХранилище);
		
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ПередЗакрытием(Отказ, СтандартнаяОбработка)
	
	СтандартнаяОбработка = Ложь;
	Если Модифицированность И Не ЗакрытиеФормы = Истина Тогда
		ОписаниеОповещения = Новый ОписаниеОповещения("ПередЗакрытиемОбработкаОповещения", ЭтаФорма);
		ТекстВопроса = НСтр("ru = 'Все внесенные изменения будут потеряны. Закрыть форму?';
							|en = 'All changes you have made will be lost. Close the form?'");
		ПоказатьВопрос(ОписаниеОповещения, ТекстВопроса, РежимДиалогаВопрос.ДаНет);
		Отказ = Истина;
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиСобытийЭлементовШапкиФормы

&НаКлиенте
Процедура ПредставлениеВариантаИспользованияЯчейкиНачалоВыбора(Элемент, ДанныеВыбора, СтандартнаяОбработка)
	
	Модифицированность = Истина;
	СтандартнаяОбработка = Ложь;
	ОписаниеОповещения = Новый ОписаниеОповещения("ВыборТипЭлемента", ЭтаФорма);
	
	ПараметрыФормы = Новый Структура();
	ПараметрыФормы.Вставить("ИспользоватьДляВводаПлана", ИспользоватьДляВводаПлана);
	ОткрытьФорму("Справочник.ЭлементыФинансовыхОтчетов.Форма.ВыборТипаЭлементаТаблицы", ПараметрыФормы,
		ЭтаФорма,,,,ОписаниеОповещения,РежимОткрытияОкнаФормы.БлокироватьОкноВладельца);
	
КонецПроцедуры

&НаКлиенте
Процедура ПредставлениеВариантаИспользованияЯчейкиОчистка(Элемент, СтандартнаяОбработка)
	
	Область = Элементы.ПредставлениеОтчета.ТекущаяОбласть;
	Если ОбластьВЗонеРедактирования(ЭтаФорма, Область) Тогда
		Модифицированность = Истина;
		ПредставлениеВариантаИспользованияЯчейкиОчисткаНаСервере();
		УстановитьЦветЯчейки(Область, ИспользоватьДляВводаПлана, ЭтоПростаяТаблица);
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ТабличныйДокументПриАктивизацииОбласти(Элемент)
	
	Область = Элемент.ТекущаяОбласть;
	Если Не ОбластьВЗонеРедактирования(ЭтаФорма, Область) Тогда
		
		ИмяЯчейки = ""; Формула = "";
		Элементы.ПредставлениеВариантаИспользованияЯчейки.Доступность = Ложь;
		УправлениеФормой();
		Возврат;
		
	КонецЕсли;
	
	Расшифровка = РасшифровкаОбластиТабличногоДокумента(Область);
	Если ТипЗнч(Расшифровка) = Тип("Структура") Тогда
		
		Элементы.ПредставлениеВариантаИспользованияЯчейки.Доступность = Истина;
		Строка = Расшифровка["Строка"]["Наименование"];
		Колонка = Расшифровка["Колонка"]["Наименование"];
		ИмяЯчейки = "[" + Строка + "; " + Колонка + "]";
		УправлениеФормой();
		
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ФормулаПриИзменении(Элемент)
	
	Область = Элементы.ПредставлениеОтчета.ТекущаяОбласть;
	Если ОбластьВЗонеРедактирования(ЭтаФорма, Область) Тогда
		ФормулаПриИзмененииНаСервере();
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ФормулаОткрытие(Элемент, СтандартнаяОбработка)
	
	СтандартнаяОбработка = Ложь;
	ПредставлениеОтчетаВыбор(Неопределено, Элементы.ПредставлениеОтчета.ТекущаяОбласть, Неопределено);
	
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиКомандФормы

&НаКлиенте
Процедура ЗавершитьРедактирование(Команда)
	
	ФинансоваяОтчетностьКлиент.ЗавершитьРедактированиеЭлементаОтчета(ЭтаФорма);
	
КонецПроцедуры

&НаКлиенте
Процедура Вырезать(Команда)
	
	КопироватьЗначения(Истина);
	
КонецПроцедуры

&НаКлиенте
Процедура Вставить(Команда)
	
	Если мКэшКопированияВставки = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	ТекущаяОбласть = Элементы.ПредставлениеОтчета.ТекущаяОбласть;
	Если Не ОбластьВЗонеРедактирования(ЭтаФорма, ТекущаяОбласть) Тогда
		ТекстПредупреждения = НСтр("ru = 'Невозможно заменить выбранную область';
									|en = 'Cannot replace the selected area'");
		ПоказатьПредупреждение(, ТекстПредупреждения);
		Возврат;
	КонецЕсли;
	
	ОбластьРедактирования = ПолучитьОбластьРедактирования(ЭтаФорма);
	
	ВысотаОбласти = мКэшКопированияВставки.Количество();
	ШиринаОбласти = мКэшКопированияВставки[0].Количество();
	
	Отказ = Ложь;
	
	Если ВысотаОбласти > 1 ИЛИ ШиринаОбласти > 1 Тогда
		// В буфере несколько ячеек - можно только указать куда копировать
		Если ОбластьРедактирования.Право < ТекущаяОбласть.Лево + мКэшКопированияВставки[0].ВГраница()
			ИЛИ ОбластьРедактирования.Низ < ТекущаяОбласть.Верх + мКэшКопированияВставки.ВГраница() Тогда
			
			// Вышли за границы области редактирования
			Отказ = Истина;
			
		КонецЕсли;
	Иначе
		// В буфере одна ячейка - можно копировать куда угодно в пределах области редактирования.
		Если Не ОбластьВЗонеРедактирования(ЭтаФорма, ТекущаяОбласть) Тогда
			
			// Вышли за границы области редактирования
			Отказ = Истина;
			
		КонецЕсли;
	КонецЕсли;
	
	Если Отказ Тогда
		ТекстПредупреждения = НСтр("ru = 'Невозможно заменить выделенную область';
									|en = 'Cannot replace the selected area'");
		ПоказатьПредупреждение(, ТекстПредупреждения);
		Возврат;
		
	КонецЕсли;
	
	ВставитьНаСервере(мКэшКопированияВставки, ВысотаОбласти, ШиринаОбласти);
	
	ТабличныйДокументПриАктивизацииОбласти(Элементы.ПредставлениеОтчета);
	
КонецПроцедуры

&НаКлиенте
Процедура Копировать(Команда)
	
	КопироватьЗначения();
	
КонецПроцедуры

&НаКлиенте
Процедура Очистить(Команда)
	
	ОчиститьСервер();
	
КонецПроцедуры

&НаКлиенте
Процедура Свойства(Команда)
	
	ПоказатьСвойстваОбласти(Элементы.ПредставлениеОтчета.ТекущаяОбласть)
	
КонецПроцедуры

&НаКлиенте
Процедура Подключаемый_ВыполнитьПереопределяемуюКоманду(Команда)
	
	СобытияФормКлиент.ВыполнитьПереопределяемуюКоманду(ЭтаФорма, Команда);
	
КонецПроцедуры

&НаКлиенте
Процедура ОткрытьЭлемент(Команда)
	
	ВыбраннаяСтрока = Элементы.СписокЭлементовОформления.ТекущаяСтрока;
	Если ВыбраннаяСтрока = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	ПараметрыФормы = ПараметрыОткрытияЭлементаУсловногоОформления(Элементы.СписокЭлементовОформления.ТекущаяСтрока);
	
	ОписаниеОповещения = Новый ОписаниеОповещения("ПриИзмененииУсловногоОформления", ЭтаФорма, ВыбраннаяСтрока);
	
	ОткрытьФорму("Справочник.ЭлементыФинансовыхОтчетов.Форма.РедактированиеЭлементаУсловногоОформления",
		ПараметрыФормы,,,,,
		ОписаниеОповещения,
		РежимОткрытияОкнаФормы.БлокироватьОкноВладельца);
	
	
КонецПроцедуры

&НаКлиенте
Процедура Нумерация(Команда)
	
	ПараметрыФормы = Новый Структура;
	ПараметрыФормы.Вставить("ОтображатьНумерациюКолонок", ОтображатьНумерациюКолонок);
	ПараметрыФормы.Вставить("ОтображатьНумерациюСтрок", ОтображатьНумерациюСтрок);
	
	ОписаниеОповещения = Новый ОписаниеОповещения("ЗавершениеРедактированияНумерации", ЭтаФорма);
	ОткрытьФорму("Справочник.ЭлементыФинансовыхОтчетов.Форма.НастройкаЯчеекНастройкаНумерации",
		ПараметрыФормы,,,,,
		ОписаниеОповещения,
		РежимОткрытияОкнаФормы.БлокироватьОкноВладельца);
	
КонецПроцедуры

&НаКлиенте
Процедура ОформитьВыделенныеЯчейки(Команда)
	
	ТекстПредупреждения = НСтр("ru = 'Условное оформление можно применять к областям:
										|- Прямоугольные области ячеек с показателями отчета
										|- Строки или колонки
										|- Заголовки строк и колонок
										|- Вся таблица';
										|en = 'Conditional appearance can be applied to the following areas:
										|- Rectangular cell areas with the report indicators
										|- Rows or columns
										|- Titles of rows and columns
										|- The whole table'");
	ВыделенныеОбласти = ПредставлениеОтчета.ВыделенныеОбласти;
	Если ВыделенныеОбласти.Количество() > 1 Тогда
		ПоказатьПредупреждение(,ТекстПредупреждения);
		Возврат;
	КонецЕсли;
	
	ОбластьОформления = ВыделенныеОбласти[0];
	
	ОбластьРедактирования = ПолучитьОбластьРедактирования(ЭтаФорма);
	ЭтоСтрока = ОбластьОформления.Лево <= 2 И (ОбластьОформления.Право = 0 ИЛИ ОбластьОформления.Право >= ОбластьРедактирования.Право);
	
	ТипОформляемойОбласти = Неопределено;
	
	Если ЭтоСтрока Тогда
		Если ОбластьОформления.Верх <= ПерваяСтрока
			И (ОбластьОформления.Низ = 0 ИЛИ ОбластьОформления.Низ >= ОбластьРедактирования.Низ) Тогда
			
			ТипОформляемойОбласти = ПредопределенноеЗначение("Перечисление.ТипыОформляемыхОбластейБюджетныхОтчетов.ВсяТаблица");
			
		ИначеЕсли ОбластьОформления.Верх >= ОбластьРедактирования.Верх И ОбластьОформления.Низ <= ОбластьРедактирования.Низ Тогда
			
			ТипОформляемойОбласти = ПредопределенноеЗначение("Перечисление.ТипыОформляемыхОбластейБюджетныхОтчетов.ВсяСтрока");
			
		КонецЕсли;
	КонецЕсли;
	
	Если ТипОформляемойОбласти = Неопределено Тогда
		ЭтоКолонка = ОбластьОформления.Верх <= ПерваяСтрока И (ОбластьОформления.Низ = 0 ИЛИ ОбластьОформления.Низ >= ОбластьРедактирования.Низ);
		Если ЭтоКолонка
			И ОбластьОформления.Лево >= ОбластьРедактирования.Лево И ОбластьОформления.Право <= ОбластьРедактирования.Право Тогда
			
			ТипОформляемойОбласти = ПредопределенноеЗначение("Перечисление.ТипыОформляемыхОбластейБюджетныхОтчетов.ВсяКолонка");
			
		КонецЕсли;
	КонецЕсли;
	
	Если ТипОформляемойОбласти = Неопределено
		И (ОбластьОформления.Лево <= 1 
			ИЛИ ОбластьОформления.Право > ОбластьРедактирования.Право
			ИЛИ ОбластьОформления.Верх < ПерваяСтрока
			ИЛИ ОбластьОформления.Низ > ОбластьРедактирования.Низ) Тогда
		
		ПоказатьПредупреждение(,ТекстПредупреждения);
		Возврат;
		
	КонецЕсли;
	
	Если ТипОформляемойОбласти = Неопределено Тогда
		Если ОбластьОформления.Низ < ОбластьРедактирования.Верх И ОбластьОформления.Верх >= ПерваяСтрока Тогда
			
			ТипОформляемойОбласти = ПредопределенноеЗначение("Перечисление.ТипыОформляемыхОбластейБюджетныхОтчетов.ЗаголовкиКолонок");
			
		КонецЕсли;
	КонецЕсли;
	
	Если ТипОформляемойОбласти = Неопределено Тогда
		Если ОбластьОформления.Лево >= 2 И ОбластьОформления.Право < ОбластьРедактирования.Лево Тогда
			
			ТипОформляемойОбласти = ПредопределенноеЗначение("Перечисление.ТипыОформляемыхОбластейБюджетныхОтчетов.ЗаголовкиСтрок");
			
		КонецЕсли;
	КонецЕсли;
	
	Если ТипОформляемойОбласти = Неопределено Тогда
		Если ОбластьОформления.Лево >= ОбластьРедактирования.Лево И ОбластьОформления.Право <= ОбластьРедактирования.Право
			И ОбластьОформления.Верх >= ОбластьРедактирования.Верх И ОбластьОформления.Низ <= ОбластьРедактирования.Низ Тогда
			
			ТипОформляемойОбласти = ПредопределенноеЗначение("Перечисление.ТипыОформляемыхОбластейБюджетныхОтчетов.ЯчейкиНаПересеченииСтрокИКолонок");
			
		КонецЕсли;
	КонецЕсли;
	
	Если ТипОформляемойОбласти = Неопределено Тогда
		
		ПоказатьПредупреждение(,ТекстПредупреждения);
		Возврат;
		
	КонецЕсли;
	
	СписокСтрок = Новый Массив;
	СписокКолонок = Новый Массив;
	ПоляОтбора = Новый Массив;
	ПоляОтбораЗначений = Новый Массив;
	
	Если ТипОформляемойОбласти = ПредопределенноеЗначение("Перечисление.ТипыОформляемыхОбластейБюджетныхОтчетов.ЯчейкиНаПересеченииСтрокИКолонок") Тогда
		Для Колонка = ОбластьОформления.Лево По ОбластьОформления.Право Цикл
			Для Строка = ОбластьОформления.Верх По ОбластьОформления.Низ Цикл
				Область = ПредставлениеОтчета.Область(Строка, Колонка);
				Расшифровка = РасшифровкаОбластиТабличногоДокумента(Область);
				СписокСтрок.Добавить(Расшифровка["Строка"].ЭлементОтчета);
				СписокКолонок.Добавить(Расшифровка["Колонка"].ЭлементОтчета);
				ПоляОтбора.Добавить(Расшифровка["Строка"].ЭлементОтчета);
				ПоляОтбора.Добавить(Расшифровка["Колонка"].ЭлементОтчета);
			КонецЦикла;
		КонецЦикла;
	ИначеЕсли ТипОформляемойОбласти = ПредопределенноеЗначение("Перечисление.ТипыОформляемыхОбластейБюджетныхОтчетов.ЗаголовкиКолонок") Тогда
		Для Колонка = ОбластьОформления.Лево По ОбластьОформления.Право Цикл
			Для Строка = ОбластьОформления.Верх По ОбластьОформления.Низ Цикл
				Область = ПредставлениеОтчета.Область(Строка, Колонка);
				СписокКолонок.Добавить(Область.Расшифровка);
			КонецЦикла;
		КонецЦикла;
	ИначеЕсли ТипОформляемойОбласти = ПредопределенноеЗначение("Перечисление.ТипыОформляемыхОбластейБюджетныхОтчетов.ЗаголовкиСтрок") Тогда
		Для Колонка = ОбластьОформления.Лево По ОбластьОформления.Право Цикл
			Для Строка = ОбластьОформления.Верх По ОбластьОформления.Низ Цикл
				Область = ПредставлениеОтчета.Область(Строка, Колонка);
				СписокСтрок.Добавить(Область.Расшифровка);
				Если ЗначениеЗаполнено(Область.Расшифровка) Тогда
					ПоляОтбора.Добавить(Область.Расшифровка);
				КонецЕсли;
			КонецЦикла;
		КонецЦикла;
	ИначеЕсли ТипОформляемойОбласти = ПредопределенноеЗначение("Перечисление.ТипыОформляемыхОбластейБюджетныхОтчетов.ВсяСтрока") Тогда
		Для Колонка = 2 По 2 + ГлубинаОбъединения - 1 Цикл
			Для Строка = ОбластьОформления.Верх По ОбластьОформления.Низ Цикл
				Область = ПредставлениеОтчета.Область(Строка, Колонка);
				СписокСтрок.Добавить(Область.Расшифровка);
				ПоляОтбора.Добавить(Область.Расшифровка);
				Для КолонкаОтбора = ОбластьРедактирования.Лево По ОбластьРедактирования.Право Цикл
					ОбластьЗначения = ПредставлениеОтчета.Область(Строка, КолонкаОтбора);
					ПоляОтбораЗначений.Добавить(ОбластьЗначения.Расшифровка.Колонка.ЭлементОтчета);
				КонецЦикла;
			КонецЦикла;
		КонецЦикла;
	ИначеЕсли ТипОформляемойОбласти = ПредопределенноеЗначение("Перечисление.ТипыОформляемыхОбластейБюджетныхОтчетов.ВсяКолонка") Тогда
		Для Колонка = ОбластьОформления.Лево По ОбластьОформления.Право Цикл
			Для Строка = ПерваяСтрока По ПерваяСтрока + ВысотаШапки Цикл
				Область = ПредставлениеОтчета.Область(Строка, Колонка);
				СписокКолонок.Добавить(Область.Расшифровка);
				ПоляОтбора.Добавить(Область.Расшифровка);
				Для СтрокаОтбора = ОбластьРедактирования.Верх По ОбластьРедактирования.Низ Цикл
					ОбластьЗначения = ПредставлениеОтчета.Область(СтрокаОтбора, Колонка);
					Расшифровка = РасшифровкаОбластиТабличногоДокумента(ОбластьЗначения);
					ПоляОтбораЗначений.Добавить(Расшифровка["Строка"].ЭлементОтчета);
				КонецЦикла;
			КонецЦикла;
		КонецЦикла;
	КонецЕсли;
	
	Если СписокСтрок.Найти(Неопределено) <> Неопределено Тогда
		ОбщегоНазначенияКлиентСервер.УдалитьВсеВхожденияЗначенияИзМассива(СписокСтрок, Неопределено);
		СписокСтрок.Добавить(Неопределено);
	КонецЕсли;
	СписокСтрок = ОбщегоНазначенияКлиентСервер.СвернутьМассив(СписокСтрок);
	
	Если СписокКолонок.Найти(Неопределено) <> Неопределено Тогда
		ОбщегоНазначенияКлиентСервер.УдалитьВсеВхожденияЗначенияИзМассива(СписокКолонок, Неопределено);
		СписокКолонок.Добавить(Неопределено);
	КонецЕсли;
	СписокКолонок = ОбщегоНазначенияКлиентСервер.СвернутьМассив(СписокКолонок);
	
	ПоляОтбора = ОбщегоНазначенияКлиентСервер.СвернутьМассив(ПоляОтбора);
	ДополнитьРодительскимиИзмерениями(ПоляОтбора);
	ПоляОтбораЗначений = ОбщегоНазначенияКлиентСервер.СвернутьМассив(ПоляОтбораЗначений);
	
	ПараметрыФормы = Новый Структура;
	ПараметрыФормы.Вставить("НастройкаЯчеек", Истина);
	ПараметрыФормы.Вставить("ЭтоПростаяТаблица", ЭтоПростаяТаблица);
	ПараметрыФормы.Вставить("ОформляемыеСтроки", СписокСтрок);
	ПараметрыФормы.Вставить("ОформляемыеКолонки", СписокКолонок);
	ПараметрыФормы.Вставить("ПоляОтбора", ПоляОтбора);
	ПараметрыФормы.Вставить("ПоляОтбораЗначений", ПоляОтбораЗначений);
	ПараметрыФормы.Вставить("ТипОформляемойОбласти", ТипОформляемойОбласти);
	ПараметрыФормы.Вставить("АдресЭлементовОтчета", АдресЭлементовОтчета);
	ПараметрыФормы.Вставить("АдресЭлементаВХранилище", АдресЭлементаВХранилище);
	
	ОписаниеОповещения = Новый ОписаниеОповещения("ПриИзмененииУсловногоОформления", ЭтаФорма);
	
	ОткрытьФорму("Справочник.ЭлементыФинансовыхОтчетов.Форма.РедактированиеЭлементаУсловногоОформления",
		ПараметрыФормы,,,,,
		ОписаниеОповещения,
		РежимОткрытияОкнаФормы.БлокироватьОкноВладельца);
	
КонецПроцедуры

&НаКлиенте
Процедура ЭлементыОформления(Команда)
	
	ВидимостьЭлементовОформления = Не ВидимостьЭлементовОформления;
	УстановитьВидимостьЭлементовОформления();
	
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиКомандТаблицыФормы

&НаКлиенте
Процедура СписокЭлементовОформленияВыбор(Элемент, ВыбраннаяСтрока, Поле, СтандартнаяОбработка)
	
	ПараметрыФормы = ПараметрыОткрытияЭлементаУсловногоОформления(ВыбраннаяСтрока);
	
	ОписаниеОповещения = Новый ОписаниеОповещения("ПриИзмененииУсловногоОформления", ЭтаФорма, ВыбраннаяСтрока);
	
	ОткрытьФорму("Справочник.ЭлементыФинансовыхОтчетов.Форма.РедактированиеЭлементаУсловногоОформления",
		ПараметрыФормы,,,,,
		ОписаниеОповещения,
		РежимОткрытияОкнаФормы.БлокироватьОкноВладельца);
	
	
КонецПроцедуры

&НаКлиенте
Процедура СписокЭлементовОформленияПриИзменении(Элемент)
	
	ОбновитьНомераСтрокУсловногоОформления();
	
КонецПроцедуры

&НаКлиенте
Процедура СписокЭлементовОформленияПередНачаломДобавления(Элемент, Отказ, Копирование, Родитель, Группа, Параметр)
	
	Отказ = Истина;
	
КонецПроцедуры

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

&НаКлиенте
Процедура ПередЗакрытиемОбработкаОповещения(Результат, ДополнительныеПараметры) Экспорт
	
	Если Результат = КодВозвратаДиалога.Да Тогда
		ЗакрытиеФормы = Истина;
		ЭтаФорма.Закрыть();
	КонецЕсли;
	
КонецПроцедуры

// Возвращает описанное значение расшифровки из области табличного документа.
// 
// Параметры:
// 	Область - ОбластьЯчеекТабличногоДокумента - 
// Возвращаемое значение:
// 	Структура - Структура расшифровки (см. Справочник.ЭлементыФинансовыхОтчетов.ВывестиЯчейки):
// 	 *Строка - Структура -:
// 	   **Наименование - Строка -
// 	   **ЭлементОтчета - СправочникСсылка.ЭлементыФинансовыхОтчетов, Строка - Элемент отчета или адрес временного хранилища.
// 	 *Колонка - Структура -:
// 	   **Наименование - Строка -
// 	   **ЭлементОтчета - СправочникСсылка.ЭлементыФинансовыхОтчетов, Строка - Элемент отчета или адрес временного хранилища.
// 	 *ВидЭлемента - ПеречислениеСсылка.ВидыЭлементовФинансовогоОтчета -
// 	 *ЭлементОтчета - СправочникСсылка.ЭлементыФинансовыхОтчетов, Строка - Элемент отчета или адрес временного хранилища.
// 	 *ЭтоСвязанный - Булево -
// 	
&НаКлиентеНаСервереБезКонтекста
Функция РасшифровкаОбластиТабличногоДокумента(Область)
	Возврат Область.Расшифровка;
КонецФункции

&НаСервереБезКонтекста
Функция МассивИменТекущейТаблицы(АдресТаблицыЭлементов)
	
	ТаблицаЭлементов = ПолучитьИзВременногоХранилища(АдресТаблицыЭлементов); // См. БюджетнаяОтчетностьРасчетКэшаСервер.НовыйТаблицаЭлементов
	МассивИменТекущейТаблицы = Новый Массив;
	Для Каждого СтрокаЭлементов Из ТаблицаЭлементов Цикл
		СтруктураЭлемента = ПолучитьИзВременногоХранилища(СтрокаЭлементов.Элемент); // См. ФинансоваяОтчетностьКлиентСервер.СтруктураЭлементаОтчета
		Если СтруктураЭлемента.ВидЭлемента = Перечисления.ВидыЭлементовФинансовогоОтчета.РедактируемоеЗначение Тогда
			МассивИменТекущейТаблицы.Добавить(СтруктураЭлемента.НаименованиеДляПечати);
		КонецЕсли;
	КонецЦикла;
	
	Возврат МассивИменТекущейТаблицы;
	
КонецФункции

&НаСервере
Процедура СкорректироватьРедактируемыеЗначенияНаЭлементыТекущейТаблицы()
	
	МассивИмен = ПолучитьИзВременногоХранилища(РедактируемыеЗначения);
	МассивВычитания = МассивИменТекущейТаблицы(ПоместитьВоВременноеХранилище(ЭлементыТаблицы.Выгрузить()));
	МассивИмен = ОбщегоНазначенияКлиентСервер.РазностьМассивов(МассивИмен, МассивВычитания);
	ПоместитьВоВременноеХранилище(МассивИмен, РедактируемыеЗначения);
	
КонецПроцедуры

&НаКлиенте
Процедура КопироватьЗначения(Вырезать = Ложь)
	ЛокальныйКэш = Неопределено;
	
	ТекущаяОбласть = Элементы.ПредставлениеОтчета.ТекущаяОбласть;
	
	Если Не ОбластьВЗонеРедактирования(ЭтаФорма, ТекущаяОбласть) Тогда
		ТекстПредупреждения = НСтр("ru = 'Невозможно скопировать выбранную область';
									|en = 'Cannot copy the selected area'");
		ПоказатьПредупреждение(, ТекстПредупреждения);
		Возврат;
	КонецЕсли;
	
	ВысотаОбласти = ТекущаяОбласть.Низ - ТекущаяОбласть.Верх + 1;
	ШиринаОбласти = ТекущаяОбласть.Право - ТекущаяОбласть.Лево + 1;
	
	Массив = Новый Массив(ВысотаОбласти, ШиринаОбласти);
	
	Если Вырезать Тогда
		ОбновитьТаблицуВырезанныхЭлементов(
			ТекущаяОбласть.Верх,
			ТекущаяОбласть.Лево,
			ТекущаяОбласть.Верх + ВысотаОбласти - 1,
			ТекущаяОбласть.Лево + ШиринаОбласти - 1);
	КонецЕсли;
	
	Для СчВысота = 0 По ВысотаОбласти - 1 Цикл
		Для СчШирина = 0 По ШиринаОбласти - 1 Цикл
			Область = ПредставлениеОтчета.Область(
											ТекущаяОбласть.Верх + СчВысота,
											ТекущаяОбласть.Лево + СчШирина);
			Массив[СчВысота][СчШирина] = Область.Расшифровка.ЭлементОтчета;
			Если Вырезать Тогда
				Область.Расшифровка.ЭлементОтчета = "";
				Область.Расшифровка.ВидЭлемента = Неопределено;
				Область.Текст = НСтр("ru = '<выберите тип ячейки>';
									|en = '<select a cell type>'");
				УстановитьЦветЯчейки(Область, ИспользоватьДляВводаПлана, ЭтоПростаяТаблица, ЛокальныйКэш);
			КонецЕсли;
		КонецЦикла;
	КонецЦикла;
	
	мКэшКопированияВставки = Массив;
	
КонецПроцедуры

&НаСервере
Процедура ОбновитьТаблицуВырезанныхЭлементов(СтрокаНачала, КолонкаНачала, СтрокаОкончания, КолонкаОкончания)
	
	ЭлементыТаблицыБуфер = Новый ТаблицаЗначений;
	ЭлементыТаблицыБуфер.Колонки.Добавить("Строка");
	ЭлементыТаблицыБуфер.Колонки.Добавить("Колонка");
	ЭлементыТаблицыБуфер.Колонки.Добавить("Элемент");
	Для Колонка = КолонкаНачала По КолонкаОкончания Цикл
		Для Строка = СтрокаНачала По СтрокаОкончания Цикл
			ОбластьРасшифровки = ПредставлениеОтчета.Область(Строка, Колонка);
			Расшифровка = РасшифровкаОбластиТабличногоДокумента(ОбластьРасшифровки);
			Если ЗначениеЗаполнено(Расшифровка.ЭлементОтчета)
				И Не Расшифровка.ВидЭлемента = Перечисления.ВидыЭлементовФинансовогоОтчета.ФормулаПоГруппе
				И Не Расшифровка.ВидЭлемента = Перечисления.ВидыЭлементовФинансовогоОтчета.Группа Тогда
				НоваяСтрока = ЭлементыТаблицыБуфер.Добавить();
				НоваяСтрока.Строка = Расшифровка["Строка"].ЭлементОтчета;
				НоваяСтрока.Колонка = Расшифровка["Колонка"].ЭлементОтчета;
				НоваяСтрока.Элемент = Расшифровка.ЭлементОтчета;
			КонецЕсли;
		КонецЦикла;
	КонецЦикла;
	
	АдресВырезанныхЭлементов = ПоместитьВоВременноеХранилище(ЭлементыТаблицыБуфер, УникальныйИдентификатор);
	
КонецПроцедуры

&НаСервере
Процедура ВставитьНаСервере(Массив, ВысотаОбласти, ШиринаОбласти)
	ЛокальныйКэш = Неопределено;
	
	ТекущаяОбласть = Элементы.ПредставлениеОтчета.ТекущаяОбласть;
	Если Не (ШиринаОбласти = 1 И ВысотаОбласти = 1) Тогда
		Если ТекущаяОбласть.Право - ТекущаяОбласть.Лево + 1 <> ШиринаОбласти
		 ИЛИ ТекущаяОбласть.Низ - ТекущаяОбласть.Верх + 1 <> ВысотаОбласти Тогда
			
			ТекущаяОбласть = ПредставлениеОтчета.Область(ТекущаяОбласть.Верх, ТекущаяОбласть.Лево,
										ТекущаяОбласть.Верх + ВысотаОбласти - 1,
										ТекущаяОбласть.Лево + ШиринаОбласти - 1);
										
		КонецЕсли;
	КонецЕсли;
	
	Элементы.ПредставлениеОтчета.ТекущаяОбласть = ТекущаяОбласть;
	ТекущаяТаблицаЭлементов = ПолучитьИзВременногоХранилища(ЭлементыОтчета()); // См. БюджетнаяОтчетностьРасчетКэшаСервер.НовыйТаблицаЭлементов
	
	Для СчВысота = ТекущаяОбласть.Верх По ТекущаяОбласть.Низ Цикл
		Для СчШирина = ТекущаяОбласть.Лево По ТекущаяОбласть.Право Цикл
			
			Область = ПредставлениеОтчета.Область(СчВысота, СчШирина);
			
			Если ШиринаОбласти = 1 И ВысотаОбласти = 1 Тогда
				АдресЭлемента = Массив[0][0];
			Иначе
				АдресЭлемента = Массив[СчВысота - ТекущаяОбласть.Верх][СчШирина - ТекущаяОбласть.Лево];
			КонецЕсли;
			Если ЗначениеЗаполнено(АдресЭлемента) Тогда
				ВидЭлемента = Неопределено;
				Область.Расшифровка.ЭлементОтчета = ФинансоваяОтчетностьВызовСервера.СкопироватьЭлементПоАдресу(
					АдресЭлемента, ИдентификаторГлавногоХранилища, ВидЭлемента);
				
				СместитьСсылкиНаЯчейкиФормулы(Область.Расшифровка.ЭлементОтчета, АдресЭлемента, Область, ТекущаяТаблицаЭлементов);
				
				Область.Расшифровка.ВидЭлемента = ВидЭлемента;
			Иначе
				Область.Расшифровка.ЭлементОтчета = Неопределено;
				Область.Расшифровка.ВидЭлемента = Неопределено;
			КонецЕсли;
			Справочники.ЭлементыФинансовыхОтчетов.УстановитьТекстЯчейки(ЭтаФорма, Область.Имя);
			
		КонецЦикла;
	КонецЦикла;
	
	ТекущаяОбласть = Элементы.ПредставлениеОтчета.ТекущаяОбласть;
	
	Для СчВысота = ТекущаяОбласть.Верх По ТекущаяОбласть.Низ Цикл
		Для СчШирина = ТекущаяОбласть.Лево По ТекущаяОбласть.Право Цикл
			
			Область = ПредставлениеОтчета.Область(СчВысота, СчШирина);
			УстановитьЦветЯчейки(Область, ИспользоватьДляВводаПлана, ЭтоПростаяТаблица, ЛокальныйКэш);
			
		КонецЦикла;
	КонецЦикла;
	
КонецПроцедуры

&НаСервере
Процедура ОчиститьСервер()
	
	ТекущаяОбласть = Элементы.ПредставлениеОтчета.ТекущаяОбласть;
	Для СчВысота = ТекущаяОбласть.Верх По ТекущаяОбласть.Низ Цикл
		Для СчШирина = ТекущаяОбласть.Лево По ТекущаяОбласть.Право Цикл
			
			Область = ПредставлениеОтчета.Область(СчВысота, СчШирина);
			Если ОбластьВЗонеРедактирования(ЭтаФорма, Область) Тогда
				Область.Расшифровка.ЭлементОтчета = Неопределено;
				Область.Расшифровка.ВидЭлемента = Неопределено;
				Справочники.ЭлементыФинансовыхОтчетов.УстановитьТекстЯчейки(ЭтаФорма, Область.Имя);
				УстановитьЦветЯчейки(Область, ИспользоватьДляВводаПлана, ЭтоПростаяТаблица);
			КонецЕсли;
			
		КонецЦикла;
	КонецЦикла;
	
	УправлениеФормой();
	
КонецПроцедуры

&НаКлиенте
Функция ОпределитьДополнительныеПараметры(Расшифровка)
	
	Если Расшифровка.ВидЭлемента = ВидЭлемента("СтатьяБюджетов") Тогда
		Если ИспользоватьДляВводаПлана Тогда
			Возврат ПредопределенноеЗначение("Перечисление.ДополнительныеРежимыЭлементовОтчетов.СтатьяБюджетовВРежимеВвода");
		КонецЕсли;
	КонецЕсли;
	
КонецФункции

&НаКлиентеНаСервереБезКонтекста
Функция ПолучитьОбластьРедактирования(Форма)
	
	Результат = Новый Структура;
	Результат.Вставить("Верх",  Форма.ПерваяСтрока + Форма.ВысотаШапки + 1); //первая строка после шапки
	Результат.Вставить("Лево",  2 + Форма.ГлубинаОбъединения);               //все строки во второй колонке, значит редактируем с третьей колонки + выводимые совместно
	Результат.Вставить("Низ",   Форма.ПерваяСтрока + Форма.ВысотаМакета);    //до последней строки
	Результат.Вставить("Право", 2 + Форма.ГлубинаОбъединения - 1 + Форма.ШиринаМакета); //до последней колонки
	
	Возврат Результат;
	
КонецФункции

&НаКлиентеНаСервереБезКонтекста
Функция ОбластьВЗонеРедактирования(Форма, Область)
	
	ОбластьРедактирования = ПолучитьОбластьРедактирования(Форма);
	Если Область.Лево >= ОбластьРедактирования.Лево
		И Область.Право <= ОбластьРедактирования.Право
		И Область.Низ <= ОбластьРедактирования.Низ
		И Область.Верх >= ОбластьРедактирования.Верх Тогда
		
		Возврат Истина;
		
	КонецЕсли;
	
	Возврат Ложь;
	
КонецФункции

&НаСервере
Функция СвойствоЯчейкиТаблицы(ИмяСвойства, ПоУмолчанию = Неопределено)
	
	Область = Элементы.ПредставлениеОтчета.ТекущаяОбласть;
	Попытка
		Расшифровка = Область.Расшифровка;
	Исключение
		Возврат Неопределено;
	КонецПопытки;
	
	Если Не ЗначениеЗаполнено(Расшифровка)
		ИЛИ ТипЗнч(Расшифровка) <> Тип("Структура") Тогда
		Возврат ПоУмолчанию;
	КонецЕсли;
	
	ЗначениеСвойства = Неопределено;
	Если Не Расшифровка.Свойство(ИмяСвойства, ЗначениеСвойства) Тогда
		Возврат ПоУмолчанию;
	КонецЕсли;
	
	Возврат ЗначениеСвойства;
	
КонецФункции

&НаСервере
Процедура УправлениеФормой()
	
	ВидЭлемента = СвойствоЯчейкиТаблицы("ВидЭлемента");
	ЭлементОтчета = СвойствоЯчейкиТаблицы("ЭлементОтчета");
	ЗначениеЯчейки = "";
	
	Если ЭтоПростаяТаблица Тогда
		Элементы.НадписьВидЯчейки.Видимость = Ложь;
		Элементы.ГруппаКартинокВидаЭлемента.Видимость = Ложь;
		Элементы.ПредставлениеВариантаИспользованияЯчейки.Видимость = Ложь;
	ИначеЕсли ВидЭлемента = ВидЭлемента("ПроизводныйПоказатель") Тогда
		Элементы.ГруппаКартинокВидаЭлемента.ТекущаяСтраница = Элементы.ПроизводныйПоказатель;
		ЗначениеЯчейки = ФинансоваяОтчетностьВызовСервера.ЗначениеДополнительногоРеквизита(ЭлементОтчета, "ПоказательБюджетов");
	ИначеЕсли ВидЭлемента = ВидЭлемента("НефинансовыйПоказатель") Тогда
		Элементы.ГруппаКартинокВидаЭлемента.ТекущаяСтраница = Элементы.НефинансовыйПоказатель;
		ЗначениеЯчейки = ФинансоваяОтчетностьВызовСервера.ЗначениеДополнительногоРеквизита(ЭлементОтчета, "НефинансовыйПоказатель");
	ИначеЕсли ВидЭлемента = ВидЭлемента("РедактируемоеЗначение") Тогда
		Элементы.ГруппаКартинокВидаЭлемента.ТекущаяСтраница = Элементы.РедактируемоеЗначение;
		ЗначениеЯчейки = ПолучитьИзВременногоХранилища(ЭлементОтчета).НаименованиеДляПечати;
	ИначеЕсли ВидЭлемента = ВидЭлемента("СтатьяБюджетов")
		ИЛИ ВидЭлемента = ВидЭлемента("ВсеСтатьиБюджетов") Тогда
		Элементы.ГруппаКартинокВидаЭлемента.ТекущаяСтраница = Элементы.СтатьяБюджетов;
		ЗначениеЯчейки = ФинансоваяОтчетностьВызовСервера.ЗначениеДополнительногоРеквизита(ЭлементОтчета, "СтатьяБюджетов");
	ИначеЕсли ВидЭлемента = ВидЭлемента("ПоказательБюджетов")
		ИЛИ ВидЭлемента = ВидЭлемента("ВсеПоказателиБюджетов") Тогда
		Элементы.ГруппаКартинокВидаЭлемента.ТекущаяСтраница = Элементы.ПоказательБюджетов;
		ЗначениеЯчейки = ФинансоваяОтчетностьВызовСервера.ЗначениеРеквизитаОбъекта(ЭлементОтчета, "НаименованиеДляПечати");
	ИначеЕсли ВидЭлемента = ВидЭлемента("ФормулаПоГруппе")
		ИЛИ ВидЭлемента = ВидЭлемента("Группа") Тогда
		Элементы.ГруппаКартинокВидаЭлемента.ТекущаяСтраница = Элементы.ПроизводныйПоказатель;
	Иначе
		Элементы.ГруппаКартинокВидаЭлемента.ТекущаяСтраница = Элементы.Неопределен;
	КонецЕсли;
	
	ПредставлениеВариантаИспользованияЯчейки = "" + ВидЭлемента;
	Если ЗначениеЗаполнено(ЗначениеЯчейки) Тогда
		ПредставлениеВариантаИспользованияЯчейки = ПредставлениеВариантаИспользованияЯчейки + " """ + ЗначениеЯчейки + """";
	КонецЕсли;
	
	Если ЭтоПростаяТаблица Тогда
		
		Элементы.Формула.Видимость = Ложь;
		
	ИначеЕсли ВидЭлемента = ВидЭлемента("ПроизводныйПоказатель") Тогда
		
		Элементы.Формула.Заголовок = НСтр("ru = 'Вычисление';
											|en = 'Calculation'");
		Формула = ФинансоваяОтчетностьВызовСервера.ЗначениеДополнительногоРеквизита(ЭлементОтчета, "Формула");
		Элементы.Формула.Доступность = Истина;
		Элементы.Формула.РедактированиеТекста = Истина;
		
	ИначеЕсли ВидЭлемента = ВидЭлемента("ФормулаПоГруппе") Тогда
		
		Элементы.Формула.Заголовок = НСтр("ru = 'Вычисление';
											|en = 'Calculation'");
		Формула = ФинансоваяОтчетностьВызовСервера.ЗначениеДополнительногоРеквизита(ЭлементОтчета, "ФормулаПоГруппе");
		Элементы.Формула.Доступность = Истина;
		Элементы.Формула.РедактированиеТекста = Ложь;
		
	ИначеЕсли ВидЭлемента = ВидЭлемента("Группа") Тогда
		
		Элементы.Формула.Заголовок = НСтр("ru = 'Настройка';
											|en = 'Setting'");
		ОтображатьЗаголовок = ФинансоваяОтчетностьВызовСервера.ЗначениеДополнительногоРеквизита(ЭлементОтчета, "ВыводитьЗаголовокЭлемента");
		Элементы.Формула.Доступность = Истина;
		Элементы.Формула.РедактированиеТекста = Ложь;
		Если Не ОтображатьЗаголовок Тогда
			Формула = НСтр("ru = '<в отчете не отображается>';
							|en = '<not displayed in the report>'");
		КонецЕсли;
		
	Иначе
		
		Если Не ЗначениеЗаполнено(ЗначениеЯчейки) Тогда
			
			Элементы.Формула.Заголовок = НСтр("ru = 'Вычисление';
												|en = 'Calculation'");
			Формула = "";
			Элементы.Формула.Доступность = Ложь;
			
		Иначе
			
			Элементы.Формула.Доступность = Истина;
			Элементы.Формула.РедактированиеТекста = Ложь;
			
			Если ИспользоватьДляВводаПлана И ВидЭлемента = ВидЭлемента("СтатьяБюджетов") Тогда
				
				Элементы.Формула.Заголовок = НСтр("ru = 'Автозаполнение';
													|en = 'Auto population'");
				Формула = ФинансоваяОтчетностьВызовСервера.ЗначениеДополнительногоРеквизита(ЭлементОтчета, "Формула");
				
			Иначе
				
				Элементы.Формула.Заголовок = НСтр("ru = 'Настройка';
													|en = 'Setting'");
				Формула = "";
				ЕстьНастройки = ФинансоваяОтчетностьВызовСервера.ЗначениеРеквизитаОбъекта(ЭлементОтчета, "ЕстьНастройки");
				Если ЕстьНастройки = Истина Тогда
					Формула = НСтр("ru = 'Установлены дополнительные отборы показателя';
									|en = 'Additional indicator filters are set'");
				КонецЕсли;
				
				ПериодСмещения = ФинансоваяОтчетностьВызовСервера.ЗначениеДополнительногоРеквизита(ЭлементОтчета, "ПериодСмещения");
				Если ЗначениеЗаполнено(ПериодСмещения) Тогда
					Если Не ПустаяСтрока(Формула) Тогда
						Формула = Формула + "; ";
					КонецЕсли;
					ПараметрыПредставления = Новый Структура;
					ПараметрыПредставления.Вставить("ПериодСмещения");
					ПараметрыПредставления.Вставить("ПериодичностьСмещения");
					ПараметрыПредставления.Вставить("ВерхняяГраницаДанных");
					ПараметрыПредставления.Вставить("НижняяГраницаДанных");
					ПараметрыПредставления.Вставить("НачалоПериодаГруппировки");
					ПараметрыПредставления.Вставить("КонецПериодаГруппировки");
					ПараметрыКПередаче = Новый Структура;
					Для Каждого КлючИЗначение Из ПараметрыПредставления Цикл
						Значение = ФинансоваяОтчетностьВызовСервера.ЗначениеДополнительногоРеквизита(ЭлементОтчета, КлючИЗначение.Ключ);
						ПараметрыКПередаче.Вставить(КлючИЗначение.Ключ, Значение);
					КонецЦикла;
					ПустоеЗначение = Ложь;
					ПараметрыКПередаче.Вставить("ИмяФормы", "НастройкаЯчеек");
					ПредставлениеСмещения = БюджетнаяОтчетностьКлиентСервер.ПредставлениеСмещения(ПараметрыКПередаче, ПустоеЗначение);
					Если Не ПустоеЗначение Тогда
						Формула = Формула + ПредставлениеСмещения;
					КонецЕсли;
					
				КонецЕсли;
				
			КонецЕсли;
			
		КонецЕсли;
		
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Процедура УстановитьЗначениеЯчейки(Результат)
	
	Префикс = "ДополнительныйРеквизит_";
	
	СтруктураЭлемента = ФинансоваяОтчетностьКлиентСервер.СтруктураЭлементаОтчета();
	ЗаполнитьЗначенияСвойств(СтруктураЭлемента, Результат);
	
	ПеременныеПериодов = БюджетнаяОтчетностьКлиентСервер.ПеременныеПериодовБюджетирования();
	
	Если СтруктураЭлемента.ВидЭлемента = ВидЭлемента("СтатьяБюджетов")
		ИЛИ СтруктураЭлемента.ВидЭлемента = ВидЭлемента("ВсеСтатьиБюджетов") Тогда
		
		Если СтруктураЭлемента.ВидЭлемента = ВидЭлемента("СтатьяБюджетов") Тогда
			СтруктураЭлемента.Вставить(Префикс + "СтатьяБюджетов", Результат.ЭлементОтчета);
		КонецЕсли;
		СтруктураЭлемента.Вставить(Префикс + "ВыводимыеПоказатели", Перечисления.ТипыВыводимыхПоказателейБюджетногоОтчета.Сумма);
		СтруктураЭлемента.Вставить(Префикс + "ПериодичностьСмещения", Перечисления.Периодичность.Год);
		СтруктураЭлемента.Вставить(Префикс + "НижняяГраницаДанных", ПеременныеПериодов.НачалоПериодаДанных.Имя);
		СтруктураЭлемента.Вставить(Префикс + "ВерхняяГраницаДанных", ПеременныеПериодов.КонецПериодаДанных.Имя);
		СтруктураЭлемента.Вставить(Префикс + "НачалоПериодаГруппировки", ПеременныеПериодов.ПериодГруппировки.Имя);
		СтруктураЭлемента.Вставить(Префикс + "КонецПериодаГруппировки", ПеременныеПериодов.ПериодГруппировки.Имя);
		
	ИначеЕсли СтруктураЭлемента.ВидЭлемента = ВидЭлемента("ПоказательБюджетов")
		ИЛИ СтруктураЭлемента.ВидЭлемента = ВидЭлемента("ВсеПоказателиБюджетов") Тогда
		
		Если СтруктураЭлемента.ВидЭлемента = ВидЭлемента("ПоказательБюджетов") Тогда
			СтруктураЭлемента.Вставить(Префикс + "ПоказательБюджетов", Результат.ЭлементОтчета);
		КонецЕсли;
		СтруктураЭлемента.Вставить(Префикс + "ТипЗначенияПоказателя", Перечисления.ТипыЗначенийПоказателейБюджетногоОтчета.Оборот);
		СтруктураЭлемента.Вставить(Префикс + "ВыводимыеПоказатели", Перечисления.ТипыВыводимыхПоказателейБюджетногоОтчета.Сумма);
		СтруктураЭлемента.Вставить(Префикс + "ПериодичностьСмещения", Перечисления.Периодичность.Год);
		СтруктураЭлемента.Вставить(Префикс + "НижняяГраницаДанных", ПеременныеПериодов.НачалоПериодаДанных.Имя);
		СтруктураЭлемента.Вставить(Префикс + "ВерхняяГраницаДанных", ПеременныеПериодов.КонецПериодаДанных.Имя);
		СтруктураЭлемента.Вставить(Префикс + "НачалоПериодаГруппировки", ПеременныеПериодов.ПериодГруппировки.Имя);
		СтруктураЭлемента.Вставить(Префикс + "КонецПериодаГруппировки", ПеременныеПериодов.ПериодГруппировки.Имя);
		
	ИначеЕсли СтруктураЭлемента.ВидЭлемента = ВидЭлемента("НефинансовыйПоказатель") Тогда
		
		СтруктураЭлемента.Вставить(Префикс + "НефинансовыйПоказатель", Результат.ЭлементОтчета);
		СтруктураЭлемента.Вставить(Префикс + "ПериодичностьСмещения",  Перечисления.Периодичность.Год);
		
	ИначеЕсли СтруктураЭлемента.ВидЭлемента = ВидЭлемента("РедактируемоеЗначение") Тогда
		
		МассивИмен = ОбщегоНазначенияКлиентСервер.СкопироватьМассив(ПолучитьИзВременногоХранилища(РедактируемыеЗначения));
		ОбщегоНазначенияКлиентСервер.ДополнитьМассив(МассивИмен, МассивИменТекущейТаблицы(ЭлементыОтчета()));
		СтруктураЭлемента.Вставить("НаименованиеДляПечати", БюджетнаяОтчетностьКлиентСервер.ИмяРедактируемогоЗначенияБюджета(МассивИмен));
		СтруктураЭлемента.Вставить(Префикс + "ТипРедактируемогоЗначения", "Число");
		
	КонецЕсли;
	
	СсылкаНаЭлемент = БюджетнаяОтчетностьКлиентСервер.ПоместитьЭлементВХранилище(СтруктураЭлемента, ИдентификаторГлавногоХранилища);
	
	ТекущаяОбласть = Элементы.ПредставлениеОтчета.ТекущаяОбласть;
	Расшифровка = ТекущаяОбласть.Расшифровка;
	Расшифровка.ВидЭлемента = СтруктураЭлемента.ВидЭлемента;
	Расшифровка.ЭлементОтчета = СсылкаНаЭлемент;
	
	УправлениеФормой();
	Справочники.ЭлементыФинансовыхОтчетов.УстановитьТекстЯчейки(ЭтаФорма, ТекущаяОбласть.Имя);
	
КонецПроцедуры

&НаКлиенте
Процедура ВыборТипЭлемента(Результат, ДополнительныеПараметры) Экспорт
	
	Если Результат = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	Область = Элементы.ПредставлениеОтчета.ТекущаяОбласть;
	Область.Шрифт = Новый Шрифт(,,Ложь);
	УстановитьЗначениеЯчейки(Результат);
	УстановитьЦветЯчейки(Область, ИспользоватьДляВводаПлана, ЭтоПростаяТаблица);
	
	Если Область.Расшифровка.ВидЭлемента = 
		ПредопределенноеЗначение("Перечисление.ВидыЭлементовФинансовогоОтчета.ПроизводныйПоказатель") Тогда
		РедактироватьЭлементОтчета(Область);
	КонецЕсли;
	
КонецПроцедуры

&НаКлиентеНаСервереБезКонтекста
Процедура УстановитьЦветЯчейки(Область, ИспользоватьДляВводаПлана, ЭтоПростаяТаблица, ЛокальныйКэш = Неопределено)
	
	Если ЭтоПростаяТаблица Тогда
		Область.ГоризонтальноеПоложение  = ГоризонтальноеПоложение.Центр;
		Область.ВертикальноеПоложение    = ВертикальноеПоложение.Центр;
		Возврат;
	КонецЕсли;
	
	ОписаниеЯчейки = Область.Расшифровка;
	Если НЕ ЗначениеЗаполнено(ОписаниеЯчейки.ЭлементОтчета) Тогда
		Область.ЦветФона = БюджетнаяОтчетностьКлиентСервер.ПолучитьЦветСтиля(ЛокальныйКэш, "ПолеСОшибкойФон");
		Область.ЦветТекста = БюджетнаяОтчетностьКлиентСервер.ПолучитьЦветСтиля(ЛокальныйКэш, "НезаполненноеПолеТаблицы");
		Область.Шрифт = Новый Шрифт(,,Истина);
		Область.ГоризонтальноеПоложение = ГоризонтальноеПоложение.Центр;
		Область.ВертикальноеПоложение = ВертикальноеПоложение.Центр;
	Иначе
		Если ИспользоватьДляВводаПлана
		   И (ОписаниеЯчейки.ВидЭлемента = ВидЭлемента("СтатьяБюджетов")
		  ИЛИ ОписаниеЯчейки.ВидЭлемента = ВидЭлемента("РедактируемоеЗначение")) Тогда
			Область.ЦветФона = Новый Цвет(192, 220, 192);
		Иначе
			Область.ЦветФона = БюджетнаяОтчетностьКлиентСервер.ПолучитьЦветСтиля(ЛокальныйКэш, "ЦветФонаПоля");
		КонецЕсли;
		Область.ЦветТекста = БюджетнаяОтчетностьКлиентСервер.ПолучитьЦветСтиля(ЛокальныйКэш, "ЦветТекстаПоля");
		Область.Шрифт = Новый Шрифт(,,Ложь);
		Область.ГоризонтальноеПоложение = ГоризонтальноеПоложение.Лево;
		Область.ВертикальноеПоложение = ВертикальноеПоложение.Верх;
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Процедура УстановитьЦветЯчеек()
	ЛокальныйКэш = Неопределено;
	
	ОбластьРедактирования = ПолучитьОбластьРедактирования(ЭтаФорма);
	Для Колонка = ОбластьРедактирования.Лево По ОбластьРедактирования.Право Цикл
		Для Строка = ОбластьРедактирования.Верх По ОбластьРедактирования.Низ Цикл
			Область = ПредставлениеОтчета.Область(Строка, Колонка);
			УстановитьЦветЯчейки(Область, ИспользоватьДляВводаПлана, ЭтоПростаяТаблица, ЛокальныйКэш);
		КонецЦикла;
	КонецЦикла;
	
КонецПроцедуры

&НаКлиентеНаСервереБезКонтекста
Функция ВидЭлемента(ИмяВидаЭлемента)
	
	#Если Клиент Тогда
	
		Возврат ПредопределенноеЗначение("Перечисление.ВидыЭлементовФинансовогоОтчета."+ИмяВидаЭлемента);
		
	#Иначе
		
		Возврат Перечисления.ВидыЭлементовФинансовогоОтчета[ИмяВидаЭлемента];
		
	#КонецЕсли
	
КонецФункции

&НаКлиенте
Процедура ПоказатьСвойстваОбласти(Область)
	
	Если ОбластьВЗонеРедактирования(ЭтаФорма, Область) Тогда
		
		Расшифровка = Область.Расшифровка;
		Если Не ЗначениеЗаполнено(Расшифровка.ЭлементОтчета) Тогда
			ПредставлениеВариантаИспользованияЯчейкиНачалоВыбора(Неопределено, Неопределено, Неопределено);
		Иначе
			РедактироватьЭлементОтчета(Область);
		КонецЕсли;
		
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ПредставлениеОтчетаВыбор(Элемент, Область, СтандартнаяОбработка)
	
	СтандартнаяОбработка = Ложь;
	
	Если ЭтоПростаяТаблица Тогда
		ТекстПредупреждения = НСтр("ru = 'Выбор значений ячеек доступен только в сложной таблице';
									|en = 'Selection of cell values is available only in a complex table'");
		ПоказатьПредупреждение(, ТекстПредупреждения);
		Возврат;
	КонецЕсли;
	
	ПоказатьСвойстваОбласти(Область);
	
КонецПроцедуры

&НаКлиенте
Процедура РедактироватьЭлементОтчета(Область)
	
	Модифицированность = Истина;
	Расшифровка = Область.Расшифровка;
	
	Если Расшифровка.ВидЭлемента = ПредопределенноеЗначение("Перечисление.ВидыЭлементовФинансовогоОтчета.ФормулаПоГруппе")
		ИЛИ Расшифровка.ВидЭлемента = ПредопределенноеЗначение("Перечисление.ВидыЭлементовФинансовогоОтчета.Группа") Тогда
		ТекстПредупреждения = НСтр("ru = 'Настройка свойств элемента доступна в виде бюджета';
									|en = 'Setting of item properties is available as a budget.'");
		ПоказатьПредупреждение( , ТекстПредупреждения);
		Возврат;
	КонецЕсли;
	
	АдресСтруктурыЭлемента = Расшифровка.ЭлементОтчета;
	
	ПараметрыФормы = Новый Структура();
	ПараметрыФормы.Вставить("ВидЭлемента", 						Расшифровка.ВидЭлемента);
	ПараметрыФормы.Вставить("АдресЭлементаВХранилище", 			АдресСтруктурыЭлемента);
	ПараметрыФормы.Вставить("ИдентификаторГлавногоХранилища", 	ИдентификаторГлавногоХранилища);
	ПараметрыФормы.Вставить("ИспользоватьДляВводаПлана", 		ИспользоватьДляВводаПлана);
	ПараметрыФормы.Вставить("НастройкаЯчеек", 					Истина);
	АдресТекущейТаблицыЭлементов = ЭлементыОтчета();
	ПараметрыФормы.Вставить("АдресТаблицыЭлементов", 			АдресТекущейТаблицыЭлементов);
	ПараметрыФормы.Вставить("АдресЭлементовОтчета", 			АдресЭлементовОтчета);
	ПараметрыФормы.Вставить("ДополнительныйРежимФормы", 		ОпределитьДополнительныеПараметры(Расшифровка));
	ПараметрыФормы.Вставить("ВариантРасположенияГраницыФактическихДанных", ВариантРасположенияГраницыФактическихДанных);
	ПараметрыФормы.Вставить("ИдентификаторСтрокиЭлементаОтчета", ИдентификаторСтрокиЭлементаОтчета);
	
	МассивИмен = ОбщегоНазначенияКлиентСервер.СкопироватьМассив(ПолучитьИзВременногоХранилища(РедактируемыеЗначения));
	ОбщегоНазначенияКлиентСервер.ДополнитьМассив(МассивИмен, МассивИменТекущейТаблицы(АдресТекущейТаблицыЭлементов));
	ПараметрыФормы.Вставить("РедактируемыеЗначения", ПоместитьВоВременноеХранилище(МассивИмен, УникальныйИдентификатор));
	
	Оповещение = Новый ОписаниеОповещения("ОбновитьПолеПослеИзмененияЭлемента", ЭтаФорма, ПараметрыФормы);
	
	ОткрытьФорму("Справочник.ЭлементыФинансовыхОтчетов.ФормаОбъекта",
				ПараметрыФормы, ЭтаФорма, , , , Оповещение, РежимОткрытияОкнаФормы.БлокироватьОкноВладельца);
	
КонецПроцедуры

&НаСервере
Процедура ОбновитьИнформациюПослеРедактированияЭлементаОтчета(Имя)
	
	Справочники.ЭлементыФинансовыхОтчетов.УстановитьТекстЯчейки(ЭтаФорма, Имя);
	УправлениеФормой();
	
КонецПроцедуры

&НаКлиенте
Процедура ОбновитьПолеПослеИзмененияЭлемента(Результат, ДополнительныеПараметры) Экспорт
	
	ИмяОбласти = Элементы.ПредставлениеОтчета.ТекущаяОбласть.Имя;
	Расшифровка = ПредставлениеОтчета.Область(ИмяОбласти).Расшифровка;
	КопияСтруктуры = ОбщегоНазначенияКлиентСервер.СкопироватьСтруктуру(Расшифровка);
	КопияСтруктуры.ВидЭлемента = ДополнительныеПараметры.ВидЭлемента;
	КопияСтруктуры.ЭлементОтчета = ДополнительныеПараметры.АдресЭлементаВХранилище;
	ПредставлениеОтчета.Область(ИмяОбласти).Расшифровка = КопияСтруктуры;
	
	ОбновитьИнформациюПослеРедактированияЭлементаОтчета(
			Элементы.ПредставлениеОтчета.ТекущаяОбласть.Имя
			);
	
КонецПроцедуры

&НаСервере
Процедура ФормулаПриИзмененииНаСервере()
	
	Область = Элементы.ПредставлениеОтчета.ТекущаяОбласть;
	ФинансоваяОтчетностьВызовСервера.УстановитьЗначениеДополнительногоРеквизита(Область.Расшифровка.ЭлементОтчета, "Формула", Формула);
	Справочники.ЭлементыФинансовыхОтчетов.УстановитьТекстЯчейки(ЭтаФорма, Область.Имя);
	
КонецПроцедуры

&НаСервере
Процедура ПредставлениеВариантаИспользованияЯчейкиОчисткаНаСервере()
	
	Область = Элементы.ПредставлениеОтчета.ТекущаяОбласть;
	Область.Расшифровка.ЭлементОтчета = Неопределено;
	Область.Расшифровка.ВидЭлемента = Неопределено;
	Справочники.ЭлементыФинансовыхОтчетов.УстановитьТекстЯчейки(ЭтаФорма, Область.Имя);
	УправлениеФормой();
	
КонецПроцедуры

&НаСервере
Функция ЭлементыОтчета()
	
	ОбластьРедактирования = ПолучитьОбластьРедактирования(ЭтаФорма);
	ЭлементыТаблицыБуфер = Новый ТаблицаЗначений;
	ЭлементыТаблицыБуфер.Колонки.Добавить("Строка");
	ЭлементыТаблицыБуфер.Колонки.Добавить("Колонка");
	ЭлементыТаблицыБуфер.Колонки.Добавить("Элемент");
	Для Колонка = ОбластьРедактирования.Лево По ОбластьРедактирования.Право Цикл
		Для Строка = ОбластьРедактирования.Верх По ОбластьРедактирования.Низ Цикл
			Расшифровка = ПредставлениеОтчета.Область(Строка, Колонка).Расшифровка; // См. РасшифровкаОбластиТабличногоДокумента
			Если ЗначениеЗаполнено(Расшифровка.ЭлементОтчета)
				И Не Расшифровка.ВидЭлемента = Перечисления.ВидыЭлементовФинансовогоОтчета.ФормулаПоГруппе
				И Не Расшифровка.ВидЭлемента = Перечисления.ВидыЭлементовФинансовогоОтчета.Группа Тогда
				НоваяСтрока = ЭлементыТаблицыБуфер.Добавить();
				НоваяСтрока.Строка = Расшифровка.Строка.ЭлементОтчета;
				НоваяСтрока.Колонка = Расшифровка.Колонка.ЭлементОтчета;
				НоваяСтрока.Элемент = Расшифровка.ЭлементОтчета;
			КонецЕсли;
		КонецЦикла;
	КонецЦикла;
	
	Возврат ПоместитьВоВременноеХранилище(ЭлементыТаблицыБуфер, УникальныйИдентификатор);
	
КонецФункции

&НаСервере
Процедура СместитьСсылкиНаЯчейкиФормулы(Приемник, Источник, ОбластьПриемника, ТекущаяТаблицаЭлементов)
	
	СтруктураПриемника = ПолучитьИзВременногоХранилища(Приемник); // См. ФинансоваяОтчетностьКлиентСервер.СтруктураЭлементаОтчета
	СтруктураИсточника = ПолучитьИзВременногоХранилища(Источник); // См. ФинансоваяОтчетностьКлиентСервер.СтруктураЭлементаОтчета
	ФинОтчеты = ФинансоваяОтчетностьВызовСервера;
	
	ОперандыКУдалению = Новый Массив;
	ИспользуемыеИдентификаторыОперандов = Новый Соответствие;
	Операнды = СтруктураПриемника.ОперандыФормулы;
	
	ТаблицаВырезанныхЭлементов = Неопределено;
	Если НЕ ПустаяСтрока(АдресВырезанныхЭлементов) Тогда
		ТаблицаВырезанныхЭлементов = ПолучитьИзВременногоХранилища(АдресВырезанныхЭлементов); // ТаблицаЗначений -
	КонецЕсли;
	
	Для Каждого Операнд Из Операнды Цикл
		
		ЭлементОперанд = ПолучитьИзВременногоХранилища(Операнд.АдресСтруктурыЭлемента); // См. ФинансоваяОтчетностьКлиентСервер.СтруктураЭлементаОтчета
		Если ЭлементОперанд.ВидЭлемента = Перечисления.ВидыЭлементовФинансовогоОтчета.ЯчейкаТаблицы Тогда
			
			ОперандИсточника = СтруктураИсточника.ОперандыФормулы.Найти(Операнд.Идентификатор, "Идентификатор");
			
			СтрокаОперанда = ФинОтчеты.ЗначениеДополнительногоРеквизита(ОперандИсточника.АдресСтруктурыЭлемента, "СтрокаЯчейки");
			КолонкаОперанда = ФинОтчеты.ЗначениеДополнительногоРеквизита(ОперандИсточника.АдресСтруктурыЭлемента, "КолонкаЯчейки");
			
			НайденныеСтроки = ТекущаяТаблицаЭлементов.НайтиСтроки(Новый Структура("Элемент", Источник));
			НайденнаяСтрокаОперандаИсточника = Неопределено;
			Если НайденныеСтроки.Количество() > 0 Тогда
				НайденнаяСтрокаОперандаИсточника = НайденныеСтроки[0];
			ИначеЕсли ТипЗнч(ТаблицаВырезанныхЭлементов) = Тип("ТаблицаЗначений") Тогда
				НайденныеСтроки = ТаблицаВырезанныхЭлементов.НайтиСтроки(Новый Структура("Элемент", Источник));
				Если НайденныеСтроки.Количество() > 0 Тогда
					НайденнаяСтрокаОперандаИсточника = НайденныеСтроки[0];
				КонецЕсли;
			КонецЕсли;
			Если НЕ НайденнаяСтрокаОперандаИсточника = Неопределено Тогда
				СтрокаИсточника = НайденнаяСтрокаОперандаИсточника.Строка;
				КолонкаИсточника = НайденнаяСтрокаОперандаИсточника.Колонка;
			Иначе
				ТекстОшибки = НСтр("ru = 'Не удалось скопировать операнды ячейки';
									|en = 'Cannot copy cell operands'");
				ВызватьИсключение ТекстОшибки;
			КонецЕсли;
			
			ИндексСтрокаИсточника = -1;
			ИндексКолонкаИсточника = -1;
			
			ИндексСтрокаОперанда = -1;
			ИндексКолонкаОперанда = -1;
			
			ИндексСтрокаПриемника = ОбластьПриемника.Верх;
			ИндексКолонкаПриемника = ОбластьПриемника.Лево;
			
			ОбластьРедактирования = ПолучитьОбластьРедактирования(ЭтаФорма);
			Для Колонка = ОбластьРедактирования.Лево По ОбластьРедактирования.Право Цикл
				ТекущаяКолонка = ПредставлениеОтчета.Область(ОбластьРедактирования.Верх, Колонка).Расшифровка.Колонка.ЭлементОтчета;
				Если ТекущаяКолонка = КолонкаОперанда Тогда
					ИндексКолонкаОперанда = Колонка;
				КонецЕсли;
				Если ТекущаяКолонка = КолонкаИсточника Тогда
					ИндексКолонкаИсточника = Колонка;
				КонецЕсли;
				Если ИндексКолонкаОперанда <> -1 И ИндексКолонкаИсточника <> -1 Тогда
					Прервать;
				КонецЕсли;
			КонецЦикла;
			
			Для Строка = ОбластьРедактирования.Верх По ОбластьРедактирования.Низ Цикл
				Расшифровка = ПредставлениеОтчета.Область(Строка, ОбластьРедактирования.Лево).Расшифровка; // См. РасшифровкаОбластиТабличногоДокумента
				ТекущаяСтрока = Расшифровка.Строка.ЭлементОтчета;
				Если ТекущаяСтрока = СтрокаОперанда Тогда
					ИндексСтрокаОперанда = Строка;
				КонецЕсли;
				Если ТекущаяСтрока = СтрокаИсточника Тогда
					ИндексСтрокаИсточника = Строка;
				КонецЕсли;
				Если ИндексСтрокаОперанда <> -1 И ИндексСтрокаИсточника <> -1 Тогда
					Прервать;
				КонецЕсли;
			КонецЦикла;
			
			ПараметрыИдентификатора = Справочники.ЭлементыФинансовыхОтчетов.РазобратьИмяОперандаНаСоставляющие(Операнд.Идентификатор);
			
			Если ПараметрыИдентификатора.СтрокаФиксированная Тогда
				НовыйИндексСтроки = ИндексСтрокаОперанда;
			Иначе
				СмещениеСтрок = ИндексСтрокаОперанда - ИндексСтрокаИсточника;
				НовыйИндексСтроки = ИндексСтрокаПриемника + СмещениеСтрок;
			КонецЕсли;
			
			Если ПараметрыИдентификатора.КолонкаФиксированная Тогда
				НовыйИндексКолонки = ИндексКолонкаОперанда;
			Иначе
				СмещениеКолонок = ИндексКолонкаОперанда - ИндексКолонкаИсточника;
				НовыйИндексКолонки = ИндексКолонкаПриемника + СмещениеКолонок;
			КонецЕсли;
			
			ЕстьОшибки = Истина;
			Если НовыйИндексКолонки > 0 И НовыйИндексСтроки > 0 Тогда
				ОбластьЯчейки = ПредставлениеОтчета.Область(НовыйИндексСтроки, НовыйИндексКолонки);
				Если ОбластьВЗонеРедактирования(ЭтаФорма, ОбластьЯчейки) Тогда
					Расшифровка = ОбластьЯчейки.Расшифровка; // См. РасшифровкаОбластиТабличногоДокумента
					АдресСтрокиИдентификатора = Расшифровка.Строка.Наименование;
					Если ПараметрыИдентификатора.СтрокаФиксированная Тогда
						АдресСтрокиИдентификатора = "$" + АдресСтрокиИдентификатора;
					КонецЕсли;
					АдресКолонкиИдентификатора = Расшифровка.Колонка.Наименование;
					Если ПараметрыИдентификатора.КолонкаФиксированная Тогда
						АдресКолонкиИдентификатора = "$" + АдресКолонкиИдентификатора;
					КонецЕсли;
					
					ИмяЯчейки = АдресСтрокиИдентификатора + "; " + АдресКолонкиИдентификатора;
					НовыйИдентификатор = БюджетнаяОтчетностьКлиентСервер.ИмяОперанда(ИмяЯчейки, Операнд, Операнды, Ложь);
					
					// Если идентификатор операнда уже используется,
					// то сделаем его уникальным и запомним.
					Если ИспользуемыеИдентификаторыОперандов[НовыйИдентификатор] <> Неопределено Тогда
						Постфикс = ИспользуемыеИдентификаторыОперандов.Количество();
						НовыйИдентификатор = НовыйИдентификатор + " " + Постфикс;
					КонецЕсли;
					ИспользуемыеИдентификаторыОперандов.Вставить(НовыйИдентификатор, Операнд);
					
					ПредставлениеНовыйИдентификатор = "[" + НовыйИдентификатор + "]";
					
					Формула = ФинОтчеты.ЗначениеДополнительногоРеквизита(СтруктураПриемника, "Формула");
					Формула = СтрЗаменить(Формула, "[" + Операнд.Идентификатор + "]", ПредставлениеНовыйИдентификатор);
					
					Операнд.Идентификатор = НовыйИдентификатор;
					
					ФинОтчеты.УстановитьЗначениеДополнительногоРеквизита(СтруктураПриемника,
							"Формула", Формула);
					ФинОтчеты.УстановитьЗначениеДополнительногоРеквизита(Операнд.АдресСтруктурыЭлемента,
							"СтрокаЯчейки", Расшифровка["Строка"].ЭлементОтчета);
					ФинОтчеты.УстановитьЗначениеДополнительногоРеквизита(Операнд.АдресСтруктурыЭлемента,
							"КолонкаЯчейки", Расшифровка["Колонка"].ЭлементОтчета);
					
					ЕстьОшибки = Ложь;
				КонецЕсли;
			КонецЕсли;
			
			Если ЕстьОшибки Тогда
				ОперандыКУдалению.Добавить(Операнд);
				
				Формула = ФинОтчеты.ЗначениеДополнительногоРеквизита(СтруктураПриемника, "Формула");
				Формула = СтрЗаменить(Формула, "[" + Операнд.Идентификатор + "]", "#Недопустимая_ссылка");
				
				ФинОтчеты.УстановитьЗначениеДополнительногоРеквизита(СтруктураПриемника, "Формула", Формула);
			КонецЕсли;
			
		КонецЕсли;
		
	КонецЦикла;
	
	Для Каждого Операнд Из ОперандыКУдалению Цикл
		СтруктураПриемника.ОперандыФормулы.Удалить(Операнд);
	КонецЦикла;
	
	ПоместитьВоВременноеХранилище(СтруктураПриемника, Приемник);
	
КонецПроцедуры

&НаСервере
Процедура ДополнитьРодительскимиИзмерениями(ОсновныеПоля)
	
	ДополнительныеПоля = Новый Массив;
	ЭлементыОтчета = ПолучитьИзВременногоХранилища(АдресЭлементовОтчета);
	
	Для Каждого СтрокаДополнения Из ОсновныеПоля Цикл
		
		НайденнаяСтрока = ФинансоваяОтчетностьСервер.ПодчиненныйЭлемент(ЭлементыОтчета,
			"АдресСтруктурыЭлемента", СтрокаДополнения);
		Пока НайденнаяСтрока <> Неопределено Цикл
			
			Родитель = ФинансоваяОтчетностьКлиентСервер.РодительСтроки(НайденнаяСтрока);
			Если Родитель.ВидЭлемента = ВидЭлемента("Строки")
				ИЛИ Родитель.ВидЭлемента = ВидЭлемента("Колонки")
				ИЛИ Родитель.ВидЭлемента = ВидЭлемента("ТаблицаПоказателиВСтроках")
				ИЛИ Родитель.ВидЭлемента = ВидЭлемента("ТаблицаПоказателиВКолонках")
				ИЛИ Родитель.ВидЭлемента = ВидЭлемента("ТаблицаСложная") Тогда
				Прервать;
			КонецЕсли;
			
			ДополнительныеПоля.Добавить(Родитель.АдресСтруктурыЭлемента);
			
			НайденнаяСтрока = Родитель;
			
		КонецЦикла;
		
	КонецЦикла;
	
	ОбщегоНазначенияКлиентСервер.ДополнитьМассив(ОсновныеПоля, ДополнительныеПоля, Истина);
	
КонецПроцедуры

&НаСервере
Процедура ЗаполнитьПредставленияСтроки(СтрокаУсловногоОформления)
	
	Условие = ПолучитьИзВременногоХранилища(СтрокаУсловногоОформления.УсловиеХранилище);
	Если ТипЗнч(Условие) = Тип("НастройкиКомпоновкиДанных") Тогда
		СтрокаУсловногоОформления.Условие = Строка(Условие.Отбор);
	КонецЕсли;
	
	Если ПустаяСтрока(СтрокаУсловногоОформления.Условие) Тогда
		СтрокаУсловногоОформления.Условие = НСтр("ru = '<без отбора>';
												|en = '<No filter>'");
	КонецЕсли;
	
	Оформление = ПолучитьИзВременногоХранилища(СтрокаУсловногоОформления.ОформлениеХранилище);
	Если ТипЗнч(Оформление) <> Тип("ТаблицаЗначений") ИЛИ Не ЗначениеЗаполнено(Оформление) Тогда
		СтрокаУсловногоОформления.Оформление = НСтр("ru = '<оформление не указано>';
													|en = '<appearance is not specified>'");
	Иначе
		МассивПредставлений = Новый Массив;
		Для Каждого Строка Из Оформление Цикл
			МассивПредставлений.Добавить(Строка.Параметр + ": " + Строка.Оформление);
		КонецЦикла;
		СтрокаУсловногоОформления.Оформление = СтрСоединить(МассивПредставлений, "; ");
	КонецЕсли;
	
	ОформляемыеСтроки = ПолучитьИзВременногоХранилища(СтрокаУсловногоОформления.ОформляемыеСтрокиХранилище);
	ОформляемыеКолонки = ПолучитьИзВременногоХранилища(СтрокаУсловногоОформления.ОформляемыеКолонкиХранилище);
	
	Если СтрокаУсловногоОформления.ТипОформляемойОбласти = Перечисления.ТипыОформляемыхОбластейБюджетныхОтчетов.ВсяТаблица Тогда
		СтрокаУсловногоОформления.ОформляемыеПоля = НСтр("ru = 'Вся таблица';
														|en = 'Entire table'");
	ИначеЕсли СтрокаУсловногоОформления.ТипОформляемойОбласти = Перечисления.ТипыОформляемыхОбластейБюджетныхОтчетов.ВсяСтрока Тогда
		СтрокаУсловногоОформления.ОформляемыеПоля = НСтр("ru = 'Строки:';
														|en = 'Lines:'");
		Для Каждого Строка Из ОформляемыеСтроки Цикл
			Если Не ЗначениеЗаполнено(Строка.ЭлементОтчета) Тогда
				Продолжить;
			КонецЕсли;
			СтрокаУсловногоОформления.ОформляемыеПоля = СтрокаУсловногоОформления.ОформляемыеПоля + "
			|-" + ПолучитьИзВременногоХранилища(Строка.ЭлементОтчета).НаименованиеДляПечати;
		КонецЦикла;
	ИначеЕсли СтрокаУсловногоОформления.ТипОформляемойОбласти = Перечисления.ТипыОформляемыхОбластейБюджетныхОтчетов.ВсяКолонка Тогда
		СтрокаУсловногоОформления.ОформляемыеПоля = НСтр("ru = 'Колонки:';
														|en = 'Columns:'");
		Для Каждого Строка Из ОформляемыеКолонки Цикл
			Если Не ЗначениеЗаполнено(Строка.ЭлементОтчета) Тогда
				Продолжить;
			КонецЕсли;
			СтрокаУсловногоОформления.ОформляемыеПоля = СтрокаУсловногоОформления.ОформляемыеПоля + "
			|-" + ПолучитьИзВременногоХранилища(Строка.ЭлементОтчета).НаименованиеДляПечати;
		КонецЦикла;
	ИначеЕсли СтрокаУсловногоОформления.ТипОформляемойОбласти = Перечисления.ТипыОформляемыхОбластейБюджетныхОтчетов.ЗаголовкиСтрок Тогда
		СтрокаУсловногоОформления.ОформляемыеПоля = НСтр("ru = 'Заголовки строк:';
														|en = 'Row headers:'");
		Для Каждого Строка Из ОформляемыеСтроки Цикл
			Если ЗначениеЗаполнено(Строка.ЭлементОтчета) Тогда
				СтруктураЭлементаОтчета = ПолучитьИзВременногоХранилища(Строка.ЭлементОтчета);
				НаименованиеДляПечати = СтруктураЭлементаОтчета.НаименованиеДляПечати;
			Иначе
				НаименованиеДляПечати = НСтр("ru = 'Шапка';
											|en = 'Header'");
			КонецЕсли;
			СтрокаУсловногоОформления.ОформляемыеПоля = СтрокаУсловногоОформления.ОформляемыеПоля + "
			|-" + НаименованиеДляПечати;
		КонецЦикла;
	ИначеЕсли СтрокаУсловногоОформления.ТипОформляемойОбласти = Перечисления.ТипыОформляемыхОбластейБюджетныхОтчетов.ЗаголовкиКолонок Тогда
		СтрокаУсловногоОформления.ОформляемыеПоля = НСтр("ru = 'Заголовки колонок:';
														|en = 'Column headers:'");
		Для Каждого Строка Из ОформляемыеКолонки Цикл
			Если ЗначениеЗаполнено(Строка.ЭлементОтчета) Тогда
				СтруктураЭлементаОтчета = ПолучитьИзВременногоХранилища(Строка.ЭлементОтчета);
				НаименованиеДляПечати = СтруктураЭлементаОтчета.НаименованиеДляПечати;
			Иначе
				НаименованиеДляПечати = НСтр("ru = 'Шапка';
											|en = 'Header'");
			КонецЕсли;
			СтрокаУсловногоОформления.ОформляемыеПоля = СтрокаУсловногоОформления.ОформляемыеПоля + "
			|-" + НаименованиеДляПечати;
		КонецЦикла;
	ИначеЕсли СтрокаУсловногоОформления.ТипОформляемойОбласти = Перечисления.ТипыОформляемыхОбластейБюджетныхОтчетов.ЯчейкиНаПересеченииСтрокИКолонок Тогда
		СтрокаУсловногоОформления.ОформляемыеПоля = НСтр("ru = 'Ячейки на пересечении колонок:';
														|en = 'Cells at the intersection of columns:'");
		Для Каждого Строка Из ОформляемыеКолонки Цикл
			Если Не ЗначениеЗаполнено(Строка.ЭлементОтчета) Тогда
				Продолжить;
			КонецЕсли;
			СтрокаУсловногоОформления.ОформляемыеПоля = СтрокаУсловногоОформления.ОформляемыеПоля + "
			|-" + ПолучитьИзВременногоХранилища(Строка.ЭлементОтчета).НаименованиеДляПечати;
		КонецЦикла;
		СтрокаУсловногоОформления.ОформляемыеПоля = СтрокаУсловногоОформления.ОформляемыеПоля + "
		|" + НСтр("ru = 'и строк:';
					|en = 'and lines:'");
		Для Каждого Строка Из ОформляемыеСтроки Цикл
			Если Не ЗначениеЗаполнено(Строка.ЭлементОтчета) Тогда
				Продолжить;
			КонецЕсли;
			СтрокаУсловногоОформления.ОформляемыеПоля = СтрокаУсловногоОформления.ОформляемыеПоля + "
			|-" + ПолучитьИзВременногоХранилища(Строка.ЭлементОтчета).НаименованиеДляПечати;
		КонецЦикла;
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Процедура ОбновитьНомераСтрокУсловногоОформления()
	
	Для Каждого Строка Из СписокЭлементовОформления Цикл
		Строка.НомерСтроки = СписокЭлементовОформления.Индекс(Строка) + 1;
	КонецЦикла;
	
КонецПроцедуры


// Возвращает описанные настройки условного оформления.
// 
// Параметры:
// 	АдресВременногоХранилища - Строка - 
// Возвращаемое значение:
// 	Структура -:
// 	 *КлючЭлементаОформления - УникальныйИдентификатор - 
// 	 *Оформление - ТаблицаЗначений - 
// 	 *ОформляемыеКолонки - ТаблицаЗначений - 
// 	 *ОформляемыеСтроки - ТаблицаЗначений -
// 	 *РасшифровкаПолейОтбораЭО - ТаблицаЗначений -
// 	 *ТипОформляемойОбласти - ПеречислениеСсылка.ТипыОформляемыхОбластейБюджетныхОтчетов -
// 	 *Условие - НастройкиКомпоновкиДанных -
//
&НаСервере
Функция СтруктураУсловногоОформленияИзВременногоХранилища(АдресВременногоХранилища)
	Возврат ПолучитьИзВременногоХранилища(АдресВременногоХранилища);
КонецФункции

&НаСервере
Процедура ДобавитьУсловноеОформлениеНаСервере(АдресРезультата)
	
	СтруктураУсловногоОформления = СтруктураУсловногоОформленияИзВременногоХранилища(АдресРезультата);
	СтрокиОформления = СписокЭлементовОформления.НайтиСтроки(Новый Структура("КлючЭлементаОформления", СтруктураУсловногоОформления.КлючЭлементаОформления));
	Если СтрокиОформления.Количество() Тогда
		НоваяСтрока = СтрокиОформления[0];
	Иначе
		НоваяСтрока = СписокЭлементовОформления.Добавить();
	КонецЕсли;
	НоваяСтрока.ТипОформляемойОбласти = СтруктураУсловногоОформления.ТипОформляемойОбласти;
	НоваяСтрока.КлючЭлементаОформления = СтруктураУсловногоОформления.КлючЭлементаОформления;
	НоваяСтрока.ОформлениеХранилище = ПоместитьВоВременноеХранилище(СтруктураУсловногоОформления.Оформление, УникальныйИдентификатор);
	НоваяСтрока.ОформляемыеСтрокиХранилище = ПоместитьВоВременноеХранилище(СтруктураУсловногоОформления.ОформляемыеСтроки, УникальныйИдентификатор);
	НоваяСтрока.ОформляемыеКолонкиХранилище = ПоместитьВоВременноеХранилище(СтруктураУсловногоОформления.ОформляемыеКолонки, УникальныйИдентификатор);
	НоваяСтрока.РасшифровкаПолейОтбораЭОХранилище = ПоместитьВоВременноеХранилище(СтруктураУсловногоОформления.РасшифровкаПолейОтбораЭО, УникальныйИдентификатор);
	НоваяСтрока.УсловиеХранилище = ПоместитьВоВременноеХранилище(СтруктураУсловногоОформления.Условие, УникальныйИдентификатор);
	ЗаполнитьПредставленияСтроки(НоваяСтрока);
	ОбновитьНомераСтрокУсловногоОформления();
	
	УстановитьВидимостьЭлементовОформления();
	
КонецПроцедуры

&НаКлиенте
Процедура ПриИзмененииУсловногоОформления(Результат, ДополнительныеПараметры) Экспорт
	
	Если Результат = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	ДобавитьУсловноеОформлениеНаСервере(Результат);
	
КонецПроцедуры

&НаСервере
Процедура УстановитьВидимостьЭлементовОформления()
	
	Элементы.СписокЭлементовОформления.Видимость = ВидимостьЭлементовОформления;
	Если ВидимостьЭлементовОформления Тогда
		Элементы.ЭлементыОформления.Заголовок = НСтр("ru = 'Скрыть элементы оформления';
													|en = 'Hide appearance items'");
	Иначе
		Элементы.ЭлементыОформления.Заголовок = НСтр("ru = 'Показать элементы оформления (%1)';
													|en = 'Show appearance items (%1)'");
		Элементы.ЭлементыОформления.Заголовок = 
			СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(Элементы.ЭлементыОформления.Заголовок, СписокЭлементовОформления.Количество());
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Функция ПараметрыОткрытияЭлементаУсловногоОформления(ИндексСтроки)
	
	СтрокаУО = СписокЭлементовОформления.НайтиПоИдентификатору(ИндексСтроки);
	ТипОформляемойОбласти = СтрокаУО.ТипОформляемойОбласти;
	
	ПоляОтбора = Новый Массив;
	ПоляОтбораЗначений = Новый Массив;
	
	ОформляемыеСтроки = ПолучитьИзВременногоХранилища(СтрокаУО.ОформляемыеСтрокиХранилище);
	ОформляемыеКолонки = ПолучитьИзВременногоХранилища(СтрокаУО.ОформляемыеКолонкиХранилище);
	
	ЭлементыОтчета = ПолучитьИзВременногоХранилища(АдресЭлементовОтчета);
	Таблица = ФинансоваяОтчетностьСервер.ТаблицаЭлемента(ЭлементыОтчета, АдресЭлементаВХранилище);
	
	Если ТипОформляемойОбласти = ПредопределенноеЗначение("Перечисление.ТипыОформляемыхОбластейБюджетныхОтчетов.ЯчейкиНаПересеченииСтрокИКолонок") Тогда
		Для Каждого Ячейка Из ОформляемыеСтроки Цикл
			ПоляОтбора.Добавить(Ячейка.ЭлементОтчета);
		КонецЦикла;
		Для Каждого Ячейка Из ОформляемыеКолонки Цикл
			ПоляОтбора.Добавить(Ячейка.ЭлементОтчета);
		КонецЦикла;
	ИначеЕсли ТипОформляемойОбласти = ПредопределенноеЗначение("Перечисление.ТипыОформляемыхОбластейБюджетныхОтчетов.ЗаголовкиКолонок") Тогда
		Для Каждого Ячейка Из ОформляемыеКолонки Цикл
			ПоляОтбора.Добавить(Ячейка.ЭлементОтчета);
		КонецЦикла;
	ИначеЕсли ТипОформляемойОбласти = ПредопределенноеЗначение("Перечисление.ТипыОформляемыхОбластейБюджетныхОтчетов.ЗаголовкиСтрок") Тогда
		Для Каждого Ячейка Из ОформляемыеСтроки Цикл
			ПоляОтбора.Добавить(Ячейка.ЭлементОтчета);
		КонецЦикла;
	ИначеЕсли ТипОформляемойОбласти = ПредопределенноеЗначение("Перечисление.ТипыОформляемыхОбластейБюджетныхОтчетов.ВсяСтрока") Тогда
		Для Каждого Ячейка Из ОформляемыеСтроки Цикл
			ПоляОтбора.Добавить(Ячейка.ЭлементОтчета);
		КонецЦикла;
		НайденныеСтроки = ФинансоваяОтчетностьСервер.ПодчиненныйЭлемент(Таблица, "ВидЭлемента", ВидЭлемента("Колонки"));
		НайденныеСтроки = БюджетнаяОтчетностьРасчетКэшаСервер.ПолучитьКонечныеЭлементыДерева(НайденныеСтроки);
		Для Каждого НайденнаяСтрока Из НайденныеСтроки Цикл
			ПоляОтбораЗначений.Добавить(НайденнаяСтрока.АдресСтруктурыЭлемента);
		КонецЦикла;
	ИначеЕсли ТипОформляемойОбласти = ПредопределенноеЗначение("Перечисление.ТипыОформляемыхОбластейБюджетныхОтчетов.ВсяКолонка") Тогда
		Для Каждого Ячейка Из ОформляемыеКолонки Цикл
			ПоляОтбора.Добавить(Ячейка.ЭлементОтчета);
		КонецЦикла;
		НайденныеСтроки = ФинансоваяОтчетностьСервер.ПодчиненныйЭлемент(Таблица, "ВидЭлемента", ВидЭлемента("Строки"));
		НайденныеСтроки = БюджетнаяОтчетностьРасчетКэшаСервер.ПолучитьКонечныеЭлементыДерева(НайденныеСтроки);
		Для Каждого НайденнаяСтрока Из НайденныеСтроки Цикл
			ПоляОтбораЗначений.Добавить(НайденнаяСтрока.АдресСтруктурыЭлемента);
		КонецЦикла;
	КонецЕсли;
	
	ПоляОтбора = ОбщегоНазначенияКлиентСервер.СвернутьМассив(ПоляОтбора);
	ДополнитьРодительскимиИзмерениями(ПоляОтбора);
	ПоляОтбораЗначений = ОбщегоНазначенияКлиентСервер.СвернутьМассив(ПоляОтбораЗначений);
	
	ПараметрыФормы = Новый Структура;
	ПараметрыФормы.Вставить("ЭтоПростаяТаблица", ЭтоПростаяТаблица);
	ПараметрыФормы.Вставить("ОформляемыеСтроки", СтрокаУО.ОформляемыеСтрокиХранилище);
	ПараметрыФормы.Вставить("ОформляемыеКолонки", СтрокаУО.ОформляемыеКолонкиХранилище);
	ПараметрыФормы.Вставить("КлючЭлементаОформления", СтрокаУО.КлючЭлементаОформления);
	ПараметрыФормы.Вставить("ПоляОтбора", ПоляОтбора);
	ПараметрыФормы.Вставить("ПоляОтбораЗначений", ПоляОтбораЗначений);
	ПараметрыФормы.Вставить("ТипОформляемойОбласти", ТипОформляемойОбласти);
	ПараметрыФормы.Вставить("Оформление", СтрокаУО.ОформлениеХранилище);
	ПараметрыФормы.Вставить("Условие", СтрокаУО.УсловиеХранилище);
	ПараметрыФормы.Вставить("АдресЭлементовОтчета", АдресЭлементовОтчета);
	ПараметрыФормы.Вставить("АдресЭлементаВХранилище", АдресЭлементаВХранилище);
	
	Возврат ПараметрыФормы;
	
КонецФункции

&НаКлиенте
Процедура ЗавершениеРедактированияНумерации(Результат, ДополнительныеПараметры) Экспорт
	
	Если Результат <> Неопределено Тогда
		ОтображатьНумерациюКолонок = Результат["ОтображатьНумерациюКолонок"];
		ОтображатьНумерациюСтрок = Результат["ОтображатьНумерациюСтрок"];
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти
