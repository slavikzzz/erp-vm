#Если Сервер Или ТолстыйКлиентОбычноеПриложение Или ВнешнееСоединение Тогда

#Область ПрограммныйИнтерфейс

// Соотвествие со списком реквизитов, по которым определяется уникальность ключа
// 
// Возвращаемое значение:
//  Соответствие - ключ - имя реквизита 
//
Функция КлючевыеРеквизиты() Экспорт
	
	Результат = Новый Соответствие;
	Результат.Вставить("Организация");
	Результат.Вставить("ТипЗапасов");
	Результат.Вставить("НалогообложениеНДС");
	Результат.Вставить("ВладелецТовара");
	Результат.Вставить("Соглашение");
	Результат.Вставить("Валюта");
	Результат.Вставить("РеализацияЗапасовДругойОрганизации");
	Результат.Вставить("ВидЗапасовВладельца");
	Результат.Вставить("СпособПередачиТоваров");
	Результат.Вставить("УстарелоПоставщик");
	Результат.Вставить("УстарелоПредназначение");
	Результат.Вставить("УстарелоПодразделение");
	Результат.Вставить("УстарелоМенеджер");
	Результат.Вставить("УстарелоСделка");
	Результат.Вставить("ГруппаФинансовогоУчета");
	Результат.Вставить("Контрагент");
	Результат.Вставить("Договор");
	Результат.Вставить("УстарелоНазначение");
	Результат.Вставить("ГруппаПродукции");
	Результат.Вставить("ВидЦены");
	
	Возврат Результат;
	
КонецФункции

// Функция получает вид запасов для текущего документа.
//
// Параметры:
//	Организация - СправочникСсылка.Организации - Организация документа
//	ХозяйственнаяОперация - ПеречислениеСсылка.ХозяйственныеОперации - Операция документа
//	РеквизитыДокумента - Структура, ВыборкаИзРезультатаЗапроса - Данные документа:
//      * Организация - СправочникСсылка.Организации
//      * ТипЗапасов - ПеречислениеСсылка.ТипыЗапасов
//      * ВладелецТовара - СправочникСсылка.Организации, СправочникСсылка.Партнеры -
//      * Контрагент - СправочникСсылка.Организации, СправочникСсылка.Контрагенты -
//      * Соглашение - СправочникСсылка.СоглашенияСПоставщиками
//      * Договор - СправочникСсылка.ДоговорыКонтрагентов, СправочникСсылка.ДоговорыМеждуОрганизациями -
//      * Валюта - СправочникСсылка.Валюты
//      * НалогообложениеНДС - ПеречислениеСсылка.ТипыНалогообложенияНДС
//      * НалогообложениеОрганизации - ПеречислениеСсылка.СистемыНалогообложения
//      * ВидЗапасов - СправочникСсылка.ВидыЗапасов
//      * ГруппаФинансовогоУчета - СправочникСсылка.ГруппыФинансовогоУчетаНоменклатуры
//      * ГруппаПродукции - СправочникСсылка.Организации
//      * ХозяйственнаяОперация - ПеречислениеСсылка.ХозяйственныеОперации
//      * ВидЦены - СправочникСсылка.ВидыЦенПоставщиков
//      * СохраняемыйВидЗапасов - СправочникСсылка.ВидыЗапасов.
//
// Возвращаемое значение:
//	СправочникСсылка.ВидыЗапасов - Найденный вид запасов.
//
Функция ВидЗапасовДокумента(Организация, ХозяйственнаяОперация, РеквизитыДокумента = Неопределено) Экспорт
	
	Если ЗначениеЗаполнено(РеквизитыДокумента) Тогда
		Реквизиты = Новый Структура("
			|Организация,
			|ТипЗапасов,
			|ВладелецТовара,
			|Контрагент,
			|Соглашение,
			|Договор,
			|Валюта,
			|НалогообложениеНДС,
			|НалогообложениеОрганизации,
			|ВидЗапасов,
			|ГруппаФинансовогоУчета,
			|ГруппаПродукции,
			|ХозяйственнаяОперация,
			|ВидЦены,
			|СохраняемыйВидЗапасов
			|");
		
		Реквизиты.Организация = Справочники.Организации.ПустаяСсылка();
		Реквизиты.ВладелецТовара = Неопределено;
		Реквизиты.Контрагент = Неопределено;
		Реквизиты.Договор = Неопределено;
		Реквизиты.Соглашение = Справочники.СоглашенияСПоставщиками.ПустаяСсылка();
		Реквизиты.Валюта = Справочники.Валюты.ПустаяСсылка();
		Реквизиты.НалогообложениеНДС = Перечисления.ТипыНалогообложенияНДС.ПустаяСсылка();
		Реквизиты.ТипЗапасов = Перечисления.ТипыЗапасов.ПустаяСсылка();
		Реквизиты.ГруппаФинансовогоУчета = Справочники.ГруппыФинансовогоУчетаНоменклатуры.ПустаяСсылка();
		Реквизиты.ГруппаПродукции = Справочники.ГруппыАналитическогоУчетаНоменклатуры.ПустаяСсылка();
		Реквизиты.ВидЦены = Справочники.ВидыЦенПоставщиков.ПустаяСсылка();
		
		ЗаполнитьЗначенияСвойств(Реквизиты, РеквизитыДокумента);
	Иначе
		Реквизиты = Неопределено;
	КонецЕсли;
	
	Если ЗначениеЗаполнено(Реквизиты) И ЗначениеЗаполнено(Реквизиты.СохраняемыйВидЗапасов) Тогда
		
		// Вид запасов уже известен - не надо пытаться его переформировать
		Результат = Реквизиты.СохраняемыйВидЗапасов;
		
	Иначе
		
		СтруктураВидЗапасов = СтруктураВидаЗапасов(Организация, ХозяйственнаяОперация, Реквизиты);
		
		УстановитьПривилегированныйРежим(Истина);
		Результат = ВидЗапасовПоОтборамКэш(СтруктураВидЗапасов);
		УстановитьПривилегированныйРежим(Ложь);
		
	КонецЕсли;
	
	Возврат Результат;

КонецФункции

// Функция получает вид запасов для передачи товаров между организациями.
//
// Параметры:
//	ВидЗапасовВладельца - СправочникСсылка.ВидыЗапасов - Вид запасов организации - владельца
//	ОрганизацияПродавец - СправочникСсылка.Организации - Организация - продавец
//	ПередачаПодДеятельность - ПеречислениеСсылка.ТипыНалогообложенияНДС - Налогообложение деятельности
//	ДатаДокумента - Дата - Дата документа, для определения попадает ли документ под действие 150ФЗ
//	СырьевойТовар - Булево - Признак, указывающий на то, является ли данный товар сырьевым или нет.
//
// Возвращаемое значение:
//	СправочникСсылка.ВидыЗапасов - Созданный вид запасов.
//
Функция ВидЗапасовДляПередачиМеждуОрганизациями(ВидЗапасовВладельца, ОрганизацияПродавец, Знач ПередачаПодДеятельность, Знач ДатаДокумента = Неопределено, СырьевойТовар = Неопределено) Экспорт
	
	Запрос = Новый Запрос(
	"ВЫБРАТЬ
	|	ВидыЗапасовВладельца.Ссылка КАК ВидЗапасовВладельца,
	|	ВидыЗапасовПродавца.Ссылка КАК ВидЗапасов,
	|	Настройка.ОрганизацияПродавец КАК Организация,
	|	ВидыЗапасовВладельца.Организация КАК Комитент,
	|	ВидыЗапасовВладельца.Организация КАК Контрагент,
	|	Настройка.Валюта КАК Валюта,
	|	Настройка.СпособПередачиТоваров КАК СпособПередачиТоваров,
	|	ИСТИНА КАК РеализацияЗапасовДругойОрганизации,
	|	&ПередачаПодДеятельность КАК НалогообложениеНДС,
	|	ВЫБОР
	|		КОГДА Настройка.СпособПередачиТоваров = ЗНАЧЕНИЕ(Перечисление.СпособыПередачиТоваров.ПередачаНаКомиссию)
	|			ТОГДА ВидыЗапасовВладельца.Организация
	|		ИНАЧЕ ВидыЗапасовВладельца.ВладелецТовара
	|	КОНЕЦ КАК ВладелецТовара,
	|	ВидыЗапасовВладельца.ТипЗапасов КАК ТипЗапасовВладельца,
	|	ВидыЗапасовВладельца.НалогообложениеНДС КАК НалогообложениеВладельца
	|ИЗ
	|	Справочник.ВидыЗапасов КАК ВидыЗапасовВладельца
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.НастройкаПередачиТоваровМеждуОрганизациями КАК Настройка
	|		ПО ВидыЗапасовВладельца.Организация = Настройка.ОрганизацияВладелец
	|			И ВидыЗапасовВладельца.ТипЗапасов = Настройка.ТипЗапасов
	|			И (Настройка.ОрганизацияПродавец = &ОрганизацияПродавец)
	|			И (Настройка.СпособПередачиТоваров <> ЗНАЧЕНИЕ(Перечисление.СпособыПередачиТоваров.НеПередается))
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ВидыЗапасов КАК ВидыЗапасовПродавца
	|		ПО ВидыЗапасовВладельца.Ссылка = ВидыЗапасовПродавца.ВидЗапасовВладельца
	|			И (Настройка.ОрганизацияПродавец = ВидыЗапасовПродавца.Организация)
	|			И (Настройка.СпособПередачиТоваров = ВидыЗапасовПродавца.СпособПередачиТоваров)
	|			И (Настройка.Валюта = ВидыЗапасовПродавца.Валюта
	|				ИЛИ Настройка.СпособПередачиТоваров = ЗНАЧЕНИЕ(Перечисление.СпособыПередачиТоваров.Продажа))
	|			И (ВидыЗапасовПродавца.НалогообложениеНДС = &ПередачаПодДеятельность
	|				ИЛИ Настройка.СпособПередачиТоваров = ЗНАЧЕНИЕ(Перечисление.СпособыПередачиТоваров.ПередачаНаКомиссию))
	|ГДЕ
	|	ВидыЗапасовВладельца.Ссылка = &ВидЗапасовВладельца");
	
	Запрос.УстановитьПараметр("ОрганизацияПродавец", ОрганизацияПродавец);
	Запрос.УстановитьПараметр("ВидЗапасовВладельца", ВидЗапасовВладельца);
	ИспользоватьРаздельныйУчетПоНалогообложению =
		НастройкиНалоговУчетныхПолитикПовтИсп.РаздельныйУчетТоваровПоНалогообложениюНДС(ОрганизацияПродавец, ДатаДокумента);
	Если ИспользоватьРаздельныйУчетПоНалогообложению Тогда
		Запрос.УстановитьПараметр("ПередачаПодДеятельность", ПередачаПодДеятельность);
	Иначе
		Запрос.УстановитьПараметр("ПередачаПодДеятельность", Перечисления.ТипыНалогообложенияНДС.ПустаяСсылка());
	КонецЕсли;	
	
	ВидЗапасов = Справочники.ВидыЗапасов.ПустаяСсылка();
	
	УстановитьПривилегированныйРежим(Истина);
	Выборка = Запрос.Выполнить().Выбрать();
	УстановитьПривилегированныйРежим(Ложь);
	
	Если Выборка.Следующий() Тогда
		
		Если ЗначениеЗаполнено(Выборка.ВидЗапасов) Тогда
			ВидЗапасов = Выборка.ВидЗапасов;
		Иначе
			СтруктураПараметры = Новый Структура("
				|Организация,
				|СпособПередачиТоваров,
				|Комитент,
				|Контрагент,
				|Валюта,
				|ВидЗапасовВладельца,
				|РеализацияЗапасовДругойОрганизации,
				|ВладелецТовара,
				|НалогообложениеНДС
				|");
			ЗаполнитьЗначенияСвойств(СтруктураПараметры, Выборка);
			
			Если Выборка.СпособПередачиТоваров = Перечисления.СпособыПередачиТоваров.ПередачаНаКомиссию
				ИЛИ Выборка.СпособПередачиТоваров = Перечисления.СпособыПередачиТоваров.ПередачаНаКомиссиюВозврат Тогда
				Если ПередачаПодДеятельность = Перечисления.ТипыНалогообложенияНДС.ПродажаНаЭкспорт
					И ДатаДокумента >= УчетНДСУП.НастройкиУчета().ДатаРазделенияЭкспорта Тогда
					Если СырьевойТовар Тогда
						НалогообложениеНДС = Перечисления.ТипыНалогообложенияНДС.ЭкспортСырьевыхТоваровУслуг;
					Иначе
						НалогообложениеНДС = Перечисления.ТипыНалогообложенияНДС.ЭкспортНесырьевыхТоваров;
					КонецЕсли;
				ИначеЕсли Выборка.ТипЗапасовВладельца = Перечисления.ТипыЗапасов.КомиссионныйТовар Тогда
					НалогообложениеНДС = Выборка.НалогообложениеВладельца;
				Иначе
					УстановитьПривилегированныйРежим(Истина);
					ПараметрыУчетаПоОрганизации = УчетНДСУП.ПараметрыУчетаПоОрганизации(
						Выборка.ВладелецТовара,
						ТекущаяДатаСеанса());
					НалогообложениеНДС = ПараметрыУчетаПоОрганизации.ОсновноеНалогообложениеНДСПродажи;
					УстановитьПривилегированныйРежим(Ложь);
				КонецЕсли;
			ИначеЕсли ИспользоватьРаздельныйУчетПоНалогообложению Тогда
				Если ПередачаПодДеятельность = Перечисления.ТипыНалогообложенияНДС.ПродажаНаЭкспорт
					И ДатаДокумента >= УчетНДСУП.НастройкиУчета().ДатаРазделенияЭкспорта Тогда
					Если СырьевойТовар Тогда
						НалогообложениеНДС = Перечисления.ТипыНалогообложенияНДС.ЭкспортСырьевыхТоваровУслуг;
					Иначе
						НалогообложениеНДС = Перечисления.ТипыНалогообложенияНДС.ЭкспортНесырьевыхТоваров;
					КонецЕсли;
				Иначе
					НалогообложениеНДС = ПередачаПодДеятельность;
				КонецЕсли;
			Иначе
				НалогообложениеНДС = Перечисления.ТипыНалогообложенияНДС.ПустаяСсылка();
			КонецЕсли;
			
			СправочникОбъект = Справочники.ВидыЗапасов.СоздатьЭлемент();
			ЗаполнитьЗначенияСвойств(СправочникОбъект, СтруктураПараметры);
			СправочникОбъект.НалогообложениеНДС = НалогообложениеНДС;
			
			УстановитьПривилегированныйРежим(Истина);
			СправочникОбъект.Записать();
			УстановитьПривилегированныйРежим(Ложь);
			
			ВидЗапасов = СправочникОбъект.Ссылка;
		КонецЕсли;
		
	КонецЕсли;
	
	Возврат ВидЗапасов;
	
КонецФункции

// Функция получает вид запасов для возврата товаров от клиента.
//
// Параметры:
//	ВидЗапасовОтгрузки - СправочникСсылка.ВидыЗапасов - Вид запасов реализованного товара
//	Организация - СправочникСсылка.Организации - Организация в документе возврата товаров
//				- Неопределено - Организация берется из вида запасов отгрузки.
//
// Возвращаемое значение:
//	СправочникСсылка.ВидыЗапасов - Созданный вид запасов.
//
Функция ВидЗапасовДляВозвратаТоваровОтКлиента(ВидЗапасовОтгрузки, Организация = Неопределено) Экспорт
	
	Запрос = Новый Запрос("
	|ВЫБРАТЬ
	|	ВидыЗапасов.Ссылка					КАК ВидЗапасов,
	|	ВидыЗапасов.Организация				КАК Организация,
	|	ВидыЗапасов.ТипЗапасов				КАК ТипЗапасов,
	|	ВидыЗапасов.ВладелецТовара			КАК ВладелецТовара,
	|	ВидыЗапасов.Контрагент				КАК Контрагент,
	|	ВидыЗапасов.Договор					КАК Договор,
	|	ВидыЗапасов.Соглашение				КАК Соглашение,
	|	ВидыЗапасов.Валюта					КАК Валюта,
	|	ВидыЗапасов.ГруппаФинансовогоУчета	КАК ГруппаФинансовогоУчета,
	|	ВидыЗапасов.НалогообложениеНДС КАК НалогообложениеНДС,
	|	ВЫБОР КОГДА ВидыЗапасов.ТипЗапасов = ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.КомиссионныйТовар) ТОГДА
	|		ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПриемНаКомиссию)
	|	ИНАЧЕ
	|		ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ЗакупкаУПоставщика)
	|	КОНЕЦ КАК ХозяйственнаяОперация,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка) КАК НалогообложениеОрганизации
	|ИЗ
	|	Справочник.ВидыЗапасов КАК ВидыЗапасов
	|ГДЕ
	|	ВидыЗапасов.Ссылка = &ВидЗапасовОтгрузки
	|");
	
	Запрос.УстановитьПараметр("ВидЗапасовОтгрузки", ВидЗапасовОтгрузки);
	
	ВидЗапасов = Справочники.ВидыЗапасов.ПустаяСсылка();
	
	УстановитьПривилегированныйРежим(Истина);
	Выборка = Запрос.Выполнить().Выбрать();
	УстановитьПривилегированныйРежим(Ложь);
	Если Выборка.Следующий() Тогда
		
		ВидЗапасов = Справочники.ВидыЗапасов.ВидЗапасовДокумента(
			?(Организация = Неопределено, Выборка.Организация, Организация),
			Выборка.ХозяйственнаяОперация,
			Выборка);
			
	КонецЕсли;
	
	Возврат ВидЗапасов;
	
КонецФункции

#Область ДляВызоваИзДругихПодсистем

// СтандартныеПодсистемы.УправлениеДоступом

// Параметры:
//   Ограничение - см. УправлениеДоступомПереопределяемый.ПриЗаполненииОграниченияДоступа.Ограничение.
//
Процедура ПриЗаполненииОграниченияДоступа(Ограничение) Экспорт

	Ограничение.Текст =
	"РазрешитьЧтениеИзменение
	|ГДЕ
	|	( ЗначениеРазрешено(Организация)
	|	ИЛИ(ВЫБОР КОГДА ТипЗначения(ВладелецТовара) = Тип(Справочник.Организации) ТОГДА ЗначениеРазрешено(ВладелецТовара)
	|	ИНАЧЕ ЛОЖЬ КОНЕЦ)) 
	|	И(ВЫБОР КОГДА ТипЗапасов = ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.КомиссионныйТовар) ТОГДА ЗначениеРазрешено(ВладелецТовара)
	|	ИНАЧЕ ИСТИНА КОНЕЦ) ";

КонецПроцедуры

// Конец СтандартныеПодсистемы.УправлениеДоступом

#КонецОбласти

#КонецОбласти

#Область ЗаменаДублейВидовЗапасов

Функция ТекстЗапросаПоискаДублейВидовЗапасов(ЭтоОбработчикОбновления = Ложь)
	
	ТекстЗапроса = 
	"ВЫБРАТЬ
	|	ВидыЗапасов.Организация КАК Организация,
	|	ВидыЗапасов.ТипЗапасов КАК ТипЗапасов,
	|	ВидыЗапасов.НалогообложениеНДС КАК НалогообложениеНДС,
	|	ВЫБОР ВидыЗапасов.ВладелецТовара
	|		КОГДА ЗНАЧЕНИЕ(Справочник.Организации.ПустаяСсылка)
	|			ТОГДА НЕОПРЕДЕЛЕНО
	|		КОГДА ЗНАЧЕНИЕ(Справочник.Партнеры.ПустаяСсылка)
	|			ТОГДА НЕОПРЕДЕЛЕНО
	|		ИНАЧЕ ВидыЗапасов.ВладелецТовара
	|	КОНЕЦ КАК ВладелецТовара,
	|	ВидыЗапасов.Соглашение КАК Соглашение,
	|	ВидыЗапасов.Валюта КАК Валюта,
	|	ВидыЗапасов.РеализацияЗапасовДругойОрганизации КАК РеализацияЗапасовДругойОрганизации,
	|	ВидыЗапасов.ВидЗапасовВладельца КАК ВидЗапасовВладельца,
	|	ВидыЗапасов.СпособПередачиТоваров КАК СпособПередачиТоваров,
	|	ВЫБОР
	|		КОГДА ВидыЗапасов.УстарелоПоставщик В (ЗНАЧЕНИЕ(Справочник.Организации.ПустаяСсылка), ЗНАЧЕНИЕ(Справочник.Партнеры.ПустаяСсылка))
	|			ТОГДА НЕОПРЕДЕЛЕНО
	|		КОГДА НЕ ВидыЗапасов.ВладелецТовара В (НЕОПРЕДЕЛЕНО, ЗНАЧЕНИЕ(Справочник.Организации.ПустаяСсылка), ЗНАЧЕНИЕ(Справочник.Партнеры.ПустаяСсылка))
	|			ТОГДА НЕОПРЕДЕЛЕНО
	|		ИНАЧЕ ВидыЗапасов.УстарелоПоставщик
	|	КОНЕЦ КАК УстарелоПоставщик,
	|	ВЫБОР
	|		КОГДА ВидыЗапасов.УстарелоПредназначение = ЗНАЧЕНИЕ(Перечисление.ТипыПредназначенияВидовЗапасов.ПредназначениеНеОграничено)
	|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыПредназначенияВидовЗапасов.ПустаяСсылка)
	|		ИНАЧЕ ВидыЗапасов.УстарелоПредназначение
	|	КОНЕЦ КАК УстарелоПредназначение,
	|	ВидыЗапасов.УстарелоПодразделение КАК УстарелоПодразделение,
	|	ВидыЗапасов.УстарелоМенеджер КАК УстарелоМенеджер,
	|	ВидыЗапасов.УстарелоСделка КАК УстарелоСделка,
	|	ВидыЗапасов.ГруппаФинансовогоУчета КАК ГруппаФинансовогоУчета,
	|	ВЫБОР ВидыЗапасов.Контрагент
	|		КОГДА ЗНАЧЕНИЕ(Справочник.Организации.ПустаяСсылка)
	|			ТОГДА НЕОПРЕДЕЛЕНО
	|		КОГДА ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	|			ТОГДА НЕОПРЕДЕЛЕНО
	|		ИНАЧЕ ВидыЗапасов.Контрагент
	|	КОНЕЦ КАК Контрагент,
	|	ВЫБОР ВидыЗапасов.Договор
	|		КОГДА ЗНАЧЕНИЕ(Справочник.ДоговорыМеждуОрганизациями.ПустаяСсылка)
	|			ТОГДА НЕОПРЕДЕЛЕНО
	|		КОГДА ЗНАЧЕНИЕ(Справочник.ДоговорыКонтрагентов.ПустаяСсылка)
	|			ТОГДА НЕОПРЕДЕЛЕНО
	|		ИНАЧЕ ВидыЗапасов.Договор
	|	КОНЕЦ КАК Договор,
	|	ВидыЗапасов.УстарелоНазначение КАК УстарелоНазначение,
	|	ВидыЗапасов.ГруппаПродукции КАК ГруппаПродукции,
	|	ВидыЗапасов.ВидЦены КАК ВидЦены,
	|	СУММА(1) КАК КоличествоДублей
	|ПОМЕСТИТЬ ВтОтборыДублей
	|ИЗ
	|	Справочник.ВидыЗапасов КАК ВидыЗапасов
	|ГДЕ
	|	(&ПоВсемОрганизациям
	|			ИЛИ ВидыЗапасов.Организация В (&МассивОрганизаций))
	|	И (НЕ ВидыЗапасов.ПометкаУдаления
	|			ИЛИ НЕ &ПроверятьПометкуУдаления)
	|
	|СГРУППИРОВАТЬ ПО
	|	ВидыЗапасов.Организация,
	|	ВидыЗапасов.ТипЗапасов,
	|	ВидыЗапасов.НалогообложениеНДС,
	|	ВЫБОР ВидыЗапасов.ВладелецТовара
	|		КОГДА ЗНАЧЕНИЕ(Справочник.Организации.ПустаяСсылка)
	|			ТОГДА НЕОПРЕДЕЛЕНО
	|		КОГДА ЗНАЧЕНИЕ(Справочник.Партнеры.ПустаяСсылка)
	|			ТОГДА НЕОПРЕДЕЛЕНО
	|		ИНАЧЕ ВидыЗапасов.ВладелецТовара
	|	КОНЕЦ,
	|	ВидыЗапасов.Соглашение,
	|	ВидыЗапасов.Валюта,
	|	ВидыЗапасов.РеализацияЗапасовДругойОрганизации,
	|	ВидыЗапасов.ВидЗапасовВладельца,
	|	ВидыЗапасов.СпособПередачиТоваров,
	|	ВЫБОР
	|		КОГДА ВидыЗапасов.УстарелоПоставщик В (ЗНАЧЕНИЕ(Справочник.Организации.ПустаяСсылка), ЗНАЧЕНИЕ(Справочник.Партнеры.ПустаяСсылка))
	|			ТОГДА НЕОПРЕДЕЛЕНО
	|		КОГДА НЕ ВидыЗапасов.ВладелецТовара В (НЕОПРЕДЕЛЕНО, ЗНАЧЕНИЕ(Справочник.Организации.ПустаяСсылка), ЗНАЧЕНИЕ(Справочник.Партнеры.ПустаяСсылка))
	|			ТОГДА НЕОПРЕДЕЛЕНО
	|		ИНАЧЕ ВидыЗапасов.УстарелоПоставщик
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА ВидыЗапасов.УстарелоПредназначение = ЗНАЧЕНИЕ(Перечисление.ТипыПредназначенияВидовЗапасов.ПредназначениеНеОграничено)
	|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыПредназначенияВидовЗапасов.ПустаяСсылка)
	|		ИНАЧЕ ВидыЗапасов.УстарелоПредназначение
	|	КОНЕЦ,
	|	ВидыЗапасов.УстарелоПодразделение,
	|	ВидыЗапасов.УстарелоМенеджер,
	|	ВидыЗапасов.УстарелоСделка,
	|	ВидыЗапасов.ГруппаФинансовогоУчета,
	|	ВЫБОР ВидыЗапасов.Контрагент
	|		КОГДА ЗНАЧЕНИЕ(Справочник.Организации.ПустаяСсылка)
	|			ТОГДА НЕОПРЕДЕЛЕНО
	|		КОГДА ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	|			ТОГДА НЕОПРЕДЕЛЕНО
	|		ИНАЧЕ ВидыЗапасов.Контрагент
	|	КОНЕЦ,
	|	ВЫБОР ВидыЗапасов.Договор
	|		КОГДА ЗНАЧЕНИЕ(Справочник.ДоговорыМеждуОрганизациями.ПустаяСсылка)
	|			ТОГДА НЕОПРЕДЕЛЕНО
	|		КОГДА ЗНАЧЕНИЕ(Справочник.ДоговорыКонтрагентов.ПустаяСсылка)
	|			ТОГДА НЕОПРЕДЕЛЕНО
	|		ИНАЧЕ ВидыЗапасов.Договор
	|	КОНЕЦ,
	|	ВидыЗапасов.УстарелоНазначение,
	|	ВидыЗапасов.ГруппаПродукции,
	|	ВидыЗапасов.ВидЦены
	|
	|ИМЕЮЩИЕ
	|	СУММА(1) > 1
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Организация,
	|	ТипЗапасов,
	|	ВладелецТовара,
	|	Соглашение,
	|	Валюта,
	|	РеализацияЗапасовДругойОрганизации,
	|	ВидЗапасовВладельца,
	|	СпособПередачиТоваров,
	|	УстарелоПоставщик,
	|	УстарелоПодразделение,
	|	УстарелоМенеджер,
	|	УстарелоСделка,
	|	Контрагент,
	|	Договор,
	|	УстарелоНазначение,
	|	ГруппаПродукции,
	|	ВидЦены";
	
	ТекстЗапроса = ТекстЗапроса + 
	"
	|;
	|//////////////////////////////////////////
	|";
	
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "&ЭтоОбработчикОбновления", ?(ЭтоОбработчикОбновления, "ИСТИНА", "ЛОЖЬ"));
	
	Возврат ТекстЗапроса;
	
КонецФункции

Функция ТекстЗапросаНаличиеДублейВидовЗапасов() Экспорт
	
	 Возврат "ВЫБРАТЬ ПЕРВЫЕ 1
	 |	ВидыЗапасов.Ссылка КАК Ссылка
	 |ИЗ
	 |	Справочник.ВидыЗапасов КАК ВидыЗапасов
	 |ГДЕ
	 |	ВидыЗапасов.ЭтоДубль";
	
КонецФункции

Процедура УстановитьПараметрыЗапросаПоискаДублей(Запрос, МассивОрганизаций = Неопределено, ПроверятьПометкуУдаления = Ложь)
	
	ЕстьОтборПоОрганизациям = ЗначениеЗаполнено(МассивОрганизаций);
	
	Запрос.УстановитьПараметр("ПоВсемОрганизациям", НЕ ЕстьОтборПоОрганизациям);
	Запрос.УстановитьПараметр("МассивОрганизаций",  ?(ЕстьОтборПоОрганизациям, МассивОрганизаций, Новый Массив));
	Запрос.УстановитьПараметр("ПроверятьПометкуУдаления", ПроверятьПометкуУдаления);
	
КонецПроцедуры

Процедура ЗаменитьДублиВидовЗапасов(Параметры = Неопределено, АдресХранилищаРезультата = "") Экспорт
	
	Запрос = Новый Запрос;
	Запрос.МенеджерВременныхТаблиц = Новый МенеджерВременныхТаблиц;
	Запрос.Текст = ТекстЗапросаПоискаДублейВидовЗапасов() + 
	"ВЫБРАТЬ
	|	ВидыЗапасов.Ссылка КАК Ссылка,
	|	ВидыЗапасов.Наименование КАК Наименование,
	|	ВидыЗапасов.Организация КАК Организация,
	|	ВидыЗапасов.ТипЗапасов КАК ТипЗапасов,
	|	ВидыЗапасов.НалогообложениеНДС КАК НалогообложениеНДС,
	|	ВЫБОР ВидыЗапасов.ВладелецТовара
	|		КОГДА ЗНАЧЕНИЕ(Справочник.Организации.ПустаяСсылка)
	|			ТОГДА НЕОПРЕДЕЛЕНО
	|		КОГДА ЗНАЧЕНИЕ(Справочник.Партнеры.ПустаяСсылка)
	|			ТОГДА НЕОПРЕДЕЛЕНО
	|		ИНАЧЕ ВидыЗапасов.ВладелецТовара
	|	КОНЕЦ КАК ВладелецТовара,
	|	ВидыЗапасов.Соглашение КАК Соглашение,
	|	ВидыЗапасов.Валюта КАК Валюта,
	|	ВидыЗапасов.РеализацияЗапасовДругойОрганизации КАК РеализацияЗапасовДругойОрганизации,
	|	ВидыЗапасов.ВидЗапасовВладельца КАК ВидЗапасовВладельца,
	|	ВидыЗапасов.СпособПередачиТоваров КАК СпособПередачиТоваров,
	|	ВЫБОР
	|		КОГДА ВидыЗапасов.УстарелоПоставщик В (ЗНАЧЕНИЕ(Справочник.Организации.ПустаяСсылка), ЗНАЧЕНИЕ(Справочник.Партнеры.ПустаяСсылка))
	|			ТОГДА НЕОПРЕДЕЛЕНО
	|		КОГДА НЕ ВидыЗапасов.ВладелецТовара В (НЕОПРЕДЕЛЕНО, ЗНАЧЕНИЕ(Справочник.Организации.ПустаяСсылка), ЗНАЧЕНИЕ(Справочник.Партнеры.ПустаяСсылка))
	|			ТОГДА НЕОПРЕДЕЛЕНО
	|		ИНАЧЕ ВидыЗапасов.УстарелоПоставщик
	|	КОНЕЦ КАК УстарелоПоставщик,
	|	ВЫБОР
	|		КОГДА ВидыЗапасов.УстарелоПредназначение = ЗНАЧЕНИЕ(Перечисление.ТипыПредназначенияВидовЗапасов.ПредназначениеНеОграничено)
	|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыПредназначенияВидовЗапасов.ПустаяСсылка)
	|		ИНАЧЕ ВидыЗапасов.УстарелоПредназначение
	|	КОНЕЦ КАК УстарелоПредназначение,
	|	ВидыЗапасов.УстарелоПодразделение КАК УстарелоПодразделение,
	|	ВидыЗапасов.УстарелоМенеджер КАК УстарелоМенеджер,
	|	ВидыЗапасов.УстарелоСделка КАК УстарелоСделка,
	|	ВидыЗапасов.ГруппаФинансовогоУчета КАК ГруппаФинансовогоУчета,
	|	ВЫБОР ВидыЗапасов.Контрагент
	|		КОГДА ЗНАЧЕНИЕ(Справочник.Организации.ПустаяСсылка)
	|			ТОГДА НЕОПРЕДЕЛЕНО
	|		КОГДА ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	|			ТОГДА НЕОПРЕДЕЛЕНО
	|		ИНАЧЕ ВидыЗапасов.Контрагент
	|	КОНЕЦ КАК Контрагент,
	|	ВЫБОР ВидыЗапасов.Договор
	|		КОГДА ЗНАЧЕНИЕ(Справочник.ДоговорыМеждуОрганизациями.ПустаяСсылка)
	|			ТОГДА НЕОПРЕДЕЛЕНО
	|		КОГДА ЗНАЧЕНИЕ(Справочник.ДоговорыКонтрагентов.ПустаяСсылка)
	|			ТОГДА НЕОПРЕДЕЛЕНО
	|		ИНАЧЕ ВидыЗапасов.Договор
	|	КОНЕЦ КАК Договор,
	|	ВидыЗапасов.УстарелоНазначение КАК УстарелоНазначение,
	|	ВидыЗапасов.ГруппаПродукции КАК ГруппаПродукции,
	|	ВидыЗапасов.ВидЦены КАК ВидЦены,
	|	ВидыЗапасов.ЭтоДубль КАК ЭтоДубль
	|ПОМЕСТИТЬ СпрВидыЗапасов
	|ИЗ
	|	Справочник.ВидыЗапасов КАК ВидыЗапасов
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ВидыЗапасов.Организация КАК Организация,
	|	ВидыЗапасов.ТипЗапасов КАК ТипЗапасов,
	|	ВидыЗапасов.НалогообложениеНДС КАК НалогообложениеНДС,
	|	ВидыЗапасов.ВладелецТовара КАК ВладелецТовара,
	|	ВидыЗапасов.Соглашение КАК Соглашение,
	|	ВидыЗапасов.Валюта КАК Валюта,
	|	ВидыЗапасов.РеализацияЗапасовДругойОрганизации КАК РеализацияЗапасовДругойОрганизации,
	|	ВидыЗапасов.ВидЗапасовВладельца КАК ВидЗапасовВладельца,
	|	ВидыЗапасов.СпособПередачиТоваров КАК СпособПередачиТоваров,
	|	ВидыЗапасов.УстарелоПоставщик КАК УстарелоПоставщик,
	|	ВидыЗапасов.УстарелоПодразделение КАК УстарелоПодразделение,
	|	ВидыЗапасов.УстарелоМенеджер КАК УстарелоМенеджер,
	|	ВидыЗапасов.УстарелоСделка КАК УстарелоСделка,
	|	ВидыЗапасов.Контрагент КАК Контрагент,
	|	ВидыЗапасов.Договор КАК Договор,
	|	ВидыЗапасов.УстарелоНазначение КАК УстарелоНазначение,
	|	ВидыЗапасов.ГруппаПродукции КАК ГруппаПродукции,
	|	ВидыЗапасов.ГруппаФинансовогоУчета КАК ГруппаФинансовогоУчета,
	|	ВидыЗапасов.ВидЦены КАК ВидЦены,
	|	ВидыЗапасов.Ссылка КАК Ссылка
	|ПОМЕСТИТЬ КорректныеВидыЗапасов
	|ИЗ
	|	СпрВидыЗапасов КАК ВидыЗапасов
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВтОтборыДублей КАК Отборы
	|		ПО ВидыЗапасов.Организация = Отборы.Организация
	|			И ВидыЗапасов.ТипЗапасов = Отборы.ТипЗапасов
	|			И ВидыЗапасов.ВладелецТовара = Отборы.ВладелецТовара
	|			И ВидыЗапасов.Соглашение = Отборы.Соглашение
	|			И ВидыЗапасов.Валюта = Отборы.Валюта
	|			И ВидыЗапасов.РеализацияЗапасовДругойОрганизации = Отборы.РеализацияЗапасовДругойОрганизации
	|			И ВидыЗапасов.ВидЗапасовВладельца = Отборы.ВидЗапасовВладельца
	|			И ВидыЗапасов.СпособПередачиТоваров = Отборы.СпособПередачиТоваров
	|			И ВидыЗапасов.УстарелоПоставщик = Отборы.УстарелоПоставщик
	|			И ВидыЗапасов.УстарелоПодразделение = Отборы.УстарелоПодразделение
	|			И ВидыЗапасов.УстарелоМенеджер = Отборы.УстарелоМенеджер
	|			И ВидыЗапасов.УстарелоСделка = Отборы.УстарелоСделка
	|			И ВидыЗапасов.Контрагент = Отборы.Контрагент
	|			И ВидыЗапасов.Договор = Отборы.Договор
	|			И ВидыЗапасов.УстарелоНазначение = Отборы.УстарелоНазначение
	|			И ВидыЗапасов.ГруппаПродукции = Отборы.ГруппаПродукции
	|			И ВидыЗапасов.ВидЦены = Отборы.ВидЦены
	|			И ВидыЗапасов.ГруппаФинансовогоУчета = Отборы.ГруппаФинансовогоУчета
	|			И ВидыЗапасов.НалогообложениеНДС = Отборы.НалогообложениеНДС
	|ГДЕ
	|	НЕ ВидыЗапасов.ЭтоДубль
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Организация,
	|	ТипЗапасов,
	|	ВладелецТовара,
	|	Соглашение,
	|	Валюта,
	|	РеализацияЗапасовДругойОрганизации,
	|	ВидЗапасовВладельца,
	|	СпособПередачиТоваров,
	|	УстарелоПоставщик,
	|	УстарелоПодразделение,
	|	УстарелоМенеджер,
	|	УстарелоСделка,
	|	Контрагент,
	|	Договор,
	|	УстарелоНазначение,
	|	ГруппаПродукции,
	|	ВидЦены
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ВидыЗапасов.Организация КАК Организация,
	|	ВидыЗапасов.ТипЗапасов КАК ТипЗапасов,
	|	ВидыЗапасов.НалогообложениеНДС КАК НалогообложениеНДС,
	|	ВидыЗапасов.ВладелецТовара КАК ВладелецТовара,
	|	ВидыЗапасов.Соглашение КАК Соглашение,
	|	ВидыЗапасов.Валюта КАК Валюта,
	|	ВидыЗапасов.РеализацияЗапасовДругойОрганизации КАК РеализацияЗапасовДругойОрганизации,
	|	ВидыЗапасов.ВидЗапасовВладельца КАК ВидЗапасовВладельца,
	|	ВидыЗапасов.СпособПередачиТоваров КАК СпособПередачиТоваров,
	|	ВидыЗапасов.УстарелоПоставщик КАК УстарелоПоставщик,
	|	ВидыЗапасов.УстарелоПодразделение КАК УстарелоПодразделение,
	|	ВидыЗапасов.УстарелоМенеджер КАК УстарелоМенеджер,
	|	ВидыЗапасов.УстарелоСделка КАК УстарелоСделка,
	|	ВидыЗапасов.Контрагент КАК Контрагент,
	|	ВидыЗапасов.Договор КАК Договор,
	|	ВидыЗапасов.УстарелоНазначение КАК УстарелоНазначение,
	|	ВидыЗапасов.ГруппаПродукции КАК ГруппаПродукции,
	|	ВидыЗапасов.ГруппаФинансовогоУчета КАК ГруппаФинансовогоУчета,
	|	ВидыЗапасов.ВидЦены КАК ВидЦены,
	|	ВидыЗапасов.Ссылка КАК Ссылка
	|ПОМЕСТИТЬ ДублиВидовЗапасов
	|ИЗ
	|	СпрВидыЗапасов КАК ВидыЗапасов
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВтОтборыДублей КАК Отборы
	|		ПО ВидыЗапасов.Организация = Отборы.Организация
	|			И ВидыЗапасов.ТипЗапасов = Отборы.ТипЗапасов
	|			И ВидыЗапасов.ВладелецТовара = Отборы.ВладелецТовара
	|			И ВидыЗапасов.Соглашение = Отборы.Соглашение
	|			И ВидыЗапасов.Валюта = Отборы.Валюта
	|			И ВидыЗапасов.РеализацияЗапасовДругойОрганизации = Отборы.РеализацияЗапасовДругойОрганизации
	|			И ВидыЗапасов.ВидЗапасовВладельца = Отборы.ВидЗапасовВладельца
	|			И ВидыЗапасов.СпособПередачиТоваров = Отборы.СпособПередачиТоваров
	|			И ВидыЗапасов.УстарелоПоставщик = Отборы.УстарелоПоставщик
	|			И ВидыЗапасов.УстарелоПодразделение = Отборы.УстарелоПодразделение
	|			И ВидыЗапасов.УстарелоМенеджер = Отборы.УстарелоМенеджер
	|			И ВидыЗапасов.УстарелоСделка = Отборы.УстарелоСделка
	|			И ВидыЗапасов.Контрагент = Отборы.Контрагент
	|			И ВидыЗапасов.Договор = Отборы.Договор
	|			И ВидыЗапасов.УстарелоНазначение = Отборы.УстарелоНазначение
	|			И ВидыЗапасов.ГруппаПродукции = Отборы.ГруппаПродукции
	|			И ВидыЗапасов.ВидЦены = Отборы.ВидЦены
	|			И ВидыЗапасов.ГруппаФинансовогоУчета = Отборы.ГруппаФинансовогоУчета
	|			И ВидыЗапасов.НалогообложениеНДС = Отборы.НалогообложениеНДС
	|ГДЕ
	|	ВидыЗапасов.ЭтоДубль
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ЕСТЬNULL(Корректные.Ссылка, ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка)) КАК КорректныйВидЗапасов,
	|	Дубли.Ссылка КАК Дубль,
	|	Дубли.Ссылка.ПометкаУдаления КАК ПометкаУдаленияДубля
	|ИЗ
	|	ДублиВидовЗапасов КАК Дубли
	|		ЛЕВОЕ СОЕДИНЕНИЕ КорректныеВидыЗапасов КАК Корректные
	|		ПО Дубли.Организация = Корректные.Организация
	|			И Дубли.ТипЗапасов = Корректные.ТипЗапасов
	|			И Дубли.ВладелецТовара = Корректные.ВладелецТовара
	|			И Дубли.Соглашение = Корректные.Соглашение
	|			И Дубли.Валюта = Корректные.Валюта
	|			И Дубли.РеализацияЗапасовДругойОрганизации = Корректные.РеализацияЗапасовДругойОрганизации
	|			И Дубли.ВидЗапасовВладельца = Корректные.ВидЗапасовВладельца
	|			И Дубли.СпособПередачиТоваров = Корректные.СпособПередачиТоваров
	|			И Дубли.УстарелоПоставщик = Корректные.УстарелоПоставщик
	|			И Дубли.УстарелоПодразделение = Корректные.УстарелоПодразделение
	|			И Дубли.УстарелоМенеджер = Корректные.УстарелоМенеджер
	|			И Дубли.УстарелоСделка = Корректные.УстарелоСделка
	|			И Дубли.Контрагент = Корректные.Контрагент
	|			И Дубли.Договор = Корректные.Договор
	|			И Дубли.УстарелоНазначение = Корректные.УстарелоНазначение
	|			И Дубли.ГруппаПродукции = Корректные.ГруппаПродукции
	|			И Дубли.ВидЦены = Корректные.ВидЦены
	|			И Дубли.ГруппаФинансовогоУчета = Корректные.ГруппаФинансовогоУчета
	|			И Дубли.НалогообложениеНДС = Корректные.НалогообложениеНДС
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ВтОтборыДублей
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ КорректныеВидыЗапасов
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ДублиВидовЗапасов
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ СпрВидыЗапасов";
	
	УстановитьПараметрыЗапросаПоискаДублей(Запрос);
	
	УстановитьПривилегированныйРежим(Истина);
	Результат = Запрос.Выполнить();
	
	// Собственные виды запасов.
	ВсеДубли = Результат.Выгрузить();
	
	ДублиБезКорректныхЗаписей = ВсеДубли.НайтиСтроки(Новый Структура("КорректныйВидЗапасов", Справочники.ВидыЗапасов.ПустаяСсылка()));
	
	Если ДублиБезКорректныхЗаписей.Количество() > 0 Тогда
		
		Для Каждого СтрМас Из ДублиБезКорректныхЗаписей Цикл
			НачатьТранзакцию();
			Попытка
				СпрОбъект = СтрМас.Дубль.ПолучитьОбъект();
				СпрОбъект.ЭтоДубль = Ложь;
				СпрОбъект.ДополнительныеСвойства.Вставить("НеПроверятьДубли", Истина);
				СпрОбъект.Записать();
				ЗафиксироватьТранзакцию();
			Исключение
				ОтменитьТранзакцию();
				ТекстСообщения = НСтр("ru = 'Не отменить отметку %ЭтоДубль%: %Ссылка% по причине: %Причина%';
										|en = 'Cannot cancel %ЭтоДубль% mark: %Ссылка% due to: %Причина%'");
				ТекстСообщения = СтрЗаменить(ТекстСообщения, "%ЭтоДубль%", "ЭтоДубль");
				ТекстСообщения = СтрЗаменить(ТекстСообщения, "%Ссылка%",  СпрОбъект.Ссылка);
				ТекстСообщения = СтрЗаменить(ТекстСообщения, "%Причина%", ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()));
				ЗаписьЖурналаРегистрации(ОбновлениеИнформационнойБазы.СобытиеЖурналаРегистрации(),
					УровеньЖурналаРегистрации.Ошибка,
					Метаданные.Справочники.ВидыЗапасов,
					СпрОбъект.Ссылка,
					ТекстСообщения);
			КонецПопытки;
		КонецЦикла;
		ПометитьДублиВидовЗапасов();
		
	КонецЕсли;
	
	Результат = Запрос.Выполнить();
	
	// Собственные виды запасов.
	Результат = Запрос.Выполнить();
	ВсеДубли = Результат.Выгрузить();
	
	ДублиБезКорректныхЗаписей = ВсеДубли.НайтиСтроки(Новый Структура("КорректныйВидЗапасов", Справочники.ВидыЗапасов.ПустаяСсылка()));
	
	Если ДублиБезКорректныхЗаписей.Количество() > 0 Тогда
		
		ТекстСообщения = НСтр("ru = 'Не для всех дублей видов запасов удается определить корректный вид запасов. Обратитесь к разработчикам.';
								|en = 'Cannot determine correct inventory owner attribute for some of the duplicate inventory owner attributes. Contact the developers.'");
		
		ВызватьИсключение ТекстСообщения;
		
	КонецЕсли;
	// Сформируем соответствие элементов к замене.
	СоответствиеЗаписей = Новый Соответствие;
	
	Для каждого СтрМас из ВсеДубли Цикл
		
		СоответствиеЗаписей.Вставить(СтрМас.Дубль, СтрМас.КорректныйВидЗапасов);
		
		Если НЕ СтрМас.ПометкаУдаленияДубля Тогда
			СправочникОбъект = СтрМас.Дубль.ПолучитьОбъект();
			СправочникОбъект.ДополнительныеСвойства.Вставить("НеПроверятьДубли", Истина);
			СправочникОбъект.УстановитьПометкуУдаления(Истина, Ложь);
		КонецЕсли;

	КонецЦикла;
	УстановитьПривилегированныйРежим(Ложь);
	
	Если СоответствиеЗаписей.Количество() > 0 Тогда
	
		// Заменим дубли.
		Исключения = Новый Массив;
		Исключения.Добавить(Метаданные.РегистрыСведений.СтоимостьТоваров);
		Исключения.Добавить(Метаданные.РегистрыСведений.УстаревшиеВидыЗапасовСОстатками);
		
		УстановитьПривилегированныйРежим(Истина);
		ОбщегоНазначенияУТ.ЗаменитьСсылки(СоответствиеЗаписей, Исключения);
		УстановитьПривилегированныйРежим(Ложь);
		
		ЗаменитьДублиВРегистреСтоимостьТоваров(СоответствиеЗаписей);
		
		УстановитьПривилегированныйРежим(Истина);
		РегистрыСведений.УстаревшиеВидыЗапасовСОстатками.ОбновитьЗаписи();
		УстановитьПривилегированныйРежим(Ложь);
		
	КонецЕсли;
	
КонецПроцедуры

Процедура ЗаменитьДублиВРегистреСтоимостьТоваров(СоответствиеАналитик)
	
	ТаблицаАналитик = Новый ТаблицаЗначений;
	ТаблицаАналитик.Колонки.Добавить("ЗаменяемаяАналитика", Новый ОписаниеТипов("СправочникСсылка.ВидыЗапасов"));
	ТаблицаАналитик.Колонки.Добавить("НоваяАналитика", 		Новый ОписаниеТипов("СправочникСсылка.ВидыЗапасов"));
	
	Для Каждого КлючИЗначение Из СоответствиеАналитик Цикл
		НоваяСтрока = ТаблицаАналитик.Добавить();
		НоваяСтрока.ЗаменяемаяАналитика = КлючИЗначение.Ключ;
		НоваяСтрока.НоваяАналитика 		= КлючИЗначение.Значение;
	КонецЦикла;
	
	Запрос = Новый Запрос;
	Запрос.МенеджерВременныхТаблиц = Новый МенеджерВременныхТаблиц;
	Запрос.УстановитьПараметр("ТаблицаАналитик", ТаблицаАналитик);
	
	Запрос.Текст =
	"ВЫБРАТЬ
	|	Т.ЗаменяемаяАналитика КАК ЗаменяемаяАналитика,
	|	Т.НоваяАналитика КАК НоваяАналитика
	|ПОМЕСТИТЬ ВТАналитики
	|ИЗ
	|	&ТаблицаАналитик КАК Т
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	ЗаменяемаяАналитика
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	СтоимостьТоваров.Регистратор КАК Регистратор
	|ПОМЕСТИТЬ ВТРегистраторы
	|ИЗ
	|	РегистрСведений.СтоимостьТоваров КАК СтоимостьТоваров
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТАналитики КАК ВТАналитики
	|		ПО СтоимостьТоваров.ВидЗапасов = ВТАналитики.ЗаменяемаяАналитика
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Регистратор
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	СтоимостьТоваров.Регистратор КАК Регистратор,
	|	КОНЕЦПЕРИОДА(СтоимостьТоваров.Период, МЕСЯЦ) КАК Период,
	|	СтоимостьТоваров.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
	|	СтоимостьТоваров.Организация КАК Организация,
	|	СтоимостьТоваров.РазделУчета КАК РазделУчета,
	|	ЕСТЬNULL(ВТАналитики.НоваяАналитика, СтоимостьТоваров.ВидЗапасов) КАК ВидЗапасов,
	|	СРЕДНЕЕ(СтоимостьТоваров.Стоимость) КАК Стоимость,
	|	СРЕДНЕЕ(СтоимостьТоваров.СтоимостьДопРасходы) КАК СтоимостьДопРасходы,
	|	СРЕДНЕЕ(СтоимостьТоваров.СтоимостьЗабалансовая) КАК СтоимостьЗабалансовая,
	|	СРЕДНЕЕ(СтоимостьТоваров.СтоимостьБезНДС) КАК СтоимостьБезНДС,
	|	СРЕДНЕЕ(СтоимостьТоваров.СтоимостьДопРасходыБезНДС) КАК СтоимостьДопРасходыБезНДС,
	|	СРЕДНЕЕ(СтоимостьТоваров.Трудозатраты) КАК Трудозатраты,
	|	СРЕДНЕЕ(СтоимостьТоваров.ПостатейныеПостоянныеСНДС) КАК ПостатейныеПостоянныеСНДС,
	|	СРЕДНЕЕ(СтоимостьТоваров.ПостатейныеПеременныеСНДС) КАК ПостатейныеПеременныеСНДС,
	|	СРЕДНЕЕ(СтоимостьТоваров.ПостатейныеПостоянныеБезНДС) КАК ПостатейныеПостоянныеБезНДС,
	|	СРЕДНЕЕ(СтоимостьТоваров.ПостатейныеПеременныеБезНДС) КАК ПостатейныеПеременныеБезНДС,
	|	СРЕДНЕЕ(СтоимостьТоваров.СтоимостьРегл) КАК СтоимостьРегл,
	|	СРЕДНЕЕ(СтоимостьТоваров.СтоимостьЗабалансоваяРегл) КАК СтоимостьЗабалансоваяРегл,
	|	СРЕДНЕЕ(СтоимостьТоваров.ДопРасходыРегл) КАК ДопРасходыРегл,
	|	СРЕДНЕЕ(СтоимостьТоваров.ТрудозатратыРегл) КАК ТрудозатратыРегл,
	|	СРЕДНЕЕ(СтоимостьТоваров.ПостатейныеПостоянныеРегл) КАК ПостатейныеПостоянныеРегл,
	|	СРЕДНЕЕ(СтоимостьТоваров.ПостатейныеПеременныеРегл) КАК ПостатейныеПеременныеРегл,
	|	СРЕДНЕЕ(СтоимостьТоваров.ПостояннаяРазница) КАК ПостояннаяРазница,
	|	СРЕДНЕЕ(СтоимостьТоваров.ВременнаяРазница) КАК ВременнаяРазница,
	|	СРЕДНЕЕ(СтоимостьТоваров.СтоимостьУпр) КАК СтоимостьУпр,
	|	СРЕДНЕЕ(СтоимостьТоваров.ДопРасходыУпр) КАК ДопРасходыУпр,
	|	СРЕДНЕЕ(СтоимостьТоваров.ТрудозатратыУпр) КАК ТрудозатратыУпр,
	|	СРЕДНЕЕ(СтоимостьТоваров.ПостатейныеПостоянныеУпр) КАК ПостатейныеПостоянныеУпр,
	|	СРЕДНЕЕ(СтоимостьТоваров.ПостатейныеПеременныеУпр) КАК ПостатейныеПеременныеУпр
	|ИЗ
	|	РегистрСведений.СтоимостьТоваров КАК СтоимостьТоваров
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТРегистраторы КАК ВТРегистраторы
	|		ПО СтоимостьТоваров.Регистратор = ВТРегистраторы.Регистратор
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВТАналитики КАК ВТАналитики
	|		ПО СтоимостьТоваров.ВидЗапасов = ВТАналитики.ЗаменяемаяАналитика
	|
	|СГРУППИРОВАТЬ ПО
	|	СтоимостьТоваров.Регистратор,
	|	КОНЕЦПЕРИОДА(СтоимостьТоваров.Период, МЕСЯЦ),
	|	СтоимостьТоваров.АналитикаУчетаНоменклатуры,
	|	СтоимостьТоваров.Организация,
	|	СтоимостьТоваров.РазделУчета,
	|	ЕСТЬNULL(ВТАналитики.НоваяАналитика, СтоимостьТоваров.ВидЗапасов)
	|УПОРЯДОЧИТЬ ПО
	|	Регистратор,
	|	АналитикаУчетаНоменклатуры,
	|	Организация,
	|	РазделУчета,
	|	ВидЗапасов
	|";
	
	УстановитьПривилегированныйРежим(Истина);
	РезультатЗапроса = Запрос.Выполнить();
	УстановитьПривилегированныйРежим(Ложь);
	
	Если РезультатЗапроса.Пустой() Тогда
		Возврат;
	КонецЕсли;
	
	УстановитьПривилегированныйРежим(Истина);
	
	Выборка = РезультатЗапроса.Выбрать();
	
	ТекущийРегистратор = Неопределено;
	НаборЗаписей = РегистрыСведений.СтоимостьТоваров.СоздатьНаборЗаписей();
	
	Пока Выборка.Следующий() Цикл
		
		Если ТекущийРегистратор <> Выборка.Регистратор Тогда
			
			Если ЗначениеЗаполнено(ТекущийРегистратор) Тогда
				НаборЗаписей.Записать(Истина);
			КонецЕсли;
			
			НаборЗаписей = РегистрыСведений.СтоимостьТоваров.СоздатьНаборЗаписей();
			НаборЗаписей.Отбор.Регистратор.Установить(Выборка.Регистратор);
			
			ТекущийРегистратор = Выборка.Регистратор;
			
		КонецЕсли;
		
		ЗаполнитьЗначенияСвойств(НаборЗаписей.Добавить(), Выборка);
		
	КонецЦикла;
	
	Если ЗначениеЗаполнено(ТекущийРегистратор) Тогда
		НаборЗаписей.Записать(Истина);
	КонецЕсли;
	
	УстановитьПривилегированныйРежим(Ложь);
	
КонецПроцедуры

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

#Область Прочее

Функция ВидЗапасовПоОтборам(ПоляОтбора) Экспорт
	
	Запрос = Новый Запрос;
	Запрос.Текст =
	"ВЫБРАТЬ ПЕРВЫЕ 1
	|	ВидыЗапасов.Ссылка КАК Ссылка
	|ИЗ
	|	Справочник.ВидыЗапасов КАК ВидыЗапасов
	|ГДЕ
	|	ВидыЗапасов.Организация = &Организация
	|	И ВидыЗапасов.ТипЗапасов = &ТипЗапасов
	|	И ВидыЗапасов.НалогообложениеНДС = &НалогообложениеНДС
	|	И ВидыЗапасов.ВладелецТовара = &ВладелецТовара
	|	И ВидыЗапасов.Соглашение = &Соглашение
	|	И ВидыЗапасов.Валюта = &Валюта
	|	И ВидыЗапасов.ГруппаФинансовогоУчета = &ГруппаФинансовогоУчета
	|	И ВидыЗапасов.Контрагент = &Контрагент
	|	И ВидыЗапасов.Договор = &Договор
	|	И ВидыЗапасов.ГруппаПродукции = &ГруппаПродукции
	|	И ВидыЗапасов.ВидЦены = &ВидЦены
	|	И НЕ ВидыЗапасов.ЭтоДубль
	|	И НЕ ВидыЗапасов.Устаревший";
	
	Запрос.УстановитьПараметр("Организация", ПоляОтбора.Организация);
	Запрос.УстановитьПараметр("ТипЗапасов", ПоляОтбора.ТипЗапасов);
	Запрос.УстановитьПараметр("ВладелецТовара", ПоляОтбора.ВладелецТовара);
	Запрос.УстановитьПараметр("Контрагент", ПоляОтбора.Контрагент);
	Запрос.УстановитьПараметр("Соглашение", ПоляОтбора.Соглашение);
	Запрос.УстановитьПараметр("Договор", ПоляОтбора.Договор);
	Запрос.УстановитьПараметр("Валюта", ПоляОтбора.Валюта);
	Запрос.УстановитьПараметр("НалогообложениеНДС", ПоляОтбора.НалогообложениеНДС);
	Запрос.УстановитьПараметр("ГруппаФинансовогоУчета", ПоляОтбора.ГруппаФинансовогоУчета);
	Запрос.УстановитьПараметр("ГруппаПродукции", ПоляОтбора.ГруппаПродукции);
	Запрос.УстановитьПараметр("ВидЦены", ПоляОтбора.ВидЦены);
	
	РезультатЗапроса = Запрос.Выполнить();
	
	ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
	
	Если ВыборкаДетальныеЗаписи.Следующий() Тогда
		ВидЗапасов = ВыборкаДетальныеЗаписи.Ссылка;
	Иначе
		ВидЗапасов = Неопределено;
	КонецЕсли;
	
	Возврат ВидЗапасов;
	
КонецФункции

Функция СоздатьВидЗапасов(СтруктураПолей)
	
	НачатьТранзакцию();
	Попытка
		
		Блокировка = Новый БлокировкаДанных();
		
		ЭлементБлокировки = Блокировка.Добавить("Справочник.ВидыЗапасов");
		Если ЗначениеЗаполнено(СтруктураПолей.Организация) Тогда
			ЭлементБлокировки.УстановитьЗначение("Организация", СтруктураПолей.Организация);
		КонецЕсли;
		Если ЗначениеЗаполнено(СтруктураПолей.ТипЗапасов) Тогда
			ЭлементБлокировки.УстановитьЗначение("ТипЗапасов", СтруктураПолей.ТипЗапасов);
		КонецЕсли;
		Если ЗначениеЗаполнено(СтруктураПолей.ВладелецТовара) Тогда
			ЭлементБлокировки.УстановитьЗначение("ВладелецТовара", СтруктураПолей.ВладелецТовара);
		КонецЕсли;
		Если ЗначениеЗаполнено(СтруктураПолей.Контрагент) Тогда
			ЭлементБлокировки.УстановитьЗначение("Контрагент", СтруктураПолей.Контрагент);
		КонецЕсли;
		Если ЗначениеЗаполнено(СтруктураПолей.Соглашение) Тогда
			ЭлементБлокировки.УстановитьЗначение("Соглашение", СтруктураПолей.Соглашение);
		КонецЕсли;
		Если ЗначениеЗаполнено(СтруктураПолей.Договор) Тогда
			ЭлементБлокировки.УстановитьЗначение("Договор", СтруктураПолей.Договор);
		КонецЕсли;
		Если ЗначениеЗаполнено(СтруктураПолей.Валюта) Тогда
			ЭлементБлокировки.УстановитьЗначение("Валюта", СтруктураПолей.Валюта);
		КонецЕсли;
		Если ЗначениеЗаполнено(СтруктураПолей.НалогообложениеНДС) Тогда
			ЭлементБлокировки.УстановитьЗначение("НалогообложениеНДС", СтруктураПолей.НалогообложениеНДС);
		КонецЕсли;
		Если ЗначениеЗаполнено(СтруктураПолей.ГруппаФинансовогоУчета) Тогда
			ЭлементБлокировки.УстановитьЗначение("ГруппаФинансовогоУчета", СтруктураПолей.ГруппаФинансовогоУчета);
		КонецЕсли;
		Если ЗначениеЗаполнено(СтруктураПолей.ГруппаПродукции) Тогда
			ЭлементБлокировки.УстановитьЗначение("ГруппаПродукции", СтруктураПолей.ГруппаПродукции);
		КонецЕсли;
		Если ЗначениеЗаполнено(СтруктураПолей.ВидЦены) Тогда
			ЭлементБлокировки.УстановитьЗначение("ВидЦены", СтруктураПолей.ВидЦены);
		КонецЕсли;
		ЭлементБлокировки.Режим = РежимБлокировкиДанных.Исключительный;
		
		Блокировка.Заблокировать();
		
		ВидЗапасов = ВидЗапасовПоОтборам(СтруктураПолей); // производится ответственное чтение еще раз
		Если Не ЗначениеЗаполнено(ВидЗапасов) Тогда // вид запасов в ИБ гарантированно отсутствует
			СправочникОбъект = Справочники.ВидыЗапасов.СоздатьЭлемент(); // поэтому можем создать новый
			ЗаполнитьЗначенияСвойств(СправочникОбъект, СтруктураПолей);
			СправочникОбъект.Записать();
			
			ВидЗапасов = СправочникОбъект.Ссылка;
		КонецЕсли;
		
		ЗафиксироватьТранзакцию();
		
	Исключение
		
		ОтменитьТранзакцию();
		
		ОписаниеВидаЗапасов = ОбщегоНазначенияУТКлиентСервер.ПредставлениеСтруктуры(СтруктураПолей);
		
		ТекстСообщения = НСтр("ru = 'Не удалось записать новый вид запасов с параметрами: %ОписаниеВидаЗапасов% по причине: %Причина%';
								|en = 'Cannot save the new inventory owner attributes with parameters: %ОписаниеВидаЗапасов%. Reason: %Причина%'");
		ТекстСообщения = СтрЗаменить(ТекстСообщения, "%ОписаниеВидаЗапасов%", ОписаниеВидаЗапасов);
		ТекстСообщения = СтрЗаменить(ТекстСообщения, "%Причина%", ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()));
		ЗаписьЖурналаРегистрации(ОбновлениеИнформационнойБазы.СобытиеЖурналаРегистрации(),
			УровеньЖурналаРегистрации.Ошибка,
			Метаданные.Справочники.ВидыЗапасов,
			,
			ТекстСообщения);
		ВызватьИсключение;
	КонецПопытки;
	
	Возврат ВидЗапасов;
	
КонецФункции

// Возвращает структуру с данными для поиска или создания нового элемента справочника ВидыЗапасов.
//
// Параметры:
//  Организация				 - СправочникСсылка.Организации				 - организация, для которой требуется получить структуру
//  ХозяйственнаяОперация	 - ПеречислениеСсылка.ХозяйственныеОперации	 - хоз. операция, для которой требуется получить структуру
//  РеквизитыДокумента		 - Структура, ВыборкаИзРезультатаЗапроса	 - структура или выборка со значениями.
// 
// Возвращаемое значение:
//  Структура - структура с данными.
//
Функция СтруктураВидаЗапасов(Организация, ХозяйственнаяОперация = Неопределено, РеквизитыДокумента = Неопределено) Экспорт
	
	Если Не ЗначениеЗаполнено(Организация) Тогда
		ТекстИсключения = НСтр("ru = 'Попытка генерации вида запасов с незаполненной организацией.';
								|en = 'An attempt to generate inventory owner attributes with no company specified.'");
		ВызватьИсключение ТекстИсключения;
	КонецЕсли;
	
	СтруктураВидЗапасов = ПараметрыОтбораВидовЗапасов(); 
	СтруктураВидЗапасов.ТипЗапасов = Перечисления.ТипыЗапасов.Товар;
	СтруктураВидЗапасов.Организация = Организация;
	
	Если РеквизитыДокумента <> Неопределено Тогда
		
		Если РеквизитыДокумента.ТипЗапасов = Перечисления.ТипыЗапасов.Услуга
			Или РеквизитыДокумента.ТипЗапасов = Перечисления.ТипыЗапасов.АгентскаяУслуга Тогда
			ТекстИсключения = НСтр("ru = 'Попытка генерации вида запасов для типа запасов ""%ТипЗапасов%"".
			|Для этого типа запасов виды запасов не используются.';
			|en = 'An attempt to generate inventory owner attributes for the ""%ТипЗапасов%"" inventory type.
			|Inventory owner attributes are not used for this inventory type.'");
			ТекстИсключения = СтрЗаменить(ТекстИсключения, "%ТипЗапасов%", РеквизитыДокумента.ТипЗапасов);
			ВызватьИсключение ТекстИсключения;
		КонецЕсли;
		
		Если ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ПриемНаКомиссию
			ИЛИ ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ВозвратТоваровКомитенту
			ИЛИ ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ПередачаНаКомиссиюВДругуюОрганизацию
			ИЛИ РеквизитыДокумента.ТипЗапасов = Перечисления.ТипыЗапасов.КомиссионныйТовар Тогда
		 
		 	СтруктураВидЗапасов.ТипЗапасов = Перечисления.ТипыЗапасов.КомиссионныйТовар;
			
			ТекстыИсключения = Новый Массив;
			Если Не ЗначениеЗаполнено(РеквизитыДокумента.ВладелецТовара) Тогда
				ТекстыИсключения.Добавить(НСтр("ru = 'Не заполнен обязательный реквизит ""Владелец товара"".';
												|en = 'Attribute ""Goods owner"" is required.'"));
			КонецЕсли;
			Если Не ЗначениеЗаполнено(РеквизитыДокумента.Валюта) Тогда
				ТекстыИсключения.Добавить(НСтр("ru = 'Не заполнен обязательный реквизит ""Валюта"".';
												|en = 'Attribute ""Currency"" is required.'"));
			КонецЕсли;
			Если ТекстыИсключения.Количество() Тогда
				ТекстИсключения = НСтр("ru = 'Попытка генерации вида запасов для типа запасов ""%ТипЗапасов%"".';
										|en = 'An attempt to generate inventory owner attributes for the ""%ТипЗапасов%"" inventory type.'");
				ТекстИсключения = СтрЗаменить(ТекстИсключения, "%ТипЗапасов%", СтруктураВидЗапасов.ТипЗапасов);
				ВызватьИсключение ТекстИсключения + Символы.ПС + СтрСоединить(ТекстыИсключения, Символы.ПС);
			КонецЕсли;
			
			СтруктураВидЗапасов.ВладелецТовара = РеквизитыДокумента.ВладелецТовара;
			СтруктураВидЗапасов.Контрагент = ?(ЗначениеЗаполнено(РеквизитыДокумента.Контрагент), РеквизитыДокумента.Контрагент, Неопределено);
			СтруктураВидЗапасов.Соглашение = ?(ЗначениеЗаполнено(РеквизитыДокумента.Соглашение), РеквизитыДокумента.Соглашение, Справочники.СоглашенияСПоставщиками.ПустаяСсылка());
			СтруктураВидЗапасов.Договор = ?(ЗначениеЗаполнено(РеквизитыДокумента.Договор), РеквизитыДокумента.Договор, Неопределено);
			СтруктураВидЗапасов.Валюта = РеквизитыДокумента.Валюта;
			СтруктураВидЗапасов.НалогообложениеНДС = РеквизитыДокумента.НалогообложениеНДС;
			
		ИначеЕсли ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ПриемНаХранениеСПравомПродажи
			ИЛИ РеквизитыДокумента.ТипЗапасов = Перечисления.ТипыЗапасов.ТоварНаХраненииСПравомПродажи Тогда
			
		 	СтруктураВидЗапасов.ТипЗапасов = Перечисления.ТипыЗапасов.ТоварНаХраненииСПравомПродажи;
			
			ТекстыИсключения = Новый Массив;
			Если Не ЗначениеЗаполнено(РеквизитыДокумента.ВладелецТовара) Тогда
				ТекстыИсключения.Добавить(НСтр("ru = 'Не заполнен обязательный реквизит ""Владелец товара"".';
												|en = 'Attribute ""Goods owner"" is required.'"));
			КонецЕсли;
			
			ТипДоговораПоставкаПодПринципала = Ложь;
			Если Не ЗначениеЗаполнено(РеквизитыДокумента.Договор) Тогда
				ТекстыИсключения.Добавить(НСтр("ru = 'Не заполнен обязательный реквизит ""Договор"".';
												|en = 'Attribute ""Contract"" is required.'"));
			Иначе
				ТипДоговора = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(РеквизитыДокумента.Договор, "ТипДоговора");
				ТипДоговораПоставкаПодПринципала = (ТипДоговора = Перечисления.ТипыДоговоров.СКомитентомНаЗакупку);
			КонецЕсли;
			
			Если ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ВыкупПринятыхНаХранениеТоваров
				И ТекстыИсключения.Количество() = 1 И Не ЗначениеЗаполнено(РеквизитыДокумента.ВидЦены) Тогда
				ТекстИсключения = НСтр("ru = 'Недостаточно товаров для выкупа с хранения.
				|В текущем режиме работы отрицательный остаток товаров организаций не контролируется, но необходимо указать вид цены.';
				|en = 'Insufficient goods for redemption from storage. 
				|Negative balance of the company goods is not controlled in the current operating mode but you must specify the price type.'");
				ВызватьИсключение ТекстИсключения;
			ИначеЕсли ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ОтгрузкаПринятыхСПравомПродажиТоваровСХранения
				И ТекстыИсключения.Количество() > 0 Тогда
				ТекстИсключения = НСтр("ru = 'Недостаточно товаров для отгрузки с хранения.
				|Даже если контроль остатков отключен, программа не поддерживает отгрузку товаров с ответственного хранения ""в минус"".';
				|en = 'Insufficient goods to ship from storage.
				|Even if balance control is disabled, the application does not support VMI pick-up in the amount exceeding the actual amount of goods in custody.'");
				ВызватьИсключение ТекстИсключения;
			КонецЕсли;
			
			Если ТекстыИсключения.Количество() Тогда
				ТекстИсключения = НСтр("ru = 'Попытка генерации вида запасов для типа запасов ""%ТипЗапасов%"".';
										|en = 'An attempt to generate inventory owner attributes for the ""%ТипЗапасов%"" inventory type.'");
				ТекстИсключения = СтрЗаменить(ТекстИсключения, "%ТипЗапасов%", СтруктураВидЗапасов.ТипЗапасов);
				ВызватьИсключение ТекстИсключения + Символы.ПС + СтрСоединить(ТекстыИсключения, Символы.ПС);
			КонецЕсли;
			
			СтруктураВидЗапасов.ВладелецТовара = РеквизитыДокумента.ВладелецТовара;
			СтруктураВидЗапасов.Контрагент = ?(ЗначениеЗаполнено(РеквизитыДокумента.Контрагент), РеквизитыДокумента.Контрагент, Неопределено);
			СтруктураВидЗапасов.Договор = РеквизитыДокумента.Договор;
			СтруктураВидЗапасов.ВидЦены = РеквизитыДокумента.ВидЦены;
			
		ИначеЕсли РеквизитыДокумента.ТипЗапасов = Перечисления.ТипыЗапасов.СобственныйТоварВПути
			ИЛИ РеквизитыДокумента.ТипЗапасов = Перечисления.ТипыЗапасов.СобственныйТоварПоНеотфактурованнойПоставке Тогда
			
			СтруктураВидЗапасов.ТипЗапасов = РеквизитыДокумента.ТипЗапасов;
			
		//++ НЕ УТКА
		ИначеЕсли ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ПоступлениеОтДавальца2_5
			ИЛИ ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ВозвратДавальцу2_5
			//++ Устарело_Переработка24
			ИЛИ ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ПоступлениеОтДавальца
			ИЛИ ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ВозвратДавальцу
			//-- Устарело_Переработка24
			ИЛИ РеквизитыДокумента.ТипЗапасов = Перечисления.ТипыЗапасов.МатериалДавальца Тогда
		 
		 	СтруктураВидЗапасов.ТипЗапасов = Перечисления.ТипыЗапасов.МатериалДавальца;
			
			Если Не ЗначениеЗаполнено(РеквизитыДокумента.ВладелецТовара) Тогда
				ТекстИсключения = НСтр("ru = 'Попытка генерации вида запасов для типа запасов ""%ТипЗапасов%"".
				|Не заполнен обязательный реквизит ""Владелец товара"".';
				|en = 'An attempt to generate inventory owner attributes for the ""%ТипЗапасов%"" inventory type.
				|Attribute ""Goods owner"" is required.'");
				ТекстИсключения = СтрЗаменить(ТекстИсключения, "%ТипЗапасов%", СтруктураВидЗапасов.ТипЗапасов);
				ВызватьИсключение ТекстИсключения;
			КонецЕсли;
			
			СтруктураВидЗапасов.ВладелецТовара = РеквизитыДокумента.ВладелецТовара;
			СтруктураВидЗапасов.Контрагент = ?(ЗначениеЗаполнено(РеквизитыДокумента.Контрагент), РеквизитыДокумента.Контрагент, Неопределено);
			СтруктураВидЗапасов.Договор = ?(ЗначениеЗаполнено(РеквизитыДокумента.Договор), РеквизитыДокумента.Договор, Неопределено);
			
		ИначеЕсли ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ПроизводствоИзДавальческогоСырья2_5
			//++ Устарело_Переработка24
			ИЛИ ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ПроизводствоИзДавальческогоСырья
			//-- Устарело_Переработка24
			ИЛИ РеквизитыДокумента.ТипЗапасов = Перечисления.ТипыЗапасов.ПродукцияДавальца
			ИЛИ РеквизитыДокумента.ТипЗапасов = Перечисления.ТипыЗапасов.ПолуфабрикатДавальца Тогда
			
			Если РеквизитыДокумента.ТипЗапасов = Перечисления.ТипыЗапасов.ПолуфабрикатДавальца Тогда
				СтруктураВидЗапасов.ТипЗапасов = РеквизитыДокумента.ТипЗапасов;
			Иначе
				СтруктураВидЗапасов.ТипЗапасов = Перечисления.ТипыЗапасов.ПродукцияДавальца;
			КонецЕсли;
			
			Если Не ЗначениеЗаполнено(РеквизитыДокумента.ВладелецТовара) Тогда
				ТекстИсключения = НСтр("ru = 'Попытка генерации вида запасов для типа запасов ""%ТипЗапасов%"".
				|Не заполнен обязательный реквизит ""Владелец товара"".';
				|en = 'An attempt to generate inventory owner attributes for the ""%ТипЗапасов%"" inventory type.
				|Attribute ""Goods owner"" is required.'");
				ТекстИсключения = СтрЗаменить(ТекстИсключения, "%ТипЗапасов%", СтруктураВидЗапасов.ТипЗапасов);
				ВызватьИсключение ТекстИсключения;
			КонецЕсли;
			
			СтруктураВидЗапасов.ВладелецТовара = РеквизитыДокумента.ВладелецТовара;
			СтруктураВидЗапасов.Контрагент = ?(ЗначениеЗаполнено(РеквизитыДокумента.Контрагент), РеквизитыДокумента.Контрагент, Неопределено);
			СтруктураВидЗапасов.Договор = ?(ЗначениеЗаполнено(РеквизитыДокумента.Договор), РеквизитыДокумента.Договор, Неопределено);
		
		//-- НЕ УТКА
		Иначе
			Если ЗначениеЗаполнено(РеквизитыДокумента.ТипЗапасов) Тогда
				СтруктураВидЗапасов.ТипЗапасов = РеквизитыДокумента.ТипЗапасов;
			Иначе
				СтруктураВидЗапасов.ТипЗапасов = Перечисления.ТипыЗапасов.Товар;
			КонецЕсли;
		КонецЕсли;
		
		Если ПолучитьФункциональнуюОпцию("ФормироватьВидыЗапасовПоГруппамФинансовогоУчета") Тогда
			СтруктураВидЗапасов.ГруппаФинансовогоУчета = РеквизитыДокумента.ГруппаФинансовогоУчета;
		КонецЕсли;
		
		//++ НЕ УТ
		Если ПолучитьФункциональнуюОпцию("АналитическийУчетПоГруппамПродукции") Тогда
			СтруктураВидЗапасов.ГруппаПродукции = РеквизитыДокумента.ГруппаПродукции;
		КонецЕсли;
		//-- НЕ УТ
		
	КонецЕсли;
	
	ПараметрыОтбораВидовЗапасов = ПараметрыОтбораВидовЗапасов(); 
	
	Для Каждого КлючИЗначение Из ПараметрыОтбораВидовЗапасов Цикл
		Если Не ЗначениеЗаполнено(СтруктураВидЗапасов[КлючИЗначение.Ключ]) Тогда
			СтруктураВидЗапасов[КлючИЗначение.Ключ] = КлючИЗначение.Значение;
		КонецЕсли;
	КонецЦикла;
	
	Возврат СтруктураВидЗапасов;
	
КонецФункции

// Возвращает параметры отбора видов запасов.
//
// Возвращаемое значение:
// 	Структура - содержит следующие ключи:
// * Организация - СправочникСсылка.Организации, Массив из СправочникСсылка.Организации - организация, от имени которой будет оформляться реализация товаров.
// * ОрганизацияДавалец - СправочникСсылка.Организации, Массив из СправочникСсылка.Организации - организация, для которой выполняется производство.
// * ТипЗапасов - ПеречислениеСсылка.ТипыЗапасов, Массив из ПеречислениеСсылка.ТипыЗапасов - доступные типы запасов товаров.
// * ВладелецТовара - СправочникСсылка.Организации, СправочникСсылка.Партнеры - владелец товаров.
// * Контрагент - СправочникСсылка.Организации, СправочникСсылка.Партнеры - контрагент, с которым заключается договор на реализацию товаров.
// * Соглашение - СправочникСсылка.СоглашенияСПоставщиками - соглашение, в рамках которого оформляется поступление товаров.
// * Договор - СправочникСсылка.ДоговорыКонтрагентов, СправочникСсылка.ДоговорыМеждуОрганизациями, Массив из СправочникСсылка.ДоговорыКонтрагентов, СправочникСсылка.ДоговорыМеждуОрганизациями - договор, в рамках которого оформляется реализация товаров.
// * Валюта - СправочникСсылка.Валюты - валюта, по которой осуществляются взаиморасчеты с владельцем товаров.
// * НалогообложениеНДС - ПеречислениеСсылка.ТипыНалогообложенияНДС - тип налогообложения реализации товаров, облагаемой налогом на добавленную стоимость.
// * ГруппаФинансовогоУчета - СправочникСсылка.ГруппыФинансовогоУчетаНоменклатуры - группа финансового учета товаров.
// * ГруппаПродукции - СправочникСсылка.ГруппыАналитическогоУчетаНоменклатуры - вид продукции.
// * ВидЦены - СправочникСсылка.ВидыЦенПоставщиков - вид цены, по которой зафиксировано поступление товара.
//
Функция ПараметрыОтбораВидовЗапасов() Экспорт
	
	Параметры = Новый Структура("
	|Организация,
	//++ НЕ УТКА
	|ОрганизацияДавалец,
	//-- НЕ УТКА
	|ТипЗапасов,
	|ВладелецТовара,
	|Контрагент,
	|Соглашение,
	|Договор,
	|Валюта,
	|НалогообложениеНДС,
	|ГруппаФинансовогоУчета,
	|ГруппаПродукции,
	|ВидЦены
	|");
	
	Параметры.Организация = Справочники.Организации.ПустаяСсылка();
	//++ НЕ УТКА
	Параметры.ОрганизацияДавалец = Справочники.Организации.ПустаяСсылка();
	//-- НЕ УТКА
	Параметры.ВладелецТовара = Неопределено;
	Параметры.Контрагент = Неопределено;
	Параметры.Договор = Неопределено;
	Параметры.Соглашение = Справочники.СоглашенияСПоставщиками.ПустаяСсылка();
	Параметры.Валюта = Справочники.Валюты.ПустаяСсылка();
	Параметры.НалогообложениеНДС = Перечисления.ТипыНалогообложенияНДС.ПустаяСсылка();
	Параметры.ТипЗапасов = Перечисления.ТипыЗапасов.ПустаяСсылка();
	Параметры.ГруппаФинансовогоУчета = Справочники.ГруппыФинансовогоУчетаНоменклатуры.ПустаяСсылка();
	Параметры.ГруппаПродукции = Справочники.ГруппыАналитическогоУчетаНоменклатуры.ПустаяСсылка();
	Параметры.ВидЦены = Справочники.ВидыЦенПоставщиков.ПустаяСсылка();
	
	Возврат Параметры;
	
КонецФункции

Функция ВидЗапасовПоОтборамКэш(ПараметрыАналитики)
	
	СтруктураАналитики = ПараметрыОтбораВидовЗапасов();
	ЗаполнитьЗначенияСвойств(СтруктураАналитики, ПараметрыАналитики);
	
	Результат = ЗначениеНастроекПовтИсп.ВидЗапасовПоОтборам(СтруктураАналитики.Организация,
		СтруктураАналитики.ТипЗапасов,
		СтруктураАналитики.ВладелецТовара,
		СтруктураАналитики.Контрагент,
		СтруктураАналитики.Соглашение,
		СтруктураАналитики.Договор,
		СтруктураАналитики.Валюта,
		СтруктураАналитики.НалогообложениеНДС,
		СтруктураАналитики.ГруппаФинансовогоУчета,
		СтруктураАналитики.ГруппаПродукции,
		СтруктураАналитики.ВидЦены);
		
	Если ЗначениеЗаполнено(Результат)
			И Не ОбщегоНазначения.СсылкаСуществует(Результат) Тогда
		Результат = Неопределено;
	КонецЕсли;
		
	Если Не ЗначениеЗаполнено(Результат) Тогда
		Результат = СоздатьВидЗапасов(СтруктураАналитики);
		ОбновитьПовторноИспользуемыеЗначения();
	КонецЕсли;
	
	Возврат Результат;
	
КонецФункции

#КонецОбласти

#Область ОбновлениеИнформационнойБазы

Процедура ПометитьДублиВидовЗапасов() Экспорт
	
 	Запрос = Новый Запрос();
	Запрос.МенеджерВременныхТаблиц = Новый МенеджерВременныхТаблиц;
	Запрос.Текст = ТекстЗапросаПоискаДублейВидовЗапасов(Истина) + 
	"ВЫБРАТЬ
	|	ВидыЗапасов.Ссылка КАК Ссылка,
	|	ВидыЗапасов.Наименование КАК Наименование,
	|	ВидыЗапасов.Организация КАК Организация,
	|	ВидыЗапасов.ТипЗапасов КАК ТипЗапасов,
	|	ВидыЗапасов.НалогообложениеНДС КАК НалогообложениеНДС,
	|	ВЫБОР ВидыЗапасов.ВладелецТовара
	|		КОГДА ЗНАЧЕНИЕ(Справочник.Организации.ПустаяСсылка)
	|			ТОГДА НЕОПРЕДЕЛЕНО
	|		КОГДА ЗНАЧЕНИЕ(Справочник.Партнеры.ПустаяСсылка)
	|			ТОГДА НЕОПРЕДЕЛЕНО
	|		ИНАЧЕ ВидыЗапасов.ВладелецТовара
	|	КОНЕЦ КАК ВладелецТовара,
	|	ВидыЗапасов.Соглашение КАК Соглашение,
	|	ВидыЗапасов.Валюта КАК Валюта,
	|	ВидыЗапасов.РеализацияЗапасовДругойОрганизации КАК РеализацияЗапасовДругойОрганизации,
	|	ВидыЗапасов.ВидЗапасовВладельца КАК ВидЗапасовВладельца,
	|	ВидыЗапасов.СпособПередачиТоваров КАК СпособПередачиТоваров,
	|	ВЫБОР
	|		КОГДА ВидыЗапасов.УстарелоПоставщик В (ЗНАЧЕНИЕ(Справочник.Организации.ПустаяСсылка), ЗНАЧЕНИЕ(Справочник.Партнеры.ПустаяСсылка))
	|			ТОГДА НЕОПРЕДЕЛЕНО
	|		КОГДА НЕ ВидыЗапасов.ВладелецТовара В (НЕОПРЕДЕЛЕНО, ЗНАЧЕНИЕ(Справочник.Организации.ПустаяСсылка), ЗНАЧЕНИЕ(Справочник.Партнеры.ПустаяСсылка))
	|			ТОГДА НЕОПРЕДЕЛЕНО
	|		ИНАЧЕ ВидыЗапасов.УстарелоПоставщик
	|	КОНЕЦ КАК УстарелоПоставщик,
	|	ВЫБОР
	|		КОГДА ВидыЗапасов.УстарелоПредназначение = ЗНАЧЕНИЕ(Перечисление.ТипыПредназначенияВидовЗапасов.ПредназначениеНеОграничено)
	|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыПредназначенияВидовЗапасов.ПустаяСсылка)
	|		ИНАЧЕ ВидыЗапасов.УстарелоПредназначение
	|	КОНЕЦ КАК УстарелоПредназначение,
	|	ВидыЗапасов.УстарелоПодразделение КАК УстарелоПодразделение,
	|	ВидыЗапасов.УстарелоМенеджер КАК УстарелоМенеджер,
	|	ВидыЗапасов.УстарелоСделка КАК УстарелоСделка,
	|	ВидыЗапасов.ГруппаФинансовогоУчета КАК ГруппаФинансовогоУчета,
	|	ВЫБОР ВидыЗапасов.Контрагент
	|		КОГДА ЗНАЧЕНИЕ(Справочник.Организации.ПустаяСсылка)
	|			ТОГДА НЕОПРЕДЕЛЕНО
	|		КОГДА ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	|			ТОГДА НЕОПРЕДЕЛЕНО
	|		ИНАЧЕ ВидыЗапасов.Контрагент
	|	КОНЕЦ КАК Контрагент,
	|	ВЫБОР ВидыЗапасов.Договор
	|		КОГДА ЗНАЧЕНИЕ(Справочник.ДоговорыМеждуОрганизациями.ПустаяСсылка)
	|			ТОГДА НЕОПРЕДЕЛЕНО
	|		КОГДА ЗНАЧЕНИЕ(Справочник.ДоговорыКонтрагентов.ПустаяСсылка)
	|			ТОГДА НЕОПРЕДЕЛЕНО
	|		ИНАЧЕ ВидыЗапасов.Договор
	|	КОНЕЦ КАК Договор,
	|	ВидыЗапасов.УстарелоНазначение КАК УстарелоНазначение,
	|	ВидыЗапасов.ГруппаПродукции КАК ГруппаПродукции,
	|	ВидыЗапасов.ВидЦены КАК ВидЦены,
	|	ВидыЗапасов.ЭтоДубль КАК ЭтоДубль,
	|	ВидыЗапасов.ПометкаУдаления КАК ПометкаУдаления
	|ПОМЕСТИТЬ СпрВидыЗапасов
	|ИЗ
	|	Справочник.ВидыЗапасов КАК ВидыЗапасов
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ВидыЗапасов.Организация КАК Организация,
	|	ВидыЗапасов.ТипЗапасов КАК ТипЗапасов,
	|	ВидыЗапасов.НалогообложениеНДС КАК НалогообложениеНДС,
	|	ВидыЗапасов.ВладелецТовара КАК ВладелецТовара,
	|	ВидыЗапасов.Соглашение КАК Соглашение,
	|	ВидыЗапасов.Валюта КАК Валюта,
	|	ВидыЗапасов.РеализацияЗапасовДругойОрганизации КАК РеализацияЗапасовДругойОрганизации,
	|	ВидыЗапасов.ВидЗапасовВладельца КАК ВидЗапасовВладельца,
	|	ВидыЗапасов.СпособПередачиТоваров КАК СпособПередачиТоваров,
	|	ВидыЗапасов.УстарелоПоставщик КАК УстарелоПоставщик,
	|	ВидыЗапасов.УстарелоПредназначение КАК УстарелоПредназначение,
	|	ВидыЗапасов.УстарелоПодразделение КАК УстарелоПодразделение,
	|	ВидыЗапасов.УстарелоМенеджер КАК УстарелоМенеджер,
	|	ВидыЗапасов.УстарелоСделка КАК УстарелоСделка,
	|	ВидыЗапасов.ГруппаФинансовогоУчета КАК ГруппаФинансовогоУчета,
	|	ВидыЗапасов.Контрагент КАК Контрагент,
	|	ВидыЗапасов.Договор КАК Договор,
	|	ВидыЗапасов.УстарелоНазначение КАК УстарелоНазначение,
	|	ВидыЗапасов.ГруппаПродукции КАК ГруппаПродукции,
	|	ВидыЗапасов.ВидЦены КАК ВидЦены,
	|	ВидыЗапасов.Ссылка КАК Ссылка,
	|	ВидыЗапасов.ПометкаУдаления КАК ПометкаУдаления,
	|	ВидыЗапасов.ЭтоДубль КАК ЭтоДубль,
	|	КОЛИЧЕСТВО(РАЗЛИЧНЫЕ ТоварыОрганизаций.Регистратор) КАК КоличествоСсылок
	|ИЗ
	|	СпрВидыЗапасов КАК ВидыЗапасов
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВтОтборыДублей КАК Отборы
	|		ПО ВидыЗапасов.Организация = Отборы.Организация
	|			И ВидыЗапасов.ТипЗапасов = Отборы.ТипЗапасов
	|			И ВидыЗапасов.НалогообложениеНДС = Отборы.НалогообложениеНДС
	|			И ВидыЗапасов.ВладелецТовара = Отборы.ВладелецТовара
	|			И ВидыЗапасов.Соглашение = Отборы.Соглашение
	|			И ВидыЗапасов.Валюта = Отборы.Валюта
	|			И ВидыЗапасов.РеализацияЗапасовДругойОрганизации = Отборы.РеализацияЗапасовДругойОрганизации
	|			И ВидыЗапасов.ВидЗапасовВладельца = Отборы.ВидЗапасовВладельца
	|			И ВидыЗапасов.СпособПередачиТоваров = Отборы.СпособПередачиТоваров
	|			И ВидыЗапасов.УстарелоПоставщик = Отборы.УстарелоПоставщик
	|			И ВидыЗапасов.УстарелоПредназначение = Отборы.УстарелоПредназначение
	|			И ВидыЗапасов.УстарелоПодразделение = Отборы.УстарелоПодразделение
	|			И ВидыЗапасов.УстарелоМенеджер = Отборы.УстарелоМенеджер
	|			И ВидыЗапасов.УстарелоСделка = Отборы.УстарелоСделка
	|			И ВидыЗапасов.ГруппаФинансовогоУчета = Отборы.ГруппаФинансовогоУчета
	|			И ВидыЗапасов.Контрагент = Отборы.Контрагент
	|			И ВидыЗапасов.Договор = Отборы.Договор
	|			И ВидыЗапасов.УстарелоНазначение = Отборы.УстарелоНазначение
	|			И ВидыЗапасов.ГруппаПродукции = Отборы.ГруппаПродукции
	|			И ВидыЗапасов.ВидЦены = Отборы.ВидЦены
	|			И (НЕ ВидыЗапасов.ЭтоДубль)
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ТоварыОрганизаций КАК ТоварыОрганизаций
	|		ПО ВидыЗапасов.Ссылка = ТоварыОрганизаций.ВидЗапасов
	|
	|СГРУППИРОВАТЬ ПО
	|	ВидыЗапасов.Контрагент,
	|	ВидыЗапасов.УстарелоНазначение,
	|	ВидыЗапасов.Валюта,
	|	ВидыЗапасов.РеализацияЗапасовДругойОрганизации,
	|	ВидыЗапасов.УстарелоПоставщик,
	|	ВидыЗапасов.Соглашение,
	|	ВидыЗапасов.ЭтоДубль,
	|	ВидыЗапасов.ВладелецТовара,
	|	ВидыЗапасов.СпособПередачиТоваров,
	|	ВидыЗапасов.ВидЗапасовВладельца,
	|	ВидыЗапасов.Договор,
	|	ВидыЗапасов.ТипЗапасов,
	|	ВидыЗапасов.Ссылка,
	|	ВидыЗапасов.Организация,
	|	ВидыЗапасов.УстарелоМенеджер,
	|	ВидыЗапасов.УстарелоСделка,
	|	ВидыЗапасов.ГруппаФинансовогоУчета,
	|	ВидыЗапасов.ПометкаУдаления,
	|	ВидыЗапасов.ГруппаПродукции,
	|	ВидыЗапасов.ВидЦены,
	|	ВидыЗапасов.УстарелоПредназначение,
	|	ВидыЗапасов.УстарелоПодразделение,
	|	ВидыЗапасов.НалогообложениеНДС
	|
	|УПОРЯДОЧИТЬ ПО
	|	Организация,
	|	ТипЗапасов,
	|	НалогообложениеНДС,
	|	ВладелецТовара,
	|	Соглашение,
	|	Валюта,
	|	РеализацияЗапасовДругойОрганизации,
	|	ВидЗапасовВладельца,
	|	СпособПередачиТоваров,
	|	УстарелоПоставщик,
	|	УстарелоПредназначение,
	|	УстарелоПодразделение,
	|	УстарелоМенеджер,
	|	УстарелоСделка,
	|	ГруппаФинансовогоУчета,
	|	Контрагент,
	|	Договор,
	|	УстарелоНазначение,
	|	ГруппаПродукции,
	|	ВидЦены,
	|	КОЛИЧЕСТВО(РАЗЛИЧНЫЕ ТоварыОрганизаций.Регистратор) УБЫВ
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ВтОтборыДублей
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ СпрВидыЗапасов";
	
	УстановитьПараметрыЗапросаПоискаДублей(Запрос);
	
	ПоляСтруктуры = "
		|	Организация,
		|	ТипЗапасов,
		|	НалогообложениеНДС,
		|	ВладелецТовара,
		|	Соглашение,
		|	Валюта,
		|	РеализацияЗапасовДругойОрганизации,
		|	ВидЗапасовВладельца,
		|	СпособПередачиТоваров,
		|	УстарелоПоставщик,
		|	УстарелоПредназначение,
		|	УстарелоПодразделение,
		|	УстарелоМенеджер,
		|	УстарелоСделка,
		|	ГруппаФинансовогоУчета,
		|	Контрагент,
		|	Договор,
		|	УстарелоНазначение,
		|	ГруппаПродукции,
		|	ВидЦены
		|";
		
	СтруктураДляСравнения = Новый Структура(ПоляСтруктуры);
	СтруктураИзВыборки = Новый Структура(ПоляСтруктуры);
	
	МассивДублейОднойГруппы = Новый Массив();
	
	Результат = Запрос.Выполнить();
	ВыборкаДублейВидовЗапасов = Результат.Выбрать();
	
	Если ВыборкаДублейВидовЗапасов.Следующий() Тогда
		ЗаполнитьЗначенияСвойств(СтруктураДляСравнения, ВыборкаДублейВидовЗапасов);
		МассивДублейОднойГруппы.Добавить(ВыборкаДублейВидовЗапасов.Ссылка);
		Пока ВыборкаДублейВидовЗапасов.Следующий() Цикл
			ЗаполнитьЗначенияСвойств(СтруктураИзВыборки, ВыборкаДублейВидовЗапасов);
			Если Не ОбщегоНазначенияУТКлиентСервер.СтруктурыРавны(СтруктураДляСравнения, СтруктураИзВыборки) Тогда
				ВыбратьИПометитьДубли(МассивДублейОднойГруппы);
			КонецЕсли;
			МассивДублейОднойГруппы.Добавить(ВыборкаДублейВидовЗапасов.Ссылка);
			ЗаполнитьЗначенияСвойств(СтруктураДляСравнения, ВыборкаДублейВидовЗапасов);
		КонецЦикла;
		ВыбратьИПометитьДубли(МассивДублейОднойГруппы);
	КонецЕсли;

КонецПроцедуры

Процедура ВыбратьИПометитьДубли(МассивДублейОднойГруппы)
	
	Счетчик = 1;
	Пока Счетчик <= МассивДублейОднойГруппы.ВГраница() Цикл
		НачатьТранзакцию();
		Попытка
			СпрОбъект = МассивДублейОднойГруппы[Счетчик].ПолучитьОбъект();
			СпрОбъект.ЭтоДубль = Истина;
			СпрОбъект.ДополнительныеСвойства.Вставить("НеПроверятьДубли", Истина);
			ОбновлениеИнформационнойБазы.ЗаписатьОбъект(СпрОбъект);
			ЗафиксироватьТранзакцию();
		Исключение
			ОтменитьТранзакцию();
			ТекстСообщения = НСтр("ru = 'Не удалось обработать справочник: %Ссылка% по причине: %Причина%';
									|en = 'Cannot process the catalog: %Ссылка%. Reason: %Причина%'");
			ТекстСообщения = СтрЗаменить(ТекстСообщения, "%Ссылка%",  МассивДублейОднойГруппы[Счетчик]);
			ТекстСообщения = СтрЗаменить(ТекстСообщения, "%Причина%", ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()));
			ЗаписьЖурналаРегистрации(ОбновлениеИнформационнойБазы.СобытиеЖурналаРегистрации(),
				УровеньЖурналаРегистрации.Ошибка,
				Метаданные.Справочники.ВидыЗапасов,
				МассивДублейОднойГруппы[Счетчик],
				ТекстСообщения);
		КонецПопытки;
		Счетчик = Счетчик + 1;
	КонецЦикла;
	
	МассивДублейОднойГруппы.Очистить();
	
КонецПроцедуры

Функция ОбработатьРеквизитыОбъекта(ОбрабатываемыйОбъект) Экспорт
	
	Если Не ЗначениеЗаполнено(ОбрабатываемыйОбъект.ВладелецТовара) И ОбрабатываемыйОбъект.ВладелецТовара <> Неопределено Тогда
		ОбрабатываемыйОбъект.ВладелецТовара = Неопределено;
	КонецЕсли;
	
	Если Не ЗначениеЗаполнено(ОбрабатываемыйОбъект.Договор) И ОбрабатываемыйОбъект.Договор <> Неопределено Тогда
		ОбрабатываемыйОбъект.Договор = Неопределено;
	КонецЕсли;
	
	Если Не ЗначениеЗаполнено(ОбрабатываемыйОбъект.Контрагент) И ОбрабатываемыйОбъект.Контрагент <> Неопределено Тогда
		ОбрабатываемыйОбъект.Контрагент = Неопределено;
	КонецЕсли;
	
	Если Не ЗначениеЗаполнено(ОбрабатываемыйОбъект.УстарелоПоставщик) И ОбрабатываемыйОбъект.УстарелоПоставщик <> Неопределено Тогда
		ОбрабатываемыйОбъект.УстарелоПоставщик = Неопределено;
	ИначеЕсли ЗначениеЗаполнено(ОбрабатываемыйОбъект.ВладелецТовара)
		И ОбрабатываемыйОбъект.УстарелоПоставщик <> Неопределено Тогда
		ОбрабатываемыйОбъект.УстарелоПоставщик = Неопределено;
	КонецЕсли;
	
	Если ОбрабатываемыйОбъект.УстарелоПредназначение = Перечисления.ТипыПредназначенияВидовЗапасов.ПредназначениеНеОграничено Тогда
		ОбрабатываемыйОбъект.УстарелоПредназначение = Перечисления.ТипыПредназначенияВидовЗапасов.ПустаяСсылка();
	КонецЕсли;
	
КонецФункции

Функция ПустойВидЗапасовСтруктура() Экспорт
	
	Параметры = Новый Структура("
	|Организация,
	|ТипЗапасов,
	|ВладелецТовара,
	|Контрагент,
	|Соглашение,
	|Договор,
	|Валюта,
	|НалогообложениеНДС,
	|ГруппаФинансовогоУчета,
	|ГруппаПродукции,
	|ВидЦены,
	|РеализацияЗапасовДругойОрганизации,
	|ВидЗапасовВладельца,
	|СпособПередачиТоваров,
	|УстарелоПоставщик,
	|УстарелоПодразделение,
	|УстарелоМенеджер,
	|УстарелоСделка,      
	|УстарелоНазначение,
	|УстарелоПредназначение
	|");
	
	Параметры.Организация = Справочники.Организации.ПустаяСсылка();
	Параметры.ВладелецТовара = Неопределено;
	Параметры.Контрагент = Неопределено;
	Параметры.Договор = Неопределено;
	Параметры.Соглашение = Справочники.СоглашенияСПоставщиками.ПустаяСсылка();
	Параметры.Валюта = Справочники.Валюты.ПустаяСсылка();
	Параметры.НалогообложениеНДС = Перечисления.ТипыНалогообложенияНДС.ПустаяСсылка();
	Параметры.ТипЗапасов = Перечисления.ТипыЗапасов.ПустаяСсылка();
	Параметры.ГруппаФинансовогоУчета = Справочники.ГруппыФинансовогоУчетаНоменклатуры.ПустаяСсылка();
	Параметры.ГруппаПродукции = Справочники.ГруппыАналитическогоУчетаНоменклатуры.ПустаяСсылка();
	Параметры.ВидЦены = Справочники.ВидыЦенПоставщиков.ПустаяСсылка();
	Параметры.РеализацияЗапасовДругойОрганизации = Ложь;
	Параметры.ВидЗапасовВладельца = Справочники.ВидыЗапасов.ПустаяСсылка();
	Параметры.СпособПередачиТоваров = Перечисления.СпособыПередачиТоваров.ПустаяСсылка();
	Параметры.УстарелоПоставщик = Неопределено;
	Параметры.УстарелоПодразделение = Справочники.СтруктураПредприятия.ПустаяСсылка();
	Параметры.УстарелоМенеджер = Справочники.Пользователи.ПустаяСсылка();
	Параметры.УстарелоСделка = Справочники.СделкиСКлиентами.ПустаяСсылка();
	Параметры.УстарелоНазначение = Справочники.Назначения.ПустаяСсылка();
	Параметры.УстарелоПредназначение = Перечисления.ТипыПредназначенияВидовЗапасов.ПустаяСсылка();
	
	Возврат Параметры;
	
КонецФункции

#КонецОбласти

#КонецОбласти

#КонецЕсли

